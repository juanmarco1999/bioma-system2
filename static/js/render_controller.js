/**
 * BIOMA Render Controller
 * Sistema de controle de renderiza√ß√£o por se√ß√£o
 * Previne sobreposi√ß√£o e informa√ß√µes indevidas
 */

(function() {
    'use strict';

    /**
     * Mapa de conte√∫do permitido por se√ß√£o
     */
    const SECTION_CONTENT_MAP = {
        'dashboard': {
            allowed: ['dashboard', 'resumo', 'geral', 'card', 'stats', 'grafico', 'chart'],
            forbidden: ['estoque', 'orcamento', 'contrato', 'anamnese', 'prontuario'],
            containers: ['#dashboard-resumo', '#dashboard-graficos', '#dashboard-cards']
        },
        'agendamentos': {
            allowed: ['agendamento', 'agenda', 'calendario', 'horario', 'cliente', 'servico'],
            forbidden: ['estoque', 'produto', 'financeiro', 'orcamento'],
            containers: ['#agendamentos-lista', '#agendamentos-calendario']
        },
        'clientes': {
            allowed: ['cliente', 'pessoa', 'contato', 'anamnese', 'prontuario'],
            forbidden: ['estoque', 'produto', 'financeiro', 'agendamento'],
            containers: ['#clientes-lista', '#cliente-detalhes']
        },
        'profissionais': {
            allowed: ['profissional', 'funcionario', 'colaborador', 'agenda', 'comissao'],
            forbidden: ['estoque', 'produto', 'cliente'],
            containers: ['#profissionais-lista']
        },
        'servicos': {
            allowed: ['servico', 'tratamento', 'procedimento', 'categoria', 'preco'],
            forbidden: ['estoque', 'produto', 'cliente', 'financeiro'],
            containers: ['#servicos-lista', '#servico-form']
        },
        'produtos': {
            allowed: ['produto', 'item', 'estoque', 'preco', 'categoria', 'fornecedor'],
            forbidden: ['agendamento', 'cliente', 'servico'],
            containers: ['#produtos-lista', '#produto-form']
        },
        'estoque': {
            allowed: ['estoque', 'produto', 'item', 'quantidade', 'minimo', 'movimentacao'],
            forbidden: ['agendamento', 'cliente', 'servico'],
            containers: ['#estoque-visao-geral', '#estoque-lista', '#estoque-movimentacoes']
        },
        'financeiro': {
            allowed: ['financeiro', 'receita', 'despesa', 'comissao', 'pagamento', 'faturamento'],
            forbidden: ['estoque', 'produto', 'agendamento'],
            containers: ['#financeiro-resumo', '#financeiro-receitas', '#financeiro-despesas']
        },
        'comunidade': {
            allowed: ['post', 'comunidade', 'feed', 'noticia', 'anuncio'],
            forbidden: ['estoque', 'produto', 'financeiro', 'agendamento'],
            containers: ['#comunidade-feed']
        },
        'importar': {
            allowed: ['importar', 'upload', 'arquivo', 'planilha', 'dados'],
            forbidden: ['estoque', 'produto'],
            containers: ['#importar-form']
        },
        'sistema': {
            allowed: ['auditoria', 'log', 'usuario', 'acao', 'data', 'hora'],
            forbidden: ['estoque', 'produto', 'cliente'],
            containers: ['#sistema-auditoria']
        },
        'configuracoes': {
            allowed: ['configuracao', 'perfil', 'logo', 'email', 'senha', 'tema'],
            forbidden: ['estoque', 'produto', 'cliente', 'agendamento'],
            containers: ['#configuracoes-form']
        },
        'avaliacoes': {
            allowed: ['avaliacao', 'nota', 'estrela', 'comentario', 'feedback', 'servico'],
            forbidden: ['estoque', 'produto', 'financeiro'],
            containers: ['#avaliacoes-lista']
        }
    };

    /**
     * Render Controller
     */
    const RenderController = {

        /**
         * Inicializar
         */
        init: function() {
            console.log('üé® RenderController: Inicializando...');
            this.setupSectionGuards();
            console.log('‚úÖ RenderController: Pronto!');
        },

        /**
         * Verificar se conte√∫do √© permitido em uma se√ß√£o
         */
        isContentAllowed: function(sectionId, content) {
            const config = SECTION_CONTENT_MAP[sectionId];
            if (!config) {
                console.warn(`‚ö†Ô∏è RenderController: Se√ß√£o ${sectionId} n√£o configurada`);
                return true; // Permitir se n√£o configurado
            }

            const contentLower = content.toLowerCase();

            // Verificar se est√° na lista proibida
            const isForbidden = config.forbidden.some(keyword =>
                contentLower.includes(keyword)
            );

            if (isForbidden) {
                console.warn(`‚ùå RenderController: Conte√∫do "${content}" proibido em ${sectionId}`);
                return false;
            }

            return true;
        },

        /**
         * Validar elemento
         */
        validateElement: function(element, sectionId) {
            if (!element || !sectionId) return false;

            const config = SECTION_CONTENT_MAP[sectionId];
            if (!config) return true;

            // Coletar informa√ß√µes do elemento
            const id = element.id || '';
            const className = element.className || '';
            const text = element.textContent || '';

            const combinedContent = `${id} ${className} ${text}`.toLowerCase();

            // Verificar palavras proibidas
            const hasForbidden = config.forbidden.some(keyword =>
                combinedContent.includes(keyword)
            );

            if (hasForbidden) {
                console.warn(`‚ùå RenderController: Elemento proibido em ${sectionId}:`, element);
                return false;
            }

            return true;
        },

        /**
         * Limpar se√ß√£o de conte√∫do indevido
         */
        cleanSection: function(sectionId) {
            const section = document.getElementById(sectionId);
            if (!section) return;

            const config = SECTION_CONTENT_MAP[sectionId];
            if (!config) return;

            console.log(`üßπ RenderController: Limpando ${sectionId}...`);

            let removed = 0;

            // Procurar e remover elementos proibidos
            const allElements = section.querySelectorAll('*');

            allElements.forEach(element => {
                // N√£o remover containers principais
                const isContainer = config.containers.some(c =>
                    element.matches(c)
                );
                if (isContainer) return;

                // Verificar se elemento √© v√°lido
                if (!this.validateElement(element, sectionId)) {
                    element.remove();
                    removed++;
                }
            });

            if (removed > 0) {
                console.log(`‚úÖ RenderController: ${removed} elementos removidos de ${sectionId}`);
            }
        },

        /**
         * Configurar guards de se√ß√£o
         */
        setupSectionGuards: function() {
            Object.keys(SECTION_CONTENT_MAP).forEach(sectionId => {
                const section = document.getElementById(sectionId);
                if (!section) return;

                // Observador de muta√ß√£o para detectar inser√ß√µes indevidas
                const observer = new MutationObserver((mutations) => {
                    let needsClean = false;

                    mutations.forEach(mutation => {
                        mutation.addedNodes.forEach(node => {
                            if (node.nodeType === 1) { // Element
                                if (!this.validateElement(node, sectionId)) {
                                    needsClean = true;
                                }
                            }
                        });
                    });

                    if (needsClean) {
                        // Limpar ap√≥s um pequeno delay
                        setTimeout(() => {
                            this.cleanSection(sectionId);
                        }, 100);
                    }
                });

                observer.observe(section, {
                    childList: true,
                    subtree: true
                });

                console.log(`üõ°Ô∏è RenderController: Guard ativo em ${sectionId}`);
            });
        },

        /**
         * Renderizar se√ß√£o de forma segura
         */
        safeRender: function(sectionId, renderFunction) {
            console.log(`üé® RenderController: Renderizando ${sectionId}...`);

            // Verificar se pode carregar
            if (!window.StateManager.canLoad(sectionId)) {
                console.warn(`‚ö†Ô∏è RenderController: ${sectionId} bloqueado pelo StateManager`);
                return Promise.reject('Carregamento bloqueado');
            }

            // Marcar como carregando
            window.StateManager.setLoading(sectionId, true);

            // Executar renderiza√ß√£o
            return Promise.resolve()
                .then(() => renderFunction())
                .then(result => {
                    // Limpar conte√∫do indevido ap√≥s renderizar
                    this.cleanSection(sectionId);
                    window.StateManager.setLoading(sectionId, false);
                    console.log(`‚úÖ RenderController: ${sectionId} renderizado com sucesso`);
                    return result;
                })
                .catch(error => {
                    window.StateManager.setLoading(sectionId, false);
                    console.error(`‚ùå RenderController: Erro ao renderizar ${sectionId}:`, error);
                    throw error;
                });
        },

        /**
         * Limpar todas as se√ß√µes
         */
        cleanAll: function() {
            console.log('üßπ RenderController: Limpando todas as se√ß√µes...');
            Object.keys(SECTION_CONTENT_MAP).forEach(sectionId => {
                this.cleanSection(sectionId);
            });
        },

        /**
         * Obter configura√ß√£o de uma se√ß√£o
         */
        getSectionConfig: function(sectionId) {
            return SECTION_CONTENT_MAP[sectionId] || null;
        },

        /**
         * Debug: mostrar configura√ß√µes
         */
        debug: function() {
            console.log('üìä RENDER CONTROLLER CONFIG:');
            Object.keys(SECTION_CONTENT_MAP).forEach(sectionId => {
                console.log(`  ${sectionId}:`, SECTION_CONTENT_MAP[sectionId]);
            });
        }
    };

    // Expor globalmente
    window.RenderController = RenderController;
    window.SECTION_CONTENT_MAP = SECTION_CONTENT_MAP;

    // Auto-inicializar
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => RenderController.init());
    } else {
        RenderController.init();
    }

    console.log('‚úÖ Render Controller carregado');

})();
