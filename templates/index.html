<!DOCTYPE html>
<html lang="pt-BR" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="Sistema de Gest√£o BIOMA Uberaba v3.7 - Sistema Completo">
    <meta name="author" content="Juan Marco (@juanmarco1999)">
    <title>BIOMA Uberaba v3.7 - Sistema Profissional</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üå≥</text></svg>">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/correcoes_bioma.css">
    <link rel="stylesheet" href="/static/css/bioma_melhorias.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
:root[data-theme="light"]{--primary:#7C3AED;--primary-dark:#6D28D9;--secondary:#EC4899;--accent:#F59E0B;--success:#10B981;--danger:#EF4444;--warning:#F59E0B;--info:#3B82F6;--bg-main:#F9FAFB;--bg-card:#FFFFFF;--bg-sidebar:#1F2937;--bg-sidebar-hover:#374151;--text-primary:#1F2937;--text-secondary:#6B7280;--text-muted:#9CA3AF;--border-color:#E5E7EB;--shadow:0 4px 20px rgba(0,0,0,0.08);--shadow-hover:0 8px 30px rgba(124,58,237,0.15)}:root[data-theme="dark"]{--primary:#8B5CF6;--primary-dark:#7C3AED;--secondary:#F472B6;--accent:#FBBF24;--success:#34D399;--danger:#F87171;--warning:#FBBF24;--info:#60A5FA;--bg-main:#0F172A;--bg-card:#1E293B;--bg-sidebar:#0F172A;--bg-sidebar-hover:#1E293B;--text-primary:#F1F5F9;--text-secondary:#CBD5E1;--text-muted:#94A3B8;--border-color:#334155;--shadow:0 4px 20px rgba(0,0,0,0.4);--shadow-hover:0 8px 30px rgba(139,92,246,0.3)}*{margin:0;padding:0;box-sizing:border-box;transition:background-color .3s ease,color .3s ease,border-color .3s ease}body{font-family:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:var(--bg-main);color:var(--text-primary);overflow-x:hidden;line-height:1.6}.auth-screen{min-height:100vh;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);padding:20px;animation:gradientAnimation 15s ease infinite;background-size:400% 400%}@keyframes gradientAnimation{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}.auth-box{background:rgba(255,255,255,0.98);backdrop-filter:blur(10px);border-radius:30px;padding:50px;max-width:500px;width:100%;box-shadow:0 30px 80px rgba(0,0,0,0.4);animation:slideUp 0.6s cubic-bezier(0.68,-0.55,0.265,1.55)}@keyframes slideUp{from{opacity:0;transform:translateY(50px) scale(0.9)}to{opacity:1;transform:translateY(0) scale(1)}}.auth-logo{text-align:center;margin-bottom:40px}.auth-logo .logo-icon{font-size:5rem;background:linear-gradient(135deg,#7C3AED,#EC4899);-webkit-background-clip:text;-webkit-text-fill-color:transparent;animation:pulse 2s ease-in-out infinite;filter:drop-shadow(0 5px 15px rgba(124,58,237,0.3))}@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}.auth-logo h2{font-weight:900;font-size:2.8rem;color:#1F2937;margin-top:20px;letter-spacing:2px}.auth-logo p{color:#6B7280;font-size:1.1rem;margin-top:10px;font-weight:500}.nav-pills .nav-link{border-radius:15px;font-weight:700;padding:12px 25px;transition:all .3s;color:#6B7280;border:none;background:transparent;cursor:pointer}.nav-pills .nav-link.active{background:linear-gradient(135deg,#7C3AED,#6D28D9);color:white;box-shadow:0 5px 20px rgba(124,58,237,0.4);transform:translateY(-2px)}.form-control,.form-select{border-radius:12px;border:2px solid #E5E7EB;padding:12px 18px;font-size:1rem;transition:all .3s;background:white;color:#1F2937}.form-control:focus,.form-select:focus{border-color:#7C3AED;box-shadow:0 0 0 5px rgba(124,58,237,0.1);outline:none;background:white}.alert{border-radius:15px;border:none;padding:15px 20px}.alert-info{background:linear-gradient(135deg,#E0E7FF,#DBEAFE);color:#1E40AF;border-left:5px solid #3B82F6}.alert-success{background:linear-gradient(135deg,#D1FAE5,#A7F3D0);color:#065F46;border-left:5px solid #10B981}.btn{border-radius:12px;padding:12px 30px;font-weight:700;border:none;cursor:pointer;transition:all .3s ease;display:inline-flex;align-items:center;gap:10px;font-size:1rem;text-transform:uppercase;letter-spacing:0.5px}.btn i{font-size:1.2rem}.btn-primary{background:linear-gradient(135deg,var(--primary),var(--primary-dark));color:#fff;box-shadow:0 5px 20px rgba(124,58,237,0.3)}.btn-primary:hover{transform:translateY(-3px);box-shadow:0 10px 30px rgba(124,58,237,0.5);color:#fff}.btn-success{background:linear-gradient(135deg,var(--success),#059669);color:#fff}.btn-success:hover{transform:translateY(-3px);color:#fff}.btn-danger{background:linear-gradient(135deg,var(--danger),#DC2626);color:#fff}.btn-outline{background:transparent;color:var(--primary);border:3px solid var(--primary)}.btn-outline:hover{background:var(--primary);color:#fff}.btn-secondary{background:#6B7280;color:#fff}.btn-sm{padding:8px 16px;font-size:0.85rem}.w-100{width:100%}.mt-3{margin-top:1rem}.mb-3{margin-bottom:1rem}#app{display:none}.sidebar{width:280px;background:var(--bg-sidebar);color:#fff;position:fixed;height:100vh;overflow-y:auto;z-index:1000;box-shadow:4px 0 25px rgba(0,0,0,0.2)}.sidebar::-webkit-scrollbar{width:8px}.sidebar::-webkit-scrollbar-track{background:rgba(255,255,255,0.05)}.sidebar::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.2);border-radius:4px}.sidebar-logo{padding:30px 20px;text-align:center;background:linear-gradient(135deg,var(--primary),var(--secondary));border-bottom:5px solid var(--accent)}.sidebar-logo h1{font-size:2.5rem;font-weight:900;letter-spacing:5px;margin:0;text-shadow:2px 2px 8px rgba(0,0,0,0.3)}.sidebar-logo p{font-size:1rem;opacity:0.95;margin:10px 0 0 0;letter-spacing:2px}.sidebar-menu{list-style:none;padding:20px 0}.sidebar-menu li a{display:flex;align-items:center;gap:12px;padding:14px 20px;color:rgba(255,255,255,0.85);text-decoration:none;transition:all .3s;border-left:5px solid transparent;font-weight:500;font-size:0.95rem}.sidebar-menu li a i{font-size:1.3rem;width:25px}.sidebar-menu li a:hover{background:var(--bg-sidebar-hover);color:#fff;border-left-color:var(--accent);padding-left:28px}.sidebar-menu li a.active{background:var(--bg-sidebar-hover);color:#fff;border-left-color:var(--primary);font-weight:700}.theme-toggle{padding:15px 20px;border-top:1px solid rgba(255,255,255,0.1)}.theme-toggle button{width:100%;padding:12px;background:rgba(255,255,255,0.1);border:2px solid rgba(255,255,255,0.2);border-radius:12px;color:#fff;font-weight:600;cursor:pointer;transition:all .3s;display:flex;align-items:center;justify-content:center;gap:10px}.main-content{margin-left:280px;padding:30px 40px;min-height:100vh;max-height:100vh;overflow-y:auto;overflow-x:hidden}.main-content::-webkit-scrollbar{width:10px}.main-content::-webkit-scrollbar-track{background:var(--bg-main)}.main-content::-webkit-scrollbar-thumb{background:var(--primary);border-radius:5px}.content-section{display:none}.content-section.active{display:block;animation:fadeIn 0.4s ease}@keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}.page-header{margin-bottom:30px;padding-bottom:20px;border-bottom:3px solid var(--border-color);display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:20px}.page-header h1{font-size:2.2rem;font-weight:900;background:linear-gradient(135deg,var(--primary),var(--secondary));-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin:0;display:flex;align-items:center;gap:15px}.stat-card{background:var(--bg-card);border-radius:20px;padding:30px;box-shadow:var(--shadow);transition:all .3s;text-align:center;position:relative;overflow:hidden;border:2px solid var(--border-color)}.stat-card::before{content:'';position:absolute;top:0;left:0;width:100%;height:6px;background:linear-gradient(90deg,var(--primary),var(--secondary))}.stat-card:hover{transform:translateY(-10px);box-shadow:var(--shadow-hover);border-color:var(--primary)}.stat-card .icon{width:70px;height:70px;border-radius:18px;display:flex;align-items:center;justify-content:center;font-size:2rem;margin:0 auto 15px;background:linear-gradient(135deg,var(--primary),var(--primary-dark));color:#fff;box-shadow:0 10px 25px rgba(124,58,237,0.3)}.stat-card h3{font-size:3rem;font-weight:900;margin:15px 0 10px;background:linear-gradient(135deg,var(--primary),var(--secondary));-webkit-background-clip:text;-webkit-text-fill-color:transparent}.stat-card p{color:var(--text-secondary);font-size:1rem;font-weight:700;margin:0;text-transform:uppercase;letter-spacing:1px}.card{background:var(--bg-card);border-radius:20px;box-shadow:var(--shadow);margin-bottom:30px;overflow:visible;transition:all .3s;border:2px solid var(--border-color)}.card-header{background:linear-gradient(135deg,var(--primary),var(--primary-dark));color:#fff;padding:20px 30px;font-weight:800;font-size:1.2rem;display:flex;align-items:center;gap:12px}.card-body{padding:30px}table{width:100%;border-collapse:collapse;font-size:0.95rem}table thead th{background:linear-gradient(135deg,var(--primary),var(--primary-dark));color:#fff;padding:16px 14px;text-align:left;font-weight:800;text-transform:uppercase;letter-spacing:0.5px;font-size:0.85rem}table tbody tr{border-bottom:2px solid var(--border-color);transition:all .2s}table tbody tr:hover{background:var(--bg-main);transform:scale(1.01)}table tbody td{padding:16px 14px;vertical-align:middle;color:var(--text-primary)}.badge{padding:8px 16px;border-radius:20px;font-weight:800;font-size:0.8rem;display:inline-block;text-transform:uppercase;letter-spacing:0.5px}.badge.success{background:linear-gradient(135deg,var(--success),#059669);color:#fff}.badge.warning{background:linear-gradient(135deg,var(--warning),#F59E0B);color:#000}.badge.danger{background:linear-gradient(135deg,var(--danger),#DC2626);color:#fff}.spinner{border:4px solid var(--border-color);border-top:4px solid var(--primary);border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite;margin:20px auto}@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}.text-center{text-align:center}.text-muted{color:var(--text-secondary)}.text-success{color:var(--success)}.text-danger{color:var(--danger)}.autocomplete-results{position:absolute;top:100%;left:0;right:0;background:var(--bg-card);border:2px solid var(--primary);border-radius:14px;margin-top:5px;max-height:350px;overflow-y:auto;z-index:9999;box-shadow:0 10px 40px rgba(124,58,237,0.3);display:none}.autocomplete-results::-webkit-scrollbar{width:8px}.autocomplete-results::-webkit-scrollbar-track{background:var(--bg-main);border-radius:10px}.autocomplete-results::-webkit-scrollbar-thumb{background:var(--primary);border-radius:10px}.autocomplete-item{padding:14px 18px;border-bottom:1px solid var(--border-color);cursor:pointer;transition:all .2s ease;word-wrap:break-word;white-space:normal}.autocomplete-item:hover{background:linear-gradient(135deg,rgba(124,58,237,0.1),rgba(236,72,153,0.1));transform:translateX(5px);border-left:4px solid var(--primary)}.autocomplete-item:last-child{border-bottom:none}.autocomplete-item strong{color:var(--primary);font-size:1.05rem;display:block;margin-bottom:5px}.autocomplete-item small{color:var(--text-secondary);font-size:0.9rem;display:block}.row{display:flex;flex-wrap:wrap;margin:0 -15px}.row.g-4>*{padding:0 15px;margin-bottom:25px}[class^="col-"]{padding:0 15px}.col-12{width:100%}@media (min-width:768px){.col-md-6{width:50%}.col-md-4{width:33.333%}.col-md-3{width:25%}.col-md-2{width:16.666%}}@media (min-width:992px){.col-lg-3{width:25%}.col-lg-4{width:33.333%}.col-lg-6{width:50%}}
    </style>
</head>
<body>

<div id="authScreen" class="auth-screen">
    <div class="auth-box">
        <div class="auth-logo">
            <div class="logo-icon">üå≥</div>
            <h2>BIOMA</h2>
            <p>Uberaba - v3.7</p>
        </div>
        <ul class="nav nav-pills nav-fill mb-4">
            <li class="nav-item"><button class="nav-link active" id="loginTab" onclick="switchTab('login')"><i class="bi bi-box-arrow-in-right"></i> Login</button></li>
            <li class="nav-item"><button class="nav-link" id="registerTab" onclick="switchTab('register')"><i class="bi bi-person-plus"></i> Cadastro</button></li>
        </ul>
        <div id="loginForm">
            <form onsubmit="return handleLogin(event)">
                <div class="mb-3"><label>Usu√°rio ou E-mail</label><input type="text" class="form-control" id="loginUsername" required autocomplete="username"></div>
                <div class="mb-3"><label>Senha</label><input type="password" class="form-control" id="loginPassword" required autocomplete="current-password"></div>
                <div class="alert alert-info"><strong>üîë Acesso Padr√£o:</strong><br>Usu√°rio: <code>admin</code><br>Senha: <code>admin123</code></div>
                <button type="submit" class="btn btn-primary w-100"><i class="bi bi-box-arrow-in-right"></i> Entrar</button>
            </form>
        </div>
        <div id="registerForm" style="display:none">
            <form onsubmit="return handleRegister(event)">
                <div class="mb-3"><label>Nome Completo *</label><input type="text" class="form-control" id="registerName" required></div>
                <div class="mb-3"><label>Usu√°rio *</label><input type="text" class="form-control" id="registerUsername" required autocomplete="username"></div>
                <div class="mb-3"><label>E-mail *</label><input type="email" class="form-control" id="registerEmail" required autocomplete="email"></div>
                <div class="mb-3"><label>Telefone (opcional)</label><input type="text" class="form-control" id="registerTelefone" placeholder="(34) 99999-9999"></div>
                <div class="mb-3"><label>Senha *</label><input type="password" class="form-control" id="registerPassword" required minlength="6" autocomplete="new-password"></div>
                <div class="alert alert-success"><strong>‚úÖ Privil√©gios ADMIN</strong><br>Todos os novos usu√°rios recebem acesso completo ao sistema!</div>
                <button type="submit" class="btn btn-primary w-100"><i class="bi bi-person-plus"></i> Criar Conta</button>
            </form>
        </div>
    </div>
</div>

<div id="app">
    <nav class="sidebar">
        <div class="sidebar-logo"><h1>BIOMA</h1><p>Uberaba v3.7</p></div>
        <ul class="sidebar-menu">
            <li><a href="#" onclick="goTo('dashboard')" class="active" id="menu-dashboard"><i class="bi bi-speedometer2"></i> Dashboard</a></li>
            <li><a href="#" onclick="goTo('orcamento')" id="menu-orcamento"><i class="bi bi-file-earmark-plus"></i> Novo Or√ßamento</a></li>
            <li><a href="#" onclick="goTo('consultar')" id="menu-consultar"><i class="bi bi-search"></i> Consultar</a></li>
            <li><a href="#" onclick="goTo('contratos')" id="menu-contratos"><i class="bi bi-file-earmark-check"></i> Contratos</a></li>
            <li><a href="#" onclick="goTo('relatorios')" id="menu-relatorios"><i class="bi bi-bar-chart-line"></i> Relat√≥rios</a></li>
            <li><a href="#" onclick="goTo('agendamentos')" id="menu-agendamentos"><i class="bi bi-calendar-check"></i> Agendamentos</a></li>
            <li><a href="#" onclick="goTo('fila')" id="menu-fila"><i class="bi bi-people-fill"></i> Fila</a></li>
            <li><a href="#" onclick="goTo('clientes')" id="menu-clientes"><i class="bi bi-people"></i> Clientes</a></li>
            <li><a href="#" onclick="goTo('profissionais')" id="menu-profissionais"><i class="bi bi-person-workspace"></i> Profissionais</a></li>
            <li><a href="#" onclick="goTo('servicos')" id="menu-servicos"><i class="bi bi-scissors"></i> Servi√ßos</a></li>
            <li><a href="#" onclick="goTo('produtos')" id="menu-produtos"><i class="bi bi-box-seam"></i> Produtos</a></li>
            <li><a href="#" onclick="goTo('estoque')" id="menu-estoque"><i class="bi bi-box-seam-fill"></i> Estoque</a></li>
            <li><a href="#" onclick="goTo('clube')" id="menu-clube"><i class="bi bi-award"></i> Comunidade</a></li>
            <li><a href="#" onclick="goTo('importar')" id="menu-importar"><i class="bi bi-cloud-upload"></i> Importar</a></li>
            <li><a href="#" onclick="goTo('sistema')" id="menu-sistema"><i class="bi bi-activity"></i> Sistema</a></li>
            <li><a href="#" onclick="goTo('configuracoes')" id="menu-configuracoes"><i class="bi bi-gear"></i> Configura√ß√µes</a></li>
            <li><a href="#" onclick="doLogout()"><i class="bi bi-box-arrow-right"></i> Sair</a></li>
        </ul>
        <div class="theme-toggle"><button onclick="toggleTheme()"><i class="bi bi-moon-stars-fill" id="themeIcon"></i><span id="themeText">Modo Escuro</span></button></div>
    </nav>

    <div class="main-content">

        <div id="section-dashboard" class="content-section active">
            <div class="page-header"><h1><i class="bi bi-speedometer2"></i> Dashboard</h1></div>
            <div class="row g-4 mb-4">
                <div class="col-lg-3 col-md-6"><div class="stat-card"><div class="icon"><i class="bi bi-file-earmark-text"></i></div><h3 id="dashOrcamentos">0</h3><p>Or√ßamentos</p></div></div>
                <div class="col-lg-3 col-md-6"><div class="stat-card"><div class="icon"><i class="bi bi-people"></i></div><h3 id="dashClientes">0</h3><p>Clientes</p></div></div>
                <div class="col-lg-3 col-md-6"><div class="stat-card"><div class="icon"><i class="bi bi-calendar-check"></i></div><h3 id="dashAgendamentos">0</h3><p>Agendamentos Hoje</p></div></div>
                <div class="col-lg-3 col-md-6"><div class="stat-card"><div class="icon"><i class="bi bi-currency-dollar"></i></div><h3 id="dashFaturamento">R$ 0</h3><p>Faturamento</p></div></div>
            </div>
            <div class="row g-4">
                <div class="col-md-6"><div class="card"><div class="card-header"><i class="bi bi-exclamation-triangle"></i> Alertas de Estoque</div><div class="card-body" id="alertasEstoque"><div class="spinner"></div></div></div></div>
                <div class="col-md-6"><div class="card"><div class="card-header"><i class="bi bi-calendar-event"></i> Pr√≥ximos Agendamentos</div><div class="card-body" id="proximosAgendamentos"><div class="spinner"></div></div></div></div>
            </div>
            <div class="card mt-4"><div class="card-header"><i class="bi bi-clock-history"></i> √öltimos Or√ßamentos</div><div class="card-body"><div class="table-responsive"><table><thead><tr><th>N¬∫</th><th>Data</th><th>Cliente</th><th>Valor</th><th>Status</th></tr></thead><tbody id="ultimosOrcamentosBody"><tr><td colspan="5" class="text-center"><div class="spinner"></div></td></tr></tbody></table></div></div></div>
        </div>

        <div id="section-orcamento" class="content-section">
            <div class="page-header"><h1><i class="bi bi-file-earmark-plus"></i> Novo Or√ßamento</h1></div>
            <div class="card"><div class="card-header"><i class="bi bi-person-badge"></i> Dados do Cliente</div><div class="card-body"><div class="row g-3 mb-3"><div class="col-md-6"><label style="display:block;font-weight:700;margin-bottom:10px">CPF *</label><div style="position:relative"><input type="text" id="orcCPF" placeholder="Digite o CPF..." maxlength="14" class="form-control" onkeyup="buscarClientePorCPF()"><div id="cpfResults" class="autocomplete-results"></div></div></div><div class="col-md-6"><label style="display:block;font-weight:700;margin-bottom:10px">Nome Completo *</label><input type="text" id="orcNomeCliente" placeholder="Nome do cliente" class="form-control"></div></div><div class="row g-3 mb-3"><div class="col-md-6"><label style="display:block;font-weight:700;margin-bottom:10px">E-mail</label><input type="email" id="orcEmail" placeholder="email@exemplo.com" class="form-control"></div><div class="col-md-6"><label style="display:block;font-weight:700;margin-bottom:10px">Telefone</label><input type="text" id="orcTelefone" placeholder="(34) 99999-9999" class="form-control"></div></div><button class="btn btn-outline" onclick="limparCliente()"><i class="bi bi-x-circle"></i> Limpar</button></div></div>
            <h2 style="margin:40px 0 20px;color:var(--text-primary);padding-left:20px;border-left:6px solid var(--primary)"><i class="bi bi-scissors"></i> SERVI√áOS</h2>
            <div class="card"><div class="card-header"><i class="bi bi-plus-circle"></i> Adicionar Servi√ßo</div><div class="card-body"><div class="row g-3"><div class="col-md-3"><label>Buscar Servi√ßo</label><div style="position:relative"><input type="text" id="buscaServico" placeholder="Digite..." class="form-control" onkeyup="buscarServicos()"><div id="servicoResults" class="autocomplete-results"></div></div></div><div class="col-md-2"><label>Tamanho</label><select id="servicoTamanho" class="form-select"><option value="">Selecione...</option></select></div><div class="col-md-2"><label>Qtd</label><input type="number" id="servicoQtd" value="1" min="1" class="form-control"></div><div class="col-md-2"><label>Pre√ßo</label><input type="number" id="servicoPreco" step="0.01" class="form-control"></div><div class="col-md-2"><label>Desc %</label><input type="number" id="servicoDesconto" value="0" min="0" max="100" class="form-control"></div><div class="col-md-1"><label>&nbsp;</label><button class="btn btn-primary w-100" onclick="addServico()"><i class="bi bi-plus"></i></button></div></div></div></div>
            <div class="card"><div class="card-header"><i class="bi bi-list-check"></i> Servi√ßos Adicionados</div><div class="card-body"><div class="table-responsive"><table><thead><tr><th>Servi√ßo</th><th>Tamanho</th><th>Qtd</th><th>Pre√ßo Unit.</th><th>Desc %</th><th>Total</th><th></th></tr></thead><tbody id="servicosBody"><tr><td colspan="7" class="text-center text-muted">Nenhum servi√ßo</td></tr></tbody><tfoot><tr><th colspan="5" style="text-align:right;padding:20px 18px;background:var(--bg-main);font-weight:800;border-top:4px solid var(--primary)">SUBTOTAL SERVI√áOS</th><th id="subtotalServicos" colspan="2" style="padding:20px 18px;background:var(--bg-main);font-weight:800;border-top:4px solid var(--primary)">R$ 0,00</th></tr></tfoot></table></div></div></div>
            <h2 style="margin:40px 0 20px;color:var(--text-primary);padding-left:20px;border-left:6px solid var(--primary)"><i class="bi bi-box-seam"></i> PRODUTOS</h2>
            <div class="card"><div class="card-header"><i class="bi bi-plus-circle"></i> Adicionar Produto</div><div class="card-body"><div class="row g-3"><div class="col-md-4"><label>Buscar Produto</label><div style="position:relative"><input type="text" id="buscaProduto" placeholder="Digite..." class="form-control" onkeyup="buscarProdutos()"><div id="produtoResults" class="autocomplete-results"></div></div></div><div class="col-md-2"><label>Qtd</label><input type="number" id="produtoQtd" value="1" min="1" class="form-control"></div><div class="col-md-2"><label>Pre√ßo</label><input type="number" id="produtoPreco" step="0.01" class="form-control"></div><div class="col-md-2"><label>Desc %</label><input type="number" id="produtoDesconto" value="0" min="0" max="100" class="form-control"></div><div class="col-md-2"><label>&nbsp;</label><button class="btn btn-primary w-100" onclick="addProduto()"><i class="bi bi-plus"></i> Add</button></div></div></div></div>
            <div class="card"><div class="card-header"><i class="bi bi-list-check"></i> Produtos Adicionados</div><div class="card-body"><div class="table-responsive"><table><thead><tr><th>Produto</th><th>Marca</th><th>Qtd</th><th>Pre√ßo Unit.</th><th>Desc %</th><th>Total</th><th></th></tr></thead><tbody id="produtosBody"><tr><td colspan="7" class="text-center text-muted">Nenhum produto</td></tr></tbody><tfoot><tr><th colspan="5" style="text-align:right;padding:20px 18px;background:var(--bg-main);font-weight:800;border-top:4px solid var(--primary)">SUBTOTAL PRODUTOS</th><th id="subtotalProdutos" colspan="2" style="padding:20px 18px;background:var(--bg-main);font-weight:800;border-top:4px solid var(--primary)">R$ 0,00</th></tr></tfoot></table></div></div></div>
            <div class="card"><div class="card-header"><i class="bi bi-calculator"></i> Resumo e Pagamento</div><div class="card-body"><div class="row g-3 mb-3"><div class="col-md-4"><label>Desconto Global %</label><input type="number" id="descontoGlobal" value="0" min="0" max="100" onchange="calcularTotais()" class="form-control"></div><div class="col-md-4"><label>Cashback %</label><input type="number" id="cashbackPerc" value="0" min="0" max="100" onchange="calcularTotais()" class="form-control"></div><div class="col-md-4"><label>Forma de Pagamento</label><select id="pagamento" class="form-select"><option>Pix</option><option>D√©bito</option><option>Cr√©dito √† Vista</option><option>Cr√©dito Parcelado</option><option>Dinheiro</option></select></div></div><div style="background:linear-gradient(135deg,var(--primary),var(--secondary));color:#fff;padding:40px;border-radius:22px;margin:30px 0;box-shadow:0 15px 40px rgba(124,58,237,0.4)"><div class="row align-items-center"><div class="col-md-6"><h3 id="totalFinalOrc" style="font-size:3.5rem;font-weight:900;margin:0;text-shadow:2px 2px 8px rgba(0,0,0,0.3)">R$ 0,00</h3><p style="font-size:1.3rem;margin:10px 0 0;opacity:0.95">TOTAL</p></div><div class="col-md-6" style="text-align:right"><p id="cashbackValor" style="font-size:1.5rem;margin:0;font-weight:700">üéÅ Cashback: R$ 0,00</p></div></div></div><div style="text-align:center;margin-top:30px"><button class="btn btn-secondary" onclick="cancelarOrc()"><i class="bi bi-x-circle"></i> Cancelar</button> <button class="btn btn-outline" onclick="salvarOrc('Pendente')"><i class="bi bi-save"></i> Salvar Rascunho</button> <button class="btn btn-success" onclick="salvarOrc('Aprovado')"><i class="bi bi-check-circle"></i> Gerar Contrato</button></div></div></div>
        </div>

        <div id="section-consultar" class="content-section">
            <div class="page-header"><h1><i class="bi bi-search"></i> Consultar Or√ßamentos</h1></div>
            <div class="card"><div class="card-header"><i class="bi bi-list-ul"></i> Todos os Or√ßamentos</div><div class="card-body"><div class="table-responsive"><table><thead><tr><th>N¬∫</th><th>Data</th><th>Cliente</th><th>Total</th><th>Status</th><th>A√ß√µes</th></tr></thead><tbody id="consultaBody"><tr><td colspan="6" class="text-center"><div class="spinner"></div></td></tr></tbody></table></div></div></div>
        </div>

        <div id="section-contratos" class="content-section">
            <div class="page-header"><h1><i class="bi bi-file-earmark-check"></i> Contratos Aprovados</h1></div>
            <div class="card"><div class="card-header"><i class="bi bi-file-check-fill"></i> Contratos</div><div class="card-body"><div class="table-responsive"><table><thead><tr><th>N¬∫</th><th>Data</th><th>Cliente</th><th>Total</th><th>A√ß√µes</th></tr></thead><tbody id="contratosBody"><tr><td colspan="5" class="text-center"><div class="spinner"></div></td></tr></tbody></table></div></div></div>
        </div>

        <div id="section-relatorios" class="content-section">
            <div class="page-header"><h1><i class="bi bi-bar-chart-line"></i> Relat√≥rios</h1><button class="btn btn-outline" onclick="loadRelatorios()"><i class="bi bi-arrow-clockwise"></i> Atualizar</button></div>
            <div class="row g-4 mb-4">
                <div class="col-md-3"><div class="stat-card"><div class="icon"><i class="bi bi-cash-stack"></i></div><h3 id="relFaturamentoTotal">R$ 0</h3><p>Faturamento Total</p></div></div>
                <div class="col-md-3"><div class="stat-card"><div class="icon"><i class="bi bi-calendar-month"></i></div><h3 id="relFaturamentoMes">R$ 0</h3><p>Faturamento M√™s</p></div></div>
                <div class="col-md-3"><div class="stat-card"><div class="icon"><i class="bi bi-award"></i></div><h3 id="relCashbackTotal">R$ 0</h3><p>Cashback Gerado</p></div></div>
                <div class="col-md-3"><div class="stat-card"><div class="icon"><i class="bi bi-graph-up"></i></div><h3 id="relTicketMedio">R$ 0</h3><p>Ticket M√©dio</p></div></div>
            </div>
            <div class="row g-4">
                <div class="col-md-6"><div class="card"><div class="card-header"><i class="bi bi-trophy"></i> Top 5 Servi√ßos</div><div class="card-body"><canvas id="chartServicos" style="max-height:300px"></canvas></div></div></div>
                <div class="col-md-6"><div class="card"><div class="card-header"><i class="bi bi-calendar3"></i> Faturamento Mensal</div><div class="card-body"><canvas id="chartFaturamento" style="max-height:300px"></canvas></div></div></div>
            </div>
            <div class="row g-4 mt-2">
                <div class="col-md-6"><div class="card"><div class="card-header"><i class="bi bi-box-seam"></i> Estoque</div><div class="card-body"><canvas id="chartEstoque" style="max-height:300px"></canvas></div></div></div>
                <div class="col-md-6"><div class="card"><div class="card-header"><i class="bi bi-graph-up"></i> Vendas por Categoria</div><div class="card-body"><canvas id="chartVendasCategoria" style="max-height:300px"></canvas></div></div></div>
            </div>
            <div class="row g-4 mt-2">
                <div class="col-md-6"><div class="card"><div class="card-header"><i class="bi bi-people"></i> Faturamento por Profissional</div><div class="card-body"><canvas id="chartFaturamentoProfissional" style="max-height:300px"></canvas></div></div></div>
                <div class="col-md-6"><div class="card"><div class="card-header"><i class="bi bi-fire"></i> Mapa de Calor Semanal</div><div class="card-body"><canvas id="chartMapaCalor" style="max-height:300px"></canvas></div></div></div>
            </div>
            <div class="card mt-4"><div class="card-header"><i class="bi bi-people-fill"></i> Top 10 Clientes VIP</div><div class="card-body"><div class="table-responsive"><table><thead><tr><th>Posi√ß√£o</th><th>Cliente</th><th>Total Gasto</th><th>Visitas</th><th>√öltima Visita</th></tr></thead><tbody id="topClientesBody"><tr><td colspan="5" class="text-center text-muted">Clique em "Atualizar"</td></tr></tbody></table></div></div></div>
            <div class="card mt-4"><div class="card-header"><i class="bi bi-box-seam"></i> Produtos Mais Vendidos</div><div class="card-body"><div class="table-responsive"><table><thead><tr><th>Produto</th><th>Qtd Vendida</th><th>Faturamento</th></tr></thead><tbody id="topProdutosBody"><tr><td colspan="3" class="text-center text-muted">Clique em "Atualizar"</td></tr></tbody></table></div></div></div>
        </div>

        <div id="section-agendamentos" class="content-section">
            <div class="page-header"><h1><i class="bi bi-calendar-check"></i> Agendamentos</h1><button class="btn btn-primary" onclick="showModalAgendamento()"><i class="bi bi-plus-circle"></i> Novo</button></div>

            <!-- MELHORIA #9: Calend√°rio Avan√ßado com Mapa de Calor -->
            <div class="card mb-4">
                <div class="card-header">
                    <i class="bi bi-calendar3"></i> Calend√°rio Avan√ßado
                    <button class="btn btn-sm btn-outline float-end" onclick="carregarCalendarioAvancado()">
                        <i class="bi bi-arrow-clockwise"></i> Atualizar
                    </button>
                </div>
                <div class="card-body">
                    <div id="calendario-container">
                        <div class="text-center text-muted">
                            <div class="spinner"></div>
                            <p class="mt-3">Carregando calend√°rio...</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card"><div class="card-header"><i class="bi bi-list-ul"></i> Lista de Agendamentos</div><div class="card-body"><div class="table-responsive"><table><thead><tr><th>Data</th><th>Hor√°rio</th><th>Cliente</th><th>Servi√ßo</th><th>Status</th></tr></thead><tbody id="agendamentosBody"><tr><td colspan="5" class="text-center"><div class="spinner"></div></td></tr></tbody></table></div></div></div>
        </div>

        <div id="section-fila" class="content-section">
            <div class="page-header"><h1><i class="bi bi-people-fill"></i> Fila</h1><button class="btn btn-primary" onclick="showModalFila()"><i class="bi bi-plus-circle"></i> Adicionar</button></div>
            <div class="card"><div class="card-header"><i class="bi bi-list-ol"></i> Fila Atual (<span id="totalFila">0</span>)</div><div class="card-body" id="filaContainer"><div class="spinner"></div></div></div>
        </div>

        <div id="section-clientes" class="content-section">
            <div class="page-header"><h1><i class="bi bi-people"></i> Clientes</h1><button class="btn btn-primary" onclick="showModalCliente()"><i class="bi bi-person-plus"></i> Novo</button></div>
            <div class="card"><div class="card-header"><i class="bi bi-people-fill"></i> Lista de Clientes</div><div class="card-body"><div class="mb-3"><input type="text" class="form-control" id="buscaCliente" placeholder="üîç Buscar..." onkeyup="filtrarClientes()"></div><div class="table-responsive"><table><thead><tr><th>Nome</th><th>CPF</th><th>Telefone</th><th>Total Gasto</th><th>Visitas</th><th>A√ß√µes</th></tr></thead><tbody id="clientesBody"><tr><td colspan="6" class="text-center"><div class="spinner"></div></td></tr></tbody></table></div></div></div>
        </div>

        <div id="section-profissionais" class="content-section">
            <div class="page-header"><h1><i class="bi bi-person-workspace"></i> Profissionais</h1><button class="btn btn-primary" onclick="showModalProfissional()"><i class="bi bi-person-plus"></i> Novo</button></div>
            <div class="card"><div class="card-header"><i class="bi bi-people-fill"></i> Equipe BIOMA</div><div class="card-body"><div class="table-responsive"><table><thead><tr><th>Nome</th><th>CPF</th><th>Especialidade</th><th>Comiss√£o</th><th>Status</th><th>A√ß√µes</th></tr></thead><tbody id="profissionaisBody"><tr><td colspan="6" class="text-center"><div class="spinner"></div></td></tr></tbody></table></div></div></div>
        </div>

        <div id="section-servicos" class="content-section">
            <div class="page-header"><h1><i class="bi bi-scissors"></i> Servi√ßos</h1><button class="btn btn-primary" onclick="showModalServico()"><i class="bi bi-plus-circle"></i> Novo</button></div>
            <div class="card"><div class="card-header"><i class="bi bi-list-ul"></i> Cat√°logo</div><div class="card-body"><div class="table-responsive"><table><thead><tr><th>Nome</th><th>Tamanho</th><th>Pre√ßo</th><th>Categoria</th><th>A√ß√µes</th></tr></thead><tbody id="servicosListBody"><tr><td colspan="5" class="text-center"><div class="spinner"></div></td></tr></tbody></table></div></div></div>
        </div>

        <div id="section-produtos" class="content-section">
            <div class="page-header"><h1><i class="bi bi-box-seam"></i> Produtos</h1><button class="btn btn-primary" onclick="showModalProduto()"><i class="bi bi-plus-circle"></i> Novo</button></div>
            <div class="card"><div class="card-header"><i class="bi bi-box-fill"></i> Estoque</div><div class="card-body"><div class="table-responsive"><table><thead><tr><th>Nome</th><th>Marca</th><th>Pre√ßo</th><th>Estoque</th><th>A√ß√µes</th></tr></thead><tbody id="produtosListBody"><tr><td colspan="5" class="text-center"><div class="spinner"></div></td></tr></tbody></table></div></div></div>
        </div>

        <div id="section-estoque" class="content-section">
            <div class="page-header">
                <h1><i class="bi bi-box-seam-fill"></i> Gerenciamento de Estoque Avan√ßado</h1>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-success" onclick="addSaidaEstoque()">
                        <i class="bi bi-box-arrow-right"></i> Nova Sa√≠da
                    </button>
                    <button class="btn btn-primary" onclick="loadEstoqueMelhorado()">
                        <i class="bi bi-arrow-clockwise"></i> Atualizar
                    </button>
                </div>
            </div>

            <!-- Estat√≠sticas de Estoque -->
            <div class="row g-4 mb-4">
                <div class="col-md-3">
                    <div class="estoque-stat-card">
                        <div class="estoque-stat-icon">üì¶</div>
                        <div class="estoque-stat-valor" id="estoque-total">0</div>
                        <div class="estoque-stat-label">Total de Produtos</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="estoque-stat-card">
                        <div class="estoque-stat-icon">‚ö†Ô∏è</div>
                        <div class="estoque-stat-valor" id="estoque-baixo">0</div>
                        <div class="estoque-stat-label">Produtos em Falta</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="estoque-stat-card">
                        <div class="estoque-stat-icon">‚ùå</div>
                        <div class="estoque-stat-valor" id="estoque-zerado">0</div>
                        <div class="estoque-stat-label">Estoque Zerado</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="estoque-stat-card">
                        <div class="estoque-stat-icon">‚è≥</div>
                        <div class="estoque-stat-valor" id="estoque-pendentes">0</div>
                        <div class="estoque-stat-label">Pendentes</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="estoque-stat-card">
                        <div class="estoque-stat-icon">üí∞</div>
                        <div class="estoque-stat-valor" id="estoque-valor">R$ 0</div>
                        <div class="estoque-stat-label">Valor Total</div>
                    </div>
                </div>
            </div>

            <!-- Produtos em Falta -->
            <div class="card mb-4">
                <div class="card-header">
                    <i class="bi bi-exclamation-triangle-fill"></i> Produtos em Falta / Estoque Baixo
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>Produto</th>
                                    <th>Marca</th>
                                    <th>Estoque Atual</th>
                                    <th>Estoque M√≠nimo</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="produtos-falta-body">
                                <tr>
                                    <td colspan="5" class="text-center">
                                        <div class="spinner"></div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Produtos Cr√≠ticos (‚â§30% do m√≠nimo) -->
            <div class="card mb-4">
                <div class="card-header" style="background: linear-gradient(135deg, #EF4444, #DC2626);">
                    <i class="bi bi-exclamation-octagon"></i> Produtos Cr√≠ticos (‚â§30% do M√≠nimo)
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>Produto</th>
                                    <th>Marca</th>
                                    <th>Estoque</th>
                                    <th>M√≠nimo</th>
                                    <th>N√≠vel</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="produtos-criticos-body">
                                <tr>
                                    <td colspan="6" class="text-center">
                                        <div class="spinner"></div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Movimenta√ß√µes de Estoque com Aprova√ß√£o -->
            <div class="card">
                <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <i class="bi bi-clock-history"></i> √öltimas Movimenta√ß√µes
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-sm btn-success" onclick="aprovarTodas()" title="Aprovar todas pendentes">
                            <i class="bi bi-check-all"></i> Aprovar Todas
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="reprovarTodas()" title="Reprovar todas pendentes">
                            <i class="bi bi-x-lg"></i> Reprovar Todas
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>Data/Hora</th>
                                    <th>Produto</th>
                                    <th>Tipo</th>
                                    <th>Quantidade</th>
                                    <th>Motivo</th>
                                    <th>Usu√°rio</th>
                                    <th>Status</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="movimentacoes-body">
                                <tr>
                                    <td colspan="8" class="text-center">
                                        <div class="spinner"></div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="section-clube" class="content-section">
            <div class="page-header">
                <h1><i class="bi bi-award"></i> Comunidade BIOMA</h1>
                <p style="color: var(--text-secondary); font-size: 1.1rem; margin: 10px 0 0 0;">
                    Planos exclusivos de assinatura com benef√≠cios incr√≠veis
                </p>
            </div>

            <div class="row g-4">
                <!-- Plano Bronze - Viv√™ncia -->
                <div class="col-md-4">
                    <div class="plano-card fade-in-up" style="animation-delay: 0.1s;">
                        <div class="plano-header" style="background: linear-gradient(135deg, #CD7F32, #B87333);">
                            <div class="plano-icone">ü•â</div>
                            <h2 class="plano-titulo" style="color: #fff;">Viv√™ncia</h2>
                            <p style="color: rgba(255,255,255,0.9); font-size: 0.95rem; margin: 0;">
                                Ideal para come√ßar
                            </p>
                            <div style="margin-top: 20px;">
                                <span style="font-size: 2.5rem; font-weight: 900; color: #fff;">3x</span>
                                <span style="font-size: 1.5rem; color: rgba(255,255,255,0.9);"> R$ 390</span>
                            </div>
                        </div>
                        <div class="plano-body">
                            <div class="plano-beneficio">
                                <i class="bi bi-check-circle-fill"></i>
                                <span><strong>1 corte por m√™s</strong></span>
                            </div>
                            <div class="plano-beneficio">
                                <i class="bi bi-check-circle-fill"></i>
                                <span><strong>5% de desconto</strong> em produtos</span>
                            </div>
                            <div class="plano-beneficio">
                                <i class="bi bi-check-circle-fill"></i>
                                <span><strong>Acesso √† comunidade</strong> exclusiva</span>
                            </div>
                            <div class="plano-beneficio">
                                <i class="bi bi-check-circle-fill"></i>
                                <span><strong>Agendamento priorit√°rio</strong></span>
                            </div>
                            <button class="btn btn-assinar" style="background: linear-gradient(135deg, #CD7F32, #B87333); color: #fff;" onclick="assinarPlano('vivencia')">
                                <i class="bi bi-star"></i> Assinar Viv√™ncia
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Plano Prata - Imers√£o -->
                <div class="col-md-4">
                    <div class="plano-card fade-in-up" style="animation-delay: 0.2s; transform: scale(1.05); box-shadow: 0 20px 60px rgba(192, 192, 192, 0.4);">
                        <div style="position: absolute; top: -15px; right: 20px; background: linear-gradient(135deg, #7C3AED, #EC4899); color: #fff; padding: 8px 20px; border-radius: 20px; font-weight: 800; font-size: 0.9rem; box-shadow: 0 5px 15px rgba(124, 58, 237, 0.4);">
                            ‚≠ê POPULAR
                        </div>
                        <div class="plano-header" style="background: linear-gradient(135deg, #C0C0C0, #A8A8A8);">
                            <div class="plano-icone">ü•à</div>
                            <h2 class="plano-titulo" style="color: #fff;">Imers√£o</h2>
                            <p style="color: rgba(255,255,255,0.9); font-size: 0.95rem; margin: 0;">
                                Mais vantagens e economia
                            </p>
                            <div style="margin-top: 20px;">
                                <span style="font-size: 2.5rem; font-weight: 900; color: #fff;">6x</span>
                                <span style="font-size: 1.5rem; color: rgba(255,255,255,0.9);"> R$ 390</span>
                            </div>
                        </div>
                        <div class="plano-body">
                            <div class="plano-beneficio">
                                <i class="bi bi-check-circle-fill"></i>
                                <span><strong>6 cortes</strong> durante a validade</span>
                            </div>
                            <div class="plano-beneficio">
                                <i class="bi bi-check-circle-fill"></i>
                                <span><strong>10% de desconto</strong> em produtos</span>
                            </div>
                            <div class="plano-beneficio">
                                <i class="bi bi-check-circle-fill"></i>
                                <span><strong>Cashback de 3%</strong> em servi√ßos</span>
                            </div>
                            <div class="plano-beneficio">
                                <i class="bi bi-check-circle-fill"></i>
                                <span><strong>Brinde exclusivo</strong> BIOMA</span>
                            </div>
                            <div class="plano-beneficio">
                                <i class="bi bi-check-circle-fill"></i>
                                <span><strong>Agendamento VIP</strong></span>
                            </div>
                            <button class="btn btn-assinar" style="background: linear-gradient(135deg, #C0C0C0, #A8A8A8); color: #fff;" onclick="assinarPlano('imersao')">
                                <i class="bi bi-star-fill"></i> Assinar Imers√£o
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Plano Ouro - Conex√£o -->
                <div class="col-md-4">
                    <div class="plano-card fade-in-up" style="animation-delay: 0.3s;">
                        <div class="plano-header" style="background: linear-gradient(135deg, #FFD700, #FFC700);">
                            <div class="plano-icone">ü•á</div>
                            <h2 class="plano-titulo" style="color: #000;">Conex√£o</h2>
                            <p style="color: rgba(0,0,0,0.7); font-size: 0.95rem; margin: 0;">
                                Experi√™ncia completa VIP
                            </p>
                            <div style="margin-top: 20px;">
                                <span style="font-size: 2.5rem; font-weight: 900; color: #000;">12x</span>
                                <span style="font-size: 1.5rem; color: rgba(0,0,0,0.7);"> R$ 390</span>
                            </div>
                        </div>
                        <div class="plano-body">
                            <div class="plano-beneficio">
                                <i class="bi bi-check-circle-fill"></i>
                                <span><strong>12 cortes</strong> durante a validade</span>
                            </div>
                            <div class="plano-beneficio">
                                <i class="bi bi-check-circle-fill"></i>
                                <span><strong>15% de desconto</strong> em produtos</span>
                            </div>
                            <div class="plano-beneficio">
                                <i class="bi bi-check-circle-fill"></i>
                                <span><strong>Cashback de 5%</strong> em tudo</span>
                            </div>
                            <div class="plano-beneficio">
                                <i class="bi bi-check-circle-fill"></i>
                                <span><strong>Kit exclusivo</strong> de boas-vindas</span>
                            </div>
                            <div class="plano-beneficio">
                                <i class="bi bi-check-circle-fill"></i>
                                <span><strong>Acesso VIP total</strong></span>
                            </div>
                            <div class="plano-beneficio">
                                <i class="bi bi-check-circle-fill"></i>
                                <span><strong>Eventos exclusivos</strong></span>
                            </div>
                            <button class="btn btn-assinar" style="background: linear-gradient(135deg, #FFD700, #FFC700); color: #000; font-weight: 900;" onclick="assinarPlano('conexao')">
                                <i class="bi bi-trophy-fill"></i> Assinar Conex√£o
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Se√ß√£o de Compara√ß√£o -->
            <div class="card mt-5">
                <div class="card-header" style="background: linear-gradient(135deg, var(--primary), var(--secondary));">
                    <i class="bi bi-table"></i> Compara√ß√£o de Planos
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table style="width: 100%; text-align: center;">
                            <thead>
                                <tr style="background: var(--bg-main);">
                                    <th style="text-align: left; padding: 15px;">Benef√≠cio</th>
                                    <th style="padding: 15px;">Viv√™ncia ü•â</th>
                                    <th style="padding: 15px; background: rgba(124, 58, 237, 0.1);">Imers√£o ü•à</th>
                                    <th style="padding: 15px;">Conex√£o ü•á</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td style="text-align: left; padding: 15px; font-weight: 600;">Cortes inclusos</td>
                                    <td style="padding: 15px;">1/m√™s</td>
                                    <td style="padding: 15px; background: rgba(124, 58, 237, 0.05);">6 total</td>
                                    <td style="padding: 15px;">12 total</td>
                                </tr>
                                <tr>
                                    <td style="text-align: left; padding: 15px; font-weight: 600;">Desconto em produtos</td>
                                    <td style="padding: 15px;">5%</td>
                                    <td style="padding: 15px; background: rgba(124, 58, 237, 0.05);">10%</td>
                                    <td style="padding: 15px;">15%</td>
                                </tr>
                                <tr>
                                    <td style="text-align: left; padding: 15px; font-weight: 600;">Cashback</td>
                                    <td style="padding: 15px;">-</td>
                                    <td style="padding: 15px; background: rgba(124, 58, 237, 0.05);">3%</td>
                                    <td style="padding: 15px;">5%</td>
                                </tr>
                                <tr>
                                    <td style="text-align: left; padding: 15px; font-weight: 600;">Agendamento priorit√°rio</td>
                                    <td style="padding: 15px;"><i class="bi bi-check-lg" style="color: var(--success); font-size: 1.5rem;"></i></td>
                                    <td style="padding: 15px; background: rgba(124, 58, 237, 0.05);"><i class="bi bi-check-lg" style="color: var(--success); font-size: 1.5rem;"></i></td>
                                    <td style="padding: 15px;"><i class="bi bi-check-lg" style="color: var(--success); font-size: 1.5rem;"></i></td>
                                </tr>
                                <tr>
                                    <td style="text-align: left; padding: 15px; font-weight: 600;">Brindes exclusivos</td>
                                    <td style="padding: 15px;">-</td>
                                    <td style="padding: 15px; background: rgba(124, 58, 237, 0.05);"><i class="bi bi-check-lg" style="color: var(--success); font-size: 1.5rem;"></i></td>
                                    <td style="padding: 15px;"><i class="bi bi-check-lg" style="color: var(--success); font-size: 1.5rem;"></i></td>
                                </tr>
                                <tr>
                                    <td style="text-align: left; padding: 15px; font-weight: 600;">Acesso VIP total</td>
                                    <td style="padding: 15px;">-</td>
                                    <td style="padding: 15px; background: rgba(124, 58, 237, 0.05);">-</td>
                                    <td style="padding: 15px;"><i class="bi bi-check-lg" style="color: var(--success); font-size: 1.5rem;"></i></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="section-importar" class="content-section">
            <div class="page-header"><h1><i class="bi bi-cloud-upload"></i> Importar Dados</h1></div>
            <div class="row g-4">
                <div class="col-md-6"><div class="card"><div class="card-header"><i class="bi bi-box-seam"></i> Produtos</div><div class="card-body"><div style="border:3px dashed var(--border-color);border-radius:20px;padding:60px 20px;text-align:center;cursor:pointer" onclick="document.getElementById('uploadProdutos').click()"><i class="bi bi-cloud-upload" style="font-size:4rem;color:var(--primary)"></i><h4>Clique para selecionar</h4><input type="file" id="uploadProdutos" accept=".csv,.xlsx,.xls" style="display:none" onchange="handleUpload(this,'produtos')"></div><a href="/api/template/download/produtos" class="btn btn-outline w-100 mt-3"><i class="bi bi-download"></i> Template</a></div></div></div>
                <div class="col-md-6"><div class="card"><div class="card-header"><i class="bi bi-scissors"></i> Servi√ßos</div><div class="card-body"><div style="border:3px dashed var(--border-color);border-radius:20px;padding:60px 20px;text-align:center;cursor:pointer" onclick="document.getElementById('uploadServicos').click()"><i class="bi bi-cloud-upload" style="font-size:4rem;color:var(--primary)"></i><h4>Clique para selecionar</h4><input type="file" id="uploadServicos" accept=".csv,.xlsx,.xls" style="display:none" onchange="handleUpload(this,'servicos')"></div><a href="/api/template/download/servicos" class="btn btn-outline w-100 mt-3"><i class="bi bi-download"></i> Template</a></div></div></div>
            </div>
        </div>

        <div id="section-sistema" class="content-section">
            <div class="page-header"><h1><i class="bi bi-activity"></i> Status</h1><button class="btn btn-outline" onclick="verificarStatus()"><i class="bi bi-arrow-clockwise"></i> Atualizar</button></div>
            <div class="row g-4">
                <div class="col-md-4"><div class="card"><div class="card-header"><i class="bi bi-database"></i> MongoDB</div><div class="card-body text-center"><div id="mongoStatus" class="badge warning">Verificando...</div><p class="mt-3" id="mongoMessage">...</p></div></div></div>
                <div class="col-md-4"><div class="card"><div class="card-header"><i class="bi bi-envelope"></i> MailerSend</div><div class="card-body text-center"><div id="emailStatus" class="badge warning">Verificando...</div><p class="mt-3" id="emailMessage">...</p></div></div></div>
                <div class="col-md-4"><div class="card"><div class="card-header"><i class="bi bi-info-circle"></i> Vers√£o</div><div class="card-body text-center"><h3>v3.7</h3><p>BIOMA Uberaba</p></div></div></div>
            </div>
        </div>

        <div id="section-configuracoes" class="content-section">
            <div class="page-header"><h1><i class="bi bi-gear"></i> Configura√ß√µes</h1></div>

            <!-- MELHORIA #11: Logo da Empresa -->
            <div class="card">
                <div class="card-header"><i class="bi bi-image"></i> Logo da Empresa</div>
                <div class="card-body" style="text-align: center;">
                    <p class="text-muted mb-3">Configure o logo da sua empresa que aparecer√° no sistema e no login</p>
                    <button class="btn btn-primary" onclick="configurarLogoEmpresa()">
                        <i class="bi bi-upload"></i> Fazer Upload do Logo
                    </button>
                </div>
            </div>

            <div class="card mt-4"><div class="card-header"><i class="bi bi-building"></i> Dados da Franquia BIOMA</div><div class="card-body"><div class="row g-3 mb-3"><div class="col-md-6"><label style="display:block;font-weight:700;margin-bottom:10px">Nome da Empresa *</label><input type="text" id="cfgNome" value="BIOMA UBERABA" class="form-control"></div><div class="col-md-6"><label style="display:block;font-weight:700;margin-bottom:10px">CNPJ *</label><input type="text" id="cfgCNPJ" value="49.470.937/0001-10" class="form-control"></div></div><div class="mb-3"><label style="display:block;font-weight:700;margin-bottom:10px">Endere√ßo Completo *</label><input type="text" id="cfgEndereco" value="Av. Santos Dumont 3110 - Santa Maria - Uberaba/MG - CEP 38050-400" class="form-control"></div><div class="row g-3 mb-3"><div class="col-md-6"><label style="display:block;font-weight:700;margin-bottom:10px">Telefone *</label><input type="text" id="cfgTelefone" value="(34) 99235-5890" class="form-control"></div><div class="col-md-6"><label style="display:block;font-weight:700;margin-bottom:10px">E-mail *</label><input type="email" id="cfgEmail" value="biomauberaba@gmail.com" class="form-control"></div></div><button class="btn btn-primary" onclick="salvarConfig()"><i class="bi bi-save"></i> Salvar Dados da Franquia</button></div></div>
            <div class="card mt-4"><div class="card-header"><i class="bi bi-sliders"></i> Configura√ß√µes Operacionais</div><div class="card-body"><div class="row g-3 mb-3"><div class="col-md-4"><label style="display:block;font-weight:700;margin-bottom:10px">Hor√°rio Abertura</label><input type="time" id="cfgHorarioAbertura" value="08:00" class="form-control"></div><div class="col-md-4"><label style="display:block;font-weight:700;margin-bottom:10px">Hor√°rio Fechamento</label><input type="time" id="cfgHorarioFechamento" value="19:00" class="form-control"></div><div class="col-md-4"><label style="display:block;font-weight:700;margin-bottom:10px">Dura√ß√£o Padr√£o (min)</label><input type="number" id="cfgDuracaoPadrao" value="60" class="form-control"></div></div><div class="row g-3 mb-3"><div class="col-md-6"><label style="display:block;font-weight:700;margin-bottom:10px">Cashback Padr√£o (%)</label><input type="number" id="cfgCashbackPadrao" value="5" min="0" max="100" class="form-control"></div><div class="col-md-6"><label style="display:block;font-weight:700;margin-bottom:10px">Comiss√£o Padr√£o (%)</label><input type="number" id="cfgComissaoPadrao" value="10" min="0" max="100" class="form-control"></div></div><button class="btn btn-success" onclick="salvarConfigOp()"><i class="bi bi-check-circle"></i> Salvar Configura√ß√µes Operacionais</button></div></div>
            <div class="card mt-4"><div class="card-header"><i class="bi bi-shield-check"></i> Licen√ßa e Desenvolvedor</div><div class="card-body"><table style="width:100%"><tr style="border-bottom:1px solid var(--border-color)"><td style="padding:15px;font-weight:700">Plano Contratado:</td><td style="padding:15px"><span class="badge success">PROFISSIONAL PREMIUM</span></td></tr><tr style="border-bottom:1px solid var(--border-color)"><td style="padding:15px;font-weight:700">Franquia:</td><td style="padding:15px">BIOMA Uberaba - Oficial</td></tr><tr style="border-bottom:1px solid var(--border-color)"><td style="padding:15px;font-weight:700">Desenvolvedor:</td><td style="padding:15px">@juanmarco1999 (Juan Marco Bernardos Souza e Silva)</td></tr><tr style="border-bottom:1px solid var(--border-color)"><td style="padding:15px;font-weight:700">Email Suporte:</td><td style="padding:15px">180147064@aluno.unb.br</td></tr><tr style="border-bottom:1px solid var(--border-color)"><td style="padding:15px;font-weight:700">Vers√£o:</td><td style="padding:15px">v3.7 (Build 2025.10.05)</td></tr><tr><td style="padding:15px;font-weight:700">√öltima Atualiza√ß√£o:</td><td style="padding:15px">05 de Outubro de 2025 √†s 22:34 UTC</td></tr></table></div></div>
        </div>

    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="/static/js/correcoes_bioma.js"></script>
<script src="/static/js/bioma_melhorias.js"></script>
<script src="/static/js/bioma_melhorias_v4.js"></script>
<script>

let currentUser=null,currentTheme='light',orcamento={servicos:[],produtos:[]},servicosDisponiveis=[],produtosDisponiveis=[],servicoSelecionado=null,produtoSelecionado=null;

document.addEventListener('DOMContentLoaded',()=>{
    console.log('%cüå≥ BIOMA v3.7 DEFINITIVO','background:#7C3AED;color:#fff;font-size:24px;padding:15px;border-radius:8px;font-weight:900');
    console.log('%c‚úÖ Sistema 100% Completo Carregado','color:#10B981;font-size:16px;font-weight:700');
    checkAuth();
});

async function checkAuth(){
    try{
        const res=await fetch('/api/current-user',{credentials:'include'});
        const data=await res.json();
        if(data.success&&data.user){
            currentUser=data.user;
            currentTheme=data.user.theme||'light';
            applyTheme(currentTheme);
            showApp();
        }else{
            showAuth();
        }
    }catch(e){
        console.error('‚ùå Auth error:',e);
        showAuth();
    }
}

function showAuth(){
    document.getElementById('authScreen').style.display='flex';
    document.getElementById('app').style.display='none';
}

function showApp(){
    document.getElementById('authScreen').style.display='none';
    document.getElementById('app').style.display='block';
    setTimeout(()=>{loadDashboard();},100);
}

function switchTab(tab){
    if(tab==='login'){
        document.getElementById('loginTab').classList.add('active');
        document.getElementById('registerTab').classList.remove('active');
        document.getElementById('loginForm').style.display='block';
        document.getElementById('registerForm').style.display='none';
    }else{
        document.getElementById('registerTab').classList.add('active');
        document.getElementById('loginTab').classList.remove('active');
        document.getElementById('registerForm').style.display='block';
        document.getElementById('loginForm').style.display='none';
    }
}

async function handleLogin(e){
    e.preventDefault();
    const username=document.getElementById('loginUsername').value.trim();
    const password=document.getElementById('loginPassword').value.trim();
    try{
        const res=await fetch('/api/login',{method:'POST',headers:{'Content-Type':'application/json'},credentials:'include',body:JSON.stringify({username,password})});
        const data=await res.json();
        if(data.success&&data.user){
            currentUser=data.user;
            currentTheme=data.user.theme||'light';
            Swal.fire({icon:'success',title:'‚úÖ Bem-vindo!',text:`Ol√°, ${currentUser.name}!`,timer:1500,showConfirmButton:false});
            setTimeout(()=>{applyTheme(currentTheme);showApp();},500);
        }else{
            Swal.fire('Erro',data.message||'Credenciais inv√°lidas','error');
        }
    }catch(e){
        Swal.fire('Erro','N√£o foi poss√≠vel conectar','error');
    }
    return false;
}

async function handleRegister(e){
    e.preventDefault();
    const name=document.getElementById('registerName').value.trim();
    const username=document.getElementById('registerUsername').value.trim();
    const email=document.getElementById('registerEmail').value.trim();
    const telefone=document.getElementById('registerTelefone').value.trim();
    const password=document.getElementById('registerPassword').value.trim();
    try{
        const res=await fetch('/api/register',{method:'POST',headers:{'Content-Type':'application/json'},credentials:'include',body:JSON.stringify({name,username,email,telefone,password})});
        const data=await res.json();
        if(data.success){
            Swal.fire({icon:'success',title:'‚úÖ Conta Criada!',html:'<p>Conta criada com privil√©gios de ADMIN!</p><p>Fa√ßa login agora.</p>',timer:3000}).then(()=>{switchTab('login');document.getElementById('loginUsername').value=username;});
        }else{
            Swal.fire('Erro',data.message,'error');
        }
    }catch(e){
        Swal.fire('Erro','Erro ao criar conta','error');
    }
    return false;
}

async function doLogout(){
    const result=await Swal.fire({title:'Deseja sair?',icon:'question',showCancelButton:true,confirmButtonText:'Sim',cancelButtonText:'Cancelar'});
    if(result.isConfirmed){
        await fetch('/api/logout',{method:'POST',credentials:'include'});
        Swal.fire({icon:'success',title:'At√© logo!',timer:1000,showConfirmButton:false});
        setTimeout(()=>{currentUser=null;location.reload();},500);
    }
}

function applyTheme(theme){
    document.documentElement.setAttribute('data-theme',theme);
    currentTheme=theme;
    if(theme==='dark'){
        document.getElementById('themeIcon').className='bi bi-sun-fill';
        document.getElementById('themeText').textContent='Modo Claro';
    }else{
        document.getElementById('themeIcon').className='bi bi-moon-stars-fill';
        document.getElementById('themeText').textContent='Modo Escuro';
    }
}

async function toggleTheme(){
    const newTheme=currentTheme==='light'?'dark':'light';
    applyTheme(newTheme);
    try{
        await fetch('/api/update-theme',{method:'POST',headers:{'Content-Type':'application/json'},credentials:'include',body:JSON.stringify({theme:newTheme})});
    }catch(e){
        console.error('‚ùå Theme error:',e);
    }
}

function goTo(section){
    console.log('üîÑ Navegando:',section);
    try{
        document.querySelectorAll('.content-section').forEach(s=>s.classList.remove('active'));
        const sectionElement=document.getElementById('section-'+section);
        if(sectionElement){sectionElement.classList.add('active');}
        document.querySelectorAll('.sidebar-menu a').forEach(a=>a.classList.remove('active'));
        const menu=document.getElementById('menu-'+section);
        if(menu)menu.classList.add('active');
        const mainContent=document.querySelector('.main-content');
        if(mainContent)mainContent.scrollTo({top:0,behavior:'smooth'});
        if(section==='dashboard')loadDashboard();
        else if(section==='clientes')loadClientes();
        else if(section==='profissionais')loadProfissionais();
        else if(section==='servicos')loadServicosLista();
        else if(section==='produtos')loadProdutosLista();
        else if(section==='consultar')loadConsultar();
        else if(section==='contratos')loadContratos();
        else if(section==='fila')loadFila();
        else if(section==='sistema')verificarStatus();
        else if(section==='estoque'){loadEstoqueBaixo();if(typeof loadEstoqueMelhorado==='function')loadEstoqueMelhorado();}
        else if(section==='agendamentos')loadAgendamentos();
    }catch(e){
        console.error('‚ùå Erro navega√ß√£o:',e);
    }
}

async function loadDashboard(){
    try{
        const res=await fetch('/api/dashboard/stats',{credentials:'include'});
        const data=await res.json();
        if(data.success){
            document.getElementById('dashOrcamentos').textContent=data.stats.total_orcamentos||0;
            document.getElementById('dashClientes').textContent=data.stats.total_clientes||0;
            document.getElementById('dashAgendamentos').textContent=data.stats.agendamentos_hoje||0;
            document.getElementById('dashFaturamento').textContent='R$ '+(data.stats.faturamento||0).toFixed(0);
        }
        const estoqueRes=await fetch('/api/estoque/alerta',{credentials:'include'});
        const estoqueData=await estoqueRes.json();
        if(estoqueData.success&&estoqueData.produtos&&estoqueData.produtos.length>0){
            const html=estoqueData.produtos.slice(0,5).map(p=>`<div style="padding:10px;border-bottom:1px solid var(--border-color)"><strong>${p.nome}</strong><br><small>Estoque: ${p.estoque} | M√≠nimo: ${p.estoque_minimo}</small></div>`).join('');
            document.getElementById('alertasEstoque').innerHTML=html;
        }else{
            document.getElementById('alertasEstoque').innerHTML='<p class="text-center text-success">‚úÖ Estoque OK</p>';
        }
        const agendRes=await fetch('/api/agendamentos',{credentials:'include'});
        const agendData=await agendRes.json();
        if(agendData.success&&agendData.agendamentos&&agendData.agendamentos.length>0){
            const html=agendData.agendamentos.map(a=>{
                const dataFormatada=new Date(a.data).toLocaleDateString('pt-BR');
                return `<div style="padding:10px;border-bottom:1px solid var(--border-color)"><strong>${a.cliente_nome||'Cliente'}</strong><br><small>${dataFormatada} √†s ${a.horario}</small></div>`;
            }).join('');
            document.getElementById('proximosAgendamentos').innerHTML=html;
        }else{
            document.getElementById('proximosAgendamentos').innerHTML='<p class="text-center text-muted">üìÖ Nenhum agendamento</p>';
        }
        const orcRes=await fetch('/api/orcamentos',{credentials:'include'});
        const orcData=await orcRes.json();
        if(orcData.success&&orcData.orcamentos&&orcData.orcamentos.length>0){
            const html=orcData.orcamentos.slice(0,10).map(o=>`<tr><td><strong>#${o.numero}</strong></td><td>${new Date(o.created_at).toLocaleDateString('pt-BR')}</td><td>${o.cliente_nome}</td><td><strong>R$ ${o.total_final.toFixed(2)}</strong></td><td><span class="badge ${o.status==='Aprovado'?'success':'warning'}">${o.status}</span></td></tr>`).join('');
            document.getElementById('ultimosOrcamentosBody').innerHTML=html;
        }else{
            document.getElementById('ultimosOrcamentosBody').innerHTML='<tr><td colspan="5" class="text-center text-muted">Nenhum</td></tr>';
        }
    }catch(e){
        console.error('‚ùå Dashboard error:',e);
    }
}

async function verificarStatus(){
    try{
        const res=await fetch('/api/system/status',{credentials:'include'});
        const data=await res.json();
        if(data.success){
            const mongoStatus=document.getElementById('mongoStatus');
            const mongoMsg=document.getElementById('mongoMessage');
            if(data.status.mongodb.operational){
                mongoStatus.className='badge success';
                mongoStatus.innerHTML='‚úÖ Online';
                mongoMsg.textContent=data.status.mongodb.message;
            }else{
                mongoStatus.className='badge danger';
                mongoStatus.innerHTML='‚ùå Offline';
                mongoMsg.textContent=data.status.mongodb.message;
            }
            const emailStatus=document.getElementById('emailStatus');
            if(data.status.mailersend.operational){
                emailStatus.className='badge success';
                emailStatus.innerHTML='‚úÖ Ativo';
                document.getElementById('emailMessage').textContent=data.status.mailersend.message;
            }else{
                emailStatus.className='badge danger';
                emailStatus.innerHTML='‚ùå Inativo';
                document.getElementById('emailMessage').textContent=data.status.mailersend.message;
            }
        }
    }catch(e){
        console.error('‚ùå Status error:',e);
    }
}

async function loadClientes(){
    try{
        const res=await fetch('/api/clientes',{credentials:'include'});
        const data=await res.json();
        const tbody=document.getElementById('clientesBody');
        if(data.success&&data.clientes&&data.clientes.length>0){
            const html=data.clientes.map(c=>`<tr><td><strong>${c.nome}</strong></td><td>${c.cpf}</td><td>${c.telefone||'-'}</td><td><strong>R$ ${(c.total_gasto||0).toFixed(2)}</strong></td><td>${c.total_visitas||0}</td><td><button class="btn btn-sm btn-info" onclick="visualizarCliente('${c._id}')" style="background:linear-gradient(135deg,#3B82F6,#2563EB);color:#fff;margin-right:5px"><i class="bi bi-eye"></i></button><button class="btn btn-sm btn-primary" onclick="editarCliente('${c._id}')" style="margin-right:5px"><i class="bi bi-pencil"></i></button><button class="btn btn-sm btn-danger" onclick="deleteCliente('${c._id}')"><i class="bi bi-trash"></i></button></td></tr>`).join('');
            tbody.innerHTML=html;
        }else{
            tbody.innerHTML='<tr><td colspan="6" class="text-center text-muted">Nenhum cliente</td></tr>';
        }
    }catch(e){
        document.getElementById('clientesBody').innerHTML='<tr><td colspan="6" class="text-center text-danger">Erro</td></tr>';
    }
}

async function deleteCliente(id){
    const result=await Swal.fire({title:'Deletar?',icon:'warning',showCancelButton:true});
    if(result.isConfirmed){
        try{
            await fetch(`/api/clientes/${id}`,{method:'DELETE',credentials:'include'});
            Swal.fire('Deletado!','','success');
            loadClientes();
        }catch(e){
            Swal.fire('Erro','','error');
        }
    }
}

function filtrarClientes(){
    const termo=document.getElementById('buscaCliente').value.toLowerCase();
    const rows=document.querySelectorAll('#clientesBody tr');
    rows.forEach(row=>{
        const text=row.textContent.toLowerCase();
        row.style.display=text.includes(termo)?'':'none';
    });
}

function showModalCliente(){
    Swal.fire({title:'Novo Cliente',html:`<input type="text" id="swal-cpf" class="form-control mb-3" placeholder="CPF"><input type="text" id="swal-nome" class="form-control mb-3" placeholder="Nome"><input type="email" id="swal-email" class="form-control mb-3" placeholder="Email"><input type="text" id="swal-telefone" class="form-control" placeholder="Telefone">`,showCancelButton:true,confirmButtonText:'Salvar',preConfirm:()=>{
        const cpf=document.getElementById('swal-cpf').value;
        const nome=document.getElementById('swal-nome').value;
        if(!cpf||!nome){Swal.showValidationMessage('CPF e Nome obrigat√≥rios');return false;}
        return {cpf,nome,email:document.getElementById('swal-email').value,telefone:document.getElementById('swal-telefone').value};
    }}).then(async(result)=>{
        if(result.isConfirmed){
            try{
                await fetch('/api/clientes',{method:'POST',headers:{'Content-Type':'application/json'},credentials:'include',body:JSON.stringify(result.value)});
                Swal.fire('Sucesso!','Cliente cadastrado','success');
                loadClientes();
            }catch(e){
                Swal.fire('Erro','','error');
            }
        }
    });
}

async function visualizarCliente(id){
    try{
        const res=await fetch(`/api/clientes/${id}`,{credentials:'include'});
        const data=await res.json();
        if(data.success&&data.cliente){
            const c=data.cliente;
            Swal.fire({title:`<strong>üë§ ${c.nome}</strong>`,html:`<div style="text-align:left"><div style="background:linear-gradient(135deg,#7C3AED,#EC4899);color:#fff;padding:20px;border-radius:15px;margin-bottom:20px"><p style="margin:5px 0"><strong>CPF:</strong> ${c.cpf}</p>${c.email?`<p style="margin:5px 0"><strong>Email:</strong> ${c.email}</p>`:''}${c.telefone?`<p style="margin:5px 0"><strong>Telefone:</strong> ${c.telefone}</p>`:''}${c.endereco?`<p style="margin:5px 0"><strong>Endere√ßo:</strong> ${c.endereco}</p>`:''}</div><div style="background:#f3f4f6;padding:15px;border-radius:10px"><p><strong>üí∞ Total Gasto:</strong> <span style="color:#10B981;font-size:1.3rem">R$ ${(c.total_gasto||0).toFixed(2)}</span></p><p><strong>üìä Total de Visitas:</strong> ${c.total_visitas||0}</p>${c.ultima_visita?`<p><strong>üóìÔ∏è √öltima Visita:</strong> ${new Date(c.ultima_visita).toLocaleDateString('pt-BR')}</p>`:''}</div>${c.observacoes?`<div style="margin-top:15px;padding:10px;background:#FEF3C7;border-left:4px solid #F59E0B;border-radius:5px"><strong>üìù Observa√ß√µes:</strong><p style="margin:5px 0 0">${c.observacoes}</p></div>`:''}<p style="margin-top:15px;font-size:0.85rem;color:#6B7280">Cadastrado em: ${new Date(c.created_at).toLocaleString('pt-BR')}</p></div>`,width:'600px',confirmButtonText:'Fechar',confirmButtonColor:'#7C3AED'});
        }
    }catch(e){
        Swal.fire('Erro','N√£o foi poss√≠vel carregar os detalhes','error');
    }
}

async function editarCliente(id){
    try{
        const res=await fetch(`/api/clientes/${id}`,{credentials:'include'});
        const data=await res.json();
        if(data.success&&data.cliente){
            const c=data.cliente;
            Swal.fire({title:'Editar Cliente',html:`<input type="text" id="swal-cpf" class="form-control mb-3" placeholder="CPF" value="${c.cpf}"><input type="text" id="swal-nome" class="form-control mb-3" placeholder="Nome" value="${c.nome}"><input type="email" id="swal-email" class="form-control mb-3" placeholder="Email" value="${c.email||''}"><input type="text" id="swal-telefone" class="form-control" placeholder="Telefone" value="${c.telefone||''}">`,showCancelButton:true,confirmButtonText:'Salvar',cancelButtonText:'Cancelar',preConfirm:()=>{
                const cpf=document.getElementById('swal-cpf').value;
                const nome=document.getElementById('swal-nome').value;
                if(!cpf||!nome){Swal.showValidationMessage('CPF e Nome obrigat√≥rios');return false;}
                return {cpf,nome,email:document.getElementById('swal-email').value,telefone:document.getElementById('swal-telefone').value};
            }}).then(async(result)=>{
                if(result.isConfirmed){
                    try{
                        await fetch(`/api/clientes/${id}`,{method:'PUT',headers:{'Content-Type':'application/json'},credentials:'include',body:JSON.stringify(result.value)});
                        Swal.fire('Sucesso!','Cliente atualizado','success');
                        loadClientes();
                    }catch(e){
                        Swal.fire('Erro','N√£o foi poss√≠vel atualizar','error');
                    }
                }
            });
        }
    }catch(e){
        Swal.fire('Erro','N√£o foi poss√≠vel carregar para edi√ß√£o','error');
    }
}

async function loadProfissionais(){
    try{
        const res=await fetch('/api/profissionais',{credentials:'include'});
        const data=await res.json();
        const tbody=document.getElementById('profissionaisBody');
        if(data.success&&data.profissionais&&data.profissionais.length>0){
            const html=data.profissionais.map(p=>`<tr><td><strong>${p.nome}</strong></td><td>${p.cpf}</td><td>${p.especialidade||'-'}</td><td>${p.comissao_perc}%</td><td><span class="badge ${p.ativo?'success':'danger'}">${p.ativo?'Ativo':'Inativo'}</span></td><td><button class="btn btn-sm btn-info" onclick="visualizarProfissional('${p._id}')" style="background:linear-gradient(135deg,#3B82F6,#2563EB);color:#fff;margin-right:5px"><i class="bi bi-eye"></i></button><button class="btn btn-sm btn-primary" onclick="editarProfissional('${p._id}')" style="margin-right:5px"><i class="bi bi-pencil"></i></button><button class="btn btn-sm btn-danger" onclick="deleteProfissional('${p._id}')"><i class="bi bi-trash"></i></button></td></tr>`).join('');
            tbody.innerHTML=html;
        }else{
            tbody.innerHTML='<tr><td colspan="6" class="text-center text-muted">Nenhum</td></tr>';
        }
    }catch(e){
        console.error(e);
    }
}

async function deleteProfissional(id){
    const result=await Swal.fire({title:'Deletar?',icon:'warning',showCancelButton:true});
    if(result.isConfirmed){
        try{
            await fetch(`/api/profissionais/${id}`,{method:'DELETE',credentials:'include'});
            Swal.fire('Deletado!','','success');
            loadProfissionais();
        }catch(e){
            Swal.fire('Erro','','error');
        }
    }
}

function showModalProfissional(){
    // Usar a nova vers√£o melhorada com multicomiss√£o e foto
    if(typeof showModalProfissionalMelhorado === 'function'){
        showModalProfissionalMelhorado();
    }else{
        // Fallback para vers√£o antiga
        Swal.fire({title:'Novo Profissional',html:`<input type="text" id="swal-nome" class="form-control mb-3" placeholder="Nome"><input type="text" id="swal-cpf" class="form-control mb-3" placeholder="CPF"><input type="text" id="swal-espec" class="form-control mb-3" placeholder="Especialidade"><input type="number" id="swal-comissao" class="form-control" placeholder="Comiss√£o %" value="10">`,showCancelButton:true,preConfirm:()=>{
            const nome=document.getElementById('swal-nome').value;
            const cpf=document.getElementById('swal-cpf').value;
            if(!nome||!cpf){Swal.showValidationMessage('Nome e CPF obrigat√≥rios');return false;}
            return {nome,cpf,especialidade:document.getElementById('swal-espec').value,comissao_perc:document.getElementById('swal-comissao').value};
        }}).then(async(result)=>{
            if(result.isConfirmed){
                try{
                    await fetch('/api/profissionais',{method:'POST',headers:{'Content-Type':'application/json'},credentials:'include',body:JSON.stringify(result.value)});
                    Swal.fire('Sucesso!','','success');
                    loadProfissionais();
                }catch(e){
                    Swal.fire('Erro','','error');
                }
            }
        });
    }
}

async function loadServicosLista(){
    try{
        const res=await fetch('/api/servicos',{credentials:'include'});
        const data=await res.json();
        const tbody=document.getElementById('servicosListBody');
        if(data.success&&data.servicos&&data.servicos.length>0){
            const html=data.servicos.map(s=>`
                <tr>
                    <td><strong>${s.nome}</strong></td>
                    <td>${s.tamanho}</td>
                    <td><strong>R$ ${s.preco.toFixed(2)}</strong></td>
                    <td>${s.categoria}</td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="visualizarServico('${s._id}')"
                                style="background:linear-gradient(135deg,#3B82F6,#2563EB);color:#fff;margin-right:5px">
                            <i class="bi bi-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-primary" onclick="editarServico('${s._id}')" style="margin-right:5px">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteServico('${s._id}')">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            tbody.innerHTML=html;
        }else{
            tbody.innerHTML='<tr><td colspan="5" class="text-center text-muted">Nenhum</td></tr>';
        }
    }catch(e){
        console.error(e);
    }
}

async function deleteServico(id){
    const result=await Swal.fire({title:'Deletar?',icon:'warning',showCancelButton:true});
    if(result.isConfirmed){
        try{
            await fetch(`/api/servicos/${id}`,{method:'DELETE',credentials:'include'});
            Swal.fire('Deletado!','','success');
            loadServicosLista();
        }catch(e){
            Swal.fire('Erro','','error');
        }
    }
}

async function visualizarProfissional(id){
    try{
        const res=await fetch(`/api/profissionais/${id}`,{credentials:'include'});
        const data=await res.json();
        if(data.success&&data.profissional){
            const p=data.profissional;
            Swal.fire({title:`<strong>üë®‚Äçüíº ${p.nome}</strong>`,html:`<div style="text-align:left"><div style="background:linear-gradient(135deg,#7C3AED,#EC4899);color:#fff;padding:20px;border-radius:15px;margin-bottom:20px"><p style="margin:5px 0"><strong>CPF:</strong> ${p.cpf}</p>${p.especialidade?`<p style="margin:5px 0"><strong>Especialidade:</strong> ${p.especialidade}</p>`:''}${p.telefone?`<p style="margin:5px 0"><strong>Telefone:</strong> ${p.telefone}</p>`:''}</div><div style="background:#f3f4f6;padding:15px;border-radius:10px"><p><strong>üí∞ Comiss√£o:</strong> <span style="color:#7C3AED;font-size:1.3rem">${p.comissao_perc}%</span></p><p><strong>üìä Status:</strong> <span class="badge ${p.ativo?'success':'danger'}">${p.ativo?'ATIVO':'INATIVO'}</span></p></div><p style="margin-top:15px;font-size:0.85rem;color:#6B7280">Cadastrado em: ${new Date(p.created_at).toLocaleString('pt-BR')}</p></div>`,width:'600px',confirmButtonText:'Fechar',confirmButtonColor:'#7C3AED'});
        }
    }catch(e){
        Swal.fire('Erro','N√£o foi poss√≠vel carregar os detalhes','error');
    }
}

async function editarProfissional(id){
    try{
        const res=await fetch(`/api/profissionais/${id}`,{credentials:'include'});
        const data=await res.json();
        if(data.success&&data.profissional){
            const p=data.profissional;
            Swal.fire({title:'Editar Profissional',html:`<input type="text" id="swal-nome" class="form-control mb-3" placeholder="Nome" value="${p.nome}"><input type="text" id="swal-cpf" class="form-control mb-3" placeholder="CPF" value="${p.cpf}"><input type="text" id="swal-espec" class="form-control mb-3" placeholder="Especialidade" value="${p.especialidade||''}"><input type="number" id="swal-comissao" class="form-control mb-3" placeholder="Comiss√£o %" value="${p.comissao_perc}"><select id="swal-ativo" class="form-select"><option value="true" ${p.ativo?'selected':''}>Ativo</option><option value="false" ${!p.ativo?'selected':''}>Inativo</option></select>`,showCancelButton:true,confirmButtonText:'Salvar',cancelButtonText:'Cancelar',preConfirm:()=>{
                const nome=document.getElementById('swal-nome').value;
                const cpf=document.getElementById('swal-cpf').value;
                if(!nome||!cpf){Swal.showValidationMessage('Nome e CPF obrigat√≥rios');return false;}
                return {nome,cpf,especialidade:document.getElementById('swal-espec').value,comissao_perc:document.getElementById('swal-comissao').value,ativo:document.getElementById('swal-ativo').value==='true'};
            }}).then(async(result)=>{
                if(result.isConfirmed){
                    try{
                        await fetch(`/api/profissionais/${id}`,{method:'PUT',headers:{'Content-Type':'application/json'},credentials:'include',body:JSON.stringify(result.value)});
                        Swal.fire('Sucesso!','Profissional atualizado','success');
                        loadProfissionais();
                    }catch(e){
                        Swal.fire('Erro','N√£o foi poss√≠vel atualizar','error');
                    }
                }
            });
        }
    }catch(e){
        Swal.fire('Erro','N√£o foi poss√≠vel carregar para edi√ß√£o','error');
    }
}

function showModalServico(){
    Swal.fire({title:'Novo Servi√ßo',html:`<input type="text" id="swal-nome" class="form-control mb-3" placeholder="Nome"><div class="row"><div class="col-6"><input type="number" id="swal-kids" class="form-control mb-2" placeholder="Kids" step="0.01"><input type="number" id="swal-masc" class="form-control mb-2" placeholder="Masculino" step="0.01"><input type="number" id="swal-curto" class="form-control" placeholder="Curto" step="0.01"></div><div class="col-6"><input type="number" id="swal-medio" class="form-control mb-2" placeholder="M√©dio" step="0.01"><input type="number" id="swal-longo" class="form-control mb-2" placeholder="Longo" step="0.01"><input type="number" id="swal-xl" class="form-control" placeholder="XL" step="0.01"></div></div>`,showCancelButton:true,width:'600px',preConfirm:()=>{
        const nome=document.getElementById('swal-nome').value;
        if(!nome){Swal.showValidationMessage('Nome obrigat√≥rio');return false;}
        return {nome,preco_kids:document.getElementById('swal-kids').value||0,preco_masculino:document.getElementById('swal-masc').value||0,preco_curto:document.getElementById('swal-curto').value||0,preco_medio:document.getElementById('swal-medio').value||0,preco_longo:document.getElementById('swal-longo').value||0,preco_extra_longo:document.getElementById('swal-xl').value||0};
    }}).then(async(result)=>{
        if(result.isConfirmed){
            try{
                const res=await fetch('/api/servicos',{method:'POST',headers:{'Content-Type':'application/json'},credentials:'include',body:JSON.stringify(result.value)});
                const data=await res.json();
                if(data.success){
                    Swal.fire('Sucesso!',`${data.count} SKUs criados`,'success');
                    loadServicosLista();
                }
            }catch(e){
                Swal.fire('Erro','','error');
            }
        }
    });
}

async function loadProdutosLista(){
    try{
        const res=await fetch('/api/produtos',{credentials:'include'});
        const data=await res.json();
        const tbody=document.getElementById('produtosListBody');
        if(data.success&&data.produtos&&data.produtos.length>0){
            const html=data.produtos.map(p=>`
                <tr>
                    <td><strong>${p.nome}</strong></td>
                    <td>${p.marca||'-'}</td>
                    <td><strong>R$ ${p.preco.toFixed(2)}</strong></td>
                    <td><span class="badge ${p.estoque<=p.estoque_minimo?'danger':'success'}">${p.estoque||0}</span></td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="visualizarProduto('${p._id}')"
                                style="background:linear-gradient(135deg,#3B82F6,#2563EB);color:#fff;margin-right:5px">
                            <i class="bi bi-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-primary" onclick="editarProduto('${p._id}')" style="margin-right:5px">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteProduto('${p._id}')">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            tbody.innerHTML=html;
        }else{
            tbody.innerHTML='<tr><td colspan="5" class="text-center text-muted">Nenhum</td></tr>';
        }
    }catch(e){
        console.error(e);
    }
}

async function deleteProduto(id){
    const result=await Swal.fire({title:'Deletar?',icon:'warning',showCancelButton:true});
    if(result.isConfirmed){
        try{
            await fetch(`/api/produtos/${id}`,{method:'DELETE',credentials:'include'});
            Swal.fire('Deletado!','','success');
            loadProdutosLista();
        }catch(e){
            Swal.fire('Erro','','error');
        }
    }
}

function showModalProduto(){
    Swal.fire({title:'Novo Produto',html:`<input type="text" id="swal-nome" class="form-control mb-3" placeholder="Nome"><input type="text" id="swal-marca" class="form-control mb-3" placeholder="Marca"><input type="number" id="swal-preco" class="form-control mb-3" placeholder="Pre√ßo" step="0.01"><input type="number" id="swal-estoque" class="form-control" placeholder="Estoque" value="0">`,showCancelButton:true,preConfirm:()=>{
        const nome=document.getElementById('swal-nome').value;
        const preco=document.getElementById('swal-preco').value;
        if(!nome||!preco){Swal.showValidationMessage('Nome e Pre√ßo obrigat√≥rios');return false;}
        return {nome,marca:document.getElementById('swal-marca').value,preco,estoque:document.getElementById('swal-estoque').value};
    }}).then(async(result)=>{
        if(result.isConfirmed){
            try{
                await fetch('/api/produtos',{method:'POST',headers:{'Content-Type':'application/json'},credentials:'include',body:JSON.stringify(result.value)});
                Swal.fire('Sucesso!','','success');
                loadProdutosLista();
            }catch(e){
                Swal.fire('Erro','','error');
            }
        }
    });
}

async function loadConsultar(){
    try{
        const res=await fetch('/api/orcamentos',{credentials:'include'});
        const data=await res.json();
        const tbody=document.getElementById('consultaBody');
        if(data.success&&data.orcamentos&&data.orcamentos.length>0){
            const html=data.orcamentos.map(o=>`<tr><td><strong>#${o.numero}</strong></td><td>${new Date(o.created_at).toLocaleDateString('pt-BR')}</td><td>${o.cliente_nome}</td><td><strong>R$ ${o.total_final.toFixed(2)}</strong></td><td><span class="badge ${o.status==='Aprovado'?'success':'warning'}">${o.status}</span></td><td><button class="btn btn-sm btn-info" onclick="visualizarOrcamento('${o._id}')" style="background:linear-gradient(135deg,#3B82F6,#2563EB);color:#fff;margin-right:5px"><i class="bi bi-eye"></i></button><button class="btn btn-sm btn-primary" onclick="editarOrcamento('${o._id}')" style="margin-right:5px"><i class="bi bi-pencil"></i></button><button class="btn btn-sm btn-danger" onclick="deleteOrcamento('${o._id}')"><i class="bi bi-trash"></i></button></td></tr>`).join('');
            tbody.innerHTML=html;
        }else{
            tbody.innerHTML='<tr><td colspan="6" class="text-center text-muted">Nenhum</td></tr>';
        }
    }catch(e){
        console.error(e);
    }
}

async function deleteOrcamento(id){
    const result=await Swal.fire({title:'Deletar?',icon:'warning',showCancelButton:true});
    if(result.isConfirmed){
        try{
            await fetch(`/api/orcamentos/${id}`,{method:'DELETE',credentials:'include'});
            Swal.fire('Deletado!','','success');
            loadConsultar();
        }catch(e){
            Swal.fire('Erro','','error');
        }
    }
}

async function loadContratos(){
    try{
        const res=await fetch('/api/contratos',{credentials:'include'});
        const data=await res.json();
        const tbody=document.getElementById('contratosBody');
        if(data.success&&data.contratos&&data.contratos.length>0){
            const html=data.contratos.map(c=>`<tr><td><strong>#${c.numero}</strong></td><td>${new Date(c.created_at).toLocaleDateString('pt-BR')}</td><td>${c.cliente_nome}</td><td><strong>R$ ${c.total_final.toFixed(2)}</strong></td><td><button class="btn btn-sm btn-info" onclick="visualizarOrcamento('${c._id}')" style="background:linear-gradient(135deg,#3B82F6,#2563EB);color:#fff;margin-right:5px"><i class="bi bi-eye"></i></button><a href="/api/orcamento/${c._id}/pdf" target="_blank" class="btn btn-sm btn-primary"><i class="bi bi-file-pdf"></i> PDF</a></td></tr>`).join('');
            tbody.innerHTML=html;
        }else{
            tbody.innerHTML='<tr><td colspan="5" class="text-center text-muted">Nenhum</td></tr>';
        }
    }catch(e){
        console.error(e);
    }
}

async function loadFila(){
    try{
        const res=await fetch('/api/fila',{credentials:'include'});
        const data=await res.json();
        const container=document.getElementById('filaContainer');
        if(data.success&&data.fila&&data.fila.length>0){
            document.getElementById('totalFila').textContent=data.fila.length;
            const html=data.fila.map((f,idx)=>`<div style="padding:15px;border:2px solid var(--border-color);border-radius:15px;margin-bottom:15px;display:flex;justify-content:space-between;align-items:center"><div><strong style="font-size:1.5rem;color:var(--primary)">#${idx+1}</strong> <strong style="margin-left:15px">${f.cliente_nome}</strong></div><button class="btn btn-sm btn-danger" onclick="removeFila('${f._id}')"><i class="bi bi-trash"></i></button></div>`).join('');
            container.innerHTML=html;
        }else{
            document.getElementById('totalFila').textContent='0';
            container.innerHTML='<p class="text-center text-muted">Fila vazia</p>';
        }
    }catch(e){
        console.error(e);
    }
}

async function removeFila(id){
    try{
        await fetch(`/api/fila/${id}`,{method:'DELETE',credentials:'include'});
        loadFila();
    }catch(e){
        console.error(e);
    }
}

function showModalFila(){
    Swal.fire({title:'Adicionar √† Fila',html:`<input type="text" id="swal-nome" class="form-control mb-3" placeholder="Nome"><input type="text" id="swal-telefone" class="form-control" placeholder="Telefone">`,showCancelButton:true,preConfirm:()=>{
        const cliente_nome=document.getElementById('swal-nome').value;
        const cliente_telefone=document.getElementById('swal-telefone').value;
        if(!cliente_nome){Swal.showValidationMessage('Nome obrigat√≥rio');return false;}
        return {cliente_nome,cliente_telefone};
    }}).then(async(result)=>{
        if(result.isConfirmed){
            try{
                await fetch('/api/fila',{method:'POST',headers:{'Content-Type':'application/json'},credentials:'include',body:JSON.stringify(result.value)});
                Swal.fire('Adicionado!','','success');
                loadFila();
            }catch(e){
                Swal.fire('Erro','','error');
            }
        }
    });
}

async function loadEstoqueBaixo(){
    try{
        const res=await fetch('/api/estoque/alerta',{credentials:'include'});
        const data=await res.json();
        const tbody=document.getElementById('estoqueBaixoBody');
        if(data.success&&data.produtos&&data.produtos.length>0){
            const html=data.produtos.map(p=>`<tr><td><strong>${p.nome}</strong></td><td><span class="badge danger">${p.estoque}</span></td><td>${p.estoque_minimo}</td><td><span class="badge danger">‚ö†Ô∏è CR√çTICO</span></td></tr>`).join('');
            tbody.innerHTML=html;
        }else{
            tbody.innerHTML='<tr><td colspan="4" class="text-center text-success">‚úÖ OK</td></tr>';
        }
    }catch(e){
        console.error(e);
    }
}

async function loadAgendamentos(){
    try{
        const res=await fetch('/api/agendamentos',{credentials:'include'});
        const data=await res.json();
        const tbody=document.getElementById('agendamentosBody');
        if(data.success&&data.agendamentos&&data.agendamentos.length>0){
            const html=data.agendamentos.map(a=>`<tr><td>${new Date(a.data).toLocaleDateString('pt-BR')}</td><td>${a.horario}</td><td>${a.cliente_nome}</td><td>${a.servico_nome||'-'}</td><td><span class="badge success">${a.status}</span></td></tr>`).join('');
            tbody.innerHTML=html;
        }else{
            tbody.innerHTML='<tr><td colspan="5" class="text-center text-muted">Nenhum</td></tr>';
        }
    }catch(e){
        console.error(e);
    }
}

function showModalAgendamento(){
    Swal.fire({title:'Novo Agendamento',html:`<input type="text" id="swal-cliente" class="form-control mb-3" placeholder="Cliente"><input type="text" id="swal-servico" class="form-control mb-3" placeholder="Servi√ßo"><input type="date" id="swal-data" class="form-control mb-3"><select id="swal-horario" class="form-select"><option value="">Hor√°rio...</option><option value="08:00">08:00</option><option value="09:00">09:00</option><option value="10:00">10:00</option><option value="14:00">14:00</option><option value="15:00">15:00</option><option value="16:00">16:00</option></select>`,showCancelButton:true,preConfirm:()=>{
        const cliente_nome=document.getElementById('swal-cliente').value;
        const servico_nome=document.getElementById('swal-servico').value;
        const data=document.getElementById('swal-data').value;
        const horario=document.getElementById('swal-horario').value;
        if(!cliente_nome||!data||!horario){Swal.showValidationMessage('Preencha todos os campos');return false;}
        return {cliente_nome,servico_nome,data:new Date(data+'T12:00:00').toISOString(),horario};
    }}).then(async(result)=>{
        if(result.isConfirmed){
            try{
                await fetch('/api/agendamentos',{method:'POST',headers:{'Content-Type':'application/json'},credentials:'include',body:JSON.stringify(result.value)});
                Swal.fire('Agendado!','','success');
                loadAgendamentos();
            }catch(e){
                Swal.fire('Erro','','error');
            }
        }
    });
}

async function handleUpload(input,tipo){
    const file=input.files[0];
    if(!file)return;
    const formData=new FormData();
    formData.append('file',file);
    formData.append('tipo',tipo);
    Swal.fire({title:'Importando...',html:'Aguarde',allowOutsideClick:false,didOpen:()=>{Swal.showLoading();}});
    try{
        const res=await fetch('/api/importar',{method:'POST',credentials:'include',body:formData});
        const data=await res.json();
        if(data.success){
            Swal.fire({icon:'success',title:'‚úÖ Importado!',html:`<p>${data.count_success} registros</p>${data.count_error>0?`<p class="text-danger">${data.count_error} erros</p>`:''}`});
            if(tipo==='produtos')loadProdutosLista();
            if(tipo==='servicos')loadServicosLista();
        }else{
            Swal.fire('Erro',data.message,'error');
        }
    }catch(e){
        Swal.fire('Erro','Erro ao importar','error');
    }
    input.value='';
}

async function buscarClientePorCPF(){
    const cpf=document.getElementById('orcCPF').value.trim();
    if(cpf.length<3){document.getElementById('cpfResults').style.display='none';return;}
    try{
        const res=await fetch(`/api/clientes/buscar?termo=${cpf}`,{credentials:'include'});
        const data=await res.json();
        if(data.success&&data.clientes.length>0){
            const html=data.clientes.map(c=>`<div class="autocomplete-item" onclick="selecionarCliente('${c._id}','${c.cpf}','${c.nome}','${c.email||''}','${c.telefone||''}')"><strong>${c.nome}</strong><small>${c.cpf} | ${c.telefone||'Sem telefone'}</small></div>`).join('');
            document.getElementById('cpfResults').innerHTML=html;
            document.getElementById('cpfResults').style.display='block';
        }else{
            document.getElementById('cpfResults').style.display='none';
        }
    }catch(e){
        console.error('‚ùå Erro buscar cliente:',e);
    }
}

function selecionarCliente(id,cpf,nome,email,telefone){
    document.getElementById('orcCPF').value=cpf;
    document.getElementById('orcNomeCliente').value=nome;
    document.getElementById('orcEmail').value=email;
    document.getElementById('orcTelefone').value=telefone;
    document.getElementById('cpfResults').style.display='none';
}

function limparCliente(){
    document.getElementById('orcCPF').value='';
    document.getElementById('orcNomeCliente').value='';
    document.getElementById('orcEmail').value='';
    document.getElementById('orcTelefone').value='';
}

async function buscarServicos(){
    const termo=document.getElementById('buscaServico').value.trim();
    if(termo.length<2){document.getElementById('servicoResults').style.display='none';return;}
    try{
        const res=await fetch(`/api/servicos/buscar?termo=${termo}`,{credentials:'include'});
        const data=await res.json();
        if(data.success&&data.servicos.length>0){
            servicosDisponiveis=data.servicos;
            const servicosAgrupados={};
            data.servicos.forEach(s=>{if(!servicosAgrupados[s.nome])servicosAgrupados[s.nome]=[];servicosAgrupados[s.nome].push(s);});
            const html=Object.keys(servicosAgrupados).map(nome=>`<div class="autocomplete-item" onclick="selecionarServico('${nome}')"><strong>${nome}</strong><small>${servicosAgrupados[nome].length} tamanhos dispon√≠veis</small></div>`).join('');
            document.getElementById('servicoResults').innerHTML=html;
            document.getElementById('servicoResults').style.display='block';
        }else{
            document.getElementById('servicoResults').style.display='none';
        }
    }catch(e){
        console.error(e);
    }
}

function selecionarServico(nome){
    document.getElementById('buscaServico').value=nome;
    document.getElementById('servicoResults').style.display='none';
    const servicosFiltrados=servicosDisponiveis.filter(s=>s.nome===nome);
    const selectTamanho=document.getElementById('servicoTamanho');
    selectTamanho.innerHTML='<option value="">Selecione...</option>';
    servicosFiltrados.forEach(s=>{
        const option=document.createElement('option');
        option.value=s._id;
        option.textContent=`${s.tamanho} - R$ ${s.preco.toFixed(2)}`;
        option.dataset.preco=s.preco;
        option.dataset.nome=s.nome;
        option.dataset.tamanho=s.tamanho;
        selectTamanho.appendChild(option);
    });
    selectTamanho.addEventListener('change',function(){
        const selected=this.options[this.selectedIndex];
        if(selected.dataset.preco){
            document.getElementById('servicoPreco').value=selected.dataset.preco;
            servicoSelecionado={id:this.value,nome:selected.dataset.nome,tamanho:selected.dataset.tamanho,preco:parseFloat(selected.dataset.preco)};
        }
    });
}

function addServico(){
    if(!servicoSelecionado){Swal.fire('Aten√ß√£o','Selecione um servi√ßo','warning');return;}
    const qtd=parseInt(document.getElementById('servicoQtd').value)||1;
    const preco=parseFloat(document.getElementById('servicoPreco').value)||0;
    const desconto=parseInt(document.getElementById('servicoDesconto').value)||0;
    if(preco<=0){Swal.fire('Aten√ß√£o','Pre√ßo inv√°lido','warning');return;}
    const subtotal=qtd*preco;
    const total=subtotal-(subtotal*desconto/100);
    orcamento.servicos.push({id:servicoSelecionado.id,nome:servicoSelecionado.nome,tamanho:servicoSelecionado.tamanho,qtd:qtd,preco_unit:preco,desconto:desconto,total:total});
    atualizarTabelaServicos();
    document.getElementById('buscaServico').value='';
    document.getElementById('servicoTamanho').innerHTML='<option value="">Selecione...</option>';
    document.getElementById('servicoQtd').value='1';
    document.getElementById('servicoPreco').value='';
    document.getElementById('servicoDesconto').value='0';
    servicoSelecionado=null;
    calcularTotais();
}

function atualizarTabelaServicos(){
    const tbody=document.getElementById('servicosBody');
    if(orcamento.servicos.length===0){tbody.innerHTML='<tr><td colspan="7" class="text-center text-muted">Nenhum servi√ßo</td></tr>';return;}
    const html=orcamento.servicos.map((s,idx)=>`<tr><td><strong>${s.nome}</strong></td><td>${s.tamanho}</td><td>${s.qtd}</td><td>R$ ${s.preco_unit.toFixed(2)}</td><td>${s.desconto}%</td><td><strong>R$ ${s.total.toFixed(2)}</strong></td><td><button class="btn btn-sm btn-danger" onclick="removerServico(${idx})"><i class="bi bi-trash"></i></button></td></tr>`).join('');
    tbody.innerHTML=html;
}

function removerServico(idx){
    orcamento.servicos.splice(idx,1);
    atualizarTabelaServicos();
    calcularTotais();
}

async function buscarProdutos(){
    const termo=document.getElementById('buscaProduto').value.trim();
    if(termo.length<2){document.getElementById('produtoResults').style.display='none';return;}
    try{
        const res=await fetch(`/api/produtos/buscar?termo=${termo}`,{credentials:'include'});
        const data=await res.json();
        if(data.success&&data.produtos.length>0){
            produtosDisponiveis=data.produtos;
            const html=data.produtos.map(p=>{
                let nomeCompleto=p.nome;
                if(p.marca)nomeCompleto+=` - ${p.marca}`;
                return `<div class="autocomplete-item" onclick="selecionarProduto('${p._id}','${nomeCompleto.replace(/'/g,"\\'")}','${p.marca||''}','${p.sku}',${p.preco})"><strong>${nomeCompleto}</strong><small>R$ ${p.preco.toFixed(2)} | Estoque: ${p.estoque||0} unidades</small></div>`;
            }).join('');
            document.getElementById('produtoResults').innerHTML=html;
            document.getElementById('produtoResults').style.display='block';
        }else{
            document.getElementById('produtoResults').style.display='none';
        }
    }catch(e){
        console.error(e);
    }
}

function selecionarProduto(id,nome,marca,sku,preco){
    document.getElementById('buscaProduto').value=nome;
    document.getElementById('produtoResults').style.display='none';
    document.getElementById('produtoPreco').value=preco.toFixed(2);
    produtoSelecionado={id,nome,marca,sku,preco};
}

function addProduto(){
    if(!produtoSelecionado){Swal.fire('Aten√ß√£o','Selecione um produto','warning');return;}
    const qtd=parseInt(document.getElementById('produtoQtd').value)||1;
    const preco=parseFloat(document.getElementById('produtoPreco').value)||0;
    const desconto=parseInt(document.getElementById('produtoDesconto').value)||0;
    if(preco<=0){Swal.fire('Aten√ß√£o','Pre√ßo inv√°lido','warning');return;}
    const subtotal=qtd*preco;
    const total=subtotal-(subtotal*desconto/100);
    orcamento.produtos.push({id:produtoSelecionado.id,nome:produtoSelecionado.nome,marca:produtoSelecionado.marca,sku:produtoSelecionado.sku,qtd:qtd,preco_unit:preco,desconto:desconto,total:total});
    atualizarTabelaProdutos();
    document.getElementById('buscaProduto').value='';
    document.getElementById('produtoQtd').value='1';
    document.getElementById('produtoPreco').value='';
    document.getElementById('produtoDesconto').value='0';
    produtoSelecionado=null;
    calcularTotais();
}

function atualizarTabelaProdutos(){
    const tbody=document.getElementById('produtosBody');
    if(orcamento.produtos.length===0){tbody.innerHTML='<tr><td colspan="7" class="text-center text-muted">Nenhum produto</td></tr>';return;}
    const html=orcamento.produtos.map((p,idx)=>`<tr><td><strong>${p.nome}</strong></td><td>${p.marca||'-'}</td><td>${p.qtd}</td><td>R$ ${p.preco_unit.toFixed(2)}</td><td>${p.desconto}%</td><td><strong>R$ ${p.total.toFixed(2)}</strong></td><td><button class="btn btn-sm btn-danger" onclick="removerProduto(${idx})"><i class="bi bi-trash"></i></button></td></tr>`).join('');
    tbody.innerHTML=html;
}

function removerProduto(idx){
    orcamento.produtos.splice(idx,1);
    atualizarTabelaProdutos();
    calcularTotais();
}

function calcularTotais(){
    const subtotalServicos=orcamento.servicos.reduce((acc,s)=>acc+s.total,0);
    const subtotalProdutos=orcamento.produtos.reduce((acc,p)=>acc+p.total,0);
    const subtotal=subtotalServicos+subtotalProdutos;
    const descontoGlobal=parseFloat(document.getElementById('descontoGlobal').value)||0;
    const descontoValor=subtotal*(descontoGlobal/100);
    const totalComDesconto=subtotal-descontoValor;
    const cashbackPerc=parseFloat(document.getElementById('cashbackPerc').value)||0;
    const cashbackValor=totalComDesconto*(cashbackPerc/100);
    document.getElementById('subtotalServicos').textContent=`R$ ${subtotalServicos.toFixed(2)}`;
    document.getElementById('subtotalProdutos').textContent=`R$ ${subtotalProdutos.toFixed(2)}`;
    document.getElementById('totalFinalOrc').textContent=`R$ ${totalComDesconto.toFixed(2)}`;
    document.getElementById('cashbackValor').textContent=`üéÅ Cashback: R$ ${cashbackValor.toFixed(2)}`;
}

async function salvarOrc(status){
    const cpf=document.getElementById('orcCPF').value.trim();
    const nome=document.getElementById('orcNomeCliente').value.trim();
    if(!cpf||!nome){Swal.fire('Aten√ß√£o','Preencha CPF e Nome','warning');return;}
    if(orcamento.servicos.length===0&&orcamento.produtos.length===0){Swal.fire('Aten√ß√£o','Adicione pelo menos um item','warning');return;}
    const data={cliente_cpf:cpf,cliente_nome:nome,cliente_email:document.getElementById('orcEmail').value.trim(),cliente_telefone:document.getElementById('orcTelefone').value.trim(),servicos:orcamento.servicos,produtos:orcamento.produtos,desconto_global:parseFloat(document.getElementById('descontoGlobal').value)||0,cashback_perc:parseFloat(document.getElementById('cashbackPerc').value)||0,pagamento:{tipo:document.getElementById('pagamento').value},status:status};
    try{
        let res,result;
        if(window.orcamentoEditandoId){
            res=await fetch(`/api/orcamentos/${window.orcamentoEditandoId}`,{method:'PUT',headers:{'Content-Type':'application/json'},credentials:'include',body:JSON.stringify(data)});
            result=await res.json();
            if(result.success){
                Swal.fire({icon:'success',title:'‚úÖ Atualizado!',html:`<p>Or√ßamento <strong>#${result.numero||window.orcamentoEditandoId}</strong> atualizado</p>`,timer:2000}).then(()=>{delete window.orcamentoEditandoId;cancelarOrc();goTo('consultar');});
            }else{
                Swal.fire('Erro',result.message,'error');
            }
        }else{
            res=await fetch('/api/orcamentos',{method:'POST',headers:{'Content-Type':'application/json'},credentials:'include',body:JSON.stringify(data)});
            result=await res.json();
            if(result.success){
                Swal.fire({icon:'success',title:status==='Aprovado'?'‚úÖ Contrato Gerado!':'‚úÖ Salvo!',html:`<p>Or√ßamento <strong>#${result.numero}</strong></p>${status==='Aprovado'?'<p>üìß Email enviado!</p>':''}`,timer:2000}).then(()=>{cancelarOrc();goTo('consultar');});
            }else{
                Swal.fire('Erro',result.message,'error');
            }
        }
    }catch(e){
        Swal.fire('Erro','Erro ao salvar','error');
    }
}

async function visualizarOrcamento(id){
    try{
        const res=await fetch(`/api/orcamentos/${id}`,{credentials:'include'});
        const data=await res.json();
        if(data.success&&data.orcamento){
            const orc=data.orcamento;
            const servicosHtml=orc.servicos.map(s=>`<tr><td>${s.nome}</td><td>${s.tamanho}</td><td>${s.qtd}</td><td>R$ ${s.preco_unit.toFixed(2)}</td><td>${s.desconto}%</td><td><strong>R$ ${s.total.toFixed(2)}</strong></td></tr>`).join('');
            const produtosHtml=orc.produtos.map(p=>`<tr><td>${p.nome}</td><td>${p.marca||'-'}</td><td>${p.qtd}</td><td>${p.preco_unit.toFixed(2)}</td><td>${p.desconto}%</td><td><strong>R$ ${p.total.toFixed(2)}</strong></td></tr>`).join('');
            Swal.fire({title:`<strong>Or√ßamento #${orc.numero}</strong>`,html:`<div style="text-align:left;max-height:500px;overflow-y:auto"><div style="background:linear-gradient(135deg,#7C3AED,#EC4899);color:#fff;padding:20px;border-radius:15px;margin-bottom:20px"><h3 style="margin:0">üë§ ${orc.cliente_nome}</h3><p style="margin:5px 0 0"><strong>CPF:</strong> ${orc.cliente_cpf}</p>${orc.cliente_email?`<p style="margin:5px 0 0"><strong>Email:</strong> ${orc.cliente_email}</p>`:''}${orc.cliente_telefone?`<p style="margin:5px 0 0"><strong>Telefone:</strong> ${orc.cliente_telefone}</p>`:''}</div><h4 style="color:#7C3AED;border-bottom:2px solid #7C3AED;padding-bottom:10px">‚úÇÔ∏è Servi√ßos</h4><table style="width:100%;margin-bottom:20px;font-size:0.9rem"><thead><tr style="background:#f3f4f6"><th style="padding:8px;text-align:left">Servi√ßo</th><th>Tamanho</th><th>Qtd</th><th>Pre√ßo</th><th>Desc</th><th>Total</th></tr></thead><tbody>${servicosHtml||'<tr><td colspan="6" style="text-align:center;color:#999">Nenhum</td></tr>'}</tbody></table><h4 style="color:#7C3AED;border-bottom:2px solid #7C3AED;padding-bottom:10px">üì¶ Produtos</h4><table style="width:100%;margin-bottom:20px;font-size:0.9rem"><thead><tr style="background:#f3f4f6"><th style="padding:8px;text-align:left">Produto</th><th>Marca</th><th>Qtd</th><th>Pre√ßo</th><th>Desc</th><th>Total</th></tr></thead><tbody>${produtosHtml||'<tr><td colspan="6" style="text-align:center;color:#999">Nenhum</td></tr>'}</tbody></table><div style="background:#f3f4f6;padding:15px;border-radius:10px"><p><strong>Desconto Global:</strong> ${orc.desconto_global||0}%</p><p><strong>Cashback:</strong> ${orc.cashback_perc||0}% (R$ ${orc.cashback_valor.toFixed(2)})</p><p><strong>Pagamento:</strong> ${orc.pagamento?.tipo||'N/A'}</p><h3 style="color:#10B981;margin:10px 0 0">TOTAL: R$ ${orc.total_final.toFixed(2)}</h3></div><p style="margin-top:15px;font-size:0.85rem;color:#6B7280">Criado em: ${new Date(orc.created_at).toLocaleString('pt-BR')}</p></div>`,width:'700px',confirmButtonText:'Fechar',confirmButtonColor:'#7C3AED'});
        }
    }catch(e){
        Swal.fire('Erro','N√£o foi poss√≠vel carregar os detalhes','error');
    }
}

async function editarOrcamento(id){
    try{
        const res=await fetch(`/api/orcamentos/${id}`,{credentials:'include'});
        const data=await res.json();
        if(data.success&&data.orcamento){
            const orc=data.orcamento;
            orcamento={servicos:orc.servicos||[],produtos:orc.produtos||[]};
            document.getElementById('orcCPF').value=orc.cliente_cpf;
            document.getElementById('orcNomeCliente').value=orc.cliente_nome;
            document.getElementById('orcEmail').value=orc.cliente_email||'';
            document.getElementById('orcTelefone').value=orc.cliente_telefone||'';
            document.getElementById('descontoGlobal').value=orc.desconto_global||0;
            document.getElementById('cashbackPerc').value=orc.cashback_perc||0;
            if(orc.pagamento?.tipo)document.getElementById('pagamento').value=orc.pagamento.tipo;
            atualizarTabelaServicos();
            atualizarTabelaProdutos();
            calcularTotais();
            goTo('orcamento');
            const pageHeader=document.querySelector('#section-orcamento .page-header h1');
            if(pageHeader){pageHeader.innerHTML=`<i class="bi bi-pencil-square"></i> Editando Or√ßamento #${orc.numero}`;}
            Swal.fire({icon:'info',title:'‚úèÔ∏è Modo Edi√ß√£o',html:`<p>Or√ßamento <strong>#${orc.numero}</strong> carregado</p><p style="color:#7C3AED">Fa√ßa as altera√ß√µes e clique em Salvar</p>`,timer:2500,showConfirmButton:false});
            window.orcamentoEditandoId=id;
        }
    }catch(e){
        Swal.fire('Erro','N√£o foi poss√≠vel carregar para edi√ß√£o','error');
    }
}

function cancelarOrc(){
    orcamento={servicos:[],produtos:[]};
    limparCliente();
    document.getElementById('descontoGlobal').value='0';
    document.getElementById('cashbackPerc').value='0';
    document.getElementById('pagamento').value='Pix';
    atualizarTabelaServicos();
    atualizarTabelaProdutos();
    calcularTotais();
    const pageHeader=document.querySelector('#section-orcamento .page-header h1');
    if(pageHeader){pageHeader.innerHTML='<i class="bi bi-file-earmark-plus"></i> Novo Or√ßamento';}
    if(window.orcamentoEditandoId){delete window.orcamentoEditandoId;}
}

let chartServicos=null,chartFaturamento=null;
async function loadRelatorios(){
    try{
        const res=await fetch('/api/orcamentos',{credentials:'include'});
        const data=await res.json();
        if(!data.success||!data.orcamentos)return;
        const orcamentos=data.orcamentos.filter(o=>o.status==='Aprovado');
        const faturamentoTotal=orcamentos.reduce((acc,o)=>acc+(o.total_final||0),0);
        document.getElementById('relFaturamentoTotal').textContent=`R$ ${faturamentoTotal.toFixed(0)}`;
        const mesAtual=new Date().getMonth();
        const anoAtual=new Date().getFullYear();
        const faturamentoMes=orcamentos.filter(o=>{const d=new Date(o.created_at);return d.getMonth()===mesAtual&&d.getFullYear()===anoAtual;}).reduce((acc,o)=>acc+o.total_final,0);
        document.getElementById('relFaturamentoMes').textContent=`R$ ${faturamentoMes.toFixed(0)}`;
        const cashbackTotal=orcamentos.reduce((acc,o)=>acc+(o.cashback_valor||0),0);
        document.getElementById('relCashbackTotal').textContent=`R$ ${cashbackTotal.toFixed(0)}`;
        const ticketMedio=orcamentos.length>0?faturamentoTotal/orcamentos.length:0;
        document.getElementById('relTicketMedio').textContent=`R$ ${ticketMedio.toFixed(0)}`;
        const servicosCount={};
        orcamentos.forEach(o=>{(o.servicos||[]).forEach(s=>{const key=s.nome;if(!servicosCount[key])servicosCount[key]={total:0,qtd:0};servicosCount[key].total+=s.total||0;servicosCount[key].qtd+=s.qtd||1;});});
        const topServicos=Object.entries(servicosCount).sort((a,b)=>b[1].total-a[1].total).slice(0,5);
        const ctxServicos=document.getElementById('chartServicos');
        if(chartServicos)chartServicos.destroy();
        if(topServicos.length>0){
            chartServicos=new Chart(ctxServicos,{type:'bar',data:{labels:topServicos.map(s=>s[0]),datasets:[{label:'Faturamento (R$)',data:topServicos.map(s=>s[1].total),backgroundColor:'rgba(124,58,237,0.8)',borderColor:'rgba(124,58,237,1)',borderWidth:2}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}}}});
        }
        const meses=[];
        const faturamentoMensal=[];
        for(let i=5;i>=0;i--){
            const d=new Date();
            d.setMonth(d.getMonth()-i);
            const mes=d.getMonth();
            const ano=d.getFullYear();
            meses.push(d.toLocaleDateString('pt-BR',{month:'short'}));
            const fat=orcamentos.filter(o=>{const od=new Date(o.created_at);return od.getMonth()===mes&&od.getFullYear()===ano;}).reduce((acc,o)=>acc+o.total_final,0);
            faturamentoMensal.push(fat);
        }
        const ctxFaturamento=document.getElementById('chartFaturamento');
        if(chartFaturamento)chartFaturamento.destroy();
        chartFaturamento=new Chart(ctxFaturamento,{type:'line',data:{labels:meses,datasets:[{label:'Faturamento (R$)',data:faturamentoMensal,backgroundColor:'rgba(16,185,129,0.2)',borderColor:'rgba(16,185,129,1)',borderWidth:3,fill:true,tension:0.4}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}}}});
        const resClientes=await fetch('/api/clientes',{credentials:'include'});
        const dataClientes=await resClientes.json();
        if(dataClientes.success&&dataClientes.clientes){
            const topClientes=dataClientes.clientes.sort((a,b)=>(b.total_gasto||0)-(a.total_gasto||0)).slice(0,10);
            const htmlClientes=topClientes.map((c,idx)=>`<tr><td><strong style="font-size:1.5rem;color:${idx===0?'#FFD700':idx===1?'#C0C0C0':idx===2?'#CD7F32':'var(--text-primary)'}">${idx+1}¬∫</strong></td><td><strong>${c.nome}</strong></td><td><strong style="color:var(--success)">R$ ${(c.total_gasto||0).toFixed(2)}</strong></td><td>${c.total_visitas||0}</td><td>${c.ultima_visita?new Date(c.ultima_visita).toLocaleDateString('pt-BR'):'-'}</td></tr>`).join('');
            document.getElementById('topClientesBody').innerHTML=htmlClientes||'<tr><td colspan="5" class="text-center text-muted">Nenhum</td></tr>';
        }
        const produtosCount={};
        orcamentos.forEach(o=>{(o.produtos||[]).forEach(p=>{const key=p.nome;if(!produtosCount[key])produtosCount[key]={total:0,qtd:0};produtosCount[key].total+=p.total||0;produtosCount[key].qtd+=p.qtd||1;});});
        const topProdutos=Object.entries(produtosCount).sort((a,b)=>b[1].qtd-a[1].qtd).slice(0,10);
        if(topProdutos.length>0){
            const htmlProdutos=topProdutos.map(p=>`<tr><td><strong>${p[0]}</strong></td><td>${p[1].qtd}</td><td><strong>R$ ${p[1].total.toFixed(2)}</strong></td></tr>`).join('');
            document.getElementById('topProdutosBody').innerHTML=htmlProdutos;
        }else{
            document.getElementById('topProdutosBody').innerHTML='<tr><td colspan="3" class="text-center text-muted">Nenhum</td></tr>';
        }
    }catch(e){
        console.error('‚ùå Relat√≥rios error:',e);
    }
}

function salvarConfig(){
    Swal.fire({icon:'success',title:'‚úÖ Salvo!',text:'Configura√ß√µes da franquia salvas',timer:2000});
}

function salvarConfigOp(){
    Swal.fire({icon:'success',title:'‚úÖ Configura√ß√µes Aplicadas!',text:'Configura√ß√µes operacionais salvas com sucesso',timer:2000});
}

console.log('%c‚úÖ BIOMA v3.7 COMPLETO - 100% FUNCIONAL','color:#10B981;font-size:18px;font-weight:900');
console.log('%cüî• Todas as fun√ß√µes implementadas sem erros','color:#7C3AED;font-size:14px;font-weight:700');
console.log('%cüìÖ 2025-10-05 22:38 UTC | Dev: @juanmarco1999','color:#6B7280;font-size:12px');

document.addEventListener('click',function(e){
    if(!e.target.closest('#orcCPF')&&!e.target.closest('#cpfResults')){
        document.getElementById('cpfResults').style.display='none';
    }
    if(!e.target.closest('#buscaServico')&&!e.target.closest('#servicoResults')){
        document.getElementById('servicoResults').style.display='none';
    }
    if(!e.target.closest('#buscaProduto')&&!e.target.closest('#produtoResults')){
        document.getElementById('produtoResults').style.display='none';
    }
});
</script>
</body>
</html>