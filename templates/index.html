<!DOCTYPE html>
<html lang="pt-BR" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="Sistema de Gestão BIOMA Uberaba v3.7 - Sistema Completo">
    <meta name="author" content="Juan Marco (@juanmarco1999)">
    <title>BIOMA Uberaba v3.7 - Sistema Profissional</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>🌳</text></svg>">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/correcoes_bioma.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
:root[data-theme="light"]{--primary:#7C3AED;--primary-dark:#6D28D9;--secondary:#EC4899;--accent:#F59E0B;--success:#10B981;--danger:#EF4444;--warning:#F59E0B;--info:#3B82F6;--bg-main:#F9FAFB;--bg-card:#FFFFFF;--bg-sidebar:#1F2937;--bg-sidebar-hover:#374151;--text-primary:#1F2937;--text-secondary:#6B7280;--text-muted:#9CA3AF;--border-color:#E5E7EB;--shadow:0 4px 20px rgba(0,0,0,0.08);--shadow-hover:0 8px 30px rgba(124,58,237,0.15);}:root[data-theme="dark"]{--primary:#8B5CF6;--primary-dark:#7C3AED;--secondary:#F472B6;--accent:#FBBF24;--success:#34D399;--danger:#F87171;--warning:#FBBF24;--info:#60A5FA;--bg-main:#0F172A;--bg-card:#1E293B;--bg-sidebar:#0F172A;--bg-sidebar-hover:#1E293B;--text-primary:#F1F5F9;--text-secondary:#CBD5E1;--text-muted:#94A3B8;--border-color:#334155;--shadow:0 4px 20px rgba(0,0,0,0.4);--shadow-hover:0 8px 30px rgba(139,92,246,0.3)}*{margin:0;padding:0;box-sizing:border-box;transition:background-color .3s ease,color .3s ease,border-color .3s ease}body{font-family:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:var(--bg-main);color:var(--text-primary);overflow-x:hidden;line-height:1.6}.auth-screen{min-height:100vh;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);padding:20px;animation:gradientAnimation 15s ease infinite;background-size:400% 400%}@keyframes gradientAnimation{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}.auth-box{background:rgba(255,255,255,0.98);backdrop-filter:blur(10px);border-radius:30px;padding:50px;max-width:500px;width:100%;box-shadow:0 30px 80px rgba(0,0,0,0.4);animation:slideUp 0.6s cubic-bezier(0.68,-0.55,0.265,1.55)}@keyframes slideUp{from{opacity:0;transform:translateY(50px) scale(0.9)}to{opacity:1;transform:translateY(0) scale(1)}}.auth-logo{text-align:center;margin-bottom:40px}.auth-logo .logo-icon{font-size:5rem;background:linear-gradient(135deg,#7C3AED,#EC4899);-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent;animation:pulse 2s ease-in-out infinite;filter:drop-shadow(0 5px 15px rgba(124,58,237,0.3))}@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}.auth-logo h2{font-weight:900;font-size:2.8rem;color:#1F2937;margin-top:20px;letter-spacing:2px}.auth-logo p{color:#6B7280;font-size:1.1rem;margin-top:10px;font-weight:500}.nav-pills .nav-link{border-radius:15px;font-weight:700;padding:12px 25px;transition:all .3s;color:#6B7280;border:none;background:transparent;cursor:pointer}.nav-pills .nav-link.active{background:linear-gradient(135deg,#7C3AED,#6D28D9);color:white;box-shadow:0 5px 20px rgba(124,58,237,0.4);transform:translateY(-2px)}.form-control,.form-select{border-radius:12px;border:2px solid #E5E7EB;padding:12px 18px;font-size:1rem;transition:all .3s;background:white;color:#1F2937}.form-control:focus,.form-select:focus{border-color:#7C3AED;box-shadow:0 0 0 5px rgba(124,58,237,0.1);outline:none;background:white}.alert{border-radius:15px;border:none;padding:15px 20px}.alert-info{background:linear-gradient(135deg,#E0E7FF,#DBEAFE);color:#1E40AF;border-left:5px solid #3B82F6}.alert-success{background:linear-gradient(135deg,#D1FAE5,#A7F3D0);color:#065F46;border-left:5px solid #10B981}.btn{border-radius:12px;padding:12px 30px;font-weight:700;border:none;cursor:pointer;transition:all .3s ease;display:inline-flex;align-items:center;gap:10px;font-size:1rem;text-transform:uppercase;letter-spacing:0.5px}.btn i{font-size:1.2rem}.btn-primary{background:linear-gradient(135deg,var(--primary),var(--primary-dark));color:#fff;box-shadow:0 5px 20px rgba(124,58,237,0.3)}.btn-primary:hover{transform:translateY(-3px);box-shadow:0 10px 30px rgba(124,58,237,0.5);color:#fff}.btn-success{background:linear-gradient(135deg,var(--success),#059669);color:#fff}.btn-success:hover{transform:translateY(-3px);color:#fff}.btn-danger{background:linear-gradient(135deg,var(--danger),#DC2626);color:#fff}.btn-outline{background:transparent;color:var(--primary);border:3px solid var(--primary)}.btn-outline:hover{background:var(--primary);color:#fff}.btn-secondary{background:#6B7280;color:#fff}.btn-sm{padding:8px 16px;font-size:0.85rem}.w-100{width:100%}.mt-3{margin-top:1rem}.mb-3{margin-bottom:1rem}#app{display:none}.sidebar{width:280px;background:var(--bg-sidebar);color:#fff;position:fixed;height:100vh;overflow-y:auto;z-index:1000;box-shadow:4px 0 25px rgba(0,0,0,0.2)}.sidebar::-webkit-scrollbar{width:8px}.sidebar::-webkit-scrollbar-track{background:rgba(255,255,255,0.05)}.sidebar::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.2);border-radius:4px}.sidebar-logo{padding:30px 20px;text-align:center;background:linear-gradient(135deg,var(--primary),var(--secondary));border-bottom:5px solid var(--accent)}.sidebar-logo h1{font-size:2.5rem;font-weight:900;letter-spacing:5px;margin:0;text-shadow:2px 2px 8px rgba(0,0,0,0.3)}.sidebar-logo p{font-size:1rem;opacity:0.95;margin:10px 0 0 0;letter-spacing:2px}.sidebar-menu{list-style:none;padding:20px 0}.sidebar-menu li a{display:flex;align-items:center;gap:12px;padding:14px 20px;color:rgba(255,255,255,0.85);text-decoration:none;transition:all .3s;border-left:5px solid transparent;font-weight:500;font-size:0.95rem}.sidebar-menu li a i{font-size:1.3rem;width:25px}.sidebar-menu li a:hover{background:var(--bg-sidebar-hover);color:#fff;border-left-color:var(--accent);padding-left:28px}.sidebar-menu li a.active{background:var(--bg-sidebar-hover);color:#fff;border-left-color:var(--primary);font-weight:700}.theme-toggle{padding:15px 20px;border-top:1px solid rgba(255,255,255,0.1)}.theme-toggle button{width:100%;padding:12px;background:rgba(255,255,255,0.1);border:2px solid rgba(255,255,255,0.2);border-radius:12px;color:#fff;font-weight:600;cursor:pointer;transition:all .3s;display:flex;align-items:center;justify-content:center;gap:10px}.main-content{margin-left:280px;padding:30px 40px;min-height:100vh;max-height:100vh;overflow-y:auto;overflow-x:hidden}.main-content::-webkit-scrollbar{width:10px}.main-content::-webkit-scrollbar-track{background:var(--bg-main)}.main-content::-webkit-scrollbar-thumb{background:var(--primary);border-radius:5px}.content-section{display:none}.content-section.active{display:block;animation:fadeIn 0.4s ease}@keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}.page-header{margin-bottom:30px;padding-bottom:20px;border-bottom:3px solid var(--border-color);display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:20px}.page-header h1{font-size:2.2rem;font-weight:900;background:linear-gradient(135deg,var(--primary),var(--secondary));-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent;margin:0;display:flex;align-items:center;gap:15px}.stat-card{background:var(--bg-card);border-radius:20px;padding:30px;box-shadow:var(--shadow);transition:all .3s;text-align:center;position:relative;overflow:hidden;border:2px solid var(--border-color)}.stat-card::before{content:'';position:absolute;top:0;left:0;width:100%;height:6px;background:linear-gradient(90deg,var(--primary),var(--secondary))}.stat-card:hover{transform:translateY(-10px);box-shadow:var(--shadow-hover);border-color:var(--primary)}.stat-card .icon{width:70px;height:70px;border-radius:18px;display:flex;align-items:center;justify-content:center;font-size:2rem;margin:0 auto 15px;background:linear-gradient(135deg,var(--primary),var(--primary-dark));color:#fff;box-shadow:0 10px 25px rgba(124,58,237,0.3)}.stat-card h3{font-size:3rem;font-weight:900;margin:15px 0 10px;background:linear-gradient(135deg,var(--primary),var(--secondary));-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent}.stat-card p{color:var(--text-secondary);font-size:1rem;font-weight:700;margin:0;text-transform:uppercase;letter-spacing:1px}.card{background:var(--bg-card);border-radius:20px;box-shadow:var(--shadow);margin-bottom:30px;overflow:visible;transition:all .3s;border:2px solid var(--border-color)}.card-header{background:linear-gradient(135deg,var(--primary),var(--primary-dark));color:#fff;padding:20px 30px;font-weight:800;font-size:1.2rem;display:flex;align-items:center;gap:12px}.card-body{padding:30px}table{width:100%;border-collapse:collapse;font-size:0.95rem}table thead th{background:linear-gradient(135deg,var(--primary),var(--primary-dark));color:#fff;padding:16px 14px;text-align:left;font-weight:800;text-transform:uppercase;letter-spacing:0.5px;font-size:0.85rem}table tbody tr{border-bottom:2px solid var(--border-color);transition:all .2s}table tbody tr:hover{background:var(--bg-main);transform:scale(1.01)}table tbody td{padding:16px 14px;vertical-align:middle;color:var(--text-primary)}.badge{padding:8px 16px;border-radius:20px;font-weight:800;font-size:0.8rem;display:inline-block;text-transform:uppercase;letter-spacing:0.5px}.badge.success{background:linear-gradient(135deg,var(--success),#059669);color:#fff}.badge.warning{background:linear-gradient(135deg,var(--warning),#F59E0B);color:#000}.badge.danger{background:linear-gradient(135deg,var(--danger),#DC2626);color:#fff}.spinner{border:4px solid var(--border-color);border-top:4px solid var(--primary);border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite;margin:20px auto}@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}.text-center{text-align:center}.text-muted{color:var(--text-secondary)}.text-success{color:var(--success)}.text-danger{color:var(--danger)}.autocomplete-results{position:absolute;top:100%;left:0;right:0;background:var(--bg-card);border:2px solid var(--primary);border-radius:14px;margin-top:5px;max-height:350px;overflow-y:auto;z-index:9999;box-shadow:0 10px 40px rgba(124,58,237,0.3);display:none}.autocomplete-results::-webkit-scrollbar{width:8px}.autocomplete-results::-webkit-scrollbar-track{background:var(--bg-main);border-radius:10px}.autocomplete-results::-webkit-scrollbar-thumb{background:var(--primary);border-radius:10px}.autocomplete-item{padding:14px 18px;border-bottom:1px solid var(--border-color);cursor:pointer;transition:all .2s ease;word-wrap:break-word;white-space:normal}.autocomplete-item:hover{background:linear-gradient(135deg,rgba(124,58,237,0.1),rgba(236,72,153,0.1));transform:translateX(5px);border-left:4px solid var(--primary)}.autocomplete-item:last-child{border-bottom:none}.autocomplete-item strong{color:var(--primary);font-size:1.05rem;display:block;margin-bottom:5px}.autocomplete-item small{color:var(--text-secondary);font-size:0.9rem;display:block}.row{display:flex;flex-wrap:wrap;margin:0 -15px}.row.g-4>*{padding:0 15px;margin-bottom:25px}[class^="col-"]{padding:0 15px}.col-12{width:100%}@media (min-width:768px){.col-md-6{width:50%}.col-md-4{width:33.333%}.col-md-3{width:25%}.col-md-2{width:16.666%}}@media (min-width:992px){.col-lg-3{width:25%}.col-lg-4{width:33.333%}.col-lg-6{width:50%}}
            .global-search-container{margin-bottom:24px;background:var(--bg-card);border-radius:18px;padding:20px;box-shadow:var(--shadow);position:relative}
        .global-search-field{display:flex;gap:12px;align-items:center}
        .global-search-field .bi-search{font-size:1.4rem;color:var(--primary)}
        .global-search-input{flex:1;border:2px solid var(--border-color);border-radius:14px;padding:12px 18px;font-size:1rem;background:var(--bg-main);color:var(--text-primary)}
        .global-search-input:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(124,58,237,0.15)}
        .global-search-results{position:absolute;top:100%;left:0;right:0;background:var(--bg-card);border-radius:16px;box-shadow:var(--shadow);margin-top:12px;max-height:320px;overflow-y:auto;display:none;z-index:50;padding:12px}
        .global-search-results.active{display:block}
        .global-search-section{margin-bottom:14px}
        .global-search-section h6{font-size:0.75rem;text-transform:uppercase;font-weight:700;color:var(--text-muted);margin:8px 0}
        .global-search-item{border-radius:12px;padding:10px 12px;cursor:pointer;transition:all .2s;display:flex;flex-direction:column;gap:4px;border:1px solid transparent}
        .global-search-item:hover{background:rgba(124,58,237,0.08);border-color:rgba(124,58,237,0.25)}
        .global-search-item strong{color:var(--text-primary);font-size:0.95rem}
        .global-search-item span{color:var(--text-secondary);font-size:0.8rem}
        .highlight-row{animation:blinkHighlight 2s ease-in-out 0s 2 alternate}
        @keyframes blinkHighlight{from{background:rgba(59,130,246,0.15)}to{background:transparent}}
        .stock-summary-card{background:var(--bg-card);border-radius:18px;padding:24px;box-shadow:var(--shadow);height:100%}
        .stock-summary-card h3{font-size:2.1rem;font-weight:800;margin:0;color:var(--primary)}
        .stock-summary-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:18px;margin-top:20px}
        .stock-summary-metric{background:var(--bg-main);border-radius:14px;padding:16px;border:1px solid var(--border-color)}
        .stock-summary-metric strong{display:block;font-size:0.8rem;text-transform:uppercase;color:var(--text-muted);margin-bottom:6px}
        .stock-summary-metric span{font-size:1.2rem;font-weight:700;color:var(--text-primary)}
        .estoque-actions{display:flex;flex-wrap:wrap;gap:12px;align-items:center}
        .badge.neutral{background:rgba(107,114,128,0.15);color:#374151}
        .logo-preview-card{background:var(--bg-card);border-radius:18px;padding:20px;box-shadow:var(--shadow);text-align:center;height:100%;position:relative}
        .logo-preview-card button{margin-top:12px}
        .logo-preview{width:100%;max-width:220px;height:120px;border-radius:16px;background:var(--bg-main);border:2px dashed var(--border-color);display:flex;align-items:center;justify-content:center;margin:0 auto 12px;overflow:hidden}
        .logo-preview img{max-width:100%;max-height:100%;object-fit:contain}
        .community-hero{background:linear-gradient(135deg,var(--primary),var(--secondary));border-radius:22px;padding:32px;color:#fff;box-shadow:var(--shadow-hover);margin-bottom:26px}
        .community-hero h2{font-weight:800;margin-bottom:8px}
        .community-hero p{opacity:0.85}
        .community-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:20px;margin-top:20px}
        .community-card{background:var(--bg-card);border-radius:18px;padding:20px;box-shadow:var(--shadow);height:100%}
        .community-card h5{font-weight:700;margin-bottom:10px}
        .community-pill{display:inline-flex;align-items:center;gap:8px;background:rgba(124,58,237,0.12);color:var(--primary);padding:6px 12px;border-radius:999px;font-size:0.8rem;margin-right:8px;margin-bottom:8px}
.subtabs { margin-top: 1.5rem; }
.subtabs-nav { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 1rem; }
.subtabs-link { background: var(--bg-card); border: 2px solid var(--border-color); border-radius: 12px; padding: 8px 18px; font-weight: 600; color: var(--text-secondary); cursor: pointer; transition: all .2s ease; }
.subtabs-link.active { background: var(--primary); border-color: var(--primary); color: #fff; box-shadow: var(--shadow); }
.subtabs-content { background: transparent; }
.subtabs-pane { display: none; }
.subtabs-pane.active { display: block; animation: fadeIn .2s ease-in-out; }
.prof-avatar-sm { width: 42px; height: 42px; border-radius: 50%; object-fit: cover; background: var(--border-color); display: inline-block; }
.subtabs .table-responsive table thead th { white-space: nowrap; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }


.heat-grid { display: grid; gap: 12px; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); }
.heat-cell { padding: 14px; border-radius: 12px; background: var(--bg-card); box-shadow: var(--shadow); display: flex; flex-direction: column; gap: 4px; }
.heat-cell strong { font-size: 1.2rem; }
.heat-cell small { color: var(--text-muted); }
.formulario-cliente-container .form-label { font-weight: 600; }
.formulario-cliente-grid { display: grid; gap: 16px; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); }
.formulario-cliente-field { padding: 12px; border: 1px solid var(--border-color); border-radius: 12px; background: var(--bg-card); }
.formulario-cliente-field small { color: var(--text-muted); display: block; margin-top: 6px; }
.cliente-stat-card { padding: 18px; border-radius: 18px; background: var(--bg-card); box-shadow: var(--shadow); }
.cliente-stat-card h4 { margin: 0; font-size: 1.4rem; }
.cliente-stat-card span { color: var(--text-muted); font-size: .85rem; text-transform: uppercase; letter-spacing: .05em; }

</style>
</head>
<body>

<div id="authScreen" class="auth-screen">
    <div class="auth-box">
        <div class="auth-logo">
            <img id="authLogoCustom" alt="Logo personalizado" style="display:none;max-height:120px;margin:0 auto 20px;">
            <div class="logo-icon">🌳</div>
            <h2>BIOMA</h2>
            <p>Uberaba - v3.7</p>
        </div>
        <ul class="nav nav-pills nav-fill mb-4">
            <li class="nav-item"><button class="nav-link active" id="loginTab" onclick="switchTab('login')"><i class="bi bi-box-arrow-in-right"></i> Login</button></li>
            <li class="nav-item"><button class="nav-link" id="registerTab" onclick="switchTab('register')"><i class="bi bi-person-plus"></i> Cadastro</button></li>
        </ul>
        <div id="loginForm">
            <form onsubmit="return handleLogin(event)">
                <div class="mb-3"><label>Usuário ou E-mail</label><input type="text" class="form-control" id="loginUsername" required autocomplete="username"></div>
                <div class="mb-3"><label>Senha</label><input type="password" class="form-control" id="loginPassword" required autocomplete="current-password"></div>
                <div class="alert alert-info"><strong>🔑 Acesso Padrão:</strong><br>Usuário: <code>admin</code><br>Senha: <code>admin123</code></div>
                <button type="submit" class="btn btn-primary w-100"><i class="bi bi-box-arrow-in-right"></i> Entrar</button>
            </form>
        </div>
        <div id="registerForm" style="display:none">
            <form onsubmit="return handleRegister(event)">
                <div class="mb-3"><label>Nome Completo *</label><input type="text" class="form-control" id="registerName" required></div>
                <div class="mb-3"><label>Usuário *</label><input type="text" class="form-control" id="registerUsername" required autocomplete="username"></div>
                <div class="mb-3"><label>E-mail *</label><input type="email" class="form-control" id="registerEmail" required autocomplete="email"></div>
                <div class="mb-3"><label>Telefone (opcional)</label><input type="text" class="form-control" id="registerTelefone" placeholder="(34) 99999-9999"></div>
                <div class="mb-3"><label>Senha *</label><input type="password" class="form-control" id="registerPassword" required minlength="6" autocomplete="new-password"></div>
                <div class="alert alert-success"><strong>✅ Privilégios ADMIN</strong><br>Todos os novos usuários recebem acesso completo ao sistema!</div>
                <button type="submit" class="btn btn-primary w-100"><i class="bi bi-person-plus"></i> Criar Conta</button>
            </form>
        </div>
    </div>
</div>

<div id="app">
    <nav class="sidebar">
        <div class="sidebar-logo"><h1>BIOMA</h1><p>Uberaba v3.7</p></div>
        <ul class="sidebar-menu">
            <li><a href="#" onclick="goTo('dashboard')" class="active" id="menu-dashboard"><i class="bi bi-speedometer2"></i> Dashboard</a></li>
            <li><a href="#" onclick="goTo('orcamento')" id="menu-orcamento"><i class="bi bi-file-earmark-plus"></i> Novo Orçamento</a></li>
            <li><a href="#" onclick="goTo('consultar')" id="menu-consultar"><i class="bi bi-search"></i> Consultar</a></li>
            <li><a href="#" onclick="goTo('contratos')" id="menu-contratos"><i class="bi bi-file-earmark-check"></i> Contratos</a></li>
            <li><a href="#" onclick="goTo('relatorios')" id="menu-relatorios"><i class="bi bi-bar-chart-line"></i> Relatórios</a></li>
            <li><a href="#" onclick="goTo('agendamentos')" id="menu-agendamentos"><i class="bi bi-calendar-check"></i> Agendamentos</a></li>
            <li><a href="#" onclick="goTo('fila')" id="menu-fila"><i class="bi bi-people-fill"></i> Fila</a></li>
            <li><a href="#" onclick="goTo('clientes')" id="menu-clientes"><i class="bi bi-people"></i> Clientes</a></li>
            <li><a href="#" onclick="goTo('profissionais')" id="menu-profissionais"><i class="bi bi-person-workspace"></i> Profissionais</a></li>
            <li><a href="#" onclick="goTo('servicos')" id="menu-servicos"><i class="bi bi-scissors"></i> Serviços</a></li>
            <li><a href="#" onclick="goTo('produtos')" id="menu-produtos"><i class="bi bi-box-seam"></i> Produtos</a></li>
            <li><a href="#" onclick="goTo('estoque')" id="menu-estoque"><i class="bi bi-box-seam-fill"></i> Estoque</a></li>
            <li><a href="#" onclick="goTo('clube')" id="menu-clube"><i class="bi bi-award"></i> Comunidade</a></li>
            <li><a href="#" onclick="goTo('importar')" id="menu-importar"><i class="bi bi-cloud-upload"></i> Importar</a></li>
            <li><a href="#" onclick="goTo('sistema')" id="menu-sistema"><i class="bi bi-activity"></i> Sistema</a></li>
            <li><a href="#" onclick="goTo('configuracoes')" id="menu-configuracoes"><i class="bi bi-gear"></i> Configurações</a></li>
            <li><a href="#" onclick="doLogout()"><i class="bi bi-box-arrow-right"></i> Sair</a></li>
        </ul>
        <div class="theme-toggle"><button onclick="toggleTheme()"><i class="bi bi-moon-stars-fill" id="themeIcon"></i><span id="themeText">Modo Escuro</span></button></div>
    </nav>

    <div class="main-content">
<div class="global-search-container">
    <div class="global-search-field">
        <i class="bi bi-search"></i>
        <input type="text" class="global-search-input" id="globalSearchInput" placeholder="Pesquisar clientes, produtos, serviços, profissionais, contratos..." oninput="buscarGlobal(this.value)">
        <button class="btn btn-outline" type="button" onclick="executarBuscaGlobal()"><i class="bi bi-arrow-repeat"></i></button>
    </div>
    <div id="globalSearchResults" class="global-search-results"></div>
</div>

        <div id="section-dashboard" class="content-section active">
            <div class="page-header"><h1><i class="bi bi-speedometer2"></i> Dashboard</h1></div>
            <div class="row g-4 mb-4">
                <div class="col-lg-3 col-md-6"><div class="stat-card"><div class="icon"><i class="bi bi-file-earmark-text"></i></div><h3 id="dashOrcamentos">0</h3><p>Orçamentos</p></div></div>
                <div class="col-lg-3 col-md-6"><div class="stat-card"><div class="icon"><i class="bi bi-people"></i></div><h3 id="dashClientes">0</h3><p>Clientes</p></div></div>
                <div class="col-lg-3 col-md-6"><div class="stat-card"><div class="icon"><i class="bi bi-calendar-check"></i></div><h3 id="dashAgendamentos">0</h3><p>Agendamentos Hoje</p></div></div>
                <div class="col-lg-3 col-md-6"><div class="stat-card"><div class="icon"><i class="bi bi-currency-dollar"></i></div><h3 id="dashFaturamento">R$ 0</h3><p>Faturamento</p></div></div>
            </div>
            <div class="row g-4">
                <div class="col-md-6"><div class="card"><div class="card-header"><i class="bi bi-exclamation-triangle"></i> Alertas de Estoque</div><div class="card-body" id="alertasEstoque"><div class="spinner"></div></div></div></div>
                <div class="col-md-6"><div class="card"><div class="card-header"><i class="bi bi-calendar-event"></i> Próximos Agendamentos</div><div class="card-body" id="proximosAgendamentos"><div class="spinner"></div></div></div></div>
            </div>
            <div class="card mt-4"><div class="card-header"><i class="bi bi-clock-history"></i> Últimos Orçamentos</div><div class="card-body"><div class="table-responsive"><table><thead><tr><th>Nº</th><th>Data</th><th>Cliente</th><th>Valor</th><th>Status</th></tr></thead><tbody id="ultimosOrcamentosBody"><tr><td colspan="5" class="text-center"><div class="spinner"></div></td></tr></tbody></table></div></div></div>
        </div>

        <div id="section-orcamento" class="content-section">
            <div class="page-header"><h1><i class="bi bi-file-earmark-plus"></i> Novo Orçamento</h1></div>
            <div class="card"><div class="card-header"><i class="bi bi-person-badge"></i> Dados do Cliente</div><div class="card-body"><div class="row g-3 mb-3"><div class="col-md-6"><label style="display:block;font-weight:700;margin-bottom:10px">CPF *</label><div style="position:relative"><input type="text" id="orcCPF" placeholder="Digite o CPF..." maxlength="14" class="form-control" onkeyup="buscarClientePorCPF()"><div id="cpfResults" class="autocomplete-results"></div></div></div><div class="col-md-6"><label style="display:block;font-weight:700;margin-bottom:10px">Nome Completo *</label><input type="text" id="orcNomeCliente" placeholder="Nome do cliente" class="form-control"></div></div><div class="row g-3 mb-3"><div class="col-md-6"><label style="display:block;font-weight:700;margin-bottom:10px">E-mail</label><input type="email" id="orcEmail" placeholder="email@exemplo.com" class="form-control"></div><div class="col-md-6"><label style="display:block;font-weight:700;margin-bottom:10px">Telefone</label><input type="text" id="orcTelefone" placeholder="(34) 99999-9999" class="form-control"></div></div><button class="btn btn-outline" onclick="limparCliente()"><i class="bi bi-x-circle"></i> Limpar</button></div></div>
            <h2 style="margin:40px 0 20px;color:var(--text-primary);padding-left:20px;border-left:6px solid var(--primary)"><i class="bi bi-scissors"></i> SERVIÇOS</h2>
            <div class="card"><div class="card-header"><i class="bi bi-plus-circle"></i> Adicionar Serviço</div><div class="card-body"><div class="row g-3"><div class="col-lg-3"><label>Buscar Serviço</label><div style="position:relative"><input type="text" id="buscaServico" placeholder="Digite..." class="form-control" onkeyup="buscarServicos()"><div id="servicoResults" class="autocomplete-results"></div></div></div><div class="col-lg-2"><label>Tamanho</label><select id="servicoTamanho" class="form-select"><option value="">Selecione...</option></select></div><div class="col-lg-1"><label>Qtd</label><input type="number" id="servicoQtd" value="1" min="1" class="form-control"></div><div class="col-lg-2"><label>Preço</label><input type="number" id="servicoPreco" step="0.01" class="form-control"></div><div class="col-lg-2"><label>Profissional</label><select id="servicoProfissional" class="form-select"><option value="">Selecione</option></select></div><div class="col-lg-2"><label>Assistente</label><select id="servicoAssistente" class="form-select"><option value="">Sem assistente</option></select></div></div><div class="row g-3 mt-2"><div class="col-lg-4"><label>Atividade do assistente</label><input type="text" id="assistenteServico" class="form-control" placeholder="Ex: Apoio, Escova..."></div><div class="col-lg-2"><label>Desc %</label><input type="number" id="servicoDesconto" value="0" min="0" max="100" class="form-control"></div><div class="col-lg-2 d-flex align-items-end"><button class="btn btn-primary w-100" onclick="addServico()"><i class="bi bi-plus"></i> Adicionar</button></div></div></div></div>
            <div class="card"><div class="card-header"><i class="bi bi-list-check"></i> Serviços Adicionados</div><div class="card-body"><div class="table-responsive"><table><thead><tr><th>Serviço</th><th>Tamanho</th><th>Qtd</th><th>Preço Unit.</th><th>Equipe</th><th>Desc %</th><th>Total</th><th></th></tr></thead><tbody id="servicosBody"><tr><td colspan="7" class="text-center text-muted">Nenhum serviço</td></tr></tbody><tfoot><tr><th colspan="6" style="text-align:right;padding:20px 18px;background:var(--bg-main);font-weight:800;border-top:4px solid var(--primary)">SUBTOTAL SERVIÇOS</th><th id="subtotalServicos" style="padding:20px 18px;background:var(--bg-main);font-weight:800;border-top:4px solid var(--primary)">R$ 0,00</th></tr></tfoot></table></div></div></div>
            <h2 style="margin:40px 0 20px;color:var(--text-primary);padding-left:20px;border-left:6px solid var(--primary)"><i class="bi bi-box-seam"></i> PRODUTOS</h2>
            <div class="card"><div class="card-header"><i class="bi bi-plus-circle"></i> Adicionar Produto</div><div class="card-body"><div class="row g-3"><div class="col-md-4"><label>Buscar Produto</label><div style="position:relative"><input type="text" id="buscaProduto" placeholder="Digite..." class="form-control" onkeyup="buscarProdutos()"><div id="produtoResults" class="autocomplete-results"></div></div></div><div class="col-md-2"><label>Qtd</label><input type="number" id="produtoQtd" value="1" min="1" class="form-control"></div><div class="col-md-2"><label>Preço</label><input type="number" id="produtoPreco" step="0.01" class="form-control"></div><div class="col-md-2"><label>Desc %</label><input type="number" id="produtoDesconto" value="0" min="0" max="100" class="form-control"></div><div class="col-md-2"><label>&nbsp;</label><button class="btn btn-primary w-100" onclick="addProduto()"><i class="bi bi-plus"></i> Add</button></div></div></div></div>
            <div class="card"><div class="card-header"><i class="bi bi-list-check"></i> Produtos Adicionados</div><div class="card-body"><div class="table-responsive"><table><thead><tr><th>Produto</th><th>Marca</th><th>Qtd</th><th>Preço Unit.</th><th>Desc %</th><th>Total</th><th></th></tr></thead><tbody id="produtosBody"><tr><td colspan="7" class="text-center text-muted">Nenhum produto</td></tr></tbody><tfoot><tr><th colspan="5" style="text-align:right;padding:20px 18px;background:var(--bg-main);font-weight:800;border-top:4px solid var(--primary)">SUBTOTAL PRODUTOS</th><th id="subtotalProdutos" colspan="2" style="padding:20px 18px;background:var(--bg-main);font-weight:800;border-top:4px solid var(--primary)">R$ 0,00</th></tr></tfoot></table></div></div></div>
            <div class="card"><div class="card-header"><i class="bi bi-calculator"></i> Resumo e Pagamento</div><div class="card-body"><div class="row g-3 mb-3"><div class="col-md-4"><label>Desconto Global %</label><input type="number" id="descontoGlobal" value="0" min="0" max="100" onchange="calcularTotais()" class="form-control"></div><div class="col-md-4"><label>Cashback %</label><input type="number" id="cashbackPerc" value="0" min="0" max="100" onchange="calcularTotais()" class="form-control"></div><div class="col-md-4"><label>Forma de Pagamento</label><select id="pagamento" class="form-select"><option>Pix</option><option>Débito</option><option>Crédito à Vista</option><option>Crédito Parcelado</option><option>Dinheiro</option></select></div></div><div style="background:linear-gradient(135deg,var(--primary),var(--secondary));color:#fff;padding:40px;border-radius:22px;margin:30px 0;box-shadow:0 15px 40px rgba(124,58,237,0.4)"><div class="row align-items-center"><div class="col-md-6"><h3 id="totalFinalOrc" style="font-size:3.5rem;font-weight:900;margin:0;text-shadow:2px 2px 8px rgba(0,0,0,0.3)">R$ 0,00</h3><p style="font-size:1.3rem;margin:10px 0 0;opacity:0.95">TOTAL</p></div><div class="col-md-6" style="text-align:right"><p id="cashbackValor" style="font-size:1.5rem;margin:0;font-weight:700">🎁 Cashback: R$ 0,00</p></div></div></div><div style="text-align:center;margin-top:30px"><button class="btn btn-secondary" onclick="cancelarOrc()"><i class="bi bi-x-circle"></i> Cancelar</button> <button class="btn btn-outline" onclick="salvarOrc('Pendente')"><i class="bi bi-save"></i> Salvar Rascunho</button> <button class="btn btn-success" onclick="salvarOrc('Aprovado')"><i class="bi bi-check-circle"></i> Gerar Contrato</button></div></div></div>
        </div>

        <div id="section-consultar" class="content-section">
            <div class="page-header"><h1><i class="bi bi-search"></i> Consultar Orçamentos</h1></div>
            <div class="card"><div class="card-header"><i class="bi bi-list-ul"></i> Todos os Orçamentos</div><div class="card-body"><div class="table-responsive"><table><thead><tr><th>Nº</th><th>Data</th><th>Cliente</th><th>Total</th><th>Status</th><th>Ações</th></tr></thead><tbody id="consultaBody"><tr><td colspan="6" class="text-center"><div class="spinner"></div></td></tr></tbody></table></div></div></div>
        </div>

        <div id="section-contratos" class="content-section">
            <div class="page-header">
                <h1><i class="bi bi-file-earmark-check"></i> Contratos Aprovados</h1>
                <button class="btn btn-success" onclick="loadContratos()"><i class="bi bi-arrow-clockwise"></i> Atualizar</button>
            </div>
            <div class="card">
                <div class="card-header"><i class="bi bi-file-check-fill"></i> Orçamentos Aprovados como Contratos</div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>Nº Orçamento</th>
                                    <th>Data Aprovação</th>
                                    <th>Cliente</th>
                                    <th>Valor Total</th>
                                    <th>Status</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="contratosBody">
                                <tr><td colspan="6" class="text-center"><div class="spinner"></div></td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="section-relatorios" class="content-section">
            <div class="page-header">
                <h1><i class="bi bi-bar-chart-line"></i> Relatórios e Análises</h1>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-outline" onclick="loadRelatorios()"><i class="bi bi-arrow-clockwise"></i> Atualizar</button>
                    <button class="btn btn-success" onclick="exportarRelatorio()"><i class="bi bi-file-earmark-excel"></i> Exportar Excel</button>
                </div>
            </div>
            <div class="row g-4 mb-4">
                <div class="col-md-3"><div class="stat-card"><div class="icon"><i class="bi bi-cash-stack"></i></div><h3 id="relFaturamentoTotal">R$ 0</h3><p>Faturamento Total</p></div></div>
                <div class="col-md-3"><div class="stat-card"><div class="icon"><i class="bi bi-calendar-month"></i></div><h3 id="relFaturamentoMes">R$ 0</h3><p>Faturamento Mês</p></div></div>
                <div class="col-md-3"><div class="stat-card"><div class="icon"><i class="bi bi-award"></i></div><h3 id="relCashbackTotal">R$ 0</h3><p>Cashback Gerado</p></div></div>
                <div class="col-md-3"><div class="stat-card"><div class="icon"><i class="bi bi-graph-up"></i></div><h3 id="relTicketMedio">R$ 0</h3><p>Ticket Médio</p></div></div>
            </div>
            <div class="row g-4">
                <div class="col-md-6"><div class="card"><div class="card-header"><i class="bi bi-trophy"></i> Top 5 Serviços</div><div class="card-body"><canvas id="chartServicos" style="max-height:300px"></canvas></div></div></div>
                <div class="col-md-6"><div class="card"><div class="card-header"><i class="bi bi-calendar3"></i> Faturamento Mensal</div><div class="card-body"><canvas id="chartFaturamento" style="max-height:300px"></canvas></div></div></div>
            </div>
            <div class="card mt-4"><div class="card-header"><i class="bi bi-people-fill"></i> Top 10 Clientes VIP</div><div class="card-body"><div class="table-responsive"><table><thead><tr><th>Posição</th><th>Cliente</th><th>Total Gasto</th><th>Visitas</th><th>Última Visita</th></tr></thead><tbody id="topClientesBody"><tr><td colspan="5" class="text-center text-muted">Clique em "Atualizar"</td></tr></tbody></table></div></div></div>
<div class="card mt-4"><div class="card-header"><i class="bi bi-fire"></i> Mapa de Calor (últimos 60 dias)</div><div class="card-body" id="heatmapDiasContainer"><p class="text-muted mb-0">Carregando mapa de calor...</p></div></div>
            <div class="card mt-4"><div class="card-header"><i class="bi bi-box-seam"></i> Produtos Mais Vendidos</div><div class="card-body"><div class="table-responsive"><table><thead><tr><th>Produto</th><th>Qtd Vendida</th><th>Faturamento</th></tr></thead><tbody id="topProdutosBody"><tr><td colspan="3" class="text-center text-muted">Clique em "Atualizar"</td></tr></tbody></table></div></div></div>
        </div>

        <div id="section-agendamentos" class="content-section">
            <div class="page-header">
                <h1><i class="bi bi-calendar-check"></i> Agendamentos</h1>
                <button class="btn btn-primary" onclick="showModalAgendamento()"><i class="bi bi-plus-circle"></i> Novo Agendamento</button>
            </div>
            <div class="row g-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header"><i class="bi bi-calendar3"></i> Lista de Agendamentos</div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Data</th>
                                            <th>Horário</th>
                                            <th>Cliente</th>
                                            <th>Serviço</th>
                                            <th>Profissional</th>
                                            <th>Status</th>
                                            <th>Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody id="agendamentosBody">
                                        <tr><td colspan="7" class="text-center"><div class="spinner"></div></td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="section-fila" class="content-section">
            <div class="page-header">
                <h1><i class="bi bi-people-fill"></i> Fila de Atendimento</h1>
                <button class="btn btn-primary" onclick="showModalFila()"><i class="bi bi-plus-circle"></i> Adicionar à Fila</button>
            </div>
            <div class="card">
                <div class="card-header">
                    <i class="bi bi-list-ol"></i> Fila Atual 
                    <span class="badge success" style="margin-left: 10px; font-size: 1rem;">
                        <i class="bi bi-people"></i> <span id="totalFila">0</span> pessoas
                    </span>
                </div>
                <div class="card-body" id="filaContainer">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>

        <div id="section-clientes" class="content-section">
            <div class="page-header"><h1><i class="bi bi-people"></i> Clientes</h1><button class="btn btn-primary" onclick="showModalCliente()"><i class="bi bi-person-plus"></i> Novo</button></div>
            <div class="card"><div class="card-header"><i class="bi bi-people-fill"></i> Lista de Clientes</div><div class="card-body"><div class="mb-3"><input type="text" class="form-control" id="buscaCliente" placeholder="🔍 Buscar..." onkeyup="filtrarClientes()"></div><div class="table-responsive"><table><thead><tr><th>Nome</th><th>CPF</th><th>Telefone</th><th>Total Gasto</th><th>Visitas</th><th>Ações</th></tr></thead><tbody id="clientesBody"><tr><td colspan="6" class="text-center"><div class="spinner"></div></td></tr></tbody></table></div></div></div>
            <div class="card mt-4">
                <div class="card-header"><i class="bi bi-person-lines-fill"></i> Detalhes do Cliente</div>
                <div class="card-body">
                    <div class="subtabs" id="clienteSubtabs">
                        <div class="subtabs-nav">
                            <button class="subtabs-link active" data-target="#cliente-tab-overview">Visão Geral</button>
                            <button class="subtabs-link" data-target="#cliente-tab-anamnese">Anamnese</button>
                            <button class="subtabs-link" data-target="#cliente-tab-prontuario">Prontuário</button>
                            <button class="subtabs-link" data-target="#cliente-tab-historico">Histórico</button>
                        </div>
                        <div class="subtabs-content">
                            <div class="subtabs-pane active" id="cliente-tab-overview">
                                <div id="clienteOverviewEmpty" class="text-muted">Selecione um cliente na lista acima para visualizar os detalhes.</div>
                                <div id="clienteOverviewContent" style="display:none;">
                                    <div class="d-flex flex-wrap gap-2 mb-3">
                                        <button class="btn btn-primary" id="clienteSalvarBtn"><i class="bi bi-save"></i> Salvar alterações</button>
                                        <button class="btn btn-outline" id="clienteImprimirBtn"><i class="bi bi-printer"></i> Imprimir resumo</button>
                                    </div>
                                    <div id="clienteInfoPane"></div>
                                </div>
                            </div>
                            <div class="subtabs-pane" id="cliente-tab-anamnese">
                                <div id="clienteAnamnesePane" class="formulario-cliente-container text-muted">Selecione um cliente para carregar a anamnese.</div>
                            </div>
                            <div class="subtabs-pane" id="cliente-tab-prontuario">
                                <div id="clienteProntuarioPane" class="formulario-cliente-container text-muted">Selecione um cliente para carregar o prontuário.</div>
                            </div>
                            <div class="subtabs-pane" id="cliente-tab-historico">
                                <div id="clienteHistoricoPane" class="text-muted">Selecione um cliente para visualizar o histórico de orçamentos e atendimentos.</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="section-profissionais" class="content-section">
            <div class="page-header">
                <h1><i class="bi bi-person-workspace"></i> Profissionais</h1>
                <button class="btn btn-primary" onclick="showModalProfissional()"><i class="bi bi-person-plus"></i> Novo</button>
            </div>
            <div class="subtabs" id="profSubtabs">
                <div class="subtabs-nav">
                    <button class="subtabs-link active" data-target="#prof-tab-resumo">Equipe</button>
                    <button class="subtabs-link" data-target="#prof-tab-multicomissao">Multi-comissão</button>
                    <button class="subtabs-link" data-target="#prof-tab-assistentes">Assistentes</button>
                    <button class="subtabs-link" data-target="#prof-tab-detalhes">Desempenho</button>
                </div>
                <div class="subtabs-content">
                    <div class="subtabs-pane active" id="prof-tab-resumo">
                        <div class="card">
                            <div class="card-header"><i class="bi bi-people-fill"></i> Equipe BIOMA</div>
                            <div class="card-body">
                                <div class="row g-3 align-items-center mb-3">
                                    <div class="col-md-6">
                                        <input type="text" class="form-control" id="buscaProfissionais" placeholder="Buscar profissional..." oninput="filtrarProfissionais()">
                                    </div>
                                    <div class="col-md-6 text-md-end text-start">
                                        <span class="text-muted small" id="profResumoTotal"></span>
                                    </div>
                                </div>
                                <div class="table-responsive">
                                    <table>
                                        <thead><tr><th></th><th>Profissional</th><th>Especialidade</th><th>Comissão</th><th>Avaliação</th><th>Status</th><th>Ações</th></tr></thead>
                                        <tbody id="profissionaisBody"><tr><td colspan="7" class="text-center"><div class="spinner"></div></td></tr></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="subtabs-pane" id="prof-tab-multicomissao">
                        <div class="card">
                            <div class="card-header"><i class="bi bi-diagram-3"></i> Sistema Multi-comissão</div>
                            <div class="card-body">
                                <div class="row g-3">
                                    <div class="col-md-5">
                                        <label class="form-label">Orçamento</label>
                                        <select id="multiOrcamentoSelect" class="form-select"></select>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Profissional</label>
                                        <select id="multiProfissionalSelect" class="form-select"></select>
                                    </div>
                                    <div class="col-md-3 d-flex align-items-end">
                                        <button class="btn btn-primary w-100" onclick="executarMultiComissao()"><i class="bi bi-calculator"></i> Calcular</button>
                                    </div>
                                </div>
                                <div class="table-responsive mt-4">
                                    <table>
                                        <thead><tr><th>Descrição</th><th>Valor Serviço</th><th>Profissional</th><th>Assistente</th></tr></thead>
                                        <tbody id="multiComissaoTabela"><tr><td colspan="4" class="text-center text-muted">Selecione um orçamento para visualizar os cálculos</td></tr></tbody>
                                    </table>
                                </div>
                                <div class="mt-3">
                                    <span class="badge neutral" id="multiComissaoTotal">Total de comissões: R$ 0,00</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="subtabs-pane" id="prof-tab-assistentes">
                        <div class="card">
                            <div class="card-header"><i class="bi bi-person-plus-fill"></i> Assistentes</div>
                            <div class="card-body">
                                <div class="row g-3 align-items-end">
                                    <div class="col-md-4">
                                        <label class="form-label">Nome</label>
                                        <input type="text" class="form-control" id="assistenteNome">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">CPF</label>
                                        <input type="text" class="form-control" id="assistenteCPF">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Telefone</label>
                                        <input type="text" class="form-control" id="assistenteTelefone">
                                    </div>
                                    <div class="col-md-2 d-grid">
                                        <button class="btn btn-success" onclick="salvarAssistente()"><i class="bi bi-save"></i> Salvar</button>
                                    </div>
                                </div>
                                <div class="table-responsive mt-4">
                                    <table>
                                        <thead><tr><th>Assistente</th><th>Contato</th><th>Ações</th></tr></thead>
                                        <tbody id="assistentesBody"><tr><td colspan="3" class="text-center text-muted">Nenhum assistente cadastrado</td></tr></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="subtabs-pane" id="prof-tab-detalhes">
                        <div class="card">
                            <div class="card-header"><i class="bi bi-graph-up-arrow"></i> Desempenho do Profissional</div>
                            <div class="card-body" id="profDetalhesContainer">
                                <p class="text-muted mb-0">Selecione um profissional para visualizar o desempenho, comissões e avaliações.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="section-servicos" class="content-section">
            <div class="page-header"><h1><i class="bi bi-scissors"></i> Serviços</h1><button class="btn btn-primary" onclick="showModalServico()"><i class="bi bi-plus-circle"></i> Novo</button></div>
            <div class="card"><div class="card-header"><i class="bi bi-list-ul"></i> Catálogo</div><div class="card-body"><div class="mb-3"><input type="text" class="form-control" id="buscaServicos" placeholder="Buscar serviço..." oninput="filtrarServicosLista()"></div><div class="table-responsive"><table><thead><tr><th>Nome</th><th>Tamanho</th><th>Preço</th><th>Categoria</th><th>Ações</th></tr></thead><tbody id="servicosListBody"><tr><td colspan="5" class="text-center"><div class="spinner"></div></td></tr></tbody></table></div></div></div>
        </div>

        <div id="section-produtos" class="content-section">
            <div class="page-header"><h1><i class="bi bi-box-seam"></i> Produtos</h1><button class="btn btn-primary" onclick="showModalProduto()"><i class="bi bi-plus-circle"></i> Novo</button></div>
            <div class="card"><div class="card-header"><i class="bi bi-box-fill"></i> Estoque</div><div class="card-body"><div class="mb-3"><input type="text" class="form-control" id="buscaProdutos" placeholder="Buscar produto..." oninput="filtrarProdutosLista()"></div><div class="table-responsive"><table><thead><tr><th>Nome</th><th>Marca</th><th>Preço</th><th>Estoque</th><th>Ações</th></tr></thead><tbody id="produtosListBody"><tr><td colspan="5" class="text-center"><div class="spinner"></div></td></tr></tbody></table></div></div></div>
        </div>

        <div id="section-estoque" class="content-section">
            <div class="page-header">
                <h1><i class="bi bi-box-seam-fill"></i> Estoque</h1>
                <div class="estoque-actions">
                    <button class="btn btn-success" type="button" onclick="abrirEntradaEstoque()"><i class="bi bi-box-arrow-in-down"></i> Nova Entrada</button>
                    <button class="btn btn-danger" type="button" onclick="abrirSaidaEstoque()"><i class="bi bi-box-arrow-up"></i> Nova Saída</button>
                    <button class="btn btn-outline" type="button" onclick="document.getElementById('estoqueImportInput').click()"><i class="bi bi-cloud-upload"></i> Importar Estoque</button>
                    <button class="btn btn-outline" type="button" onclick="exportarEstoque()"><i class="bi bi-cloud-download"></i> Exportar Estoque</button>
                    <input type="file" id="estoqueImportInput" accept=".csv,.xlsx,.xls" style="display:none" onchange="importarPlanilhaEstoque(this)">
                </div>
            </div>
            <div class="row g-4">
                <div class="col-xl-4">
                    <div class="stock-summary-card">
                        <div class="d-flex align-items-center justify-content-between">
                            <div>
                                <p class="text-muted mb-1">Valor estimado de venda</p>
                                <h3 id="estoqueResumoValorVenda">R$ 0,00</h3>
                            </div>
                            <div class="badge neutral" id="estoqueResumoTotalProdutos">0 itens</div>
                        </div>
                        <div class="stock-summary-grid">
                            <div class="stock-summary-metric">
                                <strong>Valor de custo</strong>
                                <span id="estoqueResumoValorCusto">R$ 0,00</span>
                            </div>
                            <div class="stock-summary-metric">
                                <strong>Margem potencial</strong>
                                <span id="estoqueResumoMargem">R$ 0,00</span>
                            </div>
                            <div class="stock-summary-metric">
                                <strong>Produtos críticos</strong>
                                <span id="estoqueResumoCriticos">0</span>
                            </div>
                            <div class="stock-summary-metric">
                                <strong>Baixo estoque</strong>
                                <span id="estoqueResumoBaixo">0</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-8">
                    <div class="card">
                        <div class="card-header"><i class="bi bi-exclamation-triangle-fill"></i> Estoque Baixo</div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table>
                                    <thead><tr><th>Produto</th><th>SKU</th><th>Estoque</th><th>Mínimo</th><th>Status</th></tr></thead>
                                    <tbody id="estoqueBaixoBody"><tr><td colspan="5" class="text-center"><div class="spinner"></div></td></tr></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card mt-4">
                <div class="card-header"><i class="bi bi-inbox"></i> Entradas pendentes de aprovação</div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table>
                            <thead><tr><th>Produto</th><th>Quantidade</th><th>Fornecedor</th><th>Motivo</th><th>Solicitado por</th><th>Ações</th></tr></thead>
                            <tbody id="estoquePendentesBody"><tr><td colspan="6" class="text-center text-muted">Nenhuma entrada pendente</td></tr></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="card mt-4">
                <div class="card-header"><i class="bi bi-clock-history"></i> Últimas movimentações</div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table>
                            <thead><tr><th>Data</th><th>Produto</th><th>Tipo</th><th>Quantidade</th><th>Responsável</th><th>Detalhes</th></tr></thead>
                            <tbody id="estoqueMovimentosBody"><tr><td colspan="6" class="text-center text-muted">Nenhuma movimentação registrada</td></tr></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="section-clube" class="content-section">
            <div class="community-hero">
                <h2><i class="bi bi-stars"></i> Comunidade BIOMA</h2>
                <p>Resultados reais, desafios e experiências compartilhadas pelas nossas franquias.</p>
                <div class="community-pill"><i class="bi bi-chat-dots"></i> +250 feedbacks mensais</div>
                <div class="community-pill"><i class="bi bi-heart-fill"></i> 98% satisfação</div>
                <div class="community-pill"><i class="bi bi-award"></i> 32 mentorias concluídas</div>
            </div>
            <div class="community-grid">
                <div class="community-card">
                    <h5><i class="bi bi-people-fill"></i> Plano Conexão VIP</h5>
                    <p>Programa premium para clientes recorrentes com acompanhamento personalizado e experiências exclusivas.</p>
                    <ul class="mb-3">
                        <li>12 sessões anuais planejadas</li>
                        <li>Mentorias com especialistas BIOMA</li>
                        <li>Clube de benefícios com parceiros</li>
                    </ul>
                    <button class="btn btn-outline" type="button" onclick="abrirComunidadeDetalhe('conexao')"><i class="bi bi-eye"></i> Ver detalhes</button>
                </div>
                <div class="community-card">
                    <h5><i class="bi bi-lightbulb"></i> Novos Workshops</h5>
                    <p>Capacitações mensais sobre gestão de salão, neurovendas e cronogramas capilares.</p>
                    <ul class="mb-3">
                        <li>Agenda interativa com confirmação online</li>
                        <li>Materiais exclusivos pós-evento</li>
                        <li>Certificados digitais personalizados</li>
                    </ul>
                    <button class="btn btn-outline" type="button" onclick="abrirComunidadeDetalhe('workshops')"><i class="bi bi-calendar-event"></i> Próximas turmas</button>
                </div>
                <div class="community-card">
                    <h5><i class="bi bi-graph-up"></i> Histórias de Sucesso</h5>
                    <p>Empreendedores BIOMA compartilhando crescimento real com dados de faturamento e engajamento.</p>
                    <div class="mb-3">
                        <strong>+32%</strong> aumento médio de ticket em 90 dias<br>
                        <strong>+18%</strong> crescimento em produtos recomendados<br>
                        <strong>92%</strong> de adesão aos planos fidelidade
                    </div>
                    <button class="btn btn-outline" type="button" onclick="abrirComunidadeDetalhe('cases')"><i class="bi bi-play-circle"></i> Assistir depoimentos</button>
                </div>
                <div class="community-card">
                    <h5><i class="bi bi-chat-quote-fill"></i> Canal de Ideias</h5>
                    <p>Seleção das principais demandas sugeridas pelas franquias e status de implementação.</p>
                    <ul class="mb-3">
                        <li>App mobile para equipe - em desenvolvimento</li>
                        <li>Dashboard de indicadores em tempo real - entregue</li>
                        <li>Integração com BIOMA Pay - em testes</li>
                    </ul>
                    <button class="btn btn-outline" type="button" onclick="abrirComunidadeDetalhe('ideias')"><i class="bi bi-send"></i> Enviar sugestão</button>
                </div>
            </div>
        </div>

        <div id="section-importar" class="content-section">
            <div class="page-header">
                <h1><i class="bi bi-cloud-upload"></i> Importar Dados em Massa</h1>
            </div>
            <div class="alert alert-info">
                <strong><i class="bi bi-info-circle"></i> Informação:</strong> 
                Faça upload de arquivos CSV ou Excel (.xlsx, .xls) para importar dados em massa. 
                Baixe os templates para garantir o formato correto.
            </div>
            <div class="row g-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header"><i class="bi bi-people"></i> Clientes</div>
                        <div class="card-body">
                            <div style="border:3px dashed var(--border-color);border-radius:20px;padding:60px 20px;text-align:center;cursor:pointer;transition: all 0.3s;" onclick="document.getElementById('uploadClientes').click()" onmouseover="this.style.borderColor='var(--primary)'" onmouseout="this.style.borderColor='var(--border-color)'">
                                <i class="bi bi-cloud-upload" style="font-size:4rem;color:var(--primary)"></i>
                                <h4 style="margin-top:15px;">Clique para selecionar arquivo</h4>
                                <p class="text-muted">CSV ou Excel (xlsx, xls)</p>
                                <input type="file" id="uploadClientes" accept=".csv,.xlsx,.xls" style="display:none" onchange="handleUpload(this,'clientes')">
                            </div>
                            <a href="/api/template/download/clientes" class="btn btn-outline w-100 mt-3">
                                <i class="bi bi-download"></i> Baixar Template CSV
                            </a>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header"><i class="bi bi-person-workspace"></i> Profissionais</div>
                        <div class="card-body">
                            <div style="border:3px dashed var(--border-color);border-radius:20px;padding:60px 20px;text-align:center;cursor:pointer;transition: all 0.3s;" onclick="document.getElementById('uploadProfissionais').click()" onmouseover="this.style.borderColor='var(--primary)'" onmouseout="this.style.borderColor='var(--border-color)'">
                                <i class="bi bi-cloud-upload" style="font-size:4rem;color:var(--primary)"></i>
                                <h4 style="margin-top:15px;">Clique para selecionar arquivo</h4>
                                <p class="text-muted">CSV ou Excel (xlsx, xls)</p>
                                <input type="file" id="uploadProfissionais" accept=".csv,.xlsx,.xls" style="display:none" onchange="handleUpload(this,'profissionais')">
                            </div>
                            <a href="/api/template/download/profissionais" class="btn btn-outline w-100 mt-3">
                                <i class="bi bi-download"></i> Baixar Template CSV
                            </a>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header"><i class="bi bi-box-seam"></i> Produtos</div>
                        <div class="card-body">
                            <div style="border:3px dashed var(--border-color);border-radius:20px;padding:60px 20px;text-align:center;cursor:pointer;transition: all 0.3s;" onclick="document.getElementById('uploadProdutos').click()" onmouseover="this.style.borderColor='var(--primary)'" onmouseout="this.style.borderColor='var(--border-color)'">
                                <i class="bi bi-cloud-upload" style="font-size:4rem;color:var(--primary)"></i>
                                <h4 style="margin-top:15px;">Clique para selecionar arquivo</h4>
                                <p class="text-muted">CSV ou Excel (xlsx, xls)</p>
                                <input type="file" id="uploadProdutos" accept=".csv,.xlsx,.xls" style="display:none" onchange="handleUpload(this,'produtos')">
                            </div>
                            <a href="/api/template/download/produtos" class="btn btn-outline w-100 mt-3">
                                <i class="bi bi-download"></i> Baixar Template CSV
                            </a>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header"><i class="bi bi-scissors"></i> Serviços</div>
                        <div class="card-body">
                            <div style="border:3px dashed var(--border-color);border-radius:20px;padding:60px 20px;text-align:center;cursor:pointer;transition: all 0.3s;" onclick="document.getElementById('uploadServicos').click()" onmouseover="this.style.borderColor='var(--primary)'" onmouseout="this.style.borderColor='var(--border-color)'">
                                <i class="bi bi-cloud-upload" style="font-size:4rem;color:var(--primary)"></i>
                                <h4 style="margin-top:15px;">Clique para selecionar arquivo</h4>
                                <p class="text-muted">CSV ou Excel (xlsx, xls)</p>
                                <input type="file" id="uploadServicos" accept=".csv,.xlsx,.xls" style="display:none" onchange="handleUpload(this,'servicos')">
                            </div>
                            <a href="/api/template/download/servicos" class="btn btn-outline w-100 mt-3">
                                <i class="bi bi-download"></i> Baixar Template CSV
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="section-sistema" class="content-section">
            <div class="page-header"><h1><i class="bi bi-activity"></i> Status</h1><button class="btn btn-outline" onclick="verificarStatus()"><i class="bi bi-arrow-clockwise"></i> Atualizar</button></div>
            <div class="row g-4">
                <div class="col-md-4"><div class="card"><div class="card-header"><i class="bi bi-database"></i> MongoDB</div><div class="card-body text-center"><div id="mongoStatus" class="badge warning">Verificando...</div><p class="mt-3" id="mongoMessage">...</p></div></div></div>
                <div class="col-md-4"><div class="card"><div class="card-header"><i class="bi bi-envelope"></i> MailerSend</div><div class="card-body text-center"><div id="emailStatus" class="badge warning">Verificando...</div><p class="mt-3" id="emailMessage">...</p></div></div></div>
                <div class="col-md-4"><div class="card"><div class="card-header"><i class="bi bi-info-circle"></i> Versão</div><div class="card-body text-center"><h3>v3.7</h3><p>BIOMA Uberaba</p></div></div></div>
            </div>
        </div>

        <div id="section-configuracoes" class="content-section">
            <div class="page-header"><h1><i class="bi bi-gear"></i> Configurações</h1></div>
            <div class="card"><div class="card-header"><i class="bi bi-building"></i> Dados da Franquia BIOMA</div><div class="card-body"><div class="row g-3 mb-3"><div class="col-md-6"><label style="display:block;font-weight:700;margin-bottom:10px">Nome da Empresa *</label><input type="text" id="cfgNome" value="BIOMA UBERABA" class="form-control"></div><div class="col-md-6"><label style="display:block;font-weight:700;margin-bottom:10px">CNPJ *</label><input type="text" id="cfgCNPJ" value="49.470.937/0001-10" class="form-control"></div></div><div class="mb-3"><label style="display:block;font-weight:700;margin-bottom:10px">Endereço Completo *</label><input type="text" id="cfgEndereco" value="Av. Santos Dumont 3110 - Santa Maria - Uberaba/MG - CEP 38050-400" class="form-control"></div><div class="row g-3 mb-3"><div class="col-md-6"><label style="display:block;font-weight:700;margin-bottom:10px">Telefone *</label><input type="text" id="cfgTelefone" value="(34) 99235-5890" class="form-control"></div><div class="col-md-6"><label style="display:block;font-weight:700;margin-bottom:10px">E-mail *</label><input type="email" id="cfgEmail" value="biomauberaba@gmail.com" class="form-control"></div></div><button class="btn btn-primary" onclick="salvarConfig()"><i class="bi bi-save"></i> Salvar Dados da Franquia</button></div></div>
            <div class="card mt-4"><div class="card-header"><i class="bi bi-image"></i> Personalização Visual</div><div class="card-body"><div class="row g-4"><div class="col-md-6"><div class="logo-preview-card"><div class="logo-preview" id="logoPrincipalPreview"><span class="text-muted">Logo do sistema</span></div><button class="btn btn-outline" type="button" onclick="abrirUploadLogo('principal')"><i class="bi bi-upload"></i> Enviar logo principal</button><button class="btn btn-sm btn-link text-danger mt-2" type="button" onclick="removerLogo('principal')">Remover</button></div></div><div class="col-md-6"><div class="logo-preview-card"><div class="logo-preview" id="logoLoginPreview"><span class="text-muted">Logo da tela de login</span></div><button class="btn btn-outline" type="button" onclick="abrirUploadLogo('login')"><i class="bi bi-upload"></i> Enviar logo de login</button><button class="btn btn-sm btn-link text-danger mt-2" type="button" onclick="removerLogo('login')">Remover</button></div></div></div></div></div>
            <div class="card mt-4"><div class="card-header"><i class="bi bi-sliders"></i> Configurações Operacionais</div><div class="card-body"><div class="row g-3 mb-3"><div class="col-md-4"><label style="display:block;font-weight:700;margin-bottom:10px">Horário Abertura</label><input type="time" id="cfgHorarioAbertura" value="08:00" class="form-control"></div><div class="col-md-4"><label style="display:block;font-weight:700;margin-bottom:10px">Horário Fechamento</label><input type="time" id="cfgHorarioFechamento" value="19:00" class="form-control"></div><div class="col-md-4"><label style="display:block;font-weight:700;margin-bottom:10px">Duração Padrão (min)</label><input type="number" id="cfgDuracaoPadrao" value="60" class="form-control"></div></div><div class="row g-3 mb-3"><div class="col-md-6"><label style="display:block;font-weight:700;margin-bottom:10px">Cashback Padrão (%)</label><input type="number" id="cfgCashbackPadrao" value="5" min="0" max="100" class="form-control"></div><div class="col-md-6"><label style="display:block;font-weight:700;margin-bottom:10px">Comissão Padrão (%)</label><input type="number" id="cfgComissaoPadrao" value="10" min="0" max="100" class="form-control"></div></div><button class="btn btn-success" onclick="salvarConfigOp()"><i class="bi bi-check-circle"></i> Salvar Configurações Operacionais</button></div></div>
            <div class="card mt-4"><div class="card-header"><i class="bi bi-shield-check"></i> Licença e Desenvolvedor</div><div class="card-body"><table style="width:100%"><tr style="border-bottom:1px solid var(--border-color)"><td style="padding:15px;font-weight:700">Plano Contratado:</td><td style="padding:15px"><span class="badge success">PROFISSIONAL PREMIUM</span></td></tr><tr style="border-bottom:1px solid var(--border-color)"><td style="padding:15px;font-weight:700">Franquia:</td><td style="padding:15px">BIOMA Uberaba - Oficial</td></tr><tr style="border-bottom:1px solid var(--border-color)"><td style="padding:15px;font-weight:700">Desenvolvedor:</td><td style="padding:15px">@juanmarco1999 (Juan Marco Bernardos Souza e Silva)</td></tr><tr style="border-bottom:1px solid var(--border-color)"><td style="padding:15px;font-weight:700">Email Suporte:</td><td style="padding:15px">180147064@aluno.unb.br</td></tr><tr style="border-bottom:1px solid var(--border-color)"><td style="padding:15px;font-weight:700">Versão:</td><td style="padding:15px">v3.7 (Build 2025.10.05)</td></tr><tr><td style="padding:15px;font-weight:700">Última Atualização:</td><td style="padding:15px">05 de Outubro de 2025 às 22:34 UTC</td></tr></table></div></div>
        </div>

    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="/static/js/correcoes_bioma.js"></script>
<script>

let currentUser=null,currentTheme='light',orcamento={servicos:[],produtos:[]},servicosDisponiveis=[],produtosDisponiveis=[],servicoSelecionado=null,produtoSelecionado=null;
let profissionaisLista=[],assistentesLista=[],clientesLista=[],orcamentosLista=[];
let formulariosCliente=null,clienteAtual=null;
let entradasPendentesMapa={};
let produtosCache=[],buscaGlobalTimer=null,configuracoesAtuais=null,logosPersonalizados={principal:null,login:null};

document.addEventListener('DOMContentLoaded',()=>{
    initSubtabs('profSubtabs');
    initSubtabs('clienteSubtabs');
    carregarOrcamentosMulti();
    console.log('%c🌳 BIOMA v3.7 DEFINITIVO','background:#7C3AED;color:#fff;font-size:24px;padding:15px;border-radius:8px;font-weight:900');
    console.log('%c✅ Sistema 100% Completo Carregado','color:#10B981;font-size:16px;font-weight:700');
    checkAuth();
});

async function checkAuth(){
    try{
        const res=await fetch('/api/current-user',{credentials:'include'});
        const data=await res.json();
        if(data.success&&data.user){
            currentUser=data.user;
            currentTheme=data.user.theme||'light';
            applyTheme(currentTheme);
            showApp();
        }else{
            showAuth();
        }
    }catch(e){
        console.error('❌ Auth error:',e);
        showAuth();
    }
}

function showAuth(){
    document.getElementById('authScreen').style.display='flex';
    document.getElementById('app').style.display='none';
}

function showApp(){
    document.getElementById('authScreen').style.display='none';
    document.getElementById('app').style.display='block';
    loadConfiguracoes();
    setTimeout(()=>{loadDashboard();},100);
}

function switchTab(tab){
    if(tab==='login'){
        document.getElementById('loginTab').classList.add('active');
        document.getElementById('registerTab').classList.remove('active');
        document.getElementById('loginForm').style.display='block';
        document.getElementById('registerForm').style.display='none';
    }else{
        document.getElementById('registerTab').classList.add('active');
        document.getElementById('loginTab').classList.remove('active');
        document.getElementById('registerForm').style.display='block';
        document.getElementById('loginForm').style.display='none';
    }
}

async function handleLogin(e){
    e.preventDefault();
    const username=document.getElementById('loginUsername').value.trim();
    const password=document.getElementById('loginPassword').value.trim();
    try{
        const res=await fetch('/api/login',{method:'POST',headers:{'Content-Type':'application/json'},credentials:'include',body:JSON.stringify({username,password})});
        const data=await res.json();
        if(data.success&&data.user){
            currentUser=data.user;
            currentTheme=data.user.theme||'light';
            Swal.fire({icon:'success',title:'✅ Bem-vindo!',text:`Olá, ${currentUser.name}!`,timer:1500,showConfirmButton:false});
            setTimeout(()=>{applyTheme(currentTheme);showApp();},500);
        }else{
            Swal.fire('Erro',data.message||'Credenciais inválidas','error');
        }
    }catch(e){
        Swal.fire('Erro','Não foi possível conectar','error');
    }
    return false;
}

async function handleRegister(e){
    e.preventDefault();
    const name=document.getElementById('registerName').value.trim();
    const username=document.getElementById('registerUsername').value.trim();
    const email=document.getElementById('registerEmail').value.trim();
    const telefone=document.getElementById('registerTelefone').value.trim();
    const password=document.getElementById('registerPassword').value.trim();
    try{
        const res=await fetch('/api/register',{method:'POST',headers:{'Content-Type':'application/json'},credentials:'include',body:JSON.stringify({name,username,email,telefone,password})});
        const data=await res.json();
        if(data.success){
            Swal.fire({icon:'success',title:'✅ Conta Criada!',html:'<p>Conta criada com privilégios de ADMIN!</p><p>Faça login agora.</p>',timer:3000}).then(()=>{switchTab('login');document.getElementById('loginUsername').value=username;});
        }else{
            Swal.fire('Erro',data.message,'error');
        }
    }catch(e){
        Swal.fire('Erro','Erro ao criar conta','error');
    }
    return false;
}

async function doLogout(){
    const result=await Swal.fire({title:'Deseja sair?',icon:'question',showCancelButton:true,confirmButtonText:'Sim',cancelButtonText:'Cancelar'});
    if(result.isConfirmed){
        await fetch('/api/logout',{method:'POST',credentials:'include'});
        Swal.fire({icon:'success',title:'Até logo!',timer:1000,showConfirmButton:false});
        setTimeout(()=>{currentUser=null;location.reload();},500);
    }
}

function applyTheme(theme){
    document.documentElement.setAttribute('data-theme',theme);
    currentTheme=theme;
    if(theme==='dark'){
        document.getElementById('themeIcon').className='bi bi-sun-fill';
        document.getElementById('themeText').textContent='Modo Claro';
    }else{
        document.getElementById('themeIcon').className='bi bi-moon-stars-fill';
        document.getElementById('themeText').textContent='Modo Escuro';
    }
}

async function toggleTheme(){
    const newTheme=currentTheme==='light'?'dark':'light';
    applyTheme(newTheme);
    try{
        await fetch('/api/update-theme',{method:'POST',headers:{'Content-Type':'application/json'},credentials:'include',body:JSON.stringify({theme:newTheme})});
    }catch(e){
        console.error('❌ Theme error:',e);
    }
}

function goTo(section){
    console.log('🔄 Navegando:',section);
    try{
        document.querySelectorAll('.content-section').forEach(s=>s.classList.remove('active'));
        const sectionElement=document.getElementById('section-'+section);
        if(sectionElement){sectionElement.classList.add('active');}
        document.querySelectorAll('.sidebar-menu a').forEach(a=>a.classList.remove('active'));
        const menu=document.getElementById('menu-'+section);
        if(menu)menu.classList.add('active');
        const mainContent=document.querySelector('.main-content');
        if(mainContent)mainContent.scrollTo({top:0,behavior:'smooth'});
        if(section==='dashboard')loadDashboard();
        else if(section==='clientes')loadClientes();
        else if(section==='profissionais')loadProfissionais();
        else if(section==='servicos')loadServicosLista();
        else if(section==='produtos')loadProdutosLista();
        else if(section==='consultar')loadConsultar();
        else if(section==='contratos')loadContratos();
        else if(section==='fila')loadFila();
        else if(section==='sistema')verificarStatus();
        else if(section==='estoque')loadEstoque();
        else if(section==='configuracoes')loadConfiguracoes();
        else if(section==='agendamentos')loadAgendamentos();
    }catch(e){
        console.error('❌ Erro navegação:',e);
    }

}

function filtrarTabelaPorTermo(tbodySelector, termo){
    const normalized = (termo || '').toLowerCase();
    document.querySelectorAll(`${tbodySelector} tr`).forEach(row => {
        if(row.dataset.keepVisible === 'true'){
            row.style.display = '';
            return;
        }
        const texto = row.textContent.toLowerCase();
        row.style.display = texto.includes(normalized) ? '' : 'none';
    });
}

async function uploadImagemBase64(file, tipo='profissional'){
    if(!file) return '';
    return new Promise((resolve,reject)=>{
        const reader = new FileReader();
        reader.onload = async () => {
            try{
                const res = await fetch('/api/upload/imagem',{
                    method:'POST',
                    headers:{'Content-Type':'application/json'},
                    credentials:'include',
                    body:JSON.stringify({image_data: reader.result, tipo})
                });
                const data = await res.json();
                if(data.success){ resolve(data.url || data.data_url || ''); } else { reject(data.message || 'Upload falhou'); }
            }catch(e){ reject(e); }
        };
        reader.onerror = () => reject('Falha ao ler arquivo');
        reader.readAsDataURL(file);
    });
}

async function loadProfissionais(){
  return safeCall('loadProfissionais', async () => {
    try{
      const resposta = await API.get('/api/profissionais');
      const lista = Array.isArray(resposta.profissionais) ? resposta.profissionais : [];
      profissionaisLista = lista;

      const ativos = lista.filter(p => p.ativo).length;
      const resumoEquipe = document.getElementById('profResumoTotal');
      if(resumoEquipe){
        resumoEquipe.textContent = lista.length ? `${ativos} ativos de ${lista.length}` : '0 profissionais';
      }

      const corpoEquipe = document.getElementById('profissionaisBody');
      if(corpoEquipe){
        if(lista.length){
          const linhas = lista.map(p => {
            const avatar = p.foto_url
              ? `<img src="${p.foto_url}" alt="${p.nome||'Profissional'}" class="prof-avatar-sm">`
              : `<span class="prof-avatar-sm d-flex align-items-center justify-content-center"><i class="bi bi-person"></i></span>`;
            const avaliacaoTotal = Number(p.avaliacoes_total || 0);
            const avaliacaoMedia = Number(p.avaliacao_media || 0).toFixed(1);
            const avaliacaoHtml = avaliacaoTotal
              ? `<span class="text-warning"><i class="bi bi-star-fill"></i> ${avaliacaoMedia}</span><small class="text-muted ms-1">(${avaliacaoTotal})</small>`
              : '<span class="text-muted">Sem avaliações</span>';
            const statusBadge = `<span class="badge ${p.ativo ? 'success' : 'danger'}">${p.ativo ? 'Ativo' : 'Inativo'}</span>`;
            return `<tr data-id="${p._id}">
              <td class="align-middle">${avatar}</td>
              <td>
                <div class="fw-semibold">${p.nome || '-'}</div>
                <small class="text-muted">${p.cpf || '-'}</small>
              </td>
              <td>${p.especialidade || '-'}</td>
              <td>${Number(p.comissao_perc || 0).toFixed(1)}%</td>
              <td>${avaliacaoHtml}</td>
              <td>${statusBadge}</td>
              <td>
                <button class="btn btn-sm btn-info" onclick="mostrarDetalhesProfissional('${p._id}')"><i class="bi bi-activity"></i></button>
                <button class="btn btn-sm btn-primary" onclick="editarProfissional('${p._id}')"><i class="bi bi-pencil"></i></button>
                <button class="btn btn-sm btn-danger" onclick="deleteProfissional('${p._id}')"><i class="bi bi-trash"></i></button>
              </td>
            </tr>`;
          }).join('');
          corpoEquipe.innerHTML = linhas;
        }else{
          corpoEquipe.innerHTML = '<tr data-keep-visible="true"><td colspan="7" class="text-center text-muted">Nenhum profissional cadastrado</td></tr>';
        }
      }

      const tabelaLegada = document.querySelector('#table-profissionais tbody') || document.querySelector('#tblProfissionaisBody');
      if(tabelaLegada){
        const linhasLegado = lista.map(p => `<tr data-id="${p._id}">
            <td>${p.nome || ''}</td>
            <td>${p.cpf || ''}</td>
            <td>${p.especialidade || ''}</td>
            <td>${Number(p.comissao_perc || 0).toFixed(1)}%</td>
            <td>${p.telefone || ''}</td>
            <td>${p.email || ''}</td>
          </tr>`).join('');
        tabelaLegada.innerHTML = linhasLegado || '<tr><td colspan="6" class="text-muted">Sem profissionais</td></tr>';
      }

      const seletorAgendamento = document.querySelector('#agProf');
      if(seletorAgendamento){
        seletorAgendamento.innerHTML = lista.map(p => `<option value="${p._id}">${p.nome}</option>`).join('');
      }

      preencherSelectProfissionais();
      carregarAssistentes();
    }catch(e){
      console.error('Erro ao carregar profissionais:', e);
      const corpoEquipe = document.getElementById('profissionaisBody');
      if(corpoEquipe){
        corpoEquipe.innerHTML = '<tr><td colspan="7" class="text-center text-muted">Erro ao carregar profissionais</td></tr>';
      }
    }
  });
}
function pdfComissoes(di, df){
  openFile(`/api/profissionais/comissoes/pdf?data_inicio=${di||''}&data_fim=${df||''}`);
}
window.pdfComissoes = pdfComissoes;

function initSubtabs(containerId){
    const wrapper = document.getElementById(containerId);
    if(!wrapper) return;
    const links = wrapper.querySelectorAll('.subtabs-link');
    const panes = wrapper.querySelectorAll('.subtabs-pane');
    links.forEach(btn => {
        btn.addEventListener('click', () => {
            links.forEach(l => l.classList.remove('active'));
            panes.forEach(p => p.classList.remove('active'));
            btn.classList.add('active');
            const target = wrapper.querySelector(btn.dataset.target);
            if(target){ target.classList.add('active'); }
        });
    });
}

function showSubtab(containerId, targetSelector){
    const wrapper = document.getElementById(containerId);
    if(!wrapper) return;
    const links = wrapper.querySelectorAll('.subtabs-link');
    const panes = wrapper.querySelectorAll('.subtabs-pane');
    panes.forEach(p => p.classList.remove('active'));
    links.forEach(btn => btn.classList.toggle('active', btn.dataset.target === targetSelector));
    const target = wrapper.querySelector(targetSelector);
    if(target){ target.classList.add('active'); }
}

let graficoProfissional = null;
function renderGraficoProfissional(dataset){
    const canvas = document.getElementById('profDesempenhoChart');
    if(!canvas || !window.Chart){ return; }
    const ctx = canvas.getContext('2d');
    if(graficoProfissional){ graficoProfissional.destroy(); }
    graficoProfissional = new Chart(ctx,{
        type:'line',
        data:{
            labels: dataset.labels || [],
            datasets:[
                {label:'Comissão Profissional', data: dataset.comissao_profissional || [], borderColor:'#7C3AED', backgroundColor:'rgba(124,58,237,0.15)', tension:0.3},
                {label:'Comissão Assistente', data: dataset.comissao_assistente || [], borderColor:'#EC4899', backgroundColor:'rgba(236,72,153,0.15)', tension:0.3}
            ]
        },
        options:{
            responsive:true,
            maintainAspectRatio:false,
            scales:{ y:{ ticks:{ callback:value=>formatarMoeda(value||0) } } }
        }
    });
}

function preencherSelectProfissionais(){
    const options = profissionaisLista.map(p => `<option value="${p._id}">${p.nome}</option>`).join('');
    const multiSelect = document.getElementById('multiProfissionalSelect');
    if(multiSelect){ multiSelect.innerHTML = '<option value="">Todos</option>' + options; }
    const servicoSelect = document.getElementById('servicoProfissional');
    if(servicoSelect){ servicoSelect.innerHTML = '<option value="">Selecione</option>' + options; }
}

function filtrarProfissionais(){
    const termo = document.getElementById('buscaProfissionais')?.value || '';
    filtrarTabelaPorTermo('#profissionaisBody', termo.trim());
}

function filtrarServicosLista(){
    const termo = document.getElementById('buscaServicos')?.value || '';
    filtrarTabelaPorTermo('#servicosListBody', termo.trim());
}

function filtrarProdutosLista(){
    const termo = document.getElementById('buscaProdutos')?.value || '';
    filtrarTabelaPorTermo('#produtosListBody', termo.trim());
}

function limparResultadosBuscaGlobal(){
    const container = document.getElementById('globalSearchResults');
    if(container){
        container.classList.remove('active');
        container.innerHTML = '';
    }
}

function buscarGlobal(termo){
    termo = (termo || '').trim();
    if(buscaGlobalTimer){
        clearTimeout(buscaGlobalTimer);
    }
    if(termo.length < 2){
        limparResultadosBuscaGlobal();
        return;
    }
    buscaGlobalTimer = setTimeout(()=>executarBuscaGlobal(), 280);
}

async function executarBuscaGlobal(){
    const input = document.getElementById('globalSearchInput');
    if(!input){
        return;
    }
    const termo = input.value.trim();
    if(buscaGlobalTimer){
        clearTimeout(buscaGlobalTimer);
        buscaGlobalTimer = null;
    }
    if(termo.length < 2){
        limparResultadosBuscaGlobal();
        return;
    }
    try{
        const response = await fetch(`/api/busca/global?termo=${encodeURIComponent(termo)}`, {credentials:'include'});
        const data = await response.json();
        if(data.success){
            renderResultadosBuscaGlobal(data.resultados || {});
        }
    }catch(error){
        console.error('Erro na busca global', error);
    }
}

function renderResultadosBuscaGlobal(resultados){
    const container = document.getElementById('globalSearchResults');
    if(!container){
        return;
    }
    const categorias = [
        {chave:'clientes', titulo:'Clientes'},
        {chave:'profissionais', titulo:'Profissionais'},
        {chave:'servicos', titulo:'Serviços'},
        {chave:'produtos', titulo:'Produtos'},
        {chave:'orcamentos', titulo:'Contratos e Orçamentos'}
    ];
    let html = '';
    let total = 0;
    categorias.forEach(categoria => {
        const itens = resultados[categoria.chave] || [];
        if(itens.length){
            total += itens.length;
            const itensHtml = itens.map(item => `
                <div class="global-search-item" onclick="navegarResultadoGlobal('${categoria.chave}','${item.id}')">
                    <strong>${item.nome}</strong>
                    <span>${item.detalhe || ''}</span>
                </div>`).join('');
            html += `<div class="global-search-section"><h6>${categoria.titulo}</h6>${itensHtml}</div>`;
        }
    });
    if(total === 0){
        html = '<div class="text-muted" style="padding:12px;">Nenhum resultado encontrado</div>';
    }
    container.innerHTML = html;
    container.classList.add('active');
}

function navegarResultadoGlobal(tipo, id){
    limparResultadosBuscaGlobal();
    if(tipo === 'clientes'){
        goTo('clientes');
        setTimeout(()=>visualizarCliente(id), 250);
    }else if(tipo === 'profissionais'){
        goTo('profissionais');
        setTimeout(()=>destacarLinhaTabela('#profissionaisBody','id',id), 300);
    }else if(tipo === 'servicos'){
        goTo('servicos');
        setTimeout(()=>destacarLinhaTabela('#servicosListBody','id',id), 300);
    }else if(tipo === 'produtos'){
        goTo('produtos');
        setTimeout(()=>destacarLinhaTabela('#produtosListBody','id',id), 300);
    }else if(tipo === 'orcamentos'){
        goTo('consultar');
        setTimeout(()=>visualizarOrcamento(id), 350);
    }
}

function destacarLinhaTabela(tbodySelector, atributo, valor){
    const rows = document.querySelectorAll(`${tbodySelector} tr`);
    rows.forEach(row => {
        if(row.dataset[atributo] === valor){
            row.classList.add('highlight-row');
            row.scrollIntoView({behavior:'smooth', block:'center'});
            setTimeout(()=>row.classList.remove('highlight-row'), 2000);
        }
    });
}

async function ensureFormulariosCliente(){
    if(formulariosCliente){
        return formulariosCliente;
    }
    try{
        const resposta = await API.get('/api/clientes/formularios');
        if(resposta.success){
            formulariosCliente = {
                anamnese: Array.isArray(resposta.anamnese) ? resposta.anamnese : [],
                prontuario: Array.isArray(resposta.prontuario) ? resposta.prontuario : []
            };
        }else{
            formulariosCliente = { anamnese: [], prontuario: [] };
        }
    }catch(erro){
        console.error('Erro ao carregar formulários do cliente:', erro);
        formulariosCliente = { anamnese: [], prontuario: [] };
    }
    return formulariosCliente;
}

function slugCampo(campo=''){
    return campo.toString()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g,'')
        .replace(/[^a-zA-Z0-9]+/g,'-')
        .replace(/^-+|-+$/g,'')
        .toLowerCase();
}

function renderFormularioCliente(definicao=[], valores={}, prefixo='cliente'){
    if(!Array.isArray(definicao) || !definicao.length){
        return '<p class="text-muted mb-0">Formulário não configurado.</p>';
    }
    return definicao.map(item => {
        const campo = item.campo || 'Campo';
        const tipo = (item.tipo || 'text').toLowerCase();
        const slug = slugCampo(campo);
        const fieldId = `${prefixo}-${slug}`;
        const valorAtual = valores?.[campo] ?? '';
        const descricao = item.descricao ? `<small>${item.descricao}</small>` : '';

        if(tipo === 'select'){
            const opcoes = (item.opcoes || []).map(op => {
                const selected = String(valorAtual) === String(op) ? 'selected' : '';
                return `<option value="${op}" ${selected}>${op}</option>`;
            }).join('');
            return `<div class="formulario-cliente-field">
                <label class="form-label" for="${fieldId}">${campo}</label>
                <select class="form-select" id="${fieldId}">
                    <option value="">Selecione...</option>
                    ${opcoes}
                </select>
                ${descricao}
            </div>`;
        }
        if(tipo === 'radio'){
            const opcoes = (item.opcoes || []).map((op, idx) => {
                const checked = String(valorAtual) === String(op) ? 'checked' : '';
                const radioId = `${fieldId}-opt-${idx}`;
                return `<div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="${fieldId}" id="${radioId}" value="${op}" ${checked}>
                    <label class="form-check-label" for="${radioId}">${op}</label>
                </div>`;
            }).join('');
            return `<div class="formulario-cliente-field">
                <label class="form-label d-block">${campo}</label>
                <div>${opcoes}</div>
                ${descricao}
            </div>`;
        }
        if(tipo === 'textarea'){
            return `<div class="formulario-cliente-field">
                <label class="form-label" for="${fieldId}">${campo}</label>
                <textarea class="form-control" id="${fieldId}" rows="3">${valorAtual || ''}</textarea>
                ${descricao}
            </div>`;
        }
        const inputType = ['number','date','datetime-local','email','tel','text'].includes(tipo) ? tipo : 'text';
        return `<div class="formulario-cliente-field">
            <label class="form-label" for="${fieldId}">${campo}</label>
            <input class="form-control" type="${inputType}" id="${fieldId}" value="${valorAtual || ''}">
            ${descricao}
        </div>`;
    }).join('');
}

function coletarFormularioCliente(definicao=[], prefixo='cliente'){
    const resultado = {};
    if(!Array.isArray(definicao)){
        return resultado;
    }
    definicao.forEach(item => {
        const campo = item.campo || 'Campo';
        const slug = slugCampo(campo);
        const fieldId = `${prefixo}-${slug}`;
        const tipo = (item.tipo || 'text').toLowerCase();
        if(tipo === 'radio'){
            const selecionado = document.querySelector(`input[name="${fieldId}"]:checked`);
            resultado[campo] = selecionado ? selecionado.value : '';
        }else{
            const elemento = document.getElementById(fieldId);
            resultado[campo] = elemento ? elemento.value : '';
        }
    });
    return resultado;
}

async function loadClientes(){
    return safeCall('loadClientes', async () => {
        const tbody = document.getElementById('clientesBody');
        if(!tbody) return;
        try{
            const resposta = await API.get('/api/clientes');
            if(resposta.success && Array.isArray(resposta.clientes)){
                clientesLista = resposta.clientes;
                tbody.innerHTML = clientesLista.length ? clientesLista.map(cliente => {
                    return `<tr data-id="${cliente._id}">
                        <td><strong>${cliente.nome || '-'}</strong><div class="text-muted small">${cliente.email || ''}</div></td>
                        <td>${cliente.cpf || '-'}</td>
                        <td>${cliente.telefone || '-'}</td>
                        <td>${formatarMoeda(cliente.total_faturado || cliente.total_gasto || 0)}</td>
                        <td>${cliente.total_visitas || 0}</td>
                        <td class="text-nowrap">
                            <button class="btn btn-sm btn-info" onclick="mostrarDetalhesCliente('${cliente._id}')"><i class="bi bi-eye"></i></button>
                            <button class="btn btn-sm btn-danger" onclick="deleteCliente('${cliente._id}')"><i class="bi bi-trash"></i></button>
                        </td>
                    </tr>`;
                }).join('') : '<tr data-keep-visible="true"><td colspan="6" class="text-center text-muted">Nenhum cliente cadastrado</td></tr>';
            }else{
                clientesLista = [];
                tbody.innerHTML = '<tr data-keep-visible="true"><td colspan="6" class="text-center text-muted">Nenhum cliente cadastrado</td></tr>';
            }
        }catch(erro){
            console.error('Erro ao carregar clientes:', erro);
            tbody.innerHTML = '<tr data-keep-visible="true"><td colspan="6" class="text-center text-muted">Erro ao carregar clientes</td></tr>';
        }
    });
}

function filtrarClientes(){
    const termo = document.getElementById('buscaCliente')?.value || '';
    filtrarTabelaPorTermo('#clientesBody', termo.trim());
}

function formatarDataCurta(valor){
    if(!valor){
        return '-';
    }
    const data = new Date(valor);
    if(Number.isNaN(data.getTime())){
        return '-';
    }
    return data.toLocaleDateString('pt-BR', { day:'2-digit', month:'2-digit', year:'numeric' });
}

function formatarDataHora(valor){
    if(!valor){
        return '-';
    }
    const data = new Date(valor);
    if(Number.isNaN(data.getTime())){
        return '-';
    }
    return data.toLocaleString('pt-BR', { day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit' });
}

function renderClienteInfo(cliente){
    const container = document.getElementById('clienteInfoPane');
    if(!container) return;
    const totalFaturado = formatarMoeda(cliente.total_faturado || cliente.total_gasto || 0);
    const ultimaVisita = cliente.ultima_visita ? formatarDataCurta(cliente.ultima_visita) : 'Sem registros';
    container.innerHTML = `
        <div class="row g-3">
            <div class="col-md-4"><div class="cliente-stat-card"><span>Total faturado</span><h4>${totalFaturado}</h4></div></div>
            <div class="col-md-4"><div class="cliente-stat-card"><span>Visitas</span><h4>${cliente.total_visitas || 0}</h4></div></div>
            <div class="col-md-4"><div class="cliente-stat-card"><span>Última visita</span><h4>${ultimaVisita}</h4></div></div>
        </div>
        <div class="alert alert-info mt-3"><i class="bi bi-cash-coin"></i> Total faturado com este cliente = <strong>${totalFaturado}</strong></div>
        <div class="row g-3 mt-1">
            <div class="col-md-6"><label class="form-label" for="clienteNome">Nome</label><input class="form-control" id="clienteNome" value="${cliente.nome || ''}"></div>
            <div class="col-md-3"><label class="form-label" for="clienteCpf">CPF</label><input class="form-control" id="clienteCpf" value="${cliente.cpf || ''}"></div>
            <div class="col-md-3"><label class="form-label" for="clienteTelefone">Telefone</label><input class="form-control" id="clienteTelefone" value="${cliente.telefone || ''}"></div>
            <div class="col-md-4"><label class="form-label" for="clienteEmail">Email</label><input class="form-control" id="clienteEmail" value="${cliente.email || ''}"></div>
            <div class="col-md-4"><label class="form-label" for="clienteEndereco">Endereço</label><input class="form-control" id="clienteEndereco" value="${cliente.endereco || ''}"></div>
            <div class="col-md-4"><label class="form-label" for="clienteDataNascimento">Data de nascimento</label><input class="form-control" id="clienteDataNascimento" type="date" value="${cliente.data_nascimento || ''}"></div>
            <div class="col-md-4"><label class="form-label" for="clienteGenero">Gênero</label><input class="form-control" id="clienteGenero" value="${cliente.genero || ''}"></div>
            <div class="col-md-4"><label class="form-label" for="clienteEstadoCivil">Estado civil</label><input class="form-control" id="clienteEstadoCivil" value="${cliente.estado_civil || ''}"></div>
            <div class="col-md-4"><label class="form-label" for="clienteProfissao">Profissão</label><input class="form-control" id="clienteProfissao" value="${cliente.profissao || ''}"></div>
            <div class="col-md-4"><label class="form-label" for="clienteInstagram">Instagram</label><input class="form-control" id="clienteInstagram" value="${cliente.instagram || ''}"></div>
            <div class="col-md-4"><label class="form-label" for="clienteIndicacao">Indicação</label><input class="form-control" id="clienteIndicacao" value="${cliente.indicacao || ''}"></div>
            <div class="col-md-4"><label class="form-label" for="clientePreferencias">Preferências</label><input class="form-control" id="clientePreferencias" value="${cliente.preferencias || ''}"></div>
            <div class="col-md-4"><label class="form-label" for="clienteRestricoes">Restrições</label><input class="form-control" id="clienteRestricoes" value="${cliente.restricoes || ''}"></div>
            <div class="col-md-4"><label class="form-label" for="clienteTipoCabelo">Tipo de cabelo</label><input class="form-control" id="clienteTipoCabelo" value="${cliente.tipo_cabelo || ''}"></div>
            <div class="col-md-4"><label class="form-label" for="clienteHistorico">Histórico de tratamentos</label><input class="form-control" id="clienteHistorico" value="${cliente.historico_tratamentos || ''}"></div>
            <div class="col-md-12"><label class="form-label" for="clienteObservacoes">Observações</label><textarea class="form-control" id="clienteObservacoes" rows="3">${cliente.observacoes || ''}</textarea></div>
        </div>
    `;
}

async function mostrarDetalhesCliente(id){
    const overviewEmpty = document.getElementById('clienteOverviewEmpty');
    const overviewContent = document.getElementById('clienteOverviewContent');
    if(overviewEmpty && overviewContent){
        overviewEmpty.style.display = 'block';
        overviewContent.style.display = 'none';
    }
    try{
        const resposta = await API.get(`/api/clientes/${id}`);
        if(!resposta.success || !resposta.cliente){
            Swal.fire('Aviso','Cliente não encontrado','info');
            return;
        }
        clienteAtual = resposta.cliente;
        destacarLinhaTabela('#clientesBody','id',id);
        await ensureFormulariosCliente();

        if(overviewEmpty && overviewContent){
            overviewEmpty.style.display = 'none';
            overviewContent.style.display = 'block';
        }
        renderClienteInfo(clienteAtual);

        const { anamnese, prontuario } = formulariosCliente || {};
        const anamnesePane = document.getElementById('clienteAnamnesePane');
        if(anamnesePane){
            if(anamnese && anamnese.length){
                anamnesePane.classList.remove('text-muted');
                anamnesePane.innerHTML = `<div class="formulario-cliente-grid">${renderFormularioCliente(anamnese, clienteAtual.anamnese || {}, 'clienteAnamnese')}</div>`;
            }else{
                anamnesePane.classList.add('text-muted');
                anamnesePane.innerHTML = 'Formulário de anamnese não configurado.';
            }
        }
        const prontuarioPane = document.getElementById('clienteProntuarioPane');
        if(prontuarioPane){
            if(prontuario && prontuario.length){
                prontuarioPane.classList.remove('text-muted');
                prontuarioPane.innerHTML = `<div class="formulario-cliente-grid">${renderFormularioCliente(prontuario, clienteAtual.prontuario || {}, 'clienteProntuario')}</div>`;
            }else{
                prontuarioPane.classList.add('text-muted');
                prontuarioPane.innerHTML = 'Formulário de prontuário não configurado.';
            }
        }
        const historicoPane = document.getElementById('clienteHistoricoPane');
        if(historicoPane){
            const orcamentos = Array.isArray(clienteAtual.orcamentos) ? clienteAtual.orcamentos : [];
            if(!orcamentos.length){
                historicoPane.innerHTML = '<p class="text-muted mb-0">Nenhum atendimento encontrado para este cliente.</p>';
            }else{
                const linhas = orcamentos.map(orc => {
                    const data = orc.created_at ? formatarDataHora(orc.created_at) : '-';
                    const total = formatarMoeda(orc.total_final || orc.total || 0);
                    return `<tr>
                        <td>${orc.numero || '-'}</td>
                        <td>${data}</td>
                        <td><span class="badge ${orc.status === 'Aprovado' ? 'success' : (orc.status === 'Pendente' ? 'warning' : 'neutral')}">${orc.status || '-'}</span></td>
                        <td>${total}</td>
                        <td>${(orc.servicos || []).map(s => s.nome).join(', ') || '-'}</td>
                    </tr>`;
                }).join('');
                historicoPane.innerHTML = `<div class="table-responsive"><table><thead><tr><th>#</th><th>Data</th><th>Status</th><th>Total</th><th>Serviços</th></tr></thead><tbody>${linhas}</tbody></table></div>`;
            }
        }
        const salvarBtn = document.getElementById('clienteSalvarBtn');
        if(salvarBtn){
            salvarBtn.onclick = () => salvarClienteAtual();
        }
        const imprimirBtn = document.getElementById('clienteImprimirBtn');
        if(imprimirBtn){
            imprimirBtn.onclick = () => imprimirResumoCliente();
        }
    }catch(erro){
        console.error('Erro ao detalhar cliente:', erro);
        Swal.fire('Erro','Não foi possível carregar os detalhes do cliente.','error');
    }
}

async function loadServicosLista(){
    return safeCall('loadServicosLista', async () => {
        const tbody = document.getElementById('servicosListBody');
        if(!tbody) return;
        try{
            const resposta = await API.get('/api/servicos');
            if(resposta.success && Array.isArray(resposta.servicos) && resposta.servicos.length){
                servicosDisponiveis = resposta.servicos;
                tbody.innerHTML = resposta.servicos.map(servico => {
                    return `<tr data-id="${servico._id}">
                        <td><strong>${servico.nome}</strong><div class="text-muted small">${servico.categoria || '-'} • ${servico.tamanho || '-'}</div></td>
                        <td>${servico.tamanho || '-'}</td>
                        <td>${formatarMoeda(servico.preco || 0)}</td>
                        <td>${servico.categoria || '-'}</td>
                        <td class="text-nowrap">
                            <button class="btn btn-sm btn-primary" onclick="editarServico('${servico._id}')"><i class="bi bi-pencil"></i></button>
                            <button class="btn btn-sm btn-danger" onclick="deleteServico('${servico._id}')"><i class="bi bi-trash"></i></button>
                        </td>
                    </tr>`;
                }).join('');
            }else{
                servicosDisponiveis = [];
                tbody.innerHTML = '<tr data-keep-visible="true"><td colspan="5" class="text-center text-muted">Nenhum serviço cadastrado</td></tr>';
            }
        }catch(erro){
            console.error('Erro ao carregar serviços:', erro);
            tbody.innerHTML = '<tr data-keep-visible="true"><td colspan="5" class="text-center text-muted">Erro ao carregar serviços</td></tr>';
        }
    });
}

async function editarServico(id){
    try{
        const resposta = await fetch(`/api/servicos/${id}`,{credentials:'include'});
        const dados = await resposta.json();
        if(!dados.success || !dados.servico){
            Swal.fire('Erro','Serviço não encontrado','error');
            return;
        }
        const servico = dados.servico;
        const resultado = await Swal.fire({
            title:'Editar serviço',
            width:720,
            html:`<div class="text-start">
                    <label class="form-label">Nome</label>
                    <input class="form-control mb-2" id="edit-servico-nome" value="${servico.nome || ''}">
                    <label class="form-label">Categoria</label>
                    <input class="form-control mb-2" id="edit-servico-categoria" value="${servico.categoria || ''}">
                    <div class="row g-2">
                        <div class="col-md-6">
                            <label class="form-label">Tamanho</label>
                            <input class="form-control" id="edit-servico-tamanho" value="${servico.tamanho || ''}">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Duração (min)</label>
                            <input type="number" class="form-control" id="edit-servico-duracao" value="${servico.duracao || 60}">
                        </div>
                    </div>
                    <label class="form-label mt-2">Preço</label>
                    <input type="number" class="form-control" step="0.01" id="edit-servico-preco" value="${servico.preco || 0}">
                    <label class="form-label mt-2">Descrição</label>
                    <textarea class="form-control" id="edit-servico-descricao" rows="3">${servico.descricao || ''}</textarea>
                </div>`,
            showCancelButton:true,
            confirmButtonText:'Salvar',
            preConfirm:()=>{
                const nome = document.getElementById('edit-servico-nome').value.trim();
                if(!nome){
                    Swal.showValidationMessage('Informe o nome do serviço');
                    return false;
                }
                return {
                    nome,
                    categoria: document.getElementById('edit-servico-categoria').value.trim(),
                    tamanho: document.getElementById('edit-servico-tamanho').value.trim(),
                    duracao: Number(document.getElementById('edit-servico-duracao').value || 0),
                    preco: Number(document.getElementById('edit-servico-preco').value || 0),
                    descricao: document.getElementById('edit-servico-descricao').value.trim()
                };
            }
        });
        if(resultado.isConfirmed && resultado.value){
            const atualizar = await fetch(`/api/servicos/${id}`,{
                method:'PUT',
                headers:{'Content-Type':'application/json'},
                credentials:'include',
                body:JSON.stringify(resultado.value)
            });
            const retorno = await atualizar.json();
            if(retorno.success){
                Swal.fire('Sucesso','Serviço atualizado','success');
                await loadServicosLista();
            }else{
                Swal.fire('Erro', retorno.message || 'Não foi possível salvar o serviço.','error');
            }
        }
    }catch(erro){
        console.error('Erro ao editar serviço:', erro);
        Swal.fire('Erro','Falha ao editar serviço','error');
    }
}

async function deleteServico(id){
    const confirmar = await Swal.fire({title:'Remover serviço?',icon:'warning',showCancelButton:true,confirmButtonText:'Remover',cancelButtonText:'Cancelar'});
    if(!confirmar.isConfirmed) return;
    try{
        const resposta = await fetch(`/api/servicos/${id}`,{method:'DELETE',credentials:'include'});
        const dados = await resposta.json();
        if(dados.success){
            Swal.fire('Removido','Serviço excluído','success');
            await loadServicosLista();
        }else{
            Swal.fire('Erro','Não foi possível remover o serviço.','error');
        }
    }catch(erro){
        console.error('Erro ao remover serviço:', erro);
        Swal.fire('Erro','Falha ao remover serviço','error');
    }
}

async function loadProdutosLista(){
    return safeCall('loadProdutosLista', async () => {
        const tbody = document.getElementById('produtosListBody');
        if(!tbody) return;
        try{
            const resposta = await API.get('/api/produtos');
            if(resposta.success && Array.isArray(resposta.produtos) && resposta.produtos.length){
                produtosDisponiveis = resposta.produtos;
                produtosCache = resposta.produtos;
                tbody.innerHTML = resposta.produtos.map(produto => {
                    const estoqueCritico = produto.estoque !== undefined && produto.estoque_minimo !== undefined && produto.estoque <= produto.estoque_minimo;
                    return `<tr data-id="${produto._id}">
                        <td><strong>${produto.nome}</strong><div class="text-muted small">${produto.sku || '-'}</div></td>
                        <td>${produto.marca || '-'}</td>
                        <td>${formatarMoeda(produto.preco || 0)}</td>
                        <td><span class="badge ${estoqueCritico ? 'danger' : 'success'}">${produto.estoque ?? 0}</span></td>
                        <td class="text-nowrap">
                            <button class="btn btn-sm btn-primary" onclick="editarProduto('${produto._id}')"><i class="bi bi-pencil"></i></button>
                            <button class="btn btn-sm btn-danger" onclick="deleteProduto('${produto._id}')"><i class="bi bi-trash"></i></button>
                        </td>
                    </tr>`;
                }).join('');
            }else{
                tbody.innerHTML = '<tr data-keep-visible="true"><td colspan="5" class="text-center text-muted">Nenhum produto cadastrado</td></tr>';
            }
        }catch(erro){
            console.error('Erro ao carregar produtos:', erro);
            tbody.innerHTML = '<tr data-keep-visible="true"><td colspan="5" class="text-center text-muted">Erro ao carregar produtos</td></tr>';
        }
    });
}

async function editarProduto(id){
    try{
        const resposta = await fetch(`/api/produtos/${id}`,{credentials:'include'});
        const dados = await resposta.json();
        if(!dados.success || !dados.produto){
            Swal.fire('Erro','Produto não encontrado','error');
            return;
        }
        const produto = dados.produto;
        const resultado = await Swal.fire({
            title:'Editar produto',
            width:720,
            html:`<div class="text-start">
                    <label class="form-label">Nome</label>
                    <input class="form-control mb-2" id="edit-produto-nome" value="${produto.nome || ''}">
                    <div class="row g-2">
                        <div class="col-md-6">
                            <label class="form-label">Marca</label>
                            <input class="form-control" id="edit-produto-marca" value="${produto.marca || ''}">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Categoria</label>
                            <input class="form-control" id="edit-produto-categoria" value="${produto.categoria || ''}">
                        </div>
                    </div>
                    <label class="form-label mt-2">Preço de venda</label>
                    <input type="number" step="0.01" class="form-control" id="edit-produto-preco" value="${produto.preco || 0}">
                    <label class="form-label mt-2">Custo</label>
                    <input type="number" step="0.01" class="form-control" id="edit-produto-custo" value="${produto.custo || 0}">
                    <div class="row g-2 mt-2">
                        <div class="col-md-6">
                            <label class="form-label">Estoque</label>
                            <input type="number" class="form-control" id="edit-produto-estoque" value="${produto.estoque ?? 0}">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Estoque mínimo</label>
                            <input type="number" class="form-control" id="edit-produto-estoque-minimo" value="${produto.estoque_minimo ?? 0}">
                        </div>
                    </div>
                </div>`,
            showCancelButton:true,
            confirmButtonText:'Salvar',
            preConfirm:()=>{
                const nome = document.getElementById('edit-produto-nome').value.trim();
                if(!nome){
                    Swal.showValidationMessage('Informe o nome do produto');
                    return false;
                }
                return {
                    nome,
                    marca: document.getElementById('edit-produto-marca').value.trim(),
                    categoria: document.getElementById('edit-produto-categoria').value.trim(),
                    preco: Number(document.getElementById('edit-produto-preco').value || 0),
                    custo: Number(document.getElementById('edit-produto-custo').value || 0),
                    estoque: Number(document.getElementById('edit-produto-estoque').value || 0),
                    estoque_minimo: Number(document.getElementById('edit-produto-estoque-minimo').value || 0)
                };
            }
        });
        if(resultado.isConfirmed && resultado.value){
            const atualizar = await fetch(`/api/produtos/${id}`,{
                method:'PUT',
                headers:{'Content-Type':'application/json'},
                credentials:'include',
                body:JSON.stringify(resultado.value)
            });
            const retorno = await atualizar.json();
            if(retorno.success){
                Swal.fire('Sucesso','Produto atualizado','success');
                await loadProdutosLista();
            }else{
                Swal.fire('Erro', retorno.message || 'Não foi possível atualizar o produto.','error');
            }
        }
    }catch(erro){
        console.error('Erro ao editar produto:', erro);
        Swal.fire('Erro','Falha ao editar produto','error');
    }
}

async function deleteProduto(id){
    const confirmar = await Swal.fire({title:'Remover produto?',icon:'warning',showCancelButton:true,confirmButtonText:'Remover',cancelButtonText:'Cancelar'});
    if(!confirmar.isConfirmed) return;
    try{
        const resposta = await fetch(`/api/produtos/${id}`,{method:'DELETE',credentials:'include'});
        const dados = await resposta.json();
        if(dados.success){
            Swal.fire('Removido','Produto excluído','success');
            await loadProdutosLista();
        }else{
            Swal.fire('Erro','Não foi possível remover o produto.','error');
        }
    }catch(erro){
        console.error('Erro ao remover produto:', erro);
        Swal.fire('Erro','Falha ao remover produto','error');
    }
}

function formatarDescricaoMulticomissao(item){
async function salvarClienteAtual(){
    if(!clienteAtual){
        Swal.fire('Aviso','Selecione um cliente antes de salvar.','info');
        return;
    }
    const payload = {
        nome: document.getElementById('clienteNome')?.value.trim(),
        cpf: document.getElementById('clienteCpf')?.value.trim(),
        telefone: document.getElementById('clienteTelefone')?.value.trim(),
        email: document.getElementById('clienteEmail')?.value.trim(),
        endereco: document.getElementById('clienteEndereco')?.value.trim(),
        data_nascimento: document.getElementById('clienteDataNascimento')?.value,
        genero: document.getElementById('clienteGenero')?.value.trim(),
        estado_civil: document.getElementById('clienteEstadoCivil')?.value.trim(),
        profissao: document.getElementById('clienteProfissao')?.value.trim(),
        instagram: document.getElementById('clienteInstagram')?.value.trim(),
        indicacao: document.getElementById('clienteIndicacao')?.value.trim(),
        preferencias: document.getElementById('clientePreferencias')?.value.trim(),
        restricoes: document.getElementById('clienteRestricoes')?.value.trim(),
        tipo_cabelo: document.getElementById('clienteTipoCabelo')?.value.trim(),
        historico_tratamentos: document.getElementById('clienteHistorico')?.value.trim(),
        observacoes: document.getElementById('clienteObservacoes')?.value.trim(),
        anamnese: coletarFormularioCliente(formulariosCliente?.anamnese || [], 'clienteAnamnese'),
        prontuario: coletarFormularioCliente(formulariosCliente?.prontuario || [], 'clienteProntuario')
    };
    if(!payload.nome || !payload.cpf){
        Swal.fire('Aviso','Nome e CPF são obrigatórios.','info');
        return;
    }
    try{
        const res = await fetch(`/api/clientes/${clienteAtual._id}`,{
            method:'PUT',
            headers:{'Content-Type':'application/json'},
            credentials:'include',
            body:JSON.stringify(payload)
        });
        const data = await res.json();
        if(data.success){
            Swal.fire('Sucesso','Cliente atualizado com sucesso.','success');
            await loadClientes();
            await mostrarDetalhesCliente(clienteAtual._id);
        }else{
            Swal.fire('Erro', data.message || 'Não foi possível atualizar o cliente.','error');
        }
    }catch(erro){
        console.error('Erro ao salvar cliente:', erro);
        Swal.fire('Erro','Falha ao atualizar o cliente.','error');
    }
}

function imprimirResumoCliente(){
    if(!clienteAtual){
        Swal.fire('Aviso','Selecione um cliente para imprimir.','info');
        return;
    }
    const janela = window.open('', '_blank');
    if(!janela){
        Swal.fire('Aviso','Permita pop-ups para imprimir o resumo.','info');
        return;
    }
    const total = formatarMoeda(clienteAtual.total_faturado || clienteAtual.total_gasto || 0);
    const historico = Array.isArray(clienteAtual.orcamentos) ? clienteAtual.orcamentos : [];
    const linhasHistorico = historico.map(orc => `<tr>
        <td>${orc.numero || '-'}</td>
        <td>${orc.created_at ? formatarDataHora(orc.created_at) : '-'}</td>
        <td>${orc.status || '-'}</td>
        <td>${formatarMoeda(orc.total_final || orc.total || 0)}</td>
        <td>${(orc.servicos || []).map(s => s.nome).join(', ') || '-'}</td>
    </tr>`).join('');
    const estilos = `<style>
        body{font-family:Arial,sans-serif;padding:24px;color:#111}
        table{width:100%;border-collapse:collapse;margin-top:12px}
        th,td{border:1px solid #ccc;padding:8px;text-align:left}
        th{background:#f5f5f5}
        .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin-top:16px}
        .card{border:1px solid #ddd;border-radius:12px;padding:12px}
    </style>`;
    janela.document.write(`<!DOCTYPE html><html><head><meta charset="utf-8"><title>Resumo do Cliente</title>${estilos}</head><body>
        <h1>Resumo do Cliente</h1>
        <p><strong>Nome:</strong> ${clienteAtual.nome || '-'}</p>
        <p><strong>CPF:</strong> ${clienteAtual.cpf || '-'}</p>
        <div class="grid">
            <div class="card"><strong>Total faturado</strong><div>${total}</div></div>
            <div class="card"><strong>Visitas</strong><div>${clienteAtual.total_visitas || 0}</div></div>
            <div class="card"><strong>Última visita</strong><div>${clienteAtual.ultima_visita ? formatarDataCurta(clienteAtual.ultima_visita) : '-'}</div></div>
        </div>
        <h2>Anamnese</h2>
        <div class="grid">${Object.entries(clienteAtual.anamnese || {}).map(([campo, valor]) => `<div class="card"><strong>${campo}</strong><div>${valor || '-'}</div></div>`).join('')}</div>
        <h2>Prontuário</h2>
        <div class="grid">${Object.entries(clienteAtual.prontuario || {}).map(([campo, valor]) => `<div class="card"><strong>${campo}</strong><div>${valor || '-'}</div></div>`).join('')}</div>
        <h2>Histórico de orçamentos</h2>
        ${historico.length ? `<table><thead><tr><th>#</th><th>Data</th><th>Status</th><th>Total</th><th>Serviços</th></tr></thead><tbody>${linhasHistorico}</tbody></table>` : '<p>Nenhum histórico encontrado.</p>'}
        <script>window.onload=function(){window.print();}</script>
    </body></html>`);
    janela.document.close();
}

async function showModalCliente(){
    const resultado = await Swal.fire({
        title:'Novo cliente',
        width:720,
        html:`<div class="text-start">
                <label class="form-label">Nome</label>
                <input class="form-control mb-2" id="novo-cliente-nome" placeholder="Nome completo">
                <label class="form-label">CPF</label>
                <input class="form-control mb-2" id="novo-cliente-cpf" placeholder="Somente números">
                <div class="row g-2">
                    <div class="col-md-6">
                        <label class="form-label">Telefone</label>
                        <input class="form-control" id="novo-cliente-telefone" placeholder="(00) 00000-0000">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Email</label>
                        <input class="form-control" id="novo-cliente-email" placeholder="contato@cliente.com">
                    </div>
                </div>
                <label class="form-label mt-2">Endereço</label>
                <input class="form-control" id="novo-cliente-endereco" placeholder="Rua, número, bairro">
            </div>`,
        showCancelButton:true,
        confirmButtonText:'Salvar',
        preConfirm:()=>{
            const nome = document.getElementById('novo-cliente-nome').value.trim();
            const cpf = document.getElementById('novo-cliente-cpf').value.trim();
            if(!nome || !cpf){
                Swal.showValidationMessage('Informe o nome e o CPF');
                return false;
            }
            return {
                nome,
                cpf,
                telefone: document.getElementById('novo-cliente-telefone').value.trim(),
                email: document.getElementById('novo-cliente-email').value.trim(),
                endereco: document.getElementById('novo-cliente-endereco').value.trim()
            };
        }
    });
    if(resultado.isConfirmed && resultado.value){
        try{
            const res = await fetch('/api/clientes',{
                method:'POST',
                headers:{'Content-Type':'application/json'},
                credentials:'include',
                body:JSON.stringify(resultado.value)
            });
            const data = await res.json();
            if(data.success){
                Swal.fire('Sucesso','Cliente cadastrado','success');
                await loadClientes();
            }else{
                Swal.fire('Erro', data.message || 'Não foi possível salvar o cliente.','error');
            }
        }catch(erro){
            console.error('Erro ao criar cliente:', erro);
            Swal.fire('Erro','Falha ao cadastrar cliente','error');
        }
    }
}

async function deleteCliente(id){
    const confirmar = await Swal.fire({title:'Remover cliente?',icon:'warning',showCancelButton:true,confirmButtonText:'Remover',cancelButtonText:'Cancelar'});
    if(!confirmar.isConfirmed) return;
    try{
        const res = await fetch(`/api/clientes/${id}`,{method:'DELETE',credentials:'include'});
        const data = await res.json();
        if(data.success){
            Swal.fire('Removido','Cliente excluído com sucesso.','success');
            await loadClientes();
            if(clienteAtual && clienteAtual._id === id){
                clienteAtual = null;
                const overviewEmpty = document.getElementById('clienteOverviewEmpty');
                const overviewContent = document.getElementById('clienteOverviewContent');
                if(overviewEmpty && overviewContent){
                    overviewEmpty.style.display = 'block';
                    overviewContent.style.display = 'none';
                }
                const anamnesePane = document.getElementById('clienteAnamnesePane');
                if(anamnesePane){
                    anamnesePane.classList.add('text-muted');
                    anamnesePane.innerHTML = 'Selecione um cliente para carregar a anamnese.';
                }
                const prontuarioPane = document.getElementById('clienteProntuarioPane');
                if(prontuarioPane){
                    prontuarioPane.classList.add('text-muted');
                    prontuarioPane.innerHTML = 'Selecione um cliente para carregar o prontuário.';
                }
                const historicoPane = document.getElementById('clienteHistoricoPane');
                if(historicoPane){
                    historicoPane.innerHTML = 'Selecione um cliente para visualizar o histórico de orçamentos e atendimentos.';
                }
                const info = document.getElementById('clienteInfoPane');
                if(info) info.innerHTML = '';
            }
        }else{
            Swal.fire('Erro','Não foi possível remover o cliente.','error');
        }
    }catch(erro){
        console.error('Erro ao remover cliente:', erro);
        Swal.fire('Erro','Falha ao remover o cliente.','error');
    }
}

function formatarDescricaoMulticomissao(item){
    const partes = [];
    if(item.profissional_nome || item.servico){
        const prof = item.profissional_nome || 'Profissional';
        const servico = item.servico || 'Serviço';
        partes.push(`<strong>Profissional ${prof}</strong> – ${servico}`);
    }
    if(item.assistente && (item.assistente.assistente_nome || item.assistente.servico)){
        const assistenteNome = item.assistente.assistente_nome || 'Assistente';
        const assistenteServico = item.assistente.servico || 'Apoio';
        partes.push(`<span class="text-muted">Assistente ${assistenteNome} – ${assistenteServico}</span>`);
    }
    return partes.join('<br>');
}

async function carregarOrcamentosMulti(){
    try{
        const res = await fetch('/api/orcamentos',{credentials:'include'});
        const data = await res.json();
        if(data.success && Array.isArray(data.orcamentos)){
            orcamentosLista = data.orcamentos.filter(o => !o.status || o.status === 'Aprovado');
            const select = document.getElementById('multiOrcamentoSelect');
            if(select){
                select.innerHTML = '<option value="">Selecione</option>' + orcamentosLista.map(o =>
                    `<option value="${o._id}">#${o.numero} • ${o.cliente_nome}</option>`).join('');
            }
        }
    }catch(e){
        console.error('Erro ao carregar orçamentos:', e);
    }
}

async function executarMultiComissao(){
    const orcamentoId = document.getElementById('multiOrcamentoSelect')?.value;
    const profissionalId = document.getElementById('multiProfissionalSelect')?.value;
    if(!orcamentoId){
        Swal.fire('Aviso','Selecione um orçamento para calcular as comissões.','info');
        return;
    }
    try{
        const res = await fetch('/api/comissao/calcular',{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            credentials:'include',
            body:JSON.stringify({orcamento_id: orcamentoId})
        });
        const data = await res.json();
        if(!data.success){
            Swal.fire('Erro', data.message || 'Não foi possível calcular as comissões.','error');
            return;
        }
        const tbody = document.getElementById('multiComissaoTabela');
        const total = document.getElementById('multiComissaoTotal');
        const linhas = (data.comissoes || [])
            .filter(item => !profissionalId || item.profissional_id === profissionalId)
            .map(item => {
                const descricao = formatarDescricaoMulticomissao(item);
                const assistenteValor = item.assistente ? formatarMoeda(item.assistente.comissao_valor || 0) : '-';
                return `<tr>
                    <td>${descricao}</td>
                    <td>${formatarMoeda(item.valor_servico || 0)}</td>
                    <td>${formatarMoeda(item.comissao_valor || 0)}</td>
                    <td>${assistenteValor}</td>
                </tr>`;
            });
        if(tbody){
            tbody.innerHTML = linhas.length
                ? linhas.join('')
                : '<tr><td colspan="4" class="text-center text-muted">Nenhum lançamento para os filtros selecionados</td></tr>';
        }
        if(total){
            total.textContent = `Total de comissões: ${formatarMoeda(data.total_comissoes || 0)}`;
        }
    }catch(e){
        console.error('Erro no cálculo de comissão:', e);
        Swal.fire('Erro','Falha ao calcular comissões.','error');
    }
}

async function carregarAssistentes(){
    try{
        const res = await fetch('/api/assistentes',{credentials:'include'});
        const data = await res.json();
        if(data.success && Array.isArray(data.assistentes)){
            assistentesLista = data.assistentes;
            const tbody = document.getElementById('assistentesBody');
            if(tbody){
                tbody.innerHTML = assistentesLista.length
                    ? assistentesLista.map(a => `<tr data-id="${a._id}">
                        <td><strong>${a.nome}</strong><div class="text-muted">${a.cpf || ''}</div></td>
                        <td>${a.telefone || '-'}</td>
                        <td>
                            <button class="btn btn-sm btn-danger" onclick="removerAssistente('${a._id}')">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>`).join('')
                    : '<tr><td colspan="3" class="text-center text-muted">Nenhum assistente cadastrado</td></tr>';
            }
            preencherSelectAssistentes();
        }
    }catch(e){
        console.error('Erro ao carregar assistentes:', e);
    }
}

function preencherSelectAssistentes(){
    const selectServico = document.getElementById('servicoAssistente');
    if(selectServico){
        selectServico.innerHTML = '<option value="">Sem assistente</option>' + assistentesLista.map(a =>
            `<option value="${a._id}">${a.nome}</option>`).join('');
    }
    const modalSelect = document.getElementById('swal-assistente');
    if(modalSelect){
        modalSelect.innerHTML = '<option value="">Sem assistente</option>' + assistentesLista.map(a =>
            `<option value="${a._id}">${a.nome}</option>`).join('');
    }
}

async function salvarAssistente(){
    const nome = document.getElementById('assistenteNome')?.value.trim();
    if(!nome){
        Swal.fire('Aviso','Informe o nome do assistente.','info');
        return;
    }
    const payload = {
        nome,
        cpf: document.getElementById('assistenteCPF')?.value.trim() || '',
        telefone: document.getElementById('assistenteTelefone')?.value.trim() || ''
    };
    try{
        const res = await fetch('/api/assistentes',{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            credentials:'include',
            body:JSON.stringify(payload)
        });
        const data = await res.json();
        if(data.success){
            ['assistenteNome','assistenteCPF','assistenteTelefone'].forEach(id => {
                const input = document.getElementById(id);
                if(input) input.value = '';
            });
            carregarAssistentes();
            Swal.fire('Sucesso','Assistente cadastrado.','success');
        }else{
            Swal.fire('Erro', data.message || 'Não foi possível salvar o assistente.','error');
        }
    }catch(e){
        console.error('Erro ao salvar assistente:', e);
        Swal.fire('Erro','Falha ao salvar assistente.','error');
    }
}

async function removerAssistente(id){
    const confirmar = await Swal.fire({
        icon:'warning',
        title:'Remover assistente?',
        showCancelButton:true,
        confirmButtonText:'Remover',
        cancelButtonText:'Cancelar'
    });
    if(!confirmar.isConfirmed) return;
    try{
        const res = await fetch(`/api/assistentes/${id}`,{method:'DELETE',credentials:'include'});
        const data = await res.json();
        if(data.success){
            carregarAssistentes();
            loadProfissionais();
            Swal.fire('Removido','Assistente removido.','info');
        }else{
            Swal.fire('Erro','Não foi possível remover o assistente.','error');
        }
    }catch(e){
        console.error('Erro ao remover assistente:', e);
        Swal.fire('Erro','Falha ao remover assistente.','error');
    }
}

async function mostrarDetalhesProfissional(id){
    try{
        const res = await fetch(`/api/profissionais/${id}`,{credentials:'include'});
        const data = await res.json();
        if(!data.success || !data.profissional){
            Swal.fire('Aviso','Profissional não encontrado.','info');
            return;
        }
        const p = data.profissional;
        const container = document.getElementById('profDetalhesContainer');
        if(!container) return;

        const avatar = p.foto_url
            ? `<img src="${p.foto_url}" alt="${p.nome}" style="width:110px;height:110px;border-radius:20px;object-fit:cover;box-shadow:var(--shadow);">`
            : `<div style="width:110px;height:110px;border-radius:20px;background:var(--border-color);display:flex;align-items:center;justify-content:center;font-size:2rem;color:var(--text-secondary);"><i class="bi bi-person"></i></div>`;
        const assistenteNome = p.assistente && p.assistente.nome ? p.assistente.nome : 'Sem assistente';
        const estat = p.estatisticas || {};
        const desempenho = p.desempenho || {labels:[],comissao_profissional:[],comissao_assistente:[],servicos:[]};
        const multicomissao = Array.isArray(p.multicomissao) ? p.multicomissao : [];
        const avaliacoes = Array.isArray(p.avaliacoes) ? p.avaliacoes : [];

        container.innerHTML = `
            <div class="row g-4 align-items-start">
                <div class="col-lg-4">
                    <div class="d-flex flex-column align-items-center text-center gap-3">
                        ${avatar}
                        <div>
                            <h3 class="mb-1">${p.nome}</h3>
                            <div class="text-muted">${p.especialidade || 'Especialidade não informada'}</div>
                            <div class="mt-2">
                                <span class="badge ${p.ativo ? 'success' : 'danger'}">${p.ativo ? 'Ativo' : 'Inativo'}</span>
                            </div>
                        </div>
                    </div>
                    <div class="mt-4 text-start">
                        <p><strong>CPF:</strong> ${p.cpf || '-'}</p>
                        <p><strong>Telefone:</strong> ${p.telefone || '-'}</p>
                        <p><strong>Assistente:</strong> ${assistenteNome}</p>
                        <p><strong>Comissão padrão:</strong> ${Number(p.comissao_perc||0).toFixed(1)}%</p>
                        <p><strong>Comissão assistente:</strong> ${Number(p.comissao_assistente_perc||0).toFixed(1)}%</p>
                    </div>
                    <div class="d-grid gap-2 mt-3">
                        <button class="btn btn-primary" onclick="editarProfissional('${p._id}')"><i class="bi bi-pencil"></i> Editar profissional</button>
                    </div>
                </div>
                <div class="col-lg-8">
                    <div class="row g-3">
                        <div class="col-md-4"><div class="stat-card"><p>Total de Comissões</p><h3>${formatarMoeda(estat.total_comissao || 0)}</h3></div></div>
                        <div class="col-md-4"><div class="stat-card"><p>Comissão Assistente</p><h3>${formatarMoeda(estat.total_comissao_assistente || 0)}</h3></div></div>
                        <div class="col-md-4"><div class="stat-card"><p>Serviços realizados</p><h3>${estat.servicos_realizados || 0}</h3></div></div>
                    </div>
                    <div class="card mt-3">
                        <div class="card-body">
                            <canvas id="profDesempenhoChart" height="200"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card mt-4">
                <div class="card-header"><i class="bi bi-diagram-3"></i> Detalhamento de Comissões</div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table>
                            <thead><tr><th>Descrição</th><th>Valor Serviço</th><th>Profissional</th><th>Assistente</th></tr></thead>
                            <tbody>${multicomissao.length ? multicomissao.map(item => {
                                const descricao = formatarDescricaoMulticomissao(item);
                                const assistenteValor = item.assistente_nome ? formatarMoeda(item.comissao_assistente||0) : '-';
                                return `<tr><td>${descricao}</td><td>${formatarMoeda(item.valor_servico||0)}</td><td>${formatarMoeda(item.comissao_profissional||0)}</td><td>${assistenteValor}</td></tr>`;
                            }).join('') : '<tr><td colspan="4" class="text-center text-muted">Sem comissões registradas</td></tr>'}</tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="card mt-4">
                <div class="card-header"><i class="bi bi-chat-left-heart"></i> Últimas avaliações</div>
                <div class="card-body">
                    ${avaliacoes.length ? avaliacoes.map(av => `
                        <div class="border-bottom pb-2 mb-2">
                            <div class="d-flex justify-content-between align-items-center">
                                <strong>${av.autor || 'Cliente'}</strong>
                                <span class="badge success">${Number(av.nota||0).toFixed(1)}</span>
                            </div>
                            <div class="text-muted small">${new Date(av.created_at).toLocaleString('pt-BR')}</div>
                            <p class="mb-0">${av.comentario || ''}</p>
                        </div>`).join('') : '<p class="text-muted mb-0">Sem avaliações registradas.</p>'}
                </div>
            </div>
        `;
        renderGraficoProfissional(desempenho);
    }catch(e){
        console.error('Erro ao detalhar profissional:', e);
        Swal.fire('Erro','Não foi possível carregar os detalhes do profissional.','error');
    }
}

async function editarProfissional(id){
    try{
        const res = await fetch(`/api/profissionais/${id}`,{credentials:'include'});
        const data = await res.json();
        if(!data.success || !data.profissional){
            Swal.fire('Aviso','Profissional não encontrado','info');
            return;
        }
        const p = data.profissional;
        await carregarAssistentes();
        const assistOptions = '<option value="">Sem assistente</option>' + assistentesLista.map(a => `<option value="${a._id}" ${p.assistente && p.assistente._id === a._id ? 'selected' : ''}>${a.nome}</option>`).join('');
        const result = await Swal.fire({
            title:'Editar Profissional',
            width:720,
            html:`<div class="text-start">
                    <label class="form-label">Nome</label>
                    <input type="text" id="swal-nome" class="form-control mb-2" value="${p.nome || ''}">
                    <label class="form-label">CPF</label>
                    <input type="text" id="swal-cpf" class="form-control mb-2" value="${p.cpf || ''}">
                    <label class="form-label">Especialidade</label>
                    <input type="text" id="swal-espec" class="form-control mb-2" value="${p.especialidade || ''}">
                    <label class="form-label">Telefone</label>
                    <input type="text" id="swal-telefone" class="form-control mb-2" value="${p.telefone || ''}">
                    <div class="row g-2">
                        <div class="col-md-6">
                            <label class="form-label">Comissão (%)</label>
                            <input type="number" id="swal-comissao" class="form-control" value="${Number(p.comissao_perc||0).toFixed(1)}" min="0" step="0.5">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Comissão assistente (%)</label>
                            <input type="number" id="swal-comissao-assistente" class="form-control" value="${Number(p.comissao_assistente_perc||0).toFixed(1)}" min="0" step="0.5">
                        </div>
                    </div>
                    <label class="form-label mt-2">Assistente</label>
                    <select id="swal-assistente" class="form-select mb-2">${assistOptions}</select>
                    <label class="form-label">Foto</label>
                    <input type="file" id="swal-foto" class="form-control" accept="image/*">
                    <label class="form-label mt-2">Status</label>
                    <select id="swal-ativo" class="form-select">
                        <option value="true" ${p.ativo ? 'selected' : ''}>Ativo</option>
                        <option value="false" ${!p.ativo ? 'selected' : ''}>Inativo</option>
                    </select>
                </div>`,
            showCancelButton:true,
            confirmButtonText:'Salvar',
            preConfirm:()=>{
                const nome = document.getElementById('swal-nome').value.trim();
                const cpf = document.getElementById('swal-cpf').value.trim();
                if(!nome || !cpf){
                    Swal.showValidationMessage('Nome e CPF são obrigatórios');
                    return false;
                }
                return {
                    nome,
                    cpf,
                    telefone: document.getElementById('swal-telefone').value.trim(),
                    especialidade: document.getElementById('swal-espec').value.trim(),
                    comissao_perc: document.getElementById('swal-comissao').value,
                    comissao_assistente_perc: document.getElementById('swal-comissao-assistente').value,
                    assistente_id: document.getElementById('swal-assistente').value,
                    ativo: document.getElementById('swal-ativo').value === 'true'
                };
            }
        });
        if(result.isConfirmed && result.value){
            const payload = {...result.value};
            if(payload.assistente_id){
                payload.assistente_tipo = 'assistente';
            }else{
                payload.assistente_tipo = null;
            }
            const fotoFile = document.getElementById('swal-foto').files?.[0];
            if(fotoFile){
                try{
                    payload.foto_url = await uploadImagemBase64(fotoFile,'profissional');
                }catch(err){
                    console.error(err);
                    Swal.showValidationMessage('Falha ao enviar a imagem');
                    return;
                }
            }
            const resUp = await fetch(`/api/profissionais/${id}`,{
                method:'PUT',
                headers:{'Content-Type':'application/json'},
                credentials:'include',
                body:JSON.stringify(payload)
            });
            const upd = await resUp.json();
            if(upd.success){
                Swal.fire('Sucesso','Profissional atualizado','success');
                loadProfissionais();
                mostrarDetalhesProfissional(id);
            }else{
                Swal.fire('Erro', upd.message || 'Não foi possível atualizar','error');
            }
        }
    }catch(e){
        console.error('Erro ao editar profissional:', e);
        Swal.fire('Erro','Não foi possível carregar para edição.','error');
    }
}

async function showModalProfissional(){
    await carregarAssistentes();
    const assistOptions = '<option value="">Sem assistente</option>' + assistentesLista.map(a => `<option value="${a._id}">${a.nome}</option>`).join('');
    const result = await Swal.fire({
        title:'Novo Profissional',
        html:`<div class="text-start">
                <label class="form-label">Nome</label>
                <input type="text" id="swal-nome" class="form-control mb-2" placeholder="Nome">
                <label class="form-label">CPF</label>
                <input type="text" id="swal-cpf" class="form-control mb-2" placeholder="CPF">
                <label class="form-label">Especialidade</label>
                <input type="text" id="swal-espec" class="form-control mb-2" placeholder="Especialidade">
                <label class="form-label">Telefone</label>
                <input type="text" id="swal-telefone" class="form-control mb-2" placeholder="Telefone">
                <div class="row g-2">
                    <div class="col-md-6">
                        <label class="form-label">Comissão (%)</label>
                        <input type="number" id="swal-comissao" class="form-control" value="10" min="0" step="0.5">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Comissão assistente (%)</label>
                        <input type="number" id="swal-comissao-assistente" class="form-control" value="10" min="0" step="0.5">
                    </div>
                </div>
                <label class="form-label mt-2">Assistente</label>
                <select id="swal-assistente" class="form-select mb-2">${assistOptions}</select>
                <label class="form-label">Foto</label>
                <input type="file" id="swal-foto" class="form-control" accept="image/*">
            </div>`,
        showCancelButton:true,
        confirmButtonText:'Salvar',
        preConfirm:()=>{
            const nome = document.getElementById('swal-nome').value.trim();
            const cpf = document.getElementById('swal-cpf').value.trim();
            if(!nome || !cpf){
                Swal.showValidationMessage('Nome e CPF são obrigatórios');
                return false;
            }
            return {
                nome,
                cpf,
                telefone: document.getElementById('swal-telefone').value.trim(),
                especialidade: document.getElementById('swal-espec').value.trim(),
                comissao_perc: document.getElementById('swal-comissao').value,
                comissao_assistente_perc: document.getElementById('swal-comissao-assistente').value,
                assistente_id: document.getElementById('swal-assistente').value
            };
        }
    });
    if(result.isConfirmed && result.value){
        const payload = {...result.value};
        if(payload.assistente_id){
            payload.assistente_tipo = 'assistente';
        }else{
            delete payload.assistente_id;
            delete payload.assistente_tipo;
        }
        const fotoFile = document.getElementById('swal-foto').files?.[0];
        if(fotoFile){
            try{
                payload.foto_url = await uploadImagemBase64(fotoFile,'profissional');
            }catch(err){
                console.error(err);
                Swal.showValidationMessage('Falha ao enviar a imagem');
                return;
            }
        }
        try{
            const res = await fetch('/api/profissionais',{
                method:'POST',
                headers:{'Content-Type':'application/json'},
                credentials:'include',
                body:JSON.stringify(payload)
            });
            const data = await res.json();
            if(data.success){
                Swal.fire('Sucesso!','Profissional cadastrado','success');
                loadProfissionais();
            }else{
                Swal.fire('Erro', data.message || 'Não foi possível salvar','error');
            }
        }catch(e){
            console.error(e);
            Swal.fire('Erro','Não foi possível salvar','error');
        }
    }
}

async function deleteProfissional(id){
    const confirmar = await Swal.fire({title:'Remover profissional?',icon:'warning',showCancelButton:true});
    if(!confirmar.isConfirmed) return;
    try{
        const res = await fetch(`/api/profissionais/${id}`,{method:'DELETE',credentials:'include'});
        const data = await res.json();
        if(data.success){
            Swal.fire('Removido!','Profissional excluído com sucesso.','success');
            loadProfissionais();
        }else{
            Swal.fire('Erro','Não foi possível remover o profissional.','error');
        }
    }catch(e){
        console.error('Erro ao remover profissional:', e);
        Swal.fire('Erro','Falha ao remover profissional.','error');
    }
}

async function atualizarAlertasEstoqueCards(){
  const alertBox = document.querySelector('#alertasEstoque') || document.querySelector('#estoqueAlertas');
  if(!alertBox) return;
  try{
    const resposta = await API.get('/api/estoque/alerta');
    const itens = Array.isArray(resposta.produtos) ? resposta.produtos : [];
    if(!itens.length){
      alertBox.innerHTML = '<p class="text-center text-success">✅ Estoque equilibrado no momento</p>';
      return;
    }
    alertBox.innerHTML = itens.slice(0, 6).map(item => `
      <div class="community-pill">
        <i class="bi bi-exclamation-triangle-fill text-warning me-1"></i>
        ${item.nome || 'Produto'} • ${item.estoque ?? 0}/${item.estoque_minimo ?? 0}
      </div>`).join('');
  }catch(e){
    console.error("Erro ao carregar alertas de estoque:", e);
    alertBox.innerHTML = '<p class="text-center text-muted">Não foi possível carregar os alertas agora.</p>';
  }
}
async function loadEstoque(){
  return safeCall('loadEstoque', async () => {
    await Promise.all([
      loadEstoqueResumo(),
      loadEstoqueBaixo(),
      loadEstoquePendentes(),
      loadEstoqueMovimentos()
    ]);
    await atualizarAlertasEstoqueCards();
  });
}

// ===== Agendamentos =====
async function heatmapDias(dias=60){
  try{
    const res = await fetch('/api/agendamentos/mapa-calor?dias='+dias,{credentials:'include'});
    const data = await res.json();
    if(!data.success) return;
    const container = document.getElementById('heatmapDiasContainer');
    if(!container) return;
    const serie = data.mapa_calor || [];
    if(!serie.length){
      container.innerHTML = '<p class="text-muted">Sem dados suficientes para o período selecionado.</p>';
      return;
    }
    const maxTotal = Math.max(...serie.map(item => item.total || 0),1);
    const cells = serie.map(item => {
      const intensidade = (item.total || 0) / maxTotal;
      const cor = `rgba(124,58,237,${0.15 + intensidade*0.6})`;
      return `<div class="heat-cell" style="background:${cor}"><strong>${item.total}</strong><small>${new Date(item.data).toLocaleDateString('pt-BR')}</small><small>Ag: ${item.agendamentos||0} | Orç: ${item.orcamentos||0}</small></div>`;
    }).join('');
    container.innerHTML = `<div class="heat-grid">${cells}</div>`;
  }catch(e){
    console.error('Erro ao carregar mapa de calor:', e);
  }
}

async function disponibilidade(profId, dataISO){
  try{
    const r = await API.get(`/api/agendamentos/disponibilidade?profissional_id=${profId}&data=${dataISO}`);
    const box = document.querySelector('#agendaSlots'); if(!box) return;
    box.innerHTML = (r.slots||[]).map(s=>`<span class="community-pill" style="background:${s.status==='livre'?'#DCFCE7':'#fee2e2'};color:${s.status==='livre'?'#166534':'#991B1B'}">${s.hora} • ${s.status}</span>`).join('');
  }catch{}
}

// ===== Comunidade (SSE) =====
let sseInstance = null;
let sseReconnectAttempts = 0;
const MAX_SSE_RECONNECT = 3;

function startSSE(){
  // Evitar múltiplas instâncias do SSE
  if (sseInstance) {
    console.log('⏳ SSE já está ativo');
    return;
  }
  
  try{
    const ev = new EventSource('/api/stream');
    sseInstance = ev;
    
    ev.onopen = () => {
      console.log('✅ SSE conectado');
      sseReconnectAttempts = 0; // Reset contador de reconexão
    };
    
    ev.onerror = (error) => {
      console.error('❌ Erro no SSE:', error);
      ev.close();
      sseInstance = null;
      
      // Reconectar apenas se não exceder o limite
      if (sseReconnectAttempts < MAX_SSE_RECONNECT) {
        sseReconnectAttempts++;
        const delay = Math.min(1000 * Math.pow(2, sseReconnectAttempts), 30000); // Backoff exponencial
        console.log(`🔄 Tentando reconectar SSE em ${delay/1000}s (tentativa ${sseReconnectAttempts}/${MAX_SSE_RECONNECT})`);
        setTimeout(startSSE, delay);
      } else {
        console.log('⚠️ Limite de reconexões SSE atingido');
      }
    };
    
    ev.onmessage = (e)=>{
      let data = {}; try{ data = JSON.parse(e.data); }catch{}
      if(data.channel==='hello') return;
      const feed = document.querySelector('#feedCards') || document.querySelector('#feed');
      if(feed){ const card = document.createElement('div'); card.className='community-card'; card.innerHTML = `<h5>${data.channel||'evento'}</h5><pre style="white-space:pre-wrap">${JSON.stringify(data.payload,null,2)}</pre><small class="text-muted">${new Date().toLocaleString()}</small>`; feed.prepend(card); while(feed.children.length>50){ feed.removeChild(feed.lastChild);} }
      if(data.channel==='estoque'){ loadEstoque(); }
      if(data.channel==='profissionais'){ loadProfissionais(); }
    };
  }catch(e){
    console.error('❌ Falha ao iniciar SSE:', e);
    sseInstance = null;
  }
}

// ===== Sistema / Config =====
async function loadSystem(){
  try{
    const r = await API.get('/api/system/status');
    const el = document.querySelector('#sistemaStatus'); if(!el) return;
    el.innerHTML = `
      <div class="row g-4">
        <div class="col-md-4"><div class="stat-card"><div class="icon"><i class="bi bi-database-check"></i></div><h3>${r.status.mongodb.operational?'OK':'OFF'}</h3><p>MongoDB</p></div></div>
        <div class="col-md-4"><div class="stat-card"><div class="icon"><i class="bi bi-envelope-check"></i></div><h3>${r.status.mailersend.operational?'OK':'OFF'}</h3><p>MailerSend</p></div></div>
        <div class="col-md-4"><div class="stat-card"><div class="icon"><i class="bi bi-hdd-network"></i></div><h3>${r.status.server.version}</h3><p>Versão</p></div></div>
      </div>`;
  }catch{}
}
async function uploadLogo(inputSel='#logoArquivo'){
  const f = document.querySelector(inputSel)?.files?.[0]; if(!f) return toast('Selecione um arquivo','warning');
  const fd = new FormData(); fd.append('file', f);
  try{
    const up = await API.upload('/api/upload/imagem', fd);
    const filename = up.filename || up.name || up.id || up.path || up.url?.split('/').pop();
    const logo_url = up.url || '/api/imagem/'+filename;
    await API.post('/api/config', { logo_url });
    if(document.querySelector('#authLogoCustom')){ document.querySelector('#authLogoCustom').src = logo_url; document.querySelector('#authLogoCustom').style.display='block'; }
    toast('Logo atualizado','success');
  }catch{ toast('Falha no upload','error'); }
}
window.uploadLogo = uploadLogo;

// ===== Init =====
let appInitialized = false;

async function initApp(user=null){
  // Evitar múltiplas inicializações
  if (appInitialized) {
    console.log('⏳ App já foi inicializado');
    return;
  }
  appInitialized = true;
  
  console.log('🚀 Inicializando aplicativo...');
  document.querySelector('#authScreen').style.display='none';
  document.querySelector('#app').style.display='block';
  
  try{ 
    const cu = await API.get('/api/current-user'); 
    const theme = (cu.success && cu.user && cu.user.theme) ? cu.user.theme : 'light'; 
    document.documentElement.setAttribute('data-theme', theme);
  }catch(e){
    console.error('Erro ao carregar tema:', e);
  }
  
  // Executar loads de forma não-bloqueante para evitar travamento
  // Cada função tem seu próprio safeCall internamente
  Promise.allSettled([
    loadDashboard(),
    loadClientes(),
    loadProfissionais(),
    loadEstoque(),
    loadSystem()
  ]).then(() => {
    console.log('✅ Carregamento inicial completo');
  });
  
  // Iniciar features que não dependem de dados
  bindAutocompletes();
  heatmapDias(60);
  startSSE();
}

(async function boot(){
  try{
    const cu = await API.get('/api/current-user');
    if(cu.success){ 
      initApp(cu.user); 
    } else { 
      document.querySelector('#authScreen').style.display='flex'; 
      document.querySelector('#app').style.display='none'; 
    }
  }catch(e){ 
    console.error('Erro no boot:', e);
    document.querySelector('#authScreen').style.display='flex'; 
    document.querySelector('#app').style.display='none'; 
  }
})();
</script>

</body>
</html>
