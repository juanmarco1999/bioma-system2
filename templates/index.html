<!DOCTYPE html>
<html lang="pt-BR" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>BIOMA Uberaba v3.1 - Sistema Completo</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>🌳</text></svg>">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        :root[data-theme="light"] {
            --primary: #7C3AED;
            --primary-dark: #6D28D9;
            --secondary: #EC4899;
            --success: #10B981;
            --danger: #EF4444;
            --warning: #F59E0B;
            --info: #3B82F6;
            --bg-main: #F9FAFB;
            --bg-card: #FFFFFF;
            --bg-sidebar: #1F2937;
            --text-primary: #1F2937;
            --text-secondary: #6B7280;
            --border-color: #E5E7EB;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }

        :root[data-theme="dark"] {
            --primary: #8B5CF6;
            --primary-dark: #7C3AED;
            --secondary: #F472B6;
            --success: #34D399;
            --danger: #F87171;
            --warning: #FBBF24;
            --info: #60A5FA;
            --bg-main: #0F172A;
            --bg-card: #1E293B;
            --bg-sidebar: #0F172A;
            --text-primary: #F1F5F9;
            --text-secondary: #CBD5E1;
            --border-color: #334155;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-main);
            color: var(--text-primary);
            overflow-x: hidden;
        }

        /* AUTH SCREEN */
        .auth-screen {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
        }

        .auth-box {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            border-radius: 30px;
            padding: 50px;
            max-width: 500px;
            width: 100%;
            box-shadow: 0 30px 80px rgba(0, 0, 0, 0.4);
        }

        .auth-logo {
            text-align: center;
            margin-bottom: 40px;
        }

        .auth-logo .logo-icon {
            font-size: 5rem;
        }

        .auth-logo h2 {
            font-weight: 900;
            font-size: 2.8rem;
            color: #1F2937;
            margin-top: 20px;
        }

        .nav-pills .nav-link {
            border-radius: 15px;
            font-weight: 700;
            padding: 12px 25px;
            color: #6B7280;
        }

        .nav-pills .nav-link.active {
            background: linear-gradient(135deg, #7C3AED, #6D28D9);
            box-shadow: 0 5px 20px rgba(124, 58, 237, 0.4);
        }

        .form-control, .form-select {
            border-radius: 12px;
            border: 2px solid #E5E7EB;
            padding: 12px 18px;
            font-size: 1rem;
        }

        .form-control:focus, .form-select:focus {
            border-color: #7C3AED;
            box-shadow: 0 0 0 5px rgba(124, 58, 237, 0.1);
            outline: none;
        }

        .btn {
            border-radius: 12px;
            padding: 12px 30px;
            font-weight: 700;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            font-size: 1rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: #fff;
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(124, 58, 237, 0.5);
            color: #fff;
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success), #059669);
            color: #fff;
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger), #DC2626);
            color: #fff;
        }

        .btn-outline {
            background: transparent;
            color: var(--primary);
            border: 3px solid var(--primary);
        }

        .btn-secondary {
            background: #6B7280;
            color: #fff;
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 0.85rem;
        }

        /* APP LAYOUT */
        #app {
            display: none;
        }

        .sidebar {
            width: 280px;
            background: var(--bg-sidebar);
            color: #fff;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 4px 0 25px rgba(0, 0, 0, 0.2);
        }

        .sidebar-logo {
            padding: 30px 20px;
            text-align: center;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
        }

        .sidebar-logo h1 {
            font-size: 2.5rem;
            font-weight: 900;
            margin: 0;
        }

        .sidebar-menu {
            list-style: none;
            padding: 20px 0;
        }

        .sidebar-menu li a {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 20px;
            color: rgba(255, 255, 255, 0.85);
            text-decoration: none;
            transition: all 0.3s;
            border-left: 5px solid transparent;
        }

        .sidebar-menu li a:hover,
        .sidebar-menu li a.active {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            border-left-color: var(--primary);
        }

        .main-content {
            margin-left: 280px;
            padding: 30px 40px;
            min-height: 100vh;
            max-height: 100vh;
            overflow-y: auto;
        }

        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
        }

        .page-header {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .page-header h1 {
            font-size: 2.2rem;
            font-weight: 900;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .card {
            background: var(--bg-card);
            border-radius: 20px;
            box-shadow: var(--shadow);
            margin-bottom: 30px;
            border: 2px solid var(--border-color);
        }

        .card-header {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: #fff;
            padding: 20px 30px;
            font-weight: 800;
            font-size: 1.2rem;
            border-radius: 18px 18px 0 0;
        }

        .card-body {
            padding: 30px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        table thead th {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: #fff;
            padding: 16px 14px;
            text-align: left;
            font-weight: 800;
        }

        table tbody tr {
            border-bottom: 2px solid var(--border-color);
        }

        table tbody td {
            padding: 16px 14px;
            color: var(--text-primary);
        }

        .badge {
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 800;
            font-size: 0.8rem;
            display: inline-block;
        }

        .badge.success {
            background: var(--success);
            color: #fff;
        }

        .badge.warning {
            background: var(--warning);
            color: #000;
        }

        .badge.danger {
            background: var(--danger);
            color: #fff;
        }

        .stat-card {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 30px;
            box-shadow: var(--shadow);
            text-align: center;
            border: 2px solid var(--border-color);
        }

        .stat-card .icon {
            width: 70px;
            height: 70px;
            border-radius: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            margin: 0 auto 15px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: #fff;
        }

        .stat-card h3 {
            font-size: 3rem;
            font-weight: 900;
            margin: 15px 0 10px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .text-center { text-align: center; }
        .text-muted { color: var(--text-secondary); }
        .text-danger { color: var(--danger); }
        .text-success { color: var(--success); }
        .w-100 { width: 100%; }
        .mt-3 { margin-top: 1rem; }
        .mb-3 { margin-bottom: 1rem; }
        .mb-4 { margin-bottom: 1.5rem; }

        .row { display: flex; flex-wrap: wrap; margin: 0 -15px; }
        .row > * { padding: 0 15px; margin-bottom: 25px; }
        .col-12 { width: 100%; }
        .col-md-6 { width: 50%; }
        .col-md-4 { width: 33.333%; }
        .col-lg-3 { width: 25%; }

        @media (max-width: 768px) {
            .col-md-6, .col-md-4, .col-lg-3 { width: 100%; }
        }

        .alert {
            padding: 15px 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .alert-info {
            background: linear-gradient(135deg, #E0E7FF, #DBEAFE);
            color: #1E40AF;
            border-left: 5px solid #3B82F6;
        }
    </style>
</head>
<body>

<!-- AUTH SCREEN -->
<div id="authScreen" class="auth-screen">
    <div class="auth-box">
        <div class="auth-logo">
            <div class="logo-icon">🌳</div>
            <h2>BIOMA</h2>
            <p>Uberaba - v3.1</p>
        </div>

        <ul class="nav nav-pills nav-fill mb-4">
            <li class="nav-item">
                <button class="nav-link active" id="loginTab" onclick="switchTab('login')">
                    <i class="bi bi-box-arrow-in-right"></i> Login
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="registerTab" onclick="switchTab('register')">
                    <i class="bi bi-person-plus"></i> Cadastro
                </button>
            </li>
        </ul>

        <div id="loginForm">
            <form onsubmit="return handleLogin(event)">
                <div class="mb-3">
                    <label>Usuário ou E-mail</label>
                    <input type="text" class="form-control" id="loginUsername" required>
                </div>
                <div class="mb-3">
                    <label>Senha</label>
                    <input type="password" class="form-control" id="loginPassword" required>
                </div>
                <div class="alert alert-info">
                    <strong>🔑 Acesso Padrão:</strong><br>
                    Usuário: <code>admin</code><br>
                    Senha: <code>admin123</code>
                </div>
                <button type="submit" class="btn btn-primary w-100">
                    <i class="bi bi-box-arrow-in-right"></i> Entrar
                </button>
            </form>
        </div>

        <div id="registerForm" style="display:none;">
            <form onsubmit="return handleRegister(event)">
                <div class="mb-3">
                    <label>Nome Completo</label>
                    <input type="text" class="form-control" id="registerName" required>
                </div>
                <div class="mb-3">
                    <label>Usuário</label>
                    <input type="text" class="form-control" id="registerUsername" required>
                </div>
                <div class="mb-3">
                    <label>E-mail</label>
                    <input type="email" class="form-control" id="registerEmail" required>
                </div>
                <div class="mb-3">
                    <label>Telefone (opcional)</label>
                    <input type="text" class="form-control" id="registerTelefone" placeholder="(34) 99999-9999">
                </div>
                <div class="mb-3">
                    <label>Senha</label>
                    <input type="password" class="form-control" id="registerPassword" required minlength="6">
                </div>
                <button type="submit" class="btn btn-primary w-100">
                    <i class="bi bi-person-plus"></i> Criar Conta
                </button>
            </form>
        </div>

        <div id="verifyForm" style="display:none;">
            <div class="alert alert-info">
                <strong>📧 Verificação Necessária</strong><br>
                Digite o código de 6 dígitos enviado para seu email/SMS.
            </div>
            <form onsubmit="return handleVerify(event)">
                <input type="hidden" id="verifyUsername">
                <div class="mb-3">
                    <label>Código de Verificação</label>
                    <input type="text" class="form-control text-center" id="verifyCode" maxlength="6" required style="font-size: 2rem; letter-spacing: 10px;">
                </div>
                <button type="submit" class="btn btn-primary w-100">
                    <i class="bi bi-check-circle"></i> Verificar
                </button>
                <button type="button" class="btn btn-secondary w-100 mt-3" onclick="switchTab('login')">
                    Voltar ao Login
                </button>
            </form>
        </div>
    </div>
</div>

<!-- APP -->
<div id="app">
    <nav class="sidebar">
        <div class="sidebar-logo">
            <h1>BIOMA</h1>
            <p>Uberaba v3.1</p>
        </div>

        <ul class="sidebar-menu">
            <li><a href="#" onclick="goTo('dashboard')" class="active" id="menu-dashboard">
                <i class="bi bi-speedometer2"></i> Dashboard
            </a></li>
            <li><a href="#" onclick="goTo('orcamento')" id="menu-orcamento">
                <i class="bi bi-file-earmark-text"></i> Novo Orçamento
            </a></li>
            <li><a href="#" onclick="goTo('consultar')" id="menu-consultar">
                <i class="bi bi-search"></i> Consultar
            </a></li>
            <li><a href="#" onclick="goTo('clientes')" id="menu-clientes">
                <i class="bi bi-people"></i> Clientes
            </a></li>
            <li><a href="#" onclick="goTo('profissionais')" id="menu-profissionais">
                <i class="bi bi-person-workspace"></i> Profissionais
            </a></li>
            <li><a href="#" onclick="goTo('servicos')" id="menu-servicos">
                <i class="bi bi-scissors"></i> Serviços
            </a></li>
            <li><a href="#" onclick="goTo('produtos')" id="menu-produtos">
                <i class="bi bi-box-seam"></i> Produtos
            </a></li>
            <li><a href="#" onclick="goTo('importar')" id="menu-importar">
                <i class="bi bi-cloud-upload"></i> Importar
            </a></li>
            <li><a href="#" onclick="goTo('sistema')" id="menu-sistema">
                <i class="bi bi-activity"></i> Status
            </a></li>
            <li><a href="#" onclick="doLogout()">
                <i class="bi bi-box-arrow-right"></i> Sair
            </a></li>
        </ul>
    </nav>

    <div class="main-content">
        
        <!-- DASHBOARD -->
        <div id="section-dashboard" class="content-section active">
            <div class="page-header">
                <h1><i class="bi bi-speedometer2"></i> Dashboard</h1>
            </div>

            <div class="row">
                <div class="col-lg-3 col-md-6">
                    <div class="stat-card">
                        <div class="icon"><i class="bi bi-file-earmark-text"></i></div>
                        <h3 id="dashOrcamentos">0</h3>
                        <p>Orçamentos</p>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6">
                    <div class="stat-card">
                        <div class="icon"><i class="bi bi-people"></i></div>
                        <h3 id="dashClientes">0</h3>
                        <p>Clientes</p>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6">
                    <div class="stat-card">
                        <div class="icon"><i class="bi bi-scissors"></i></div>
                        <h3 id="dashServicos">0</h3>
                        <p>Serviços</p>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6">
                    <div class="stat-card">
                        <div class="icon"><i class="bi bi-currency-dollar"></i></div>
                        <h3 id="dashFaturamento">R$ 0</h3>
                        <p>Faturamento</p>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <i class="bi bi-clock-history"></i> Últimos Orçamentos
                </div>
                <div class="card-body">
                    <table>
                        <thead>
                            <tr>
                                <th>Nº</th>
                                <th>Data</th>
                                <th>Cliente</th>
                                <th>Valor</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="ultimosOrcamentosBody">
                            <tr><td colspan="5" class="text-center text-muted">Carregando...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- NOVO ORÇAMENTO -->
        <div id="section-orcamento" class="content-section">
            <div class="page-header">
                <h1><i class="bi bi-file-earmark-plus"></i> Novo Orçamento</h1>
            </div>

            <div class="card">
                <div class="card-header">
                    <i class="bi bi-person-badge"></i> Cliente
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label>CPF *</label>
                                <input type="text" class="form-control" id="orcCPF" maxlength="14" onkeyup="buscarClientePorCPF()">
                                <div id="cpfResults" style="position:relative; display:none;"></div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label>Nome *</label>
                                <input type="text" class="form-control" id="orcNomeCliente">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label>Email</label>
                                <input type="email" class="form-control" id="orcEmail">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label>Telefone</label>
                                <input type="text" class="form-control" id="orcTelefone">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <i class="bi bi-scissors"></i> Serviços
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label>Buscar</label>
                                <input type="text" class="form-control" id="buscaServico" onkeyup="buscarServicos()">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label>Tamanho</label>
                                <select class="form-select" id="servicoTamanho">
                                    <option value="">Selecione...</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="mb-3">
                                <label>Qtd</label>
                                <input type="number" class="form-control" id="servicoQtd" value="1" min="1">
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="mb-3">
                                <label>Preço</label>
                                <input type="number" class="form-control" id="servicoPreco" step="0.01">
                            </div>
                        </div>
                        <div class="col-md-1">
                            <div class="mb-3">
                                <label>&nbsp;</label>
                                <button class="btn btn-primary w-100" onclick="addServico()">
                                    <i class="bi bi-plus"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Serviço</th>
                                <th>Tamanho</th>
                                <th>Qtd</th>
                                <th>Preço</th>
                                <th>Total</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="servicosBody">
                            <tr><td colspan="6" class="text-center text-muted">Nenhum serviço</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <i class="bi bi-calculator"></i> Total
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label>Desconto %</label>
                                <input type="number" class="form-control" id="descontoGlobal" value="0" min="0" max="100" onchange="calcularTotais()">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label>Pagamento</label>
                                <select class="form-select" id="pagamento">
                                    <option>Pix</option>
                                    <option>Débito</option>
                                    <option>Crédito</option>
                                    <option>Dinheiro</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label>TOTAL</label>
                                <h2 id="totalFinal" style="color: var(--primary);">R$ 0,00</h2>
                            </div>
                        </div>
                    </div>
                    <div class="text-center">
                        <button class="btn btn-secondary" onclick="cancelarOrc()">Cancelar</button>
                        <button class="btn btn-primary" onclick="salvarOrc('Pendente')">Salvar</button>
                        <button class="btn btn-success" onclick="salvarOrc('Aprovado')">Aprovar</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- CONSULTAR -->
        <div id="section-consultar" class="content-section">
            <div class="page-header">
                <h1><i class="bi bi-search"></i> Consultar</h1>
            </div>
            <div class="card">
                <div class="card-header">Orçamentos</div>
                <div class="card-body">
                    <table>
                        <thead>
                            <tr>
                                <th>Nº</th>
                                <th>Data</th>
                                <th>Cliente</th>
                                <th>Total</th>
                                <th>Status</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="consultaBody">
                            <tr><td colspan="6" class="text-center text-muted">Carregando...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- CLIENTES -->
        <div id="section-clientes" class="content-section">
            <div class="page-header">
                <h1><i class="bi bi-people"></i> Clientes</h1>
                <button class="btn btn-primary" onclick="showModalCliente()">
                    <i class="bi bi-person-plus"></i> Novo
                </button>
            </div>
            <div class="card">
                <div class="card-header">Lista</div>
                <div class="card-body">
                    <table>
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>CPF</th>
                                <th>Telefone</th>
                                <th>Total Gasto</th>
                                <th>Visitas</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="clientesBody">
                            <tr><td colspan="6" class="text-center text-muted">Carregando...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- PROFISSIONAIS -->
        <div id="section-profissionais" class="content-section">
            <div class="page-header">
                <h1><i class="bi bi-person-workspace"></i> Profissionais</h1>
                <button class="btn btn-primary" onclick="showModalProfissional()">
                    <i class="bi bi-person-plus"></i> Novo
                </button>
            </div>
            <div class="card">
                <div class="card-header">Equipe</div>
                <div class="card-body">
                    <table>
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>CPF</th>
                                <th>Especialidade</th>
                                <th>Comissão</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="profissionaisBody">
                            <tr><td colspan="5" class="text-center text-muted">Carregando...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- SERVIÇOS -->
        <div id="section-servicos" class="content-section">
            <div class="page-header">
                <h1><i class="bi bi-scissors"></i> Serviços</h1>
                <button class="btn btn-primary" onclick="showModalServico()">
                    <i class="bi bi-plus-circle"></i> Novo
                </button>
            </div>
            <div class="card">
                <div class="card-header">Catálogo</div>
                <div class="card-body">
                    <table>
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Tamanho</th>
                                <th>Preço</th>
                                <th>Categoria</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="servicosListBody">
                            <tr><td colspan="5" class="text-center text-muted">Carregando...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- PRODUTOS -->
        <div id="section-produtos" class="content-section">
            <div class="page-header">
                <h1><i class="bi bi-box-seam"></i> Produtos</h1>
                <button class="btn btn-primary" onclick="showModalProduto()">
                    <i class="bi bi-plus-circle"></i> Novo
                </button>
            </div>
            <div class="card">
                <div class="card-header">Estoque</div>
                <div class="card-body">
                    <table>
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Marca</th>
                                <th>SKU</th>
                                <th>Preço</th>
                                <th>Estoque</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="produtosListBody">
                            <tr><td colspan="6" class="text-center text-muted">Carregando...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- IMPORTAR -->
        <div id="section-importar" class="content-section">
            <div class="page-header">
                <h1><i class="bi bi-cloud-upload"></i> Importar</h1>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">Produtos</div>
                        <div class="card-body text-center">
                            <input type="file" id="uploadProdutos" accept=".csv,.xlsx" style="display:none;" onchange="handleUpload(this, 'produtos')">
                            <button class="btn btn-primary" onclick="document.getElementById('uploadProdutos').click()">
                                <i class="bi bi-cloud-upload"></i> Selecionar CSV/XLSX
                            </button>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">Serviços</div>
                        <div class="card-body text-center">
                            <input type="file" id="uploadServicos" accept=".csv,.xlsx" style="display:none;" onchange="handleUpload(this, 'servicos')">
                            <button class="btn btn-primary" onclick="document.getElementById('uploadServicos').click()">
                                <i class="bi bi-cloud-upload"></i> Selecionar CSV/XLSX
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- STATUS -->
        <div id="section-sistema" class="content-section">
            <div class="page-header">
                <h1><i class="bi bi-activity"></i> Status</h1>
                <button class="btn btn-outline" onclick="verificarStatus()">
                    <i class="bi bi-arrow-clockwise"></i> Atualizar
                </button>
            </div>

            <div class="row">
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">MongoDB</div>
                        <div class="card-body text-center">
                            <div id="mongoStatus" class="badge success">Online</div>
                            <p class="mt-3" id="mongoMessage">Conectado</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">Email</div>
                        <div class="card-body text-center">
                            <div id="emailStatus" class="badge success">Ativo</div>
                            <p class="mt-3" id="emailMessage">Configurado</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">SMS</div>
                        <div class="card-body text-center">
                            <div id="smsStatus" class="badge success">Ativo</div>
                            <p class="mt-3" id="smsMessage">Configurado</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
// GLOBALS
let currentUser = null;
let orcamento = { servicos: [], produtos: [] };
let servicosDisponiveis = [];
let servicoSelecionado = null;

// INIT
document.addEventListener('DOMContentLoaded', () => {
    console.log('%c🌳 BIOMA v3.1', 'background: #7C3AED; color: #fff; font-size: 24px; padding: 15px; border-radius: 8px; font-weight: 900;');
    checkAuth();
});

// AUTH
async function checkAuth() {
    try {
        const res = await fetch('/api/current-user', { credentials: 'include' });
        const data = await res.json();
        
        if (data.success && data.user) {
            currentUser = data.user;
            showApp();
        } else {
            showAuth();
        }
    } catch (e) {
        console.error('❌ Auth error:', e);
        showAuth();
    }
}

function showAuth() {
    document.getElementById('authScreen').style.display = 'flex';
    document.getElementById('app').style.display = 'none';
}

function showApp() {
    document.getElementById('authScreen').style.display = 'none';
    document.getElementById('app').style.display = 'block';
    loadDashboard();
}

function switchTab(tab) {
    if (tab === 'login') {
        document.getElementById('loginTab').classList.add('active');
        document.getElementById('registerTab').classList.remove('active');
        document.getElementById('loginForm').style.display = 'block';
        document.getElementById('registerForm').style.display = 'none';
        document.getElementById('verifyForm').style.display = 'none';
    } else {
        document.getElementById('registerTab').classList.add('active');
        document.getElementById('loginTab').classList.remove('active');
        document.getElementById('registerForm').style.display = 'block';
        document.getElementById('loginForm').style.display = 'none';
        document.getElementById('verifyForm').style.display = 'none';
    }
}

async function handleLogin(e) {
    e.preventDefault();
    
    const username = document.getElementById('loginUsername').value.trim();
    const password = document.getElementById('loginPassword').value.trim();
    
    console.log('🔐 Login:', username);
    
    try {
        const res = await fetch('/api/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ username, password })
        });
        
        const data = await res.json();
        
        if (data.success && data.user) {
            currentUser = data.user;
            
            Swal.fire({
                icon: 'success',
                title: '✅ Login OK!',
                text: `Bem-vindo, ${currentUser.name}!`,
                timer: 1500,
                showConfirmButton: false
            });
            
            setTimeout(() => showApp(), 500);
        } else {
            Swal.fire('Erro', data.message || 'Credenciais inválidas', 'error');
        }
    } catch (e) {
        console.error('❌ Login error:', e);
        Swal.fire('Erro', 'Erro de conexão', 'error');
    }
    
    return false;
}

async function handleRegister(e) {
    e.preventDefault();
    
    const name = document.getElementById('registerName').value.trim();
    const username = document.getElementById('registerUsername').value.trim();
    const email = document.getElementById('registerEmail').value.trim();
    const telefone = document.getElementById('registerTelefone').value.trim();
    const password = document.getElementById('registerPassword').value.trim();
    
    console.log('👤 Register:', username);
    
    try {
        const res = await fetch('/api/register', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ name, username, email, telefone, password })
        });
        
        const data = await res.json();
        
        if (data.success) {
            document.getElementById('verifyUsername').value = username;
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'none';
            document.getElementById('verifyForm').style.display = 'block';
            
            Swal.fire({
                icon: 'success',
                title: '✅ Conta criada!',
                text: data.message
            });
        } else {
            Swal.fire('Erro', data.message, 'error');
        }
    } catch (e) {
        console.error('❌ Register error:', e);
        Swal.fire('Erro', 'Erro de conexão', 'error');
    }
    
    return false;
}

async function handleVerify(e) {
    e.preventDefault();
    
    const username = document.getElementById('verifyUsername').value;
    const code = document.getElementById('verifyCode').value.trim();
    
    console.log('🔐 Verify:', username);
    
    try {
        const res = await fetch('/api/verify', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ username, code })
        });
        
        const data = await res.json();
        
        if (data.success) {
            Swal.fire({
                icon: 'success',
                title: '✅ Verificado!',
                text: data.message
            }).then(() => switchTab('login'));
        } else {
            Swal.fire('Erro', data.message, 'error');
        }
    } catch (e) {
        console.error('❌ Verify error:', e);
        Swal.fire('Erro', 'Erro de conexão', 'error');
    }
    
    return false;
}

async function doLogout() {
    await fetch('/api/logout', { method: 'POST', credentials: 'include' });
    location.reload();
}

// NAVIGATION
function goTo(section) {
    console.log('🔄 Navigate:', section);
    
    document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
    document.getElementById('section-' + section).classList.add('active');
    
    document.querySelectorAll('.sidebar-menu a').forEach(a => a.classList.remove('active'));
    const menu = document.getElementById('menu-' + section);
    if (menu) menu.classList.add('active');
    
    document.querySelector('.main-content').scrollTo({ top: 0, behavior: 'smooth' });
    
    if (section === 'dashboard') loadDashboard();
    if (section === 'clientes') loadClientes();
    if (section === 'profissionais') loadProfissionais();
    if (section === 'servicos') loadServicosLista();
    if (section === 'produtos') loadProdutosLista();
    if (section === 'consultar') loadConsultar();
    if (section === 'sistema') verificarStatus();
}

// DASHBOARD
async function loadDashboard() {
    console.log('📊 Load dashboard');
    try {
        const res = await fetch('/api/dashboard/stats', { credentials: 'include' });
        const data = await res.json();
        
        if (data.success) {
            document.getElementById('dashOrcamentos').textContent = data.stats.total_orcamentos;
            document.getElementById('dashClientes').textContent = data.stats.total_clientes;
            document.getElementById('dashServicos').textContent = data.stats.total_servicos;
            document.getElementById('dashFaturamento').textContent = 'R$ ' + data.stats.faturamento.toFixed(0);
        }
        
        const orcRes = await fetch('/api/orcamentos', { credentials: 'include' });
        const orcData = await orcRes.json();
        
        if (orcData.success && orcData.orcamentos.length > 0) {
            const html = orcData.orcamentos.slice(0, 10).map(o => `
                <tr>
                    <td><strong>#${o.numero}</strong></td>
                    <td>${new Date(o.created_at).toLocaleDateString('pt-BR')}</td>
                    <td>${o.cliente_nome}</td>
                    <td><strong>R$ ${o.total_final.toFixed(2)}</strong></td>
                    <td><span class="badge ${o.status === 'Aprovado' ? 'success' : 'warning'}">${o.status}</span></td>
                </tr>
            `).join('');
            document.getElementById('ultimosOrcamentosBody').innerHTML = html;
        }
    } catch (e) {
        console.error('❌ Dashboard error:', e);
    }
}

// CLIENTES
async function loadClientes() {
    console.log('📋 Load clients');
    try {
        const res = await fetch('/api/clientes', { credentials: 'include' });
        const data = await res.json();
        
        const tbody = document.getElementById('clientesBody');
        
        if (data.success && data.clientes && data.clientes.length > 0) {
            const html = data.clientes.map(c => `
                <tr>
                    <td><strong>${c.nome}</strong></td>
                    <td>${c.cpf}</td>
                    <td>${c.telefone || '-'}</td>
                    <td>R$ ${c.total_gasto?.toFixed(2) || '0.00'}</td>
                    <td>${c.total_visitas || 0}</td>
                    <td>
                        <button class="btn btn-sm btn-danger" onclick="deleteCliente('${c._id}')">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            tbody.innerHTML = html;
        } else {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Nenhum cliente</td></tr>';
        }
    } catch (e) {
        console.error('❌ Load clients error:', e);
        document.getElementById('clientesBody').innerHTML = '<tr><td colspan="6" class="text-center text-danger">Erro ao carregar</td></tr>';
    }
}

async function deleteCliente(id) {
    const result = await Swal.fire({
        title: 'Deletar?',
        text: 'Confirma a exclusão?',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Sim',
        cancelButtonText: 'Não'
    });
    
    if (result.isConfirmed) {
        try {
            const res = await fetch(`/api/clientes/${id}`, {
                method: 'DELETE',
                credentials: 'include'
            });
            const data = await res.json();
            
            if (data.success) {
                Swal.fire('Deletado!', '', 'success');
                loadClientes();
            }
        } catch (e) {
            Swal.fire('Erro', 'Erro ao deletar', 'error');
        }
    }
}

// PROFISSIONAIS
async function loadProfissionais() {
    try {
        const res = await fetch('/api/profissionais', { credentials: 'include' });
        const data = await res.json();
        
        const tbody = document.getElementById('profissionaisBody');
        
        if (data.success && data.profissionais && data.profissionais.length > 0) {
            const html = data.profissionais.map(p => `
                <tr>
                    <td><strong>${p.nome}</strong></td>
                    <td>${p.cpf}</td>
                    <td>${p.especialidade || '-'}</td>
                    <td>${p.comissao_perc}%</td>
                    <td>
                        <button class="btn btn-sm btn-danger" onclick="deleteProfissional('${p._id}')">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            tbody.innerHTML = html;
        } else {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Nenhum profissional</td></tr>';
        }
    } catch (e) {
        console.error('❌ Load professionals error:', e);
    }
}

async function deleteProfissional(id) {
    const result = await Swal.fire({
        title: 'Deletar?',
        icon: 'warning',
        showCancelButton: true
    });
    
    if (result.isConfirmed) {
        try {
            await fetch(`/api/profissionais/${id}`, { method: 'DELETE', credentials: 'include' });
            Swal.fire('Deletado!', '', 'success');
            loadProfissionais();
        } catch (e) {
            Swal.fire('Erro', '', 'error');
        }
    }
}

// SERVIÇOS
async function loadServicosLista() {
    try {
        const res = await fetch('/api/servicos', { credentials: 'include' });
        const data = await res.json();
        
        const tbody = document.getElementById('servicosListBody');
        
        if (data.success && data.servicos && data.servicos.length > 0) {
            const html = data.servicos.map(s => `
                <tr>
                    <td><strong>${s.nome}</strong></td>
                    <td>${s.tamanho}</td>
                    <td>R$ ${s.preco.toFixed(2)}</td>
                    <td>${s.categoria}</td>
                    <td>
                        <button class="btn btn-sm btn-danger" onclick="deleteServico('${s._id}')">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            tbody.innerHTML = html;
        } else {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Nenhum serviço</td></tr>';
        }
    } catch (e) {
        console.error('❌ Load services error:', e);
    }
}

async function deleteServico(id) {
    const result = await Swal.fire({
        title: 'Deletar?',
        icon: 'warning',
        showCancelButton: true
    });
    
    if (result.isConfirmed) {
        try {
            await fetch(`/api/servicos/${id}`, { method: 'DELETE', credentials: 'include' });
            Swal.fire('Deletado!', '', 'success');
            loadServicosLista();
        } catch (e) {
            Swal.fire('Erro', '', 'error');
        }
    }
}

// PRODUTOS
async function loadProdutosLista() {
    try {
        const res = await fetch('/api/produtos', { credentials: 'include' });
        const data = await res.json();
        
        const tbody = document.getElementById('produtosListBody');
        
        if (data.success && data.produtos && data.produtos.length > 0) {
            const html = data.produtos.map(p => `
                <tr>
                    <td><strong>${p.nome}</strong></td>
                    <td>${p.marca || '-'}</td>
                    <td>${p.sku}</td>
                    <td>R$ ${p.preco.toFixed(2)}</td>
                    <td>${p.estoque || 0}</td>
                    <td>
                        <button class="btn btn-sm btn-danger" onclick="deleteProduto('${p._id}')">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            tbody.innerHTML = html;
        } else {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Nenhum produto</td></tr>';
        }
    } catch (e) {
        console.error('❌ Load products error:', e);
    }
}

async function deleteProduto(id) {
    const result = await Swal.fire({
        title: 'Deletar?',
        icon: 'warning',
        showCancelButton: true
    });
    
    if (result.isConfirmed) {
        try {
            await fetch(`/api/produtos/${id}`, { method: 'DELETE', credentials: 'include' });
            Swal.fire('Deletado!', '', 'success');
            loadProdutosLista();
        } catch (e) {
            Swal.fire('Erro', '', 'error');
        }
    }
}

// CONSULTAR
async function loadConsultar() {
    try {
        const res = await fetch('/api/orcamentos', { credentials: 'include' });
        const data = await res.json();
        
        const tbody = document.getElementById('consultaBody');
        
        if (data.success && data.orcamentos && data.orcamentos.length > 0) {
            const html = data.orcamentos.map(o => `
                <tr>
                    <td><strong>#${o.numero}</strong></td>
                    <td>${new Date(o.created_at).toLocaleDateString('pt-BR')}</td>
                    <td>${o.cliente_nome}</td>
                    <td>R$ ${o.total_final.toFixed(2)}</td>
                    <td><span class="badge ${o.status === 'Aprovado' ? 'success' : 'warning'}">${o.status}</span></td>
                    <td>
                        <button class="btn btn-sm btn-danger" onclick="deleteOrcamento('${o._id}')">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            tbody.innerHTML = html;
        } else {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Nenhum orçamento</td></tr>';
        }
    } catch (e) {
        console.error('❌ Load budgets error:', e);
    }
}

async function deleteOrcamento(id) {
    const result = await Swal.fire({
        title: 'Deletar?',
        icon: 'warning',
        showCancelButton: true
    });
    
    if (result.isConfirmed) {
        try {
            await fetch(`/api/orcamentos/${id}`, { method: 'DELETE', credentials: 'include' });
            Swal.fire('Deletado!', '', 'success');
            loadConsultar();
        } catch (e) {
            Swal.fire('Erro', '', 'error');
        }
    }
}

// ORÇAMENTO
async function buscarClientePorCPF() {
    const cpf = document.getElementById('orcCPF').value.trim();
    if (cpf.length < 3) return;
    
    try {
        const res = await fetch(`/api/clientes/buscar?termo=${cpf}`, { credentials: 'include' });
        const data = await res.json();
        
        if (data.success && data.clientes.length > 0) {
            const c = data.clientes[0];
            document.getElementById('orcNomeCliente').value = c.nome;
            document.getElementById('orcEmail').value = c.email || '';
            document.getElementById('orcTelefone').value = c.telefone || '';
        }
    } catch (e) {
        console.error('❌ Search client error:', e);
    }
}

async function buscarServicos() {
    const termo = document.getElementById('buscaServico').value.trim();
    if (termo.length < 2) return;
    
    try {
        const res = await fetch(`/api/servicos/buscar?termo=${termo}`, { credentials: 'include' });
        const data = await res.json();
        
        if (data.success && data.servicos.length > 0) {
            servicosDisponiveis = data.servicos;
            
            const select = document.getElementById('servicoTamanho');
            select.innerHTML = '<option value="">Selecione...</option>';
            
            data.servicos.forEach(s => {
                const option = document.createElement('option');
                option.value = s._id;
                option.textContent = `${s.tamanho} - R$ ${s.preco.toFixed(2)}`;
                option.dataset.preco = s.preco;
                option.dataset.nome = s.nome;
                option.dataset.tamanho = s.tamanho;
                select.appendChild(option);
            });
            
            select.addEventListener('change', function() {
                const selected = this.options[this.selectedIndex];
                if (selected.dataset.preco) {
                    document.getElementById('servicoPreco').value = selected.dataset.preco;
                    servicoSelecionado = {
                        id: this.value,
                        nome: selected.dataset.nome,
                        tamanho: selected.dataset.tamanho,
                        preco: parseFloat(selected.dataset.preco)
                    };
                }
            });
        }
    } catch (e) {
        console.error('❌ Search services error:', e);
    }
}

function addServico() {
    if (!servicoSelecionado) {
        Swal.fire('Atenção', 'Selecione um serviço', 'warning');
        return;
    }
    
    const qtd = parseInt(document.getElementById('servicoQtd').value) || 1;
    const preco = parseFloat(document.getElementById('servicoPreco').value) || 0;
    
    const total = qtd * preco;
    
    orcamento.servicos.push({
        id: servicoSelecionado.id,
        nome: servicoSelecionado.nome,
        tamanho: servicoSelecionado.tamanho,
        qtd: qtd,
        preco_unit: preco,
        desconto: 0,
        total: total
    });
    
    atualizarTabelaServicos();
    
    document.getElementById('buscaServico').value = '';
    document.getElementById('servicoTamanho').innerHTML = '<option value="">Selecione...</option>';
    document.getElementById('servicoQtd').value = '1';
    document.getElementById('servicoPreco').value = '';
    servicoSelecionado = null;
    
    calcularTotais();
}

function atualizarTabelaServicos() {
    const tbody = document.getElementById('servicosBody');
    
    if (orcamento.servicos.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Nenhum serviço</td></tr>';
        return;
    }
    
    const html = orcamento.servicos.map((s, idx) => `
        <tr>
            <td><strong>${s.nome}</strong></td>
            <td>${s.tamanho}</td>
            <td>${s.qtd}</td>
            <td>R$ ${s.preco_unit.toFixed(2)}</td>
            <td><strong>R$ ${s.total.toFixed(2)}</strong></td>
            <td>
                <button class="btn btn-sm btn-danger" onclick="removerServico(${idx})">
                    <i class="bi bi-trash"></i>
                </button>
            </td>
        </tr>
    `).join('');
    
    tbody.innerHTML = html;
}

function removerServico(idx) {
    orcamento.servicos.splice(idx, 1);
    atualizarTabelaServicos();
    calcularTotais();
}

function calcularTotais() {
    const subtotal = orcamento.servicos.reduce((acc, s) => acc + s.total, 0);
    const descontoGlobal = parseFloat(document.getElementById('descontoGlobal').value) || 0;
    const descontoValor = subtotal * (descontoGlobal / 100);
    const total = subtotal - descontoValor;
    
    document.getElementById('totalFinal').textContent = `R$ ${total.toFixed(2)}`;
}

async function salvarOrc(status) {
    const cpf = document.getElementById('orcCPF').value.trim();
    const nome = document.getElementById('orcNomeCliente').value.trim();
    
    if (!cpf || !nome) {
        Swal.fire('Atenção', 'Preencha CPF e Nome', 'warning');
        return;
    }
    
    if (orcamento.servicos.length === 0) {
        Swal.fire('Atenção', 'Adicione pelo menos um serviço', 'warning');
        return;
    }
    
    const data = {
        cliente_cpf: cpf,
        cliente_nome: nome,
        cliente_email: document.getElementById('orcEmail').value.trim(),
        cliente_telefone: document.getElementById('orcTelefone').value.trim(),
        servicos: orcamento.servicos,
        produtos: [],
        desconto_global: parseFloat(document.getElementById('descontoGlobal').value) || 0,
        cashback_perc: 0,
        pagamento: { tipo: document.getElementById('pagamento').value },
        status: status
    };
    
    console.log('💾 Saving budget:', status);
    
    try {
        const res = await fetch('/api/orcamentos', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify(data)
        });
        
        const result = await res.json();
        
        if (result.success) {
            Swal.fire({
                icon: 'success',
                title: status === 'Aprovado' ? '✅ Aprovado!' : '✅ Salvo!',
                text: `Orçamento #${result.numero}`,
                timer: 2000
            }).then(() => {
                cancelarOrc();
                goTo('consultar');
            });
        } else {
            Swal.fire('Erro', result.message, 'error');
        }
    } catch (e) {
        console.error('❌ Save budget error:', e);
        Swal.fire('Erro', 'Erro ao salvar', 'error');
    }
}

function cancelarOrc() {
    orcamento = { servicos: [], produtos: [] };
    document.getElementById('orcCPF').value = '';
    document.getElementById('orcNomeCliente').value = '';
    document.getElementById('orcEmail').value = '';
    document.getElementById('orcTelefone').value = '';
    document.getElementById('descontoGlobal').value = '0';
    document.getElementById('pagamento').value = 'Pix';
    atualizarTabelaServicos();
    calcularTotais();
}

// STATUS
async function verificarStatus() {
    console.log('🔬 Checking status');
    try {
        const res = await fetch('/api/system/status', { credentials: 'include' });
        const data = await res.json();
        
        if (data.success) {
            const mongoStatus = document.getElementById('mongoStatus');
            const mongoMsg = document.getElementById('mongoMessage');
            
            if (data.status.mongodb.operational) {
                mongoStatus.className = 'badge success';
                mongoStatus.textContent = 'Online';
                mongoMsg.textContent = data.status.mongodb.message;
            } else {
                mongoStatus.className = 'badge danger';
                mongoStatus.textContent = 'Offline';
                mongoMsg.textContent = data.status.mongodb.message;
            }
            
            const emailStatus = document.getElementById('emailStatus');
            const emailMsg = document.getElementById('emailMessage');
            
            if (data.status.mailersend.operational) {
                emailStatus.className = 'badge success';
                emailStatus.textContent = 'Ativo';
                emailMsg.textContent = data.status.mailersend.message;
            } else {
                emailStatus.className = 'badge danger';
                emailStatus.textContent = 'Inativo';
                emailMsg.textContent = data.status.mailersend.message;
            }
            
            const smsStatus = document.getElementById('smsStatus');
            const smsMsg = document.getElementById('smsMessage');
            
            if (data.status.mailersend.operational) {
                smsStatus.className = 'badge success';
                smsStatus.textContent = 'Ativo';
                smsMsg.textContent = 'SMS serão enviados';
            } else {
                smsStatus.className = 'badge danger';
                smsStatus.textContent = 'Inativo';
                smsMsg.textContent = 'Configure API Key';
            }
            
            console.log('✅ Status OK');
        }
    } catch (e) {
        console.error('❌ Status error:', e);
    }
}

// IMPORTAR
async function handleUpload(input, tipo) {
    const file = input.files[0];
    if (!file) return;
    
    console.log('📤 Importing:', file.name, '-', tipo);
    
    const formData = new FormData();
    formData.append('file', file);
    formData.append('tipo', tipo);
    
    Swal.fire({
        title: 'Importando...',
        html: 'Aguarde...',
        allowOutsideClick: false,
        didOpen: () => {
            Swal.showLoading();
        }
    });
    
    try {
        const res = await fetch('/api/importar', {
            method: 'POST',
            credentials: 'include',
            body: formData
        });
        
        const data = await res.json();
        
        if (data.success) {
            console.log('✅ Import:', data.count_success, 'success,', data.count_error, 'errors');
            
            Swal.fire({
                icon: 'success',
                title: '✅ Importado!',
                html: `<p><strong>${data.count_success}</strong> registros importados</p>${data.count_error > 0 ? `<p class="text-danger">${data.count_error} erros</p>` : ''}`
            });
            
            if (tipo === 'produtos') loadProdutosLista();
            if (tipo === 'servicos') loadServicosLista();
        } else {
            Swal.fire('Erro', data.message, 'error');
        }
    } catch (e) {
        console.error('❌ Import error:', e);
        Swal.fire('Erro', 'Erro ao importar', 'error');
    }
    
    input.value = '';
}

// MODALS (placeholders)
function showModalCliente() {
    Swal.fire({
        title: 'Novo Cliente',
        html: `
            <input type="text" id="swal-cpf" class="form-control mb-3" placeholder="CPF">
            <input type="text" id="swal-nome" class="form-control mb-3" placeholder="Nome">
            <input type="email" id="swal-email" class="form-control mb-3" placeholder="Email">
            <input type="text" id="swal-telefone" class="form-control mb-3" placeholder="Telefone">
        `,
        showCancelButton: true,
        confirmButtonText: 'Salvar',
        preConfirm: () => {
            const cpf = document.getElementById('swal-cpf').value;
            const nome = document.getElementById('swal-nome').value;
            const email = document.getElementById('swal-email').value;
            const telefone = document.getElementById('swal-telefone').value;
            
            if (!cpf || !nome) {
                Swal.showValidationMessage('CPF e Nome são obrigatórios');
                return false;
            }
            
            return { cpf, nome, email, telefone };
        }
    }).then(async (result) => {
        if (result.isConfirmed) {
            try {
                const res = await fetch('/api/clientes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(result.value)
                });
                
                const data = await res.json();
                
                if (data.success) {
                    Swal.fire('Sucesso!', 'Cliente cadastrado', 'success');
                    loadClientes();
                } else {
                    Swal.fire('Erro', data.message, 'error');
                }
            } catch (e) {
                Swal.fire('Erro', 'Erro ao salvar', 'error');
            }
        }
    });
}

function showModalProfissional() {
    Swal.fire({
        title: 'Novo Profissional',
        html: `
            <input type="text" id="swal-nome" class="form-control mb-3" placeholder="Nome">
            <input type="text" id="swal-cpf" class="form-control mb-3" placeholder="CPF">
            <input type="text" id="swal-espec" class="form-control mb-3" placeholder="Especialidade">
            <input type="number" id="swal-comissao" class="form-control mb-3" placeholder="Comissão %" value="10">
        `,
        showCancelButton: true,
        confirmButtonText: 'Salvar',
        preConfirm: () => {
            const nome = document.getElementById('swal-nome').value;
            const cpf = document.getElementById('swal-cpf').value;
            const especialidade = document.getElementById('swal-espec').value;
            const comissao_perc = document.getElementById('swal-comissao').value;
            
            if (!nome || !cpf) {
                Swal.showValidationMessage('Nome e CPF são obrigatórios');
                return false;
            }
            
            return { nome, cpf, especialidade, comissao_perc };
        }
    }).then(async (result) => {
        if (result.isConfirmed) {
            try {
                const res = await fetch('/api/profissionais', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(result.value)
                });
                
                const data = await res.json();
                
                if (data.success) {
                    Swal.fire('Sucesso!', 'Profissional cadastrado', 'success');
                    loadProfissionais();
                } else {
                    Swal.fire('Erro', data.message, 'error');
                }
            } catch (e) {
                Swal.fire('Erro', 'Erro ao salvar', 'error');
            }
        }
    });
}

function showModalServico() {
    Swal.fire({
        title: 'Novo Serviço',
        html: `
            <input type="text" id="swal-nome" class="form-control mb-3" placeholder="Nome">
            <input type="text" id="swal-cat" class="form-control mb-3" placeholder="Categoria" value="Serviço">
            <div class="row">
                <div class="col-6">
                    <input type="number" id="swal-kids" class="form-control mb-2" placeholder="Preço Kids" step="0.01">
                    <input type="number" id="swal-masc" class="form-control mb-2" placeholder="Preço Masculino" step="0.01">
                    <input type="number" id="swal-curto" class="form-control mb-2" placeholder="Preço Curto" step="0.01">
                </div>
                <div class="col-6">
                    <input type="number" id="swal-medio" class="form-control mb-2" placeholder="Preço Médio" step="0.01">
                    <input type="number" id="swal-longo" class="form-control mb-2" placeholder="Preço Longo" step="0.01">
                    <input type="number" id="swal-xl" class="form-control mb-2" placeholder="Preço XL" step="0.01">
                </div>
            </div>
        `,
        showCancelButton: true,
        confirmButtonText: 'Salvar',
        preConfirm: () => {
            const nome = document.getElementById('swal-nome').value;
            const categoria = document.getElementById('swal-cat').value;
            
            if (!nome) {
                Swal.showValidationMessage('Nome é obrigatório');
                return false;
            }
            
            return {
                nome,
                categoria,
                preco_kids: document.getElementById('swal-kids').value || 0,
                preco_masculino: document.getElementById('swal-masc').value || 0,
                preco_curto: document.getElementById('swal-curto').value || 0,
                preco_medio: document.getElementById('swal-medio').value || 0,
                preco_longo: document.getElementById('swal-longo').value || 0,
                preco_extra_longo: document.getElementById('swal-xl').value || 0
            };
        }
    }).then(async (result) => {
        if (result.isConfirmed) {
            try {
                const res = await fetch('/api/servicos', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(result.value)
                });
                
                const data = await res.json();
                
                if (data.success) {
                    Swal.fire('Sucesso!', `${data.count} SKUs criados`, 'success');
                    loadServicosLista();
                } else {
                    Swal.fire('Erro', data.message, 'error');
                }
            } catch (e) {
                Swal.fire('Erro', 'Erro ao salvar', 'error');
            }
        }
    });
}

function showModalProduto() {
    Swal.fire({
        title: 'Novo Produto',
        html: `
            <input type="text" id="swal-nome" class="form-control mb-3" placeholder="Nome">
            <input type="text" id="swal-marca" class="form-control mb-3" placeholder="Marca">
            <input type="text" id="swal-sku" class="form-control mb-3" placeholder="SKU">
            <input type="number" id="swal-preco" class="form-control mb-3" placeholder="Preço" step="0.01">
            <input type="number" id="swal-custo" class="form-control mb-3" placeholder="Custo" step="0.01">
            <input type="number" id="swal-estoque" class="form-control mb-3" placeholder="Estoque" value="0">
        `,
        showCancelButton: true,
        confirmButtonText: 'Salvar',
        preConfirm: () => {
            const nome = document.getElementById('swal-nome').value;
            const preco = document.getElementById('swal-preco').value;
            
            if (!nome || !preco) {
                Swal.showValidationMessage('Nome e Preço são obrigatórios');
                return false;
            }
            
            return {
                nome,
                marca: document.getElementById('swal-marca').value,
                sku: document.getElementById('swal-sku').value,
                preco,
                custo: document.getElementById('swal-custo').value || 0,
                estoque: document.getElementById('swal-estoque').value || 0,
                categoria: 'Produto'
            };
        }
    }).then(async (result) => {
        if (result.isConfirmed) {
            try {
                const res = await fetch('/api/produtos', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(result.value)
                });
                
                const data = await res.json();
                
                if (data.success) {
                    Swal.fire('Sucesso!', 'Produto cadastrado', 'success');
                    loadProdutosLista();
                } else {
                    Swal.fire('Erro', data.message, 'error');
                }
            } catch (e) {
                Swal.fire('Erro', 'Erro ao salvar', 'error');
            }
        }
    });
}

console.log('%c✅ BIOMA v3.1 LOADED', 'color: #10B981; font-size: 16px; font-weight: 900;');
console.log('%cAll functions operational! 🎉', 'color: #10B981; font-size: 14px;');
</script>

</body>
</html>