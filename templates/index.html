<!DOCTYPE html>
<html lang="pt-BR" data-theme="light">
<head>
    <!-- BIOMA v5.3.4 - Build: {{ cache_buster|default('LOCAL', true) }} -->
    <!-- UI SYSTEM: Overlay + editarProduto + Fila Fix + Timeout Fix -->
    <!-- CACHE BUSTER: Force reload para carregar editarProduto -->

    <!-- TEMA PERSISTENTE - Script de bloqueio no <head> para prevenir FOUC -->
    <script>
    // Este script √© intencionalmente colocado no <head> e √© um script de bloqueio.
    // Ele garante que o tema correto seja aplicado ANTES da p√°gina ser renderizada,
    // prevenindo o "flash" de um tema para o outro no carregamento da p√°gina.
    (function() {
        // HIERARQUIA DE PRIORIDADES (conforme relat√≥rio t√©cnico):
        // 1. Prefer√™ncia do USU√ÅRIO salva no localStorage (M√ÅXIMA prioridade)
        // 2. Prefer√™ncia do SISTEMA OPERACIONAL (matchMedia)
        // 3. Padr√£o da aplica√ß√£o ('light')
        function getTheme() {
            // 1¬™ Prioridade: Prefer√™ncia expl√≠cita do usu√°rio
            const storedTheme = localStorage.getItem('theme');
            if (storedTheme) {
                console.log('üé® Usando prefer√™ncia do USU√ÅRIO:', storedTheme);
                return storedTheme;
            }

            // 2¬™ Prioridade: Prefer√™ncia do Sistema Operacional
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                console.log('üé® Usando prefer√™ncia do SO: dark');
                return 'dark';
            }

            // 3¬™ Prioridade: Padr√£o da aplica√ß√£o
            console.log('üé® Usando padr√£o da aplica√ß√£o: light');
            return 'light';
        }

        const theme = getTheme();
        document.documentElement.setAttribute('data-theme', theme);
    })();
    </script>

    <!-- META TAG PARA EVITAR CACHE - For√ßa reload de assets -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="Sistema de Gest√£o BIOMA Uberaba v4.0 - Sistema Completo">
    <meta name="author" content="Juan Marco (@juanmarco1999)">
    <title>BIOMA Uberaba v4.0 - Sistema Profissional</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üå≥</text></svg>">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <!-- BIOMA v5.0 - Sistema Consolidado -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- SweetAlert2 - RESTAURADO para compatibilidade -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.10.8/dist/sweetalert2.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.10.8/dist/sweetalert2.all.min.js"></script>
    <!-- SheetJS para exporta√ß√£o Excel -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <!-- jsPDF para gera√ß√£o de PDFs profissionais -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- jsPDF AutoTable para tabelas em PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <!-- FullCalendar para calend√°rio de profissionais - CDN correto -->
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/main.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/locales/pt-br.global.min.js"></script>

    <!-- ======================== BIBLIOTECAS MODERNAS PARA UI/UX ======================== -->
    <!-- NProgress - Barra de progresso elegante no topo da p√°gina -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/nprogress/0.2.0/nprogress.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/nprogress/0.2.0/nprogress.min.js"></script>

    <!-- Animate.css - Anima√ß√µes CSS prontas para usar -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">

    <!-- Spinkit - Spinners/Loaders elegantes -->
    <style>
    /* Spinkit - Spinner Moderno */
    .sk-chase {
        width: 40px;
        height: 40px;
        position: relative;
        animation: sk-chase 2.5s infinite linear both;
        margin: 0 auto;
    }
    .sk-chase-dot {
        width: 100%;
        height: 100%;
        position: absolute;
        left: 0;
        top: 0;
        animation: sk-chase-dot 2.0s infinite ease-in-out both;
    }
    .sk-chase-dot:before {
        content: '';
        display: block;
        width: 25%;
        height: 25%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 100%;
        animation: sk-chase-dot-before 2.0s infinite ease-in-out both;
    }
    .sk-chase-dot:nth-child(1) { animation-delay: -1.1s; }
    .sk-chase-dot:nth-child(2) { animation-delay: -1.0s; }
    .sk-chase-dot:nth-child(3) { animation-delay: -0.9s; }
    .sk-chase-dot:nth-child(4) { animation-delay: -0.8s; }
    .sk-chase-dot:nth-child(5) { animation-delay: -0.7s; }
    .sk-chase-dot:nth-child(6) { animation-delay: -0.6s; }
    .sk-chase-dot:nth-child(1):before { animation-delay: -1.1s; }
    .sk-chase-dot:nth-child(2):before { animation-delay: -1.0s; }
    .sk-chase-dot:nth-child(3):before { animation-delay: -0.9s; }
    .sk-chase-dot:nth-child(4):before { animation-delay: -0.8s; }
    .sk-chase-dot:nth-child(5):before { animation-delay: -0.7s; }
    .sk-chase-dot:nth-child(6):before { animation-delay: -0.6s; }
    @keyframes sk-chase {
        100% { transform: rotate(360deg); }
    }
    @keyframes sk-chase-dot {
        80%, 100% { transform: rotate(360deg); }
    }
    @keyframes sk-chase-dot-before {
        50% {
            transform: scale(0.4);
        } 100%, 0% {
            transform: scale(1.0);
        }
    }

    /* Spinner Wave */
    .sk-wave {
        width: 50px;
        height: 40px;
        text-align: center;
        font-size: 10px;
        margin: 0 auto;
    }
    .sk-wave .sk-rect {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        height: 100%;
        width: 6px;
        display: inline-block;
        animation: sk-wave-stretch-delay 1.2s infinite ease-in-out;
        margin: 0 1px;
    }
    .sk-wave .sk-rect1 { animation-delay: -1.2s; }
    .sk-wave .sk-rect2 { animation-delay: -1.1s; }
    .sk-wave .sk-rect3 { animation-delay: -1.0s; }
    .sk-wave .sk-rect4 { animation-delay: -0.9s; }
    .sk-wave .sk-rect5 { animation-delay: -0.8s; }
    @keyframes sk-wave-stretch-delay {
        0%, 40%, 100% {
            transform: scaleY(0.4);
        } 20% {
            transform: scaleY(1.0);
        }
    }

    /* Spinner Circle */
    .sk-circle {
        margin: 20px auto;
        width: 40px;
        height: 40px;
        position: relative;
    }
    .sk-circle .sk-child {
        width: 100%;
        height: 100%;
        position: absolute;
        left: 0;
        top: 0;
    }
    .sk-circle .sk-child:before {
        content: '';
        display: block;
        margin: 0 auto;
        width: 15%;
        height: 15%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 100%;
        animation: sk-circle-bounce-delay 1.2s infinite ease-in-out both;
    }
    .sk-circle .sk-circle2 { transform: rotate(30deg); }
    .sk-circle .sk-circle3 { transform: rotate(60deg); }
    .sk-circle .sk-circle4 { transform: rotate(90deg); }
    .sk-circle .sk-circle5 { transform: rotate(120deg); }
    .sk-circle .sk-circle6 { transform: rotate(150deg); }
    .sk-circle .sk-circle7 { transform: rotate(180deg); }
    .sk-circle .sk-circle8 { transform: rotate(210deg); }
    .sk-circle .sk-circle9 { transform: rotate(240deg); }
    .sk-circle .sk-circle10 { transform: rotate(270deg); }
    .sk-circle .sk-circle11 { transform: rotate(300deg); }
    .sk-circle .sk-circle12 { transform: rotate(330deg); }
    .sk-circle .sk-circle2:before { animation-delay: -1.1s; }
    .sk-circle .sk-circle3:before { animation-delay: -1.0s; }
    .sk-circle .sk-circle4:before { animation-delay: -0.9s; }
    .sk-circle .sk-circle5:before { animation-delay: -0.8s; }
    .sk-circle .sk-circle6:before { animation-delay: -0.7s; }
    .sk-circle .sk-circle7:before { animation-delay: -0.6s; }
    .sk-circle .sk-circle8:before { animation-delay: -0.5s; }
    .sk-circle .sk-circle9:before { animation-delay: -0.4s; }
    .sk-circle .sk-circle10:before { animation-delay: -0.3s; }
    .sk-circle .sk-circle11:before { animation-delay: -0.2s; }
    .sk-circle .sk-circle12:before { animation-delay: -0.1s; }
    @keyframes sk-circle-bounce-delay {
        0%, 80%, 100% {
            transform: scale(0);
        } 40% {
            transform: scale(1);
        }
    }

    /* BIOMA Modern Loader - Spinner Premium */
    .bioma-loader {
        margin: 20px auto;
        width: 60px;
        height: 60px;
        position: relative;
    }
    .bioma-loader-ring {
        position: absolute;
        width: 100%;
        height: 100%;
        border: 4px solid transparent;
        border-top-color: #667eea;
        border-right-color: #764ba2;
        border-radius: 50%;
        animation: bioma-spin 1.5s cubic-bezier(0.68, -0.55, 0.265, 1.55) infinite;
    }
    .bioma-loader-ring:nth-child(2) {
        width: 80%;
        height: 80%;
        top: 10%;
        left: 10%;
        border-top-color: #764ba2;
        border-right-color: #667eea;
        animation-duration: 2s;
        animation-direction: reverse;
    }
    .bioma-loader-ring:nth-child(3) {
        width: 60%;
        height: 60%;
        top: 20%;
        left: 20%;
        border-top-color: #667eea;
        border-right-color: #764ba2;
        animation-duration: 2.5s;
    }
    @keyframes bioma-spin {
        0% {
            transform: rotate(0deg);
            opacity: 1;
        }
        50% {
            opacity: 0.8;
        }
        100% {
            transform: rotate(360deg);
            opacity: 1;
        }
    }

    /* BIOMA Pulse Loader - Efeito de Pulso Moderno */
    .bioma-pulse-loader {
        margin: 20px auto;
        width: 60px;
        height: 60px;
        position: relative;
    }
    .bioma-pulse-dot {
        position: absolute;
        width: 20px;
        height: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 50%;
        animation: bioma-pulse 1.5s ease-in-out infinite;
    }
    .bioma-pulse-dot:nth-child(1) {
        left: 0;
        animation-delay: 0s;
    }
    .bioma-pulse-dot:nth-child(2) {
        left: 20px;
        animation-delay: 0.3s;
    }
    .bioma-pulse-dot:nth-child(3) {
        left: 40px;
        animation-delay: 0.6s;
    }
    @keyframes bioma-pulse {
        0%, 80%, 100% {
            transform: scale(0.6);
            opacity: 0.5;
        }
        40% {
            transform: scale(1);
            opacity: 1;
        }
    }

    /* BIOMA Bounce Loader - Efeito Bounce Elegante */
    .bioma-bounce-loader {
        margin: 20px auto;
        width: 80px;
        text-align: center;
    }
    .bioma-bounce-ball {
        width: 18px;
        height: 18px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 100%;
        display: inline-block;
        animation: bioma-bounce 1.4s infinite ease-in-out both;
        margin: 0 3px;
        box-shadow: 0 0 10px rgba(102, 126, 234, 0.5);
    }
    .bioma-bounce-ball:nth-child(1) {
        animation-delay: -0.32s;
    }
    .bioma-bounce-ball:nth-child(2) {
        animation-delay: -0.16s;
    }
    @keyframes bioma-bounce {
        0%, 80%, 100% {
            transform: scale(0) translateY(0);
        }
        40% {
            transform: scale(1) translateY(-20px);
        }
    }

    /* Configura√ß√µes do NProgress */
    #nprogress .bar {
        background: linear-gradient(90deg, #667eea 0%, #764ba2 100%) !important;
        height: 3px !important;
    }
    #nprogress .peg {
        box-shadow: 0 0 10px #667eea, 0 0 5px #667eea !important;
    }
    #nprogress .spinner-icon {
        border-top-color: #667eea !important;
        border-left-color: #667eea !important;
    }
    </style>
    <!-- ======================== FIM DAS BIBLIOTECAS MODERNAS ======================== -->

    <!-- ======================== MELHORIAS ADICIONAIS v6.4.0 ======================== -->

    <!-- Material Ripple Effect para Bot√µes -->
    <style>
    /* Ripple Effect - Material Design */
    .btn, .bioma-btn {
        position: relative;
        overflow: hidden;
        transform: translateZ(0);
    }

    .btn::before, .bioma-btn::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.5);
        transform: translate(-50%, -50%);
        transition: width 0.6s, height 0.6s;
    }

    .btn:active::before, .bioma-btn:active::before {
        width: 300px;
        height: 300px;
    }

    /* Bot√µes Modernos - Gradientes Melhorados */
    .btn-primary, .bioma-btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
        border: none;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    }

    .btn-primary:hover, .bioma-btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6);
        background: linear-gradient(135deg, #764ba2 0%, #667eea 100%) !important;
    }

    .btn-success, .bioma-btn-success {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%) !important;
        border: none;
        box-shadow: 0 4px 15px rgba(17, 153, 142, 0.4);
    }

    .btn-success:hover, .bioma-btn-success:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(17, 153, 142, 0.6);
    }

    .btn-danger, .bioma-btn-danger {
        background: linear-gradient(135deg, #ee0979 0%, #ff6a00 100%) !important;
        border: none;
        box-shadow: 0 4px 15px rgba(238, 9, 121, 0.4);
    }

    .btn-danger:hover, .bioma-btn-danger:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(238, 9, 121, 0.6);
    }

    .btn-info, .bioma-btn-info {
        background: linear-gradient(135deg, #00b4db 0%, #0083b0 100%) !important;
        border: none;
        box-shadow: 0 4px 15px rgba(0, 180, 219, 0.4);
    }

    .btn-info:hover, .bioma-btn-info:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 180, 219, 0.6);
    }

    .btn-warning, .bioma-btn-warning {
        background: linear-gradient(135deg, #f2994a 0%, #f2c94c 100%) !important;
        border: none;
        box-shadow: 0 4px 15px rgba(242, 153, 74, 0.4);
        color: #fff !important;
    }

    .btn-warning:hover, .bioma-btn-warning:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(242, 153, 74, 0.6);
    }

    /* √çcones Animados nos Bot√µes */
    .btn i, .bioma-btn i {
        transition: transform 0.3s ease;
    }

    .btn:hover i, .bioma-btn:hover i {
        transform: scale(1.2) rotate(5deg);
    }

    /* Estilos Melhorados para FullCalendar */
    .fc {
        font-family: inherit;
    }

    .fc .fc-button-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
        border: none !important;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        transition: all 0.3s ease;
    }

    .fc .fc-button-primary:hover {
        background: linear-gradient(135deg, #764ba2 0%, #667eea 100%) !important;
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6);
    }

    .fc .fc-button-primary:not(:disabled):active,
    .fc .fc-button-primary:not(:disabled).fc-button-active {
        background: linear-gradient(135deg, #5568d3 0%, #654393 100%) !important;
    }

    .fc-theme-standard td, .fc-theme-standard th {
        border-color: #e5e7eb;
    }

    .fc-daygrid-day:hover {
        background: rgba(102, 126, 234, 0.05);
        transition: background 0.3s ease;
    }

    .fc-event {
        border: none !important;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        transition: all 0.3s ease;
    }

    .fc-event:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
    }

    .fc-event-title {
        font-weight: 600;
    }

    /* Cores personalizadas para eventos */
    .fc-event.event-confirmado {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    }

    .fc-event.event-pendente {
        background: linear-gradient(135deg, #f2994a 0%, #f2c94c 100%);
    }

    .fc-event.event-cancelado {
        background: linear-gradient(135deg, #ee0979 0%, #ff6a00 100%);
    }

    /* Melhorias no header do calend√°rio */
    .fc-toolbar-title {
        font-size: 1.5rem !important;
        font-weight: 700 !important;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    /* Padroniza√ß√£o de Modais SweetAlert2 */
    .swal2-popup {
        border-radius: 20px !important;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3) !important;
    }

    .swal2-title {
        font-weight: 700 !important;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    .swal2-confirm {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
        border: none !important;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4) !important;
        border-radius: 10px !important;
        padding: 12px 30px !important;
        font-weight: 600 !important;
        transition: all 0.3s ease !important;
    }

    .swal2-confirm:hover {
        transform: translateY(-2px) !important;
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6) !important;
    }

    .swal2-cancel {
        background: linear-gradient(135deg, #6c757d 0%, #495057 100%) !important;
        border: none !important;
        box-shadow: 0 4px 15px rgba(108, 117, 125, 0.4) !important;
        border-radius: 10px !important;
        padding: 12px 30px !important;
        font-weight: 600 !important;
    }

    .swal2-input, .swal2-textarea, .swal2-select {
        border-radius: 10px !important;
        border: 2px solid #e5e7eb !important;
        transition: all 0.3s ease !important;
    }

    .swal2-input:focus, .swal2-textarea:focus, .swal2-select:focus {
        border-color: #667eea !important;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1) !important;
    }

    /* Anima√ß√£o de entrada para modais */
    .swal2-show {
        animation: swal2-show 0.3s cubic-bezier(0.25, 0.8, 0.25, 1) !important;
    }

    @keyframes swal2-show {
        0% {
            transform: scale(0.7) translateY(20px);
            opacity: 0;
        }
        100% {
            transform: scale(1) translateY(0);
            opacity: 1;
        }
    }
    </style>
    <!-- ======================== FIM DAS MELHORIAS ADICIONAIS ======================== -->

    <!-- POLYFILLS PARA COMPATIBILIDADE CROSS-BROWSER (Safari, Firefox, Mobile) -->
    <script>
    // Polyfill: Promise.allSettled (Safari < 13, Firefox < 71, Chrome < 76)
    if (!Promise.allSettled) {
        Promise.allSettled = function(promises) {
            return Promise.all(promises.map(p => Promise.resolve(p).then(
                value => ({ status: 'fulfilled', value }),
                reason => ({ status: 'rejected', reason })
            )));
        };
    }

    // Polyfill: String.prototype.replaceAll (Safari < 13.1, Firefox < 77)
    if (!String.prototype.replaceAll) {
        String.prototype.replaceAll = function(search, replacement) {
            return this.split(search).join(replacement);
        };
    }

    // Polyfill: Array.prototype.at (Safari < 15.4, Firefox < 90, Chrome < 92)
    if (!Array.prototype.at) {
        Array.prototype.at = function(index) {
            const len = this.length;
            const relativeIndex = index >= 0 ? index : len + index;
            if (relativeIndex < 0 || relativeIndex >= len) return undefined;
            return this[relativeIndex];
        };
    }

    // Helper: Substituir optional chaining (?.) e nullish coalescing (??)
    // que n√£o funcionam em Safari < 13.1, Chrome < 80
    window._safe = function(obj, path, defaultValue) {
        try {
            const keys = path.split('.');
            let result = obj;
            for (let key of keys) {
                if (result == null) return defaultValue;
                result = result[key];
            }
            return result != null ? result : defaultValue;
        } catch(e) {
            return defaultValue;
        }
    };

    // Polyfill: Object.fromEntries (Safari < 12.1, Firefox < 63)
    if (!Object.fromEntries) {
        Object.fromEntries = function(entries) {
            const obj = {};
            for (const [key, value] of entries) {
                obj[key] = value;
            }
            return obj;
        };
    }

    // Mobile detection helper
    window.isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

    // Touch events support detection
    window.hasTouch = 'ontouchstart' in window || navigator.maxTouchPoints > 0;

    console.log('%c‚úÖ Polyfills carregados', 'background: #10B981; color: white; padding: 4px;');
    console.log('   ‚Üí Mobile:', window.isMobile ? 'Sim' : 'N√£o');
    console.log('   ‚Üí Touch:', window.hasTouch ? 'Sim' : 'N√£o');
    console.log('   ‚Üí User Agent:', navigator.userAgent.substring(0, 50) + '...');
    </script>

    <style>
:root[data-theme="light"]{--primary:#7C3AED;--primary-dark:#6D28D9;--secondary:#EC4899;--accent:#F59E0B;--success:#10B981;--danger:#EF4444;--warning:#F59E0B;--info:#3B82F6;--bg-main:#F9FAFB;--bg-card:#FFFFFF;--bg-sidebar:#1F2937;--bg-sidebar-hover:#374151;--text-primary:#1F2937;--text-secondary:#6B7280;--text-muted:#9CA3AF;--border-color:#E5E7EB;--shadow:0 4px 20px rgba(0,0,0,0.08);--shadow-hover:0 8px 30px rgba(124,58,237,0.15);}

/* Estilos melhorados para o calend√°rio FullCalendar */
.fc {
    background: var(--bg-card);
    border-radius: 20px;
    padding: 20px;
    box-shadow: var(--shadow);
    border: 2px solid var(--border-color);
}

.fc-toolbar {
    margin-bottom: 20px !important;
    padding: 10px;
    background: linear-gradient(135deg, rgba(124,58,237,0.05), rgba(236,72,153,0.05));
    border-radius: 15px;
}

.fc-toolbar-title {
    font-weight: 800 !important;
    font-size: 1.5rem !important;
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
}

.fc-button {
    background: linear-gradient(135deg, var(--primary), var(--primary-dark)) !important;
    border: none !important;
    border-radius: 10px !important;
    padding: 8px 16px !important;
    font-weight: 600 !important;
    text-transform: uppercase !important;
    letter-spacing: 0.5px !important;
    font-size: 0.85rem !important;
    transition: all 0.3s ease !important;
}

.fc-button:hover {
    transform: translateY(-2px) !important;
    box-shadow: 0 5px 15px rgba(124,58,237,0.3) !important;
}

.fc-button-primary:not(:disabled).fc-button-active {
    background: linear-gradient(135deg, var(--secondary), var(--primary)) !important;
}

.fc-col-header-cell {
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    color: white !important;
    font-weight: 700 !important;
    text-transform: uppercase !important;
    padding: 12px 0 !important;
}

.fc-col-header-cell-cushion {
    color: white !important;
}

.fc-daygrid-day {
    border: 1px solid var(--border-color) !important;
    transition: all 0.2s ease;
}

.fc-daygrid-day:hover {
    background: linear-gradient(135deg, rgba(124,58,237,0.05), rgba(236,72,153,0.05));
}

.fc-day-today {
    background: linear-gradient(135deg, rgba(124,58,237,0.1), rgba(236,72,153,0.1)) !important;
}

.fc-day-today .fc-daygrid-day-number {
    background: var(--primary);
    color: white;
    border-radius: 50%;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    margin: 5px;
}

.fc-event {
    border-radius: 8px !important;
    padding: 4px 8px !important;
    font-weight: 600 !important;
    border: none !important;
    transition: all 0.2s ease !important;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1) !important;
}

.fc-event:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.2) !important;
}

.fc-event-custom {
    background: linear-gradient(135deg, var(--primary), var(--primary-dark)) !important;
    color: white !important;
}

.fc-timegrid-slot {
    height: 60px !important;
}

.fc-timegrid-slot-label {
    font-weight: 600 !important;
    color: var(--text-secondary) !important;
}

.fc-scrollgrid {
    border-radius: 15px !important;
    overflow: hidden;
}

.fc-popover {
    background: var(--bg-card) !important;
    border: 2px solid var(--primary) !important;
    border-radius: 15px !important;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2) !important;
}

.fc-popover-header {
    background: linear-gradient(135deg, var(--primary), var(--primary-dark)) !important;
    color: white !important;
    padding: 10px !important;
}

/* Tooltip customizado */
.fc-event-tooltip {
    animation: fadeInTooltip 0.3s ease;
}

@keyframes fadeInTooltip {
    from { opacity: 0; transform: translateY(5px); }
    to { opacity: 1; transform: translateY(0); }
}

:root[data-theme="dark"]{--primary:#8B5CF6;--primary-dark:#7C3AED;--secondary:#F472B6;--accent:#FBBF24;--success:#34D399;--danger:#F87171;--warning:#FBBF24;--info:#60A5FA;--bg-main:#0F172A;--bg-card:#1E293B;--bg-sidebar:#0F172A;--bg-sidebar-hover:#1E293B;--text-primary:#F1F5F9;--text-secondary:#CBD5E1;--text-muted:#94A3B8;--border-color:#334155;--shadow:0 4px 20px rgba(0,0,0,0.4);--shadow-hover:0 8px 30px rgba(139,92,246,0.3)}*{margin:0;padding:0;box-sizing:border-box}body,button,input,select,textarea{transition:background-color .2s ease,color .2s ease,border-color .2s ease}body{font-family:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:var(--bg-main);color:var(--text-primary);overflow-x:hidden;line-height:1.6}.auth-screen{min-height:100vh;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);padding:20px;animation:gradientAnimation 15s ease infinite;background-size:400% 400%}@keyframes gradientAnimation{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}.auth-box{background:rgba(255,255,255,0.98);-webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);border-radius:30px;padding:50px;max-width:500px;width:100%;box-shadow:0 30px 80px rgba(0,0,0,0.4);animation:slideUp 0.6s cubic-bezier(0.68,-0.55,0.265,1.55)}@keyframes slideUp{from{opacity:0;transform:translateY(50px) scale(0.9)}to{opacity:1;transform:translateY(0) scale(1)}}.auth-logo{text-align:center;margin-bottom:40px}.auth-logo .logo-icon{font-size:5rem;background:linear-gradient(135deg,#7C3AED,#EC4899);-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent;animation:pulse 2s ease-in-out infinite;filter:drop-shadow(0 5px 15px rgba(124,58,237,0.3))}@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}.auth-logo h2{font-weight:900;font-size:2.8rem;color:#1F2937;margin-top:20px;letter-spacing:2px}.auth-logo p{color:#6B7280;font-size:1.1rem;margin-top:10px;font-weight:500}.nav-pills .nav-link{border-radius:15px;font-weight:700;padding:12px 25px;transition:all .3s;color:#6B7280;border:none;background:transparent;cursor:pointer}.nav-pills .nav-link.active{background:linear-gradient(135deg,#7C3AED,#6D28D9);color:white;box-shadow:0 5px 20px rgba(124,58,237,0.4);transform:translateY(-2px)}.form-control,.form-select{border-radius:12px;border:2px solid #E5E7EB;padding:12px 18px;font-size:1rem;transition:all .3s;background:white;color:#1F2937}.form-control:focus,.form-select:focus{border-color:#7C3AED;box-shadow:0 0 0 5px rgba(124,58,237,0.1);outline:none;background:white}.alert{border-radius:15px;border:none;padding:15px 20px}.alert-info{background:linear-gradient(135deg,#E0E7FF,#DBEAFE);color:#1E40AF;border-left:5px solid #3B82F6}.alert-success{background:linear-gradient(135deg,#D1FAE5,#A7F3D0);color:#065F46;border-left:5px solid #10B981}.btn{border-radius:12px;padding:12px 30px;font-weight:700;border:none;cursor:pointer;transition:all .3s ease;display:inline-flex;align-items:center;gap:10px;font-size:1rem;text-transform:uppercase;letter-spacing:0.5px}.btn i{font-size:1.2rem}.btn-primary{background:linear-gradient(135deg,var(--primary),var(--primary-dark));color:#fff;box-shadow:0 5px 20px rgba(124,58,237,0.3)}.btn-primary:hover{transform:translateY(-3px);box-shadow:0 10px 30px rgba(124,58,237,0.5);color:#fff}.btn-success{background:linear-gradient(135deg,var(--success),#059669);color:#fff}.btn-success:hover{transform:translateY(-3px);color:#fff}.btn-danger{background:linear-gradient(135deg,var(--danger),#DC2626);color:#fff}.btn-outline{background:transparent;color:var(--primary);border:3px solid var(--primary)}.btn-outline:hover{background:var(--primary);color:#fff}.btn-secondary{background:#6B7280;color:#fff}.btn-sm{padding:8px 16px;font-size:0.85rem}.w-100{width:100%}.mt-3{margin-top:1rem}.mb-3{margin-bottom:1rem}#app{display:none}.sidebar{width:280px;background:var(--bg-sidebar);color:#fff;position:fixed;height:100vh;overflow-y:auto;z-index:1000;box-shadow:4px 0 25px rgba(0,0,0,0.2)}.sidebar::-webkit-scrollbar{width:8px}.sidebar::-webkit-scrollbar-track{background:rgba(255,255,255,0.05)}.sidebar::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.2);border-radius:4px}.sidebar-logo{padding:30px 20px;text-align:center;background:linear-gradient(135deg,var(--primary),var(--secondary));border-bottom:5px solid var(--accent)}.sidebar-logo h1{font-size:2.5rem;font-weight:900;letter-spacing:5px;margin:0;text-shadow:2px 2px 8px rgba(0,0,0,0.3)}.sidebar-logo p{font-size:1rem;opacity:0.95;margin:10px 0 0 0;letter-spacing:2px}.sidebar-menu{list-style:none;padding:20px 0}.sidebar-menu li a{display:flex;align-items:center;gap:12px;padding:14px 20px;color:rgba(255,255,255,0.85);text-decoration:none;transition:all .3s;border-left:5px solid transparent;font-weight:500;font-size:0.95rem}.sidebar-menu li a i{font-size:1.3rem;width:25px}.sidebar-menu li a:hover{background:var(--bg-sidebar-hover);color:#fff;border-left-color:var(--accent);padding-left:28px}.sidebar-menu li a.active{background:var(--bg-sidebar-hover);color:#fff;border-left-color:var(--primary);font-weight:700}.theme-toggle{padding:15px 20px;border-top:1px solid rgba(255,255,255,0.1)}.theme-toggle button{width:100%;padding:12px;background:rgba(255,255,255,0.1);border:2px solid rgba(255,255,255,0.2);border-radius:12px;color:#fff;font-weight:600;cursor:pointer;transition:all .3s;display:flex;align-items:center;justify-content:center;gap:10px}.main-content{margin-left:280px;padding:30px 40px 100px;min-height:100vh;overflow-y:auto;overflow-x:hidden}.main-content::-webkit-scrollbar{width:10px}.main-content::-webkit-scrollbar-track{background:var(--bg-main)}.main-content::-webkit-scrollbar-thumb{background:var(--primary);border-radius:5px}.content-section{display:none}.content-section.active{display:block;animation:fadeIn 0.4s ease}@keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}.page-header{margin-bottom:30px;padding-bottom:20px;border-bottom:3px solid var(--border-color);display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:20px}.page-header h1{font-size:2.2rem;font-weight:900;background:linear-gradient(135deg,var(--primary),var(--secondary));-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent;margin:0;display:flex;align-items:center;gap:15px}

/* Anima√ß√£o para transi√ß√£o de p√°ginas */
@keyframes slideInFromRight{
    from{opacity:0;transform:translateX(30px)}
    to{opacity:1;transform:translateX(0)}
}

@keyframes slideOutToLeft{
    from{opacity:1;transform:translateX(0)}
    to{opacity:0;transform:translateX(-30px)}
}

/* Anima√ß√£o para pulse do menu */
@keyframes pulseMenu{
    0%{transform:scale(1)}
    50%{transform:scale(1.05)}
    100%{transform:scale(1)}
}

/* Transi√ß√µes suaves para elementos */
.content-section{
    transition:opacity 0.3s ease,transform 0.3s ease;
}

.content-section.entering{
    animation:slideInFromRight 0.4s ease forwards;
}

.content-section.leaving{
    animation:slideOutToLeft 0.3s ease forwards;
}

/* Transi√ß√£o suave para sub-tabs */
.sub-tab-btn{
    transition:all 0.3s cubic-bezier(0.4,0,0.2,1);
}

.sub-tab-btn:hover{
    transform:translateY(-2px);
}

/* Melhorias para o calend√°rio */
.fc-button{
    transition:all 0.3s ease !important;
}

.fc-button:hover{
    transform:translateY(-2px) !important;
    box-shadow:0 5px 15px rgba(124,58,237,0.3) !important;
}

/* ========== BOT√ïES DE REFRESH MANUAL COM ANIMA√á√ÉO ========== */
.btn-refresh{
    position:relative;
    overflow:hidden;
    transition:all 0.3s ease;
}

.btn-refresh i{
    transition:transform 0.6s ease;
}

.btn-refresh:hover{
    transform:translateY(-2px);
    box-shadow:0 6px 20px rgba(124,58,237,0.4);
}

.btn-refresh.refreshing{
    pointer-events:none;
    opacity:0.7;
}

.btn-refresh.refreshing i{
    animation:spinRefresh 1s linear infinite;
}

/* Ripple effect removido do btn-refresh */

@keyframes spinRefresh{
    from{
        transform:rotate(0deg);
    }
    to{
        transform:rotate(360deg);
    }
}

.spin {
    animation: spinRefresh 1s linear infinite;
    display: inline-block;
}

.btn-refresh-success{
    animation:successPulse 0.6s ease;
}

@keyframes successPulse{
    0%{
        transform:scale(1);
        box-shadow:0 0 0 0 rgba(52,211,153,0.7);
    }
    50%{
        transform:scale(1.05);
        box-shadow:0 0 0 10px rgba(52,211,153,0);
    }
    100%{
        transform:scale(1);
        box-shadow:0 0 0 0 rgba(52,211,153,0);
    }
}

.stat-card{background:var(--bg-card);border-radius:20px;padding:30px;box-shadow:var(--shadow);transition:all .3s;text-align:center;position:relative;overflow:hidden;border:2px solid var(--border-color)}.stat-card::before{content:'';position:absolute;top:0;left:0;width:100%;height:6px;background:linear-gradient(90deg,var(--primary),var(--secondary))}.stat-card:hover{transform:translateY(-10px);box-shadow:var(--shadow-hover);border-color:var(--primary)}.stat-card .icon{width:70px;height:70px;border-radius:18px;display:flex;align-items:center;justify-content:center;font-size:2rem;margin:0 auto 15px;background:linear-gradient(135deg,var(--primary),var(--primary-dark));color:#fff;box-shadow:0 10px 25px rgba(124,58,237,0.3)}.stat-card h3{font-size:3rem;font-weight:900;margin:15px 0 10px;background:linear-gradient(135deg,var(--primary),var(--secondary));-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent}.stat-card p{color:var(--text-secondary);font-size:1rem;font-weight:700;margin:0;text-transform:uppercase;letter-spacing:1px}.card{background:var(--bg-card);border-radius:20px;box-shadow:var(--shadow);margin-bottom:30px;overflow:visible;transition:all .3s;border:2px solid var(--border-color)}.card-header{background:linear-gradient(135deg,var(--primary),var(--primary-dark));color:#fff;padding:20px 30px;font-weight:800;font-size:1.2rem;display:flex;align-items:center;gap:12px}.card-body{padding:30px}table{width:100%;border-collapse:collapse;font-size:0.95rem}table thead th{background:linear-gradient(135deg,var(--primary),var(--primary-dark));color:#fff;padding:16px 14px;text-align:left;font-weight:800;text-transform:uppercase;letter-spacing:0.5px;font-size:0.85rem}table tbody tr{border-bottom:2px solid var(--border-color);transition:all .2s}table tbody tr:hover{background:var(--bg-main);transform:scale(1.01)}table tbody td{padding:16px 14px;vertical-align:middle;color:var(--text-primary)}.badge{padding:8px 16px;border-radius:20px;font-weight:800;font-size:0.8rem;display:inline-block;text-transform:uppercase;letter-spacing:0.5px}.badge.success{background:linear-gradient(135deg,var(--success),#059669);color:#fff}.badge.warning{background:linear-gradient(135deg,var(--warning),#F59E0B);color:#000}.badge.danger{background:linear-gradient(135deg,var(--danger),#DC2626);color:#fff}.spinner{
    width:40px;
    height:40px;
    margin:20px auto;
    border-radius:50%;
    background:linear-gradient(135deg,var(--primary),var(--secondary));
    animation:brightPulse 1.5s ease-in-out infinite;
    box-shadow:0 0 20px var(--primary);
    position:relative;
}
.spinner::before{
    content:'';
    position:absolute;
    top:-4px;
    left:-4px;
    right:-4px;
    bottom:-4px;
    border-radius:50%;
    background:linear-gradient(135deg,var(--primary),var(--secondary),var(--accent));
    z-index:-1;
    animation:glowPulse 1.5s ease-in-out infinite;
    opacity:0.6;
}
@keyframes brightPulse{
    0%,100%{
        transform:scale(1);
        box-shadow:0 0 20px var(--primary);
    }
    50%{
        transform:scale(1.15);
        box-shadow:0 0 40px var(--primary), 0 0 60px var(--secondary);
    }
}
@keyframes glowPulse{
    0%,100%{
        transform:scale(1);
        opacity:0.6;
    }
    50%{
        transform:scale(1.2);
        opacity:0.9;
    }
}.text-center{text-align:center}.text-muted{color:var(--text-secondary)}.text-success{color:var(--success)}.text-danger{color:var(--danger)}.autocomplete-results{position:fixed;background:var(--bg-card);border:2px solid var(--primary);border-radius:14px;margin-top:5px;max-height:400px;overflow-y:auto;z-index:99999999;box-shadow:0 10px 40px rgba(124,58,237,0.3);display:none;min-width:300px}.autocomplete-results::-webkit-scrollbar{width:8px}.autocomplete-results::-webkit-scrollbar-track{background:var(--bg-main);border-radius:10px}.autocomplete-results::-webkit-scrollbar-thumb{background:var(--primary);border-radius:10px}.autocomplete-item{padding:14px 18px;border-bottom:1px solid var(--border-color);cursor:pointer;transition:all .2s ease;word-wrap:break-word;white-space:normal}.autocomplete-item:hover{background:linear-gradient(135deg,rgba(124,58,237,0.1),rgba(236,72,153,0.1));transform:translateX(5px);border-left:4px solid var(--primary)}.autocomplete-item:last-child{border-bottom:none}.autocomplete-item strong{color:var(--primary);font-size:1.05rem;display:block;margin-bottom:5px}.autocomplete-item small{color:var(--text-secondary);font-size:0.9rem;display:block}.row{display:flex;flex-wrap:wrap;margin:0 -15px}.row.g-4>*{padding:0 15px;margin-bottom:25px}[class^="col-"]{padding:0 15px}.col-12{width:100%}@media (min-width:768px){.col-md-6{width:50%}.col-md-4{width:33.333%}.col-md-3{width:25%}.col-md-2{width:16.666%}}@media (min-width:992px){.col-lg-3{width:25%}.col-lg-4{width:33.333%}.col-lg-6{width:50%}}
            .global-search-container{margin-bottom:24px;background:var(--bg-card);border-radius:18px;padding:20px;box-shadow:var(--shadow);position:relative}
        .global-search-field{display:flex;gap:12px;align-items:center}
        .global-search-field .bi-search{font-size:1.4rem;color:var(--primary)}
        .global-search-input{flex:1;border:2px solid var(--border-color);border-radius:14px;padding:12px 18px;font-size:1rem;background:var(--bg-main);color:var(--text-primary)}
        .global-search-input:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(124,58,237,0.15)}
        .global-search-results{position:absolute;top:100%;left:0;right:0;background:var(--bg-card);border-radius:16px;box-shadow:var(--shadow);margin-top:12px;max-height:320px;overflow-y:auto;display:none;z-index:9999;padding:12px}
        .global-search-results.active{display:block}
        .global-search-section{margin-bottom:14px}
        .global-search-section h6{font-size:0.75rem;text-transform:uppercase;font-weight:700;color:var(--text-muted);margin:8px 0}
        .global-search-item{border-radius:12px;padding:10px 12px;cursor:pointer;transition:all .2s;display:flex;flex-direction:column;gap:4px;border:1px solid transparent}
        .global-search-item:hover{background:rgba(124,58,237,0.08);border-color:rgba(124,58,237,0.25)}
        .global-search-item strong{color:var(--text-primary);font-size:0.95rem}
        .global-search-item span{color:var(--text-secondary);font-size:0.8rem}
        .highlight-row{animation:blinkHighlight 2s ease-in-out 0s 2 alternate}
        @keyframes blinkHighlight{from{background:rgba(59,130,246,0.15)}to{background:transparent}}
        .stock-summary-card{background:var(--bg-card);border-radius:18px;padding:24px;box-shadow:var(--shadow);height:100%}
        .stock-summary-card h3{font-size:2.1rem;font-weight:800;margin:0;color:var(--primary)}
        .stock-summary-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:18px;margin-top:20px}
        .stock-summary-metric{background:var(--bg-main);border-radius:14px;padding:16px;border:1px solid var(--border-color)}
        .stock-summary-metric strong{display:block;font-size:0.8rem;text-transform:uppercase;color:var(--text-muted);margin-bottom:6px}
        .stock-summary-metric span{font-size:1.2rem;font-weight:700;color:var(--text-primary)}
        .estoque-actions{display:flex;flex-wrap:wrap;gap:12px;align-items:center}
        .badge.neutral{background:rgba(107,114,128,0.15);color:#374151}
        .logo-preview-card{background:var(--bg-card);border-radius:18px;padding:20px;box-shadow:var(--shadow);text-align:center;height:100%;position:relative}
        .logo-preview-card button{margin-top:12px}
        .logo-preview{width:100%;max-width:220px;height:120px;border-radius:16px;background:var(--bg-main);border:2px dashed var(--border-color);display:flex;align-items:center;justify-content:center;margin:0 auto 12px;overflow:hidden}
        .logo-preview img{max-width:100%;max-height:100%;object-fit:contain}
        /* ========== COMUNIDADE - REDESIGN COLORIDO E ANIMADO ========== */
        .community-hero {
            background: linear-gradient(135deg, #8B5CF6 0%, #EC4899 50%, #F59E0B 100%);
            background-size: 200% 200%;
            animation: gradientShift 8s ease infinite;
            border-radius: 25px;
            padding: 45px 40px;
            color: #fff;
            box-shadow: 0 20px 60px rgba(139, 92, 246, 0.4);
            margin-bottom: 30px;
            position: relative;
            overflow: hidden;
        }

        .community-hero::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: rotate 20s linear infinite;
        }

        .community-hero h2 {
            font-weight: 900;
            margin-bottom: 12px;
            font-size: 2.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
            position: relative;
            z-index: 1;
            animation: slideInLeft 0.6s ease;
        }

        .community-hero p {
            opacity: 0.95;
            font-size: 1.2rem;
            margin-bottom: 20px;
            position: relative;
            z-index: 1;
            animation: slideInLeft 0.8s ease;
        }

        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        @keyframes slideInLeft {
            from { opacity: 0; transform: translateX(-30px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .community-pill {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            background: rgba(255, 255, 255, 0.25);
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            color: #fff;
            padding: 10px 18px;
            border-radius: 999px;
            font-size: 0.9rem;
            font-weight: 600;
            margin-right: 12px;
            margin-bottom: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            animation: popIn 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            animation-fill-mode: both;
            position: relative;
            z-index: 1;
            transition: all 0.3s ease;
        }

        .community-pill:nth-child(4) { animation-delay: 0.1s; }
        .community-pill:nth-child(5) { animation-delay: 0.2s; }
        .community-pill:nth-child(6) { animation-delay: 0.3s; }

        .community-pill:hover {
            transform: scale(1.1) translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }

        .community-pill i {
            font-size: 1.1rem;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes popIn {
            0% { opacity: 0; transform: scale(0.5); }
            100% { opacity: 1; transform: scale(1); }
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .community-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-top: 25px;
        }

        .community-card {
            background: linear-gradient(135deg, var(--bg-card) 0%, var(--bg-main) 100%);
            border-radius: 22px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            height: 100%;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            border: 2px solid transparent;
            animation: fadeInUp 0.6s ease;
            animation-fill-mode: both;
        }

        .community-card:nth-child(1) {
            animation-delay: 0.1s;
            border-color: #10B981;
        }

        .community-card:nth-child(2) {
            animation-delay: 0.2s;
            border-color: #F59E0B;
        }

        .community-card:nth-child(3) {
            animation-delay: 0.3s;
            border-color: #8B5CF6;
        }

        .community-card:nth-child(4) {
            animation-delay: 0.4s;
            border-color: #EC4899;
        }

        .community-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 6px;
            background: linear-gradient(90deg, #10B981, #8B5CF6, #EC4899, #F59E0B);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .community-card:hover {
            transform: translateY(-12px) scale(1.02);
            box-shadow: 0 20px 60px rgba(139, 92, 246, 0.3);
            border-color: var(--primary);
        }

        .community-card:hover::before {
            opacity: 1;
        }

        .community-card h5 {
            font-weight: 800;
            margin-bottom: 15px;
            font-size: 1.4rem;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .community-card h5 i {
            font-size: 1.8rem;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: iconBounce 2s ease-in-out infinite;
        }

        .community-card:hover h5 i {
            animation: iconSpin 0.6s ease;
        }

        .community-card p {
            color: var(--text-secondary);
            margin-bottom: 20px;
            line-height: 1.7;
            font-size: 1rem;
        }

        .community-card ul {
            list-style: none;
            padding: 0;
            margin-bottom: 20px;
        }

        .community-card ul li {
            padding: 8px 0;
            padding-left: 30px;
            position: relative;
            color: var(--text-primary);
            line-height: 1.6;
        }

        .community-card ul li::before {
            content: '‚úì';
            position: absolute;
            left: 0;
            top: 8px;
            width: 20px;
            height: 20px;
            background: linear-gradient(135deg, #10B981, #059669);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.75rem;
        }

        .community-card .btn {
            width: 100%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            padding: 14px 25px;
            font-weight: 700;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .community-card .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.6s ease, height 0.6s ease;
        }

        .community-card .btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .community-card .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(139, 92, 246, 0.4);
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(40px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes iconBounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        @keyframes iconSpin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* === CORRE√á√ÉO RENDERIZA√á√ÉO DAS ABAS === */
        #section-clube, #section-importar, #section-sistema, #section-auditoria, #section-configuracoes {
            overflow: auto !important;
            max-width: 100% !important;
        }

        /* ================================================================ */
        /* === CONTROLE DE VISIBILIDADE DAS SE√á√ïES - CORRIGIDO === */
        /* ================================================================ */

        /* Classe utilit√°ria para esconder elementos */
        .d-none {
            display: none !important;
            visibility: hidden !important;
            pointer-events: none !important;
            position: absolute !important;
            left: -9999px !important;
            z-index: -1 !important;
        }

        /* Garantir que apenas se√ß√µes ativas sejam exibidas */
        .content-section {
            display: none !important;
            visibility: hidden !important;
            pointer-events: none !important;
        }

        .content-section.active {
            display: block !important;
            visibility: visible !important;
            height: auto !important;
            overflow: auto !important;
            position: relative !important;
            left: 0 !important;
            opacity: 1 !important;
            pointer-events: auto !important;
            z-index: 1 !important;
        }

        .sub-tab-content {
            display: none !important;
        }

        .sub-tab-content.active {
            display: block !important;
            height: auto !important;
            overflow: revert !important;
            position: relative !important;
            left: 0 !important;
            opacity: 1 !important;
            visibility: visible !important;
        }

        /* === SUB-TABS SYSTEM === */
        .sub-tabs{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:24px;padding:12px;background:var(--bg-card);border-radius:16px;box-shadow:var(--shadow);border:2px solid var(--border-color)}
        .sub-tab,.sub-tab-btn{padding:12px 24px;border-radius:12px;font-weight:700;font-size:0.9rem;cursor:pointer;transition:all .3s ease;border:2px solid transparent;background:var(--bg-main);color:var(--text-secondary);text-transform:uppercase;letter-spacing:0.5px;white-space:nowrap}
        .sub-tab:hover,.sub-tab-btn:hover{background:rgba(124,58,237,0.1);color:var(--primary);border-color:var(--primary);transform:translateY(-2px)}
        .sub-tab.active,.sub-tab-btn.active{background:linear-gradient(135deg,var(--primary),var(--primary-dark));color:#fff;border-color:var(--primary);box-shadow:0 5px 15px rgba(124,58,237,0.4);transform:translateY(-2px)}
        .sub-tab-content{display:none;animation:fadeInContent 0.4s ease}
        .sub-tab-content.active{display:block}
        @keyframes fadeInContent{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}

        /* Fotos de perfil profissionais */
        .foto-profissional-container{position:relative;display:inline-block}
        .foto-profissional{width:80px;height:80px;border-radius:50%;object-fit:cover;border:4px solid var(--primary);box-shadow:0 5px 15px rgba(124,58,237,0.3);cursor:pointer;transition:all .3s}
        .foto-profissional:hover{transform:scale(1.1);box-shadow:0 8px 25px rgba(124,58,237,0.5)}
        .foto-upload-btn{position:absolute;bottom:0;right:0;background:var(--primary);color:#fff;border:none;border-radius:50%;width:30px;height:30px;display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 3px 10px rgba(0,0,0,0.3)}

        /* Mapa de Calor */
        .mapa-calor-container{background:var(--bg-card);border-radius:18px;padding:24px;box-shadow:var(--shadow)}
        .mapa-calor-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:12px;margin-top:20px}
        .mapa-dia{background:var(--bg-main);border-radius:12px;padding:16px;text-align:center;border:2px solid var(--border-color);transition:all .3s}
        .mapa-dia:hover{transform:scale(1.05);box-shadow:0 5px 15px rgba(0,0,0,0.1)}
        .mapa-dia-header{font-size:0.85rem;font-weight:700;color:var(--text-muted);margin-bottom:8px}
        .mapa-dia-data{font-size:0.75rem;color:var(--text-secondary);margin-bottom:12px}
        .mapa-dia-valor{font-size:2rem;font-weight:900;color:var(--primary)}
        .intensidade-1{border-left:5px solid #DCFCE7}
        .intensidade-2{border-left:5px solid #86EFAC}
        .intensidade-3{border-left:5px solid #4ADE80}
        .intensidade-4{border-left:5px solid #22C55E}
        .intensidade-5{border-left:5px solid #16A34A;background:linear-gradient(135deg,rgba(22,163,74,0.1),rgba(34,197,94,0.2))}

        /* Formul√°rios Anamnese/Prontu√°rio */
        .form-anamnese,.form-prontuario{background:var(--bg-card);border-radius:18px;padding:30px;box-shadow:var(--shadow);margin-bottom:20px}
        .form-section-title{font-size:1.3rem;font-weight:800;color:var(--primary);margin:25px 0 15px;padding-bottom:10px;border-bottom:3px solid var(--border-color)}
        .form-group-inline{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px;margin-bottom:20px}
        .form-label-custom{display:block;font-weight:700;margin-bottom:8px;color:var(--text-primary);font-size:0.95rem}
        .form-textarea-custom{width:100%;min-height:120px;border-radius:12px;border:2px solid var(--border-color);padding:14px;font-family:inherit;resize:vertical;transition:all .3s}
        .form-textarea-custom:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 4px rgba(124,58,237,0.1)}

        /* Loading States */
        .loading-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:99999;-webkit-backdrop-filter: blur(5px);
            backdrop-filter: blur(5px)}
        .loading-content{background:var(--bg-card);padding:40px;border-radius:20px;text-align:center;box-shadow:0 15px 50px rgba(0,0,0,0.5)}
        .loading-spinner-large{
            width:60px;
            height:60px;
            margin:0 auto 20px;
            border-radius:50%;
            background:linear-gradient(135deg,var(--primary),var(--secondary));
            animation:brightPulse 1.5s ease-in-out infinite;
            box-shadow:0 0 30px var(--primary);
            position:relative;
        }
        .loading-spinner-large::before{
            content:'';
            position:absolute;
            top:-6px;
            left:-6px;
            right:-6px;
            bottom:-6px;
            border-radius:50%;
            background:linear-gradient(135deg,var(--primary),var(--secondary),var(--accent));
            z-index:-1;
            animation:glowPulse 1.5s ease-in-out infinite;
            opacity:0.6;
        }

        /* ========== CORRE√á√ÉO OVERFLOW/SCROLL ========== */
        .content-section{padding:20px}
        .content-section::-webkit-scrollbar{width:8px}
        .content-section::-webkit-scrollbar-thumb{background:#888;border-radius:4px}
        /* REMOVIDO :hover para evitar piscar */
        .table-responsive{max-height:600px;overflow-y:auto;margin-bottom:20px}
        .table-responsive::-webkit-scrollbar{width:6px}
        .table-responsive::-webkit-scrollbar-thumb{background:var(--primary);border-radius:3px}
        .row{margin-left:-10px;margin-right:-10px}
        .col-md-3,.col-md-4,.col-md-6{padding-left:10px;padding-right:10px}

        /* ========== OTIMIZA√á√ïES DE PERFORMANCE ========== */
        /* Remove transform em hover de tabelas para evitar travamentos */
        table tbody tr:hover {
            background: var(--bg-main) !important;
            transform: none !important; /* Remove scale que causa reflow */
        }

        /* Hardware acceleration para elementos animados */
        .stat-card, .btn, .sidebar-menu li a {
            will-change: transform;
            transform: translate3d(0, 0, 0); /* Force GPU */
        }

        /* Otimizar scrollbar para evitar jank */
        .main-content {
            scrollbar-width: thin;
            scrollbar-color: var(--primary) var(--bg-main);
        }

        /* Reduzir uso de backdrop-filter (caro para performance) */
        .auth-box {
            backdrop-filter: none !important;
        }

        /* Smooth scrolling sem impacto de performance */
        * {
            scroll-behavior: smooth;
        }

        /* Containment para melhor performance */
        .card, .stat-card {
            contain: layout style paint;
        }

        /* ========== FIX SCROLL PISCANDO ========== */
        /* Remover TODOS os efeitos hover das scrollbars */
        *::-webkit-scrollbar-thumb:hover,
        *::-webkit-scrollbar-track:hover,
        *::-webkit-scrollbar:hover {
            /* Sem mudan√ßas no hover */
        }

        /* Estabilizar scrollbars */
        *::-webkit-scrollbar {
            background: transparent;
        }

        *::-webkit-scrollbar-thumb {
            transition: none !important; /* Sem transi√ß√µes */
        }

        *::-webkit-scrollbar-track {
            transition: none !important; /* Sem transi√ß√µes */
        }

        /* Sub-tabs System */
        .sub-tabs{display:flex;gap:12px;margin-bottom:30px;border-bottom:3px solid var(--border-color);padding-bottom:0;flex-wrap:wrap}
        .sub-tab-btn{background:transparent;border:none;padding:14px 24px;font-weight:700;font-size:0.95rem;color:var(--text-secondary);cursor:pointer;border-bottom:4px solid transparent;transition:all .3s;display:flex;align-items:center;gap:8px;position:relative;bottom:-3px}
        .sub-tab-btn:hover{color:var(--primary);background:rgba(124,58,237,0.05)}
        .sub-tab-btn.active{color:var(--primary);border-bottom-color:var(--primary);background:rgba(124,58,237,0.08)}
        .sub-tab-content{display:none;animation:fadeIn 0.4s ease}
        .sub-tab-content.active{display:block}

        /* ========== IMPROVED ACTION BUTTONS (Directive 9) ========== */
        /* Enhanced button styling for better UX across all tables and forms */

        /* Base action button improvements */
        table .btn-sm {
            min-width: 38px;
            height: 38px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 8px 12px;
            border-radius: 10px;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            border: 2px solid transparent;
        }

        /* Action button hover effects */
        table .btn-sm:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }

        table .btn-sm:active {
            transform: translateY(-1px) scale(1.02);
        }

        /* Edit/Primary button enhancement */
        table .btn-sm.btn-primary {
            background: linear-gradient(135deg, #3B82F6, #2563EB);
            border-color: #2563EB;
        }

        table .btn-sm.btn-primary:hover {
            background: linear-gradient(135deg, #2563EB, #1D4ED8);
            box-shadow: 0 8px 25px rgba(37, 99, 235, 0.4);
        }

        /* Delete/Danger button enhancement */
        table .btn-sm.btn-danger {
            background: linear-gradient(135deg, #EF4444, #DC2626);
            border-color: #DC2626;
        }

        table .btn-sm.btn-danger:hover {
            background: linear-gradient(135deg, #DC2626, #B91C1C);
            box-shadow: 0 8px 25px rgba(220, 38, 38, 0.4);
        }

        /* Info/View button enhancement */
        table .btn-sm.btn-info {
            background: linear-gradient(135deg, #3B82F6, #2563EB);
            border-color: #2563EB;
        }

        table .btn-sm.btn-info:hover {
            background: linear-gradient(135deg, #2563EB, #1D4ED8);
            box-shadow: 0 8px 25px rgba(37, 99, 235, 0.4);
        }

        /* Success button enhancement */
        table .btn-sm.btn-success {
            background: linear-gradient(135deg, #10B981, #059669);
            border-color: #059669;
        }

        table .btn-sm.btn-success:hover {
            background: linear-gradient(135deg, #059669, #047857);
            box-shadow: 0 8px 25px rgba(5, 150, 105, 0.4);
        }

        /* Warning button enhancement */
        table .btn-sm.btn-warning {
            background: linear-gradient(135deg, #F59E0B, #D97706);
            border-color: #D97706;
            color: #fff;
        }

        table .btn-sm.btn-warning:hover {
            background: linear-gradient(135deg, #D97706, #B45309);
            box-shadow: 0 8px 25px rgba(217, 119, 6, 0.4);
            color: #fff;
        }

        /* Button ripple effect removido */

        /* Button group spacing */
        table td .btn-sm {
            margin-right: 6px;
        }

        table td .btn-sm:last-child {
            margin-right: 0;
        }

        /* Icon sizing in action buttons */
        table .btn-sm i {
            font-size: 1.1rem;
        }

        /* Tooltip-like hover labels (optional enhancement) */
        table .btn-sm[title]:hover::after {
            content: attr(title);
            position: absolute;
            bottom: calc(100% + 8px);
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.75rem;
            white-space: nowrap;
            z-index: 1000;
            pointer-events: none;
            animation: tooltipFade 0.2s ease;
        }

        table .btn-sm[title]:hover::before {
            content: '';
            position: absolute;
            bottom: calc(100% + 2px);
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            pointer-events: none;
        }

        @keyframes tooltipFade {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(5px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        /* Responsive button adjustments */
        @media (max-width: 768px) {
            table .btn-sm {
                min-width: 32px;
                height: 32px;
                padding: 6px 10px;
            }

            table .btn-sm i {
                font-size: 1rem;
            }
        }

        /* ========== END ACTION BUTTONS ========== */

        /* ========== ANAMNESE & PRONTU√ÅRIO BUTTONS (Directive 10) ========== */
        /* Enhanced medical record buttons with professional healthcare styling */

        /* Nova Anamnese & Novo Prontu√°rio buttons */
        .card-header .btn.btn-success.float-end {
            background: linear-gradient(135deg, #10B981, #059669);
            border: none;
            padding: 10px 20px;
            border-radius: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .card-header .btn.btn-success.float-end:hover {
            background: linear-gradient(135deg, #059669, #047857);
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
        }

        .card-header .btn.btn-success.float-end:active {
            transform: translateY(0) scale(1.02);
        }

        .card-header .btn.btn-success.float-end i {
            font-size: 1.2rem;
        }

        /* Sub-tab buttons for Anamnese & Prontu√°rio */
        .sub-tab-btn[onclick*="anamnese"],
        .sub-tab-btn[onclick*="prontuario"] {
            position: relative;
            overflow: hidden;
        }

        .sub-tab-btn[onclick*="anamnese"]::before,
        .sub-tab-btn[onclick*="prontuario"]::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 3px;
            background: linear-gradient(180deg, #10B981, #059669);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .sub-tab-btn[onclick*="anamnese"].active::before,
        .sub-tab-btn[onclick*="prontuario"].active::before {
            opacity: 1;
        }

        .sub-tab-btn[onclick*="anamnese"].active,
        .sub-tab-btn[onclick*="prontuario"].active {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(5, 150, 105, 0.05));
            color: #059669;
            border-bottom-color: #10B981;
        }

        /* Anamnese/Prontu√°rio search buttons */
        button[onclick="buscarAnamnesesCliente()"],
        button[onclick="buscarProntuariosCliente()"] {
            background: linear-gradient(135deg, #3B82F6, #2563EB);
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 700;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        button[onclick="buscarAnamnesesCliente()"]:hover,
        button[onclick="buscarProntuariosCliente()"]:hover {
            background: linear-gradient(135deg, #2563EB, #1D4ED8);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
        }

        /* Table action buttons for anamnese/prontu√°rio */
        button[onclick*="visualizarAnamnese"],
        button[onclick*="visualizarProntuario"] {
            background: linear-gradient(135deg, #8B5CF6, #7C3AED);
            border: 2px solid #7C3AED;
            color: white;
            min-width: 100px;
            padding: 8px 16px;
            border-radius: 10px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        button[onclick*="visualizarAnamnese"]:hover,
        button[onclick*="visualizarProntuario"]:hover {
            background: linear-gradient(135deg, #7C3AED, #6D28D9);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(124, 58, 237, 0.4);
        }

        button[onclick*="deletarAnamnese"],
        button[onclick*="deletarProntuario"] {
            background: linear-gradient(135deg, #EF4444, #DC2626);
            border: 2px solid #DC2626;
            min-width: 100px;
        }

        /* Alert boxes in anamnese/prontu√°rio sections */
        #clientes-anamnese .alert-info,
        #clientes-prontuario .alert-info {
            background: linear-gradient(135deg, #DBEAFE, #BFDBFE);
            border-left: 5px solid #3B82F6;
            border-radius: 12px;
            padding: 18px 24px;
        }

        #clientes-anamnese .alert-info strong,
        #clientes-prontuario .alert-info strong {
            color: #1E40AF;
            font-size: 1.1rem;
        }

        /* Medical record cards */
        #anamnesesResultado .card,
        #prontuariosResultado .card {
            border: 2px solid #E0E7FF;
            box-shadow: 0 4px 20px rgba(124, 58, 237, 0.1);
        }

        #anamnesesResultado .card-header,
        #prontuariosResultado .card-header {
            background: linear-gradient(135deg, #8B5CF6, #7C3AED);
        }

        /* ========== END ANAMNESE & PRONTU√ÅRIO ========== */

        /* ========== ANIMATED COLOR SUB-TABS (New Directives) ========== */
        /* Red animated sub-tabs for critical/add actions */

        .sub-tab-red-animated {
            position: relative;
            overflow: hidden;
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(220, 38, 38, 0.05));
            border: 2px solid #EF4444;
            color: #DC2626;
            animation: pulse-red 2s ease-in-out infinite;
        }

        .sub-tab-red-animated::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(239, 68, 68, 0.3), transparent);
            animation: shine-red 3s infinite;
        }

        .sub-tab-red-animated:hover {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(220, 38, 38, 0.1));
            border-color: #DC2626;
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(239, 68, 68, 0.3);
        }

        .sub-tab-red-animated.active {
            background: linear-gradient(135deg, #EF4444, #DC2626);
            color: white;
            border-color: #DC2626;
            animation: none;
        }

        @keyframes pulse-red {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4);
            }
            50% {
                box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
            }
        }

        @keyframes shine-red {
            0% {
                left: -100%;
            }
            50%, 100% {
                left: 100%;
            }
        }

        /* Green animated sub-tabs for positive/add actions */

        .sub-tab-green-animated {
            position: relative;
            overflow: hidden;
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(5, 150, 105, 0.05));
            border: 2px solid #10B981;
            color: #059669;
            animation: pulse-green 2s ease-in-out infinite;
        }

        .sub-tab-green-animated::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(16, 185, 129, 0.3), transparent);
            animation: shine-green 3s infinite;
        }

        .sub-tab-green-animated:hover {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(5, 150, 105, 0.1));
            border-color: #059669;
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(16, 185, 129, 0.3);
        }

        .sub-tab-green-animated.active {
            background: linear-gradient(135deg, #10B981, #059669);
            color: white;
            border-color: #059669;
            animation: none;
        }

        @keyframes pulse-green {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4);
            }
            50% {
                box-shadow: 0 0 0 10px rgba(16, 185, 129, 0);
            }
        }

        @keyframes shine-green {
            0% {
                left: -100%;
            }
            50%, 100% {
                left: 100%;
            }
        }

        /* ========== END ANIMATED COLOR SUB-TABS ========== */

        /* ISOLAMENTO DAS SE√á√ïES - Otimizado para Performance */
        .content-section:not(.active) {
            display: none !important;
            /* Removido visibility e pointer-events de * para evitar reflow massivo */
        }

        .content-section.active {
            display: block !important;
        }

        /* PROTE√á√ÉO ESPEC√çFICA PARA SE√á√ÉO DE ESTOQUE */
        #section-estoque:not(.active),
        #section-estoque:not(.active) * {
            display: none !important;
            visibility: hidden !important;
            pointer-events: none !important;
            position: absolute !important;
            left: -9999px !important;
            top: -9999px !important;
            opacity: 0 !important;
        }

        /* Garantir que apenas se√ß√£o ativa de estoque seja vis√≠vel */
        #section-estoque.active {
            display: block !important;
            visibility: visible !important;
            position: relative !important;
            left: 0 !important;
            top: 0 !important;
            opacity: 1 !important;
        }

        /* ========== MOBILE RESPONSIVE DESIGN ========== */
        /* Tablets e telas m√©dias */
        @media (max-width: 992px) {
            .page-header h1 {
                font-size: 1.8rem;
            }

            .stat-card h3 {
                font-size: 2.5rem;
            }

            .card-header {
                font-size: 1rem;
                padding: 15px 20px;
            }

            table {
                font-size: 0.85rem;
            }

            table thead th,
            table tbody td {
                padding: 12px 10px;
            }
        }

        /* Mobile - Smartphones */
        @media (max-width: 768px) {
            /* Layout geral */
            .main-content {
                margin-left: 0 !important;
                padding: 15px !important;
            }

            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
                z-index: 999;
            }

            /* Tela de login */
            .auth-box {
                padding: 30px 20px;
                border-radius: 20px;
            }

            .auth-logo .logo-icon {
                font-size: 4rem;
            }

            .auth-logo h2 {
                font-size: 2rem;
            }

            /* Headers e t√≠tulos */
            .page-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }

            .page-header h1 {
                font-size: 1.5rem;
            }

            /* Cards de estat√≠sticas */
            .stat-card {
                padding: 20px;
            }

            .stat-card .icon {
                width: 50px;
                height: 50px;
                font-size: 1.5rem;
            }

            .stat-card h3 {
                font-size: 2rem;
            }

            /* Bot√µes maiores para touch */
            .btn {
                padding: 14px 24px;
                font-size: 0.95rem;
                min-height: 48px; /* Tamanho m√≠nimo para touch */
            }

            .btn-sm {
                padding: 10px 18px;
                min-height: 44px;
            }

            /* Formul√°rios */
            .form-control,
            .form-select {
                padding: 14px 16px;
                font-size: 16px; /* Previne zoom no iOS */
                min-height: 48px;
            }

            /* Sub-tabs */
            .sub-tabs {
                flex-direction: column;
                gap: 10px;
            }

            .sub-tab,
            .sub-tab-btn {
                width: 100%;
                text-align: center;
                padding: 12px 16px;
            }

            /* Tabelas responsivas */
            .table-responsive {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch; /* Smooth scrolling no iOS */
            }

            table {
                min-width: 600px; /* For√ßa scroll horizontal */
                font-size: 0.8rem;
            }

            table thead th,
            table tbody td {
                padding: 10px 8px;
                white-space: nowrap;
            }

            /* Cards */
            .card {
                border-radius: 15px;
                margin-bottom: 20px;
            }

            .card-header {
                padding: 15px;
                font-size: 0.95rem;
            }

            .card-body {
                padding: 15px;
            }

            /* Modais do SweetAlert */
            .swal2-popup {
                width: 90% !important;
                padding: 20px !important;
            }

            .swal2-title {
                font-size: 1.3rem !important;
            }

            .swal2-html-container {
                font-size: 0.9rem !important;
            }

            /* Busca global */
            .global-search-container {
                padding: 15px;
            }

            .global-search-input {
                font-size: 16px; /* Previne zoom no iOS */
            }

            /* Sidebar menu items */
            .sidebar-menu li a {
                padding: 16px 20px; /* Maior para touch */
                font-size: 0.95rem;
            }

            /* Grid responsivo */
            .row.g-4 > * {
                padding: 0 10px;
                margin-bottom: 15px;
            }

            [class^="col-"] {
                padding: 0 10px;
            }
        }

        /* Mobile pequeno - Smartphones pequenos */
        @media (max-width: 480px) {
            .main-content {
                padding: 10px !important;
            }

            .page-header h1 {
                font-size: 1.3rem;
            }

            .stat-card h3 {
                font-size: 1.8rem;
            }

            .stat-card .icon {
                width: 45px;
                height: 45px;
                font-size: 1.3rem;
            }

            .btn {
                padding: 12px 20px;
                font-size: 0.85rem;
                gap: 6px;
            }

            table {
                font-size: 0.75rem;
            }

            table thead th,
            table tbody td {
                padding: 8px 6px;
            }

            .badge {
                padding: 6px 12px;
                font-size: 0.7rem;
            }

            .auth-box {
                padding: 25px 15px;
            }

            .auth-logo h2 {
                font-size: 1.8rem;
            }

            .nav-pills .nav-link {
                padding: 10px 16px;
                font-size: 0.85rem;
            }
        }

        /* Landscape mode em mobile */
        @media (max-height: 500px) and (orientation: landscape) {
            .auth-screen {
                padding: 10px;
            }

            .auth-box {
                padding: 20px;
                max-width: 90%;
            }

            .auth-logo .logo-icon {
                font-size: 3rem;
            }

            .auth-logo h2 {
                font-size: 1.5rem;
                margin-top: 10px;
            }
        }

        /* Touch device optimizations */
        @media (hover: none) and (pointer: coarse) {
            /* Remove hover effects em dispositivos touch */
            .sidebar-menu li a:hover {
                padding-left: 20px; /* Remove slide effect */
            }

            .stat-card:hover {
                transform: none; /* Remove lift effect */
            }

            .btn-primary:hover,
            .btn-success:hover,
            .btn:hover {
                transform: none;
            }

            /* Aumentar √°rea clic√°vel de bot√µes pequenos */
            .btn-sm {
                padding: 12px 20px;
                min-height: 48px;
            }

            /* Feedback visual para touch */
            button:active,
            .btn:active,
            a:active {
                opacity: 0.7;
                transform: scale(0.98);
            }
        }

        /* ========== LOGO PERSONALIZADO: DIN√ÇMICO E SEM FUNDO ========== */
        .sidebar-logo {
            padding: 20px !important;
            display: flex !important;
            flex-direction: column !important;
            justify-content: center !important;
            align-items: center !important;
            background: var(--bg-sidebar) !important; /* Fundo da sidebar sem gradiente */
            border-bottom: none !important; /* Remove borda */
            min-height: 200px !important;
            max-height: none !important;
            overflow: visible !important;
            transition: all 0.3s ease !important;
        }

        #sidebarLogoImage {
            width: 90%;
            max-width: 200px;
            height: auto;
            object-fit: contain;
            display: block;
            margin: 0 auto;
            padding: 15px;
            background: transparent !important;
            border-radius: 50% !important;
            box-shadow:
                0 4px 15px rgba(0,0,0,0.2),
                0 0 20px rgba(255, 255, 255, 0.1),
                0 0 40px rgba(124, 58, 237, 0.2);
            position: relative;
            animation: logoGlamourGlow 2s ease-in-out infinite;
        }

        /* ‚ú® EFEITO GLAMOUR ESTRELADO - M√∫ltiplas estrelas cintilantes ‚ú® */
        #sidebarLogoImage::before,
        #sidebarLogoImage::after {
            content: '‚ú®';
            position: absolute;
            font-size: 25px;
            pointer-events: none;
            animation: sparkleGlamour 2s ease-in-out infinite;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.8);
        }

        #sidebarLogoImage::before {
            top: -10px;
            right: -10px;
            animation-delay: 0s;
        }

        #sidebarLogoImage::after {
            bottom: -10px;
            left: -10px;
            animation-delay: 1s;
        }

        /* Brilho glamour cont√≠nuo */
        @keyframes logoGlamourGlow {
            0%, 100% {
                filter: brightness(1) drop-shadow(0 0 8px rgba(124, 58, 237, 0.4));
                box-shadow:
                    0 4px 15px rgba(0,0,0,0.2),
                    0 0 20px rgba(255, 255, 255, 0.1),
                    0 0 40px rgba(124, 58, 237, 0.2);
            }
            25% {
                filter: brightness(1.15) drop-shadow(0 0 15px rgba(236, 72, 153, 0.6));
                box-shadow:
                    0 4px 15px rgba(0,0,0,0.2),
                    0 0 30px rgba(255, 255, 255, 0.3),
                    0 0 60px rgba(236, 72, 153, 0.4);
            }
            50% {
                filter: brightness(1.3) drop-shadow(0 0 20px rgba(245, 158, 11, 0.7));
                box-shadow:
                    0 4px 15px rgba(0,0,0,0.2),
                    0 0 40px rgba(255, 255, 255, 0.4),
                    0 0 80px rgba(245, 158, 11, 0.5);
            }
            75% {
                filter: brightness(1.15) drop-shadow(0 0 15px rgba(124, 58, 237, 0.6));
                box-shadow:
                    0 4px 15px rgba(0,0,0,0.2),
                    0 0 30px rgba(255, 255, 255, 0.3),
                    0 0 60px rgba(124, 58, 237, 0.4);
            }
        }

        /* Cintila√ß√£o das estrelas ‚ú® */
        @keyframes sparkleGlamour {
            0%, 100% {
                opacity: 0;
                transform: scale(0) rotate(0deg);
            }
            25% {
                opacity: 1;
                transform: scale(1.2) rotate(90deg);
            }
            50% {
                opacity: 0.7;
                transform: scale(0.8) rotate(180deg);
            }
            75% {
                opacity: 1;
                transform: scale(1.3) rotate(270deg);
            }
        }

        /* ========== √çCONES COM BRILHO GLAMOUR ========== */
        .icon-glamour-shine {
            display: inline-block;
            animation: logoGlamourGlow 4s ease-in-out infinite;
            filter: brightness(1.1) drop-shadow(0 0 5px rgba(124, 58, 237, 0.3));
        }

        /* Varia√ß√£o de brilho suave para √≠cones */
        @keyframes iconGlamourShine {
            0%, 100% {
                filter: brightness(1) drop-shadow(0 0 3px rgba(124, 58, 237, 0.3));
                text-shadow: 0 0 5px rgba(124, 58, 237, 0.2);
            }
            25% {
                filter: brightness(1.2) drop-shadow(0 0 8px rgba(236, 72, 153, 0.5));
                text-shadow: 0 0 10px rgba(236, 72, 153, 0.4);
            }
            50% {
                filter: brightness(1.15) drop-shadow(0 0 6px rgba(139, 92, 246, 0.5));
                text-shadow: 0 0 8px rgba(139, 92, 246, 0.4);
            }
            75% {
                filter: brightness(1.2) drop-shadow(0 0 8px rgba(124, 58, 237, 0.5));
                text-shadow: 0 0 10px rgba(124, 58, 237, 0.4);
            }
        }

        /* Quando h√° logo personalizado, esconder texto */
        .sidebar-logo.has-custom-logo h1,
        .sidebar-logo.has-custom-logo p {
            display: none !important;
        }

        /* Quando N√ÉO h√° logo, mostrar texto normal */
        .sidebar-logo h1 {
            font-size: 2rem !important;
            margin: 0 !important;
        }

        .sidebar-logo p {
            font-size: 0.85rem !important;
            margin: 5px 0 0 0 !important;
        }

        /* ========== ANIMA√á√ïES MELHORADAS (PARTE 4.2) ========== */

        /* Anima√ß√µes de entrada suaves */
        @keyframes slideInFromLeft {
            from {
                opacity: 0;
                transform: translateX(-30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes slideInFromRight {
            from {
                opacity: 0;
                transform: translateX(30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes slideInFromTop {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes bounceIn {
            0% {
                opacity: 0;
                transform: scale(0.3);
            }
            50% {
                opacity: 1;
                transform: scale(1.05);
            }
            70% {
                transform: scale(0.9);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* Aplicar anima√ß√µes aos elementos */
        .stat-card {
            animation: slideInFromTop 0.5s ease-out;
            animation-fill-mode: both;
        }

        .stat-card:nth-child(1) { animation-delay: 0.1s; }
        .stat-card:nth-child(2) { animation-delay: 0.2s; }
        .stat-card:nth-child(3) { animation-delay: 0.3s; }
        .stat-card:nth-child(4) { animation-delay: 0.4s; }

        .card {
            animation: slideInFromLeft 0.6s ease-out;
        }

        .sidebar-menu li {
            animation: slideInFromLeft 0.5s ease-out;
            animation-fill-mode: both;
        }

        .sidebar-menu li:nth-child(1) { animation-delay: 0.1s; }
        .sidebar-menu li:nth-child(2) { animation-delay: 0.15s; }
        .sidebar-menu li:nth-child(3) { animation-delay: 0.2s; }
        .sidebar-menu li:nth-child(4) { animation-delay: 0.25s; }
        .sidebar-menu li:nth-child(5) { animation-delay: 0.3s; }

        /* Hover animations */
        .btn {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        /* Anima√ß√£o de entrada suave para cards */
        .stat-card, .card {
            animation: fadeInUp 0.5s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Toast notification animations */
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(400px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes slideOutRight {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(400px);
            }
        }

        /* Micro-intera√ß√£o nos bot√µes */
        .btn {
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:active::before {
            width: 300px;
            height: 300px;
        }

        /* Anima√ß√£o de pulsa√ß√£o para badges importantes */
        .badge.danger, .badge.warning {
            animation: subtlePulse 2s ease-in-out infinite;
        }

        @keyframes subtlePulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 0 0 8px rgba(239, 68, 68, 0);
            }
        }

        /* Loading spinner com rota√ß√£o suave */
        @keyframes smoothSpin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .spinner {
            animation: smoothSpin 0.8s cubic-bezier(0.4, 0, 0.2, 1) infinite !important;
        }

        /* === ANIMA√á√ïES PARA ALERTA DE ESTOQUE === */
        /* Anima√ß√£o fadeIn para card de alerta */
        @keyframes fadeInAlert {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Anima√ß√£o de pulso para badges cr√≠ticos (sobrescrever subtlePulse com mais destaque) */
        @keyframes pulseCritico {
            0% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
            }
            50% {
                box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
            }
        }

        /* Aplicar anima√ß√£o fadeIn ao card de alerta */
        #alertaEstoqueBaixo {
            animation: fadeInAlert 0.5s ease;
        }

        /* Pulso mais forte para badges de estoque cr√≠tico */
        #estoqueBaixoBody .badge.danger {
            animation: pulseCritico 2s infinite;
        }

        /* === BOT√ÉO DE TEMA NA TELA DE LOGIN === */
        .auth-theme-toggle {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.3rem;
            color: white;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .auth-theme-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1) rotate(15deg);
            box-shadow: 0 6px 20px rgba(124, 58, 237, 0.4);
        }

        .auth-theme-toggle i {
            transition: transform 0.3s ease;
        }

        /* === MELHORIAS DE DARK MODE (CONTRASTE E LEGIBILIDADE) === */

        /* ===== TELA DE LOGIN LIGHT MODE ===== */
        :root[data-theme="light"] .auth-screen {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #F472B6 100%) !important;
        }

        :root[data-theme="light"] .auth-box {
            background: rgba(255, 255, 255, 0.98) !important;
            border: 2px solid rgba(124, 58, 237, 0.1);
        }

        :root[data-theme="light"] .auth-logo h2 {
            color: #1F2937 !important;
        }

        :root[data-theme="light"] .auth-logo p {
            color: #6B7280 !important;
        }

        /* ===== TELA DE LOGIN DARK MODE - VERS√ÉO MELHORADA ===== */

        /* Fundo gradiente dark mode */
        :root[data-theme="dark"] .auth-screen {
            background: linear-gradient(135deg, #1e1b4b 0%, #312e81 50%, #4c1d95 100%) !important;
        }

        /* Box de login dark mode */
        :root[data-theme="dark"] .auth-box {
            background: rgba(15, 23, 42, 0.95) !important;
            border: 2px solid rgba(139, 92, 246, 0.5);
            box-shadow: 0 30px 80px rgba(0, 0, 0, 0.8), 0 0 50px rgba(139, 92, 246, 0.2) !important;
        }

        /* Logo e t√≠tulos */
        :root[data-theme="dark"] .auth-logo .logo-icon {
            background: linear-gradient(135deg, #A78BFA, #F472B6);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 5px 25px rgba(167, 139, 250, 0.5));
        }

        :root[data-theme="dark"] .auth-logo h2 {
            color: #F1F5F9 !important;
            text-shadow: 0 2px 20px rgba(167, 139, 250, 0.3);
        }

        :root[data-theme="dark"] .auth-logo p {
            color: #CBD5E1 !important;
        }

        /* Labels leg√≠veis */
        :root[data-theme="dark"] .login-label,
        :root[data-theme="dark"] .remember-label,
        :root[data-theme="dark"] label {
            color: #F1F5F9 !important;
            font-weight: 600;
        }

        /* Inputs no dark mode com melhor contraste */
        :root[data-theme="dark"] .auth-screen .form-control,
        :root[data-theme="dark"] .auth-screen .form-select,
        :root[data-theme="dark"] .auth-box .form-control,
        :root[data-theme="dark"] .auth-box .form-select {
            background: #0F172A !important;
            color: #F1F5F9 !important;
            border: 2px solid #475569 !important;
        }

        :root[data-theme="dark"] .auth-screen .form-control:focus,
        :root[data-theme="dark"] .auth-screen .form-select:focus,
        :root[data-theme="dark"] .auth-box .form-control:focus,
        :root[data-theme="dark"] .auth-box .form-select:focus {
            background: #1E293B !important;
            color: #F1F5F9 !important;
            border-color: #8B5CF6 !important;
            box-shadow: 0 0 0 4px rgba(139, 92, 246, 0.4) !important;
        }

        :root[data-theme="dark"] .auth-screen .form-control::placeholder,
        :root[data-theme="dark"] .auth-box .form-control::placeholder {
            color: #94A3B8 !important;
            opacity: 0.9;
        }

        /* Info box no dark mode */
        :root[data-theme="dark"] .info-box {
            background: rgba(59, 130, 246, 0.2) !important;
            color: #93C5FD !important;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        :root[data-theme="dark"] .info-code {
            background: rgba(139, 92, 246, 0.3);
            color: #E9D5FF;
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: 600;
        }

        /* Tabs no dark mode - mais vis√≠veis */
        :root[data-theme="dark"] .nav-pills .nav-link {
            color: #E2E8F0 !important;
            font-weight: 600;
        }

        :root[data-theme="dark"] .nav-pills .nav-link:hover {
            background: rgba(139, 92, 246, 0.2);
            color: #A78BFA !important;
        }

        :root[data-theme="dark"] .nav-pills .nav-link.active {
            background: linear-gradient(135deg, #8B5CF6, #7C3AED);
            color: white !important;
            box-shadow: 0 5px 20px rgba(139, 92, 246, 0.5);
        }

        /* Remember box no dark mode */
        :root[data-theme="dark"] .remember-box {
            background: rgba(139, 92, 246, 0.2);
            border: 2px solid rgba(139, 92, 246, 0.4);
        }

        :root[data-theme="dark"] .remember-label {
            color: #C4B5FD !important;
        }

        /* Bot√£o de alternar tema */
        :root[data-theme="dark"] .auth-theme-toggle {
            background: rgba(139, 92, 246, 0.3);
            border: 2px solid rgba(139, 92, 246, 0.5);
        }

        :root[data-theme="dark"] .auth-theme-toggle:hover {
            background: rgba(139, 92, 246, 0.5);
            box-shadow: 0 6px 20px rgba(139, 92, 246, 0.6);
        }

        :root[data-theme="dark"] .auth-theme-toggle i {
            color: #E9D5FF !important;
        }

        /* Alertas no dark mode */
        :root[data-theme="dark"] .alert-info {
            background: rgba(59, 130, 246, 0.2);
            color: #BFDBFE !important;
            border-left: 5px solid #3B82F6;
        }

        :root[data-theme="dark"] .alert-success {
            background: rgba(52, 211, 153, 0.2);
            color: #A7F3D0 !important;
            border-left: 5px solid #10B981;
        }

        /* Textos gerais na tela de login dark */
        :root[data-theme="dark"] .auth-screen *:not(i):not(.logo-icon),
        :root[data-theme="dark"] .auth-box *:not(i):not(.logo-icon) {
            color: inherit;
        }

        /* Melhorar contraste de textos em cards */
        :root[data-theme="dark"] .card-body {
            color: #F1F5F9;
        }

        :root[data-theme="dark"] table tbody td {
            color: #E2E8F0;
        }

        /* Badges mais vis√≠veis no dark mode */
        :root[data-theme="dark"] .badge {
            filter: brightness(1.3) saturate(1.2);
        }

        /* √çcones mais vis√≠veis */
        :root[data-theme="dark"] .bi {
            opacity: 0.95;
        }

        /* Melhorar legibilidade de h1, h2, h3 */
        :root[data-theme="dark"] h1,
        :root[data-theme="dark"] h2,
        :root[data-theme="dark"] h3,
        :root[data-theme="dark"] h4,
        :root[data-theme="dark"] h5,
        :root[data-theme="dark"] h6 {
            color: #F1F5F9 !important;
        }

        /* Melhorar contraste de labels */
        :root[data-theme="dark"] label {
            color: #E2E8F0 !important;
            font-weight: 600;
        }

        /* Autocomplete no dark mode */
        :root[data-theme="dark"] .autocomplete-item {
            color: #E2E8F0;
        }

        :root[data-theme="dark"] .autocomplete-item:hover {
            background: rgba(139, 92, 246, 0.2);
        }

        :root[data-theme="dark"] .autocomplete-item strong {
            color: #C4B5FD;
        }

        /* Melhorar contraste de c√≥digos e small texts */
        :root[data-theme="dark"] code {
            background: rgba(139, 92, 246, 0.2);
            color: #C4B5FD;
            padding: 2px 6px;
            border-radius: 4px;
        }

        :root[data-theme="dark"] small {
            color: #CBD5E1;
        }

        /* ========== SISTEMA DE MODAIS E BOT√ïES BIOMA v5.1.0 ========== */
/* ============================================================
   BIOMA UI SYSTEM v5.1.0 - Modais Bonitos + Bot√µes Modernos
   ============================================================ */

/* ========== TOAST NOTIFICATIONS (Toastify-style) ========== */
.bioma-toast-stack {
    position: fixed;
    top: 24px;
    right: 24px;
    z-index: 999999;
    display: flex;
    flex-direction: column;
    gap: 12px;
    pointer-events: none;
}

.bioma-toast {
    pointer-events: auto;
    background: var(--bg-card);
    color: var(--text);
    padding: 16px 20px;
    border-radius: 12px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15), 0 2px 8px rgba(0, 0, 0, 0.08);
    display: flex;
    align-items: center;
    gap: 12px;
    min-width: 320px;
    max-width: 420px;
    border-left: 4px solid;
    opacity: 0;
    transform: translateX(100px);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.bioma-toast-show {
    opacity: 1;
    transform: translateX(0);
}

.bioma-toast-exit {
    opacity: 0;
    transform: translateX(100px) scale(0.95);
}

.bioma-toast-success { border-left-color: #10B981; }
.bioma-toast-error { border-left-color: #EF4444; }
.bioma-toast-warning { border-left-color: #F59E0B; }
.bioma-toast-info { border-left-color: #3B82F6; }

.bioma-toast-icon {
    flex-shrink: 0;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.bioma-toast-success .bioma-toast-icon { color: #10B981; }
.bioma-toast-error .bioma-toast-icon { color: #EF4444; }
.bioma-toast-warning .bioma-toast-icon { color: #F59E0B; }
.bioma-toast-info .bioma-toast-icon { color: #3B82F6; }

.bioma-toast-message {
    flex: 1;
    font-weight: 500;
    font-size: 14px;
    line-height: 1.4;
}

.bioma-toast-close {
    background: none;
    border: none;
    color: var(--text-muted);
    cursor: pointer;
    padding: 4px;
    border-radius: 4px;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
}

.bioma-toast-close:hover {
    background: var(--bg-secondary);
    color: var(--text);
}

/* ========== MODAL OVERLAY ========== */
.bioma-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.65);
    backdrop-filter: blur(4px);
    -webkit-backdrop-filter: blur(4px);
    z-index: 99999;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
}

.bioma-modal-fade-in {
    animation: biomaFadeIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.bioma-modal-fade-out {
    animation: biomaFadeOut 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

@keyframes biomaFadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes biomaFadeOut {
    from { opacity: 1; }
    to { opacity: 0; }
}

/* ========== MODAL CONTENT ========== */
.bioma-modal {
    background: #FFFFFF;
    border-radius: 20px;
    padding: 0;
    max-width: 500px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
    overflow-x: hidden;
    box-shadow:
        0 25px 80px rgba(0, 0, 0, 0.5),
        0 10px 30px rgba(0, 0, 0, 0.3);
    text-align: center;
    border: none;
    position: relative;
}

.bioma-modal::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 6px;
    background: linear-gradient(90deg, #7C3AED, #3B82F6, #10B981, #F59E0B, #EF4444);
    border-radius: 20px 20px 0 0;
}

/* Dark mode modal */
:root[data-theme="dark"] .bioma-modal {
    background: #1E293B;
    box-shadow:
        0 25px 80px rgba(0, 0, 0, 0.8),
        0 10px 30px rgba(0, 0, 0, 0.5);
}

.bioma-modal-scale-in {
    animation: biomaScaleIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
}

.bioma-modal-scale-out {
    animation: biomaScaleOut 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

@keyframes biomaScaleIn {
    from {
        opacity: 0;
        transform: scale(0.9) translateY(-20px);
    }
    to {
        opacity: 1;
        transform: scale(1) translateY(0);
    }
}

@keyframes biomaScaleOut {
    from {
        opacity: 1;
        transform: scale(1) translateY(0);
    }
    to {
        opacity: 0;
        transform: scale(0.95) translateY(10px);
    }
}

.bioma-modal-header {
    padding: 40px 40px 0;
}

.bioma-modal-body {
    padding: 20px 40px 40px;
}

.bioma-modal-icon {
    margin: 0 auto 20px;
    width: 64px;
    height: 64px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    background: linear-gradient(135deg, #7C3AED 0%, #3B82F6 100%);
    box-shadow: 0 10px 30px rgba(124, 58, 237, 0.3);
    animation: biomaIconPulse 2s ease-in-out infinite;
}

.bioma-modal-icon svg {
    font-size: 32px;
    color: white;
}

@keyframes biomaIconPulse {
    0%, 100% { transform: scale(1); box-shadow: 0 10px 30px rgba(124, 58, 237, 0.3); }
    50% { transform: scale(1.05); box-shadow: 0 15px 40px rgba(124, 58, 237, 0.4); }
}

.bioma-modal-title {
    font-size: 24px;
    font-weight: 700;
    color: #1E293B;
    margin: 0 0 12px 0;
    line-height: 1.3;
}

:root[data-theme="dark"] .bioma-modal-title {
    color: #F1F5F9;
}

.bioma-modal-text {
    font-size: 15px;
    color: #64748B;
    margin: 0;
    line-height: 1.6;
}

:root[data-theme="dark"] .bioma-modal-text {
    color: #94A3B8;
}

.bioma-modal-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    justify-content: center;
    margin-top: 24px;
}

/* ========== LOADING MODAL ========== */
.bioma-modal-loading {
    padding: 40px;
    max-width: 320px;
}

.bioma-spinner {
    width: 56px;
    height: 56px;
    margin: 0 auto 20px;
    position: relative;
}

.bioma-spinner-circle {
    width: 100%;
    height: 100%;
    border: 4px solid var(--border-color);
    border-top-color: #7C3AED;
    border-radius: 50%;
    animation: biomaSpinnerRotate 0.8s linear infinite;
}

@keyframes biomaSpinnerRotate {
    to { transform: rotate(360deg); }
}

/* ========== SISTEMA DE BOT√ïES MODERNO ========== */

/* Reset de bot√µes */
.bioma-btn {
    position: relative;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 12px 24px;
    font-size: 15px;
    font-weight: 600;
    line-height: 1;
    border: none;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    text-decoration: none;
    font-family: inherit;
    white-space: nowrap;
    user-select: none;
    -webkit-user-select: none;
    overflow: hidden;
}

.bioma-btn:focus {
    outline: none;
    box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.3);
}

.bioma-btn:active {
    transform: scale(0.98);
}

.bioma-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none !important;
}

/* ========== VARIANTES DE BOT√ïES ========== */

/* Primary (Roxo) */
.bioma-btn-primary {
    background: linear-gradient(135deg, #7C3AED, #8B5CF6);
    color: white;
    box-shadow: 0 4px 12px rgba(124, 58, 237, 0.3);
}

.bioma-btn-primary:hover:not(:disabled) {
    background: linear-gradient(135deg, #6D28D9, #7C3AED);
    box-shadow: 0 6px 20px rgba(124, 58, 237, 0.4);
    transform: translateY(-2px);
}

/* Secondary (Cinza) */
.bioma-btn-secondary {
    background: var(--bg-secondary);
    color: var(--text);
    border: 2px solid var(--border-color);
}

.bioma-btn-secondary:hover:not(:disabled) {
    background: var(--bg-hover);
    border-color: var(--text-muted);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

/* Success (Verde) */
.bioma-btn-success {
    background: linear-gradient(135deg, #10B981, #059669);
    color: white;
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
}

.bioma-btn-success:hover:not(:disabled) {
    background: linear-gradient(135deg, #059669, #047857);
    box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
    transform: translateY(-2px);
}

/* Danger (Vermelho) */
.bioma-btn-danger {
    background: linear-gradient(135deg, #EF4444, #DC2626);
    color: white;
    box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
}

.bioma-btn-danger:hover:not(:disabled) {
    background: linear-gradient(135deg, #DC2626, #B91C1C);
    box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
    transform: translateY(-2px);
}

/* Warning (Amarelo) */
.bioma-btn-warning {
    background: linear-gradient(135deg, #F59E0B, #D97706);
    color: white;
    box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
}

.bioma-btn-warning:hover:not(:disabled) {
    background: linear-gradient(135deg, #D97706, #B45309);
    box-shadow: 0 6px 20px rgba(245, 158, 11, 0.4);
    transform: translateY(-2px);
}

/* Info (Azul) */
.bioma-btn-info {
    background: linear-gradient(135deg, #3B82F6, #2563EB);
    color: white;
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
}

.bioma-btn-info:hover:not(:disabled) {
    background: linear-gradient(135deg, #2563EB, #1D4ED8);
    box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
    transform: translateY(-2px);
}

/* ========== TAMANHOS DE BOT√ïES ========== */
.bioma-btn-sm {
    padding: 8px 16px;
    font-size: 13px;
    border-radius: 8px;
}

.bioma-btn-lg {
    padding: 16px 32px;
    font-size: 16px;
    border-radius: 14px;
}

/* ========== BOT√ïES OUTLINE ========== */
.bioma-btn-outline-primary {
    background: transparent;
    color: #7C3AED;
    border: 2px solid #7C3AED;
    box-shadow: none;
}

.bioma-btn-outline-primary:hover:not(:disabled) {
    background: #7C3AED;
    color: white;
}

.bioma-btn-outline-secondary {
    background: transparent;
    color: var(--text);
    border: 2px solid var(--border-color);
    box-shadow: none;
}

.bioma-btn-outline-secondary:hover:not(:disabled) {
    background: var(--bg-secondary);
    border-color: var(--text-muted);
}

/* ========== BOT√ïES GHOST (transparentes) ========== */
.bioma-btn-ghost {
    background: transparent;
    color: var(--text);
    box-shadow: none;
}

.bioma-btn-ghost:hover:not(:disabled) {
    background: var(--bg-secondary);
}

/* ========== BOT√ÉO COM √çCONE ========== */
.bioma-btn i,
.bioma-btn svg {
    font-size: 18px;
    width: 18px;
    height: 18px;
}

.bioma-btn-sm i,
.bioma-btn-sm svg {
    font-size: 14px;
    width: 14px;
    height: 14px;
}

.bioma-btn-lg i,
.bioma-btn-lg svg {
    font-size: 20px;
    width: 20px;
    height: 20px;
}

/* ========== BOT√ÉO CIRCULAR (apenas √≠cone) ========== */
.bioma-btn-circle {
    padding: 12px;
    border-radius: 50%;
    aspect-ratio: 1;
}

.bioma-btn-circle.bioma-btn-sm {
    padding: 8px;
}

.bioma-btn-circle.bioma-btn-lg {
    padding: 16px;
}

/* ========== GLAMOUR SHINE EFFECT ========== */
.bioma-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(
        90deg,
        transparent,
        rgba(255, 255, 255, 0.4),
        transparent
    );
    transition: left 0.5s ease;
}

.bioma-btn:hover::before {
    left: 100%;
}

@keyframes glamourShine {
    0% {
        left: -100%;
    }
    100% {
        left: 100%;
    }
}

/* ========== DARK MODE ========== */
:root[data-theme="dark"] .bioma-toast {
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4), 0 2px 8px rgba(0, 0, 0, 0.3);
}

:root[data-theme="dark"] .bioma-modal {
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6), 0 8px 16px rgba(0, 0, 0, 0.4);
}

/* ========== RESPONSIVIDADE ========== */
@media (max-width: 640px) {
    .bioma-toast-stack {
        top: 16px;
        right: 16px;
        left: 16px;
    }

    .bioma-toast {
        min-width: 0;
        width: 100%;
    }

    .bioma-modal {
        padding: 24px;
        border-radius: 16px;
    }

    .bioma-modal-actions {
        flex-direction: column;
    }

    .bioma-modal-actions .bioma-btn {
        width: 100%;
    }
}

/* ========== SISTEMA DE AUTOCOMPLETE MODERNO ========== */
.bioma-autocomplete {
    position: relative;
    width: 100%;
}

.bioma-autocomplete-input {
    width: 100%;
    padding: 12px 16px 12px 44px;
    font-size: 15px;
    font-weight: 500;
    border: 2px solid var(--border-color);
    border-radius: 12px;
    background: var(--bg-card);
    color: var(--text);
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    outline: none;
}

.bioma-autocomplete-input:focus {
    border-color: #7C3AED;
    box-shadow: 0 0 0 4px rgba(124, 58, 237, 0.1);
}

.bioma-autocomplete-icon {
    position: absolute;
    left: 14px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-muted);
    font-size: 18px;
    pointer-events: none;
    transition: color 0.2s;
}

.bioma-autocomplete-input:focus + .bioma-autocomplete-icon {
    color: #7C3AED;
}

.bioma-autocomplete-dropdown {
    position: fixed;
    max-height: 400px;
    overflow-y: auto;
    background: var(--bg-card);
    border: 2px solid var(--border-color);
    border-radius: 12px;
    z-index: 99999999;
    min-width: 300px;
    box-shadow:
        0 10px 40px rgba(0, 0, 0, 0.15),
        0 2px 8px rgba(0, 0, 0, 0.08);
    opacity: 0;
    transform: translateY(-10px);
    pointer-events: none;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
}

.bioma-autocomplete-dropdown.active {
    opacity: 1;
    transform: translateY(0);
    pointer-events: auto;
}

.bioma-autocomplete-item {
    padding: 12px 16px;
    cursor: pointer;
    transition: all 0.15s;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    align-items: center;
    gap: 12px;
}

.bioma-autocomplete-item:last-child {
    border-bottom: none;
}

.bioma-autocomplete-item:hover {
    background: var(--bg-hover);
}

.bioma-autocomplete-item.selected {
    background: rgba(124, 58, 237, 0.1);
    color: #7C3AED;
}

.bioma-autocomplete-item-icon {
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, rgba(124, 58, 237, 0.1), rgba(59, 130, 246, 0.1));
    border-radius: 8px;
    font-size: 16px;
    flex-shrink: 0;
}

.bioma-autocomplete-item-content {
    flex: 1;
    min-width: 0;
}

.bioma-autocomplete-item-title {
    font-weight: 600;
    font-size: 14px;
    color: var(--text);
    margin-bottom: 2px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.bioma-autocomplete-item-subtitle {
    font-size: 12px;
    color: var(--text-muted);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.bioma-autocomplete-empty {
    padding: 24px;
    text-align: center;
    color: var(--text-muted);
    font-size: 14px;
}

.bioma-autocomplete-loading {
    padding: 24px;
    text-align: center;
}

.bioma-autocomplete-spinner {
    width: 24px;
    height: 24px;
    margin: 0 auto;
    border: 3px solid var(--border-color);
    border-top-color: #7C3AED;
    border-radius: 50%;
    animation: biomaAutocompleteSpinner 0.8s linear infinite;
}

@keyframes biomaAutocompleteSpinner {
    to { transform: rotate(360deg); }
}

/* Dark mode */
:root[data-theme="dark"] .bioma-autocomplete-dropdown {
    box-shadow:
        0 10px 40px rgba(0, 0, 0, 0.4),
        0 2px 8px rgba(0, 0, 0, 0.3);
}


        /* Hover em tabelas com eleva√ß√£o */
        table tbody tr {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1) !important;
        }

        table tbody tr:hover {
            transform: translateX(5px) !important;
            box-shadow: -5px 0 15px rgba(124, 58, 237, 0.1) !important;
        }

        /* Menu sidebar com slide suave */
        .sidebar-menu li a {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
        }

        .sidebar-menu li a:hover {
            transform: translateX(5px) !important;
        }

        /* Stat cards com rota√ß√£o 3D ao hover */
        .stat-card {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1) !important;
        }

        .stat-card:hover {
            transform: translateY(-15px) rotateX(5deg) !important;
        }

        /* Form inputs com foco animado */
        .form-control, .form-select {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
        }

        .form-control:focus, .form-select:focus {
            transform: scale(1.02) !important;
        }

        /* Loading overlay com fade suave */
        .loading-overlay {
            animation: fadeIn 0.2s ease-out;
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px) !important;
        }

        /* Badge de atualiza√ß√£o com entrada suave */
        #lastRefreshBadge {
            animation: slideInRight 0.5s ease-out;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(-30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* ========== ANIMA√á√ïES EXTRAS SOFISTICADAS ========== */

        /* Shake animation para erros */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-8px); }
            20%, 40%, 60%, 80% { transform: translateX(8px); }
        }

        .shake-animation {
            animation: shake 0.5s ease-in-out;
        }

        /* Success glow effect */
        @keyframes successGlow {
            0%, 100% {
                box-shadow: 0 0 5px rgba(16, 185, 129, 0.3);
            }
            50% {
                box-shadow: 0 0 20px rgba(16, 185, 129, 0.8), 0 0 40px rgba(16, 185, 129, 0.4);
            }
        }

        .success-glow {
            animation: successGlow 1.5s ease-in-out 2;
        }

        /* Brilho pulsante para √≠cones (fixos, sem movimento vertical) */
        @keyframes iconGlow {
            0%, 100% {
                box-shadow: 0 10px 25px rgba(124, 58, 237, 0.3);
                filter: brightness(1);
            }
            50% {
                box-shadow: 0 10px 40px rgba(124, 58, 237, 0.6), 0 0 20px rgba(236, 72, 153, 0.4);
                filter: brightness(1.2);
            }
        }

        .stat-card .icon {
            animation: iconGlow 2s ease-in-out infinite;
        }

        .stat-card:nth-child(2) .icon {
            animation-delay: 0.3s;
        }

        .stat-card:nth-child(3) .icon {
            animation-delay: 0.6s;
        }

        .stat-card:nth-child(4) .icon {
            animation-delay: 0.9s;
        }

        /* Ripple effect removido completamente */

        /* Bounce in animation para badges */
        @keyframes bounceInBadge {
            0% {
                opacity: 0;
                transform: scale(0.3);
            }
            50% {
                opacity: 1;
                transform: scale(1.1);
            }
            70% {
                transform: scale(0.9);
            }
            100% {
                transform: scale(1);
            }
        }

        .badge {
            animation: bounceInBadge 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        /* Typewriter effect para t√≠tulos */
        @keyframes typewriter {
            from {
                width: 0;
            }
            to {
                width: 100%;
            }
        }

        .page-header h1 {
            overflow: hidden;
            white-space: nowrap;
            animation: typewriter 1s steps(30, end);
        }

        /* Gradient animation para bot√µes prim√°rios */
        @keyframes gradientShift {
            0% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
            100% {
                background-position: 0% 50%;
            }
        }

        .btn-primary {
            background-size: 200% 200%;
            animation: gradientShift 3s ease infinite;
        }

        /* Slide up animation para form controls ao focar */
        @keyframes slideUpFocus {
            0% {
                transform: translateY(0);
            }
            100% {
                transform: translateY(-2px);
            }
        }

        .form-control:focus, .form-select:focus {
            animation: slideUpFocus 0.2s ease-out forwards;
        }

        /* Confetti effect para sucessos */
        @keyframes confetti-fall {
            0% {
                transform: translateY(-100%) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }

        /* Progress bar animation */
        @keyframes progressBar {
            0% {
                width: 0%;
            }
            100% {
                width: 100%;
            }
        }

        /* Fade in zoom para imagens */
        @keyframes fadeInZoom {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        #sidebarLogoImage, img.profile-pic {
            animation: fadeInZoom 0.6s ease-out;
        }

        /* Hover effect para links com underline animado */
        a {
            position: relative;
        }

        a::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 0;
            height: 2px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            transition: width 0.3s ease-out;
        }

        a:hover::after {
            width: 100%;
        }

        /* Skeleton loading animation */
        @keyframes skeleton-loading {
            0% {
                background-position: -200px 0;
            }
            100% {
                background-position: calc(200px + 100%) 0;
            }
        }

        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200px 100%;
            animation: skeleton-loading 1.5s ease-in-out infinite;
        }

        /* ========== TELA DE LOGIN: DARK MODE MELHORADO ========== */
        /* Dark mode bonito e leg√≠vel na tela de autentica√ß√£o */

        /* ========== LOGIN MODERNIZADO COM DARK MODE (PARTE 5.1) ========== */

        /* Labels com cor din√¢mica */
        .login-label {
            font-weight: 700;
            color: var(--text-primary) !important;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }

        /* √çcones animados */
        .animated-icon {
            animation: iconPulse 2s ease-in-out infinite;
        }

        @keyframes iconPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.15); }
        }

        /* Caixa "Lembrar por 7 dias" adapt√°vel */
        .remember-box {
            display: flex;
            align-items: center;
            gap: 10px;
            background: linear-gradient(135deg, rgba(124, 58, 237, 0.1), rgba(236, 72, 153, 0.1));
            padding: 15px;
            border-radius: 12px;
            border: 2px solid var(--primary);
        }

        .remember-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: var(--primary);
        }

        .remember-label {
            cursor: pointer;
            margin: 0;
            font-weight: 600;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Caixa de informa√ß√£o adapt√°vel */
        .info-box {
            border-left: 5px solid var(--info) !important;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(96, 165, 250, 0.1)) !important;
            color: var(--text-primary) !important;
        }

        .info-title {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-primary) !important;
        }

        .info-content {
            margin-top: 10px;
            padding-left: 28px;
        }

        .info-item {
            margin-bottom: 5px;
            color: var(--text-primary) !important;
        }

        .info-code {
            background: rgba(124, 58, 237, 0.15) !important;
            padding: 4px 10px;
            border-radius: 6px;
            font-weight: 700;
            color: var(--primary) !important;
        }

        /* Bot√£o de login moderno */
        .login-btn {
            padding: 15px !important;
            font-size: 1.1rem !important;
            font-weight: 800 !important;
            position: relative;
            overflow: hidden;
        }

        .btn-content, .btn-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        /* Spinner moderno */
        .modern-spinner {
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top-color: #fff;
            border-radius: 50%;
            animation: modernSpin 0.8s linear infinite;
            display: inline-block;
        }

        @keyframes modernSpin {
            to { transform: rotate(360deg); }
        }

        /* Dark mode para auth screen */
        @media (prefers-color-scheme: dark) {
            .auth-box {
                background: rgba(30, 41, 59, 0.98) !important;
            }

            .auth-logo h2 {
                color: var(--text-primary) !important;
            }

            .auth-logo p {
                color: var(--text-secondary) !important;
            }
        }

        /* ========== INDICADOR DE CONECTIVIDADE OFFLINE (PARTE 5.7) ========== */

        .connectivity-indicator {
            padding: 12px 20px;
            text-align: center;
            font-weight: 700;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            border-radius: 10px;
            margin: 15px 20px;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .connectivity-indicator.online {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(5, 150, 105, 0.15));
            color: #10B981;
            border: 2px solid rgba(16, 185, 129, 0.3);
        }

        .connectivity-indicator.offline {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.15), rgba(220, 38, 38, 0.15));
            color: #EF4444;
            border: 2px solid rgba(239, 68, 68, 0.3);
            animation: pulse-offline 2s ease-in-out infinite;
        }

        .connectivity-indicator i {
            font-size: 1.1rem;
        }

        @keyframes pulse-offline {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
            }
        }

        /* ========== FIM INDICADOR DE CONECTIVIDADE ========== */

        /* ========== CORRE√á√ÉO AUTOCOMPLETE CORTADO (Clipping) ========== */
        /*
         * O Problema: A classe .card usa "contain: layout style paint;"
         * para otimiza√ß√£o de performance. Isso cria um novo contexto
         * de empilhamento que "corta" qualquer elemento filho que tente
         * flutuar para fora, como o nosso .autocomplete-results.
         *
         * A Solu√ß√£o: Desativar a conten√ß√£o (contain: none) APENAS
         * para os cards dentro da se√ß√£o de or√ßamento.
        */
        #section-orcamento .card {
            contain: none !important;
        }

        /* Tamb√©m garantir que autocomplete-results tenha z-index alto */
        .autocomplete-results,
        #cpfResults,
        #servicoResults,
        #produtoResults {
            z-index: 99999999 !important;
            position: fixed !important;
        }

        /* Bot√£o vermelho pulsante para desfazer importa√ß√£o */
        .btn-undo-import {
            background: linear-gradient(135deg, #EF4444, #DC2626) !important;
            color: white !important;
            border: none !important;
            padding: 12px 24px !important;
            border-radius: 12px !important;
            font-weight: 600 !important;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4) !important;
            animation: pulse-red 2s infinite !important;
            transition: all 0.3s ease !important;
            display: inline-flex !important;
            align-items: center !important;
            gap: 8px !important;
        }

        .btn-undo-import:hover {
            transform: translateY(-2px) !important;
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.6) !important;
        }

        .btn-undo-import:disabled {
            opacity: 0.5 !important;
            cursor: not-allowed !important;
            animation: none !important;
        }

        @keyframes pulse-red {
            0% {
                box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4);
            }
            50% {
                box-shadow: 0 4px 25px rgba(239, 68, 68, 0.8);
            }
            100% {
                box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4);
            }
        }

/* ========== (Ponto 11) ANIMA√á√ÉO ESTOQUE CR√çTICO (v6.0) ========== */
.badge-pulse-danger {
    background: linear-gradient(135deg, var(--danger), #DC2626) !important;
    color: white !important;
    animation: pulse-red-v6 2s ease-in-out infinite;
    box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4);
}

@keyframes pulse-red-v6 {
    0% {
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4);
    }
    50% {
        transform: scale(1.05);
        box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
    }
    100% {
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
    }
}

</style>

<!-- ========== MELHORIAS DE UX E ANIMA√á√ïES V4.1 ========== -->
<style>
    /* ========== TRANSI√á√ïES SUAVES ENTRE P√ÅGINAS ========== */
    .content-section {
        opacity: 0;
        transform: translateX(-30px);
        transition: opacity 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94),
                    transform 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    }

    .content-section.active {
        opacity: 1;
        transform: translateX(0);
        animation: smoothPageIn 0.7s cubic-bezier(0.16, 1, 0.3, 1);
    }

    @keyframes smoothPageIn {
        0% {
            opacity: 0;
            transform: translateX(-50px) scale(0.96);
        }
        100% {
            opacity: 1;
            transform: translateX(0) scale(1);
        }
    }

    /* ========== ANIMA√á√ïES HOVER MODERNAS PARA BOT√ïES ========== */
    .btn {
        position: relative;
        overflow: hidden;
        transform-style: preserve-3d;
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    .btn::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.3);
        transform: translate(-50%, -50%);
        transition: width 0.6s, height 0.6s;
    }

    .btn:hover::before {
        width: 300px;
        height: 300px;
    }

    .btn:hover {
        transform: translateY(-5px) scale(1.05);
        box-shadow: 0 15px 40px rgba(124, 58, 237, 0.6) !important;
    }

    .btn:active {
        transform: translateY(-2px) scale(0.98);
    }

    /* Bot√µes com anima√ß√£o de pulso */
    .btn-primary {
        animation: subtlePulse 3s ease-in-out infinite;
    }

    @keyframes subtlePulse {
        0%, 100% {
            box-shadow: 0 5px 20px rgba(124, 58, 237, 0.3);
        }
        50% {
            box-shadow: 0 5px 30px rgba(124, 58, 237, 0.5);
        }
    }

    /* ========== SUB-TABS COM TRANSI√á√ïES SUAVES ========== */
    .sub-tab-content {
        opacity: 0;
        transform: translateY(20px);
        transition: opacity 0.5s ease, transform 0.5s ease;
        pointer-events: none;
    }

    .sub-tab-content.active {
        opacity: 1;
        transform: translateY(0);
        pointer-events: auto;
        animation: tabSlideIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    @keyframes tabSlideIn {
        0% {
            opacity: 0;
            transform: translateY(30px) scale(0.95);
        }
        100% {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }

    /* ========== MELHORIAS NAS TABELAS ========== */
    table tbody tr {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    table tbody tr:hover {
        transform: translateX(4px) !important;
        background: linear-gradient(90deg,
            rgba(124, 58, 237, 0.05),
            transparent) !important;
        box-shadow: 0 2px 8px rgba(124, 58, 237, 0.1);
    }

    /* ========== INDICADOR DE AUTO-REFRESH ========== */
    #auto-refresh-indicator {
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        color: white;
        padding: 12px 20px;
        border-radius: 50px;
        box-shadow: 0 5px 25px rgba(124, 58, 237, 0.4);
        z-index: 999999;
        display: none;
        align-items: center;
        gap: 10px;
        font-weight: 700;
        font-size: 0.9rem;
        animation: slideInFromTop 0.4s ease, pulse 2s ease-in-out infinite;
    }

    #auto-refresh-indicator.show {
        display: flex;
    }

    #auto-refresh-indicator .spinner-small {
        width: 16px;
        height: 16px;
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-top-color: white;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes slideInFromTop {
        from {
            opacity: 0;
            transform: translateY(-30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* ========== DARK MODE APRIMORADO ========== */
    :root[data-theme="dark"] {
        --primary: #A78BFA;
        --primary-dark: #8B5CF6;
        --secondary: #F472B6;
        --accent: #FDE047;
        --success: #4ADE80;
        --danger: #F87171;
        --warning: #FBBF24;
        --info: #38BDF8;
        --bg-main: #0F1419;
        --bg-card: #1A1F2E;
        --bg-sidebar: #0A0E14;
        --bg-sidebar-hover: #1A1F2E;
        --text-primary: #F3F4F6;
        --text-secondary: #D1D5DB;
        --text-muted: #9CA3AF;
        --border-color: #374151;
        --shadow: 0 4px 20px rgba(0, 0, 0, 0.6);
        --shadow-hover: 0 8px 40px rgba(167, 139, 250, 0.4);
    }

    /* Garantir contraste no dark mode */
    :root[data-theme="dark"] .card-header,
    :root[data-theme="dark"] table thead th {
        background: linear-gradient(135deg, #6D28D9, #8B5CF6);
    }

    :root[data-theme="dark"] .stat-card h3 {
        color: var(--primary);
        -webkit-text-fill-color: var(--primary);
    }

    :root[data-theme="dark"] input,
    :root[data-theme="dark"] select,
    :root[data-theme="dark"] textarea {
        background: var(--bg-main);
        color: var(--text-primary);
        border-color: var(--border-color);
    }

    :root[data-theme="dark"] .badge {
        filter: brightness(1.2);
    }

    /* ========== SCROLL OTIMIZADO ========== */
    * {
        scrollbar-width: thin;
        scrollbar-color: var(--primary) var(--bg-main);
    }

    ::-webkit-scrollbar {
        width: 10px;
        height: 10px;
    }

    ::-webkit-scrollbar-track {
        background: var(--bg-main);
        border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb {
        background: linear-gradient(180deg, var(--primary), var(--secondary));
        border-radius: 10px;
        border: 2px solid var(--bg-main);
        transition: none;
    }

    ::-webkit-scrollbar-thumb:active {
        background: var(--primary-dark);
    }

    /* Hover removido completamente para evitar piscar ao passar mouse */

    /* ========== CARDS COM ANIMA√á√ïES ========== */
    .stat-card {
        animation: cardFloat 6s ease-in-out infinite;
    }

    .stat-card:nth-child(2) {
        animation-delay: 0.2s;
    }

    .stat-card:nth-child(3) {
        animation-delay: 0.4s;
    }

    .stat-card:nth-child(4) {
        animation-delay: 0.6s;
    }

    @keyframes cardFloat {
        0%, 100% {
            transform: translateY(0);
        }
        50% {
            transform: translateY(-5px);
        }
    }

    /* ========== BADGES COM ANIMA√á√ïES ========== */
    .badge {
        animation: badgePop 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }

    @keyframes badgePop {
        0% {
            transform: scale(0);
        }
        80% {
            transform: scale(1.1);
        }
        100% {
            transform: scale(1);
        }
    }

    /* ========== SIDEBAR MENU ANIMA√á√ïES ========== */
    .sidebar-menu li a {
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .sidebar-menu li a:hover {
        transform: translateX(8px);
        background: linear-gradient(90deg,
            var(--bg-sidebar-hover),
            rgba(124, 58, 237, 0.1));
    }

    .sidebar-menu li a.active {
        animation: activeMenuPulse 2s ease-in-out infinite;
    }

    @keyframes activeMenuPulse {
        0%, 100% {
            box-shadow: inset 5px 0 0 var(--primary);
        }
        50% {
            box-shadow: inset 8px 0 0 var(--primary);
        }
    }

    /* ========== FORM CONTROLS COM FOCO SUAVE ========== */
    .form-control:focus,
    .form-select:focus {
        transform: scale(1.02);
        transition: all 0.3s ease;
    }

    /* ========== LOADING STATES ELEGANTES ========== */
    .spinner {
        animation: spin 1s linear infinite, colorChange 3s ease-in-out infinite;
    }

    @keyframes colorChange {
        0%, 100% {
            border-top-color: var(--primary);
        }
        33% {
            border-top-color: var(--secondary);
        }
        66% {
            border-top-color: var(--accent);
        }
    }

    /* ========== PERFORMANCE OTIMIZA√á√ÉO ========== */
    .main-content {
        will-change: scroll-position;
    }

    .content-section.active {
        will-change: transform, opacity;
    }

    table tbody tr {
        will-change: auto;
    }

    /* ========== COMUNIDADE ANIMA√á√ïES ========== */
    .mapa-dia {
        animation: cardFadeIn 0.6s ease forwards;
        opacity: 0;
    }

    .mapa-dia:nth-child(1) { animation-delay: 0.05s; }
    .mapa-dia:nth-child(2) { animation-delay: 0.1s; }
    .mapa-dia:nth-child(3) { animation-delay: 0.15s; }
    .mapa-dia:nth-child(4) { animation-delay: 0.2s; }
    .mapa-dia:nth-child(5) { animation-delay: 0.25s; }

    @keyframes cardFadeIn {
        from {
            opacity: 0;
            transform: translateY(20px) scale(0.9);
        }
        to {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }

    /* ========== THEME TOGGLE MELHORADO ========== */
    .theme-toggle button:hover {
        transform: scale(1.08);
        background: rgba(255, 255, 255, 0.2);
        box-shadow: 0 5px 20px rgba(124, 58, 237, 0.5);
    }

    .theme-toggle button {
        transition: all 0.3s ease;
    }

    .theme-toggle button i {
        transition: transform 0.3s ease;
    }

    /* ========== CORRE√á√ïES ABRANGENTES DARK MODE ========== */
    /* Garantir que TODOS os inputs/selects/textareas funcionem no dark mode */
    :root[data-theme="dark"] .form-control,
    :root[data-theme="dark"] .form-select,
    :root[data-theme="dark"] input:not([type="checkbox"]):not([type="radio"]),
    :root[data-theme="dark"] select,
    :root[data-theme="dark"] textarea {
        background: var(--bg-card) !important;
        color: var(--text-primary) !important;
        border-color: var(--border-color) !important;
    }

    :root[data-theme="dark"] .form-control:focus,
    :root[data-theme="dark"] .form-select:focus,
    :root[data-theme="dark"] input:focus,
    :root[data-theme="dark"] select:focus,
    :root[data-theme="dark"] textarea:focus {
        background: var(--bg-card) !important;
        color: var(--text-primary) !important;
        border-color: var(--primary) !important;
    }

    /* Placeholders vis√≠veis no dark mode */
    :root[data-theme="dark"] input::placeholder,
    :root[data-theme="dark"] textarea::placeholder {
        color: var(--text-muted) !important;
        opacity: 0.7;
    }

    /* Labels e textos no dark mode */
    :root[data-theme="dark"] label,
    :root[data-theme="dark"] .form-label {
        color: var(--text-primary) !important;
    }

    /* Alertas no dark mode */
    :root[data-theme="dark"] .alert-info {
        background: rgba(59, 130, 246, 0.15) !important;
        color: var(--info) !important;
    }

    :root[data-theme="dark"] .alert-success {
        background: rgba(16, 185, 129, 0.15) !important;
        color: var(--success) !important;
    }

    /* ========== TRANSI√á√ïES SUAVES ENTRE P√ÅGINAS/ABAS ========== */
    .content-section {
        transition: opacity 0.4s cubic-bezier(0.4, 0.0, 0.2, 1),
                    transform 0.4s cubic-bezier(0.4, 0.0, 0.2, 1);
        opacity: 0;
        transform: translateY(20px);
    }

    .content-section.active {
        opacity: 1;
        transform: translateY(0);
        animation: smoothPageTransition 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    @keyframes smoothPageTransition {
        0% {
            opacity: 0;
            transform: translateY(30px) scale(0.98);
        }
        100% {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }

    /* Sub-tabs com transi√ß√£o suave */
    .sub-tab-content {
        transition: opacity 0.35s ease, transform 0.35s ease;
        opacity: 0;
        transform: translateX(-15px);
        display: none;
    }

    .sub-tab-content.active {
        opacity: 1;
        transform: translateX(0);
        display: block;
        animation: smoothSubTabTransition 0.4s ease;
    }

    @keyframes smoothSubTabTransition {
        0% {
            opacity: 0;
            transform: translateX(-20px);
        }
        100% {
            opacity: 1;
            transform: translateX(0);
        }
    }

    /* Tabs do menu lateral com transi√ß√£o */
    .sidebar-menu li a {
        transition: all 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
    }

    .sidebar-menu li a:hover {
        transition-duration: 0.2s;
    }

    /* Cards com transi√ß√£o suave */
    .card {
        transition: all 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
    }

    .stat-card {
        transition: all 0.35s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    /* Bot√µes com transi√ß√£o mais fluida */
    .btn {
        transition: all 0.25s cubic-bezier(0.4, 0.0, 0.2, 1);
    }

    .btn:hover {
        transition-duration: 0.15s;
    }

    /* Smooth scroll global */
    html {
        scroll-behavior: smooth;
        height: 100%;
    }

    /* Transi√ß√£o de cor no body ao mudar tema */
    body {
        transition: background-color 0.4s cubic-bezier(0.4, 0.0, 0.2, 1),
                    color 0.4s cubic-bezier(0.4, 0.0, 0.2, 1);
        height: 100%;
        overflow-y: auto;
    }

    /* Fix para garantir scroll na tela principal */
    .main-content {
        height: 100vh;
        overflow-y: auto !important;
        overflow-x: hidden !important;
        position: relative;
    }
</style>

</head>
<body>

<!-- ========== INDICADOR DE AUTO-REFRESH ========== -->
<div id="auto-refresh-indicator">
    <div class="spinner-small"></div>
    <span>Atualizando dados...</span>
</div>

<!-- SISTEMA DE VERSIONING + DEBUG -->
<script>
// ============================================================
// VERS√ÉO DO BUILD - Injetada pelo Flask via Jinja2
// ============================================================
const BUILD_TIMESTAMP = '{{ cache_buster|default("LOCAL", true) }}';
const APP_VERSION = 'v6.0';

console.log('%c‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'color: #7C3AED;');
console.log(`%cüî• BIOMA ${APP_VERSION} - Build: ${BUILD_TIMESTAMP}`, 'background: #7C3AED; color: white; font-size: 16px; padding: 10px; font-weight: bold;');
console.log('%c‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'color: #7C3AED;');

// ============================================================
// VERIFICAR ATUALIZA√á√ÉO (Sistema de Cache Busting)
// ============================================================
const cachedBuild = localStorage.getItem('BIOMA_BUILD');
if (cachedBuild !== BUILD_TIMESTAMP) {
    console.log('%cüÜï NOVA VERS√ÉO DETECTADA!', 'background: green; color: white; font-size: 14px; padding: 8px;');
    console.log('%cBuild Anterior:', 'font-weight: bold', cachedBuild || 'Primeira execu√ß√£o');
    console.log('%cBuild Atual:', 'font-weight: bold', BUILD_TIMESTAMP);
    console.log('%c‚úÖ Cache atualizado!', 'color: green; font-weight: bold;');
    localStorage.setItem('BIOMA_BUILD', BUILD_TIMESTAMP);

    // Limpar outros caches se necess√°rio
    console.log('%cüßπ Limpando caches antigos...', 'color: orange;');
} else {
    console.log('%c‚úÖ Vers√£o atual: ' + APP_VERSION + ' (Build: ' + BUILD_TIMESTAMP + ')', 'color: green; font-weight: bold;');
    console.log('%cüì¶ Cache est√° sincronizado', 'color: green;');
}

// ============================================================
// SISTEMA DE TEMA - Light/Dark Mode
// ============================================================
// Tema pode ser alternado tanto no login quanto no app
// Removido: C√≥digo que for√ßava light mode no login

// ============================================================
// ============================================================
// BIOMA UI SYSTEM v5.1.0 - Modais Bonitos + Bot√µes Modernos
// ============================================================
// Modais customizados DIV (n√£o nativos do browser)
// Sistema de bot√µes moderno e profissional
// ============================================================

// ========== ESTADO GLOBAL ==========
let biomaToastContainer = null;
let activeModals = [];

// ========== CRIAR CONTAINERS ==========
function initBiomaUI() {
    // Container para toasts
    if (!biomaToastContainer) {
        biomaToastContainer = document.createElement('div');
        biomaToastContainer.className = 'bioma-toast-stack';
        biomaToastContainer.id = 'biomaToastStack';
        document.body.appendChild(biomaToastContainer);
    }
}

// Auto-inicializar quando DOM carregar
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initBiomaUI);
} else {
    initBiomaUI();
}

// ========== TOAST NOTIFICATIONS (Toastify-style) ==========
function mostrarNotificacao(type, message, duration = 3000) {
    const toast = document.createElement('div');
    toast.className = `bioma-toast bioma-toast-${type} bioma-toast-enter`;

    const icons = {
        success: '<svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg>',
        error: '<svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>',
        warning: '<svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/></svg>',
        info: '<svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>'
    };

    toast.innerHTML = `
        <div class="bioma-toast-icon">${icons[type] || icons.info}</div>
        <div class="bioma-toast-message">${message}</div>
        <button class="bioma-toast-close" onclick="this.closest('.bioma-toast').remove()">
            <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
                <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/>
            </svg>
        </button>
    `;

    biomaToastContainer.appendChild(toast);

    // Anima√ß√£o de entrada
    setTimeout(() => toast.classList.add('bioma-toast-show'), 10);

    // Auto-remover
    if (duration > 0) {
        setTimeout(() => {
            toast.classList.remove('bioma-toast-show');
            toast.classList.add('bioma-toast-exit');
            setTimeout(() => toast.remove(), 300);
        }, duration);
    }

    return toast;
}

// ========== MODAL CUSTOMIZADO (DIV estilizado) ==========
function mostrarConfirmacao(config) {
    return new Promise((resolve) => {
        // Criar overlay
        const overlay = document.createElement('div');
        overlay.className = 'bioma-modal-overlay bioma-modal-fade-in';

        // Criar modal
        const modal = document.createElement('div');
        modal.className = 'bioma-modal bioma-modal-scale-in';

        const icons = {
            success: '<svg viewBox="0 0 24 24" width="48" height="48" fill="#10B981"><circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2"/><path d="M9 12l2 2 4-4" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>',
            error: '<svg viewBox="0 0 24 24" width="48" height="48" fill="#EF4444"><circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2"/><path d="M15 9l-6 6m0-6l6 6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>',
            warning: '<svg viewBox="0 0 24 24" width="48" height="48" fill="#F59E0B"><path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/></svg>',
            info: '<svg viewBox="0 0 24 24" width="48" height="48" fill="#3B82F6"><circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2"/><path d="M12 16v-4m0-4h.01" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>',
            question: '<svg viewBox="0 0 24 24" width="48" height="48" fill="#8B5CF6"><circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3m.08 4h.01" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>'
        };

        const iconHTML = config.icon ? `<div class="bioma-modal-icon">${icons[config.icon] || icons.info}</div>` : '';
        const textHTML = config.text ? `<p class="bioma-modal-text">${config.text}</p>` : '';
        const htmlContent = config.html || '';

        modal.innerHTML = `
            <div class="bioma-modal-header">
                ${iconHTML}
                <h3 class="bioma-modal-title">${config.title || 'Confirma√ß√£o'}</h3>
                ${textHTML}
            </div>
            <div class="bioma-modal-body">
                ${htmlContent}
                <div class="bioma-modal-actions">
                    ${config.showCancelButton !== false ? `<button class="bioma-btn bioma-btn-secondary" data-action="cancel">${config.cancelButtonText || 'Cancelar'}</button>` : ''}
                    <button class="bioma-btn bioma-btn-primary" data-action="confirm">${config.confirmButtonText || 'Confirmar'}</button>
                </div>
            </div>
        `;

        overlay.appendChild(modal);
        document.body.appendChild(overlay);
        activeModals.push(overlay);

        // Bloquear scroll do body
        document.body.style.overflow = 'hidden';

        // Event listeners
        const buttons = modal.querySelectorAll('button[data-action]');
        buttons.forEach(btn => {
            btn.addEventListener('click', () => {
                const action = btn.getAttribute('data-action');
                closeModal(overlay);
                resolve({
                    isConfirmed: action === 'confirm',
                    isDismissed: action === 'cancel',
                    value: action === 'confirm'
                });
            });
        });

        // Fechar ao clicar no overlay
        if (config.allowOutsideClick !== false) {
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    closeModal(overlay);
                    resolve({ isConfirmed: false, isDismissed: true });
                }
            });
        }

        // Fechar com ESC
        if (config.allowEscapeKey !== false) {
            const escHandler = (e) => {
                if (e.key === 'Escape') {
                    closeModal(overlay);
                    resolve({ isConfirmed: false, isDismissed: true });
                    document.removeEventListener('keydown', escHandler);
                }
            };
            document.addEventListener('keydown', escHandler);
        }

        // Executar didOpen se existir
        if (config.didOpen) {
            setTimeout(() => config.didOpen(modal), 100);
        }
    });
}

// ========== MODAL DE LOADING ==========
let currentLoadingModal = null;

function mostrarLoading(message = 'Carregando...') {
    // Fechar loading anterior se existir
    if (currentLoadingModal) {
        closeModal(currentLoadingModal);
    }

    const overlay = document.createElement('div');
    overlay.className = 'bioma-modal-overlay bioma-modal-fade-in';

    const modal = document.createElement('div');
    modal.className = 'bioma-modal bioma-modal-loading bioma-modal-scale-in';

    modal.innerHTML = `
        <div class="bioma-spinner">
            <div class="bioma-spinner-circle"></div>
        </div>
        <p class="bioma-modal-title">${message}</p>
    `;

    overlay.appendChild(modal);
    document.body.appendChild(overlay);
    document.body.style.overflow = 'hidden';

    currentLoadingModal = overlay;
    activeModals.push(overlay);

    return overlay;
}

// ========== FUN√á√ïES AUXILIARES ==========
function closeModal(overlay) {
    overlay.classList.add('bioma-modal-fade-out');
    const modal = overlay.querySelector('.bioma-modal');
    if (modal) modal.classList.add('bioma-modal-scale-out');

    setTimeout(() => {
        overlay.remove();
        activeModals = activeModals.filter(m => m !== overlay);

        // Restaurar scroll se n√£o houver mais modais
        if (activeModals.length === 0) {
            document.body.style.overflow = '';
        }

        if (overlay === currentLoadingModal) {
            currentLoadingModal = null;
        }
    }, 300);
}

// Helper function para obter √≠cone do modal
function getModalIcon(icon) {
    const icons = {
        'success': '<i class="bi bi-check-circle-fill" style="color: #10B981;"></i>',
        'error': '<i class="bi bi-x-circle-fill" style="color: #EF4444;"></i>',
        'warning': '<i class="bi bi-exclamation-triangle-fill" style="color: #F59E0B;"></i>',
        'info': '<i class="bi bi-info-circle-fill" style="color: #3B82F6;"></i>',
        'question': '<i class="bi bi-question-circle-fill" style="color: #8B5CF6;"></i>'
    };
    return icons[icon] || '';
}

// ========== COMPATIBILIDADE COM C√ìDIGO ANTIGO ==========
window.Swal = {
    fire: function(...args) {
        if (typeof args[0] === 'object') {
            const config = args[0];

            // Toast notification
            if (config.timer && config.showConfirmButton === false) {
                return Promise.resolve(mostrarNotificacao(config.icon || 'info', config.title, config.timer));
            }

            // Loading
            if (config.didOpen && config.showConfirmButton === false && !config.timer) {
                return Promise.resolve(mostrarLoading(config.title));
            }

            // Confirma√ß√£o
            return mostrarConfirmacao(config);
        } else if (args.length >= 1) {
            // Formato curto: Swal.fire(title, text, icon)
            return mostrarConfirmacao({
                title: args[0],
                text: args[1] || '',
                icon: args[2] || 'info'
            });
        }
    },

    close: function() {
        if (currentLoadingModal) {
            closeModal(currentLoadingModal);
        }
        // Fechar o √∫ltimo modal aberto
        if (activeModals.length > 0) {
            closeModal(activeModals[activeModals.length - 1]);
        }
    },

    isVisible: () => activeModals.length > 0,
    getContainer: () => activeModals[activeModals.length - 1],
    getPopup: () => activeModals[activeModals.length - 1]?.querySelector('.bioma-modal'),
    getCancelButton: () => activeModals[activeModals.length - 1]?.querySelector('.bioma-btn-cancel'),
    getConfirmButton: () => activeModals[activeModals.length - 1]?.querySelector('.bioma-btn-primary'),
    showLoading: () => {},
    DismissReason: {
        cancel: 'cancel',
        backdrop: 'backdrop',
        close: 'close',
        esc: 'esc',
        timer: 'timer'
    },

    mixin: function(defaultConfig) {
        return {
            fire: function(config) {
                const mergedConfig = { ...defaultConfig, ...config };
                // Se for toast
                if (mergedConfig.toast) {
                    return Promise.resolve(mostrarNotificacao(
                        mergedConfig.icon || 'info',
                        mergedConfig.title || '',
                        mergedConfig.timer || 3000
                    ));
                }
                return window.Swal.fire(mergedConfig);
            }
        };
    },

    update: function(config) {
        // Atualizar o modal atual com novo conte√∫do
        if (activeModals.length > 0) {
            const currentModal = activeModals[activeModals.length - 1];
            const modalBody = currentModal.querySelector('.bioma-modal-body');
            const modalTitle = currentModal.querySelector('.bioma-modal-title');
            const modalIcon = currentModal.querySelector('.bioma-modal-icon');

            if (config.title && modalTitle) {
                modalTitle.textContent = config.title;
            }
            if (config.html && modalBody) {
                modalBody.innerHTML = config.html;
            }
            if (config.text && modalBody) {
                modalBody.textContent = config.text;
            }
            if (config.icon && modalIcon) {
                // Atualizar √≠cone
                const iconHTML = getModalIcon(config.icon);
                if (iconHTML) {
                    modalIcon.innerHTML = iconHTML;
                }
            }
        }
    },

    showValidationMessage: function(message) {
        // Mostrar mensagem de valida√ß√£o no modal atual
        if (activeModals.length > 0) {
            const currentModal = activeModals[activeModals.length - 1];
            let validationMsg = currentModal.querySelector('.bioma-validation-message');

            if (!validationMsg) {
                validationMsg = document.createElement('div');
                validationMsg.className = 'bioma-validation-message';
                validationMsg.style.cssText = 'color: #EF4444; margin-top: 10px; font-size: 0.9rem;';
                const modalBody = currentModal.querySelector('.bioma-modal-body');
                if (modalBody) {
                    modalBody.appendChild(validationMsg);
                }
            }

            validationMsg.textContent = message;
            validationMsg.style.display = 'block';
        }
    }
};

// Aliases
const showNotification = mostrarNotificacao;
const showDialog = mostrarConfirmacao;
const showLoading = mostrarLoading;

console.log('%c‚úÖ BIOMA UI System v5.3.4 Carregado', 'color: #10B981; font-weight: bold; font-size: 14px;');
console.log('%c  üé® Modais modernos e detalhados (DIV com gradientes)', 'color: #3B82F6;');
console.log('%c  üîî Toast notifications estilo Toastify', 'color: #3B82F6;');
console.log('%c  ‚ú® Bot√µes com efeito glamour shine', 'color: #3B82F6;');
console.log('%c  ‚úÖ 100% compat√≠vel com c√≥digo antigo', 'color: #10B981; font-weight: bold;');

// ========== SISTEMA DE AUTOCOMPLETE MODERNO ==========
class BiomaAutocomplete {
    constructor(inputElement, options = {}) {
        this.input = inputElement;
        this.options = {
            minChars: options.minChars || 2,
            delay: options.delay || 300,
            fetchData: options.fetchData || this.defaultFetchData,
            onSelect: options.onSelect || (() => {}),
            icon: options.icon || 'bi-search',
            placeholder: options.placeholder || 'Digite para buscar...',
            emptyMessage: options.emptyMessage || 'Nenhum resultado encontrado'
        };

        this.dropdown = null;
        this.selectedIndex = -1;
        this.data = [];
        this.timeout = null;

        this.init();
    }

    init() {
        // Criar wrapper
        const wrapper = document.createElement('div');
        wrapper.className = 'bioma-autocomplete';
        this.input.parentNode.insertBefore(wrapper, this.input);
        wrapper.appendChild(this.input);

        // Adicionar classes ao input
        this.input.classList.add('bioma-autocomplete-input');
        this.input.placeholder = this.options.placeholder;

        // Adicionar √≠cone
        const icon = document.createElement('i');
        icon.className = `bi ${this.options.icon} bioma-autocomplete-icon`;
        wrapper.appendChild(icon);

        // Criar dropdown
        this.dropdown = document.createElement('div');
        this.dropdown.className = 'bioma-autocomplete-dropdown';
        wrapper.appendChild(this.dropdown);

        // Event listeners
        this.input.addEventListener('input', (e) => this.handleInput(e));
        this.input.addEventListener('focus', (e) => this.handleFocus(e));
        this.input.addEventListener('keydown', (e) => this.handleKeydown(e));
        document.addEventListener('click', (e) => this.handleClickOutside(e));
    }

    handleInput(e) {
        const value = e.target.value.trim();

        clearTimeout(this.timeout);

        if (value.length < this.options.minChars) {
            this.hideDropdown();
            return;
        }

        this.showLoading();

        this.timeout = setTimeout(async () => {
            try {
                this.data = await this.options.fetchData(value);
                this.renderResults();
            } catch (error) {
                console.error('Erro no autocomplete:', error);
                this.showError();
            }
        }, this.options.delay);
    }

    handleFocus(e) {
        if (this.data.length > 0) {
            this.showDropdown();
        }
    }

    handleKeydown(e) {
        if (!this.dropdown.classList.contains('active')) return;

        switch (e.key) {
            case 'ArrowDown':
                e.preventDefault();
                this.selectedIndex = Math.min(this.selectedIndex + 1, this.data.length - 1);
                this.updateSelection();
                break;
            case 'ArrowUp':
                e.preventDefault();
                this.selectedIndex = Math.max(this.selectedIndex - 1, -1);
                this.updateSelection();
                break;
            case 'Enter':
                e.preventDefault();
                if (this.selectedIndex >= 0) {
                    this.selectItem(this.data[this.selectedIndex]);
                }
                break;
            case 'Escape':
                this.hideDropdown();
                break;
        }
    }

    handleClickOutside(e) {
        if (!e.target.closest('.bioma-autocomplete')) {
            this.hideDropdown();
        }
    }

    async defaultFetchData(query) {
        // Busca padr√£o - override isso ao criar inst√¢ncia
        const response = await fetch(`/api/busca/autocomplete?q=${encodeURIComponent(query)}`, {
            credentials: 'include'
        });
        const data = await response.json();
        return data.results || [];
    }

    renderResults() {
        if (this.data.length === 0) {
            this.showEmpty();
            return;
        }

        this.dropdown.innerHTML = '';

        this.data.forEach((item, index) => {
            const itemEl = document.createElement('div');
            itemEl.className = 'bioma-autocomplete-item';

            itemEl.innerHTML = `
                <div class="bioma-autocomplete-item-icon">
                    <i class="bi ${item.icon || 'bi-star'}"></i>
                </div>
                <div class="bioma-autocomplete-item-content">
                    <div class="bioma-autocomplete-item-title">${item.title}</div>
                    ${item.subtitle ? `<div class="bioma-autocomplete-item-subtitle">${item.subtitle}</div>` : ''}
                </div>
            `;

            itemEl.addEventListener('click', () => this.selectItem(item));

            this.dropdown.appendChild(itemEl);
        });

        this.showDropdown();
    }

    selectItem(item) {
        this.input.value = item.title;
        this.options.onSelect(item);
        this.hideDropdown();
    }

    updateSelection() {
        const items = this.dropdown.querySelectorAll('.bioma-autocomplete-item');
        items.forEach((item, index) => {
            item.classList.toggle('selected', index === this.selectedIndex);
        });

        // Scroll to selected
        if (this.selectedIndex >= 0) {
            items[this.selectedIndex].scrollIntoView({ block: 'nearest' });
        }
    }

    showLoading() {
        this.dropdown.innerHTML = `
            <div class="bioma-autocomplete-loading">
                <div class="bioma-autocomplete-spinner"></div>
            </div>
        `;
        this.showDropdown();
    }

    showEmpty() {
        this.dropdown.innerHTML = `
            <div class="bioma-autocomplete-empty">
                ${this.options.emptyMessage}
            </div>
        `;
        this.showDropdown();
    }

    showError() {
        this.dropdown.innerHTML = `
            <div class="bioma-autocomplete-empty">
                Erro ao carregar resultados
            </div>
        `;
        this.showDropdown();
    }

    showDropdown() {
        // Calcular posi√ß√£o para dropdown fixo
        const rect = this.input.getBoundingClientRect();
        this.dropdown.style.top = (rect.bottom + 8) + 'px';
        this.dropdown.style.left = rect.left + 'px';
        this.dropdown.style.width = Math.max(rect.width, 300) + 'px';
        this.dropdown.classList.add('active');
    }

    hideDropdown() {
        this.dropdown.classList.remove('active');
        this.selectedIndex = -1;
    }
}

// Fun√ß√£o auxiliar para criar autocomplete
window.createAutocomplete = function(selector, options) {
    const input = typeof selector === 'string' ? document.querySelector(selector) : selector;
    if (input) {
        return new BiomaAutocomplete(input, options);
    }
    return null;
};

console.log('%c  üîç Sistema de autocomplete moderno carregado', 'color: #3B82F6;');


</script>

<div id="authScreen" class="auth-screen">
    <div class="auth-box">
        <!-- Bot√£o de altern√¢ncia de tema no login -->
        <div style="position: absolute; top: 20px; right: 20px; z-index: 10;">
            <button onclick="toggleTheme()" class="auth-theme-toggle" title="Alternar tema">
                <i class="bi bi-moon-stars-fill" id="authThemeIcon"></i>
            </button>
        </div>

        <div class="auth-logo">
            <img id="authLogoCustom" alt="Logo personalizado" style="display:none;max-height:120px;margin:0 auto 20px;">
            <div class="logo-icon">üå≥</div>
            <h2>BIOMA</h2>
            <p>Uberaba - v4.0</p>
        </div>
        <ul class="nav nav-pills nav-fill mb-4">
            <li class="nav-item"><button class="nav-link active" id="loginTab" onclick="switchTab('login')"><i class="bi bi-box-arrow-in-right"></i> Login</button></li>
            <li class="nav-item"><button class="nav-link" id="registerTab" onclick="switchTab('register')"><i class="bi bi-person-plus"></i> Cadastro</button></li>
        </ul>
        <div id="loginForm">
            <form onsubmit="return handleLogin(event)" id="formLogin">
                <div class="mb-3">
                    <label class="login-label">
                        <i class="bi bi-person-circle animated-icon"></i> Usu√°rio ou E-mail
                    </label>
                    <input type="text" class="form-control" id="loginUsername" required autocomplete="username" placeholder="Digite seu usu√°rio ou e-mail">
                </div>
                <div class="mb-3">
                    <label class="login-label">
                        <i class="bi bi-shield-lock animated-icon"></i> Senha
                    </label>
                    <input type="password" class="form-control" id="loginPassword" required autocomplete="current-password" placeholder="Digite sua senha">
                </div>

                <!-- Checkbox Lembrar por 7 dias -->
                <div class="mb-3 remember-box">
                    <input type="checkbox" id="rememberMe" class="remember-checkbox">
                    <label for="rememberMe" class="remember-label">
                        <i class="bi bi-clock-history"></i> Lembrar-se de mim por 7 dias
                    </label>
                </div>

                <div class="alert alert-info info-box">
                    <strong class="info-title">
                        <i class="bi bi-info-circle"></i> Acesso Padr√£o:
                    </strong>
                    <div class="info-content">
                        <div class="info-item"><strong>Usu√°rio:</strong> <code class="info-code">admin</code></div>
                        <div class="info-item"><strong>Senha:</strong> <code class="info-code">admin123</code></div>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary w-100 login-btn" id="btnLogin">
                    <span class="btn-content">
                        <i class="bi bi-box-arrow-in-right"></i> ENTRAR NO SISTEMA
                    </span>
                    <span class="btn-loading" style="display: none;">
                        <span class="modern-spinner"></span>
                        AUTENTICANDO...
                    </span>
                </button>
            </form>
        </div>
        <div id="registerForm" style="display:none">
            <form onsubmit="return handleRegister(event)">
                <div class="mb-3"><label>Nome Completo *</label><input type="text" class="form-control" id="registerName" required></div>
                <div class="mb-3"><label>Usu√°rio *</label><input type="text" class="form-control" id="registerUsername" required autocomplete="username"></div>
                <div class="mb-3"><label>E-mail *</label><input type="email" class="form-control" id="registerEmail" required autocomplete="email"></div>
                <div class="mb-3"><label>Telefone (opcional)</label><input type="text" class="form-control" id="registerTelefone" placeholder="(34) 99999-9999"></div>
                <div class="mb-3"><label>Senha *</label><input type="password" class="form-control" id="registerPassword" required minlength="6" autocomplete="new-password"></div>
                <div class="alert alert-success"><strong>‚úÖ Privil√©gios ADMIN</strong><br>Todos os novos usu√°rios recebem acesso completo ao sistema!</div>
                <button type="submit" class="btn btn-primary w-100"><i class="bi bi-person-plus"></i> Criar Conta</button>
            </form>
        </div>
    </div>
</div>

<div id="app">
    <nav class="sidebar">
        <div class="sidebar-logo"><h1>BIOMA</h1><p>Uberaba v4.0</p></div>
        <ul class="sidebar-menu">
            <li><a href="javascript:void(0)" onclick="goTo('dashboard'); return false;" class="active" id="menu-dashboard"><i class="bi bi-speedometer2"></i> Dashboard</a></li>
            <li><a href="javascript:void(0)" onclick="goTo('orcamento'); return false;" id="menu-orcamento"><i class="bi bi-file-earmark-plus"></i> Novo Or√ßamento</a></li>
            <li><a href="javascript:void(0)" onclick="goTo('consultar'); return false;" id="menu-consultar"><i class="bi bi-search"></i> Consultar</a></li>
            <li><a href="javascript:void(0)" onclick="goTo('contratos'); return false;" id="menu-contratos"><i class="bi bi-file-earmark-check"></i> Contratos</a></li>
            <li><a href="javascript:void(0)" onclick="goTo('relatorios'); return false;" id="menu-relatorios"><i class="bi bi-bar-chart-line"></i> Relat√≥rios</a></li>
            <li><a href="javascript:void(0)" onclick="goTo('perfil'); return false;" id="menu-perfil"><i class="bi bi-person-circle"></i> Perfil</a></li>
            <li><a href="javascript:void(0)" onclick="goTo('comissoes'); return false;" id="menu-comissoes"><i class="bi bi-cash-stack"></i> Comiss√µes</a></li>
            <li><a href="javascript:void(0)" onclick="goTo('financeiro'); return false;" id="menu-financeiro"><i class="bi bi-currency-dollar"></i> Financeiro</a></li>
            <li><a href="javascript:void(0)" onclick="goTo('estoque'); return false;" id="menu-estoque"><i class="bi bi-box-seam"></i> Estoque</a></li>
            <li><a href="javascript:void(0)" onclick="goTo('agendamentos'); return false;" id="menu-agendamentos"><i class="bi bi-calendar-check"></i> Agendamentos</a></li>
            <li><a href="javascript:void(0)" onclick="goTo('fila'); return false;" id="menu-fila"><i class="bi bi-people-fill"></i> Fila</a></li>
            <li><a href="javascript:void(0)" onclick="goTo('clientes'); return false;" id="menu-clientes"><i class="bi bi-people"></i> Clientes</a></li>
            <li><a href="javascript:void(0)" onclick="goTo('profissionais'); return false;" id="menu-profissionais"><i class="bi bi-person-workspace"></i> Profissionais</a></li>
            <li><a href="javascript:void(0)" onclick="goTo('servicos'); return false;" id="menu-servicos"><i class="bi bi-scissors"></i> Servi√ßos</a></li>
            <li><a href="javascript:void(0)" onclick="goTo('produtos'); return false;" id="menu-produtos"><i class="bi bi-box-seam"></i> Produtos</a></li>
            <li><a href="javascript:void(0)" onclick="goTo('clube'); return false;" id="menu-clube"><i class="bi bi-award"></i> Comunidade</a></li>
            <li><a href="javascript:void(0)" onclick="goTo('importar'); return false;" id="menu-importar"><i class="bi bi-cloud-upload"></i> Importar</a></li>
            <li><a href="javascript:void(0)" onclick="goTo('sistema'); return false;" id="menu-sistema"><i class="bi bi-activity"></i> Sistema</a></li>
            <li><a href="javascript:void(0)" onclick="goTo('auditoria'); return false;" id="menu-auditoria"><i class="bi bi-shield-check"></i> Auditoria</a></li>
            <li><a href="javascript:void(0)" onclick="goTo('configuracoes'); return false;" id="menu-configuracoes"><i class="bi bi-gear"></i> Configura√ß√µes</a></li>
            <li><a href="javascript:void(0)" onclick="doLogout(); return false;"><i class="bi bi-box-arrow-right"></i> Sair</a></li>
        </ul>
        <div class="theme-toggle"><button onclick="toggleTheme()"><i class="bi bi-moon-stars-fill" id="themeIcon"></i><span id="themeText">Modo Escuro</span></button></div>

        <!-- Indicador de Conectividade -->
        <div id="connectivity-indicator" class="connectivity-indicator online" title="Conectado ao servidor">
            <i class="bi bi-wifi"></i> Online
        </div>
    </nav>

    <div class="main-content">
<div class="global-search-container">
    <div class="global-search-field">
        <i class="bi bi-search"></i>
        <input type="text" class="global-search-input" id="globalSearchInput" placeholder="Pesquisar clientes, produtos, servi√ßos, profissionais, contratos..." oninput="buscarGlobal(this.value)">
        <button class="btn btn-outline" type="button" onclick="executarBuscaGlobal()"><i class="bi bi-arrow-repeat"></i></button>
    </div>
    <div id="globalSearchResults" class="global-search-results"></div>
</div>

        <div id="section-dashboard" class="content-section active">
            <div class="page-header">
                <h1><i class="bi bi-speedometer2"></i> Dashboard</h1>
                <button class="btn btn-primary btn-refresh" onclick="refreshData(this, loadDashboard, 'Dashboard atualizado')">
                    <i class="bi bi-arrow-clockwise"></i> Atualizar
                </button>
            </div>
            <div class="row g-4 mb-4">
                <div class="col-lg-3 col-md-6"><div class="stat-card"><div class="icon"><i class="bi bi-file-earmark-text"></i></div><h3 id="dashOrcamentos">0</h3><p>Or√ßamentos</p></div></div>
                <div class="col-lg-3 col-md-6"><div class="stat-card"><div class="icon"><i class="bi bi-people"></i></div><h3 id="dashClientes">0</h3><p>Clientes</p></div></div>
                <div class="col-lg-3 col-md-6"><div class="stat-card"><div class="icon"><i class="bi bi-calendar-check"></i></div><h3 id="dashAgendamentos">0</h3><p>Agendamentos Hoje</p></div></div>
                <div class="col-lg-3 col-md-6"><div class="stat-card"><div class="icon"><i class="bi bi-currency-dollar"></i></div><h3 id="dashFaturamento">R$ 0</h3><p>Faturamento</p></div></div>
            </div>
            <div class="row g-4">
                <div class="col-md-12"><div class="card"><div class="card-header"><i class="bi bi-calendar-event"></i> Pr√≥ximos Agendamentos</div><div class="card-body" id="proximosAgendamentos"><div class="spinner"></div></div></div></div>
            </div>
            <div class="card mt-4"><div class="card-header"><i class="bi bi-clock-history"></i> √öltimos Or√ßamentos</div><div class="card-body"><div class="table-responsive"><table><thead><tr><th>N¬∫</th><th>Data</th><th>Cliente</th><th>Valor</th><th>Status</th></tr></thead><tbody id="ultimosOrcamentosBody"><tr><td colspan="5" class="text-center"><div class="spinner"></div></td></tr></tbody></table></div></div></div>

            <!-- ALERTA DE ESTOQUE BAIXO -->
            <div id="alertaEstoqueBaixo" class="card mt-4" style="display: none; border-left: 5px solid var(--danger);">
                <div class="card-header" style="background: linear-gradient(135deg, var(--danger), #DC2626);">
                    <i class="bi bi-exclamation-triangle-fill"></i> ‚ö†Ô∏è Alerta de Estoque Baixo
                </div>
                <div class="card-body">
                    <div class="alert alert-warning" style="margin-bottom: 15px;">
                        <strong>Aten√ß√£o!</strong> Os seguintes produtos est√£o com estoque abaixo do m√≠nimo:
                    </div>
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>Produto</th>
                                    <th>Marca</th>
                                    <th>Estoque Atual</th>
                                    <th>M√≠nimo</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="estoqueBaixoBody">
                                <tr><td colspan="5" class="text-center"><div class="spinner"></div></td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="section-orcamento" class="content-section">
            <div class="page-header">
                <h1><i class="bi bi-file-earmark-plus"></i> Or√ßamentos</h1>
            </div>
            
            <!-- Sub-tabs de Or√ßamentos -->
            <div class="sub-tabs" style="margin-bottom:25px;">
                <button class="sub-tab-btn active" onclick="switchSubTab('orcamento', 'novo')">
                    <i class="bi bi-file-earmark-plus"></i> Novo Or√ßamento
                </button>
                <button class="sub-tab-btn" onclick="switchSubTab('orcamento', 'pendentes')">
                    <i class="bi bi-clock-history"></i> Pendentes
                </button>
                <button class="sub-tab-btn" onclick="switchSubTab('orcamento', 'aprovados')">
                    <i class="bi bi-check-circle"></i> Aprovados
                </button>
                <button class="sub-tab-btn" onclick="switchSubTab('orcamento', 'rejeitados')">
                    <i class="bi bi-x-circle"></i> Rejeitados
                </button>
                <button class="sub-tab-btn" onclick="switchSubTab('orcamento', 'historico')">
                    <i class="bi bi-file-earmark-text"></i> Hist√≥rico
                </button>
            </div>
            
            <!-- Sub-tab: Novo Or√ßamento -->
            <div id="orcamento-subtab-novo" class="sub-tab-content active">
            <div class="card"><div class="card-header"><i class="bi bi-person-badge"></i> Dados do Cliente</div><div class="card-body"><div class="row g-3 mb-3"><div class="col-md-6"><label style="display:block;font-weight:700;margin-bottom:10px">CPF *</label><div style="position:relative"><input type="text" id="orcCPF" placeholder="Digite o CPF..." maxlength="14" class="form-control" onkeyup="buscarClientePorCPF()"><div id="cpfResults" class="autocomplete-results"></div></div></div><div class="col-md-6"><label style="display:block;font-weight:700;margin-bottom:10px">Nome Completo *</label><input type="text" id="orcNomeCliente" placeholder="Nome do cliente" class="form-control"></div></div><div class="row g-3 mb-3"><div class="col-md-6"><label style="display:block;font-weight:700;margin-bottom:10px">E-mail</label><input type="email" id="orcEmail" placeholder="email@exemplo.com" class="form-control"></div><div class="col-md-6"><label style="display:block;font-weight:700;margin-bottom:10px">Telefone</label><input type="text" id="orcTelefone" placeholder="(34) 99999-9999" class="form-control"></div></div><button class="btn btn-outline" onclick="limparCliente()"><i class="bi bi-x-circle"></i> Limpar</button></div></div>
            <h2 style="margin:40px 0 20px;color:var(--text-primary);padding-left:20px;border-left:6px solid var(--primary)"><i class="bi bi-scissors"></i> SERVI√áOS</h2>
            <div class="card"><div class="card-header"><i class="bi bi-plus-circle"></i> Adicionar Servi√ßo</div><div class="card-body"><div class="row g-3"><div class="col-md-3"><label>Buscar Servi√ßo</label><div style="position:relative"><input type="text" id="buscaServico" placeholder="Digite..." class="form-control" onkeyup="buscarServicos()"><div id="servicoResults" class="autocomplete-results"></div></div></div><div class="col-md-2"><label>Tamanho</label><select id="servicoTamanho" class="form-select"><option value="">Selecione...</option></select></div><div class="col-md-2"><label>Qtd</label><input type="number" id="servicoQtd" value="1" min="1" class="form-control"></div><div class="col-md-2"><label>Pre√ßo</label><input type="number" id="servicoPreco" step="0.01" class="form-control"></div><div class="col-md-2"><label>Desc %</label><input type="number" id="servicoDesconto" value="0" min="0" max="100" class="form-control"></div><div class="col-md-1"><label>&nbsp;</label><button class="btn btn-primary w-100" onclick="addServico()"><i class="bi bi-plus"></i></button></div></div></div></div>
            <div class="card"><div class="card-header"><i class="bi bi-list-check"></i> Servi√ßos Adicionados</div><div class="card-body"><div class="table-responsive"><table><thead><tr><th>Servi√ßo</th><th>Tamanho</th><th>Qtd</th><th>Pre√ßo Unit.</th><th>Desc %</th><th>Total</th><th></th></tr></thead><tbody id="servicosBody"><tr><td colspan="7" class="text-center text-muted">Nenhum servi√ßo</td></tr></tbody><tfoot><tr><th colspan="5" style="text-align:right;padding:20px 18px;background:var(--bg-main);font-weight:800;border-top:4px solid var(--primary)">SUBTOTAL SERVI√áOS</th><th id="subtotalServicos" colspan="2" style="padding:20px 18px;background:var(--bg-main);font-weight:800;border-top:4px solid var(--primary)">R$ 0,00</th></tr></tfoot></table></div></div></div>
            <h2 style="margin:40px 0 20px;color:var(--text-primary);padding-left:20px;border-left:6px solid var(--primary)"><i class="bi bi-box-seam"></i> PRODUTOS</h2>
            <div class="card"><div class="card-header"><i class="bi bi-plus-circle"></i> Adicionar Produto</div><div class="card-body"><div class="row g-3"><div class="col-md-4"><label>Buscar Produto</label><div style="position:relative"><input type="text" id="buscaProduto" placeholder="Digite..." class="form-control" onkeyup="buscarProdutos()"><div id="produtoResults" class="autocomplete-results"></div></div></div><div class="col-md-2"><label>Qtd</label><input type="number" id="produtoQtd" value="1" min="1" class="form-control"></div><div class="col-md-2"><label>Pre√ßo</label><input type="number" id="produtoPreco" step="0.01" class="form-control"></div><div class="col-md-2"><label>Desc %</label><input type="number" id="produtoDesconto" value="0" min="0" max="100" class="form-control"></div><div class="col-md-2"><label>&nbsp;</label><button class="btn btn-primary w-100" onclick="addProduto()"><i class="bi bi-plus"></i> Add</button></div></div></div></div>
            <div class="card"><div class="card-header"><i class="bi bi-list-check"></i> Produtos Adicionados</div><div class="card-body"><div class="table-responsive"><table><thead><tr><th>Produto</th><th>Marca</th><th>Qtd</th><th>Pre√ßo Unit.</th><th>Desc %</th><th>Total</th><th></th></tr></thead><tbody id="produtosBody"><tr><td colspan="7" class="text-center text-muted">Nenhum produto</td></tr></tbody><tfoot><tr><th colspan="5" style="text-align:right;padding:20px 18px;background:var(--bg-main);font-weight:800;border-top:4px solid var(--primary)">SUBTOTAL PRODUTOS</th><th id="subtotalProdutos" colspan="2" style="padding:20px 18px;background:var(--bg-main);font-weight:800;border-top:4px solid var(--primary)">R$ 0,00</th></tr></tfoot></table></div></div></div>
            
            <!-- SE√á√ÉO DE PROFISSIONAIS VINCULADOS -->
            <h2 style="margin:40px 0 20px;color:var(--text-primary);padding-left:20px;border-left:6px solid var(--primary)">
                <i class="bi bi-people-fill"></i> PROFISSIONAIS E COMISS√ïES
            </h2>
            
            <!-- Hidden fields para profissional selecionado -->
            <input type="hidden" id="profissionalSelecionadoId">
            <input type="hidden" id="profissionalSelecionadoNome">
            <input type="hidden" id="profissionalSelecionadoTipo">
            <input type="hidden" id="profissionalSelecionadoFoto">
            
            <div class="card">
                <div class="card-header">
                    <i class="bi bi-person-plus-fill"></i> Vincular Profissional/Assistente
                </div>
                <div class="card-body">
                    <div class="alert alert-info" style="margin-bottom:20px;">
                        <i class="bi bi-info-circle"></i> 
                        <strong>Multicomiss√µes:</strong> Voc√™ pode adicionar m√∫ltiplos profissionais e assistentes ao or√ßamento. 
                        Cada um receber√° a comiss√£o percentual sobre o valor total.
                    </div>
                    
                    <div class="row g-3 mb-3">
                        <div class="col-md-5">
                            <label class="form-label" style="font-weight:700;">Buscar Profissional/Assistente</label>
                            <div style="position:relative;">
                                <input 
                                    type="text" 
                                    id="buscaProfissionalOrc" 
                                    placeholder="Digite o nome..." 
                                    class="form-control" 
                                    onkeyup="buscarProfissionaisOrcamento()"
                                    autocomplete="off"
                                >
                                <div id="profissionalOrcResults" class="autocomplete-results"></div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label" style="font-weight:700;">Comiss√£o %</label>
                            <input 
                                type="number" 
                                id="profComissaoPerc" 
                                min="0" 
                                max="100" 
                                step="0.5" 
                                value="10" 
                                class="form-control"
                            >
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">&nbsp;</label>
                            <button class="btn btn-primary w-100" onclick="addProfissionalOrcamento()" style="font-weight:700;">
                                <i class="bi bi-plus-circle"></i> Adicionar ao Or√ßamento
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tabela de Profissionais Vinculados -->
            <div class="card">
                <div class="card-header">
                    <i class="bi bi-list-check"></i> Profissionais Vinculados ao Or√ßamento
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th style="width:60px;">Foto</th>
                                    <th>Nome</th>
                                    <th>Tipo</th>
                                    <th>Comiss√£o %</th>
                                    <th>Valor Estimado</th>
                                    <th style="width:80px;">A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="profissionaisVinculadosBody">
                                <tr>
                                    <td colspan="6" class="text-center text-muted" style="padding:30px;">
                                        <i class="bi bi-person-x" style="font-size:2rem;color:var(--text-muted);display:block;margin-bottom:10px;"></i>
                                        Nenhum profissional vinculado ao or√ßamento
                                    </td>
                                </tr>
                            </tbody>
                            <tfoot id="profissionaisVinculadosFooter" style="display:none;">
                                <tr>
                                    <th colspan="4" style="text-align:right;padding:20px 18px;background:var(--bg-main);font-weight:800;border-top:4px solid var(--success);">
                                        TOTAL DE COMISS√ïES
                                    </th>
                                    <th colspan="2" id="totalComissoes" style="padding:20px 18px;background:var(--bg-main);font-weight:800;border-top:4px solid var(--success);color:var(--success);">
                                        R$ 0,00
                                    </th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
            <!-- FIM SE√á√ÉO DE PROFISSIONAIS -->
            
            <div class="card"><div class="card-header"><i class="bi bi-calculator"></i> Resumo e Pagamento</div><div class="card-body"><div class="row g-3 mb-3"><div class="col-md-4"><label>Desconto Global %</label><input type="number" id="descontoGlobal" value="0" min="0" max="100" onchange="calcularTotais()" class="form-control"></div><div class="col-md-4"><label>Cashback %</label><input type="number" id="cashbackPerc" value="0" min="0" max="100" onchange="calcularTotais()" class="form-control"></div><div class="col-md-4"><label>Forma de Pagamento</label><select id="pagamento" class="form-select"><option>Pix</option><option>D√©bito</option><option>Cr√©dito √† Vista</option><option>Cr√©dito Parcelado</option><option>Dinheiro</option></select></div></div><div style="background:linear-gradient(135deg,var(--primary),var(--secondary));color:#fff;padding:40px;border-radius:22px;margin:30px 0;box-shadow:0 15px 40px rgba(124,58,237,0.4)"><div class="row align-items-center"><div class="col-md-6"><h3 id="totalFinalOrc" style="font-size:3.5rem;font-weight:900;margin:0;text-shadow:2px 2px 8px rgba(0,0,0,0.3)">R$ 0,00</h3><p style="font-size:1.3rem;margin:10px 0 0;opacity:0.95">TOTAL</p></div><div class="col-md-6" style="text-align:right"><p id="cashbackValor" style="font-size:1.5rem;margin:0;font-weight:700">üéÅ Cashback: R$ 0,00</p></div></div></div><div style="text-align:center;margin-top:30px"><button class="bioma-btn bioma-btn-secondary" onclick="cancelarOrc()"><i class="bi bi-x-circle"></i> Cancelar</button> <button class="btn btn-outline" onclick="salvarOrc('Pendente')"><i class="bi bi-save"></i> Salvar Rascunho</button> <button class="bioma-btn bioma-btn-success" onclick="salvarOrc('Aprovado')"><i class="bi bi-check-circle"></i> Gerar Contrato</button></div></div></div>
            </div><!-- Fim sub-tab novo -->
            
            <!-- Sub-tab: Pendentes -->
            <div id="orcamento-subtab-pendentes" class="sub-tab-content">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-clock-history"></i> Or√ßamentos Pendentes
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Data</th>
                                        <th>Cliente</th>
                                        <th>CPF</th>
                                        <th>Valor Total</th>
                                        <th>Profissionais</th>
                                        <th>A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody id="orcamentosPendentesBody">
                                    <tr><td colspan="6" class="text-center text-muted">Carregando...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Sub-tab: Aprovados -->
            <div id="orcamento-subtab-aprovados" class="sub-tab-content">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-check-circle"></i> Or√ßamentos Aprovados
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Data</th>
                                        <th>Cliente</th>
                                        <th>CPF</th>
                                        <th>Valor Total</th>
                                        <th>Pagamento</th>
                                        <th>A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody id="orcamentosAprovadosBody">
                                    <tr><td colspan="6" class="text-center text-muted">Carregando...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Sub-tab: Rejeitados -->
            <div id="orcamento-subtab-rejeitados" class="sub-tab-content">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-x-circle"></i> Or√ßamentos Rejeitados
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Data</th>
                                        <th>Cliente</th>
                                        <th>CPF</th>
                                        <th>Valor Total</th>
                                        <th>Motivo</th>
                                        <th>A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody id="orcamentosRejeitadosBody">
                                    <tr><td colspan="6" class="text-center text-muted">Carregando...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Sub-tab: Hist√≥rico -->
            <div id="orcamento-subtab-historico" class="sub-tab-content">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-file-earmark-text"></i> Hist√≥rico Completo
                    </div>
                    <div class="card-body">
                        <div class="row g-3 mb-3">
                            <div class="col-md-3">
                                <label>Per√≠odo</label>
                                <select id="filtroHistoricoPeriodo" class="form-select" onchange="carregarHistoricoOrcamentos()">
                                    <option value="7">√öltimos 7 dias</option>
                                    <option value="30" selected>√öltimos 30 dias</option>
                                    <option value="90">√öltimos 3 meses</option>
                                    <option value="180">√öltimos 6 meses</option>
                                    <option value="365">√öltimo ano</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label>Status</label>
                                <select id="filtroHistoricoStatus" class="form-select" onchange="carregarHistoricoOrcamentos()">
                                    <option value="">Todos</option>
                                    <option value="Pendente">Pendente</option>
                                    <option value="Aprovado">Aprovado</option>
                                    <option value="Rejeitado">Rejeitado</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label>Buscar Cliente</label>
                                <input type="text" id="filtroHistoricoCliente" class="form-control" placeholder="Nome ou CPF" onkeyup="carregarHistoricoOrcamentos()">
                            </div>
                            <div class="col-md-2">
                                <label>&nbsp;</label>
                                <button class="btn btn-outline w-100" onclick="carregarHistoricoOrcamentos()">
                                    <i class="bi bi-search"></i> Filtrar
                                </button>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Data</th>
                                        <th>Cliente</th>
                                        <th>CPF</th>
                                        <th>Valor Total</th>
                                        <th>Status</th>
                                        <th>A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody id="orcamentosHistoricoBody">
                                    <tr><td colspan="6" class="text-center text-muted">Carregando...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
        </div>

        <div id="section-consultar" class="content-section">
            <div class="page-header">
                <h1><i class="bi bi-search"></i> Consultar Or√ßamentos</h1>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-success btn-sm" onclick="exportarOrcamentosExcel()" title="Exportar para Excel">
                        <i class="bi bi-file-earmark-excel"></i> Excel
                    </button>
                    <button class="btn btn-info btn-sm" onclick="exportarOrcamentosCSV()" title="Exportar para CSV">
                        <i class="bi bi-file-earmark-text"></i> CSV
                    </button>
                </div>
            </div>

            <!-- Filtros e Pesquisa -->
            <div class="card mb-3">
                <div class="card-body" style="padding: 15px;">
                    <div class="row g-3 align-items-end">
                        <div class="col-md-4">
                            <label style="display: block; margin-bottom: 5px; font-size: 0.9em; color: #6c757d;">
                                <i class="bi bi-search"></i> Pesquisar
                            </label>
                            <input type="text" id="consultaSearch" class="form-control" placeholder="Buscar por n√∫mero, cliente..."
                                   oninput="filtrarOrcamentos()" style="font-size: 0.95em;">
                        </div>
                        <div class="col-md-2">
                            <label style="display: block; margin-bottom: 5px; font-size: 0.9em; color: #6c757d;">
                                <i class="bi bi-funnel"></i> Status
                            </label>
                            <select id="consultaStatusFilter" class="form-control" onchange="filtrarOrcamentos()" style="font-size: 0.95em;">
                                <option value="">Todos</option>
                                <option value="Pendente">Pendente</option>
                                <option value="Aprovado">Aprovado</option>
                                <option value="Cancelado">Cancelado</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label style="display: block; margin-bottom: 5px; font-size: 0.9em; color: #6c757d;">
                                <i class="bi bi-calendar"></i> Data In√≠cio
                            </label>
                            <input type="date" id="consultaDataInicio" class="form-control" onchange="filtrarOrcamentos()" style="font-size: 0.95em;">
                        </div>
                        <div class="col-md-2">
                            <label style="display: block; margin-bottom: 5px; font-size: 0.9em; color: #6c757d;">
                                <i class="bi bi-calendar-check"></i> Data Fim
                            </label>
                            <input type="date" id="consultaDataFim" class="form-control" onchange="filtrarOrcamentos()" style="font-size: 0.95em;">
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-outline w-100" onclick="limparFiltrosOrcamentos()" style="font-size: 0.95em;">
                                <i class="bi bi-x-circle"></i> Limpar
                            </button>
                        </div>
                    </div>
                    <div style="margin-top: 10px; font-size: 0.85em; color: #6c757d;">
                        <i class="bi bi-info-circle"></i> <span id="consultaResultCount">Carregando...</span>
                    </div>
                </div>
            </div>

            <div class="card"><div class="card-header"><i class="bi bi-list-ul"></i> Todos os Or√ßamentos</div><div class="card-body"><div class="table-responsive"><table><thead><tr><th>N¬∫</th><th>Data</th><th>Cliente</th><th>Total</th><th>Status</th><th>A√ß√µes</th></tr></thead><tbody id="consultaBody"><tr><td colspan="6" class="text-center"><div class="spinner"></div></td></tr></tbody></table></div></div></div>
        </div>

        <div id="section-contratos" class="content-section">
            <div class="page-header">
                <h1><i class="bi bi-file-earmark-check icon-glamour-shine"></i> Contratos Aprovados</h1>
            </div>
            <div class="card">
                <div class="card-header"><i class="bi bi-file-check-fill icon-glamour-shine"></i> Or√ßamentos Aprovados como Contratos</div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>N¬∫ Or√ßamento</th>
                                    <th>Data Aprova√ß√£o</th>
                                    <th>Cliente</th>
                                    <th>Valor Total</th>
                                    <th>Status</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="contratosBody">
                                <tr><td colspan="6" class="text-center text-muted">Carregando contratos...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="section-relatorios" class="content-section">
            <div class="page-header">
                <h1><i class="bi bi-bar-chart-line"></i> Relat√≥rios e An√°lises</h1>
                <div style="display: flex; gap: 10px;">
                    <button class="bioma-btn bioma-btn-primary" onclick="atualizarRelatorios()">
                        <i class="bi bi-arrow-clockwise"></i> Atualizar
                    </button>
                    <button class="bioma-btn bioma-btn-danger" onclick="exportarRelatoriosPDF()">
                        <i class="bi bi-file-earmark-pdf"></i> Exportar PDF
                    </button>
                    <button class="bioma-btn bioma-btn-success" onclick="exportarRelatorio()"><i class="bi bi-file-earmark-excel"></i> Exportar Excel</button>
                </div>
            </div>

            <!-- Filtros de Data para Relat√≥rios -->
            <div class="card mb-4">
                <div class="card-header">
                    <i class="bi bi-funnel"></i> Filtros de Per√≠odo
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label">Data In√≠cio</label>
                            <input type="date" id="relatorioDataInicio" class="form-control" onchange="aplicarFiltrosRelatorios()">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Data Fim</label>
                            <input type="date" id="relatorioDataFim" class="form-control" onchange="aplicarFiltrosRelatorios()">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Per√≠odo R√°pido</label>
                            <select class="form-select" id="relatorioPeriodoRapido" onchange="aplicarPeriodoRapidoRelatorios(this.value)">
                                <option value="">Personalizado</option>
                                <option value="hoje">Hoje</option>
                                <option value="semana">Esta Semana</option>
                                <option value="mes">Este M√™s</option>
                                <option value="trimestre">√öltimos 3 Meses</option>
                                <option value="semestre">√öltimos 6 Meses</option>
                                <option value="ano">Este Ano</option>
                                <option value="tudo" selected>Tudo</option>
                            </select>
                        </div>
                        <div class="col-md-3 d-flex align-items-end">
                            <button class="bioma-btn bioma-btn-outline w-100" onclick="limparFiltrosRelatorios()">
                                <i class="bi bi-x-circle"></i> Limpar Filtros
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sub-tabs para Relat√≥rios -->
            <div class="sub-tabs">
                <button class="sub-tab-btn active" onclick="showSubTab('relatorios', 'resumo')">
                    <i class="bi bi-graph-up"></i> Resumo
                </button>
                <button class="sub-tab-btn" onclick="showSubTab('relatorios', 'mapa')">
                    <i class="bi bi-calendar-heat"></i> Mapa de Calor
                </button>
                <button class="sub-tab-btn" onclick="showSubTab('relatorios', 'clientes')">
                    <i class="bi bi-people-fill"></i> Top Clientes
                </button>
                <button class="sub-tab-btn" onclick="showSubTab('relatorios', 'produtos')">
                    <i class="bi bi-box-seam"></i> Top Produtos
                </button>
            </div>

            <!-- Sub-tab: Resumo -->
            <div id="relatorios-resumo" class="sub-tab-content active">
                <div class="row g-4 mb-4">
                    <div class="col-md-3"><div class="stat-card"><div class="icon"><i class="bi bi-cash-stack"></i></div><h3 id="relFaturamentoTotal">R$ 0</h3><p>Faturamento Total</p></div></div>
                    <div class="col-md-3"><div class="stat-card"><div class="icon"><i class="bi bi-calendar-month"></i></div><h3 id="relFaturamentoMes">R$ 0</h3><p>Faturamento M√™s</p></div></div>
                    <div class="col-md-3"><div class="stat-card"><div class="icon"><i class="bi bi-award"></i></div><h3 id="relCashbackTotal">R$ 0</h3><p>Cashback Gerado</p></div></div>
                    <div class="col-md-3"><div class="stat-card"><div class="icon"><i class="bi bi-graph-up"></i></div><h3 id="relTicketMedio">R$ 0</h3><p>Ticket M√©dio</p></div></div>
                </div>
                <div class="row g-4">
                    <div class="col-md-6"><div class="card"><div class="card-header"><i class="bi bi-trophy"></i> Top 5 Servi√ßos</div><div class="card-body"><canvas id="chartServicos" style="max-height:300px"></canvas></div></div></div>
                    <div class="col-md-6"><div class="card"><div class="card-header"><i class="bi bi-calendar3"></i> Faturamento Mensal</div><div class="card-body"><canvas id="chartFaturamento" style="max-height:300px"></canvas></div></div></div>
                </div>
            </div>

            <!-- Sub-tab: Mapa de Calor -->
            <div id="relatorios-mapa" class="sub-tab-content">
                <div class="card mb-4">
                    <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                        <span><i class="bi bi-calendar-heat"></i> Mapa de Calor - Dias Mais Movimentados</span>
                        <button class="bioma-btn bioma-btn-sm bioma-btn-primary" onclick="carregarMapaCalor()" title="Atualizar Mapa de Calor">
                            <i class="bi bi-arrow-clockwise"></i> Atualizar
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i> Este mapa mostra os dias mais movimentados da unidade nos √∫ltimos 90 dias.
                            Quanto mais escuro, mais atendimentos realizados.
                        </div>
                        <div id="mapaCalorContainer" class="mapa-calor-grid">
                            <div class="spinner"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sub-tab: Top Clientes -->
            <div id="relatorios-clientes" class="sub-tab-content">
                <div class="card">
                    <div class="card-header"><i class="bi bi-people-fill"></i> Top 10 Clientes VIP</div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table>
                                <thead><tr><th>Posi√ß√£o</th><th>Cliente</th><th>Total Gasto</th><th>Visitas</th><th>√öltima Visita</th></tr></thead>
                                <tbody id="topClientesBody"><tr><td colspan="5" class="text-center text-muted">Clique em "Atualizar"</td></tr></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sub-tab: Top Produtos -->
            <div id="relatorios-produtos" class="sub-tab-content">
                <div class="card">
                    <div class="card-header"><i class="bi bi-box-seam"></i> Produtos Mais Vendidos</div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table>
                                <thead><tr><th>Produto</th><th>Qtd Vendida</th><th>Faturamento</th></tr></thead>
                                <tbody id="topProdutosBody"><tr><td colspan="3" class="text-center text-muted">Clique em "Atualizar"</td></tr></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="section-agendamentos" class="content-section">
            <div class="page-header">
                <h1><i class="bi bi-calendar-check"></i> Agendamentos</h1>
            </div>

            <!-- Sub-tabs de Agendamentos -->
            <div class="sub-tabs" style="margin-bottom:25px;">
                <button class="sub-tab-btn sub-tab-green-animated" onclick="switchSubTab('agendamentos', 'novo')">
                    <i class="bi bi-plus-circle-fill"></i> Novo Agendamento
                </button>
                <button class="sub-tab-btn active" onclick="switchSubTab('agendamentos', 'hoje')">
                    <i class="bi bi-calendar-day"></i> Hoje
                </button>
                <button class="sub-tab-btn" onclick="switchSubTab('agendamentos', 'semana')">
                    <i class="bi bi-calendar-week"></i> Esta Semana
                </button>
                <button class="sub-tab-btn" onclick="switchSubTab('agendamentos', 'mes')">
                    <i class="bi bi-calendar-month"></i> Este M√™s
                </button>
                <button class="sub-tab-btn" onclick="switchSubTab('agendamentos', 'todos')">
                    <i class="bi bi-calendar3"></i> Todos
                </button>
            </div>

            <!-- Sub-tab: Novo Agendamento -->
            <div id="agendamentos-subtab-novo" class="sub-tab-content">
                <div class="card">
                    <div class="card-header" style="background: linear-gradient(135deg, #10B981, #059669);">
                        <i class="bi bi-plus-circle-fill"></i> Criar Novo Agendamento
                    </div>
                    <div class="card-body">
                        <form id="formNovoAgendamento">
                            <div class="row g-3">
                                <!-- Cliente -->
                                <div class="col-md-6">
                                    <label class="form-label"><i class="bi bi-person"></i> Cliente *</label>
                                    <select id="novoAgendCliente" class="form-select" required>
                                        <option value="">Selecione o cliente...</option>
                                    </select>
                                </div>

                                <!-- Profissional -->
                                <div class="col-md-6">
                                    <label class="form-label"><i class="bi bi-person-badge"></i> Profissional *</label>
                                    <select id="novoAgendProfissional" class="form-select" required>
                                        <option value="">Selecione o profissional...</option>
                                    </select>
                                </div>

                                <!-- Servi√ßo -->
                                <div class="col-md-12">
                                    <label class="form-label"><i class="bi bi-scissors"></i> Servi√ßo *</label>
                                    <select id="novoAgendServico" class="form-select" required>
                                        <option value="">Selecione o servi√ßo...</option>
                                    </select>
                                </div>

                                <!-- Data -->
                                <div class="col-md-6">
                                    <label class="form-label"><i class="bi bi-calendar"></i> Data *</label>
                                    <input type="date" id="novoAgendData" class="form-control" required>
                                </div>

                                <!-- Hor√°rio -->
                                <div class="col-md-6">
                                    <label class="form-label"><i class="bi bi-clock"></i> Hor√°rio *</label>
                                    <select id="novoAgendHorario" class="form-select" required>
                                        <option value="">Selecione...</option>
                                        <option value="08:00">08:00</option>
                                        <option value="08:30">08:30</option>
                                        <option value="09:00">09:00</option>
                                        <option value="09:30">09:30</option>
                                        <option value="10:00">10:00</option>
                                        <option value="10:30">10:30</option>
                                        <option value="11:00">11:00</option>
                                        <option value="11:30">11:30</option>
                                        <option value="13:00">13:00</option>
                                        <option value="13:30">13:30</option>
                                        <option value="14:00">14:00</option>
                                        <option value="14:30">14:30</option>
                                        <option value="15:00">15:00</option>
                                        <option value="15:30">15:30</option>
                                        <option value="16:00">16:00</option>
                                        <option value="16:30">16:30</option>
                                        <option value="17:00">17:00</option>
                                        <option value="17:30">17:30</option>
                                        <option value="18:00">18:00</option>
                                    </select>
                                </div>

                                <!-- Status -->
                                <div class="col-md-6">
                                    <label class="form-label"><i class="bi bi-check-circle"></i> Status *</label>
                                    <select id="novoAgendStatus" class="form-select" required>
                                        <option value="Pendente" selected>Pendente</option>
                                        <option value="Confirmado">Confirmado</option>
                                        <option value="Cancelado">Cancelado</option>
                                        <option value="Conclu√≠do">Conclu√≠do</option>
                                    </select>
                                </div>

                                <!-- Forma de Pagamento -->
                                <div class="col-md-6">
                                    <label class="form-label"><i class="bi bi-credit-card"></i> Forma de Pagamento</label>
                                    <select id="novoAgendFormaPagamento" class="form-select">
                                        <option value="">N√£o definido</option>
                                        <option value="Dinheiro">Dinheiro</option>
                                        <option value="PIX">PIX</option>
                                        <option value="D√©bito">D√©bito</option>
                                        <option value="Cr√©dito">Cr√©dito</option>
                                    </select>
                                </div>

                                <!-- Observa√ß√µes -->
                                <div class="col-12">
                                    <label class="form-label"><i class="bi bi-chat-left-text"></i> Observa√ß√µes</label>
                                    <textarea id="novoAgendObs" class="form-control" rows="3" placeholder="Observa√ß√µes sobre o agendamento..."></textarea>
                                </div>
                            </div>

                            <!-- Bot√µes -->
                            <div class="mt-4" style="display: flex; gap: 10px; justify-content: flex-end;">
                                <button type="button" class="bioma-btn bioma-btn-secondary" onclick="limparFormularioNovoAgendamento()">
                                    <i class="bi bi-x-circle"></i> Limpar
                                </button>
                                <button type="button" class="bioma-btn bioma-btn-success" onclick="salvarNovoAgendamento()">
                                    <i class="bi bi-check-circle"></i> Criar Agendamento
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Sub-tab: Hoje -->
            <div id="agendamentos-subtab-hoje" class="sub-tab-content active">
                <div class="row g-4 mb-4">
                    <div class="col-md-3">
                        <div class="stat-card" style="background:linear-gradient(135deg,#10b981,#059669);">
                            <div class="stat-icon"><i class="bi bi-calendar-check"></i></div>
                            <div class="stat-info">
                                <div class="stat-value" id="agendamentosHojeTotal">0</div>
                                <div class="stat-label">Agendamentos Hoje</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card" style="background:linear-gradient(135deg,#3b82f6,#2563eb);">
                            <div class="stat-icon"><i class="bi bi-clock"></i></div>
                            <div class="stat-info">
                                <div class="stat-value" id="agendamentosHojePendentes">0</div>
                                <div class="stat-label">Pendentes</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card" style="background:linear-gradient(135deg,#8b5cf6,#7c3aed);">
                            <div class="stat-icon"><i class="bi bi-check-circle"></i></div>
                            <div class="stat-info">
                                <div class="stat-value" id="agendamentosHojeConfirmados">0</div>
                                <div class="stat-label">Confirmados</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card" style="background:linear-gradient(135deg,#ef4444,#dc2626);">
                            <div class="stat-icon"><i class="bi bi-x-circle"></i></div>
                            <div class="stat-info">
                                <div class="stat-value" id="agendamentosHojeCancelados">0</div>
                                <div class="stat-label">Cancelados</div>
                            </div>
                        </div>
                    </div>
                </div>
            <div class="row g-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header"><i class="bi bi-calendar-day"></i> Agendamentos de Hoje</div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Hor√°rio</th>
                                            <th>Cliente</th>
                                            <th>Servi√ßo</th>
                                            <th>Tamanho</th>
                                            <th>Profissional</th>
                                            <th>Status</th>
                                            <th>A√ß√µes</th>
                                        </tr>
                                    </thead>
                                    <tbody id="agendamentosHojeBody">
                                        <tr><td colspan="7" class="text-center"><div class="spinner"></div></td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            </div>
            
            <!-- Sub-tab: Esta Semana -->
            <div id="agendamentos-subtab-semana" class="sub-tab-content d-none">
                <div class="card">
                    <div class="card-header"><i class="bi bi-calendar-week"></i> Agendamentos da Semana</div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Data</th>
                                        <th>Hor√°rio</th>
                                        <th>Cliente</th>
                                        <th>Servi√ßo</th>
                                        <th>Tamanho</th>
                                        <th>Profissional</th>
                                        <th>Status</th>
                                        <th>A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody id="agendamentosSemanaBody">
                                    <tr><td colspan="8" class="text-center"><div class="spinner"></div></td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Sub-tab: Este M√™s -->
            <div id="agendamentos-subtab-mes" class="sub-tab-content d-none">
                <div class="card">
                    <div class="card-header"><i class="bi bi-calendar-month"></i> Agendamentos do M√™s</div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Data</th>
                                        <th>Hor√°rio</th>
                                        <th>Cliente</th>
                                        <th>Servi√ßo</th>
                                        <th>Tamanho</th>
                                        <th>Profissional</th>
                                        <th>Status</th>
                                        <th>A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody id="agendamentosMesBody">
                                    <tr><td colspan="8" class="text-center"><div class="spinner"></div></td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sub-tab: Todos -->
            <div id="agendamentos-subtab-todos" class="sub-tab-content d-none">
                <div class="card">
                    <div class="card-header"><i class="bi bi-calendar3"></i> Todos os Agendamentos</div>
                    <div class="card-body">
                        <div class="row g-3 mb-3">
                            <div class="col-md-4">
                                <label>Data Inicial</label>
                                <input type="date" id="filtroAgendamentoDataInicio" class="form-control">
                            </div>
                            <div class="col-md-4">
                                <label>Data Final</label>
                                <input type="date" id="filtroAgendamentoDataFim" class="form-control">
                            </div>
                            <div class="col-md-4">
                                <label>Status</label>
                                <select id="filtroAgendamentoStatus" class="form-select">
                                    <option value="">Todos</option>
                                    <option value="Confirmado">Confirmado</option>
                                    <option value="Pendente">Pendente</option>
                                    <option value="Cancelado">Cancelado</option>
                                    <option value="Conclu√≠do">Conclu√≠do</option>
                                </select>
                            </div>
                        </div>
                        <button class="btn btn-primary mb-3" onclick="carregarTodosAgendamentos()">
                            <i class="bi bi-search"></i> Filtrar
                        </button>
                        <div class="table-responsive">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Data</th>
                                        <th>Hor√°rio</th>
                                        <th>Cliente</th>
                                        <th>Servi√ßo</th>
                                        <th>Tamanho</th>
                                        <th>Profissional</th>
                                        <th>Status</th>
                                        <th>A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody id="agendamentosTodosBody">
                                    <tr><td colspan="8" class="text-center"><div class="spinner"></div></td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="section-fila" class="content-section">
            <div class="page-header">
                <h1><i class="bi bi-people-fill"></i> Fila de Atendimento</h1>
                <button class="bioma-btn bioma-btn-primary" onclick="showModalFila()"><i class="bi bi-plus-circle"></i> Adicionar √† Fila</button>
            </div>
            <div class="card">
                <div class="card-header">
                    <i class="bi bi-list-ol"></i> Fila Atual 
                    <span class="badge success" style="margin-left: 10px; font-size: 1rem;">
                        <i class="bi bi-people"></i> <span id="totalFila">0</span> pessoas
                    </span>
                </div>
                <div class="card-body" id="filaContainer">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>

        <div id="section-clientes" class="content-section">
            <div class="page-header">
                <h1><i class="bi bi-people"></i> Clientes</h1>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn btn-primary btn-refresh" onclick="refreshData(this, loadClientes, 'Clientes atualizados')">
                        <i class="bi bi-arrow-clockwise"></i> Atualizar
                    </button>
                    <button class="btn btn-success btn-sm" onclick="exportarClientes('excel')" title="Exportar para Excel">
                        <i class="bi bi-file-earmark-excel"></i> Excel
                    </button>
                    <button class="btn btn-info btn-sm" onclick="exportarClientes('csv')" title="Exportar para CSV">
                        <i class="bi bi-file-earmark-text"></i> CSV
                    </button>
                </div>
            </div>

            <!-- Sub-tabs para Clientes -->
            <div class="sub-tabs">
                <button class="sub-tab-btn" onclick="showSubTab('clientes', 'novo')">
                    <i class="bi bi-person-plus-fill"></i> Novo Cliente
                </button>
                <button class="sub-tab-btn active" onclick="showSubTab('clientes', 'lista')">
                    <i class="bi bi-people-fill"></i> Lista
                </button>
                <button class="sub-tab-btn" onclick="showSubTab('clientes', 'anamnese')">
                    <i class="bi bi-file-medical"></i> Anamnese
                </button>
                <button class="sub-tab-btn" onclick="showSubTab('clientes', 'prontuario')">
                    <i class="bi bi-clipboard2-pulse"></i> Prontu√°rio
                </button>
                <button class="sub-tab-btn" onclick="showSubTab('clientes', 'faturamento')">
                    <i class="bi bi-currency-dollar"></i> Faturamento
                </button>
            </div>

            <!-- Sub-tab: NOVO CLIENTE - COMPLETO COM UPLOAD DE FOTOS -->
            <div id="clientes-novo" class="sub-tab-content">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-person-plus-fill"></i> Cadastrar Novo Cliente
                    </div>
                    <div class="card-body">
                        <!-- Upload de Foto -->
                        <div class="foto-profissional-container">
                            <img id="previewFotoCliente" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='120'%3E%3Crect width='120' height='120' fill='%23e0e7ff'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-family='Arial, sans-serif' font-size='48' fill='%237c3aed'%3E%F0%9F%91%A4%3C/text%3E%3C/svg%3E"
                                 class="foto-profissional" alt="Foto do cliente"
                                 style="width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 4px solid var(--primary); box-shadow: 0 5px 15px rgba(124,58,237,0.3);">
                            <button type="button" class="foto-upload-btn" onclick="document.getElementById('inputFotoCliente').click()">
                                <i class="bi bi-camera-fill"></i>
                            </button>
                        </div>
                        <input type="file" id="inputFotoCliente" accept="image/*" style="display: none;" onchange="previewFotoClienteNovo(event)">

                        <!-- Formul√°rio Completo -->
                        <form id="formNovoCliente" class="mt-4">
                            <div class="row g-3">
                                <!-- Nome Completo -->
                                <div class="col-md-8">
                                    <label class="form-label"><i class="bi bi-person"></i> Nome Completo *</label>
                                    <input type="text" id="novoClienteNome" class="form-control" placeholder="Digite o nome completo" required>
                                </div>

                                <!-- CPF -->
                                <div class="col-md-4">
                                    <label class="form-label"><i class="bi bi-card-text"></i> CPF *</label>
                                    <input type="text" id="novoClienteCPF" class="form-control" placeholder="000.000.000-00" maxlength="14" required>
                                </div>

                                <!-- Email -->
                                <div class="col-md-6">
                                    <label class="form-label"><i class="bi bi-envelope"></i> Email</label>
                                    <input type="email" id="novoClienteEmail" class="form-control" placeholder="exemplo@email.com">
                                </div>

                                <!-- Telefone -->
                                <div class="col-md-6">
                                    <label class="form-label"><i class="bi bi-phone"></i> Telefone *</label>
                                    <input type="text" id="novoClienteTelefone" class="form-control" placeholder="(00) 00000-0000" maxlength="15" required>
                                </div>

                                <!-- Data de Nascimento -->
                                <div class="col-md-4">
                                    <label class="form-label"><i class="bi bi-calendar-event"></i> Data de Nascimento</label>
                                    <input type="date" id="novoClienteDataNasc" class="form-control">
                                </div>

                                <!-- CEP -->
                                <div class="col-md-4">
                                    <label class="form-label"><i class="bi bi-mailbox"></i> CEP</label>
                                    <input type="text" id="novoClienteCEP" class="form-control" placeholder="00000-000" maxlength="9">
                                </div>

                                <!-- Estado -->
                                <div class="col-md-4">
                                    <label class="form-label"><i class="bi bi-map"></i> Estado</label>
                                    <input type="text" id="novoClienteEstado" class="form-control" placeholder="Ex: SP" maxlength="2">
                                </div>

                                <!-- Cidade -->
                                <div class="col-md-8">
                                    <label class="form-label"><i class="bi bi-building"></i> Cidade</label>
                                    <input type="text" id="novoClienteCidade" class="form-control" placeholder="Digite a cidade">
                                </div>

                                <!-- Bairro -->
                                <div class="col-md-4">
                                    <label class="form-label"><i class="bi bi-signpost"></i> Bairro</label>
                                    <input type="text" id="novoClienteBairro" class="form-control" placeholder="Digite o bairro">
                                </div>

                                <!-- Rua -->
                                <div class="col-md-8">
                                    <label class="form-label"><i class="bi bi-signpost-2"></i> Rua</label>
                                    <input type="text" id="novoClienteRua" class="form-control" placeholder="Digite a rua">
                                </div>

                                <!-- N√∫mero -->
                                <div class="col-md-4">
                                    <label class="form-label"><i class="bi bi-hash"></i> N√∫mero</label>
                                    <input type="text" id="novoClienteNumero" class="form-control" placeholder="N¬∫">
                                </div>

                                <!-- Observa√ß√µes -->
                                <div class="col-12">
                                    <label class="form-label"><i class="bi bi-chat-left-text"></i> Observa√ß√µes</label>
                                    <textarea id="novoClienteObservacoes" class="form-control" rows="3" placeholder="Informa√ß√µes adicionais sobre o cliente..."></textarea>
                                </div>
                            </div>

                            <!-- Bot√µes de A√ß√£o -->
                            <div class="mt-4" style="display: flex; gap: 10px; justify-content: flex-end;">
                                <button type="button" class="bioma-btn bioma-btn-secondary" onclick="limparFormularioNovoCliente()">
                                    <i class="bi bi-x-circle"></i> Limpar
                                </button>
                                <button type="button" class="bioma-btn bioma-btn-primary" onclick="salvarNovoCliente()">
                                    <i class="bi bi-check-circle"></i> Salvar Cliente
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Sub-tab: Lista de Clientes -->
            <div id="clientes-lista" class="sub-tab-content active">
                <div class="card">
                    <div class="card-header"><i class="bi bi-people-fill"></i> Lista de Clientes</div>
                    <div class="card-body">
                        <div class="mb-3"><input type="text" class="form-control" id="buscaCliente" placeholder="üîç Buscar..." onkeyup="filtrarClientes()"></div>
                        <div class="table-responsive">
                            <table>
                                <thead><tr><th>Nome</th><th>CPF</th><th>Telefone</th><th>Total Gasto</th><th>Visitas</th><th>A√ß√µes</th></tr></thead>
                                <tbody id="clientesBody"><tr><td colspan="6" class="text-center"><div class="spinner"></div></td></tr></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sub-tab: Anamnese -->
            <div id="clientes-anamnese" class="sub-tab-content">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-file-earmark-medical"></i> Anamnese - Hist√≥rico de Clientes
                        <button class="btn btn-primary btn-sm float-end" onclick="refreshData(this, carregarListaAnamnese, 'Anamnese atualizada')">
                            <i class="bi bi-arrow-clockwise"></i> Atualizar
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info mb-4">
                            <i class="bi bi-info-circle"></i>
                            <strong>Gerenciamento de Anamnese:</strong> Visualize todos os clientes com anamnese cadastrada. Clique nos bot√µes para visualizar documentos digitais ou f√≠sicos (escaneados).
                        </div>

                        <!-- Busca r√°pida opcional -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <input type="text" id="buscaAnamnese" class="form-control" placeholder="üîç Buscar cliente por nome ou CPF..." onkeyup="filtrarAnamnese()">
                            </div>
                        </div>

                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Cliente</th>
                                        <th>CPF</th>
                                        <th>√öltima Atualiza√ß√£o</th>
                                        <th>Status</th>
                                        <th style="min-width: 280px;">A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody id="anamnesesListaBody">
                                    <tr><td colspan="5" class="text-center text-muted">Carregando...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sub-tab: Prontu√°rio -->
            <div id="clientes-prontuario" class="sub-tab-content">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-file-earmark-text"></i> Prontu√°rio - Hist√≥rico de Clientes
                        <button class="btn btn-primary btn-sm float-end" onclick="refreshData(this, carregarListaProntuario, 'Prontu√°rio atualizado')">
                            <i class="bi bi-arrow-clockwise"></i> Atualizar
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info mb-4">
                            <i class="bi bi-info-circle"></i>
                            <strong>Gerenciamento de Prontu√°rio:</strong> Visualize todos os clientes com prontu√°rio cadastrado. Clique nos bot√µes para visualizar documentos digitais ou f√≠sicos (escaneados).
                        </div>

                        <!-- Busca r√°pida opcional -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <input type="text" id="buscaProntuario" class="form-control" placeholder="üîç Buscar cliente por nome ou CPF..." onkeyup="filtrarProntuario()">
                            </div>
                        </div>

                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Cliente</th>
                                        <th>CPF</th>
                                        <th>√öltima Atualiza√ß√£o</th>
                                        <th>Status</th>
                                        <th style="min-width: 280px;">A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody id="prontuariosListaBody">
                                    <tr><td colspan="5" class="text-center text-muted">Carregando...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sub-tab: Faturamento -->
            <div id="clientes-faturamento" class="sub-tab-content">
                <div class="card">
                    <div class="card-header"><i class="bi bi-currency-dollar"></i> Faturamento por Cliente</div>
                    <div class="card-body">
                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <label class="form-label-custom">Selecionar Cliente</label>
                                <select class="form-select" id="selectClienteFaturamento">
                                    <option value="">-- Escolha um cliente --</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label-custom">&nbsp;</label>
                                <button class="btn btn-primary w-100" onclick="carregarFaturamentoCliente()">
                                    <i class="bi bi-bar-chart"></i> Carregar Dados
                                </button>
                            </div>
                        </div>
                        <div id="faturamentoClienteInfo">
                            <p class="text-center text-muted">Selecione um cliente para ver o faturamento total</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="section-profissionais" class="content-section">
            <div class="page-header">
                <h1><i class="bi bi-person-workspace"></i> Profissionais</h1>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn btn-primary btn-refresh" onclick="refreshData(this, loadProfissionais, 'Profissionais atualizados')">
                        <i class="bi bi-arrow-clockwise"></i> Atualizar
                    </button>
                    <button class="btn btn-success btn-sm" onclick="exportarProfissionais('excel')" title="Exportar para Excel">
                        <i class="bi bi-file-earmark-excel"></i> Excel
                    </button>
                    <button class="btn btn-info btn-sm" onclick="exportarProfissionais('csv')" title="Exportar para CSV">
                        <i class="bi bi-file-earmark-text"></i> CSV
                    </button>
                </div>
            </div>

            <!-- Sub-tabs para Profissionais - COM NOVO PROFISSIONAL -->
            <div class="sub-tabs">
                <button class="sub-tab-btn" onclick="showSubTab('profissionais', 'novo')">
                    <i class="bi bi-person-plus-fill"></i> Novo Profissional
                </button>
                <button class="sub-tab-btn active" onclick="showSubTab('profissionais', 'lista')">
                    <i class="bi bi-people-fill"></i> Lista
                </button>
                <button class="sub-tab-btn" onclick="showSubTab('profissionais', 'calendario')">
                    <i class="bi bi-calendar3"></i> Calend√°rio
                </button>
                <button class="sub-tab-btn" onclick="showSubTab('profissionais', 'comissoes')">
                    <i class="bi bi-cash-stack"></i> Comiss√µes
                </button>
                <button class="sub-tab-btn" onclick="showSubTab('profissionais', 'estatisticas')">
                    <i class="bi bi-graph-up"></i> Estat√≠sticas
                </button>
                <button class="sub-tab-btn" onclick="showSubTab('profissionais', 'assistentes')">
                    <i class="bi bi-person-badge"></i> Assistentes
                </button>
            </div>

            <!-- Sub-tab: NOVO PROFISSIONAL - COMPLETO COM UPLOAD DE FOTOS -->
            <div id="profissionais-novo" class="sub-tab-content">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-person-plus-fill"></i> Cadastrar Novo Profissional
                    </div>
                    <div class="card-body">
                        <!-- Upload de Foto do Profissional -->
                        <div class="row g-3 mb-4">
                            <div class="col-md-12">
                                <div style="text-align: center; margin-bottom: 20px;">
                                    <div class="foto-profissional-container">
                                        <img id="previewFotoProfissional" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='120'%3E%3Crect fill='%23E5E7EB' width='120' height='120'/%3E%3Ctext x='50%25' y='50%25' font-size='48' text-anchor='middle' dy='.3em' fill='%239CA3AF'%3Eüë§%3C/text%3E%3C/svg%3E"
                                             class="foto-profissional" alt="Foto do profissional"
                                             style="width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 4px solid var(--primary); box-shadow: 0 5px 15px rgba(124,58,237,0.3);">
                                        <button type="button" class="foto-upload-btn" onclick="document.getElementById('inputFotoProfissional').click()">
                                            <i class="bi bi-camera-fill"></i>
                                        </button>
                                    </div>
                                    <input type="file" id="inputFotoProfissional" accept="image/*" style="display: none;" onchange="previewFotoProfissionalNovo(event)">
                                    <p class="text-muted mt-2" style="font-size: 0.9rem;">Clique no √≠cone da c√¢mera para adicionar uma foto</p>
                                </div>
                            </div>
                        </div>

                        <!-- Formul√°rio Completo -->
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label"><i class="bi bi-person"></i> Nome Completo *</label>
                                <input type="text" id="novoProfNome" class="form-control" placeholder="Digite o nome completo" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label"><i class="bi bi-card-text"></i> CPF *</label>
                                <input type="text" id="novoProfCPF" class="form-control" placeholder="000.000.000-00" maxlength="14" required>
                            </div>
                        </div>

                        <div class="row g-3 mt-3">
                            <div class="col-md-6">
                                <label class="form-label"><i class="bi bi-envelope"></i> E-mail</label>
                                <input type="email" id="novoProfEmail" class="form-control" placeholder="email@exemplo.com">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label"><i class="bi bi-telephone"></i> Telefone</label>
                                <input type="text" id="novoProfTelefone" class="form-control" placeholder="(34) 99999-9999">
                            </div>
                        </div>

                        <div class="row g-3 mt-3">
                            <div class="col-md-6">
                                <label class="form-label"><i class="bi bi-briefcase"></i> Especialidade *</label>
                                <input type="text" id="novoProfEspecialidade" class="form-control" placeholder="Ex: Esteticista, Dermatologista" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label"><i class="bi bi-percent"></i> Comiss√£o Padr√£o (%) *</label>
                                <input type="number" id="novoProfComissao" class="form-control" placeholder="10" value="10" min="0" max="100" step="0.5" required>
                            </div>
                        </div>

                        <div class="row g-3 mt-3">
                            <div class="col-md-12">
                                <label class="form-label"><i class="bi bi-chat-left-text"></i> Observa√ß√µes</label>
                                <textarea id="novoProfObservacoes" class="form-control" rows="3" placeholder="Anota√ß√µes adicionais sobre o profissional"></textarea>
                            </div>
                        </div>

                        <!-- Bot√µes de A√ß√£o -->
                        <div class="mt-4" style="display: flex; gap: 10px; justify-content: flex-end;">
                            <button type="button" class="bioma-btn bioma-btn-secondary" onclick="limparFormularioNovoProfissional()">
                                <i class="bi bi-x-circle"></i> Limpar
                            </button>
                            <button type="button" class="bioma-btn bioma-btn-primary" onclick="salvarNovoProfissional()">
                                <i class="bi bi-check-circle"></i> Salvar Profissional
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sub-tab: Lista de Profissionais -->
            <div id="profissionais-lista" class="sub-tab-content active">
                <div class="card">
                    <div class="card-header"><i class="bi bi-people-fill"></i> Equipe BIOMA</div>
                    <div class="card-body">
                        <div class="mb-3">
                            <input type="text" class="form-control" id="buscaProfissionais" placeholder="Buscar profissional..." oninput="filtrarProfissionais()">
                        </div>
                        <div class="table-responsive">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Foto</th>
                                        <th>Nome</th>
                                        <th>CPF</th>
                                        <th>Especialidade</th>
                                        <th>Comiss√£o</th>
                                        <th>Assistentes</th>
                                        <th>Status</th>
                                        <th>A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody id="profissionaisBody">
                                    <tr><td colspan="8" class="text-center"><div class="spinner"></div></td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sub-tab: Calend√°rio de Profissionais -->
            <div id="profissionais-calendario" class="sub-tab-content">
                <!-- Controles do Calend√°rio -->
                <div class="card mb-4">
                    <div class="card-header">
                        <i class="bi bi-funnel-fill"></i> Filtros e Visualiza√ß√£o
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label">
                                    <i class="bi bi-person"></i> Filtrar por Profissional
                                </label>
                                <select id="filtroCalendarioProfissional" class="form-select" onchange="carregarCalendario()">
                                    <option value="">Todos os Profissionais</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">
                                    <i class="bi bi-eye"></i> Visualiza√ß√£o
                                </label>
                                <select id="visualizacaoCalendario" class="form-select" onchange="alterarVisualizacaoCalendario()">
                                    <option value="dayGridMonth">M√™s</option>
                                    <option value="timeGridWeek">Semana</option>
                                    <option value="timeGridDay">Dia</option>
                                    <option value="listWeek">Lista Semanal</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">
                                    <i class="bi bi-calendar-plus"></i> A√ß√µes R√°pidas
                                </label>
                                <div style="display: flex; gap: 10px;">
                                    <button class="btn btn-success flex-fill" onclick="novoAgendamentoRapido()">
                                        <i class="bi bi-plus-circle"></i> Novo Agendamento
                                    </button>
                                    <button class="btn btn-outline" onclick="calendarioHoje()">
                                        <i class="bi bi-calendar-event"></i> Hoje
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Legenda de Cores -->
                <div class="card mb-4">
                    <div class="card-body">
                        <div style="display: flex; align-items: center; gap: 20px; flex-wrap: wrap;">
                            <strong><i class="bi bi-palette"></i> Legenda:</strong>
                            <div id="legendaProfissionais" style="display: flex; gap: 15px; flex-wrap: wrap;">
                                <!-- Ser√° populado dinamicamente -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Calend√°rio Principal -->
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-calendar3"></i> Calend√°rio de Agendamentos
                    </div>
                    <div class="card-body">
                        <div id="calendarioProfissionais" style="background: var(--bg-main); padding: 20px; border-radius: 15px;">
                            <!-- FullCalendar ser√° renderizado aqui -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sub-tab: Comiss√µes Multin√≠veis -->
            <div id="profissionais-comissoes" class="sub-tab-content">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-funnel"></i> Filtros
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label">Profissional</label>
                                <select id="filtroComissoesProfissional" class="form-select">
                                    <option value="">Selecione um profissional</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Data In√≠cio</label>
                                <input type="date" id="filtroComissoesDataInicio" class="form-control">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Data Fim</label>
                                <input type="date" id="filtroComissoesDataFim" class="form-control">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Status</label>
                                <select id="filtroComissoesStatus" class="form-select">
                                    <option value="">Todos</option>
                                    <option value="Pendente">Pendente</option>
                                    <option value="Aprovado">Aprovado</option>
                                    <option value="Rejeitado">Rejeitado</option>
                                </select>
                            </div>
                        </div>
                        <div class="mt-3">
                            <button class="bioma-btn bioma-btn-primary" onclick="carregarComissoesProfissional()">
                                <i class="bi bi-search"></i> Filtrar
                            </button>
                            <button class="btn btn-outline" onclick="limparFiltrosComissoes()">
                                <i class="bi bi-x-circle"></i> Limpar
                            </button>
                            <button class="bioma-btn bioma-btn-success" onclick="exportarComissoesExcel()">
                                <i class="bi bi-file-earmark-excel"></i> Exportar Excel
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Cards de Estat√≠sticas -->
                <div id="comissoesEstatisticasCards" style="display:none;">
                    <div class="row g-4 mb-4 mt-3">
                        <div class="col-lg-4 col-md-6">
                            <div class="stat-card">
                                <div class="icon"><i class="bi bi-cash-coin"></i></div>
                                <h3 id="statTotalComissoes">R$ 0,00</h3>
                                <p>Total de Comiss√µes</p>
                            </div>
                        </div>
                        <div class="col-lg-4 col-md-6">
                            <div class="stat-card">
                                <div class="icon"><i class="bi bi-file-earmark-text"></i></div>
                                <h3 id="statTotalOrcamentos">0</h3>
                                <p>Or√ßamentos Participados</p>
                            </div>
                        </div>
                        <div class="col-lg-4 col-md-6">
                            <div class="stat-card">
                                <div class="icon"><i class="bi bi-graph-up-arrow"></i></div>
                                <h3 id="statMediaComissao">R$ 0,00</h3>
                                <p>M√©dia por Or√ßamento</p>
                            </div>
                        </div>
                    </div>

                    <!-- Gr√°fico de Evolu√ß√£o Mensal -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <i class="bi bi-graph-up"></i> Evolu√ß√£o de Comiss√µes (Mensal)
                        </div>
                        <div class="card-body">
                            <canvas id="graficoComissoesMensal" height="80"></canvas>
                        </div>
                    </div>

                    <!-- Tabela de Hist√≥rico -->
                    <div class="card">
                        <div class="card-header">
                            <i class="bi bi-clock-history"></i> Hist√≥rico Detalhado
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Data</th>
                                            <th>Or√ßamento</th>
                                            <th>Tipo</th>
                                            <th>Valor Base</th>
                                            <th>Comiss√£o %</th>
                                            <th>Valor Comiss√£o</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tabelaHistoricoComissoes">
                                        <tr>
                                            <td colspan="7" class="text-center text-muted">
                                                Selecione um profissional nos filtros acima
                                            </td>
                                        </tr>
                                    </tbody>
                                    <tfoot id="tfootComissoes" style="display:none;">
                                        <tr>
                                            <th colspan="5" class="text-end">TOTAL:</th>
                                            <th id="totalComissoesFooter">R$ 0,00</th>
                                            <th></th>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Mensagem inicial -->
                <div id="comissoesMensagemInicial">
                    <div class="alert alert-info mt-4">
                        <h4><i class="bi bi-info-circle"></i> Como usar esta se√ß√£o</h4>
                        <p><strong>1.</strong> Selecione um profissional no filtro acima</p>
                        <p><strong>2.</strong> (Opcional) Defina um per√≠odo e status para filtrar</p>
                        <p><strong>3.</strong> Clique em "Filtrar" para ver as estat√≠sticas e hist√≥rico</p>
                        <p><strong>4.</strong> Use "Exportar Excel" para gerar relat√≥rio completo</p>
                    </div>
                </div>
            </div>

            <!-- Sub-tab: Estat√≠sticas Gerais -->
            <div id="profissionais-estatisticas" class="sub-tab-content">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-trophy"></i> Ranking de Profissionais
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Foto</th>
                                        <th>Nome</th>
                                        <th>Tipo</th>
                                        <th>Total Comiss√µes</th>
                                        <th>Or√ßamentos</th>
                                        <th>M√©dia</th>
                                    </tr>
                                </thead>
                                <tbody id="rankingProfissionaisBody">
                                    <tr>
                                        <td colspan="7" class="text-center">
                                            <div class="spinner"></div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sub-tab: Assistentes -->
            <div id="profissionais-assistentes" class="sub-tab-content">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-person-badge"></i> Gest√£o de Assistentes
                    </div>
                    <div class="card-body">
                        <button class="btn btn-success mb-3" onclick="cadastrarAssistenteIndependente()">
                            <i class="bi bi-person-plus"></i> Cadastrar Assistente Independente
                        </button>
                        
                        <div class="table-responsive">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Nome</th>
                                        <th>CPF</th>
                                        <th>Profissional Vinculado</th>
                                        <th>% Comiss√£o</th>
                                        <th>Status</th>
                                        <th>A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody id="assistentesBody">
                                    <tr><td colspan="6" class="text-center">Carregando...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <div id="section-servicos" class="content-section">
            <div class="page-header">
                <h1><i class="bi bi-scissors"></i> Servi√ßos</h1>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn btn-primary btn-refresh" onclick="refreshData(this, loadServicosLista, 'Servi√ßos atualizados')">
                        <i class="bi bi-arrow-clockwise"></i> Atualizar
                    </button>
                    <button class="btn btn-success btn-sm" onclick="ativarTodosServicos()" title="Ativar todos os servi√ßos">
                        <i class="bi bi-check-circle-fill"></i> Ativar Todos
                    </button>
                    <button class="btn btn-danger btn-sm" onclick="desativarTodosServicos()" title="Desativar todos os servi√ßos">
                        <i class="bi bi-x-circle-fill"></i> Desativar Todos
                    </button>
                    <button class="btn btn-danger btn-sm" onclick="deletarTodosServicos()" title="DELETAR TODOS os servi√ßos">
                        <i class="bi bi-trash-fill"></i> Deletar Todos
                    </button>
                    <button class="btn btn-success btn-sm" onclick="exportarServicos('excel')" title="Exportar para Excel">
                        <i class="bi bi-file-earmark-excel"></i> Excel
                    </button>
                    <button class="btn btn-info btn-sm" onclick="exportarServicos('csv')" title="Exportar para CSV">
                        <i class="bi bi-file-earmark-text"></i> CSV
                    </button>
                </div>
            </div>

            <!-- Sub-tabs para Servi√ßos -->
            <div class="sub-tabs">
                <button class="sub-tab-btn" onclick="switchSubTab('servicos', 'novo')">
                    <i class="bi bi-plus-circle-fill"></i> Novo Servi√ßo
                </button>
                <button class="sub-tab-btn active" onclick="switchSubTab('servicos', 'todos')">
                    <i class="bi bi-list-ul"></i> Todos
                </button>
                <button class="sub-tab-btn" onclick="switchSubTab('servicos', 'ativos')">
                    <i class="bi bi-check-circle"></i> Ativos
                </button>
                <button class="sub-tab-btn" onclick="switchSubTab('servicos', 'inativos')">
                    <i class="bi bi-x-circle"></i> Inativos
                </button>
            </div>

            <!-- Sub-tab: NOVO SERVI√áO - COMPLETO -->
            <div id="servicos-subtab-novo" class="sub-tab-content">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-plus-circle-fill"></i> Cadastrar Novo Servi√ßo
                    </div>
                    <div class="card-body">
                        <form id="formNovoServico">
                            <div class="row g-3">
                                <!-- Nome do Servi√ßo -->
                                <div class="col-md-8">
                                    <label class="form-label"><i class="bi bi-scissors"></i> Nome do Servi√ßo *</label>
                                    <input type="text" id="novoServicoNome" class="form-control" placeholder="Ex: Corte de Cabelo, Manicure..." required>
                                </div>

                                <!-- Status -->
                                <div class="col-md-4">
                                    <label class="form-label"><i class="bi bi-toggle-on"></i> Status *</label>
                                    <select id="novoServicoStatus" class="form-select" required>
                                        <option value="ativo" selected>Ativo</option>
                                        <option value="inativo">Inativo</option>
                                    </select>
                                </div>

                                <!-- Categoria -->
                                <div class="col-md-4">
                                    <label class="form-label"><i class="bi bi-tags"></i> Categoria *</label>
                                    <select id="novoServicoCategoria" class="form-select" required>
                                        <option value="">Selecione...</option>
                                        <option value="Est√©tica">Est√©tica</option>
                                        <option value="Capilar">Capilar</option>
                                        <option value="Corporal">Corporal</option>
                                        <option value="Facial">Facial</option>
                                    </select>
                                </div>

                                <!-- Tamanho -->
                                <div class="col-md-4">
                                    <label class="form-label"><i class="bi bi-rulers"></i> Tamanho *</label>
                                    <select id="novoServicoTamanho" class="form-select" required>
                                        <option value="">Selecione...</option>
                                        <option value="Pequeno">Pequeno</option>
                                        <option value="M√©dio">M√©dio</option>
                                        <option value="Grande">Grande</option>
                                    </select>
                                </div>

                                <!-- Pre√ßo -->
                                <div class="col-md-4">
                                    <label class="form-label"><i class="bi bi-currency-dollar"></i> Pre√ßo (R$) *</label>
                                    <input type="number" id="novoServicoPreco" class="form-control" placeholder="0.00" step="0.01" min="0" required>
                                </div>

                                <!-- Dura√ß√£o -->
                                <div class="col-md-6">
                                    <label class="form-label"><i class="bi bi-clock"></i> Dura√ß√£o (minutos)</label>
                                    <input type="number" id="novoServicoDuracao" class="form-control" placeholder="Ex: 60" min="0">
                                </div>

                                <!-- Comiss√£o do Profissional -->
                                <div class="col-md-6">
                                    <label class="form-label"><i class="bi bi-percent"></i> Comiss√£o Profissional (%)</label>
                                    <input type="number" id="novoServicoComissao" class="form-control" placeholder="10" value="10" min="0" max="100" step="0.1">
                                </div>

                                <!-- Descri√ß√£o -->
                                <div class="col-12">
                                    <label class="form-label"><i class="bi bi-chat-left-text"></i> Descri√ß√£o</label>
                                    <textarea id="novoServicoDescricao" class="form-control" rows="3" placeholder="Descreva os detalhes do servi√ßo..."></textarea>
                                </div>
                            </div>

                            <!-- Bot√µes de A√ß√£o -->
                            <div class="mt-4" style="display: flex; gap: 10px; justify-content: flex-end;">
                                <button type="button" class="bioma-btn bioma-btn-secondary" onclick="limparFormularioNovoServico()">
                                    <i class="bi bi-x-circle"></i> Limpar
                                </button>
                                <button type="button" class="bioma-btn bioma-btn-primary" onclick="salvarNovoServico()">
                                    <i class="bi bi-check-circle"></i> Salvar Servi√ßo
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Sub-tab: Todos -->
            <div id="servicos-subtab-todos" class="sub-tab-content active">
                <div class="card">
                    <div class="card-header"><i class="bi bi-list-ul"></i> Todos os Servi√ßos</div>
                    <div class="card-body">
                        <div class="row g-3 mb-3">
                            <div class="col-md-8">
                                <input type="text" class="form-control" id="buscaServicosTodos" placeholder="Buscar por nome, categoria..." onkeyup="filtrarServicosTodos()">
                            </div>
                            <div class="col-md-4">
                                <select class="form-select" id="filtroCategoria" onchange="filtrarServicosTodos()">
                                    <option value="">Todas as categorias</option>
                                    <option value="Est√©tica">Est√©tica</option>
                                    <option value="Capilar">Capilar</option>
                                    <option value="Corporal">Corporal</option>
                                    <option value="Facial">Facial</option>
                                </select>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Nome</th>
                                        <th>Categoria</th>
                                        <th>Tamanho</th>
                                        <th>Pre√ßo</th>
                                        <th>Status</th>
                                        <th>A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody id="servicosTodosBody">
                                    <tr><td colspan="6" class="text-center"><div class="spinner"></div></td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sub-tab: Ativos -->
            <div id="servicos-subtab-ativos" class="sub-tab-content d-none">
                <div class="card">
                    <div class="card-header"><i class="bi bi-check-circle"></i> Servi√ßos Ativos</div>
                    <div class="card-body">
                        <div class="mb-3">
                            <input type="text" class="form-control" id="buscaServicosAtivos" placeholder="Buscar servi√ßo ativo..." onkeyup="filtrarServicosAtivos()">
                        </div>
                        <div class="table-responsive">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Nome</th>
                                        <th>Categoria</th>
                                        <th>Tamanho</th>
                                        <th>Pre√ßo</th>
                                        <th>A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody id="servicosAtivosBody">
                                    <tr><td colspan="5" class="text-center"><div class="spinner"></div></td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sub-tab: Inativos -->
            <div id="servicos-subtab-inativos" class="sub-tab-content d-none">
                <div class="card">
                    <div class="card-header"><i class="bi bi-x-circle"></i> Servi√ßos Inativos</div>
                    <div class="card-body">
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle"></i> 
                            Servi√ßos inativos n√£o aparecem no sistema de or√ßamentos
                        </div>
                        <div class="table-responsive">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Nome</th>
                                        <th>Categoria</th>
                                        <th>Tamanho</th>
                                        <th>Pre√ßo</th>
                                        <th>A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody id="servicosInativosBody">
                                    <tr><td colspan="5" class="text-center text-muted">Nenhum servi√ßo inativo</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="section-produtos" class="content-section">
            <div class="page-header">
                <h1><i class="bi bi-box-seam"></i> Produtos</h1>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn btn-primary btn-refresh" onclick="refreshData(this, loadProdutosLista, 'Produtos atualizados')">
                        <i class="bi bi-arrow-clockwise"></i> Atualizar
                    </button>
                    <button class="btn btn-success btn-sm" onclick="ativarTodosProdutos()" title="Ativar todos os produtos">
                        <i class="bi bi-check-circle-fill"></i> Ativar Todos
                    </button>
                    <button class="btn btn-danger btn-sm" onclick="desativarTodosProdutos()" title="Desativar todos os produtos">
                        <i class="bi bi-x-circle-fill"></i> Desativar Todos
                    </button>
                    <button class="btn btn-danger btn-sm" onclick="deletarTodosProdutos()" title="DELETAR TODOS os produtos">
                        <i class="bi bi-trash-fill"></i> Deletar Todos
                    </button>
                    <button class="btn btn-success btn-sm" onclick="exportarProdutos('excel')" title="Exportar para Excel">
                        <i class="bi bi-file-earmark-excel"></i> Excel
                    </button>
                    <button class="btn btn-info btn-sm" onclick="exportarProdutos('csv')" title="Exportar para CSV">
                        <i class="bi bi-file-earmark-text"></i> CSV
                    </button>
                </div>
            </div>

            <!-- Sub-tabs para Produtos -->
            <div class="sub-tabs">
                <button class="sub-tab-btn" onclick="switchSubTab('produtos', 'novo')">
                    <i class="bi bi-plus-circle-fill"></i> Novo Produto
                </button>
                <button class="sub-tab-btn active" onclick="switchSubTab('produtos', 'todos')">
                    <i class="bi bi-box-fill"></i> Todos
                </button>
                <button class="sub-tab-btn" onclick="switchSubTab('produtos', 'ativos')">
                    <i class="bi bi-check-circle"></i> Ativos
                </button>
                <button class="sub-tab-btn" onclick="switchSubTab('produtos', 'inativos')">
                    <i class="bi bi-x-circle"></i> Inativos
                </button>
            </div>

            <!-- Sub-tab: NOVO PRODUTO - COMPLETO -->
            <div id="produtos-subtab-novo" class="sub-tab-content">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-plus-circle-fill"></i> Cadastrar Novo Produto
                    </div>
                    <div class="card-body">
                        <form id="formNovoProduto">
                            <div class="row g-3">
                                <!-- Nome do Produto -->
                                <div class="col-md-6">
                                    <label class="form-label"><i class="bi bi-box-seam"></i> Nome do Produto *</label>
                                    <input type="text" id="novoProdutoNome" class="form-control" placeholder="Ex: Shampoo Revitalizante" required>
                                </div>

                                <!-- Marca -->
                                <div class="col-md-6">
                                    <label class="form-label"><i class="bi bi-tag"></i> Marca</label>
                                    <input type="text" id="novoProdutoMarca" class="form-control" placeholder="Ex: L'Or√©al">
                                </div>

                                <!-- C√≥digo de Barras -->
                                <div class="col-md-6">
                                    <label class="form-label"><i class="bi bi-upc-scan"></i> C√≥digo de Barras</label>
                                    <input type="text" id="novoProdutoCodigoBarras" class="form-control" placeholder="Ex: 7891010971328">
                                </div>

                                <!-- Fornecedor -->
                                <div class="col-md-6">
                                    <label class="form-label"><i class="bi bi-truck"></i> Fornecedor</label>
                                    <input type="text" id="novoProdutoFornecedor" class="form-control" placeholder="Nome do fornecedor">
                                </div>

                                <!-- Pre√ßo de Custo -->
                                <div class="col-md-3">
                                    <label class="form-label"><i class="bi bi-wallet2"></i> Pre√ßo de Custo (R$)</label>
                                    <input type="number" id="novoProdutoPrecoCusto" class="form-control" placeholder="0.00" step="0.01" min="0">
                                </div>

                                <!-- Pre√ßo de Venda -->
                                <div class="col-md-3">
                                    <label class="form-label"><i class="bi bi-currency-dollar"></i> Pre√ßo de Venda (R$) *</label>
                                    <input type="number" id="novoProdutoPrecoVenda" class="form-control" placeholder="0.00" step="0.01" min="0" required>
                                </div>

                                <!-- Estoque Atual -->
                                <div class="col-md-3">
                                    <label class="form-label"><i class="bi bi-box"></i> Estoque Atual *</label>
                                    <input type="number" id="novoProdutoEstoqueAtual" class="form-control" placeholder="0" min="0" required>
                                </div>

                                <!-- Estoque M√≠nimo -->
                                <div class="col-md-3">
                                    <label class="form-label"><i class="bi bi-exclamation-triangle"></i> Estoque M√≠nimo</label>
                                    <input type="number" id="novoProdutoEstoqueMinimo" class="form-control" placeholder="0" min="0" value="0">
                                </div>

                                <!-- Status -->
                                <div class="col-md-12">
                                    <label class="form-label"><i class="bi bi-toggle-on"></i> Status *</label>
                                    <select id="novoProdutoStatus" class="form-select" required>
                                        <option value="ativo" selected>Ativo</option>
                                        <option value="inativo">Inativo</option>
                                    </select>
                                </div>

                                <!-- Descri√ß√£o -->
                                <div class="col-12">
                                    <label class="form-label"><i class="bi bi-chat-left-text"></i> Descri√ß√£o</label>
                                    <textarea id="novoProdutoDescricao" class="form-control" rows="3" placeholder="Descreva as caracter√≠sticas do produto..."></textarea>
                                </div>
                            </div>

                            <!-- Bot√µes de A√ß√£o -->
                            <div class="mt-4" style="display: flex; gap: 10px; justify-content: flex-end;">
                                <button type="button" class="bioma-btn bioma-btn-secondary" onclick="limparFormularioNovoProduto()">
                                    <i class="bi bi-x-circle"></i> Limpar
                                </button>
                                <button type="button" class="bioma-btn bioma-btn-primary" onclick="salvarNovoProduto()">
                                    <i class="bi bi-check-circle"></i> Salvar Produto
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Sub-tab: Todos -->
            <div id="produtos-subtab-todos" class="sub-tab-content active">
                <div class="card">
                    <div class="card-header"><i class="bi bi-box-fill"></i> Todos os Produtos</div>
                    <div class="card-body">
                        <div class="row g-3 mb-3">
                            <div class="col-md-8">
                                <input type="text" class="form-control" id="buscaProdutosTodos" placeholder="Buscar por nome, marca..." onkeyup="filtrarProdutosTodos()">
                            </div>
                            <div class="col-md-4">
                                <select class="form-select" id="filtroProdutoStatus" onchange="filtrarProdutosTodos()">
                                    <option value="">Todos os status</option>
                                    <option value="Ativo">Ativo</option>
                                    <option value="Inativo">Inativo</option>
                                </select>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Nome</th>
                                        <th>Marca</th>
                                        <th>Pre√ßo</th>
                                        <th>Estoque</th>
                                        <th>Status</th>
                                        <th>A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody id="produtosTodosBody">
                                    <tr><td colspan="6" class="text-center"><div class="spinner"></div></td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sub-tab: Ativos -->
            <div id="produtos-subtab-ativos" class="sub-tab-content d-none">
                <div class="card">
                    <div class="card-header"><i class="bi bi-check-circle"></i> Produtos Ativos</div>
                    <div class="card-body">
                        <div class="mb-3">
                            <input type="text" class="form-control" id="buscaProdutosAtivos" placeholder="Buscar produto ativo..." onkeyup="filtrarProdutosAtivos()">
                        </div>
                        <div class="table-responsive">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Nome</th>
                                        <th>Marca</th>
                                        <th>Pre√ßo</th>
                                        <th>Estoque</th>
                                        <th>A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody id="produtosAtivosBody">
                                    <tr><td colspan="5" class="text-center"><div class="spinner"></div></td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sub-tab: Inativos -->
            <div id="produtos-subtab-inativos" class="sub-tab-content d-none">
                <div class="card">
                    <div class="card-header"><i class="bi bi-x-circle"></i> Produtos Inativos</div>
                    <div class="card-body">
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle"></i> 
                            Produtos inativos n√£o aparecem no sistema de or√ßamentos
                        </div>
                        <div class="table-responsive">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Nome</th>
                                        <th>Marca</th>
                                        <th>Pre√ßo</th>
                                        <th>Estoque</th>
                                        <th>A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody id="produtosInativosBody">
                                    <tr><td colspan="5" class="text-center text-muted">Nenhum produto inativo</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

<!-- Inicio novas se√ß√µes -->
<!-- Se√ß√£o de Perfil -->
<div id="section-perfil" class="content-section">
    <div class="page-header">
        <h1><i class="bi bi-person-circle"></i> Meu Perfil</h1>
        <button class="bioma-btn bioma-btn-primary" onclick="salvarAlteracoesPerfil()">
            <i class="bi bi-save"></i> Salvar Altera√ß√µes
        </button>
    </div>
    
    <div class="row g-4">
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <i class="bi bi-camera"></i> Foto de Perfil
                </div>
                <div class="card-body text-center">
                    <!-- Placeholder SVG inline (SEM arquivos externos) -->
                    <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='120' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='50' fill='%23E5E7EB'/%3E%3Ccircle cx='50' cy='40' r='15' fill='%239CA3AF'/%3E%3Cpath d='M 25 75 Q 25 55 50 55 Q 75 55 75 75 Z' fill='%239CA3AF'/%3E%3C/svg%3E" alt="Foto de Perfil" class="profile-pic" style="width: 120px; height: 120px; margin-bottom: 20px; border-radius: 50%;">
                    <input type="file" id="profilePicInput" accept="image/*" style="display: none;">
                    <button class="btn btn-outline" onclick="document.getElementById('profilePicInput').click()">
                        <i class="bi bi-camera"></i> Alterar Foto
                    </button>
                </div>
            </div>

            <div class="card mt-4">
                <div class="card-header">
                    <i class="bi bi-building"></i> Logo da Empresa
                </div>
                <div class="card-body text-center">
                    <div class="logo-preview">
                        <!-- Placeholder SVG inline para logo da empresa (SEM arquivos externos) -->
                        <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='100' viewBox='0 0 200 100'%3E%3Crect width='200' height='100' fill='%23F3F4F6' rx='10'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-family='Arial' font-size='24' font-weight='bold' fill='%237C3AED'%3EBIOMA%3C/text%3E%3Ctext x='50%25' y='70%25' dominant-baseline='middle' text-anchor='middle' font-family='Arial' font-size='12' fill='%239CA3AF'%3EUberaba%3C/text%3E%3C/svg%3E" alt="Logo da Empresa" id="companyLogoPreview" style="max-width: 200px;">
                    </div>
                    <input type="file" id="logoInput" accept="image/*" style="display: none;">
                    <button class="btn btn-outline" onclick="document.getElementById('logoInput').click()">
                        <i class="bi bi-upload"></i> Upload Logo
                    </button>
                </div>
            </div>
        </div>

        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <i class="bi bi-person-vcard"></i> Dados do Perfil
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label>Nome Completo</label>
                            <input type="text" id="perfilNome" class="form-control" autocomplete="name" placeholder="Digite seu nome completo">
                        </div>
                        <div class="col-md-6">
                            <label>E-mail</label>
                            <input type="email" id="perfilEmail" class="form-control" autocomplete="email" placeholder="Digite seu e-mail">
                        </div>
                        <div class="col-md-6">
                            <label>Telefone</label>
                            <input type="text" id="perfilTelefone" class="form-control" autocomplete="tel" placeholder="Digite seu telefone">
                        </div>
                        <div class="col-md-6">
                            <label>Cargo</label>
                            <input type="text" id="perfilCargo" class="form-control" autocomplete="organization-title" placeholder="Digite seu cargo">
                        </div>
                    </div>
                </div>
            </div>

            <div class="card mt-4">
                <div class="card-header">
                    <i class="bi bi-shield-lock"></i> Seguran√ßa
                </div>
                <div class="card-body">
                    <form id="formAlterarSenha" onsubmit="return false;">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label>Nova Senha</label>
                                <input type="password" id="novaSenha" class="form-control" autocomplete="new-password" placeholder="Digite a nova senha">
                            </div>
                            <div class="col-md-6">
                                <label>Confirmar Nova Senha</label>
                                <input type="password" id="confirmarSenha" class="form-control" autocomplete="new-password" placeholder="Confirme a nova senha">
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Se√ß√£o de Comiss√µes -->
<div id="section-comissoes" class="content-section">
    <div class="page-header">
        <h1><i class="bi bi-cash-stack"></i> Sistema de Comiss√µes</h1>
    </div>

    <!-- Sub-tabs para Comiss√µes -->
    <div class="sub-tabs">
        <button class="sub-tab-btn sub-tab-red-animated" onclick="switchSubTab('comissoes', 'nova')">
            <i class="bi bi-plus-circle-fill"></i> Nova Regra
        </button>
        <button class="sub-tab-btn active" onclick="switchSubTab('comissoes', 'lista')">
            <i class="bi bi-list-check"></i> Regras
        </button>
        <button class="sub-tab-btn" onclick="switchSubTab('comissoes', 'historico')">
            <i class="bi bi-calendar3"></i> Hist√≥rico
        </button>
    </div>

    <!-- Sub-tab: Nova Regra -->
    <div id="comissoes-subtab-nova" class="sub-tab-content">
        <div class="card">
            <div class="card-header" style="background: linear-gradient(135deg, #EF4444, #DC2626);">
                <i class="bi bi-plus-circle-fill"></i> Criar Nova Regra de Comiss√£o
            </div>
            <div class="card-body">
                <form id="formNovaComissao">
                    <div class="row g-3">
                        <!-- Profissional -->
                        <div class="col-md-6">
                            <label class="form-label"><i class="bi bi-person-badge"></i> Profissional *</label>
                            <select id="novaComissaoProfissional" class="form-select" required>
                                <option value="">Selecione o profissional...</option>
                            </select>
                        </div>

                        <!-- Tipo de Comiss√£o -->
                        <div class="col-md-6">
                            <label class="form-label"><i class="bi bi-gear"></i> Tipo de Comiss√£o *</label>
                            <select id="novaComissaoTipo" class="form-select" required>
                                <option value="">Selecione...</option>
                                <option value="percentual">Percentual (%)</option>
                                <option value="fixo">Valor Fixo (R$)</option>
                            </select>
                        </div>

                        <!-- Valor -->
                        <div class="col-md-6">
                            <label class="form-label"><i class="bi bi-currency-dollar"></i> Valor *</label>
                            <input type="number" id="novaComissaoValor" class="form-control" placeholder="0.00" step="0.01" min="0" required>
                            <small class="text-muted">Para percentual: 0-100. Para fixo: valor em R$</small>
                        </div>

                        <!-- Aplicar a -->
                        <div class="col-md-6">
                            <label class="form-label"><i class="bi bi-tag"></i> Aplicar a *</label>
                            <select id="novaComissaoAplicar" class="form-select" required>
                                <option value="">Selecione...</option>
                                <option value="servicos">Apenas Servi√ßos</option>
                                <option value="produtos">Apenas Produtos</option>
                                <option value="ambos">Servi√ßos e Produtos</option>
                            </select>
                        </div>

                        <!-- Observa√ß√µes -->
                        <div class="col-12">
                            <label class="form-label"><i class="bi bi-chat-left-text"></i> Observa√ß√µes</label>
                            <textarea id="novaComissaoObs" class="form-control" rows="3" placeholder="Informa√ß√µes adicionais sobre esta regra..."></textarea>
                        </div>
                    </div>

                    <!-- Bot√µes -->
                    <div class="mt-4" style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button type="button" class="bioma-btn bioma-btn-secondary" onclick="limparFormularioNovaComissao()">
                            <i class="bi bi-x-circle"></i> Limpar
                        </button>
                        <button type="button" class="bioma-btn bioma-btn-danger" onclick="salvarNovaComissao()">
                            <i class="bi bi-check-circle"></i> Salvar Regra
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Sub-tab: Lista de Regras -->
    <div id="comissoes-subtab-lista" class="sub-tab-content active">
    <div class="row g-4">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <i class="bi bi-list-check"></i> Regras de Comiss√£o
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>Profissional</th>
                                    <th>Cliente</th>
                                    <th>Or√ßamento</th>
                                    <th>Valor Comiss√£o</th>
                                    <th>Data</th>
                                </tr>
                            </thead>
                            <tbody id="comissoesBody">
                                <tr><td colspan="5" class="text-center"><div class="spinner"></div></td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <i class="bi bi-graph-up"></i> Desempenho
                </div>
                <div class="card-body">
                    <canvas id="chartComissoes" style="max-height: 300px;"></canvas>
                </div>
            </div>

            <div class="card mt-4">
                <div class="card-header">
                    <i class="bi bi-trophy"></i> Top Performers
                </div>
                <div class="card-body">
                    <div id="topPerformersBody">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>

    <!-- Sub-tab: Hist√≥rico -->
    <div id="comissoes-subtab-historico" class="sub-tab-content">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-calendar3"></i> Hist√≥rico de Comiss√µes
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Profissional</th>
                                <th>Servi√ßo/Produto</th>
                                <th>Valor Venda</th>
                                <th>Comiss√£o</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="historicoComissoesBody">
                            <tr><td colspan="6" class="text-center"><div class="spinner"></div></td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ==================== SE√á√ÉO FINANCEIRO ==================== -->
<div id="section-financeiro" class="content-section">
    <div class="page-header">
        <h1><i class="bi bi-wallet2"></i> Gest√£o Financeira</h1>
        <div style="display: flex; gap: 10px;">
            <button class="bioma-btn bioma-btn-primary" onclick="carregarDadosFinanceiro()">
                <i class="bi bi-arrow-clockwise"></i> Atualizar
            </button>
            <button class="bioma-btn bioma-btn-danger" onclick="exportarFinanceiroPDF()">
                <i class="bi bi-file-earmark-pdf"></i> Exportar PDF
            </button>
        </div>
    </div>

    <!-- Filtros de Data para Financeiro -->
    <div class="card mb-4">
        <div class="card-header">
            <i class="bi bi-funnel"></i> Filtros de Per√≠odo
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">Data In√≠cio</label>
                    <input type="date" id="financeiroDataInicio" class="form-control" onchange="aplicarFiltrosFinanceiro()">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Data Fim</label>
                    <input type="date" id="financeiroDataFim" class="form-control" onchange="aplicarFiltrosFinanceiro()">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Per√≠odo R√°pido</label>
                    <select class="form-select" id="financeiroPeriodoRapido" onchange="aplicarPeriodoRapidoFinanceiro(this.value)">
                        <option value="">Personalizado</option>
                        <option value="hoje">Hoje</option>
                        <option value="semana">Esta Semana</option>
                        <option value="mes" selected>Este M√™s</option>
                        <option value="trimestre">√öltimos 3 Meses</option>
                        <option value="semestre">√öltimos 6 Meses</option>
                        <option value="ano">Este Ano</option>
                        <option value="tudo">Tudo</option>
                    </select>
                </div>
                <div class="col-md-3 d-flex align-items-end">
                    <button class="bioma-btn bioma-btn-outline w-100" onclick="limparFiltrosFinanceiro()">
                        <i class="bi bi-x-circle"></i> Limpar Filtros
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Cards de Resumo -->
    <div class="row g-4 mb-4">
        <div class="col-lg-3 col-md-6">
            <div class="stat-card">
                <div class="icon" style="background: linear-gradient(135deg, #10B981, #059669);">
                    <i class="bi bi-arrow-up-circle"></i>
                </div>
                <h3 id="financeiroReceitas">R$ 0,00</h3>
                <p>Receitas</p>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="stat-card">
                <div class="icon" style="background: linear-gradient(135deg, #EF4444, #DC2626);">
                    <i class="bi bi-arrow-down-circle"></i>
                </div>
                <h3 id="financeiroDespesas">R$ 0,00</h3>
                <p>Despesas</p>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="stat-card">
                <div class="icon" style="background: linear-gradient(135deg, #F59E0B, #D97706);">
                    <i class="bi bi-cash-stack"></i>
                </div>
                <h3 id="financeiroComissoes">R$ 0,00</h3>
                <p>Comiss√µes a Pagar</p>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="stat-card">
                <div class="icon" style="background: linear-gradient(135deg, #3B82F6, #2563EB);">
                    <i class="bi bi-graph-up-arrow"></i>
                </div>
                <h3 id="financeiroLucro">R$ 0,00</h3>
                <p>Lucro L√≠quido</p>
            </div>
        </div>
    </div>

    <!-- Sub-tabs -->
    <div class="sub-tabs">
        <button class="sub-tab-btn sub-tab-red-animated" onclick="switchSubTab('financeiro', 'nova-despesa')">
            <i class="bi bi-plus-circle-fill"></i> Nova Despesa
        </button>
        <button class="sub-tab-btn active" onclick="switchSubTab('financeiro', 'resumo')">
            <i class="bi bi-pie-chart"></i> Resumo
        </button>
        <button class="sub-tab-btn" onclick="switchSubTab('financeiro', 'receitas')">
            <i class="bi bi-arrow-up-circle"></i> Receitas
        </button>
        <button class="sub-tab-btn" onclick="switchSubTab('financeiro', 'despesas')">
            <i class="bi bi-arrow-down-circle"></i> Despesas
        </button>
        <button class="sub-tab-btn" onclick="switchSubTab('financeiro', 'comissoes')">
            <i class="bi bi-cash-stack"></i> Comiss√µes
        </button>
    </div>

    <!-- Sub-tab: Nova Despesa -->
    <div id="financeiro-subtab-nova-despesa" class="sub-tab-content">
        <div class="card">
            <div class="card-header" style="background: linear-gradient(135deg, #EF4444, #DC2626);">
                <i class="bi bi-plus-circle-fill"></i> Registrar Nova Despesa
            </div>
            <div class="card-body">
                <form id="formNovaDespesa">
                    <div class="row g-3">
                        <!-- Descri√ß√£o -->
                        <div class="col-md-8">
                            <label class="form-label"><i class="bi bi-pencil"></i> Descri√ß√£o *</label>
                            <input type="text" id="novaDespesaDescricao" class="form-control" placeholder="Ex: Conta de luz, Sal√°rio, etc." required>
                        </div>

                        <!-- Valor -->
                        <div class="col-md-4">
                            <label class="form-label"><i class="bi bi-currency-dollar"></i> Valor (R$) *</label>
                            <input type="number" id="novaDespesaValor" class="form-control" placeholder="0.00" step="0.01" min="0" required>
                        </div>

                        <!-- Categoria -->
                        <div class="col-md-6">
                            <label class="form-label"><i class="bi bi-tag"></i> Categoria *</label>
                            <select id="novaDespesaCategoria" class="form-select" required>
                                <option value="">Selecione...</option>
                                <option value="Geral">Geral</option>
                                <option value="Sal√°rios">Sal√°rios</option>
                                <option value="Aluguel">Aluguel</option>
                                <option value="Contas">Contas (√°gua, luz, internet)</option>
                                <option value="Produtos">Produtos</option>
                                <option value="Manuten√ß√£o">Manuten√ß√£o</option>
                                <option value="Marketing">Marketing</option>
                                <option value="Impostos">Impostos</option>
                                <option value="Outros">Outros</option>
                            </select>
                        </div>

                        <!-- Forma de Pagamento -->
                        <div class="col-md-6">
                            <label class="form-label"><i class="bi bi-credit-card"></i> Forma de Pagamento *</label>
                            <select id="novaDespesaFormaPagamento" class="form-select" required>
                                <option value="">Selecione...</option>
                                <option value="Dinheiro">Dinheiro</option>
                                <option value="PIX">PIX</option>
                                <option value="D√©bito">Cart√£o de D√©bito</option>
                                <option value="Cr√©dito">Cart√£o de Cr√©dito</option>
                                <option value="Transfer√™ncia">Transfer√™ncia Banc√°ria</option>
                            </select>
                        </div>

                        <!-- Data -->
                        <div class="col-md-6">
                            <label class="form-label"><i class="bi bi-calendar"></i> Data *</label>
                            <input type="date" id="novaDespesaData" class="form-control" required>
                        </div>

                        <!-- Status -->
                        <div class="col-md-6">
                            <label class="form-label"><i class="bi bi-check-circle"></i> Status *</label>
                            <select id="novaDespesaStatus" class="form-select" required>
                                <option value="Pago">Pago</option>
                                <option value="Pendente">Pendente</option>
                                <option value="Atrasado">Atrasado</option>
                            </select>
                        </div>

                        <!-- Observa√ß√µes -->
                        <div class="col-12">
                            <label class="form-label"><i class="bi bi-chat-left-text"></i> Observa√ß√µes</label>
                            <textarea id="novaDespesaObs" class="form-control" rows="3" placeholder="Informa√ß√µes adicionais sobre esta despesa..."></textarea>
                        </div>
                    </div>

                    <!-- Bot√µes -->
                    <div class="mt-4" style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button type="button" class="bioma-btn bioma-btn-secondary" onclick="limparFormularioNovaDespesa()">
                            <i class="bi bi-x-circle"></i> Limpar
                        </button>
                        <button type="button" class="bioma-btn bioma-btn-danger" onclick="salvarNovaDespesa()">
                            <i class="bi bi-check-circle"></i> Registrar Despesa
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Sub-tab: Resumo -->
    <div id="financeiro-subtab-resumo" class="sub-tab-content active">
        <div class="row g-4 mb-4">
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-graph-up"></i> Faturamento Mensal - √öltimos 12 Meses
                    </div>
                    <div class="card-body">
                        <canvas id="graficoFaturamentoMensal" style="height: 350px;"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-percent"></i> Margem de Lucro
                    </div>
                    <div class="card-body text-center">
                        <h1 id="margemLucro" style="font-size: 4rem; font-weight: 900; color: var(--primary);">0%</h1>
                        <p class="text-muted">Margem L√≠quida</p>
                    </div>
                </div>
            </div>
        </div>
        <div class="row g-4">
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-scissors"></i> Servi√ßos Mais Vendidos
                    </div>
                    <div class="card-body">
                        <canvas id="graficoServicosMaisVendidos" style="height: 350px;"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-box"></i> Produtos Mais Vendidos
                    </div>
                    <div class="card-body">
                        <canvas id="graficoProdutosMaisVendidos" style="height: 350px;"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sub-tab: Receitas -->
    <div id="financeiro-subtab-receitas" class="sub-tab-content">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-arrow-up-circle"></i> Receitas (Or√ßamentos Aprovados)
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Or√ßamento #</th>
                                <th>Cliente</th>
                                <th>Valor</th>
                                <th>Categoria</th>
                            </tr>
                        </thead>
                        <tbody id="receitasTableBody">
                            <tr><td colspan="5" class="text-center"><div class="spinner"></div></td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Sub-tab: Despesas -->
    <div id="financeiro-subtab-despesas" class="sub-tab-content">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-arrow-down-circle"></i> Despesas
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Descri√ß√£o</th>
                                <th>Categoria</th>
                                <th>Valor</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="despesasTableBody">
                            <tr><td colspan="5" class="text-center"><div class="spinner"></div></td></tr>
                        </tbody>
                    </table>
                </div>
                <div id="despesasPaginacao"></div>
            </div>
        </div>
    </div>

    <!-- Sub-tab: Comiss√µes -->
    <div id="financeiro-subtab-comissoes" class="sub-tab-content">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-cash-stack"></i> Comiss√µes a Pagar
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>Profissional</th>
                                <th>Or√ßamento</th>
                                <th>Data</th>
                                <th>Valor Comiss√£o</th>
                                <th>Status</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="comissoesPagarTableBody">
                            <tr><td colspan="6" class="text-center"><div class="spinner"></div></td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Se√ß√£o de Estoque Expandida -->
<div id="section-estoque" class="content-section">
    <div class="page-header">
        <h1><i class="bi bi-box-seam"></i> Gest√£o de Estoque</h1>
        <div class="estoque-actions">
            <button class="bioma-btn bioma-btn-primary" onclick="loadEstoque()">
                <i class="bi bi-arrow-repeat"></i> Atualizar
            </button>
        </div>
    </div>

    <!-- Sub-tabs para Estoque -->
    <div class="sub-tabs">
        <button class="sub-tab-btn sub-tab-green-animated" onclick="switchSubTab('estoque', 'nova-entrada')">
            <i class="bi bi-box-arrow-in-down-fill"></i> Nova Entrada
        </button>
        <button class="sub-tab-btn sub-tab-red-animated" onclick="switchSubTab('estoque', 'nova-saida')">
            <i class="bi bi-box-arrow-up-fill"></i> Nova Sa√≠da
        </button>
        <button class="sub-tab-btn active" onclick="switchSubTab('estoque', 'visaogeral')">
            <i class="bi bi-grid"></i> Vis√£o Geral
        </button>
        <button class="sub-tab-btn" onclick="switchSubTab('estoque', 'produtos')">
            <i class="bi bi-box-seam"></i> Produtos
        </button>
        <button class="sub-tab-btn" onclick="switchSubTab('estoque', 'movimentacoes')">
            <i class="bi bi-arrow-left-right"></i> Movimenta√ß√µes
        </button>
        <button class="sub-tab-btn" onclick="switchSubTab('estoque', 'relatorios')">
            <i class="bi bi-file-earmark-text"></i> Relat√≥rios
        </button>
    </div>

    <!-- Sub-tab: Nova Entrada -->
    <div id="estoque-subtab-nova-entrada" class="sub-tab-content">
        <div class="card">
            <div class="card-header" style="background: linear-gradient(135deg, #10B981, #059669);">
                <i class="bi bi-box-arrow-in-down-fill"></i> Registrar Nova Entrada de Estoque
            </div>
            <div class="card-body">
                <form id="formNovaEntrada">
                    <div class="row g-3">
                        <!-- Produto -->
                        <div class="col-md-8">
                            <label class="form-label"><i class="bi bi-box-seam"></i> Produto *</label>
                            <select id="novaEntradaProduto" class="form-select" required>
                                <option value="">Selecione o produto...</option>
                            </select>
                        </div>

                        <!-- Quantidade -->
                        <div class="col-md-4">
                            <label class="form-label"><i class="bi bi-plus-circle"></i> Quantidade *</label>
                            <input type="number" id="novaEntradaQuantidade" class="form-control" placeholder="0" min="1" required>
                        </div>

                        <!-- Fornecedor -->
                        <div class="col-md-6">
                            <label class="form-label"><i class="bi bi-truck"></i> Fornecedor</label>
                            <input type="text" id="novaEntradaFornecedor" class="form-control" placeholder="Nome do fornecedor">
                        </div>

                        <!-- Valor Unit√°rio -->
                        <div class="col-md-6">
                            <label class="form-label"><i class="bi bi-currency-dollar"></i> Valor Unit√°rio (R$)</label>
                            <input type="number" id="novaEntradaValorUnitario" class="form-control" placeholder="0.00" step="0.01" min="0">
                        </div>

                        <!-- Data -->
                        <div class="col-md-6">
                            <label class="form-label"><i class="bi bi-calendar"></i> Data da Entrada *</label>
                            <input type="date" id="novaEntradaData" class="form-control" required>
                        </div>

                        <!-- Nota Fiscal -->
                        <div class="col-md-6">
                            <label class="form-label"><i class="bi bi-file-text"></i> Nota Fiscal</label>
                            <input type="text" id="novaEntradaNF" class="form-control" placeholder="N√∫mero da NF">
                        </div>

                        <!-- Observa√ß√µes -->
                        <div class="col-12">
                            <label class="form-label"><i class="bi bi-chat-left-text"></i> Observa√ß√µes</label>
                            <textarea id="novaEntradaObs" class="form-control" rows="3" placeholder="Informa√ß√µes adicionais sobre esta entrada..."></textarea>
                        </div>
                    </div>

                    <!-- Bot√µes -->
                    <div class="mt-4" style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button type="button" class="bioma-btn bioma-btn-secondary" onclick="limparFormularioNovaEntrada()">
                            <i class="bi bi-x-circle"></i> Limpar
                        </button>
                        <button type="button" class="bioma-btn bioma-btn-success" onclick="salvarNovaEntrada()">
                            <i class="bi bi-check-circle"></i> Registrar Entrada
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Sub-tab: Nova Sa√≠da -->
    <div id="estoque-subtab-nova-saida" class="sub-tab-content">
        <div class="card">
            <div class="card-header" style="background: linear-gradient(135deg, #EF4444, #DC2626);">
                <i class="bi bi-box-arrow-up-fill"></i> Registrar Nova Sa√≠da de Estoque
            </div>
            <div class="card-body">
                <form id="formNovaSaida">
                    <div class="row g-3">
                        <!-- Produto -->
                        <div class="col-md-8">
                            <label class="form-label"><i class="bi bi-box-seam"></i> Produto *</label>
                            <select id="novaSaidaProduto" class="form-select" required>
                                <option value="">Selecione o produto...</option>
                            </select>
                        </div>

                        <!-- Quantidade -->
                        <div class="col-md-4">
                            <label class="form-label"><i class="bi bi-dash-circle"></i> Quantidade *</label>
                            <input type="number" id="novaSaidaQuantidade" class="form-control" placeholder="0" min="1" required>
                        </div>

                        <!-- Motivo -->
                        <div class="col-md-12">
                            <label class="form-label"><i class="bi bi-info-circle"></i> Motivo da Sa√≠da *</label>
                            <select id="novaSaidaMotivo" class="form-select" required>
                                <option value="">Selecione...</option>
                                <option value="Venda">Venda</option>
                                <option value="Uso Interno">Uso Interno</option>
                                <option value="Perda">Perda/Avaria</option>
                                <option value="Devolu√ß√£o">Devolu√ß√£o</option>
                                <option value="Doa√ß√£o">Doa√ß√£o</option>
                                <option value="Outros">Outros</option>
                            </select>
                        </div>

                        <!-- Data -->
                        <div class="col-md-6">
                            <label class="form-label"><i class="bi bi-calendar"></i> Data da Sa√≠da *</label>
                            <input type="date" id="novaSaidaData" class="form-control" required>
                        </div>

                        <!-- Respons√°vel -->
                        <div class="col-md-6">
                            <label class="form-label"><i class="bi bi-person"></i> Respons√°vel</label>
                            <input type="text" id="novaSaidaResponsavel" class="form-control" placeholder="Nome do respons√°vel">
                        </div>

                        <!-- Observa√ß√µes -->
                        <div class="col-12">
                            <label class="form-label"><i class="bi bi-chat-left-text"></i> Observa√ß√µes</label>
                            <textarea id="novaSaidaObs" class="form-control" rows="3" placeholder="Informa√ß√µes adicionais sobre esta sa√≠da..."></textarea>
                        </div>
                    </div>

                    <!-- Bot√µes -->
                    <div class="mt-4" style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button type="button" class="bioma-btn bioma-btn-secondary" onclick="limparFormularioNovaSaida()">
                            <i class="bi bi-x-circle"></i> Limpar
                        </button>
                        <button type="button" class="bioma-btn bioma-btn-danger" onclick="salvarNovaSaida()">
                            <i class="bi bi-check-circle"></i> Registrar Sa√≠da
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Sub-tab: Vis√£o Geral -->
    <div id="estoque-subtab-visaogeral" class="sub-tab-content active">
        <div class="row g-4 mb-4">
            <div class="col-xl-3 col-md-6">
                <div class="stat-card" style="background:linear-gradient(135deg,#3b82f6,#2563eb);">
                    <div class="stat-icon"><i class="bi bi-box-seam"></i></div>
                    <div class="stat-info">
                        <div class="stat-value" id="totalProdutosEstoque">0</div>
                        <div class="stat-label">Total de Produtos</div>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6">
                <div class="stat-card" style="background:linear-gradient(135deg,#10b981,#059669);">
                    <div class="stat-icon"><i class="bi bi-currency-dollar"></i></div>
                    <div class="stat-info">
                        <div class="stat-value" id="valorTotalEstoque">R$ 0</div>
                        <div class="stat-label">Valor em Estoque</div>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6">
                <div class="stat-card" style="background:linear-gradient(135deg,#f59e0b,#d97706);">
                    <div class="stat-icon"><i class="bi bi-archive"></i></div>
                    <div class="stat-info">
                        <div class="stat-value" id="itensAbaixoMinimo">0</div>
                        <div class="stat-label">Abaixo do M√≠nimo</div>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6">
                <div class="stat-card" style="background:linear-gradient(135deg,#8b5cf6,#7c3aed);">
                    <div class="stat-icon"><i class="bi bi-arrow-repeat"></i></div>
                    <div class="stat-info">
                        <div class="stat-value" id="movimentacoesEstoque">0</div>
                        <div class="stat-label">Movimenta√ß√µes (m√™s)</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-4">
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-graph-up"></i> Resumo de Movimenta√ß√µes
                    </div>
                    <div class="card-body">
                        <canvas id="chartEstoqueVisaoGeral" style="max-height: 300px;"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-pie-chart"></i> Distribui√ß√£o
                    </div>
                    <div class="card-body">
                        <canvas id="chartDistribuicaoEstoque" style="max-height: 300px;"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mt-4">
            <div class="card-header">
                <i class="bi bi-clock-history"></i> √öltimas Movimenta√ß√µes
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Produto</th>
                                <th>Tipo</th>
                                <th>Quantidade</th>
                                <th>Respons√°vel</th>
                            </tr>
                        </thead>
                        <tbody id="estoqueUltimasMovimentacoesVisaoGeral">
                            <tr><td colspan="5" class="text-center text-muted">Nenhuma movimenta√ß√£o recente</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Sub-tab: Produtos -->
    <div id="estoque-subtab-produtos" class="sub-tab-content">
        <div class="card">
            <div class="card-header"><i class="bi bi-box"></i> Lista de Produtos</div>
            <div class="card-body">
                <div class="mb-3">
                    <input type="text" class="form-control" id="buscaProdutosEstoque" placeholder="Buscar por nome, marca ou SKU..." onkeyup="filtrarProdutosEstoque()">
                </div>
                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>Produto</th>
                                <th>Marca</th>
                                <th>SKU</th>
                                <th>Quantidade</th>
                                <th>M√≠nimo</th>
                                <th>Pre√ßo</th>
                                <th>Valor Total</th>
                                <th>Status</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="estoqueProdutosBody">
                            <tr><td colspan="8" class="text-center"><div class="spinner"></div></td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Sub-tab: Movimenta√ß√µes -->
    <div id="estoque-subtab-movimentacoes" class="sub-tab-content">
        <div class="card">
            <div class="card-header"><i class="bi bi-arrow-left-right"></i> Hist√≥rico de Movimenta√ß√µes</div>
            <div class="card-body">
                <div class="row g-3 mb-4">
                    <div class="col-md-3">
                        <label class="form-label">Tipo</label>
                        <select id="filtroTipoMov" class="form-select" onchange="carregarMovimentacoesEstoque()">
                            <option value="">Todos</option>
                            <option value="entrada">Entrada</option>
                            <option value="saida">Sa√≠da</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Data In√≠cio</label>
                        <input type="date" id="filtroDataInicioMov" class="form-control">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Data Fim</label>
                        <input type="date" id="filtroDataFimMov" class="form-control">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">&nbsp;</label>
                        <button class="btn btn-primary w-100" onclick="carregarMovimentacoesEstoque()">
                            <i class="bi bi-search"></i> Filtrar
                        </button>
                    </div>
                </div>

                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Tipo</th>
                                <th>Produto</th>
                                <th>Quantidade</th>
                                <th>Motivo</th>
                                <th>Respons√°vel</th>
                            </tr>
                        </thead>
                        <tbody id="estoqueMovimentacoesBody">
                            <tr><td colspan="6" class="text-center"><div class="spinner"></div></td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Sub-tab: Relat√≥rios -->
    <div id="estoque-subtab-relatorios" class="sub-tab-content">
        <div class="card">
            <div class="card-header"><i class="bi bi-file-earmark-text"></i> Relat√≥rio Personalizado</div>
            <div class="card-body">
                <div class="row g-3 mb-3">
                    <div class="col-md-4">
                        <label class="form-label">Data In√≠cio</label>
                        <input type="date" id="relatorioDataInicio" class="form-control">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Data Fim</label>
                        <input type="date" id="relatorioDataFim" class="form-control">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Tipo de Relat√≥rio</label>
                        <select id="relatorioTipo" class="form-select">
                            <option value="movimentacoes">Movimenta√ß√µes</option>
                            <option value="estoque">Posi√ß√£o de Estoque</option>
                            <option value="valorizado">Estoque Valorizado</option>
                            <option value="criticos">Produtos Cr√≠ticos</option>
                        </select>
                    </div>
                </div>
                <div class="d-flex gap-2">
                    <button class="bioma-btn bioma-btn-primary" onclick="gerarRelatorioEstoque()">
                        <i class="bi bi-bar-chart"></i> Gerar Relat√≥rio
                    </button>
                    <button class="bioma-btn bioma-btn-success" onclick="exportarRelatorioExcel()">
                        <i class="bi bi-file-earmark-excel"></i> Exportar Excel
                    </button>
                    <button class="bioma-btn bioma-btn-danger" onclick="exportarRelatorioPDF()">
                        <i class="bi bi-file-earmark-pdf"></i> Exportar PDF
                    </button>
                </div>
                <div id="relatorioEstoqueResultados" style="display:none;" class="mt-4"></div>
            </div>
        </div>

        <!-- Gr√°ficos -->
        <div class="row g-4 mt-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-graph-up"></i> Movimenta√ß√µes por M√™s
                    </div>
                    <div class="card-body">
                        <canvas id="chartMovimentacoesEstoque"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-pie-chart"></i> Distribui√ß√£o de Valor
                    </div>
                    <div class="card-body">
                        <canvas id="chartValorEstoque"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Fim se√ß√£o estoque -->

        <div id="section-clube" class="content-section">
            <div class="community-hero">
                <h2><i class="bi bi-stars"></i> Comunidade BIOMA</h2>
                <p>Resultados reais, desafios e experi√™ncias compartilhadas pelas nossas franquias.</p>
                <div class="community-pill"><i class="bi bi-chat-dots"></i> +250 feedbacks mensais</div>
                <div class="community-pill"><i class="bi bi-heart-fill"></i> 98% satisfa√ß√£o</div>
                <div class="community-pill"><i class="bi bi-award"></i> 32 mentorias conclu√≠das</div>
            </div>
            <div class="community-grid">
                <div class="community-card">
                    <h5><i class="bi bi-people-fill"></i> Plano Conex√£o VIP</h5>
                    <p>Programa premium para clientes recorrentes com acompanhamento personalizado e experi√™ncias exclusivas.</p>
                    <ul class="mb-3">
                        <li>12 sess√µes anuais planejadas</li>
                        <li>Mentorias com especialistas BIOMA</li>
                        <li>Clube de benef√≠cios com parceiros</li>
                    </ul>
                    <button class="btn btn-outline" type="button" onclick="abrirComunidadeDetalhe('conexao')"><i class="bi bi-eye"></i> Ver detalhes</button>
                </div>
                <div class="community-card">
                    <h5><i class="bi bi-lightbulb"></i> Novos Workshops</h5>
                    <p>Capacita√ß√µes mensais sobre gest√£o de sal√£o, neurovendas e cronogramas capilares.</p>
                    <ul class="mb-3">
                        <li>Agenda interativa com confirma√ß√£o online</li>
                        <li>Materiais exclusivos p√≥s-evento</li>
                        <li>Certificados digitais personalizados</li>
                    </ul>
                    <button class="btn btn-outline" type="button" onclick="abrirComunidadeDetalhe('workshops')"><i class="bi bi-calendar-event"></i> Pr√≥ximas turmas</button>
                </div>
                <div class="community-card">
                    <h5><i class="bi bi-graph-up"></i> Hist√≥rias de Sucesso</h5>
                    <p>Empreendedores BIOMA compartilhando crescimento real com dados de faturamento e engajamento.</p>
                    <div class="mb-3">
                        <strong>+32%</strong> aumento m√©dio de ticket em 90 dias<br>
                        <strong>+18%</strong> crescimento em produtos recomendados<br>
                        <strong>92%</strong> de ades√£o aos planos fidelidade
                    </div>
                    <button class="btn btn-outline" type="button" onclick="abrirComunidadeDetalhe('cases')"><i class="bi bi-play-circle"></i> Assistir depoimentos</button>
                </div>
                <div class="community-card">
                    <h5><i class="bi bi-chat-quote-fill"></i> Canal de Ideias</h5>
                    <p>Sele√ß√£o das principais demandas sugeridas pelas franquias e status de implementa√ß√£o.</p>
                    <ul class="mb-3">
                        <li>App mobile para equipe - em desenvolvimento</li>
                        <li>Dashboard de indicadores em tempo real - entregue</li>
                        <li>Integra√ß√£o com BIOMA Pay - em testes</li>
                    </ul>
                    <button class="btn btn-outline" type="button" onclick="abrirComunidadeDetalhe('ideias')"><i class="bi bi-send"></i> Enviar sugest√£o</button>
                </div>
            </div>
        </div>

        <div id="section-importar" class="content-section">
            <div class="page-header">
                <h1><i class="bi bi-cloud-upload"></i> Importar Dados em Massa</h1>
            </div>
            <div class="alert alert-info">
                <strong><i class="bi bi-info-circle"></i> Informa√ß√£o:</strong>
                Fa√ßa upload de arquivos CSV ou Excel (.xlsx, .xls) para importar dados em massa.
                Baixe os templates para garantir o formato correto.
            </div>
            <div class="text-center mb-4">
                <button id="btnDesfazerImportacao" class="btn-undo-import" onclick="desfazerUltimaImportacao()" disabled>
                    <i class="bi bi-arrow-counterclockwise"></i>
                    Desfazer √öltima Importa√ß√£o (CTRL+Z)
                </button>
                <p class="text-muted mt-2" style="font-size: 0.9rem;">
                    <i class="bi bi-info-circle"></i> O bot√£o ser√° ativado ap√≥s realizar uma importa√ß√£o
                </p>
            </div>
            <div class="row g-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header"><i class="bi bi-people"></i> Clientes</div>
                        <div class="card-body">
                            <div style="border:3px dashed var(--border-color);border-radius:20px;padding:60px 20px;text-align:center;cursor:pointer;transition: all 0.3s;" onclick="document.getElementById('uploadClientes').click()" onmouseover="this.style.borderColor='var(--primary)'" onmouseout="this.style.borderColor='var(--border-color)'">
                                <i class="bi bi-cloud-upload" style="font-size:4rem;color:var(--primary)"></i>
                                <h4 style="margin-top:15px;">Clique para selecionar arquivo</h4>
                                <p class="text-muted">CSV ou Excel (xlsx, xls)</p>
                                <input type="file" id="uploadClientes" accept=".csv,.xlsx,.xls" style="display:none" onchange="handleUpload(this,'clientes')">
                            </div>
                            <a href="/api/template/download/clientes" class="btn btn-outline w-100 mt-3">
                                <i class="bi bi-download"></i> Baixar Template CSV
                            </a>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header"><i class="bi bi-person-workspace"></i> Profissionais</div>
                        <div class="card-body">
                            <div style="border:3px dashed var(--border-color);border-radius:20px;padding:60px 20px;text-align:center;cursor:pointer;transition: all 0.3s;" onclick="document.getElementById('uploadProfissionais').click()" onmouseover="this.style.borderColor='var(--primary)'" onmouseout="this.style.borderColor='var(--border-color)'">
                                <i class="bi bi-cloud-upload" style="font-size:4rem;color:var(--primary)"></i>
                                <h4 style="margin-top:15px;">Clique para selecionar arquivo</h4>
                                <p class="text-muted">CSV ou Excel (xlsx, xls)</p>
                                <input type="file" id="uploadProfissionais" accept=".csv,.xlsx,.xls" style="display:none" onchange="handleUpload(this,'profissionais')">
                            </div>
                            <a href="/api/template/download/profissionais" class="btn btn-outline w-100 mt-3">
                                <i class="bi bi-download"></i> Baixar Template CSV
                            </a>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header"><i class="bi bi-box-seam"></i> Produtos</div>
                        <div class="card-body">
                            <div style="border:3px dashed var(--border-color);border-radius:20px;padding:60px 20px;text-align:center;cursor:pointer;transition: all 0.3s;" onclick="document.getElementById('uploadProdutos').click()" onmouseover="this.style.borderColor='var(--primary)'" onmouseout="this.style.borderColor='var(--border-color)'">
                                <i class="bi bi-cloud-upload" style="font-size:4rem;color:var(--primary)"></i>
                                <h4 style="margin-top:15px;">Clique para selecionar arquivo</h4>
                                <p class="text-muted">CSV ou Excel (xlsx, xls)</p>
                                <input type="file" id="uploadProdutos" accept=".csv,.xlsx,.xls" style="display:none" onchange="handleUpload(this,'produtos')">
                            </div>
                            <a href="/api/template/download/produtos" class="btn btn-outline w-100 mt-3">
                                <i class="bi bi-download"></i> Baixar Template CSV
                            </a>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header"><i class="bi bi-scissors"></i> Servi√ßos</div>
                        <div class="card-body">
                            <div style="border:3px dashed var(--border-color);border-radius:20px;padding:60px 20px;text-align:center;cursor:pointer;transition: all 0.3s;" onclick="document.getElementById('uploadServicos').click()" onmouseover="this.style.borderColor='var(--primary)'" onmouseout="this.style.borderColor='var(--border-color)'">
                                <i class="bi bi-cloud-upload" style="font-size:4rem;color:var(--primary)"></i>
                                <h4 style="margin-top:15px;">Clique para selecionar arquivo</h4>
                                <p class="text-muted">CSV ou Excel (xlsx, xls)</p>
                                <input type="file" id="uploadServicos" accept=".csv,.xlsx,.xls" style="display:none" onchange="handleUpload(this,'servicos')">
                            </div>
                            <a href="/api/template/download/servicos" class="btn btn-outline w-100 mt-3">
                                <i class="bi bi-download"></i> Baixar Template CSV
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="section-sistema" class="content-section">
            <div class="page-header"><h1><i class="bi bi-activity"></i> Status do Sistema</h1></div>
            <div class="row g-4 mb-4">
                <div class="col-md-4"><div class="card"><div class="card-header"><i class="bi bi-database"></i> MongoDB</div><div class="card-body text-center"><div id="mongoStatus" class="badge warning">Verificando...</div><p class="mt-3" id="mongoMessage">...</p></div></div></div>
                <div class="col-md-4"><div class="card"><div class="card-header"><i class="bi bi-envelope"></i> MailerSend</div><div class="card-body text-center"><div id="emailStatus" class="badge warning">Verificando...</div><p class="mt-3" id="emailMessage">...</p><button class="bioma-btn bioma-btn-sm bioma-btn-success mt-2" onclick="testarEnvioEmail()" style="width: 100%;"><i class="bi bi-send"></i> Enviar E-mail de Teste</button></div></div></div>
                <div class="col-md-4"><div class="card"><div class="card-header"><i class="bi bi-info-circle"></i> Vers√£o</div><div class="card-body text-center"><h3>v4.0</h3><p>BIOMA Uberaba</p></div></div></div>
            </div>

            <!-- Nova Se√ß√£o: Status de Recursos Avan√ßados -->
            <div class="row g-4">
                <!-- Gerador de Documentos -->
                <div class="col-md-4">
                    <div class="card" style="border: 2px solid transparent; transition: all 0.3s ease;">
                        <div class="card-header" style="background: linear-gradient(135deg, #10B981, #059669);">
                            <i class="bi bi-file-earmark-pdf"></i> Gerador de Documentos
                        </div>
                        <div class="card-body text-center">
                            <div id="docGeneratorStatus" class="badge success">
                                <i class="bi bi-check-circle-fill"></i> Funcional
                            </div>
                            <p class="mt-3 mb-2" style="font-size: 0.9rem; color: var(--text-secondary);">
                                Sistema de gera√ß√£o de PDFs profissionais est√° ativo e pronto para uso.
                            </p>
                            <div style="display: flex; gap: 8px; margin-top: 15px; flex-wrap: wrap; font-size: 0.85rem;">
                                <span class="badge" style="background: rgba(16, 185, 129, 0.15); color: #10B981; flex: 1;">
                                    <i class="bi bi-file-pdf"></i> jsPDF
                                </span>
                                <span class="badge" style="background: rgba(16, 185, 129, 0.15); color: #10B981; flex: 1;">
                                    <i class="bi bi-table"></i> AutoTable
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sistema Offline -->
                <div class="col-md-4">
                    <div class="card" style="border: 2px solid transparent; transition: all 0.3s ease;">
                        <div class="card-header" style="background: linear-gradient(135deg, #8B5CF6, #7C3AED);">
                            <i class="bi bi-wifi-off"></i> Sistema Offline
                        </div>
                        <div class="card-body text-center">
                            <div id="offlineStatus" class="badge success">
                                <i class="bi bi-check-circle-fill"></i> Pronto
                            </div>
                            <p class="mt-3 mb-2" style="font-size: 0.9rem; color: var(--text-secondary);">
                                Modo offline ativo. O sistema continua funcionando mesmo sem internet.
                            </p>
                            <div style="display: flex; flex-direction: column; gap: 8px; margin-top: 15px; font-size: 0.85rem;">
                                <span class="badge" style="background: rgba(139, 92, 246, 0.15); color: #8B5CF6; display: flex; align-items: center; justify-content: center; gap: 8px;">
                                    <i class="bi bi-shield-check"></i> Auto-recupera√ß√£o de rede
                                </span>
                                <span class="badge" style="background: rgba(139, 92, 246, 0.15); color: #8B5CF6; display: flex; align-items: center; justify-content: center; gap: 8px;">
                                    <i class="bi bi-cloud-upload"></i> Sincroniza√ß√£o autom√°tica
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Banco de Dados Local -->
                <div class="col-md-4">
                    <div class="card" style="border: 2px solid transparent; transition: all 0.3s ease;">
                        <div class="card-header" style="background: linear-gradient(135deg, #F59E0B, #D97706);">
                            <i class="bi bi-hdd"></i> Banco de Dados Local
                        </div>
                        <div class="card-body text-center">
                            <div id="indexedDBStatus" class="badge success">
                                <i class="bi bi-check-circle-fill"></i> Operacional
                            </div>
                            <p class="mt-3 mb-2" style="font-size: 0.9rem; color: var(--text-secondary);">
                                IndexedDB dispon√≠vel para armazenamento local e backup offline.
                            </p>
                            <button class="btn btn-sm mt-2" onclick="downloadLocalDatabase()" style="width: 100%; background: linear-gradient(135deg, #F59E0B, #D97706); color: white; border: none; padding: 10px; font-weight: 600;">
                                <i class="bi bi-download"></i> Baixar Backup Local
                            </button>
                            <p style="font-size: 0.75rem; color: var(--text-muted); margin-top: 8px;">
                                Os dados s√£o sincronizados automaticamente quando a internet √© restabelecida
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Card de Limpar Banco de Dados -->
                <div class="col-md-12 mt-4">
                    <div class="card" style="border: 2px solid #EF4444; transition: all 0.3s ease;">
                        <div class="card-header" style="background: linear-gradient(135deg, #EF4444, #DC2626); color: white;">
                            <i class="bi bi-exclamation-triangle-fill"></i> Zona de Perigo - Gerenciamento de Dados
                        </div>
                        <div class="card-body">
                            <div class="alert alert-danger" style="margin-bottom: 20px;">
                                <strong><i class="bi bi-shield-exclamation"></i> ATEN√á√ÉO!</strong>
                                <p style="margin-top: 10px; margin-bottom: 0;">
                                    Esta a√ß√£o ir√° <strong>APAGAR TODOS OS DADOS</strong> do sistema, incluindo:
                                    clientes, profissionais, servi√ßos, produtos, or√ßamentos, contratos, agendamentos, movimenta√ß√µes de estoque, comiss√µes, despesas e assistentes.
                                </p>
                                <p style="margin-top: 10px; margin-bottom: 0; font-weight: 600;">
                                    ‚ö†Ô∏è Esta a√ß√£o <strong>N√ÉO PODE SER DESFEITA</strong>!
                                </p>
                            </div>
                            <button class="btn btn-danger btn-lg" onclick="limparBancoDados()" style="width: 100%; padding: 15px; font-weight: 700;">
                                <i class="bi bi-trash3-fill"></i> LIMPAR BANCO DE DADOS COMPLETO
                            </button>
                            <p style="margin-top: 15px; font-size: 0.85rem; color: var(--text-muted); text-align: center;">
                                <i class="bi bi-info-circle"></i> Apenas administradores podem executar esta a√ß√£o
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Se√ß√£o de Auditoria -->
        <div id="section-auditoria" class="content-section">
            <div class="page-header">
                <h1><i class="bi bi-shield-check"></i> Auditoria do Sistema</h1>
                <button class="bioma-btn bioma-btn-primary" onclick="loadAuditoria()">
                    <i class="bi bi-arrow-clockwise"></i> Atualizar
                </button>
            </div>

            <!-- Filtros de Auditoria -->
            <div class="card mb-4">
                <div class="card-header"><i class="bi bi-funnel"></i> Filtros</div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label">Usu√°rio</label>
                            <input type="text" id="auditoriaUsername" class="form-control" placeholder="Nome do usu√°rio">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">A√ß√£o</label>
                            <select id="auditoriaAcao" class="form-select">
                                <option value="">Todas</option>
                                <option value="criar">Criar</option>
                                <option value="editar">Editar</option>
                                <option value="deletar">Deletar</option>
                                <option value="aprovar">Aprovar</option>
                                <option value="rejeitar">Rejeitar</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Entidade</label>
                            <select id="auditoriaEntidade" class="form-select">
                                <option value="">Todas</option>
                                <option value="cliente">Cliente</option>
                                <option value="produto">Produto</option>
                                <option value="orcamento">Or√ßamento</option>
                                <option value="profissional">Profissional</option>
                                <option value="estoque">Estoque</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Data In√≠cio</label>
                            <input type="date" id="auditoriaDataInicio" class="form-control">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Data Fim</label>
                            <input type="date" id="auditoriaDataFim" class="form-control">
                        </div>
                        <div class="col-md-1">
                            <label class="form-label">&nbsp;</label>
                            <button class="btn btn-primary w-100" onclick="loadAuditoria()">
                                <i class="bi bi-search"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Estat√≠sticas de Auditoria -->
            <div class="row g-4 mb-4" id="auditoriaStats" style="display:none;">
                <div class="col-md-4">
                    <div class="stat-card">
                        <div class="icon"><i class="bi bi-activity"></i></div>
                        <h3 id="auditoriaTotalAcoes">0</h3>
                        <p>Total de A√ß√µes</p>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="stat-card">
                        <div class="icon"><i class="bi bi-people"></i></div>
                        <h3 id="auditoriaUsuariosAtivos">0</h3>
                        <p>Usu√°rios Ativos</p>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="stat-card">
                        <div class="icon"><i class="bi bi-pie-chart"></i></div>
                        <h3 id="auditoriaPrincipalAcao">-</h3>
                        <p>A√ß√£o Mais Comum</p>
                    </div>
                </div>
            </div>

            <!-- Tabela de Auditoria -->
            <div class="card">
                <div class="card-header"><i class="bi bi-list-ul"></i> Registro de A√ß√µes</div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>Data/Hora</th>
                                    <th>Usu√°rio</th>
                                    <th>A√ß√£o</th>
                                    <th>Entidade</th>
                                    <th>ID</th>
                                    <th>IP</th>
                                    <th>Detalhes</th>
                                </tr>
                            </thead>
                            <tbody id="auditoriaTableBody">
                                <tr><td colspan="7" class="text-center"><div class="spinner"></div></td></tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagina√ß√£o Auditoria -->
                    <div id="paginacaoAuditoria" class="d-flex justify-content-center align-items-center gap-3 mt-4" style="display:none !important;">
                        <button class="bioma-btn bioma-btn-sm bioma-btn-outline" onclick="mudarPaginaAuditoria(-1)">
                            <i class="bi bi-chevron-left"></i> Anterior
                        </button>
                        <span id="infoPaginaAuditoria" class="text-muted fw-bold">P√°gina 1 de 1</span>
                        <button class="bioma-btn bioma-btn-sm bioma-btn-outline" onclick="mudarPaginaAuditoria(1)">
                            Pr√≥xima <i class="bi bi-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="section-configuracoes" class="content-section">
            <div class="page-header"><h1><i class="bi bi-gear"></i> Configura√ß√µes</h1></div>
            <div class="card"><div class="card-header"><i class="bi bi-building"></i> Dados da Franquia BIOMA</div><div class="card-body"><div class="row g-3 mb-3"><div class="col-md-6"><label style="display:block;font-weight:700;margin-bottom:10px">Nome da Empresa *</label><input type="text" id="cfgNome" value="BIOMA UBERABA" class="form-control"></div><div class="col-md-6"><label style="display:block;font-weight:700;margin-bottom:10px">CNPJ *</label><input type="text" id="cfgCNPJ" value="49.470.937/0001-10" class="form-control"></div></div><div class="mb-3"><label style="display:block;font-weight:700;margin-bottom:10px">Endere√ßo Completo *</label><input type="text" id="cfgEndereco" value="Av. Santos Dumont 3110 - Santa Maria - Uberaba/MG - CEP 38050-400" class="form-control"></div><div class="row g-3 mb-3"><div class="col-md-6"><label style="display:block;font-weight:700;margin-bottom:10px">Telefone *</label><input type="text" id="cfgTelefone" value="(34) 99235-5890" class="form-control"></div><div class="col-md-6"><label style="display:block;font-weight:700;margin-bottom:10px">E-mail *</label><input type="email" id="cfgEmail" value="biomauberaba@gmail.com" class="form-control"></div></div><button class="bioma-btn bioma-btn-primary" onclick="salvarConfig()"><i class="bi bi-save"></i> Salvar Dados da Franquia</button></div></div>
            <div class="card mt-4"><div class="card-header"><i class="bi bi-image"></i> Personaliza√ß√£o Visual</div><div class="card-body"><div class="row g-4"><div class="col-md-6"><div class="logo-preview-card"><div class="logo-preview" id="logoPrincipalPreview"><span class="text-muted">Logo do sistema</span></div><button class="btn btn-outline" type="button" onclick="abrirUploadLogo('principal')"><i class="bi bi-upload"></i> Enviar logo principal</button><button class="bioma-btn bioma-btn-sm bioma-btn-link text-danger mt-2" type="button" onclick="removerLogo('principal')">Remover</button></div></div><div class="col-md-6"><div class="logo-preview-card"><div class="logo-preview" id="logoLoginPreview"><span class="text-muted">Logo da tela de login</span></div><button class="btn btn-outline" type="button" onclick="abrirUploadLogo('login')"><i class="bi bi-upload"></i> Enviar logo de login</button><button class="bioma-btn bioma-btn-sm bioma-btn-link text-danger mt-2" type="button" onclick="removerLogo('login')">Remover</button></div></div></div></div></div>
            <div class="card mt-4"><div class="card-header"><i class="bi bi-sliders"></i> Configura√ß√µes Operacionais</div><div class="card-body"><div class="row g-3 mb-3"><div class="col-md-4"><label style="display:block;font-weight:700;margin-bottom:10px">Hor√°rio Abertura</label><input type="time" id="cfgHorarioAbertura" value="08:00" class="form-control"></div><div class="col-md-4"><label style="display:block;font-weight:700;margin-bottom:10px">Hor√°rio Fechamento</label><input type="time" id="cfgHorarioFechamento" value="19:00" class="form-control"></div><div class="col-md-4"><label style="display:block;font-weight:700;margin-bottom:10px">Dura√ß√£o Padr√£o (min)</label><input type="number" id="cfgDuracaoPadrao" value="60" class="form-control"></div></div><div class="row g-3 mb-3"><div class="col-md-6"><label style="display:block;font-weight:700;margin-bottom:10px">Cashback Padr√£o (%)</label><input type="number" id="cfgCashbackPadrao" value="5" min="0" max="100" class="form-control"></div><div class="col-md-6"><label style="display:block;font-weight:700;margin-bottom:10px">Comiss√£o Padr√£o (%)</label><input type="number" id="cfgComissaoPadrao" value="10" min="0" max="100" class="form-control"></div></div><button class="bioma-btn bioma-btn-success" onclick="salvarConfigOp()"><i class="bi bi-check-circle"></i> Salvar Configura√ß√µes Operacionais</button></div></div>
            <div class="card mt-4"><div class="card-header"><i class="bi bi-envelope"></i> Configura√ß√µes de E-mail</div><div class="card-body"><p class="text-muted mb-3">Configure as credenciais SMTP para envio de e-mails autom√°ticos (or√ßamentos, notifica√ß√µes, etc.)</p><div class="alert alert-info"><i class="bi bi-info-circle"></i> <strong>Importante:</strong> As configura√ß√µes de SMTP devem ser definidas no arquivo <code>.env</code> do servidor:<br><code>EMAIL_HOST</code>, <code>EMAIL_PORT</code>, <code>EMAIL_USER</code>, <code>EMAIL_PASSWORD</code>, <code>EMAIL_FROM</code></div><div class="mb-3"><label style="display:block;font-weight:700;margin-bottom:10px">Testar Configura√ß√£o de E-mail</label><div class="input-group"><input type="email" id="emailTesteDestino" placeholder="Digite um e-mail para teste" class="form-control"><button class="bioma-btn bioma-btn-primary" onclick="testarEmailConfig()"><i class="bi bi-send"></i> Enviar E-mail de Teste</button></div><small class="text-muted">Um e-mail de teste ser√° enviado para verificar se as configura√ß√µes est√£o corretas.</small></div></div></div>
            <div class="card mt-4"><div class="card-header"><i class="bi bi-shield-check"></i> Licen√ßa e Desenvolvedor</div><div class="card-body"><table style="width:100%"><tr style="border-bottom:1px solid var(--border-color)"><td style="padding:15px;font-weight:700">Plano Contratado:</td><td style="padding:15px"><span class="badge success">PROFISSIONAL PREMIUM</span></td></tr><tr style="border-bottom:1px solid var(--border-color)"><td style="padding:15px;font-weight:700">Franquia:</td><td style="padding:15px">BIOMA Uberaba - Oficial</td></tr><tr style="border-bottom:1px solid var(--border-color)"><td style="padding:15px;font-weight:700">Desenvolvedor:</td><td style="padding:15px">@juanmarco1999 (Juan Marco Bernardos Souza e Silva)</td></tr><tr style="border-bottom:1px solid var(--border-color)"><td style="padding:15px;font-weight:700">Email Suporte:</td><td style="padding:15px">180147064@aluno.unb.br</td></tr><tr style="border-bottom:1px solid var(--border-color)"><td style="padding:15px;font-weight:700">Vers√£o:</td><td style="padding:15px">v4.0 (Build 2025.10.05)</td></tr><tr><td style="padding:15px;font-weight:700">√öltima Atualiza√ß√£o:</td><td style="padding:15px">05 de Outubro de 2025 √†s 22:34 UTC</td></tr></table></div></div>
        </div>

    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>

let currentUser=null,currentTheme='light',orcamento={servicos:[],produtos:[]},servicosDisponiveis=[],produtosDisponiveis=[],servicoSelecionado=null,produtoSelecionado=null;
let produtosCache=[],buscaGlobalTimer=null,configuracoesAtuais=null,logosPersonalizados={principal:null,login:null};

// FLAGS ANTI-LOOP: Prevenir carregamento infinito
let loadingFlags = {};
let appInitialized = false;
let sseInstance = null;
let sseReconnectAttempts = 0;
const MAX_SSE_RECONNECT = 3;

function setLoading(key, value) {
    loadingFlags[key] = value;
    if (value) {
        setTimeout(() => { loadingFlags[key] = false; }, 10000); // Auto-reset ap√≥s 10s
    }
}

function isLoading(key) {
    return loadingFlags[key] === true;
}

// ========== FUN√á√ÉO GLOBAL: SWITCH SUB-TAB ==========
function switchSubTab(section, subtab) {
    console.log(`üîÑ Mudando sub-tab: ${section} ‚Üí ${subtab}`);

    // 1. DESATIVAR todos os conte√∫dos desta se√ß√£o (CSS controla display via .active)
    document.querySelectorAll(`[id^="${section}-subtab-"]`).forEach(content => {
        content.classList.remove('active');
        content.classList.add('d-none'); // Adicionar d-none para esconder
    });

    // 2. DESATIVAR todos os bot√µes
    const sectionElement = document.getElementById(`section-${section}`);
    if (sectionElement) {
        sectionElement.querySelectorAll('.sub-tab-btn').forEach(btn => {
            btn.classList.remove('active');
        });
    }

    // 3. ATIVAR apenas o selecionado
    const targetId = `${section}-subtab-${subtab}`;
    const targetContent = document.getElementById(targetId);

    if (!targetContent) {
        console.error(`‚ùå Sub-tab n√£o encontrada: ${targetId}`);
        return;
    }

    targetContent.classList.add('active');
    targetContent.classList.remove('d-none'); // Remover d-none para mostrar

    // 4. ATIVAR bot√£o clicado
    if (event?.target) {
        event.target.classList.add('active');
    }

    // 5. Carregar dados espec√≠ficos da sub-tab
    if (typeof carregarDadosSubTab === 'function') {
        carregarDadosSubTab(section, subtab);
    }
    
    // 6. Tratamento especial para a se√ß√£o de or√ßamento
    if (section === 'orcamento') {
        if (subtab === 'novo') {
            cancelarOrc(); // Limpar formul√°rio para novo or√ßamento
        } else if (subtab === 'pendentes' || subtab === 'aprovados' || subtab === 'rejeitados' || subtab === 'historico') {
            carregarHistoricoOrcamentos(); // Carregar lista de or√ßamentos
        }
    }

    console.log(`‚úÖ Sub-tab ativa: ${targetId}`);
}

/**
 * Auto-login: Verifica se h√° credenciais salvas no localStorage
 */
async function checkAutoLogin(){
    const rememberData = localStorage.getItem('bioma_remember');

    if(!rememberData){
        return false; // Nenhum dado salvo
    }

    try{
        const data = JSON.parse(rememberData);
        const expiryDate = new Date(data.expiry);
        const now = new Date();

        // Verificar se expirou
        if(now > expiryDate){
            console.log('‚è∞ Login salvo expirou (> 7 dias)');
            localStorage.removeItem('bioma_remember');
            return false;
        }

        // Auto-preencher campos
        console.log('üîë Login salvo encontrado, preenchendo campos...');
        $('#loginUsername').value = data.username;
        $('#loginPassword').value = atob(data.password); // Decode Base64
        $('#rememberMe').checked = true;

        // Auto-login silencioso ap√≥s 500ms
        setTimeout(async () => {
            console.log('üöÄ Executando auto-login...');

            // MOSTRAR MODAL ANTES DE FAZER LOGIN
            Swal.fire({
                title: 'üîê Login Autom√°tico',
                html: '<p>Fazendo login...</p>',
                allowOutsideClick: false,
                allowEscapeKey: false,
                showConfirmButton: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            try {
                const username = data.username;
                const password = atob(data.password);

                console.log('üì° Enviando requisi√ß√£o de login...');
                const response = await API.post('/api/login', { username, password });
                console.log('üì• Resposta recebida:', response.success ? 'SUCCESS' : 'FAILED');

                if(response.success && response.user){
                    // Salvar sess√£o
                    sessionStorage.setItem('bioma_user', JSON.stringify(response.user));
                    console.log('üíæ Sess√£o salva no sessionStorage');

                    // Atualizar modal para sucesso
                    const userName = response.user.nome || response.user.username || 'Usu√°rio';
                    Swal.update({
                        icon: 'success',
                        title: 'üîê Login Autom√°tico',
                        html: `<p>Bem-vindo de volta, <strong>${userName}</strong>!</p><p style="color: #10B981;">Acessando o sistema...</p>`
                    });

                    // Iniciar app
                    setTimeout(async () => {
                        console.log('üéØ Iniciando app ap√≥s auto-login...');
                        await initApp(response.user);

                        // Fechar modal automaticamente ao entrar no sistema
                        Swal.close();
                        console.log('‚úÖ App inicializado - modal fechado!');
                    }, 1200);
                } else {
                    // Falha no auto-login: limpar dados salvos
                    console.warn('‚ö†Ô∏è Auto-login falhou:', response.message);
                    localStorage.removeItem('bioma_remember');
                    Swal.close();
                }
            } catch(error) {
                console.error('‚ùå Erro no auto-login:', error);
                localStorage.removeItem('bioma_remember');
                Swal.close();
            }
        }, 500);

        return true;
    }catch(err){
        console.error('Erro ao verificar auto-login:', err);
        localStorage.removeItem('bioma_remember');
        return false;
    }
}

document.addEventListener('DOMContentLoaded', async () => {
    console.log('%cüå≥ BIOMA v4.0 DEFINITIVO','background:#7C3AED;color:#fff;font-size:24px;padding:15px;border-radius:8px;font-weight:900');
    console.log('%c‚úÖ Sistema 100% Completo Carregado','color:#10B981;font-size:16px;font-weight:700');

    // Aplicar formata√ß√£o autom√°tica em todos os campos de CPF
    const cpfFields = [
        'orcCPF',
        'novoClienteCPF',
        'anamneseCPF',
        'prontuarioCPF',
        'novoProfCPF',
        'swal-cpf-cliente',
        'swal-cpf',
        'swal-cpf-assist'
    ];

    cpfFields.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            applyCPFFormatting(element);
        }
    });

    // Verificar auto-login primeiro
    const autoLoginAttempted = await checkAutoLogin();

    // Se n√£o tiver auto-login, verificar auth normal
    if(!autoLoginAttempted){
        checkAuth();
    }
});

async function checkAuth(){
    try{
        const res=await fetch('/api/current-user',{credentials:'include'});
        const data=await res.json();
        if(data.success&&data.user){
            currentUser=data.user;
            currentTheme=data.user.theme||'light';
            applyTheme(currentTheme);
            showApp();
            // CORRE√á√ÉO CR√çTICA: Inicializar app ap√≥s F5 quando usu√°rio j√° est√° logado
            await initApp(data.user);
        }else{
            showAuth();
        }
    }catch(e){
        console.error('‚ùå Auth error:',e);
        showAuth();
    }
}

function showAuth(){
    // SOLU√á√ÉO DO PDF: Limpar o tema do localStorage na tela de login
    localStorage.removeItem('theme');
    document.documentElement.setAttribute('data-theme', 'light');
    console.log('üåû Tela de login: light mode for√ßado (localStorage limpo)');

    document.getElementById('authScreen').style.display='flex';
    document.getElementById('app').style.display='none';
}

function showApp(){
    document.getElementById('authScreen').style.display='none';
    document.getElementById('app').style.display='block';
    loadConfiguracoes();
    // setTimeout(()=>{loadDashboard();},100); // Removido: duplicado com initApp()
}

function switchTab(tab){
    if(tab==='login'){
        document.getElementById('loginTab').classList.add('active');
        document.getElementById('registerTab').classList.remove('active');
        document.getElementById('loginForm').style.display='block';
        document.getElementById('registerForm').style.display='none';
    }else{
        document.getElementById('registerTab').classList.add('active');
        document.getElementById('loginTab').classList.remove('active');
        document.getElementById('registerForm').style.display='block';
        document.getElementById('loginForm').style.display='none';
    }
}

// ===== FUN√á√ïES ANTIGAS REMOVIDAS =====
// handleLogin(), handleRegister() e doLogout() foram movidas para o final do arquivo
// com implementa√ß√µes melhoradas (linhas 7882+)
// Remo√ß√£o feita para evitar duplica√ß√£o e vazamento de mensagens SweetAlert

function applyTheme(theme){
    // Aplicar tema em toda a aplica√ß√£o (login e app)
    document.documentElement.setAttribute('data-theme', theme);
    currentTheme = theme;

    // Salvar tema no localStorage
    localStorage.setItem('theme', theme);

    // Atualizar √≠cone do bot√£o de tema no LOGIN (authThemeIcon)
    const authThemeIcon = document.getElementById('authThemeIcon');
    if (authThemeIcon) {
        if (theme === 'dark') {
            authThemeIcon.className = 'bi bi-sun-fill';
        } else {
            authThemeIcon.className = 'bi bi-moon-stars-fill';
        }
    }

    // Atualizar √≠cone do bot√£o de tema no APP (themeIcon)
    const themeIcon = document.getElementById('themeIcon');
    const themeText = document.getElementById('themeText');

    if (themeIcon && themeText) {
        if (theme === 'dark') {
            themeIcon.className = 'bi bi-sun-fill';
            themeText.textContent = 'Modo Claro';
        } else {
            themeIcon.className = 'bi bi-moon-stars-fill';
            themeText.textContent = 'Modo Escuro';
        }
    }

    console.log(`üé® Tema aplicado: ${theme}`);
}

async function toggleTheme(){
    const newTheme=currentTheme==='light'?'dark':'light';
    applyTheme(newTheme);
    try{
        await fetch('/api/update-theme',{method:'POST',headers:{'Content-Type':'application/json'},credentials:'include',body:JSON.stringify({theme:newTheme})});
    }catch(e){
        console.error('‚ùå Theme error:',e);
    }
}

function goTo(section){
    const key = `goto-${section}`;

    // PROTE√á√ÉO ANTI-LOOP: N√£o navegar se j√° estiver navegando
    if (isLoading(key)) {
        console.warn(`‚ö†Ô∏è Navega√ß√£o em andamento: ${section}`);
        return;
    }

    console.log('üîÑ Navegando para:',section);
    setLoading(key, true);

    // Iniciar NProgress para feedback visual de carregamento
    NProgress.start();

    try{
        // Adicionar classe de transi√ß√£o
        const mainContent = document.querySelector('.main-content');
        if (mainContent) {
            mainContent.style.opacity = '0.5';
            mainContent.style.transition = 'opacity 0.3s ease';
        }
        
        // Aguardar um frame antes de trocar o conte√∫do
        requestAnimationFrame(() => {
            // 1. ESCONDER TODAS as se√ß√µes com anima√ß√£o suave
            document.querySelectorAll('.content-section').forEach(s => {
                if (s.classList.contains('active')) {
                    s.style.opacity = '0';
                    s.style.transform = 'translateY(20px)';
                    s.style.transition = 'opacity 0.2s ease, transform 0.2s ease';
                }
                
                setTimeout(() => {
                    s.classList.remove('active');
                    s.classList.add('d-none');
                    s.style.display = 'none';
                    s.style.visibility = 'hidden';
                    s.style.position = 'absolute';
                    s.style.left = '-9999px';
                    s.style.zIndex = '-1';
                }, 200);
            });

            // 2. MOSTRAR apenas a selecionada ap√≥s a anima√ß√£o de sa√≠da
            setTimeout(() => {
                const sectionElement=document.getElementById('section-'+section);
                if(sectionElement){
                    // Preparar para anima√ß√£o
                    sectionElement.style.opacity = '0';
                    sectionElement.style.transform = 'translateY(20px)';
                    
                    // Mostrar elemento
                    sectionElement.classList.add('active');
                    sectionElement.classList.remove('d-none');
                    sectionElement.style.display = 'block';
                    sectionElement.style.visibility = 'visible';
                    sectionElement.style.position = 'relative';
                    sectionElement.style.left = '0';
                    sectionElement.style.zIndex = '1';
                    
                    // Animar entrada
                    requestAnimationFrame(() => {
                        sectionElement.style.transition = 'opacity 0.4s ease, transform 0.4s ease';
                        sectionElement.style.opacity = '1';
                        sectionElement.style.transform = 'translateY(0)';
                    });
                    
                    // Restaurar opacidade do container principal
                    if (mainContent) {
                        mainContent.style.opacity = '1';
                    }
                } else {
                    console.error('‚ùå Se√ß√£o n√£o encontrada:', section);
                }

                // 3. ATUALIZAR menu sidebar com anima√ß√£o
                document.querySelectorAll('.sidebar-menu a').forEach(a => {
                    a.style.transition = 'all 0.3s ease';
                    a.classList.remove('active');
                });
                const menu=document.getElementById('menu-'+section);
                if(menu) {
                    menu.classList.add('active');
                    menu.style.animation = 'pulseMenu 0.4s ease';
                }

                // 4. SCROLL para topo suave
                const content=document.querySelector('.main-content');
                if(content)content.scrollTo({top:0,behavior:'smooth'});

                // 5. Limpar intervalo de refresh se estava em outra p√°gina
                if(filaRefreshInterval){
                    clearInterval(filaRefreshInterval);
                    filaRefreshInterval = null;
                }

                // 6. CARREGAR dados da se√ß√£o
                if(section==='dashboard')loadDashboard();
                else if(section==='clientes')loadClientes();
                else if(section==='profissionais')loadProfissionais();
                else if(section==='servicos')loadServicosLista();
                else if(section==='produtos')loadProdutosLista();
                else if(section==='consultar')loadConsultar();
                else if(section==='contratos')loadContratos();
                else if(section==='fila'){
                    loadFila();
                    // Iniciar auto-refresh da fila a cada 10 segundos
                    filaRefreshInterval = setInterval(() => {
                        console.log('üîÑ Auto-refresh da fila');
                        loadFila(true); // silent=true para n√£o mostrar erro
                    }, 10000);
                }
                else if(section==='sistema')verificarStatus();
                else if(section==='estoque')loadEstoque();
                else if(section==='configuracoes')loadConfiguracoes();
                else if(section==='agendamentos')loadAgendamentos();
                else if(section==='auditoria')loadAuditoria();
                else if(section==='clube')loadClube();
                else if(section==='comissoes')loadComissoes();
                else if(section==='relatorios')loadRelatorios();
                else if(section==='financeiro'){
                    carregarDadosFinanceiro();
                    carregarClientesParaFaturamento();
                }
            }, 250);
        });
    }catch(e){
        console.error('‚ùå Erro navega√ß√£o:',e);
    } finally {
        // Finalizar NProgress
        NProgress.done();

        // Resetar flag ap√≥s 1 segundo
        setTimeout(() => setLoading(key, false), 250);
    }

}

// Fun√ß√£o para alternar sub-tabs
function showSubTab(section, tab) {
    // Remove active de todos os bot√µes de sub-tab da se√ß√£o
    document.querySelectorAll(`#section-${section} .sub-tab-btn`).forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Remove active de todos os conte√∫dos de sub-tab da se√ß√£o
    document.querySelectorAll(`#section-${section} .sub-tab-content`).forEach(content => {
        content.classList.remove('active');
    });
    
    // Adiciona active no bot√£o clicado
    event.target.classList.add('active');
    
    // Adiciona active no conte√∫do correspondente
    const content = document.getElementById(`${section}-${tab}`);
    if (content) {
        content.classList.add('active');
        
        // Carrega dados espec√≠ficos da sub-tab se necess√°rio
        if (section === 'profissionais' && tab === 'comissoes') {
            carregarHistoricoComissoes();
        } else if (section === 'profissionais' && tab === 'assistentes') {
            loadAssistentes();
        } else if (section === 'clientes' && tab === 'faturamento') {
            carregarClientesParaFaturamento();
        }
    }
}

// ========== FUN√á√ÉO: CARREGAR HIST√ìRICO DE COMISS√ïES ==========
async function carregarHistoricoComissoes() {
    console.log('üí∞ Carregando hist√≥rico de comiss√µes...');

    try {
        // Verificar se elementos existem
        const tbodyProfissionais = document.getElementById('profissionais-comissoes');
        const tbodyFinanceiro = document.getElementById('comissoesPagarTableBody');

        if (!tbodyProfissionais && !tbodyFinanceiro) {
            console.warn('‚ö†Ô∏è Nenhum elemento tbody de comiss√µes encontrado');
            return;
        }

        // Mostrar loading spinner nos elementos ativos
        if (tbodyFinanceiro && tbodyFinanceiro.offsetParent !== null) {
            tbodyFinanceiro.innerHTML = '<tr><td colspan="6" class="text-center"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Carregando...</span></div></td></tr>';
        }

        const res = await fetch('/api/financeiro/comissoes', {credentials: 'include'});

        if (!res.ok) {
            console.error(`‚ùå Erro HTTP ao buscar comiss√µes: ${res.status}`);
            throw new Error(`Erro ${res.status}: Falha ao carregar comiss√µes`);
        }

        const data = await res.json();
        console.log('üì¶ Dados de comiss√µes recebidos:', { success: data.success, total: data.comissoes?.length });

        if (data.success && data.comissoes && data.comissoes.length > 0) {
            // HTML para tabela de Profissionais (5 colunas)
            if (tbodyProfissionais) {
                const htmlProfissionais = data.comissoes.map(c => {
                    try {
                        const data = c.data || c.data_registro || c.created_at;
                        const dataFormatada = data ? new Date(data).toLocaleDateString('pt-BR') : 'Data n√£o dispon√≠vel';
                        const valor = parseFloat(c.valor || c.comissao_valor || c.valor_comissao || 0);
                        const status = c.status || c.status_pagamento || 'Pendente';

                        return `
                            <tr>
                                <td><strong>${dataFormatada}</strong></td>
                                <td>${c.profissional_nome || c.profissional || 'Profissional n√£o identificado'}</td>
                                <td>${c.servico_nome || c.servico || 'N/A'}</td>
                                <td><strong>R$ ${valor.toFixed(2).replace('.', ',')}</strong></td>
                                <td><span class="badge ${status === 'Pago' || status === 'pago' ? 'success' : 'warning'}">${status}</span></td>
                            </tr>
                        `;
                    } catch (err) {
                        console.error('‚ö†Ô∏è Erro ao renderizar comiss√£o:', c, err);
                        return '';
                    }
                }).filter(html => html !== '').join('');

                tbodyProfissionais.innerHTML = htmlProfissionais || '<tr data-keep-visible="true"><td colspan="5" class="text-center text-muted">Erro ao processar comiss√µes</td></tr>';
            }

            // HTML para tabela de Financeiro (6 colunas - inclui Or√ßamento e A√ß√µes)
            if (tbodyFinanceiro) {
                const htmlFinanceiro = data.comissoes.map(c => {
                    try {
                        const data = c.data || c.data_registro || c.created_at;
                        const dataFormatada = data ? new Date(data).toLocaleDateString('pt-BR') : 'Data n√£o dispon√≠vel';
                        const valor = parseFloat(c.valor || c.comissao_valor || c.valor_comissao || 0);
                        const status = c.status || c.status_pagamento || 'Pendente';
                        const comissaoId = c._id || c.id || '';
                        const orcamentoNumero = c.orcamento_numero || c.orcamento_id || 'N/A';
                        const orcamentoDisplay = typeof orcamentoNumero === 'string' && orcamentoNumero.length > 6
                            ? orcamentoNumero.slice(-6)
                            : orcamentoNumero;

                        const isPago = status === 'Pago' || status === 'pago';

                        return `
                            <tr>
                                <td>${c.profissional_nome || c.profissional || 'Profissional n√£o identificado'}</td>
                                <td>#${orcamentoDisplay}</td>
                                <td><strong>${dataFormatada}</strong></td>
                                <td><strong style="color: var(--warning);">R$ ${valor.toFixed(2).replace('.', ',')}</strong></td>
                                <td><span class="badge ${isPago ? 'success' : 'warning'}">${status}</span></td>
                                <td>
                                    <button class="btn btn-sm ${isPago ? 'btn-outline-secondary' : 'btn-success'}"
                                            onclick="marcarComissaoPaga('${comissaoId}')"
                                            ${isPago ? 'disabled' : ''}
                                            title="${isPago ? 'Comiss√£o j√° paga' : 'Marcar como paga'}">
                                        <i class="bi ${isPago ? 'bi-check-circle-fill' : 'bi-check-circle'}"></i> ${isPago ? 'Pago' : 'Pagar'}
                                    </button>
                                </td>
                            </tr>
                        `;
                    } catch (err) {
                        console.error('‚ö†Ô∏è Erro ao renderizar comiss√£o para financeiro:', c, err);
                        return '';
                    }
                }).filter(html => html !== '').join('');

                tbodyFinanceiro.innerHTML = htmlFinanceiro || '<tr><td colspan="6" class="text-center text-warning">Erro ao processar comiss√µes</td></tr>';
            }

            console.log(`‚úÖ ${data.comissoes.length} comiss√µes carregadas e renderizadas`);
        } else {
            // Sem dados - exibir mensagem amig√°vel
            console.warn('‚ö†Ô∏è Nenhuma comiss√£o dispon√≠vel');

            if (tbodyProfissionais) {
                tbodyProfissionais.innerHTML = '<tr data-keep-visible="true"><td colspan="5" class="text-center text-muted"><i class="bi bi-inbox"></i> Nenhuma comiss√£o registrada</td></tr>';
            }
            if (tbodyFinanceiro) {
                tbodyFinanceiro.innerHTML = '<tr><td colspan="6" class="text-center text-muted"><i class="bi bi-inbox"></i> Nenhuma comiss√£o a pagar no momento</td></tr>';
            }
        }
    } catch (e) {
        console.error('‚ùå Erro ao carregar comiss√µes:', e);
        const tbodyProfissionais = document.getElementById('profissionais-comissoes');
        const tbodyFinanceiro = document.getElementById('comissoesPagarTableBody');

        if (tbodyProfissionais) {
            tbodyProfissionais.innerHTML = '<tr><td colspan="5" class="text-center text-danger"><i class="bi bi-exclamation-triangle"></i> Erro ao carregar comiss√µes</td></tr>';
        }
        if (tbodyFinanceiro) {
            tbodyFinanceiro.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center text-danger">
                        <i class="bi bi-exclamation-triangle"></i>
                        <strong>Erro ao carregar comiss√µes</strong><br>
                        <small>${e.message || 'Verifique sua conex√£o'}</small>
                    </td>
                </tr>
            `;
        }
    }
}

// ========== FUN√á√ÉO: MARCAR COMISS√ÉO COMO PAGA ==========
async function marcarComissaoPaga(comissaoId) {
    if (!comissaoId) {
        console.error('‚ùå ID de comiss√£o inv√°lido');
        mostrarNotificacao('error', 'ID de comiss√£o inv√°lido');
        return;
    }

    try {
        const result = await mostrarConfirmacao({
            title: 'Confirmar Pagamento',
            text: 'Deseja marcar esta comiss√£o como paga?',
            icon: 'question',
            confirmButtonText: '<i class="bi bi-check-circle"></i> Sim, Pagar',
            cancelButtonText: 'Cancelar',
            confirmButtonColor: 'var(--success)',
            cancelButtonColor: 'var(--danger)'
        });

        if (!result.isConfirmed) return;

        console.log(`üí∞ Marcando comiss√£o ${comissaoId} como paga...`);

        const res = await fetch(`/api/financeiro/comissoes/${comissaoId}/pagar`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ status: 'Pago', data_pagamento: new Date().toISOString() })
        });

        if (!res.ok) {
            const errorText = await res.text();
            console.error(`‚ùå Erro HTTP ao marcar comiss√£o: ${res.status}`, errorText);
            throw new Error(`Erro ${res.status}: ${errorText || 'Falha ao marcar comiss√£o como paga'}`);
        }

        const data = await res.json();

        if (data.success) {
            console.log('‚úÖ Comiss√£o marcada como paga');
            await mostrarNotificacao('success', 'Comiss√£o Paga!', 2000);

            // Recarregar lista de comiss√µes
            await carregarHistoricoComissoes();
        } else {
            throw new Error(data.message || 'Falha ao marcar comiss√£o');
        }
    } catch (error) {
        console.error('‚ùå Erro ao marcar comiss√£o como paga:', error);
        mostrarConfirmacao({
            icon: 'error',
            title: 'Erro ao Pagar Comiss√£o',
            html: `<p>${error.message || 'N√£o foi poss√≠vel marcar a comiss√£o como paga'}</p>
                   <small class="text-muted">Verifique o console para mais detalhes</small>`,
            confirmButtonText: 'OK',
            showCancelButton: false
        });
    }

}

// ========== FUN√á√ÉO: CARREGAR ASSISTENTES ==========
// Fun√ß√£o movida para evitar duplica√ß√£o - ver linha 10666

function filtrarTabelaPorTermo(tbodySelector, termo){
    const normalized = (termo || '').toLowerCase();
    document.querySelectorAll(`${tbodySelector} tr`).forEach(row => {
        if(row.dataset.keepVisible === 'true'){
            row.style.display = '';
            return;
        }
        const texto = row.textContent.toLowerCase();
        row.style.display = texto.includes(normalized) ? '' : 'none';
    });
}

function filtrarProfissionais(){
    const termo = document.getElementById('buscaProfissionais')?.value || '';
    filtrarTabelaPorTermo('#profissionaisBody', termo.trim());
}

function filtrarServicosLista(){
    const termo = document.getElementById('buscaServicos')?.value || '';
    filtrarTabelaPorTermo('#servicosListBody', termo.trim());
}

function filtrarProdutosLista(){
    const termo = document.getElementById('buscaProdutos')?.value || '';
    filtrarTabelaPorTermo('#produtosListBody', termo.trim());
}

function limparResultadosBuscaGlobal(){
    const container = document.getElementById('globalSearchResults');
    if(container){
        container.classList.remove('active');
        container.innerHTML = '';
    }
}

function buscarGlobal(termo){
    termo = (termo || '').trim();
    if(buscaGlobalTimer){
        clearTimeout(buscaGlobalTimer);
    }
    if(termo.length < 2){
        limparResultadosBuscaGlobal();
        return;
    }
    buscaGlobalTimer = setTimeout(()=>executarBuscaGlobal(), 280);
}

async function executarBuscaGlobal(){
    const input = document.getElementById('globalSearchInput');
    if(!input){
        return;
    }
    const termo = input.value.trim();
    if(buscaGlobalTimer){
        clearTimeout(buscaGlobalTimer);
        buscaGlobalTimer = null;
    }
    if(termo.length < 2){
        limparResultadosBuscaGlobal();
        return;
    }
    try{
        const response = await fetch(`/api/busca/global?termo=${encodeURIComponent(termo)}`, {credentials:'include'});
        const data = await response.json();
        if(data.success){
            renderResultadosBuscaGlobal(data.resultados || {});
        }
    }catch(error){
        console.error('Erro na busca global', error);
    }
}

function renderResultadosBuscaGlobal(resultados){
    const container = document.getElementById('globalSearchResults');
    if(!container){
        return;
    }
    const categorias = [
        {chave:'clientes', titulo:'Clientes'},
        {chave:'profissionais', titulo:'Profissionais'},
        {chave:'servicos', titulo:'Servi√ßos'},
        {chave:'produtos', titulo:'Produtos'},
        {chave:'orcamentos', titulo:'Contratos e Or√ßamentos'}
    ];
    let html = '';
    let total = 0;
    categorias.forEach(categoria => {
        const itens = resultados[categoria.chave] || [];
        if(itens.length){
            total += itens.length;
            const itensHtml = itens.map(item => `
                <div class="global-search-item" onclick="navegarResultadoGlobal('${categoria.chave}','${item.id}')">
                    <strong>${item.nome}</strong>
                    <span>${item.detalhe || ''}</span>
                </div>`).join('');
            html += `<div class="global-search-section"><h6>${categoria.titulo}</h6>${itensHtml}</div>`;
        }
    });
    if(total === 0){
        html = '<div class="text-muted" style="padding:12px;">Nenhum resultado encontrado</div>';
    }
    container.innerHTML = html;
    container.classList.add('active');
}

function navegarResultadoGlobal(tipo, id){
    limparResultadosBuscaGlobal();
    if(tipo === 'clientes'){
        goTo('clientes');
        setTimeout(()=>visualizarCliente(id), 250);
    }else if(tipo === 'profissionais'){
        goTo('profissionais');
        setTimeout(()=>destacarLinhaTabela('#profissionaisBody','id',id), 300);
    }else if(tipo === 'servicos'){
        goTo('servicos');
        setTimeout(()=>destacarLinhaTabela('#servicosListBody','id',id), 300);
    }else if(tipo === 'produtos'){
        goTo('produtos');
        setTimeout(()=>destacarLinhaTabela('#produtosListBody','id',id), 300);
    }else if(tipo === 'orcamentos'){
        goTo('consultar');
        setTimeout(()=>visualizarOrcamento(id), 350);
    }
}

function destacarLinhaTabela(tbodySelector, atributo, valor){
    const rows = document.querySelectorAll(`${tbodySelector} tr`);
    rows.forEach(row => {
        if(row.dataset[atributo] === valor){
            row.classList.add('highlight-row');
            row.scrollIntoView({behavior:'smooth', block:'center'});
            setTimeout(()=>row.classList.remove('highlight-row'), 2000);
        }
    });
}

async function loadEstoque(){
    const key = 'loadEstoque';

    // PROTE√á√ÉO ANTI-LOOP
    if (isLoading(key)) {
        console.warn(`‚ö†Ô∏è J√° carregando: ${key}`);
        return;
    }

    setLoading(key, true);

    try {
        await Promise.all([
            loadEstoqueResumo(),
            loadEstoquePendentes(),
            loadEstoqueMovimentos()
        ]);

        // Carregar gr√°ficos tamb√©m
        console.log('üìä Carregando gr√°ficos do estoque...');
        if (typeof Chart !== 'undefined') {
            // For√ßar carregamento dos gr√°ficos
            await loadEstoqueResumo(); // Chama novamente para garantir gr√°ficos
        }
    } finally {
        setTimeout(() => setLoading(key, false), 250);
    }
}

async function loadEstoqueResumo(){
    const key = 'loadEstoqueResumo';
    if (isLoading(key)) {
        console.warn(`‚ö†Ô∏è J√° carregando: ${key}`);
        return;
    }
    setLoading(key, true);

    try{
        // Buscar produtos
        const prodRes = await fetch('/api/produtos', {credentials: 'include'});
        const prodData = await prodRes.json();

        // Buscar movimenta√ß√µes do m√™s
        const hoje = new Date();
        const inicioMes = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
        const movRes = await fetch(`/api/estoque/movimentacoes?data_inicio=${inicioMes.toISOString()}&per_page=10000`, {credentials: 'include'});
        const movData = await movRes.json();

        if (prodData.success && prodData.produtos) {
            const produtos = prodData.produtos;

            // Total de produtos
            document.getElementById('totalProdutosEstoque').textContent = produtos.length;

            // Valor total em estoque
            const valorTotal = produtos.reduce((sum, p) => {
                return sum + ((p.preco || 0) * (p.estoque || 0));
            }, 0);
            document.getElementById('valorTotalEstoque').textContent = `R$ ${valorTotal.toFixed(2)}`;

            // Produtos abaixo do m√≠nimo
            const abaixoMinimo = produtos.filter(p => {
                const estoque = p.estoque || 0;
                const minimo = p.estoque_minimo || 0;
                return estoque < minimo && minimo > 0;
            }).length;
            document.getElementById('itensAbaixoMinimo').textContent = abaixoMinimo;
        }

        // Movimenta√ß√µes do m√™s
        if (movData.success && movData.movimentacoes) {
            document.getElementById('movimentacoesEstoque').textContent = movData.movimentacoes.length;

            // Criar gr√°fico de movimenta√ß√µes
            const entradas = movData.movimentacoes.filter(m => m.tipo === 'entrada').length;
            const saidas = movData.movimentacoes.filter(m => m.tipo === 'saida' || m.tipo === 'sa√≠da').length;

            const ctx = document.getElementById('chartEstoqueVisaoGeral');
            if (ctx && window.Chart) {
                if (window.chartEstoqueVisaoGeralInstance) {
                    window.chartEstoqueVisaoGeralInstance.destroy();
                }

                window.chartEstoqueVisaoGeralInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['Entradas', 'Sa√≠das'],
                        datasets: [{
                            label: 'Movimenta√ß√µes',
                            data: [entradas, saidas],
                            backgroundColor: [
                                'rgba(16, 185, 129, 0.7)',
                                'rgba(239, 68, 68, 0.7)'
                            ],
                            borderColor: [
                                'rgba(16, 185, 129, 1)',
                                'rgba(239, 68, 68, 1)'
                            ],
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    precision: 0
                                }
                            }
                        }
                    }
                });
            }
        }
    }catch(error){
        console.error('Erro ao carregar resumo de estoque', error);
    } finally {
        setTimeout(() => setLoading(key, false), 250);
    }
}

async function loadEstoquePendentes(){
    const key = 'loadEstoquePendentes';
    if (isLoading(key)) {
        console.warn(`‚ö†Ô∏è J√° carregando: ${key}`);
        return;
    }

    const tbody = document.getElementById('estoquePendentesBody');
    const container = document.getElementById('estoqueAprovacoesBody');

    if(!tbody && !container){
        return;
    }

    setLoading(key, true);

    try{
        const res = await fetch('/api/estoque/produtos/pendentes',{credentials:'include'});
        const data = await res.json();

        if(data.success && data.entradas && data.entradas.length){
            const html = data.entradas.map(item => `
                <tr data-id="${item._id}">
                    <td>${item.produto_nome || 'Produto'}</td>
                    <td>${item.quantidade}</td>
                    <td>${item.fornecedor || '-'}</td>
                    <td>${item.motivo || '-'}</td>
                    <td>${item.usuario || '-'}</td>
                    <td>
                        <button class="bioma-btn bioma-btn-sm bioma-btn-success" onclick="aprovarEntradaProduto('${item._id}')">
                            <i class="bi bi-check2-circle"></i> Aprovar
                        </button>
                        <button class="bioma-btn bioma-btn-sm bioma-btn-danger" onclick="rejeitarEntradaProduto('${item._id}')">
                            <i class="bi bi-x-circle"></i> Rejeitar
                        </button>
                    </td>
                </tr>`).join('');

            if(tbody) tbody.innerHTML = html;

            // Para a tab de aprova√ß√µes com cards
            if(container) {
                const cards = data.entradas.map(item => `
                    <div class="pending-stock-card">
                        <div class="product-info">
                            <h5>${item.produto_nome || 'Produto'}</h5>
                            <p>Quantidade: <strong>${item.quantidade}</strong></p>
                            <p>Fornecedor: ${item.fornecedor || '-'}</p>
                            <p>Motivo: ${item.motivo || '-'}</p>
                            <p class="text-muted">Solicitado por: ${item.usuario || '-'}</p>
                        </div>
                        <div class="approval-actions">
                            <button class="bioma-btn bioma-btn-success" onclick="aprovarEntradaProduto('${item._id}')">
                                <i class="bi bi-check2-circle"></i> Aprovar
                            </button>
                            <button class="bioma-btn bioma-btn-danger" onclick="rejeitarEntradaProduto('${item._id}')">
                                <i class="bi bi-x-circle"></i> Rejeitar
                            </button>
                        </div>
                    </div>
                `).join('');
                container.innerHTML = cards;
            }
        }else{
            const emptyMsg = '<tr><td colspan="6" class="text-center text-muted">Nenhuma entrada pendente</td></tr>';
            if(tbody) tbody.innerHTML = emptyMsg;
            if(container) container.innerHTML = '<p class="text-center text-muted">Nenhuma entrada pendente de aprova√ß√£o</p>';
        }
    }catch(error){
        console.error('Erro ao carregar pend√™ncias de estoque', error);
        const errorMsg = '<tr><td colspan="6" class="text-center text-muted">Erro ao carregar dados</td></tr>';
        if(tbody) tbody.innerHTML = errorMsg;
        if(container) container.innerHTML = '<p class="text-center text-danger">Erro ao carregar dados</p>';
    } finally {
        setTimeout(() => setLoading(key, false), 250);
    }
}

async function loadEstoqueMovimentos(){
    const key = 'loadEstoqueMovimentos';
    if (isLoading(key)) {
        console.warn(`‚ö†Ô∏è J√° carregando: ${key}`);
        return;
    }

    const tbody = document.getElementById('estoqueMovimentacoesBody');
    if(!tbody) return;

    setLoading(key, true);

    try {
        // Obter filtros
        const tipo = document.getElementById('filtroTipoMov')?.value || '';
        const dataInicio = document.getElementById('filtroDataInicioMov')?.value || '';
        const dataFim = document.getElementById('filtroDataFimMov')?.value || '';
        const perPage = document.getElementById('filtroPerPageMov')?.value || '50';
        const page = window.currentPageMov || 1;

        // Construir URL com par√¢metros
        let url = `/api/estoque/movimentacoes?page=${page}&per_page=${perPage}`;
        if (tipo) url += `&tipo=${tipo}`;
        if (dataInicio) url += `&data_inicio=${dataInicio}`;
        if (dataFim) url += `&data_fim=${dataFim}`;

        const res = await fetch(url, {credentials: 'include'});
        const data = await res.json();

        if (data.success && data.movimentacoes && data.movimentacoes.length) {
            tbody.innerHTML = data.movimentacoes.map(item => `
                <tr>
                    <td>${formatarDataHora(item.data)}</td>
                    <td><span class="badge ${item.tipo === 'entrada' ? 'success' : 'danger'}">${item.tipo || '-'}</span></td>
                    <td>${item.produto_nome || item.produto_id || '-'}</td>
                    <td>${item.quantidade || 0}</td>
                    <td>${item.motivo || '-'}</td>
                    <td>${item.usuario || '-'}</td>
                    <td>${item.nota_fiscal || '-'}</td>
                </tr>`).join('');

            // Atualizar pagina√ß√£o
            if (data.pagination) {
                window.totalPagesMov = data.pagination.total_pages;
                window.currentPageMov = data.pagination.page;

                const paginacaoDiv = document.getElementById('paginacaoMovimentacoes');
                const infoPagina = document.getElementById('infoPaginaMov');

                if (paginacaoDiv && infoPagina) {
                    paginacaoDiv.style.display = 'flex';
                    infoPagina.textContent = `P√°gina ${data.pagination.page} de ${data.pagination.total_pages} (Total: ${data.pagination.total} registros)`;
                }
            }
        } else {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">Nenhuma movimenta√ß√£o registrada</td></tr>';
            document.getElementById('paginacaoMovimentacoes')?.style.setProperty('display', 'none', 'important');
        }
    } catch (error) {
        console.error('Erro ao carregar movimenta√ß√µes', error);
        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-danger">Erro ao carregar dados</td></tr>';
    } finally {
        setTimeout(() => setLoading(key, false), 250);
    }
}

// Fun√ß√£o para mudar p√°gina de movimenta√ß√µes
function mudarPaginaMov(direcao) {
    const currentPage = window.currentPageMov || 1;
    const totalPages = window.totalPagesMov || 1;
    
    let newPage = currentPage + direcao;
    if (newPage < 1) newPage = 1;
    if (newPage > totalPages) newPage = totalPages;
    
    window.currentPageMov = newPage;
    loadEstoqueMovimentos();
}

// Fun√ß√£o para gerar relat√≥rio de estoque
async function gerarRelatorioEstoque() {
    const dataInicio = document.getElementById('relatorioDataInicio')?.value || '';
    const dataFim = document.getElementById('relatorioDataFim')?.value || '';
    
    try {
        let url = '/api/estoque/relatorio?';
        if (dataInicio) url += `data_inicio=${dataInicio}&`;
        if (dataFim) url += `data_fim=${dataFim}&`;
        
        const res = await fetch(url, {credentials: 'include'});
        const data = await res.json();
        
        if (data.success && data.relatorio) {
            const rel = data.relatorio;
            
            // Atualizar cards
            document.getElementById('relTotalProdutos').textContent = rel.total_produtos || 0;
            document.getElementById('relValorEstoque').textContent = formatarMoeda(rel.valor_total_estoque);
            document.getElementById('relSemEstoque').textContent = rel.produtos_sem_estoque || 0;
            
            // Top produtos
            const topProdutosBody = document.getElementById('relTopProdutos');
            if (rel.mais_movimentados && rel.mais_movimentados.length > 0) {
                topProdutosBody.innerHTML = rel.mais_movimentados.map(p => `
                    <tr>
                        <td>${p.produto_nome || 'N/A'}</td>
                        <td>${p.total_movimentacoes || 0}</td>
                        <td>${p.total_quantidade || 0}</td>
                    </tr>
                `).join('');
            } else {
                topProdutosBody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">Sem dados</td></tr>';
            }
            
            // √öltimas movimenta√ß√µes
            const ultimasMovBody = document.getElementById('relUltimasMovimentacoes');
            if (rel.ultimas_movimentacoes && rel.ultimas_movimentacoes.length > 0) {
                ultimasMovBody.innerHTML = rel.ultimas_movimentacoes.map(m => `
                    <tr>
                        <td>${formatarDataHora(m.data)}</td>
                        <td><span class="badge ${m.tipo === 'entrada' ? 'success' : 'danger'}">${m.tipo}</span></td>
                        <td>${m.quantidade || 0}</td>
                    </tr>
                `).join('');
            } else {
                ultimasMovBody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">Sem dados</td></tr>';
            }
            
            // Mostrar container de resultados
            document.getElementById('relatorioEstoqueContainer').style.display = 'block';
            
            if (window.Swal) {
                Swal.fire({
                    icon: 'success',
                    title: 'Relat√≥rio Gerado!',
                    text: 'Relat√≥rio gerado com sucesso',
                    timer: 2000,
                    showConfirmButton: false
                });
            }
        }
    } catch (error) {
        console.error('Erro ao gerar relat√≥rio:', error);
        if (window.Swal) {
            Swal.fire({
                icon: 'error',
                title: 'Erro',
                text: 'Erro ao gerar relat√≥rio de estoque'
            });
        }
    }
}

// Fun√ß√£o para exportar relat√≥rio em Excel
function exportarRelatorioExcel() {
    const dataInicio = document.getElementById('relatorioDataInicio')?.value || '';
    const dataFim = document.getElementById('relatorioDataFim')?.value || '';
    
    let url = '/api/estoque/relatorio?formato=excel';
    if (dataInicio) url += `&data_inicio=${dataInicio}`;
    if (dataFim) url += `&data_fim=${dataFim}`;
    
    window.open(url, '_blank');
    
    if (window.Swal) {
        Swal.fire({
            icon: 'success',
            title: 'Download Iniciado!',
            text: 'O arquivo Excel ser√° baixado em instantes',
            timer: 2000,
            showConfirmButton: false
        });
    }
}

function formatarMoeda(valor){
    return 'R$ ' + Number(valor || 0).toLocaleString('pt-BR',{minimumFractionDigits:2, maximumFractionDigits:2});
}

function formatarDataHora(valor){
    if(!valor){
        return '-';
    }
    const data = new Date(valor);
    if(Number.isNaN(data.getTime())){
        return '-';
    }
    return data.toLocaleString('pt-BR');
}

async function ensureProdutosCache(){
    if(produtosDisponiveis.length){
        produtosCache = produtosDisponiveis;
        return produtosCache;
    }
    if(!produtosCache.length){
        try{
            const res = await fetch('/api/produtos',{credentials:'include'});
            const data = await res.json();
            if(data.success && data.produtos){
                produtosCache = data.produtos;
            }
        }catch(error){
            console.error('Erro ao carregar produtos para estoque', error);
        }
    }
    return produtosCache;
}

async function abrirEntradaEstoque(){
    try{
        const produtos = await ensureProdutosCache();
        if(!produtos.length){
            Swal.fire('Aviso','Cadastre produtos antes de registrar entradas.','info');
            return;
        }
        const options = produtos.map(p=>`<option value="${p._id}">${p.nome}${p.sku ? ` - ${p.sku}` : ''} (Estoque: ${p.estoque || 0})</option>`).join('');
        const { value } = await Swal.fire({
            title:'Registrar entrada',
            html:`<div class="text-start">
                    <label class="form-label">Produto</label>
                    <select id="entradaProduto" class="form-select">${options}</select>
                    <label class="form-label mt-3">Quantidade</label>
                    <input type="number" id="entradaQuantidade" min="1" value="1" class="form-control">
                    <label class="form-label mt-3">Custo unit√°rio (opcional)</label>
                    <input type="number" id="entradaCusto" step="0.01" class="form-control">
                    <label class="form-label mt-3">Fornecedor</label>
                    <input type="text" id="entradaFornecedor" class="form-control">
                    <label class="form-label mt-3">Nota fiscal</label>
                    <input type="text" id="entradaNota" class="form-control">
                    <label class="form-label mt-3">Motivo</label>
                    <textarea id="entradaMotivo" class="form-control" rows="2">Reposi√ß√£o de estoque</textarea>
                </div>`,
            showCancelButton:true,
            confirmButtonText:'Registrar',
            cancelButtonText:'Cancelar',
            preConfirm:()=>{
                const produto = document.getElementById('entradaProduto').value;
                const quantidade = Number(document.getElementById('entradaQuantidade').value);
                if(!produto || quantidade <= 0){
                    Swal.showValidationMessage('Informe o produto e uma quantidade v√°lida');
                    return false;
                }
                return {
                    produto_id: produto,
                    quantidade: quantidade,
                    custo_unitario: Number(document.getElementById('entradaCusto').value || 0),
                    fornecedor: document.getElementById('entradaFornecedor').value.trim(),
                    nota_fiscal: document.getElementById('entradaNota').value.trim(),
                    motivo: document.getElementById('entradaMotivo').value.trim() || 'Reposi√ß√£o de estoque'
                };
            }
        });
        if(value){
            const res = await fetch('/api/estoque/entrada',{
                method:'POST',
                headers:{'Content-Type':'application/json'},
                credentials:'include',
                body:JSON.stringify(value)
            });
            const data = await res.json();
            if(data.success){
                mostrarNotificacao('success', data.message || 'Entrada registrada e aguardando aprova√ß√£o.');
                loadEstoque();
            }else{
                throw new Error(data.message || 'N√£o foi poss√≠vel registrar a entrada');
            }
        }
    }catch(error){
        console.error('Erro ao registrar entrada', error);
        mostrarNotificacao('error', 'N√£o foi poss√≠vel registrar a entrada.');
    }
}

async function abrirSaidaEstoque(){
    try{
        const produtos = await ensureProdutosCache();
        if(!produtos.length){
            mostrarNotificacao('info', 'Cadastre produtos antes de registrar sa√≠das.', 3000);
            return;
        }
        const options = produtos.map(p=>`<option value="${p._id}">${p.nome}${p.sku ? ` - ${p.sku}` : ''} (Estoque: ${p.estoque || 0})</option>`).join('');
        const { value } = await Swal.fire({
            title:'Registrar sa√≠da',
            html:`<div class="text-start">
                    <label class="form-label">Produto</label>
                    <select id="saidaProduto" class="form-select">${options}</select>
                    <label class="form-label mt-3">Quantidade</label>
                    <input type="number" id="saidaQuantidade" min="1" value="1" class="form-control">
                    <label class="form-label mt-3">Motivo</label>
                    <textarea id="saidaMotivo" class="form-control" rows="2">Consumo interno</textarea>
                </div>`,
            showCancelButton:true,
            confirmButtonText:'Registrar',
            cancelButtonText:'Cancelar',
            preConfirm:()=>{
                const produto = document.getElementById('saidaProduto').value;
                const quantidade = Number(document.getElementById('saidaQuantidade').value);
                if(!produto || quantidade <= 0){
                    Swal.showValidationMessage('Informe o produto e uma quantidade v√°lida');
                    return false;
                }
                return {
                    produto_id: produto,
                    quantidade: quantidade,
                    motivo: document.getElementById('saidaMotivo').value.trim() || 'Sa√≠da manual'
                };
            }
        });
        if(value){
            const res = await fetch('/api/estoque/saida',{
                method:'POST',
                headers:{'Content-Type':'application/json'},
                credentials:'include',
                body:JSON.stringify(value)
            });
            const data = await res.json();
            if(data.success){
                mostrarNotificacao('success', data.message || 'Sa√≠da registrada com sucesso.');
                loadEstoque();
            }else{
                throw new Error(data.message || 'N√£o foi poss√≠vel registrar a sa√≠da');
            }
        }
    }catch(error){
        console.error('Erro ao registrar sa√≠da', error);
        mostrarNotificacao('error', 'N√£o foi poss√≠vel registrar a sa√≠da.');
    }
}

async function aprovarEntradaEstoque(id){
    try{
        const res = await fetch(`/api/estoque/entrada/${id}/aprovar`,{method:'POST',credentials:'include'});
        const data = await res.json();
        if(data.success){
            mostrarNotificacao('success', 'Entrada aprovada! Estoque atualizado com sucesso.');
            loadEstoque();
        }else{
            throw new Error(data.message || 'N√£o foi poss√≠vel aprovar a entrada');
        }
    }catch(error){
        console.error('Erro ao aprovar entrada', error);
        mostrarNotificacao('error', 'N√£o foi poss√≠vel aprovar a entrada.');
    }
}

async function rejeitarEntradaEstoque(id){
    const { value: motivo } = await Swal.fire({
        title:'Rejeitar entrada',
        input:'textarea',
        inputLabel:'Informe o motivo',
        inputPlaceholder:'Motivo da rejei√ß√£o',
        showCancelButton:true,
        confirmButtonText:'Rejeitar',
        cancelButtonText:'Cancelar',
        inputValidator:value=>!value && 'Informe o motivo'
    });
    if(!motivo){ return; }
    try{
        const res = await fetch(`/api/estoque/entrada/${id}/rejeitar`,{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            credentials:'include',
            body:JSON.stringify({motivo})
        });
        const data = await res.json();
        if(data.success){
            mostrarNotificacao('info', 'Entrada rejeitada - Registro atualizado.');
            loadEstoque();
        }else{
            throw new Error(data.message || 'N√£o foi poss√≠vel rejeitar');
        }
    }catch(error){
        console.error('Erro ao rejeitar entrada', error);
        mostrarNotificacao('error', 'N√£o foi poss√≠vel rejeitar a entrada.');
    }
}

async function importarPlanilhaEstoque(input){
    const file = input.files?.[0];
    if(!file){
        return;
    }

    let cancelarProcesso = false;

    // Mostrar modal de progresso com Spinkit spinner
    Swal.fire({
        title: '<span class="animate__animated animate__fadeInDown">Importando Estoque...</span>',
        html: `
            <div class="mb-4 animate__animated animate__fadeIn animate__faster">
                <!-- Spinkit Chase Spinner -->
                <div class="sk-chase" style="margin: 20px auto;">
                    <div class="sk-chase-dot"></div>
                    <div class="sk-chase-dot"></div>
                    <div class="sk-chase-dot"></div>
                    <div class="sk-chase-dot"></div>
                    <div class="sk-chase-dot"></div>
                    <div class="sk-chase-dot"></div>
                </div>
            </div>
            <div class="mb-3">
                <div class="progress" style="height: 25px;">
                    <div id="barra-progresso-importacao" class="progress-bar progress-bar-striped progress-bar-animated bg-info"
                         role="progressbar" style="width: 0%">0%</div>
                </div>
            </div>
            <div class="text-start">
                <p><strong>üìÅ Arquivo:</strong> ${file.name}</p>
                <p><strong>‚öôÔ∏è Status:</strong> <span id="status-importacao">Enviando arquivo...</span></p>
                <p id="resultado-importacao" style="display: none;"></p>
            </div>
        `,
        allowOutsideClick: false,
        showConfirmButton: true,
        confirmButtonText: 'OK',
        showCancelButton: true,
        showCloseButton: true,
        cancelButtonText: '<i class="bi bi-x-circle"></i> Cancelar Importa√ß√£o',
        cancelButtonColor: '#dc3545',
        didOpen: () => {
            const confirmBtn = Swal.getConfirmButton();
            const cancelBtn = Swal.getCancelButton();

            // Esconder bot√£o OK inicialmente (ser√° mostrado ap√≥s conclus√£o)
            if (confirmBtn) {
                confirmBtn.style.display = 'none';
            }

            if (cancelBtn) {
                cancelBtn.onclick = () => {
                    cancelarProcesso = true;
                    cancelBtn.disabled = true;
                    cancelBtn.innerHTML = '<i class="bi bi-hourglass"></i> Cancelando...';
                    cancelBtn.style.backgroundColor = '#6c757d';
                };
            }

            // Simular progresso
            let progresso = 0;
            const intervalo = setInterval(() => {
                if (cancelarProcesso || progresso >= 90) {
                    clearInterval(intervalo);
                    return;
                }
                progresso += 10;
                const barra = document.getElementById('barra-progresso-importacao');
                if (barra) {
                    barra.style.width = `${progresso}%`;
                    barra.textContent = `${progresso}%`;
                }
            }, 300);
        }
    });

    const formData = new FormData();
    formData.append('file', file);
    formData.append('tipo', 'estoque');

    try{
        if (cancelarProcesso) {
            throw new Error('Importa√ß√£o cancelada pelo usu√°rio');
        }

        // Aguardar um pouco para garantir que o modal foi renderizado
        await new Promise(resolve => setTimeout(resolve, 100));

        const statusImportacao = document.getElementById('status-importacao');
        if (statusImportacao) {
            statusImportacao.textContent = 'Processando arquivo...';
        }

        const res = await fetch('/api/estoque/importar',{
            method:'POST',
            credentials:'include',
            body:formData
        });

        if (cancelarProcesso) {
            throw new Error('Importa√ß√£o cancelada pelo usu√°rio');
        }

        const data = await res.json();

        // Atualizar barra para 100%
        const barra = document.getElementById('barra-progresso-importacao');
        if (barra) {
            barra.style.width = '100%';
            barra.textContent = '100%';
            barra.classList.remove('bg-info');
            barra.classList.add(data.success ? 'bg-success' : 'bg-danger');
        }

        if(data.success){
            const statusSuccess = document.getElementById('status-importacao');
            if (statusSuccess) {
                statusSuccess.textContent = '‚úÖ Importa√ß√£o conclu√≠da!';
            }
            const resultadoImportacao = document.getElementById('resultado-importacao');
            if (resultadoImportacao) {
                resultadoImportacao.style.display = 'block';
                resultadoImportacao.innerHTML = `
                    <p class="text-success"><strong>‚úÖ Importados:</strong> ${data.importados || 0}</p>
                    ${data.erros > 0 ? `<p class="text-danger"><strong>‚ùå Falhas:</strong> ${data.erros}</p>` : ''}
                `;
            }

            // Mostrar bot√£o OK
            const confirmBtn = Swal.getConfirmButton();
            const cancelBtn = Swal.getCancelButton();
            if (confirmBtn) {
                confirmBtn.style.display = 'inline-block';
                confirmBtn.textContent = 'OK';
                confirmBtn.style.backgroundColor = '#3085d6';
            }
            if (cancelBtn) cancelBtn.style.display = 'none';

            await loadEstoque();
        }else{
            throw new Error(data.message || 'Erro ao importar arquivo');
        }
    }catch(error){
        console.error('Erro ao importar estoque', error);

        const barra = document.getElementById('barra-progresso-importacao');
        if (barra) {
            barra.classList.remove('bg-info');
            barra.classList.add('bg-danger');
        }

        const statusError = document.getElementById('status-importacao');
        if (statusError) {
            statusError.textContent = '‚ùå Erro na importa√ß√£o';
        }

        const resultadoError = document.getElementById('resultado-importacao');
        if (resultadoError) {
            resultadoError.style.display = 'block';
            resultadoError.innerHTML = `
                <p class="text-danger"><strong>Motivo:</strong> ${error.message || 'Erro desconhecido'}</p>
            `;
        }

        // Mostrar bot√£o OK
        const confirmBtn = Swal.getConfirmButton();
        const cancelBtn = Swal.getCancelButton();
        if (confirmBtn) {
            confirmBtn.style.display = 'inline-block';
            confirmBtn.textContent = 'Fechar';
            confirmBtn.style.backgroundColor = '#dc3545';
        }
        if (cancelBtn) cancelBtn.style.display = 'none';
    }finally{
        input.value='';
    }
}

function exportarEstoque(){
    window.open('/api/estoque/exportar','_blank');
}

function atualizarPreviewLogo(tipo, url){
    const previewId = tipo === 'login' ? 'logoLoginPreview' : 'logoPrincipalPreview';
    const preview = document.getElementById(previewId);
    if(!preview){
        return;
    }
    preview.innerHTML = '';
    if(url){
        const img = document.createElement('img');
        img.src = url;
        preview.appendChild(img);
    }else{
        preview.innerHTML = '<span class="text-muted">Selecione uma imagem</span>';
    }
}

function aplicarLogosNaInterface(){
    const sidebarLogo = document.querySelector('.sidebar-logo');
    if(!sidebarLogo){
        console.warn('‚ö†Ô∏è .sidebar-logo n√£o encontrado');
        return;
    }
    let img = document.getElementById('sidebarLogoImage');
    const h1 = sidebarLogo.querySelector('h1');
    const p = sidebarLogo.querySelector('p');

    if(logosPersonalizados.principal){
        console.log('üñºÔ∏è Aplicando logo personalizado:', logosPersonalizados.principal);

        if(!img){
            img = document.createElement('img');
            img.id = 'sidebarLogoImage';
            img.alt = 'Logo Personalizado';
            sidebarLogo.prepend(img);
        }

        img.src = logosPersonalizados.principal;

        // Adicionar classe para esconder texto via CSS
        sidebarLogo.classList.add('has-custom-logo');

        // Log de sucesso
        img.onload = () => {
            console.log('‚úÖ Logo carregado com sucesso!');
        };

        img.onerror = () => {
            console.error('‚ùå Erro ao carregar logo');
            sidebarLogo.classList.remove('has-custom-logo');
        };
    }else{
        console.log('üìù Usando texto padr√£o (sem logo personalizado)');

        if(img) img.remove();

        // Remover classe para mostrar texto
        sidebarLogo.classList.remove('has-custom-logo');
    }
    let authImg = document.getElementById('authLogoCustom');
    if(!authImg){
        authImg = document.createElement('img');
        authImg.id = 'authLogoCustom';
        authImg.style.display='none';
        authImg.style.maxHeight='120px';
        authImg.style.margin='0 auto 20px';
        const authLogoContainer = document.querySelector('.auth-logo');
        if(authLogoContainer){
            authLogoContainer.insertBefore(authImg, authLogoContainer.firstChild);
        }
    }
    const iconLogo = document.querySelector('.auth-logo .logo-icon');
    if(logosPersonalizados.login){
        authImg.src = logosPersonalizados.login;
        authImg.style.display='block';
        if(iconLogo){ iconLogo.style.display='none'; }
    }else{
        authImg.style.display='none';
        if(iconLogo){ iconLogo.style.display='block'; }
    }
}

async function loadConfiguracoes(force=false){
    const key = 'loadConfiguracoes';

    if(!force && configuracoesAtuais){
        aplicarLogosNaInterface();
        return configuracoesAtuais;
    }

    if (isLoading(key)) {
        console.warn(`‚ö†Ô∏è J√° carregando: ${key}`);
        return;
    }
    setLoading(key, true);

    try{
        const res = await fetch('/api/config',{credentials:'include'});
        const data = await res.json();
        if(data.success && data.config){
            configuracoesAtuais = data.config;
            document.getElementById('cfgNome').value = configuracoesAtuais.nome_empresa || '';
            document.getElementById('cfgCNPJ').value = configuracoesAtuais.cnpj || '';
            document.getElementById('cfgEndereco').value = configuracoesAtuais.endereco || '';
            document.getElementById('cfgTelefone').value = configuracoesAtuais.telefone || '';
            document.getElementById('cfgEmail').value = configuracoesAtuais.email || '';
            logosPersonalizados.principal = configuracoesAtuais.logo_url || null;
            logosPersonalizados.login = configuracoesAtuais.logo_login_url || null;
            atualizarPreviewLogo('principal', logosPersonalizados.principal);
            atualizarPreviewLogo('login', logosPersonalizados.login);
            aplicarLogosNaInterface();
        }
    }catch(error){
        console.error('Erro ao carregar configura√ß√µes', error);
    } finally {
        setTimeout(() => setLoading(key, false), 250);
    }
    return configuracoesAtuais;
}

async function abrirUploadLogo(tipo){
    const tipoLabel = tipo === 'login' ? 'Logo de Login' : 'Logo Principal do Sistema';

    const {value: file} = await Swal.fire({
        title: `Upload de ${tipoLabel}`,
        html: `
            <div style="text-align:center;padding:20px;">
                <label for="logoInput" style="cursor:pointer;display:block;margin-bottom:15px;">
                    <div id="logoUploadArea" style="width:200px;height:140px;margin:0 auto;border:3px dashed var(--primary);border-radius:15px;display:flex;align-items:center;justify-content:center;background:var(--bg-main);transition:all 0.3s;position:relative;overflow:hidden;">
                        <i class="bi bi-image" id="logoIcon" style="font-size:4rem;color:var(--primary);"></i>
                        <img id="logoPreview" style="display:none;max-width:100%;max-height:100%;object-fit:contain;padding:10px;">
                    </div>
                    <p style="margin-top:15px;color:var(--text-secondary);font-weight:600;">
                        <i class="bi bi-cloud-upload"></i> Clique para selecionar logo
                    </p>
                </label>
                <input type="file" id="logoInput" accept="image/jpeg,image/jpg,image/png,image/webp" style="display:none;">
                <div id="logoFileInfo" style="display:none;margin-top:15px;padding:15px;background:var(--bg-secondary);border-radius:10px;text-align:left;">
                    <p style="margin:5px 0;color:var(--text-primary);"><strong><i class="bi bi-file-earmark-image"></i> Arquivo:</strong> <span id="logoFileName"></span></p>
                    <p style="margin:5px 0;color:var(--text-primary);"><strong><i class="bi bi-hdd"></i> Tamanho:</strong> <span id="logoFileSize"></span></p>
                    <p style="margin:5px 0;color:var(--text-primary);"><strong><i class="bi bi-filetype-jpg"></i> Tipo:</strong> <span id="logoFileType"></span></p>
                </div>
                <p style="margin-top:15px;font-size:0.85rem;color:var(--text-muted);">
                    <i class="bi bi-info-circle"></i> Formatos: PNG, JPG, WebP | M√°ximo: 2MB<br>
                    <span style="font-size:0.8rem;">Recomendado: fundo transparente (PNG)</span>
                </p>
            </div>
        `,
        width: '550px',
        showCancelButton: true,
        confirmButtonText: '<i class="bi bi-upload"></i> Enviar Logo',
        cancelButtonText: '<i class="bi bi-x-circle"></i> Cancelar',
        confirmButtonColor: '#3B82F6',
        cancelButtonColor: '#6c757d',
        didOpen: () => {
            const input = document.getElementById('logoInput');
            const uploadArea = document.getElementById('logoUploadArea');

            // Click no label
            uploadArea.parentElement.addEventListener('click', () => input.click());

            // Preview e valida√ß√£o ao selecionar
            input.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;

                // Validar imagem (logos = 2MB m√°ximo)
                const validation = validarImagemUpload(file, {
                    maxSizeMB: 2,
                    allowedTypes: ['image/jpeg', 'image/jpg', 'image/png', 'image/webp']
                });

                if (!validation.valid) {
                    Swal.showValidationMessage(validation.error);
                    input.value = '';
                    return;
                }

                // Mostrar preview
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('logoIcon').style.display = 'none';
                    const preview = document.getElementById('logoPreview');
                    preview.src = e.target.result;
                    preview.style.display = 'block';

                    // Mostrar info do arquivo
                    document.getElementById('logoFileName').textContent = validation.fileInfo.name;
                    document.getElementById('logoFileSize').textContent = validation.fileInfo.size;
                    document.getElementById('logoFileType').textContent = validation.fileInfo.type;
                    document.getElementById('logoFileInfo').style.display = 'block';
                };
                reader.readAsDataURL(file);
            });
        },
        preConfirm: () => {
            const fileInput = document.getElementById('logoInput');
            if (!fileInput.files || fileInput.files.length === 0) {
                Swal.showValidationMessage('Selecione uma imagem primeiro');
                return false;
            }

            // Validar novamente
            const validation = validarImagemUpload(fileInput.files[0], {
                maxSizeMB: 2,
                allowedTypes: ['image/jpeg', 'image/jpg', 'image/png', 'image/webp']
            });
            if (!validation.valid) {
                Swal.showValidationMessage(validation.error);
                return false;
            }

            return fileInput.files[0];
        }
    });

    if (file) {
        await processarUploadLogo(file, tipo);
    }
}

async function processarUploadLogo(file, tipo){
    const reader = new FileReader();

    reader.onload = async () => {
        try{
            // Modal com progress
            Swal.fire({
                title: 'Enviando Logo...',
                html: `
                    <div style="padding:20px;">
                        <div style="margin-bottom:15px;">
                            <div style="width:100%;height:30px;background:var(--bg-secondary);border-radius:15px;overflow:hidden;">
                                <div id="logoProgressBar" style="width:0%;height:100%;background:linear-gradient(90deg,#3B82F6,#2563EB);transition:width 0.3s;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:0.9rem;"></div>
                            </div>
                        </div>
                        <p id="logoProgressText" style="color:var(--text-secondary);margin-top:10px;">Processando imagem...</p>
                    </div>
                `,
                allowOutsideClick: false,
                showConfirmButton: false
            });

            // Simular progresso (j√° que √© base64)
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += 10;
                const bar = document.getElementById('logoProgressBar');
                const text = document.getElementById('logoProgressText');
                if (bar) {
                    bar.style.width = progress + '%';
                    bar.textContent = progress + '%';
                }
                if (text && progress < 80) {
                    text.textContent = 'Enviando logo...';
                }
                if (progress >= 90) clearInterval(progressInterval);
            }, 100);

            const res = await fetch('/api/upload/imagem',{
                method:'POST',
                headers:{'Content-Type':'application/json'},
                credentials:'include',
                body:JSON.stringify({image_data: reader.result, tipo: tipo === 'login' ? 'logo_login' : 'logo'})
            });

            clearInterval(progressInterval);

            const data = await res.json();
            if(data.success){
                const url = data.data_url || data.url;
                if(tipo === 'login'){
                    logosPersonalizados.login = url;
                }else{
                    logosPersonalizados.principal = url;
                }
                atualizarPreviewLogo(tipo, url);
                aplicarLogosNaInterface();

                Swal.fire({
                    icon: 'success',
                    title: 'Logo Atualizada!',
                    text: `${tipo === 'login' ? 'Logo de login' : 'Logo principal'} foi atualizada com sucesso`,
                    timer: 2000,
                    showConfirmButton: false
                });
            }else{
                throw new Error(data.message || 'Erro ao enviar imagem');
            }
        }catch(error){
            console.error('Erro ao processar logo', error);
            mostrarNotificacao('error', 'N√£o foi poss√≠vel enviar a logo. Tente novamente.');
        }
    };

    reader.readAsDataURL(file);
}

function removerLogo(tipo){
    if(tipo === 'login'){
        logosPersonalizados.login = null;
    }else{
        logosPersonalizados.principal = null;
    }
    atualizarPreviewLogo(tipo, null);
    aplicarLogosNaInterface();
}

function abrirComunidadeDetalhe(tipo){
    const mensagens = {
        conexao: {titulo:'Plano Conex√£o VIP', descricao:'Programa pensado para clientes recorrentes com foco em alta performance e personaliza√ß√£o total.'},
        workshops: {titulo:'Workshops BIOMA', descricao:'Inscri√ß√µes abertas para capacita√ß√µes em neurovendas, gest√£o de agenda inteligente e protocolos de alopecia.'},
        cases: {titulo:'Hist√≥rias de Sucesso', descricao:'Veja depoimentos em v√≠deo com resultados de faturamento, fideliza√ß√£o e novos produtos.'},
        ideias: {titulo:'Canal de Ideias', descricao:'Envie novas sugest√µes diretamente para o time de produto BIOMA e acompanhe o status de implementa√ß√£o.'}
    };
    const info = mensagens[tipo] || {titulo:'Comunidade BIOMA', descricao:'Recurso exclusivo para franquias.'};
    Swal.fire({title: info.titulo, text: info.descricao, icon:'info'});
}

async function loadDashboard(){
    const key = 'loadDashboard';

    // PROTE√á√ÉO ANTI-LOOP
    if (isLoading(key)) {
        console.warn(`‚ö†Ô∏è J√° carregando: ${key}`);
        return;
    }

    setLoading(key, true);

    try{
        const res=await fetch('/api/dashboard/stats',{credentials:'include'});
        const data=await res.json();
        if(data.success){
            document.getElementById('dashOrcamentos').textContent=data.stats.total_orcamentos||0;
            document.getElementById('dashClientes').textContent=data.stats.total_clientes||0;
            document.getElementById('dashAgendamentos').textContent=data.stats.agendamentos_hoje||0;
            document.getElementById('dashFaturamento').textContent='R$ '+(data.stats.faturamento||0).toFixed(0);
        }
        // ALERTA DE ESTOQUE BAIXO - FUNCIONAL E EM TEMPO REAL
        try {
            const estoqueRes = await fetch('/api/estoque/alerta', {credentials: 'include'});
            const estoqueData = await estoqueRes.json();

            const alertaCard = document.getElementById('alertaEstoqueBaixo');
            const alertaBody = document.getElementById('estoqueBaixoBody');

            if (estoqueData.success && estoqueData.produtos && estoqueData.produtos.length > 0) {
                // Mostrar card de alerta
                if (alertaCard) alertaCard.style.display = 'block';

                // Renderizar produtos com estoque baixo
                const html = estoqueData.produtos.map(p => {
                    const estoqueAtual = p.estoque || p.quantidade || 0;
                    const estoqueMinimo = p.estoque_minimo || p.minimo || 5;

                    // L√ìGICA V6.0: < 5 = Vermelho Pulsante, >= 5 = Verde
                    let statusBadge = '';
                    if (estoqueAtual === 0) {
                        statusBadge = '<span class="badge badge-pulse-danger">üö´ ESGOTADO</span>';
                    } else if (estoqueAtual < 5) {
                        statusBadge = '<span class="badge badge-pulse-danger">‚ö†Ô∏è CR√çTICO</span>';
                    } else {
                        statusBadge = '<span class="badge success">‚úì Dispon√≠vel</span>';
                    }

                    return `
                    <tr style="background: ${estoqueAtual < 5 ? 'rgba(220, 38, 38, 0.1)' : 'rgba(16, 185, 129, 0.05)'};">
                        <td><strong>${p.nome || 'Produto'}</strong></td>
                        <td>${p.marca || 'N/A'}</td>
                        <td style="color: ${estoqueAtual < 5 ? 'var(--danger)' : 'var(--success)'}; font-weight: bold;">${estoqueAtual}</td>
                        <td>${estoqueMinimo}</td>
                        <td>${statusBadge}</td>
                    </tr>
                    `;
                }).join('');

                if (alertaBody) alertaBody.innerHTML = html;

                console.log(`‚ö†Ô∏è ${estoqueData.produtos.length} produto(s) com estoque baixo detectado(s)!`);
            } else {
                // Esconder card se n√£o houver alertas
                if (alertaCard) alertaCard.style.display = 'none';
                console.log('‚úÖ Estoque OK - Nenhum produto abaixo do m√≠nimo');
            }
        } catch (estoqueErr) {
            console.error('‚ùå Erro ao buscar alertas de estoque:', estoqueErr);
            const alertaCard = document.getElementById('alertaEstoqueBaixo');
            if (alertaCard) alertaCard.style.display = 'none';
        }
        const agendRes=await fetch('/api/agendamentos',{credentials:'include'});
        const agendData=await agendRes.json();
        if(agendData.success&&agendData.agendamentos&&agendData.agendamentos.length>0){
            const html=agendData.agendamentos.map(a=>{
                const dataFormatada=new Date(a.data).toLocaleDateString('pt-BR');
                return `<div style="padding:10px;border-bottom:1px solid var(--border-color)"><strong>${a.cliente_nome||'Cliente'}</strong><br><small>${dataFormatada} √†s ${a.horario}</small></div>`;
            }).join('');
            document.getElementById('proximosAgendamentos').innerHTML=html;
        }else{
            document.getElementById('proximosAgendamentos').innerHTML='<p class="text-center text-muted">üìÖ Nenhum agendamento</p>';
        }
        const orcRes=await fetch('/api/orcamentos',{credentials:'include'});
        const orcData=await orcRes.json();
        if(orcData.success&&orcData.orcamentos&&orcData.orcamentos.length>0){
            const html=orcData.orcamentos.slice(0,10).map(o=>`<tr><td><strong>#${o.numero}</strong></td><td>${new Date(o.created_at).toLocaleDateString('pt-BR')}</td><td>${o.cliente_nome}</td><td><strong>R$ ${o.total_final.toFixed(2)}</strong></td><td><span class="badge ${o.status==='Aprovado'?'success':'warning'}">${o.status}</span></td></tr>`).join('');
            document.getElementById('ultimosOrcamentosBody').innerHTML=html;
        }else{
            document.getElementById('ultimosOrcamentosBody').innerHTML='<tr><td colspan="5" class="text-center text-muted">Nenhum</td></tr>';
        }
    }catch(e){
        console.error('‚ùå Dashboard error:',e);
    } finally {
        setTimeout(() => setLoading(key, false), 250);
    }
}

async function verificarStatus(){
    const key = 'verificarStatus';
    if (isLoading(key)) {
        console.warn(`‚ö†Ô∏è J√° carregando: ${key}`);
        return;
    }
    setLoading(key, true);

    try{
        const res=await fetch('/api/system/status',{credentials:'include'});
        const data=await res.json();
        if(data.success){
            const mongoStatus=document.getElementById('mongoStatus');
            const mongoMsg=document.getElementById('mongoMessage');
            if(data.status.mongodb.operational){
                mongoStatus.className='badge success';
                mongoStatus.innerHTML='‚úÖ Online';
                mongoMsg.textContent=data.status.mongodb.message;
            }else{
                mongoStatus.className='badge danger';
                mongoStatus.innerHTML='‚ùå Offline';
                mongoMsg.textContent=data.status.mongodb.message;
            }
            const emailStatus=document.getElementById('emailStatus');
            if(data.status.mailersend.operational){
                emailStatus.className='badge success';
                emailStatus.innerHTML='‚úÖ Ativo';
                document.getElementById('emailMessage').textContent=data.status.mailersend.message;
            }else{
                emailStatus.className='badge danger';
                emailStatus.innerHTML='‚ùå Inativo';
                document.getElementById('emailMessage').textContent=data.status.mailersend.message;
            }
        }
    }catch(e){
        console.error('‚ùå Status error:',e);
    } finally {
        setTimeout(() => setLoading(key, false), 250);
    }

    // Verificar status dos novos recursos
    verificarRecursosAvancados();
}

// Fun√ß√£o para testar envio de e-mail
async function testarEnvioEmail() {
    try {
        // Perguntar o e-mail de destino com o padr√£o do usu√°rio
        const result = await Swal.fire({
            title: 'üìß Testar Envio de E-mail',
            html: `
                <p style="margin-bottom: 15px;">Digite o e-mail de destino para receber o e-mail de teste:</p>
                <input type="email" id="emailTeste" class="form-control" placeholder="exemplo@email.com" value="juanmarco.bss@hotmail.com" style="width: 80%;">
            `,
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: '<i class="bi bi-send"></i> Enviar',
            cancelButtonText: 'Cancelar',
            confirmButtonColor: '#10B981',
            preConfirm: () => {
                const email = document.getElementById('emailTeste').value;
                if (!email) {
                    Swal.showValidationMessage('Por favor, digite um e-mail');
                    return false;
                }
                // Valida√ß√£o b√°sica de e-mail
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(email)) {
                    Swal.showValidationMessage('E-mail inv√°lido');
                    return false;
                }
                return email;
            }
        });

        if (!result.isConfirmed || !result.value) {
            return;
        }

        const emailDestino = result.value;

        // Mostrar loading
        Swal.fire({
            title: 'Enviando e-mail...',
            html: '<p>Aguarde enquanto enviamos o e-mail de teste</p>',
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });

        // Enviar requisi√ß√£o para o backend
        const response = await fetch('/api/email/test', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'include',
            body: JSON.stringify({ email: emailDestino })
        });

        const data = await response.json();

        if (data.success) {
            Swal.fire({
                icon: 'success',
                title: '‚úÖ E-mail Enviado!',
                html: `
                    <p><strong>Destinat√°rio:</strong> ${data.destinatario}</p>
                    <p><strong>Remetente:</strong> ${data.remetente}</p>
                    ${data.observacao ? `<p style="color: #6b7280; font-size: 0.9rem; margin-top: 10px;">${data.observacao}</p>` : ''}
                `,
                confirmButtonText: 'OK',
                confirmButtonColor: '#10B981'
            });

            console.log('‚úÖ E-mail de teste enviado com sucesso:', data);
        } else {
            Swal.fire({
                icon: 'error',
                title: '‚ùå Erro ao Enviar E-mail',
                html: `<p>${data.message}</p>${data.detalhes ? `<p style="color: #6b7280; font-size: 0.85rem; margin-top: 10px;">${data.detalhes}</p>` : ''}`,
                confirmButtonText: 'OK',
                confirmButtonColor: '#EF4444'
            });

            console.error('‚ùå Erro ao enviar e-mail:', data);
        }

    } catch (error) {
        console.error('‚ùå Erro ao testar e-mail:', error);
        Swal.fire({
            icon: 'error',
            title: '‚ùå Erro',
            text: `Erro ao conectar com o servidor: ${error.message}`,
            confirmButtonText: 'OK',
            confirmButtonColor: '#EF4444'
        });
    }
}

// Fun√ß√£o para verificar status dos recursos avan√ßados (documento, offline, IndexedDB)
function verificarRecursosAvancados() {
    // 1. Verificar Gerador de Documentos (jsPDF e AutoTable)
    const docStatus = document.getElementById('docGeneratorStatus');
    if (typeof jspdf !== 'undefined' || typeof window.jspdf !== 'undefined') {
        docStatus.className = 'badge success';
        docStatus.innerHTML = '<i class="bi bi-check-circle-fill"></i> Funcional';
    } else {
        docStatus.className = 'badge warning';
        docStatus.innerHTML = '<i class="bi bi-exclamation-triangle-fill"></i> Parcial';
    }

    // 2. Verificar Sistema Offline (Service Worker e navegador offline)
    const offlineStatus = document.getElementById('offlineStatus');
    if ('serviceWorker' in navigator && navigator.onLine !== undefined) {
        offlineStatus.className = 'badge success';
        offlineStatus.innerHTML = '<i class="bi bi-check-circle-fill"></i> Pronto';
    } else {
        offlineStatus.className = 'badge danger';
        offlineStatus.innerHTML = '<i class="bi bi-x-circle-fill"></i> N√£o Suportado';
    }

    // 3. Verificar IndexedDB
    const indexedDBStatus = document.getElementById('indexedDBStatus');
    if (window.indexedDB) {
        indexedDBStatus.className = 'badge success';
        indexedDBStatus.innerHTML = '<i class="bi bi-check-circle-fill"></i> Operacional';
    } else {
        indexedDBStatus.className = 'badge danger';
        indexedDBStatus.innerHTML = '<i class="bi bi-x-circle-fill"></i> N√£o Dispon√≠vel';
    }
}

// Fun√ß√£o para baixar backup do banco de dados local (IndexedDB)
async function downloadLocalDatabase() {
    try {
        toast('üì¶ Preparando backup COMPLETO do banco de dados local...', 'info');

        // Coletar dados do localStorage e sessionStorage
        const backupData = {
            timestamp: new Date().toISOString(),
            version: '4.0',
            systemInfo: {
                userAgent: navigator.userAgent,
                language: navigator.language,
                online: navigator.onLine,
                platform: navigator.platform,
                screen: {
                    width: window.screen.width,
                    height: window.screen.height
                }
            },
            localStorage: {},
            sessionStorage: {},
            offlineData: {},
            cachedData: {}
        };

        // 1. Exportar localStorage
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            try {
                const value = localStorage.getItem(key);
                backupData.localStorage[key] = value;
            } catch (e) {
                backupData.localStorage[key] = '<erro ao ler>';
            }
        }

        // 2. Exportar sessionStorage
        for (let i = 0; i < sessionStorage.length; i++) {
            const key = sessionStorage.key(i);
            try {
                const value = sessionStorage.getItem(key);
                backupData.sessionStorage[key] = value;
            } catch (e) {
                backupData.sessionStorage[key] = '<erro ao ler>';
            }
        }

        // 3. Exportar dados em cache (vari√°veis globais do sistema)
        backupData.cachedData = {
            clientes: typeof clientesCached !== 'undefined' ? clientesCached : [],
            profissionais: typeof profissionaisDisponiveis !== 'undefined' ? profissionaisDisponiveis : [],
            servicos: typeof servicosDisponiveis !== 'undefined' ? servicosDisponiveis : [],
            produtos: typeof produtosDisponiveis !== 'undefined' ? produtosDisponiveis : [],
            agendamentos: typeof agendamentosCache !== 'undefined' ? agendamentosCache : [],
            orcamentos: typeof orcamentosCache !== 'undefined' ? orcamentosCache : []
        };

        // 4. Verificar IndexedDB e exportar TODOS os dados
        if (window.indexedDB) {
            try {
                const databases = await indexedDB.databases();
                backupData.indexedDB = {
                    available: true,
                    databases: [],
                    data: {}
                };

                // Para cada database, exportar todos os dados
                for (const dbInfo of databases) {
                    backupData.indexedDB.databases.push(dbInfo.name);

                    try {
                        const db = await new Promise((resolve, reject) => {
                            const request = indexedDB.open(dbInfo.name);
                            request.onsuccess = () => resolve(request.result);
                            request.onerror = () => reject(request.error);
                        });

                        backupData.indexedDB.data[dbInfo.name] = {
                            stores: []
                        };

                        // Listar todas as object stores
                        const storeNames = Array.from(db.objectStoreNames);

                        for (const storeName of storeNames) {
                            const transaction = db.transaction(storeName, 'readonly');
                            const store = transaction.objectStore(storeName);

                            const allData = await new Promise((resolve, reject) => {
                                const request = store.getAll();
                                request.onsuccess = () => resolve(request.result);
                                request.onerror = () => reject(request.error);
                            });

                            backupData.indexedDB.data[dbInfo.name].stores.push({
                                name: storeName,
                                count: allData.length,
                                data: allData
                            });
                        }

                        db.close();
                    } catch (dbError) {
                        console.error(`Erro ao exportar database ${dbInfo.name}:`, dbError);
                        backupData.indexedDB.data[dbInfo.name] = {
                            error: dbError.message
                        };
                    }
                }
            } catch (e) {
                backupData.indexedDB = {
                    available: true,
                    error: e.message,
                    note: 'Erro ao acessar IndexedDB'
                };
            }
        }

        // 5. Dados offline pendentes (se houver)
        const offlineQueue = localStorage.getItem('offline_queue');
        if (offlineQueue) {
            try {
                backupData.offlineData.pendingSync = JSON.parse(offlineQueue);
            } catch (e) {
                backupData.offlineData.pendingSync = [];
            }
        }

        // Criar arquivo JSON para download
        const jsonString = JSON.stringify(backupData, null, 2);
        const blob = new Blob([jsonString], { type: 'application/json' });
        const url = URL.createObjectURL(blob);

        // Criar link de download
        const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
        const filename = `bioma-backup-local-${timestamp}.json`;

        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        toast(`‚úÖ Backup baixado com sucesso! (${filename})`, 'success');

        // Limpar backdrop residual
        setTimeout(() => {
            document.querySelectorAll('.bioma-dialog').forEach(el => {
                if (!Swal.isVisible()) el.remove();
            });
            // Classes swal2 removidas - nao mais necessario
        }, 100);

    } catch (error) {
        console.error('Erro ao criar backup:', error);
        toast('‚ùå Erro ao criar backup do banco de dados local', 'error');
    }
}

async function carregarFormulariosCliente(){
    if (anamneseDef && prontuarioDef) return;
    try {
        const res = await fetch('/api/clientes/formularios', {credentials: 'include'});
        const data = await res.json();
        if (data.success) {
            anamneseDef = data.anamnese || [];
            prontuarioDef = data.prontuario || [];
        }
    } catch (error) {
        console.error('Erro ao carregar formularios de cliente', error);
    }
}

async function loadClientes(){
    const key = 'loadClientes';

    // PROTE√á√ÉO ANTI-LOOP
    if (isLoading(key)) {
        console.warn(`‚ö†Ô∏è J√° carregando: ${key}`);
        return;
    }

    setLoading(key, true);

    try{
        await carregarFormulariosCliente();
        const res = await fetch('/api/clientes',{credentials:'include'});
        const data = await res.json();
        const tbody = document.getElementById('clientesBody');
        if(data.success && Array.isArray(data.clientes) && data.clientes.length){
            const html = data.clientes.map(c => {
                return `<tr>
                    <td><strong>${c.nome}</strong><br><small class="text-muted">${c.email||''}</small></td>
                    <td>${c.cpf}</td>
                    <td>${c.telefone||'-'}</td>
                    <td><strong>R$ ${(c.total_gasto||0).toFixed(2)}</strong></td>
                    <td>${c.total_visitas||0}</td>
                    <td class="d-flex flex-wrap gap-2">
                        <button class="bioma-btn bioma-btn-sm bioma-btn-info" onclick="visualizarCliente('${c._id}')"><i class="bi bi-eye"></i></button>
                        <button class="bioma-btn bioma-btn-sm bioma-btn-primary" onclick="editarCliente('${c._id}')"><i class="bi bi-pencil"></i></button>
                        <button class="bioma-btn bioma-btn-sm bioma-btn-outline-secondary" onclick="abrirAnamneseCliente('${c._id}')"><i class="bi bi-file-earmark-medical"></i></button>
                        <button class="bioma-btn bioma-btn-sm bioma-btn-outline-secondary" onclick="abrirProntuarioCliente('${c._id}')"><i class="bi bi-journal-medical"></i></button>
                        <button class="bioma-btn bioma-btn-sm bioma-btn-danger" onclick="deleteCliente('${c._id}')"><i class="bi bi-trash"></i></button>
                    </td>
                </tr>`;
            }).join('');
            tbody.innerHTML = html;
        } else {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Nenhum cliente</td></tr>';
        }
    }catch(e){
        console.error('Erro ao carregar clientes', e);
        document.getElementById('clientesBody').innerHTML='<tr><td colspan="6" class="text-center text-danger">Erro</td></tr>';
    } finally {
        setTimeout(() => setLoading(key, false), 250);
    }
}

/**
 * Carregar lista de clientes no select de faturamento
 */
async function carregarClientesParaFaturamento() {
    try {
        const select = document.getElementById('selectClienteFaturamento');
        if (!select) return;

        // Mostrar loading
        select.innerHTML = '<option value="">Carregando clientes...</option>';
        select.disabled = true;

        const res = await fetch('/api/clientes', { credentials: 'include' });
        const data = await res.json();

        if (data.success && data.clientes) {
            select.innerHTML = '<option value="">-- Escolha um cliente --</option>';
            data.clientes.forEach(cliente => {
                const option = document.createElement('option');
                option.value = cliente._id;
                option.textContent = `${cliente.nome} - CPF: ${cliente.cpf || 'N/A'}`;
                select.appendChild(option);
            });
            select.disabled = false;
        } else {
            select.innerHTML = '<option value="">Erro ao carregar clientes</option>';
        }
    } catch (error) {
        console.error('Erro ao carregar clientes:', error);
        const select = document.getElementById('selectClienteFaturamento');
        if (select) {
            select.innerHTML = '<option value="">Erro ao carregar clientes</option>';
        }
    }
}

async function carregarFaturamentoCliente() {
    try {
        const selectCliente = document.getElementById('selectClienteFaturamento');
        const clienteId = selectCliente?.value;

        if (!clienteId) {
            mostrarNotificacao('warning', 'Por favor, selecione um cliente primeiro');
            return;
        }

        // Mostrar loading
        const container = document.getElementById('faturamentoClienteInfo');
        if (container) {
            container.innerHTML = `
                <div class="text-center p-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                    <p class="mt-2">Calculando faturamento...</p>
                </div>
            `;
        }

        const res = await fetch(`/api/clientes/${clienteId}/faturamento`, {credentials: 'include'});
        const data = await res.json();

        if (data.success && container) {
            const faturamento = data.faturamento || {total: 0, servicos: 0, produtos: 0, quantidade: 0};
            const clienteNome = selectCliente.options[selectCliente.selectedIndex].text;

            container.innerHTML = `
                <div class="alert alert-success">
                    <h5><i class="bi bi-person-check"></i> ${clienteNome}</h5>
                </div>
                <div class="row text-center">
                    <div class="col-md-3">
                        <div class="card">
                            <div class="card-body">
                                <h6 class="text-muted">Total Geral</h6>
                                <h3 class="text-primary">R$ ${(faturamento.total || 0).toFixed(2)}</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card">
                            <div class="card-body">
                                <h6 class="text-muted">Servi√ßos</h6>
                                <h4 class="text-info">R$ ${(faturamento.servicos || 0).toFixed(2)}</h4>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card">
                            <div class="card-body">
                                <h6 class="text-muted">Produtos</h6>
                                <h4 class="text-warning">R$ ${(faturamento.produtos || 0).toFixed(2)}</h4>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card">
                            <div class="card-body">
                                <h6 class="text-muted">N¬∫ Compras</h6>
                                <h4 class="text-success">${faturamento.quantidade || 0}</h4>
                            </div>
                        </div>
                    </div>
                </div>
                ${faturamento.ultimas_compras ? `
                    <div class="mt-4">
                        <h6><i class="bi bi-clock-history"></i> √öltimas Compras:</h6>
                        <div class="list-group">
                            ${faturamento.ultimas_compras.map(c => `
                                <div class="list-group-item">
                                    <div class="d-flex justify-content-between">
                                        <span>${new Date(c.data).toLocaleDateString('pt-BR')}</span>
                                        <strong>R$ ${c.total.toFixed(2)}</strong>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
            `;
        } else {
            if (container) {
                container.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle"></i>
                        ${data.message || 'Erro ao carregar faturamento do cliente'}
                    </div>
                `;
            }
        }
    } catch (error) {
        console.error('Erro ao carregar faturamento:', error);
        const container = document.getElementById('faturamentoClienteInfo');
        if (container) {
            container.innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle"></i>
                    Erro ao carregar faturamento. Por favor, tente novamente.
                </div>
            `;
        }
    }
}

async function deleteCliente(id){
    const result = await window.Swal.fire({
        title: 'Deletar Cliente?',
        text: 'Esta a√ß√£o n√£o pode ser desfeita',
        icon: 'warning',
        confirmButtonText: 'Sim, Deletar',
        cancelButtonText: 'Cancelar',
        showCancelButton: true
    });

    if(result.isConfirmed){
        try{
            const response = await fetchWithTimeout(`/api/clientes/${id}`, {method:'DELETE',credentials:'include'}, 30000, 1);
            const data = await response.json();
            if(data.success){
                mostrarNotificacao('success', 'Cliente deletado com sucesso!');
                await autoRefreshAfterOperation('clientes'); // v7.1: Auto-refresh
            }else{
                mostrarNotificacao('error', data.message || 'Erro ao deletar cliente');
            }
        }catch(e){
            console.error('Erro ao deletar cliente:',e);
            mostrarNotificacao('error', 'Erro ao deletar cliente');
        }
    }
}

function filtrarClientes(){
    const termo=document.getElementById('buscaCliente').value.toLowerCase();
    const rows=document.querySelectorAll('#clientesBody tr');
    rows.forEach(row=>{
        const text=row.textContent.toLowerCase();
        row.style.display=text.includes(termo)?'':'none';
    });
}

function showModalCliente(){
    Swal.fire({
        title:'Novo Cliente',
        html:`<div class="text-start">
                <div class="row g-3">
                    <div class="col-md-6"><label class="form-label">Nome *</label><input type="text" id="swal-nome-cliente" class="form-control" placeholder="Nome completo"></div>
                    <div class="col-md-6"><label class="form-label">CPF *</label><input type="text" id="swal-cpf-cliente" class="form-control" placeholder="000.000.000-00"></div>
                    <div class="col-md-6"><label class="form-label">E-mail</label><input type="email" id="swal-email-cliente" class="form-control" placeholder="email@exemplo.com"></div>
                    <div class="col-md-6"><label class="form-label">Telefone</label><input type="text" id="swal-telefone" class="form-control" placeholder="(00) 00000-0000"></div>
                    <div class="col-md-6"><label class="form-label">Data de nascimento</label><input type="date" id="swal-data-nascimento" class="form-control"></div>
                    <div class="col-md-6"><label class="form-label">Indica√ß√£o</label><input type="text" id="swal-indicacao" class="form-control"></div>
                    <div class="col-md-6"><label class="form-label">Prefer√™ncias</label><textarea id="swal-preferencias" class="form-control" rows="2"></textarea></div>
                    <div class="col-md-6"><label class="form-label">Restri√ß√µes</label><textarea id="swal-restricoes" class="form-control" rows="2"></textarea></div>
                    <div class="col-12"><label class="form-label">Observa√ß√µes</label><textarea id="swal-observacoes" class="form-control" rows="2"></textarea></div>
                </div>
            </div>`,
        showCancelButton:true,
        confirmButtonText:'Salvar',
        cancelButtonText:'Cancelar',
        allowEscapeKey: true,
        allowOutsideClick: true,
        showCloseButton: true,
        preConfirm:()=>{
            const nome=document.getElementById('swal-nome-cliente').value.trim();
            const cpf=document.getElementById('swal-cpf-cliente').value.trim();
            if(!nome || !cpf){
                Swal.showValidationMessage('Nome e CPF s√£o obrigat√≥rios');
                return false;
            }
            return {
                nome,
                cpf,
                email:document.getElementById('swal-email-cliente').value.trim(),
                telefone:document.getElementById('swal-telefone').value.trim(),
                data_nascimento:document.getElementById('swal-data-nascimento').value,
                indicacao:document.getElementById('swal-indicacao').value.trim(),
                preferencias:document.getElementById('swal-preferencias').value.trim(),
                restricoes:document.getElementById('swal-restricoes').value.trim(),
                observacoes:document.getElementById('swal-observacoes').value.trim()
            };
        }
    }).then(async(result)=>{
        if(result.isConfirmed){
            try{
                await fetch('/api/clientes',{method:'POST',headers:{'Content-Type':'application/json'},credentials:'include',body:JSON.stringify(result.value)});
                mostrarNotificacao('success', 'Cliente cadastrado com sucesso!');
                await loadClientes();
            }catch(error){
                console.error('Erro ao cadastrar cliente', error);
                mostrarNotificacao('error', 'N√£o foi poss√≠vel cadastrar o cliente');
            }
        }
    });
}


function renderFormularioCampos(definicoes, prefixo, respostas){
    return (definicoes || []).map(item => {
        const campoId = `${prefixo}_${item.ordem}`;
        const valor = respostas && respostas[item.campo] !== undefined ? respostas[item.campo] : '';
        if(item.tipo === 'select'){
            const opcoes = (item.opcoes || []).map(op => `<option value="${op}" ${valor === op ? 'selected' : ''}>${op}</option>`).join('');
            return `<div class="mb-3"><label class="form-label">${item.campo}</label><select class="form-select" id="${campoId}">${opcoes}</select></div>`;
        }
        if(item.tipo === 'radio'){
            const opcoes = (item.opcoes || []).map((op,idx)=>`
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="${campoId}" id="${campoId}_${idx}" value="${op}" ${valor === op ? 'checked' : ''}>
                    <label class="form-check-label" for="${campoId}_${idx}">${op}</label>
                </div>`).join('');
            return `<div class="mb-3"><label class="form-label">${item.campo}</label>${opcoes}</div>`;
        }
        if(item.tipo === 'checkbox'){
            const selecionados = Array.isArray(valor) ? valor : (valor ? String(valor).split(';').map(v=>v.trim()).filter(Boolean) : []);
            const opcoes = (item.opcoes || []).map((op,idx)=>`
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="${campoId}_${idx}" value="${op}" ${selecionados.includes(op) ? 'checked' : ''}>
                    <label class="form-check-label" for="${campoId}_${idx}">${op}</label>
                </div>`).join('');
            return `<div class="mb-3"><label class="form-label">${item.campo}</label>${opcoes}</div>`;
        }
        if(item.tipo === 'textarea'){
            return `<div class="mb-3"><label class="form-label">${item.campo}</label><textarea class="form-control" id="${campoId}" rows="3">${valor || ''}</textarea></div>`;
        }
        return `<div class="mb-3"><label class="form-label">${item.campo}</label><input type="text" class="form-control" id="${campoId}" value="${valor || ''}"></div>`;
    }).join('');
}

function coletarFormularioRespostas(definicoes, prefixo){
    const respostas = {};
    (definicoes || []).forEach(item => {
        const campoId = `${prefixo}_${item.ordem}`;
        if(item.tipo === 'select'){
            respostas[item.campo] = document.getElementById(campoId)?.value || '';
        } else if(item.tipo === 'radio'){
            const selecionado = document.querySelector(`input[name="${campoId}"]:checked`);
            respostas[item.campo] = selecionado ? selecionado.value : '';
        } else if(item.tipo === 'checkbox'){
            const selecionados = Array.from(document.querySelectorAll(`input[id^="${campoId}_"]:checked`)).map(el=>el.value);
            respostas[item.campo] = selecionados.join('; ');
        } else if(item.tipo === 'textarea'){
            respostas[item.campo] = document.getElementById(campoId)?.value || '';
        } else {
            respostas[item.campo] = document.getElementById(campoId)?.value || '';
        }
    });
    return respostas;
}

function renderResumoFormulario(definicoes, respostas, titulo){
    if(!definicoes || !definicoes.length) return '';
    const itens = definicoes.map(item => {
        const valor = respostas ? respostas[item.campo] : '';
        if(!valor) return '';
        return `<li class="list-group-item d-flex justify-content-between align-items-start">
            <div class="ms-2 me-auto">
                <div class="fw-bold">${item.campo}</div>
                <span>${valor}</span>
            </div>
        </li>`;
    }).filter(Boolean).join('');
    if(!itens) return '';
    return `<div class="mt-3">
        <h6 class="fw-bold">${titulo}</h6>
        <ul class="list-group list-group-flush small">
            ${itens}
        </ul>
    </div>`;
}

async function abrirAnamneseCliente(id){
    try{
        await carregarFormulariosCliente();
        const cliente = await obterCliente(id);
        const respostas = cliente.anamnese || {};
        const html = `<div style="text-align:left;max-height:60vh;overflow:auto">${renderFormularioCampos(anamneseDef,'anamnese',respostas)}</div>`;
        const result = await Swal.fire({
            title: 'Ficha de Anamnese',
            html,
            width: 720,
            focusConfirm: false,
            showCancelButton: true,
            confirmButtonText: 'Salvar',
            cancelButtonText: 'Cancelar'
        });
        if(result.isConfirmed){
            const dados = coletarFormularioRespostas(anamneseDef,'anamnese');
            await fetch(`/api/clientes/${id}`,{
                method:'PUT',
                headers:{'Content-Type':'application/json'},
                credentials:'include',
                body:JSON.stringify({anamnese:dados})
            });
            mostrarNotificacao('success', 'Ficha de anamnese atualizada com sucesso!');
            await loadClientes();
        }
    }catch(error){
        console.error('Erro ao abrir anamnese', error);
        mostrarNotificacao('error', 'N√£o foi poss√≠vel carregar a ficha');
    }
}

async function abrirProntuarioCliente(id){
    try{
        await carregarFormulariosCliente();
        const cliente = await obterCliente(id);
        const respostas = cliente.prontuario || {};
        const html = `<div style="text-align:left;max-height:60vh;overflow:auto">${renderFormularioCampos(prontuarioDef,'prontuario',respostas)}</div>`;
        const result = await Swal.fire({
            title: 'Prontu√°rio',
            html,
            width: 720,
            focusConfirm: false,
            showCancelButton: true,
            confirmButtonText: 'Salvar',
            cancelButtonText: 'Cancelar'
        });
        if(result.isConfirmed){
            const dados = coletarFormularioRespostas(prontuarioDef,'prontuario');
            await fetch(`/api/clientes/${id}`,{
                method:'PUT',
                headers:{'Content-Type':'application/json'},
                credentials:'include',
                body:JSON.stringify({prontuario:dados})
            });
            mostrarNotificacao('success', 'Prontu√°rio atualizado com sucesso!');
        }
    }catch(error){
        console.error('Erro ao abrir prontu√°rio', error);
        mostrarNotificacao('error', 'N√£o foi poss√≠vel carregar o prontu√°rio');
    }
}

async function obterCliente(id){
    const res = await fetch(`/api/clientes/${id}`,{credentials:'include'});
    const data = await res.json();
    if(data.success && data.cliente){
        return data.cliente;
    }
    throw new Error(data.message || 'Cliente nao encontrado');
}

async function visualizarCliente(id){
    try{
        await carregarFormulariosCliente();
        const c = await obterCliente(id);
        const blocoResumo = `
            <div style="background:linear-gradient(135deg,#7C3AED,#EC4899);color:#fff;padding:20px;border-radius:15px;margin-bottom:20px">
                <p style="margin:5px 0"><strong>CPF:</strong> ${c.cpf}</p>
                ${c.email?`<p style="margin:5px 0"><strong>Email:</strong> ${c.email}</p>`:''}
                ${c.telefone?`<p style="margin:5px 0"><strong>Telefone:</strong> ${c.telefone}</p>`:''}
                ${c.endereco?`<p style="margin:5px 0"><strong>Endere√ßo:</strong> ${c.endereco}</p>`:''}
            </div>`;
        const blocoEstatisticas = `
            <div style="background:#f3f4f6;padding:15px;border-radius:10px">
                <p><strong>üí∞ Total Gasto:</strong> <span style="color:#10B981;font-size:1.3rem">R$ ${(c.total_gasto||0).toFixed(2)}</span></p>
                <p><strong>üìä Total de Visitas:</strong> ${c.total_visitas||0}</p>
                ${c.ultima_visita?`<p><strong>üóìÔ∏è √öltima Visita:</strong> ${new Date(c.ultima_visita).toLocaleDateString('pt-BR')}</p>`:''}
            </div>`;
        const blocoObservacoes = c.observacoes ? `<div style="margin-top:15px;padding:10px;background:#FEF3C7;border-left:4px solid #F59E0B;border-radius:5px"><strong>üìù Observa√ß√µes:</strong><p style="margin:5px 0 0">${c.observacoes}</p></div>` : '';
        const fichaAnamnese = renderResumoFormulario(anamneseDef, c.anamnese || {}, 'Anamnese');
        const fichaProntuario = renderResumoFormulario(prontuarioDef, c.prontuario || {}, 'Prontu√°rio');
        Swal.fire({
            title:`<strong>üë§ ${c.nome}</strong>`,
            html:`<div style="text-align:left">${blocoResumo}${blocoEstatisticas}${blocoObservacoes}${fichaAnamnese}${fichaProntuario}<p style="margin-top:15px;font-size:0.85rem;color:#6B7280">Cadastrado em: ${c.created_at?new Date(c.created_at).toLocaleString('pt-BR'):''}</p></div>`,
            width:680,
            confirmButtonText:'Fechar',
            confirmButtonColor:'#7C3AED',
            allowEscapeKey: true,
            allowOutsideClick: true,
            showCloseButton: true,
            focusConfirm: true
        });
    }catch(error){
        console.error('Erro ao visualizar cliente', error);
        Swal.fire('Erro','N√£o foi poss√≠vel carregar os detalhes','error');
    }
}

async function editarCliente(id){
    try{
        await carregarFormulariosCliente();
        const c = await obterCliente(id);
        const resumo = `<div class="bg-light p-3 rounded mb-3">
                <div><strong>Total gasto:</strong> ${formatarMoeda(c.total_gasto || 0)}</div>
                <div><strong>Visitas:</strong> ${c.total_visitas || 0}</div>
                <div><strong>√öltima visita:</strong> ${c.ultima_visita ? new Date(c.ultima_visita).toLocaleDateString('pt-BR') : '-'}</div>
            </div>`;
        const html = `<div class="text-start">
                <div class="row g-3">
                    <div class="col-md-6"><label class="form-label">Nome *</label><input type="text" id="swal-edit-cliente-nome" class="form-control" value="${c.nome || ''}"></div>
                    <div class="col-md-6"><label class="form-label">CPF *</label><input type="text" id="swal-edit-cliente-cpf" class="form-control" value="${c.cpf || ''}"></div>
                    <div class="col-md-6"><label class="form-label">E-mail</label><input type="email" id="swal-email" class="form-control" value="${c.email || ''}"></div>
                    <div class="col-md-6"><label class="form-label">Telefone</label><input type="text" id="swal-telefone" class="form-control" value="${c.telefone || ''}"></div>
                    <div class="col-md-6"><label class="form-label">Data de nascimento</label><input type="date" id="swal-data-nascimento" class="form-control" value="${c.data_nascimento ? c.data_nascimento.substring(0,10) : ''}"></div>
                    <div class="col-md-6"><label class="form-label">G√™nero</label><input type="text" id="swal-genero" class="form-control" value="${c.genero || ''}"></div>
                    <div class="col-md-6"><label class="form-label">Estado civil</label><input type="text" id="swal-estado-civil" class="form-control" value="${c.estado_civil || ''}"></div>
                    <div class="col-md-6"><label class="form-label">Profiss√£o</label><input type="text" id="swal-profissao" class="form-control" value="${c.profissao || ''}"></div>
                    <div class="col-md-6"><label class="form-label">Instagram</label><input type="text" id="swal-instagram" class="form-control" value="${c.instagram || ''}"></div>
                    <div class="col-md-6"><label class="form-label">Indica√ß√£o</label><input type="text" id="swal-indicacao" class="form-control" value="${c.indicacao || ''}"></div>
                    <div class="col-md-12"><label class="form-label">Observa√ß√µes gerais</label><textarea id="swal-observacoes" class="form-control" rows="2">${c.observacoes || ''}</textarea></div>
                    <div class="col-md-6"><label class="form-label">Prefer√™ncias</label><textarea id="swal-preferencias" class="form-control" rows="2">${c.preferencias || ''}</textarea></div>
                    <div class="col-md-6"><label class="form-label">Restri√ß√µes</label><textarea id="swal-restricoes" class="form-control" rows="2">${c.restricoes || ''}</textarea></div>
                    <div class="col-md-6"><label class="form-label">Tipo de cabelo</label><input type="text" id="swal-tipo-cabelo" class="form-control" value="${c.tipo_cabelo || ''}"></div>
                    <div class="col-md-6"><label class="form-label">Hist√≥rico de tratamentos</label><textarea id="swal-historico" class="form-control" rows="2">${c.historico_tratamentos || ''}</textarea></div>
                </div>
                ${resumo}
            </div>`;
        const { value } = await Swal.fire({
            title:'Editar Cliente',
            html: html,
            focusConfirm:false,
            width:720,
            showCancelButton:true,
            confirmButtonText:'Salvar',
            cancelButtonText:'Cancelar',
            allowEscapeKey: true,
            allowOutsideClick: true,
            showCloseButton: true,
            preConfirm:()=>{
                const nome=document.getElementById('swal-edit-cliente-nome').value.trim();
                const cpf=document.getElementById('swal-edit-cliente-cpf').value.trim();
                if(!nome || !cpf){
                    Swal.showValidationMessage('Nome e CPF s√£o obrigat√≥rios');
                    return false;
                }
                return {
                    nome,
                    cpf,
                    email:document.getElementById('swal-email').value.trim(),
                    telefone:document.getElementById('swal-telefone').value.trim(),
                    endereco:c.endereco || '',
                    data_nascimento:document.getElementById('swal-data-nascimento').value,
                    genero:document.getElementById('swal-genero').value.trim(),
                    estado_civil:document.getElementById('swal-estado-civil').value.trim(),
                    profissao:document.getElementById('swal-profissao').value.trim(),
                    instagram:document.getElementById('swal-instagram').value.trim(),
                    indicacao:document.getElementById('swal-indicacao').value.trim(),
                    preferencias:document.getElementById('swal-preferencias').value.trim(),
                    restricoes:document.getElementById('swal-restricoes').value.trim(),
                    tipo_cabelo:document.getElementById('swal-tipo-cabelo').value.trim(),
                    historico_tratamentos:document.getElementById('swal-historico').value.trim(),
                    observacoes:document.getElementById('swal-observacoes').value.trim()
                };
            }
        });
        if(value){
            await fetch(`/api/clientes/${id}`,{
                method:'PUT',
                headers:{'Content-Type':'application/json'},
                credentials:'include',
                body:JSON.stringify(value)
            });
            mostrarNotificacao('success', 'Cliente atualizado com sucesso!');
            await loadClientes();
        }
    }catch(error){
        console.error('Erro ao carregar cliente para edi√ß√£o', error);
        mostrarNotificacao('error', 'N√£o foi poss√≠vel carregar o cliente para edi√ß√£o');
    }
}

// ========================================================================================
// === FUN√á√ïES DE ANAMNESE E PRONTU√ÅRIO ===
// ========================================================================================

/**
 * Carrega lista de todos os clientes para Anamnese
 */
async function carregarListaAnamnese() {
    try {
        const response = await fetch('/api/clientes', {
            credentials: 'include'
        });
        const data = await response.json();

        // A API retorna {success: true, clientes: [...]}
        const clientes = data.clientes || data || [];

        const tbody = document.getElementById('anamnesesListaBody');

        if (!clientes || !Array.isArray(clientes) || clientes.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Nenhum cliente cadastrado</td></tr>';
            return;
        }

        // Renderizar cada cliente
        const rows = clientes.map(cliente => {
            const temAnamnese = cliente.anamnese && Object.keys(cliente.anamnese).length > 0;
            const temDocumentoFisico = cliente.documentos_anamnese && cliente.documentos_anamnese.length > 0;

            let statusBadge = '';
            let ultimaAtualizacao = '-';

            if (temAnamnese) {
                statusBadge = '<span class="badge bg-success">Digital OK</span>';
                if (cliente.anamnese.data_preenchimento) {
                    ultimaAtualizacao = new Date(cliente.anamnese.data_preenchimento).toLocaleDateString('pt-BR');
                }
            }

            if (temDocumentoFisico) {
                statusBadge += ' <span class="badge bg-info">F√≠sico OK</span>';
            }

            if (!temAnamnese && !temDocumentoFisico) {
                statusBadge = '<span class="badge bg-secondary">Sem registro</span>';
            }

            return `
                <tr>
                    <td><strong>${cliente.nome}</strong></td>
                    <td>${cliente.cpf || '-'}</td>
                    <td>${ultimaAtualizacao}</td>
                    <td>${statusBadge}</td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick="visualizarAnamneseDigital('${cliente._id}')"
                                title="Ver Anamnese Digital" ${!temAnamnese ? 'disabled' : ''}>
                            <i class="bi bi-file-earmark-medical"></i> Digital
                        </button>
                        <button class="btn btn-info btn-sm" onclick="visualizarAnamneseFisica('${cliente._id}')"
                                title="Ver Documento Escaneado" ${!temDocumentoFisico ? 'disabled' : ''}>
                            <i class="bi bi-file-earmark-image"></i> F√≠sico
                        </button>
                        <button class="btn btn-warning btn-sm" onclick="editarAnamnese('${cliente._id}')"
                                title="Editar Anamnese">
                            <i class="bi bi-pencil"></i> Editar
                        </button>
                        <button class="btn btn-success btn-sm" onclick="uploadAnamneseFisica('${cliente._id}')"
                                title="Upload de Documento Escaneado">
                            <i class="bi bi-upload"></i> Upload
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="excluirAnamnese('${cliente._id}')"
                                title="Excluir Anamnese" ${!temAnamnese && !temDocumentoFisico ? 'disabled' : ''}>
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
        }).join('');

        tbody.innerHTML = rows;

    } catch (error) {
        console.error('Erro ao carregar lista de anamnese:', error);
        document.getElementById('anamnesesListaBody').innerHTML =
            '<tr><td colspan="5" class="text-center text-danger">Erro ao carregar dados</td></tr>';
    }
}

/**
 * Filtra a tabela de anamnese baseado no input de busca
 */
function filtrarAnamnese() {
    const busca = document.getElementById('buscaAnamnese').value.toLowerCase();
    const tbody = document.getElementById('anamnesesListaBody');
    const rows = tbody.getElementsByTagName('tr');

    for (let row of rows) {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(busca) ? '' : 'none';
    }
}

/**
 * Visualiza a anamnese digital (criada no sistema) do cliente
 */
async function visualizarAnamneseDigital(clienteId) {
    try {
        const response = await fetch(`/api/clientes/${clienteId}`, {
            credentials: 'include'
        });
        const cliente = await response.json();

        if (!cliente.anamnese || Object.keys(cliente.anamnese).length === 0) {
            Swal.fire('Aviso', 'Este cliente ainda n√£o possui anamnese digital cadastrada', 'info');
            return;
        }

        const anamnese = cliente.anamnese;

        let html = `
            <div class="text-start" style="max-height: 500px; overflow-y: auto;">
                <h5 class="mb-3"><i class="bi bi-person"></i> ${cliente.nome}</h5>
                <table class="table table-sm table-bordered">
                    <tbody>
        `;

        // Renderizar todos os campos da anamnese
        for (let [key, value] of Object.entries(anamnese)) {
            if (key === '_id' || key === 'cliente_id') continue;

            const label = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            html += `
                <tr>
                    <td style="width: 40%; font-weight: bold;">${label}</td>
                    <td style="width: 60%;">${value || '-'}</td>
                </tr>
            `;
        }

        html += `
                    </tbody>
                </table>
            </div>
        `;

        Swal.fire({
            title: 'Anamnese Digital',
            html: html,
            width: 800,
            showCloseButton: true,
            confirmButtonText: 'Fechar'
        });

    } catch (error) {
        console.error('Erro ao visualizar anamnese digital:', error);
        Swal.fire('Erro', 'N√£o foi poss√≠vel carregar a anamnese digital', 'error');
    }
}

/**
 * Visualiza os documentos f√≠sicos escaneados de anamnese do cliente
 */
async function visualizarAnamneseFisica(clienteId) {
    try {
        const response = await fetch(`/api/clientes/${clienteId}/anamnese/documentos`, {
            credentials: 'include'
        });
        const result = await response.json();

        if (!result.documentos || result.documentos.length === 0) {
            Swal.fire('Aviso', 'Este cliente ainda n√£o possui documentos f√≠sicos de anamnese', 'info');
            return;
        }

        let html = `
            <div class="text-start" style="max-height: 500px; overflow-y: auto;">
                <p class="mb-3"><strong>Cliente:</strong> ${result.cliente_nome}</p>
                <p class="mb-3"><strong>Total de documentos:</strong> ${result.documentos.length}</p>
        `;

        result.documentos.forEach((doc, index) => {
            const dataUpload = doc.data_upload ? new Date(doc.data_upload).toLocaleString('pt-BR') : 'Data desconhecida';
            html += `
                <div class="card mb-3">
                    <div class="card-header">
                        <strong>Documento ${index + 1}</strong>
                        <small class="text-muted float-end">${dataUpload}</small>
                    </div>
                    <div class="card-body text-center">
                        ${doc.tipo_arquivo === 'application/pdf' ?
                            `<embed src="${doc.arquivo_base64}" type="application/pdf" width="100%" height="400px" />` :
                            `<img src="${doc.arquivo_base64}" class="img-fluid" style="max-height: 400px;" />`
                        }
                    </div>
                </div>
            `;
        });

        html += '</div>';

        Swal.fire({
            title: 'Documentos F√≠sicos de Anamnese',
            html: html,
            width: 900,
            showCloseButton: true,
            confirmButtonText: 'Fechar'
        });

    } catch (error) {
        console.error('Erro ao visualizar documentos f√≠sicos:', error);
        Swal.fire('Erro', 'N√£o foi poss√≠vel carregar os documentos f√≠sicos', 'error');
    }
}

/**
 * Abre modal para editar anamnese do cliente
 */
async function editarAnamnese(clienteId) {
    try {
        const response = await fetch(`/api/clientes/${clienteId}`, {
            credentials: 'include'
        });
        const cliente = await response.json();

        const anamnese = cliente.anamnese || {};

        const html = `
            <div class="text-start">
                <div class="row g-3">
                    <div class="col-12">
                        <label class="form-label">Queixa Principal</label>
                        <textarea id="queixa_principal" class="form-control" rows="2">${anamnese.queixa_principal || ''}</textarea>
                    </div>
                    <div class="col-12">
                        <label class="form-label">Hist√≥ria da Doen√ßa Atual</label>
                        <textarea id="historia_doenca" class="form-control" rows="3">${anamnese.historia_doenca || ''}</textarea>
                    </div>
                    <div class="col-12">
                        <label class="form-label">Hist√≥rico M√©dico</label>
                        <textarea id="historico_medico" class="form-control" rows="3">${anamnese.historico_medico || ''}</textarea>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Medicamentos em Uso</label>
                        <textarea id="medicamentos" class="form-control" rows="2">${anamnese.medicamentos || ''}</textarea>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Alergias</label>
                        <textarea id="alergias" class="form-control" rows="2">${anamnese.alergias || ''}</textarea>
                    </div>
                    <div class="col-12">
                        <label class="form-label">Observa√ß√µes Adicionais</label>
                        <textarea id="observacoes_anamnese" class="form-control" rows="2">${anamnese.observacoes || ''}</textarea>
                    </div>
                </div>
            </div>
        `;

        const { value } = await Swal.fire({
            title: `Editar Anamnese - ${cliente.nome}`,
            html: html,
            width: 800,
            showCancelButton: true,
            confirmButtonText: 'Salvar',
            cancelButtonText: 'Cancelar',
            preConfirm: () => {
                return {
                    queixa_principal: document.getElementById('queixa_principal').value.trim(),
                    historia_doenca: document.getElementById('historia_doenca').value.trim(),
                    historico_medico: document.getElementById('historico_medico').value.trim(),
                    medicamentos: document.getElementById('medicamentos').value.trim(),
                    alergias: document.getElementById('alergias').value.trim(),
                    observacoes: document.getElementById('observacoes_anamnese').value.trim(),
                    data_preenchimento: new Date().toISOString()
                };
            }
        });

        if (value) {
            const updateResponse = await fetch(`/api/clientes/${clienteId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({ anamnese: value })
            });

            if (updateResponse.ok) {
                Swal.fire('Sucesso', 'Anamnese atualizada com sucesso!', 'success');
                carregarListaAnamnese();
            } else {
                Swal.fire('Erro', 'N√£o foi poss√≠vel atualizar a anamnese', 'error');
            }
        }

    } catch (error) {
        console.error('Erro ao editar anamnese:', error);
        Swal.fire('Erro', 'N√£o foi poss√≠vel carregar a anamnese para edi√ß√£o', 'error');
    }
}

/**
 * Exclui a anamnese do cliente (digital e documentos f√≠sicos)
 */
async function excluirAnamnese(clienteId) {
    try {
        const result = await Swal.fire({
            title: 'Excluir Anamnese?',
            html: `
                <p>Esta a√ß√£o ir√° remover:</p>
                <ul class="text-start">
                    <li>Anamnese digital (preenchida no sistema)</li>
                    <li>Todos os documentos f√≠sicos escaneados</li>
                </ul>
                <p class="text-danger"><strong>Esta a√ß√£o n√£o pode ser desfeita!</strong></p>
            `,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Sim, excluir!',
            cancelButtonText: 'Cancelar'
        });

        if (result.isConfirmed) {
            const response = await fetch(`/api/clientes/${clienteId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({
                    anamnese: {},
                    documentos_anamnese: []
                })
            });

            if (response.ok) {
                Swal.fire('Exclu√≠do!', 'Anamnese removida com sucesso', 'success');
                carregarListaAnamnese();
            } else {
                Swal.fire('Erro', 'N√£o foi poss√≠vel excluir a anamnese', 'error');
            }
        }

    } catch (error) {
        console.error('Erro ao excluir anamnese:', error);
        Swal.fire('Erro', 'N√£o foi poss√≠vel excluir a anamnese', 'error');
    }
}

/**
 * Faz upload de documento f√≠sico escaneado de anamnese
 */
async function uploadAnamneseFisica(clienteId) {
    try {
        const response = await fetch(`/api/clientes/${clienteId}`, {
            credentials: 'include'
        });
        const cliente = await response.json();

        const { value: file } = await Swal.fire({
            title: `Upload de Anamnese - ${cliente.nome}`,
            html: `
                <div class="text-start">
                    <p class="alert alert-info">
                        <i class="bi bi-info-circle"></i>
                        <strong>Dica:</strong> Escaneie o documento f√≠sico e fa√ßa upload da imagem ou PDF.
                    </p>
                    <label class="form-label">Selecione o arquivo (imagem ou PDF)</label>
                    <input type="file" id="arquivo-anamnese" class="form-control" accept="image/*,application/pdf">
                </div>
            `,
            width: 600,
            showCancelButton: true,
            confirmButtonText: 'Upload',
            cancelButtonText: 'Cancelar',
            preConfirm: () => {
                const fileInput = document.getElementById('arquivo-anamnese');
                if (!fileInput.files || fileInput.files.length === 0) {
                    Swal.showValidationMessage('Por favor, selecione um arquivo');
                    return false;
                }
                return fileInput.files[0];
            }
        });

        if (file) {
            // Mostrar loading
            Swal.fire({
                title: 'Fazendo upload...',
                html: 'Por favor aguarde',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            const formData = new FormData();
            formData.append('arquivo', file);

            const uploadResponse = await fetch(`/api/clientes/${clienteId}/anamnese/upload`, {
                method: 'POST',
                credentials: 'include',
                body: formData
            });

            if (uploadResponse.ok) {
                Swal.fire('Sucesso', 'Documento enviado com sucesso!', 'success');
                carregarListaAnamnese();
            } else {
                const errorData = await uploadResponse.json();
                Swal.fire('Erro', errorData.error || 'N√£o foi poss√≠vel fazer upload do documento', 'error');
            }
        }

    } catch (error) {
        console.error('Erro ao fazer upload:', error);
        Swal.fire('Erro', 'N√£o foi poss√≠vel fazer upload do documento', 'error');
    }
}

/**
 * Carrega lista de todos os clientes para Prontu√°rio
 */
async function carregarListaProntuario() {
    try {
        const response = await fetch('/api/clientes', {
            credentials: 'include'
        });
        const data = await response.json();

        // A API retorna {success: true, clientes: [...]}
        const clientes = data.clientes || data || [];

        const tbody = document.getElementById('prontuariosListaBody');

        if (!clientes || !Array.isArray(clientes) || clientes.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Nenhum cliente cadastrado</td></tr>';
            return;
        }

        // Renderizar cada cliente
        const rows = clientes.map(cliente => {
            const temProntuario = cliente.prontuario && Object.keys(cliente.prontuario).length > 0;
            const temDocumentoFisico = cliente.documentos_prontuario && cliente.documentos_prontuario.length > 0;

            let statusBadge = '';
            let ultimaAtualizacao = '-';

            if (temProntuario) {
                statusBadge = '<span class="badge bg-success">Digital OK</span>';
                if (cliente.prontuario.data_atendimento) {
                    ultimaAtualizacao = new Date(cliente.prontuario.data_atendimento).toLocaleDateString('pt-BR');
                }
            }

            if (temDocumentoFisico) {
                statusBadge += ' <span class="badge bg-info">F√≠sico OK</span>';
            }

            if (!temProntuario && !temDocumentoFisico) {
                statusBadge = '<span class="badge bg-secondary">Sem registro</span>';
            }

            return `
                <tr>
                    <td><strong>${cliente.nome}</strong></td>
                    <td>${cliente.cpf || '-'}</td>
                    <td>${ultimaAtualizacao}</td>
                    <td>${statusBadge}</td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick="visualizarProntuarioDigital('${cliente._id}')"
                                title="Ver Prontu√°rio Digital" ${!temProntuario ? 'disabled' : ''}>
                            <i class="bi bi-file-earmark-text"></i> Digital
                        </button>
                        <button class="btn btn-info btn-sm" onclick="visualizarProntuarioFisico('${cliente._id}')"
                                title="Ver Documento Escaneado" ${!temDocumentoFisico ? 'disabled' : ''}>
                            <i class="bi bi-file-earmark-image"></i> F√≠sico
                        </button>
                        <button class="btn btn-warning btn-sm" onclick="editarProntuario('${cliente._id}')"
                                title="Editar Prontu√°rio">
                            <i class="bi bi-pencil"></i> Editar
                        </button>
                        <button class="btn btn-success btn-sm" onclick="uploadProntuarioFisico('${cliente._id}')"
                                title="Upload de Documento Escaneado">
                            <i class="bi bi-upload"></i> Upload
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="excluirProntuario('${cliente._id}')"
                                title="Excluir Prontu√°rio" ${!temProntuario && !temDocumentoFisico ? 'disabled' : ''}>
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
        }).join('');

        tbody.innerHTML = rows;

    } catch (error) {
        console.error('Erro ao carregar lista de prontu√°rio:', error);
        document.getElementById('prontuariosListaBody').innerHTML =
            '<tr><td colspan="5" class="text-center text-danger">Erro ao carregar dados</td></tr>';
    }
}

/**
 * Filtra a tabela de prontu√°rio baseado no input de busca
 */
function filtrarProntuario() {
    const busca = document.getElementById('buscaProntuario').value.toLowerCase();
    const tbody = document.getElementById('prontuariosListaBody');
    const rows = tbody.getElementsByTagName('tr');

    for (let row of rows) {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(busca) ? '' : 'none';
    }
}

/**
 * Visualiza o prontu√°rio digital (criado no sistema) do cliente
 */
async function visualizarProntuarioDigital(clienteId) {
    try {
        const response = await fetch(`/api/clientes/${clienteId}`, {
            credentials: 'include'
        });
        const cliente = await response.json();

        if (!cliente.prontuario || Object.keys(cliente.prontuario).length === 0) {
            Swal.fire('Aviso', 'Este cliente ainda n√£o possui prontu√°rio digital cadastrado', 'info');
            return;
        }

        const prontuario = cliente.prontuario;

        let html = `
            <div class="text-start" style="max-height: 500px; overflow-y: auto;">
                <h5 class="mb-3"><i class="bi bi-person"></i> ${cliente.nome}</h5>
                <table class="table table-sm table-bordered">
                    <tbody>
        `;

        // Renderizar todos os campos do prontu√°rio
        for (let [key, value] of Object.entries(prontuario)) {
            if (key === '_id' || key === 'cliente_id') continue;

            const label = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            html += `
                <tr>
                    <td style="width: 40%; font-weight: bold;">${label}</td>
                    <td style="width: 60%;">${value || '-'}</td>
                </tr>
            `;
        }

        html += `
                    </tbody>
                </table>
            </div>
        `;

        Swal.fire({
            title: 'Prontu√°rio Digital',
            html: html,
            width: 800,
            showCloseButton: true,
            confirmButtonText: 'Fechar'
        });

    } catch (error) {
        console.error('Erro ao visualizar prontu√°rio digital:', error);
        Swal.fire('Erro', 'N√£o foi poss√≠vel carregar o prontu√°rio digital', 'error');
    }
}

/**
 * Visualiza os documentos f√≠sicos escaneados de prontu√°rio do cliente
 */
async function visualizarProntuarioFisico(clienteId) {
    try {
        const response = await fetch(`/api/clientes/${clienteId}/prontuario/documentos`, {
            credentials: 'include'
        });
        const result = await response.json();

        if (!result.documentos || result.documentos.length === 0) {
            Swal.fire('Aviso', 'Este cliente ainda n√£o possui documentos f√≠sicos de prontu√°rio', 'info');
            return;
        }

        let html = `
            <div class="text-start" style="max-height: 500px; overflow-y: auto;">
                <p class="mb-3"><strong>Cliente:</strong> ${result.cliente_nome}</p>
                <p class="mb-3"><strong>Total de documentos:</strong> ${result.documentos.length}</p>
        `;

        result.documentos.forEach((doc, index) => {
            const dataUpload = doc.data_upload ? new Date(doc.data_upload).toLocaleString('pt-BR') : 'Data desconhecida';
            html += `
                <div class="card mb-3">
                    <div class="card-header">
                        <strong>Documento ${index + 1}</strong>
                        <small class="text-muted float-end">${dataUpload}</small>
                    </div>
                    <div class="card-body text-center">
                        ${doc.tipo_arquivo === 'application/pdf' ?
                            `<embed src="${doc.arquivo_base64}" type="application/pdf" width="100%" height="400px" />` :
                            `<img src="${doc.arquivo_base64}" class="img-fluid" style="max-height: 400px;" />`
                        }
                    </div>
                </div>
            `;
        });

        html += '</div>';

        Swal.fire({
            title: 'Documentos F√≠sicos de Prontu√°rio',
            html: html,
            width: 900,
            showCloseButton: true,
            confirmButtonText: 'Fechar'
        });

    } catch (error) {
        console.error('Erro ao visualizar documentos f√≠sicos:', error);
        Swal.fire('Erro', 'N√£o foi poss√≠vel carregar os documentos f√≠sicos', 'error');
    }
}

/**
 * Abre modal para editar prontu√°rio do cliente
 */
async function editarProntuario(clienteId) {
    try {
        const response = await fetch(`/api/clientes/${clienteId}`, {
            credentials: 'include'
        });
        const cliente = await response.json();

        const prontuario = cliente.prontuario || {};

        const html = `
            <div class="text-start">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">Data do Atendimento</label>
                        <input type="date" id="data_atendimento" class="form-control" value="${prontuario.data_atendimento ? prontuario.data_atendimento.substring(0,10) : ''}">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Profissional Respons√°vel</label>
                        <input type="text" id="profissional" class="form-control" value="${prontuario.profissional || ''}">
                    </div>
                    <div class="col-12">
                        <label class="form-label">Procedimento Realizado</label>
                        <textarea id="procedimento" class="form-control" rows="2">${prontuario.procedimento || ''}</textarea>
                    </div>
                    <div class="col-12">
                        <label class="form-label">Observa√ß√µes do Atendimento</label>
                        <textarea id="observacoes_atendimento" class="form-control" rows="3">${prontuario.observacoes || ''}</textarea>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Produtos Utilizados</label>
                        <textarea id="produtos_utilizados" class="form-control" rows="2">${prontuario.produtos_utilizados || ''}</textarea>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Pr√≥xima Sess√£o</label>
                        <input type="date" id="proxima_sessao" class="form-control" value="${prontuario.proxima_sessao ? prontuario.proxima_sessao.substring(0,10) : ''}">
                    </div>
                    <div class="col-12">
                        <label class="form-label">Recomenda√ß√µes</label>
                        <textarea id="recomendacoes" class="form-control" rows="2">${prontuario.recomendacoes || ''}</textarea>
                    </div>
                </div>
            </div>
        `;

        const { value } = await Swal.fire({
            title: `Editar Prontu√°rio - ${cliente.nome}`,
            html: html,
            width: 800,
            showCancelButton: true,
            confirmButtonText: 'Salvar',
            cancelButtonText: 'Cancelar',
            preConfirm: () => {
                return {
                    data_atendimento: document.getElementById('data_atendimento').value,
                    profissional: document.getElementById('profissional').value.trim(),
                    procedimento: document.getElementById('procedimento').value.trim(),
                    observacoes: document.getElementById('observacoes_atendimento').value.trim(),
                    produtos_utilizados: document.getElementById('produtos_utilizados').value.trim(),
                    proxima_sessao: document.getElementById('proxima_sessao').value,
                    recomendacoes: document.getElementById('recomendacoes').value.trim()
                };
            }
        });

        if (value) {
            const updateResponse = await fetch(`/api/clientes/${clienteId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({ prontuario: value })
            });

            if (updateResponse.ok) {
                Swal.fire('Sucesso', 'Prontu√°rio atualizado com sucesso!', 'success');
                carregarListaProntuario();
            } else {
                Swal.fire('Erro', 'N√£o foi poss√≠vel atualizar o prontu√°rio', 'error');
            }
        }

    } catch (error) {
        console.error('Erro ao editar prontu√°rio:', error);
        Swal.fire('Erro', 'N√£o foi poss√≠vel carregar o prontu√°rio para edi√ß√£o', 'error');
    }
}

/**
 * Exclui o prontu√°rio do cliente (digital e documentos f√≠sicos)
 */
async function excluirProntuario(clienteId) {
    try {
        const result = await Swal.fire({
            title: 'Excluir Prontu√°rio?',
            html: `
                <p>Esta a√ß√£o ir√° remover:</p>
                <ul class="text-start">
                    <li>Prontu√°rio digital (preenchido no sistema)</li>
                    <li>Todos os documentos f√≠sicos escaneados</li>
                </ul>
                <p class="text-danger"><strong>Esta a√ß√£o n√£o pode ser desfeita!</strong></p>
            `,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Sim, excluir!',
            cancelButtonText: 'Cancelar'
        });

        if (result.isConfirmed) {
            const response = await fetch(`/api/clientes/${clienteId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({
                    prontuario: {},
                    documentos_prontuario: []
                })
            });

            if (response.ok) {
                Swal.fire('Exclu√≠do!', 'Prontu√°rio removido com sucesso', 'success');
                carregarListaProntuario();
            } else {
                Swal.fire('Erro', 'N√£o foi poss√≠vel excluir o prontu√°rio', 'error');
            }
        }

    } catch (error) {
        console.error('Erro ao excluir prontu√°rio:', error);
        Swal.fire('Erro', 'N√£o foi poss√≠vel excluir o prontu√°rio', 'error');
    }
}

/**
 * Faz upload de documento f√≠sico escaneado de prontu√°rio
 */
async function uploadProntuarioFisico(clienteId) {
    try {
        const response = await fetch(`/api/clientes/${clienteId}`, {
            credentials: 'include'
        });
        const cliente = await response.json();

        const { value: file } = await Swal.fire({
            title: `Upload de Prontu√°rio - ${cliente.nome}`,
            html: `
                <div class="text-start">
                    <p class="alert alert-info">
                        <i class="bi bi-info-circle"></i>
                        <strong>Dica:</strong> Escaneie o documento f√≠sico e fa√ßa upload da imagem ou PDF.
                    </p>
                    <label class="form-label">Selecione o arquivo (imagem ou PDF)</label>
                    <input type="file" id="arquivo-prontuario" class="form-control" accept="image/*,application/pdf">
                </div>
            `,
            width: 600,
            showCancelButton: true,
            confirmButtonText: 'Upload',
            cancelButtonText: 'Cancelar',
            preConfirm: () => {
                const fileInput = document.getElementById('arquivo-prontuario');
                if (!fileInput.files || fileInput.files.length === 0) {
                    Swal.showValidationMessage('Por favor, selecione um arquivo');
                    return false;
                }
                return fileInput.files[0];
            }
        });

        if (file) {
            // Mostrar loading
            Swal.fire({
                title: 'Fazendo upload...',
                html: 'Por favor aguarde',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            const formData = new FormData();
            formData.append('arquivo', file);

            const uploadResponse = await fetch(`/api/clientes/${clienteId}/prontuario/upload`, {
                method: 'POST',
                credentials: 'include',
                body: formData
            });

            if (uploadResponse.ok) {
                Swal.fire('Sucesso', 'Documento enviado com sucesso!', 'success');
                carregarListaProntuario();
            } else {
                const errorData = await uploadResponse.json();
                Swal.fire('Erro', errorData.error || 'N√£o foi poss√≠vel fazer upload do documento', 'error');
            }
        }

    } catch (error) {
        console.error('Erro ao fazer upload:', error);
        Swal.fire('Erro', 'N√£o foi poss√≠vel fazer upload do documento', 'error');
    }
}

// ========================================================================================

async function loadProfissionais(){
    const key = 'loadProfissionais';

    // PROTE√á√ÉO ANTI-LOOP
    if (isLoading(key)) {
        console.warn(`‚ö†Ô∏è J√° carregando: ${key}`);
        return;
    }

    setLoading(key, true);

    try{
        const res=await fetch('/api/profissionais',{credentials:'include'});
        const data=await res.json();
        const tbody=document.getElementById('profissionaisBody');
        if(data.success&&data.profissionais&&data.profissionais.length>0){
            const html=data.profissionais.map(p=>{
                const assistentes = (p.assistentes||[]).map(a=>a.nome||a).join(', ') || '-';
                const fotoHtml = exibirFotoProfissional(p.foto);
                return `<tr data-id="${p._id}">
                    <td>${fotoHtml}</td>
                    <td><strong>${p.nome}</strong></td>
                    <td>${p.cpf||'-'}</td>
                    <td>${p.especialidade||'-'}</td>
                    <td>${p.comissao_perc||0}%</td>
                    <td>${assistentes}</td>
                    <td><span class="badge ${p.ativo?'success':'danger'}">${p.ativo?'Ativo':'Inativo'}</span></td>
                    <td>
                        <button class="bioma-btn bioma-btn-sm bioma-btn-outline" onclick="uploadFotoProfissional('${p._id}')" title="Upload Foto">
                            <i class="bi bi-camera"></i>
                        </button>
                        <button class="bioma-btn bioma-btn-sm bioma-btn-info" onclick="visualizarProfissional('${p._id}')" style="background:linear-gradient(135deg,#3B82F6,#2563EB);color:#fff;margin-right:5px">
                            <i class="bi bi-eye"></i>
                        </button>
                        <button class="bioma-btn bioma-btn-sm bioma-btn-primary" onclick="editarProfissional('${p._id}')" style="margin-right:5px">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="bioma-btn bioma-btn-sm bioma-btn-danger" onclick="deleteProfissional('${p._id}')">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>`;
            }).join('');
            tbody.innerHTML=html;
        }else{
            tbody.innerHTML='<tr data-keep-visible="true"><td colspan="8" class="text-center text-muted">Nenhum</td></tr>';
        }
    }catch(e){
        console.error(e);
    } finally {
        setTimeout(() => setLoading(key, false), 250);
    }
}

// Fun√ß√£o para carregar lista de assistentes
async function loadAssistentes() {
    const key = 'loadAssistentes';
    if (isLoading(key)) {
        console.warn(`‚ö†Ô∏è J√° carregando: ${key}`);
        return;
    }
    setLoading(key, true);

    try {
        const res = await fetch('/api/assistentes', {credentials: 'include'});
        const data = await res.json();
        const tbody = document.getElementById('assistentesBody');

        if (data.success && data.assistentes && data.assistentes.length > 0) {
            const html = data.assistentes.map(a => {
                const profissionalNome = a.profissional?.nome || 'Independente';
                return `<tr>
                    <td><strong>${a.nome}</strong></td>
                    <td>${a.cpf || '-'}</td>
                    <td>${profissionalNome}</td>
                    <td>10%</td>
                    <td><span class="badge ${a.ativo ? 'success' : 'danger'}">${a.ativo ? 'Ativo' : 'Inativo'}</span></td>
                    <td>
                        <button class="bioma-btn bioma-btn-sm bioma-btn-danger" onclick="deleteAssistente('${a._id}')">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>`;
            }).join('');
            tbody.innerHTML = html;
        } else {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Nenhum assistente cadastrado</td></tr>';
        }
    } catch(e) {
        console.error('Erro ao carregar assistentes:', e);
    } finally {
        setTimeout(() => setLoading(key, false), 250);
    }
}

async function deleteAssistente(id) {
    const result = await Swal.fire({
        title: 'Deletar assistente?',
        icon: 'warning',
        showCancelButton: true
    });

    if (result.isConfirmed) {
        try {
            await fetch(`/api/assistentes/${id}`, {method: 'DELETE', credentials: 'include'});
            Swal.fire('Deletado!', '', 'success');
            loadAssistentes();
        } catch(e) {
            Swal.fire('Erro', '', 'error');
        }
    }

}

async function deleteProfissional(id){
    const result=await Swal.fire({title:'Deletar profissional?',text:'Esta a√ß√£o n√£o pode ser desfeita',icon:'warning',showCancelButton:true,confirmButtonText:'Sim, deletar',cancelButtonText:'Cancelar'});
    if(result.isConfirmed){
        try{
            const response = await fetchWithTimeout(`/api/profissionais/${id}`, {method:'DELETE',credentials:'include'}, 30000, 1);
            const data = await response.json();
            if(data.success){
                Swal.fire('Deletado!','Profissional removido com sucesso','success');
                await autoRefreshAfterOperation('profissionais'); // v7.1: Auto-refresh
            }else{
                Swal.fire('Erro',data.message || 'Erro ao deletar profissional','error');
            }
        }catch(e){
            console.error('Erro ao deletar profissional:',e);
            Swal.fire('Erro','N√£o foi poss√≠vel deletar o profissional','error');
        }
    }

}

function showModalProfissional(){
    Swal.fire({
        title:'Novo Profissional',
        html:`<input type="text" id="swal-prof-nome" class="form-control mb-3" placeholder="Nome"><input type="text" id="swal-prof-cpf" class="form-control mb-3" placeholder="CPF"><input type="text" id="swal-prof-espec" class="form-control mb-3" placeholder="Especialidade"><input type="number" id="swal-prof-comissao" class="form-control" placeholder="Comiss√£o %" value="10">`,
        showCancelButton:true,
        allowEscapeKey: true,
        allowOutsideClick: true,
        showCloseButton: true,
        preConfirm:()=>{
        const nome=document.getElementById('swal-prof-nome').value;
        const cpf=document.getElementById('swal-prof-cpf').value;
        if(!nome){Swal.showValidationMessage('Nome √© obrigat√≥rio');return false;}
        return {nome,cpf,especialidade:document.getElementById('swal-prof-espec').value,comissao_perc:document.getElementById('swal-prof-comissao').value};
    }}).then(async(result)=>{
        if(result.isConfirmed){
            try{
                await fetch('/api/profissionais',{method:'POST',headers:{'Content-Type':'application/json'},credentials:'include',body:JSON.stringify(result.value)});
                Swal.fire('Sucesso!','','success');
                await loadProfissionais();
            }catch(e){
                Swal.fire('Erro','','error');
            }
        }
    });
}

// Fun√ß√£o para cadastrar assistente independente
function cadastrarAssistenteIndependente(){
    Swal.fire({
        title:'üë• Cadastrar Assistente',
        html:`
            <div style="text-align: left;">
                <div class="mb-3">
                    <label class="form-label"><i class="bi bi-person"></i> Nome Completo *</label>
                    <input type="text" id="swal-nome-assist" class="form-control" placeholder="Ex: Maria Silva">
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <label class="form-label"><i class="bi bi-card-text"></i> CPF *</label>
                        <input type="text" id="swal-cpf-assist" class="form-control" placeholder="000.000.000-00">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label"><i class="bi bi-telephone"></i> Telefone</label>
                        <input type="text" id="swal-tel-assist" class="form-control" placeholder="(00) 00000-0000">
                    </div>
                </div>

                <div class="mb-3 mt-3">
                    <label class="form-label"><i class="bi bi-envelope"></i> E-mail</label>
                    <input type="email" id="swal-email-assist" class="form-control" placeholder="assistente@email.com">
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <label class="form-label"><i class="bi bi-percent"></i> Comiss√£o (%)</label>
                        <input type="number" id="swal-comissao-assist" class="form-control" placeholder="10" value="10" min="0" max="100">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label"><i class="bi bi-briefcase"></i> Tipo</label>
                        <select id="swal-tipo-assist" class="form-select">
                            <option value="assistente">Assistente</option>
                            <option value="auxiliar">Auxiliar</option>
                            <option value="recepcionista">Recepcionista</option>
                        </select>
                    </div>
                </div>

                <div class="mt-3">
                    <label class="form-label"><i class="bi bi-chat-text"></i> Observa√ß√µes</label>
                    <textarea id="swal-obs-assist" class="form-control" rows="2" placeholder="Informa√ß√µes adicionais (opcional)"></textarea>
                </div>
            </div>
        `,
        showCancelButton:true,
        confirmButtonText: '<i class="bi bi-check-circle"></i> Cadastrar',
        cancelButtonText: '<i class="bi bi-x-circle"></i> Cancelar',
        confirmButtonColor: '#10B981',
        cancelButtonColor: '#6c757d',
        allowEscapeKey: true,
        allowOutsideClick: true,
        showCloseButton: true,
        width: '650px',
        preConfirm:()=>{
            const nome=document.getElementById('swal-nome-assist').value;
            const cpf=document.getElementById('swal-cpf-assist').value;
            if(!nome||!cpf){
                Swal.showValidationMessage('Nome e CPF s√£o obrigat√≥rios');
                return false;
            }
            return {
                nome,
                cpf,
                email: document.getElementById('swal-email-assist').value || '',
                telefone: document.getElementById('swal-tel-assist').value || '',
                comissao_perc: document.getElementById('swal-comissao-assist').value || 10,
                tipo: 'assistente'
            };
        }
    }).then(async(result)=>{
        if(result.isConfirmed){
            try{
                const response = await fetch('/api/assistentes',{
                    method:'POST',
                    headers:{'Content-Type':'application/json'},
                    credentials:'include',
                    body:JSON.stringify(result.value)
                });

                const data = await response.json();

                if (data.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Assistente Cadastrado!',
                        text: `${result.value.nome} foi cadastrado com sucesso`,
                        timer: 2500
                    });
                    loadAssistentes(); // Recarregar lista de assistentes
                } else {
                    throw new Error(data.message || 'Erro ao cadastrar');
                }
            }catch(e){
                console.error('Erro ao cadastrar assistente:', e);
                Swal.fire({
                    icon: 'error',
                    title: 'Erro',
                    text: e.message || 'N√£o foi poss√≠vel cadastrar o assistente'
                });
            }
        }
    });
}

// ========== FUN√á√ïES PARA SUB-ABA "NOVO PROFISSIONAL" ====================

// Vari√°vel global para armazenar foto do novo profissional
let fotoNovoProfissional = null;

/**
 * Preview da foto do profissional ao selecionar arquivo
 */
function previewFotoProfissionalNovo(event) {
    const file = event.target.files[0];
    if (file) {
        // Validar tamanho (m√°x 5MB)
        if (file.size > 5 * 1024 * 1024) {
            Swal.fire({
                icon: 'error',
                title: 'Arquivo muito grande',
                text: 'A foto deve ter no m√°ximo 5MB',
                timer: 3000
            });
            return;
        }

        // Validar tipo
        if (!file.type.startsWith('image/')) {
            Swal.fire({
                icon: 'error',
                title: 'Tipo inv√°lido',
                text: 'Apenas imagens s√£o permitidas',
                timer: 3000
            });
            return;
        }

        // Criar preview
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('previewFotoProfissional').src = e.target.result;
            fotoNovoProfissional = file; // Armazenar arquivo
        };
        reader.readAsDataURL(file);
    }
}

/**
 * Limpar formul√°rio de novo profissional
 */
function limparFormularioNovoProfissional() {
    document.getElementById('novoProfNome').value = '';
    document.getElementById('novoProfCPF').value = '';
    document.getElementById('novoProfEmail').value = '';
    document.getElementById('novoProfTelefone').value = '';
    document.getElementById('novoProfEspecialidade').value = '';
    document.getElementById('novoProfComissao').value = '10';
    document.getElementById('novoProfObservacoes').value = '';
    document.getElementById('inputFotoProfissional').value = '';
    document.getElementById('previewFotoProfissional').src = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='120'%3E%3Crect fill='%23E5E7EB' width='120' height='120'/%3E%3Ctext x='50%25' y='50%25' font-size='48' text-anchor='middle' dy='.3em' fill='%239CA3AF'%3Eüë§%3C/text%3E%3C/svg%3E";
    fotoNovoProfissional = null;
    console.log('‚úÖ Formul√°rio de novo profissional limpo');
}

/**
 * Salvar novo profissional com foto
 */
async function salvarNovoProfissional() {
    // Validar campos obrigat√≥rios
    const nome = document.getElementById('novoProfNome').value.trim();
    const cpf = document.getElementById('novoProfCPF').value.trim();
    const especialidade = document.getElementById('novoProfEspecialidade').value.trim();
    const comissao = document.getElementById('novoProfComissao').value;

    if (!nome || !cpf || !especialidade) {
        Swal.fire({
            icon: 'warning',
            title: 'Campos obrigat√≥rios',
            text: 'Preencha Nome, CPF e Especialidade',
            showConfirmButton: true,
            allowOutsideClick: false
        });
        return;
    }

    try {
        // Mostrar loading
        Swal.fire({
            title: 'Salvando...',
            html: 'Cadastrando profissional no sistema',
            allowOutsideClick: false,
            allowEscapeKey: false,
            showConfirmButton: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });

        // PASSO 1: Criar profissional com JSON (sem foto)
        const profissionalData = {
            nome: nome,
            cpf: cpf,
            email: document.getElementById('novoProfEmail').value.trim(),
            telefone: document.getElementById('novoProfTelefone').value.trim(),
            especialidade: especialidade,
            comissao_perc: parseFloat(comissao),
            observacoes: document.getElementById('novoProfObservacoes').value.trim()
        };

        const response = await fetch('/api/profissionais', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'include',
            body: JSON.stringify(profissionalData)
        });

        const data = await response.json();

        if (!data.success) {
            throw new Error(data.message || 'Erro ao cadastrar profissional');
        }

        // PASSO 2: Se houver foto, fazer upload separado
        if (fotoNovoProfissional && data.id) {
            Swal.update({
                html: 'Enviando foto do profissional...'
            });

            const formData = new FormData();
            formData.append('foto', fotoNovoProfissional);

            const fotoResponse = await fetch(`/api/profissionais/${data.id}/upload-foto`, {
                method: 'POST',
                credentials: 'include',
                body: formData
            });

            const fotoData = await fotoResponse.json();

            if (!fotoData.success) {
                console.warn('‚ö†Ô∏è Profissional criado, mas foto n√£o foi enviada:', fotoData.message);
            }
        }

        // Sucesso!
        Swal.fire({
            icon: 'success',
            title: 'Profissional cadastrado!',
            html: `<strong>${nome}</strong> foi adicionado √† equipe`,
            showConfirmButton: false,
            allowOutsideClick: false,
            allowEscapeKey: false
        });

        // Limpar formul√°rio
        limparFormularioNovoProfissional();

        // Recarregar lista
        loadProfissionais();

        // Voltar para aba de lista ap√≥s 2 segundos
        setTimeout(() => {
            Swal.close();
            showSubTab('profissionais', 'lista');
        }, 2000);

    } catch (error) {
        console.error('‚ùå Erro ao salvar profissional:', error);
        Swal.fire({
            icon: 'error',
            title: 'Erro no servidor',
            text: error.message || 'N√£o foi poss√≠vel salvar o profissional',
            showConfirmButton: true,
            allowOutsideClick: false
        });
    }
}

// ========== NOVO CLIENTE - FUN√á√ïES COMPLETAS ====================

let fotoNovoCliente = null;

/**
 * Preview da foto do cliente ao selecionar arquivo
 */
function previewFotoClienteNovo(event) {
    const file = event.target.files[0];
    if (file) {
        // Validar tamanho (m√°x 5MB)
        if (file.size > 5 * 1024 * 1024) {
            Swal.fire({
                icon: 'error',
                title: 'Arquivo muito grande',
                text: 'A foto deve ter no m√°ximo 5MB',
                timer: 3000
            });
            return;
        }

        // Validar tipo
        if (!file.type.startsWith('image/')) {
            Swal.fire({
                icon: 'error',
                title: 'Tipo inv√°lido',
                text: 'Apenas imagens s√£o permitidas',
                timer: 3000
            });
            return;
        }

        // Criar preview
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('previewFotoCliente').src = e.target.result;
            fotoNovoCliente = file; // Armazenar arquivo
        };
        reader.readAsDataURL(file);
    }
}

/**
 * Limpar formul√°rio de novo cliente
 */
function limparFormularioNovoCliente() {
    document.getElementById('novoClienteNome').value = '';
    document.getElementById('novoClienteCPF').value = '';
    document.getElementById('novoClienteEmail').value = '';
    document.getElementById('novoClienteTelefone').value = '';
    document.getElementById('novoClienteDataNasc').value = '';
    document.getElementById('novoClienteCEP').value = '';
    document.getElementById('novoClienteEstado').value = '';
    document.getElementById('novoClienteCidade').value = '';
    document.getElementById('novoClienteBairro').value = '';
    document.getElementById('novoClienteRua').value = '';
    document.getElementById('novoClienteNumero').value = '';
    document.getElementById('novoClienteObservacoes').value = '';
    document.getElementById('inputFotoCliente').value = '';
    document.getElementById('previewFotoCliente').src = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='120'%3E%3Crect width='120' height='120' fill='%23e0e7ff'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-family='Arial, sans-serif' font-size='48' fill='%237c3aed'%3E%F0%9F%91%A4%3C/text%3E%3C/svg%3E";
    fotoNovoCliente = null;
    console.log('‚úÖ Formul√°rio de novo cliente limpo');
}

/**
 * Salvar novo cliente com foto e dados completos
 */
async function salvarNovoCliente() {
    // Validar campos obrigat√≥rios
    const nome = document.getElementById('novoClienteNome').value.trim();
    const cpf = document.getElementById('novoClienteCPF').value.trim();
    const telefone = document.getElementById('novoClienteTelefone').value.trim();

    if (!nome || !cpf || !telefone) {
        Swal.fire({
            icon: 'warning',
            title: 'Campos obrigat√≥rios',
            text: 'Preencha Nome, CPF e Telefone',
            timer: 3000
        });
        return;
    }

    try {
        // Criar FormData para enviar com foto
        const formData = new FormData();
        formData.append('nome', nome);
        formData.append('cpf', cpf);
        formData.append('email', document.getElementById('novoClienteEmail').value.trim());
        formData.append('telefone', telefone);
        formData.append('data_nascimento', document.getElementById('novoClienteDataNasc').value);

        // Endere√ßo completo
        formData.append('cep', document.getElementById('novoClienteCEP').value.trim());
        formData.append('estado', document.getElementById('novoClienteEstado').value.trim());
        formData.append('cidade', document.getElementById('novoClienteCidade').value.trim());
        formData.append('bairro', document.getElementById('novoClienteBairro').value.trim());
        formData.append('rua', document.getElementById('novoClienteRua').value.trim());
        formData.append('numero', document.getElementById('novoClienteNumero').value.trim());
        formData.append('observacoes', document.getElementById('novoClienteObservacoes').value.trim());

        // Adicionar foto se houver
        if (fotoNovoCliente) {
            formData.append('foto', fotoNovoCliente);
        }

        // Mostrar loading
        Swal.fire({
            title: 'Salvando...',
            html: 'Cadastrando cliente no sistema',
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });

        // Enviar para API
        const response = await fetch('/api/clientes', {
            method: 'POST',
            credentials: 'include',
            body: formData // N√£o setar Content-Type - deixar o browser fazer
        });

        const data = await response.json();

        if (data.success) {
            Swal.fire({
                icon: 'success',
                title: 'Cliente cadastrado!',
                html: `<strong>${nome}</strong> foi adicionado aos clientes`,
                timer: 2500,
                showConfirmButton: false
            });

            // Limpar formul√°rio
            limparFormularioNovoCliente();

            // Recarregar lista
            await loadClientes();

            // Voltar para aba de lista
            setTimeout(() => {
                showSubTab('clientes', 'lista');
            }, 2500);
        } else {
            Swal.fire({
                icon: 'error',
                title: 'Erro ao cadastrar',
                text: data.message || 'Verifique os dados e tente novamente'
            });
        }
    } catch (error) {
        console.error('‚ùå Erro ao salvar cliente:', error);
        Swal.fire({
            icon: 'error',
            title: 'Erro no servidor',
            text: 'N√£o foi poss√≠vel salvar o cliente'
        });
    }
}

// ========== NOVO SERVI√áO - FUN√á√ïES COMPLETAS ====================

/**
 * Limpar formul√°rio de novo servi√ßo
 */
function limparFormularioNovoServico() {
    document.getElementById('novoServicoNome').value = '';
    document.getElementById('novoServicoCategoria').value = '';
    document.getElementById('novoServicoTamanho').value = '';
    document.getElementById('novoServicoPreco').value = '';
    document.getElementById('novoServicoDuracao').value = '';
    document.getElementById('novoServicoComissao').value = '10';
    document.getElementById('novoServicoDescricao').value = '';
    document.getElementById('novoServicoStatus').value = 'ativo';
    console.log('‚úÖ Formul√°rio de novo servi√ßo limpo');
}

/**
 * Salvar novo servi√ßo
 */
async function salvarNovoServico() {
    // Validar campos obrigat√≥rios
    const nome = document.getElementById('novoServicoNome').value.trim();
    const categoria = document.getElementById('novoServicoCategoria').value;
    const tamanho = document.getElementById('novoServicoTamanho').value;
    const preco = document.getElementById('novoServicoPreco').value;
    const status = document.getElementById('novoServicoStatus').value;

    if (!nome || !categoria || !tamanho || !preco) {
        Swal.fire({
            icon: 'warning',
            title: 'Campos obrigat√≥rios',
            text: 'Preencha Nome, Categoria, Tamanho e Pre√ßo',
            timer: 3000
        });
        return;
    }

    try {
        // Criar objeto com dados do servi√ßo
        const servicoData = {
            nome: nome,
            categoria: categoria,
            tamanho: tamanho,
            preco: parseFloat(preco),
            duracao_minutos: parseInt(document.getElementById('novoServicoDuracao').value) || 0,
            comissao_perc: parseFloat(document.getElementById('novoServicoComissao').value) || 10,
            descricao: document.getElementById('novoServicoDescricao').value.trim(),
            ativo: status === 'ativo'
        };

        // Mostrar loading
        Swal.fire({
            title: 'Salvando...',
            html: 'Cadastrando servi√ßo no sistema',
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });

        // Enviar para API
        const response = await fetch('/api/servicos', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'include',
            body: JSON.stringify(servicoData)
        });

        const data = await response.json();

        if (data.success) {
            Swal.fire({
                icon: 'success',
                title: 'Servi√ßo cadastrado!',
                html: `<strong>${nome}</strong> foi adicionado aos servi√ßos`,
                timer: 2500,
                showConfirmButton: false
            });

            // Limpar formul√°rio
            limparFormularioNovoServico();

            // Recarregar lista (v7.1: Auto-refresh otimizado)
            await autoRefreshAfterOperation('servicos');

            // Voltar para aba de todos
            setTimeout(() => {
                switchSubTab('servicos', 'todos');
            }, 2500);
        } else {
            Swal.fire({
                icon: 'error',
                title: 'Erro ao cadastrar',
                text: data.message || 'Verifique os dados e tente novamente'
            });
        }
    } catch (error) {
        console.error('‚ùå Erro ao salvar servi√ßo:', error);
        Swal.fire({
            icon: 'error',
            title: 'Erro no servidor',
            text: 'N√£o foi poss√≠vel salvar o servi√ßo'
        });
    }
}

// ========== NOVO PRODUTO - FUN√á√ïES COMPLETAS ====================

/**
 * Editar estoque inline (diretamente na tabela)
 */
async function editarEstoqueInline(produtoId, estoqueAtual) {
    const { value: novoEstoque } = await Swal.fire({
        title: 'üì¶ Ajustar Estoque',
        input: 'number',
        inputLabel: 'Quantidade em estoque',
        inputValue: estoqueAtual,
        inputAttributes: {
            min: 0,
            step: 1
        },
        showCancelButton: true,
        confirmButtonText: '<i class="bi bi-check-circle"></i> Salvar',
        cancelButtonText: '<i class="bi bi-x-circle"></i> Cancelar',
        confirmButtonColor: '#10B981',
        cancelButtonColor: '#6c757d',
        inputValidator: (value) => {
            if (!value || value < 0) {
                return 'Digite uma quantidade v√°lida (m√≠nimo: 0)';
            }
        }
    });

    if (novoEstoque !== undefined) {
        try {
            mostrarLoading('Atualizando estoque...');

            const res = await fetch(`/api/produtos/${produtoId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({ estoque: parseInt(novoEstoque) })
            });

            const data = await res.json();
            Swal.close();

            if (data.success) {
                mostrarNotificacao('success', `Estoque atualizado: ${novoEstoque} unidades`);

                // Recarregar produtos
                if (document.getElementById('produtosTodosBody')) {
                    loadProdutosLista();
                }
                if (document.getElementById('estoqueTableBody')) {
                    loadEstoque();
                }
            } else {
                throw new Error(data.message || 'Erro ao atualizar estoque');
            }
        } catch (error) {
            console.error('‚ùå Erro ao atualizar estoque:', error);
            Swal.fire({
                icon: 'error',
                title: 'Erro',
                text: error.message || 'N√£o foi poss√≠vel atualizar o estoque'
            });
        }
    }
}

/**
 * Editar produto existente
 */
async function editarProduto(id) {
    try {
        // Buscar dados do produto
        const res = await fetch(`/api/produtos/${id}`, { credentials: 'include' });
        const data = await res.json();

        if (!data.success || !data.produto) {
            throw new Error('Produto n√£o encontrado');
        }

        const p = data.produto;

        // Criar formul√°rio de edi√ß√£o
        const html = `
            <div class="text-start">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">Nome *</label>
                        <input type="text" id="swal-nome" class="form-control" value="${p.nome || ''}">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Marca</label>
                        <input type="text" id="swal-marca" class="form-control" value="${p.marca || ''}">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">SKU</label>
                        <input type="text" id="swal-sku" class="form-control" value="${p.sku || ''}">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">C√≥digo de Barras</label>
                        <input type="text" id="swal-codigo-barras" class="form-control" value="${p.codigo_barras || 'Sem c√≥digo de barras no momento'}" placeholder="C√≥digo de barras do produto">
                    </div>
                    <div class="col-md-12">
                        <label class="form-label">Categoria</label>
                        <input type="text" id="swal-categoria" class="form-control" value="${p.categoria || ''}">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Pre√ßo *</label>
                        <input type="number" id="swal-preco" class="form-control" step="0.01" value="${p.preco || 0}">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Estoque Atual</label>
                        <input type="number" id="swal-estoque" class="form-control" value="${p.estoque || p.estoque_atual || 0}">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Estoque M√≠nimo</label>
                        <input type="number" id="swal-estoque-minimo" class="form-control" value="${p.estoque_minimo || 0}">
                    </div>
                    <div class="col-md-12">
                        <label class="form-label">Status</label>
                        <select id="swal-status" class="form-select">
                            <option value="Ativo" ${p.status === 'Ativo' ? 'selected' : ''}>Ativo</option>
                            <option value="Inativo" ${p.status === 'Inativo' ? 'selected' : ''}>Inativo</option>
                        </select>
                    </div>
                </div>
            </div>
        `;

        // Mostrar modal de edi√ß√£o
        const { value } = await Swal.fire({
            title: 'Editar Produto',
            html: html,
            width: 720,
            showCancelButton: true,
            confirmButtonText: 'Salvar',
            cancelButtonText: 'Cancelar',
            allowEscapeKey: true,
            allowOutsideClick: true,
            showCloseButton: true,
            focusConfirm: false,
            preConfirm: () => {
                const nome = document.getElementById('swal-nome').value.trim();
                const preco = document.getElementById('swal-preco').value;

                if (!nome) {
                    Swal.showValidationMessage('Nome √© obrigat√≥rio');
                    return false;
                }

                if (!preco || parseFloat(preco) <= 0) {
                    Swal.showValidationMessage('Pre√ßo inv√°lido');
                    return false;
                }

                return {
                    nome: nome,
                    marca: document.getElementById('swal-marca').value.trim(),
                    sku: document.getElementById('swal-sku').value.trim(),
                    codigo_barras: document.getElementById('swal-codigo-barras').value.trim(),
                    categoria: document.getElementById('swal-categoria').value.trim(),
                    preco: parseFloat(preco),
                    estoque: parseInt(document.getElementById('swal-estoque').value) || 0,
                    estoque_minimo: parseInt(document.getElementById('swal-estoque-minimo').value) || 0,
                    status: document.getElementById('swal-status').value
                };
            }
        });

        // Se confirmado, enviar atualiza√ß√£o
        if (value) {
            try {
                const updateRes = await fetch(`/api/produtos/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(value)
                });

                const updateData = await updateRes.json();

                if (updateData.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Sucesso!',
                        text: 'Produto atualizado com sucesso',
                        timer: 2000
                    });
                    // Recarregar lista de produtos
                    loadProdutosLista();
                } else {
                    throw new Error(updateData.message || 'Erro ao atualizar produto');
                }
            } catch (error) {
                console.error('‚ùå Erro ao atualizar produto:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Erro',
                    text: error.message || 'N√£o foi poss√≠vel atualizar o produto'
                });
            }
        }

    } catch (error) {
        console.error('‚ùå Erro ao carregar produto para edi√ß√£o:', error);
        Swal.fire({
            icon: 'error',
            title: 'Erro',
            text: error.message || 'N√£o foi poss√≠vel carregar os detalhes do produto'
        });
    }
}

/**
 * Limpar formul√°rio de novo produto
 */
function limparFormularioNovoProduto() {
    document.getElementById('novoProdutoNome').value = '';
    document.getElementById('novoProdutoMarca').value = '';
    document.getElementById('novoProdutoCodigoBarras').value = '';
    document.getElementById('novoProdutoFornecedor').value = '';
    document.getElementById('novoProdutoPrecoCusto').value = '';
    document.getElementById('novoProdutoPrecoVenda').value = '';
    document.getElementById('novoProdutoEstoqueAtual').value = '';
    document.getElementById('novoProdutoEstoqueMinimo').value = '0';
    document.getElementById('novoProdutoStatus').value = 'ativo';
    document.getElementById('novoProdutoDescricao').value = '';
    console.log('‚úÖ Formul√°rio de novo produto limpo');
}

/**
 * Salvar novo produto
 */
async function salvarNovoProduto() {
    // Validar campos obrigat√≥rios
    const nome = document.getElementById('novoProdutoNome').value.trim();
    const precoVenda = document.getElementById('novoProdutoPrecoVenda').value;
    const estoqueAtual = document.getElementById('novoProdutoEstoqueAtual').value;
    const status = document.getElementById('novoProdutoStatus').value;

    if (!nome || !precoVenda || estoqueAtual === '') {
        Swal.fire({
            icon: 'warning',
            title: 'Campos obrigat√≥rios',
            text: 'Preencha Nome, Pre√ßo de Venda e Estoque Atual',
            timer: 3000
        });
        return;
    }

    try {
        // Criar objeto com dados do produto
        const produtoData = {
            nome: nome,
            marca: document.getElementById('novoProdutoMarca').value.trim(),
            codigo_barras: document.getElementById('novoProdutoCodigoBarras').value.trim(),
            fornecedor: document.getElementById('novoProdutoFornecedor').value.trim(),
            preco_custo: parseFloat(document.getElementById('novoProdutoPrecoCusto').value) || 0,
            preco_venda: parseFloat(precoVenda),
            estoque_atual: parseInt(estoqueAtual),
            estoque_minimo: parseInt(document.getElementById('novoProdutoEstoqueMinimo').value) || 0,
            descricao: document.getElementById('novoProdutoDescricao').value.trim(),
            ativo: status === 'ativo'
        };

        // Mostrar loading
        Swal.fire({
            title: 'Salvando...',
            html: 'Cadastrando produto no sistema',
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });

        // Enviar para API
        const response = await fetch('/api/produtos', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'include',
            body: JSON.stringify(produtoData)
        });

        const data = await response.json();

        if (data.success) {
            Swal.fire({
                icon: 'success',
                title: 'Produto cadastrado!',
                html: `<strong>${nome}</strong> foi adicionado ao estoque`,
                timer: 2500,
                showConfirmButton: false
            });

            // Limpar formul√°rio
            limparFormularioNovoProduto();

            // Recarregar lista
            loadProdutos();

            // Voltar para aba de todos
            setTimeout(() => {
                switchSubTab('produtos', 'todos');
            }, 2500);
        } else {
            Swal.fire({
                icon: 'error',
                title: 'Erro ao cadastrar',
                text: data.message || 'Verifique os dados e tente novamente'
            });
        }
    } catch (error) {
        console.error('‚ùå Erro ao salvar produto:', error);
        Swal.fire({
            icon: 'error',
            title: 'Erro no servidor',
            text: 'N√£o foi poss√≠vel salvar o produto'
        });
    }
}

// ========== CALEND√ÅRIO DE PROFISSIONAIS ====================

// Vari√°vel global para armazenar inst√¢ncia do calend√°rio
let calendarioProfissionaisInstance = null;

// Paleta de cores para profissionais (12 cores vibrantes e distintas)
const CORES_PROFISSIONAIS = [
    '#7C3AED', // Roxo (primary)
    '#EC4899', // Rosa (secondary)
    '#10B981', // Verde
    '#F59E0B', // Laranja
    '#3B82F6', // Azul
    '#EF4444', // Vermelho
    '#8B5CF6', // Roxo claro
    '#14B8A6', // Teal
    '#F472B6', // Rosa claro
    '#FCD34D', // Amarelo
    '#60A5FA', // Azul claro
    '#34D399'  // Verde claro
];

// Fun√ß√£o para obter cor de um profissional (hash determin√≠stico)
function getCorProfissional(profissionalId, profissionais) {
    if (!profissionais) return CORES_PROFISSIONAIS[0];
    const index = profissionais.findIndex(p => p._id === profissionalId);
    return CORES_PROFISSIONAIS[index % CORES_PROFISSIONAIS.length];
}

// Fun√ß√£o para inicializar o calend√°rio
async function inicializarCalendario() {
    console.log('üìÖ Inicializando calend√°rio de profissionais...');

    try {
        // Buscar profissionais para preencher filtro e legenda
        const resProfissionais = await fetch('/api/profissionais', {credentials: 'include'});
        const dataProfissionais = await resProfissionais.json();

        if (!dataProfissionais.success || !dataProfissionais.profissionais) {
            console.error('Erro ao carregar profissionais');
            return;
        }

        const profissionais = dataProfissionais.profissionais;

        // Preencher select de filtro
        const selectFiltro = document.getElementById('filtroCalendarioProfissional');
        if (selectFiltro) {
            const optionsHTML = profissionais.map(p =>
                `<option value="${p._id}">${p.nome} - ${p.especialidade || 'Profissional'}</option>`
            ).join('');
            selectFiltro.innerHTML = '<option value="">Todos os Profissionais</option>' + optionsHTML;
        }

        // Criar legenda de cores COM FOTOS e nomes coloridos
        const legendaDiv = document.getElementById('legendaProfissionais');
        if (legendaDiv) {
            const legendaHTML = profissionais.map((p, index) => {
                const cor = CORES_PROFISSIONAIS[index % CORES_PROFISSIONAIS.length];

                // Gerar foto do profissional ou fallback
                let fotoHTML;
                if (p.foto && p.foto !== '') {
                    // Tem foto - mostrar imagem
                    fotoHTML = `<img src="${p.foto}" alt="${p.nome}" style="width: 35px; height: 35px; border-radius: 50%; object-fit: cover; border: 3px solid ${cor}; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">`;
                } else {
                    // Sem foto - mostrar iniciais com cor do profissional
                    const iniciais = p.nome.split(' ').map(n => n[0]).slice(0, 2).join('').toUpperCase();
                    fotoHTML = `<div style="width: 35px; height: 35px; border-radius: 50%; background: ${cor}; display: flex; align-items: center; justify-content: center; color: #fff; font-weight: 700; font-size: 0.85rem; border: 2px solid #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">${iniciais}</div>`;
                }

                return `<div style="display: flex; align-items: center; gap: 10px; padding: 5px 10px; background: rgba(255,255,255,0.05); border-radius: 10px; transition: all 0.3s;" onmouseenter="this.style.background='rgba(255,255,255,0.1)'; this.style.transform='translateY(-2px)';" onmouseleave="this.style.background='rgba(255,255,255,0.05)'; this.style.transform='translateY(0)';">
                    ${fotoHTML}
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="width: 12px; height: 12px; background: ${cor}; border-radius: 3px; border: 1.5px solid #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.3);"></div>
                        <span style="font-size: 0.9rem; font-weight: 600; color: ${cor}; text-shadow: 0 1px 2px rgba(0,0,0,0.1);">${p.nome}</span>
                    </div>
                </div>`;
            }).join('');
            legendaDiv.innerHTML = legendaHTML;

            console.log(`‚úÖ Legenda criada com ${profissionais.length} profissionais (com fotos e cores)`);
        }

        // Inicializar FullCalendar
        const calendarEl = document.getElementById('calendarioProfissionais');
        if (!calendarEl) {
            console.error('Elemento do calend√°rio n√£o encontrado');
            return;
        }

        // Destruir calend√°rio existente se houver
        if (calendarioProfissionaisInstance) {
            calendarioProfissionaisInstance.destroy();
        }

        // Criar nova inst√¢ncia do calend√°rio
        calendarioProfissionaisInstance = new FullCalendar.Calendar(calendarEl, {
            locale: 'pt-br',
            initialView: 'dayGridMonth',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'
            },
            buttonText: {
                today: 'Hoje',
                month: 'M√™s',
                week: 'Semana',
                day: 'Dia',
                list: 'Lista'
            },
            height: 650,
            contentHeight: 600,
            aspectRatio: 1.8,
            navLinks: true,
            editable: true,
            selectable: true,
            selectMirror: true,
            dayMaxEvents: 3,
            weekends: true,
            slotMinTime: '07:00:00',
            slotMaxTime: '21:00:00',
            slotDuration: '00:30:00',
            allDaySlot: false,
            eventDisplay: 'block',
            displayEventTime: true,
            displayEventEnd: true,
            eventTimeFormat: {
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            },
            
            // Estiliza√ß√£o personalizada
            eventClassNames: function(arg) {
                return ['fc-event-custom'];
            },
            
            dayCellClassNames: function(arg) {
                if (arg.isToday) {
                    return ['fc-day-today-custom'];
                }
                return [];
            },
            
            // Personalizar visualiza√ß√£o
            views: {
                dayGridMonth: {
                    dayMaxEventRows: 3,
                    moreLinkClick: 'popover'
                },
                timeGridWeek: {
                    slotLabelFormat: {
                        hour: '2-digit',
                        minute: '2-digit',
                        hour12: false
                    }
                },
                timeGridDay: {
                    slotLabelFormat: {
                        hour: '2-digit',
                        minute: '2-digit',
                        hour12: false
                    }
                }
            },

            // Eventos customizados
            select: function(info) {
                novoAgendamentoRapido(info.startStr, info.endStr);
            },

            eventClick: function(info) {
                info.jsEvent.preventDefault();
                visualizarAgendamentoCalendario(info.event);
            },

            eventDrop: function(info) {
                if (!confirm('Confirmar mudan√ßa de data/hora?')) {
                    info.revert();
                    return;
                }
                atualizarDataAgendamento(info.event.id, info.event.start, info.event.end);
            },

            eventResize: function(info) {
                if (!confirm('Confirmar mudan√ßa de dura√ß√£o?')) {
                    info.revert();
                    return;
                }
                atualizarDataAgendamento(info.event.id, info.event.start, info.event.end);
            },
            
            // Tooltip ao passar o mouse
            eventMouseEnter: function(info) {
                const tooltip = document.createElement('div');
                tooltip.className = 'fc-event-tooltip';
                tooltip.innerHTML = `
                    <strong>${info.event.title}</strong><br>
                    ${info.event.extendedProps.cliente || ''}<br>
                    ${info.event.start.toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'})}
                `;
                tooltip.style.cssText = `
                    position: absolute;
                    z-index: 10001;
                    background: rgba(0,0,0,0.9);
                    color: white;
                    padding: 8px 12px;
                    border-radius: 8px;
                    font-size: 12px;
                    pointer-events: none;
                    max-width: 200px;
                `;
                document.body.appendChild(tooltip);
                
                const rect = info.el.getBoundingClientRect();
                tooltip.style.left = rect.left + 'px';
                tooltip.style.top = (rect.top - tooltip.offsetHeight - 5) + 'px';
                
                info.el._tooltip = tooltip;
            },
            
            eventMouseLeave: function(info) {
                if (info.el._tooltip) {
                    info.el._tooltip.remove();
                    delete info.el._tooltip;
                }
            },

            // Carregar eventos
            events: async function(fetchInfo, successCallback, failureCallback) {
                try {
                    await carregarEventosCalendario(fetchInfo, successCallback, failureCallback, profissionais);
                } catch (error) {
                    console.error('Erro ao carregar eventos:', error);
                    failureCallback(error);
                }
            }
        });

        calendarioProfissionaisInstance.render();
        console.log('‚úÖ Calend√°rio inicializado com sucesso');

    } catch (error) {
        console.error('‚ùå Erro ao inicializar calend√°rio:', error);
        Swal.fire({
            icon: 'error',
            title: 'Erro ao carregar calend√°rio',
            text: 'N√£o foi poss√≠vel inicializar o calend√°rio. Tente recarregar a p√°gina.',
        });
    }
}

// Fun√ß√£o para carregar eventos do calend√°rio
async function carregarEventosCalendario(fetchInfo, successCallback, failureCallback, profissionais) {
    try {
        const filtroProf = document.getElementById('filtroCalendarioProfissional')?.value;

        // Buscar agendamentos
        const res = await fetch('/api/agendamentos', {credentials: 'include'});
        const data = await res.json();

        if (!data.success || !data.agendamentos) {
            successCallback([]);
            return;
        }

        // Filtrar por profissional se selecionado
        let agendamentos = data.agendamentos;
        if (filtroProf) {
            agendamentos = agendamentos.filter(a =>
                a.profissional_id === filtroProf ||
                a.profissional?._id === filtroProf
            );
        }

        // Converter agendamentos para eventos do FullCalendar
        const eventos = agendamentos.map(agendamento => {
            const profissionalId = agendamento.profissional_id || agendamento.profissional?._id;
            const profissionalNome = agendamento.profissional_nome || agendamento.profissional?.nome || 'Sem profissional';
            const cor = getCorProfissional(profissionalId, profissionais);

            // Criar data/hora do evento
            let start, end;
            if (agendamento.data && agendamento.horario) {
                // data format: "2025-10-27", horario: "14:30"
                start = `${agendamento.data}T${agendamento.horario}`;
                // Assumir 1 hora de dura√ß√£o padr√£o
                const startDate = new Date(start);
                const endDate = new Date(startDate.getTime() + 60 * 60 * 1000);
                end = endDate.toISOString().slice(0, 16);
            } else {
                start = agendamento.created_at;
                end = agendamento.created_at;
            }

            return {
                id: agendamento._id,
                title: `${profissionalNome} - ${agendamento.cliente_nome || 'Cliente'}`,
                start: start,
                end: end,
                backgroundColor: cor,
                borderColor: cor,
                extendedProps: {
                    cliente: agendamento.cliente_nome || 'Cliente n√£o informado',
                    profissional: profissionalNome,
                    telefone: agendamento.telefone || '-',
                    observacoes: agendamento.observacoes || '-',
                    status: agendamento.status || 'Agendado'
                }
            };
        });

        successCallback(eventos);
    } catch (error) {
        console.error('Erro ao carregar eventos:', error);
        failureCallback(error);
    }
}

// Fun√ß√£o para recarregar calend√°rio (√∫til ap√≥s filtrar)
function carregarCalendario() {
    if (calendarioProfissionaisInstance) {
        calendarioProfissionaisInstance.refetchEvents();
    } else {
        inicializarCalendario();
    }
}

// Fun√ß√£o para criar novo agendamento r√°pido
function novoAgendamentoRapido(dataInicio, dataFim) {
    console.log('üìÖ Abrindo modal de novo agendamento');

    let dataDefault = '';
    let horaDefault = '';

    if (dataInicio) {
        const dt = new Date(dataInicio);
        dataDefault = dt.toISOString().split('T')[0];
        horaDefault = dt.toISOString().split('T')[1].substring(0, 5);
    }

    Swal.fire({
        title: 'üìÖ Novo Agendamento',
        html: `
            <div style="text-align: left;">
                <div class="mb-3">
                    <label class="form-label">Cliente</label>
                    <input type="text" id="agend-cliente" class="form-control" placeholder="Nome do cliente">
                </div>
                <div class="mb-3">
                    <label class="form-label">Telefone</label>
                    <input type="text" id="agend-telefone" class="form-control" placeholder="(34) 99999-9999">
                </div>
                <div class="mb-3">
                    <label class="form-label">Profissional</label>
                    <select id="agend-profissional" class="form-select">
                        <option value="">Selecione um profissional</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Servi√ßo / Tamanho</label>
                    <select id="agend-tamanho" class="form-select">
                        <option value="">Selecione um tamanho</option>
                        <option value="Kids">Kids (Infantil)</option>
                        <option value="Masculino">Masculino (Barba)</option>
                        <option value="Curto">Curto (P/Small)</option>
                        <option value="M√©dio">M√©dio (M/Medium)</option>
                        <option value="Longo">Longo (G/Large)</option>
                        <option value="Extra Longo">Extra Longo (GG/XL)</option>
                    </select>
                </div>
                <div class="row g-2">
                    <div class="col-md-6">
                        <label class="form-label">Data</label>
                        <input type="date" id="agend-data" class="form-control" value="${dataDefault}">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Hor√°rio</label>
                        <input type="time" id="agend-hora" class="form-control" value="${horaDefault}">
                    </div>
                </div>
                <div class="mb-3 mt-3">
                    <label class="form-label">Observa√ß√µes</label>
                    <textarea id="agend-obs" class="form-control" rows="2" placeholder="Observa√ß√µes opcionais"></textarea>
                </div>
            </div>
        `,
        width: '600px',
        showCancelButton: true,
        confirmButtonText: 'Agendar',
        cancelButtonText: 'Cancelar',
        didOpen: async () => {
            // Carregar profissionais no select
            try {
                const res = await fetch('/api/profissionais', {credentials: 'include'});
                const data = await res.json();
                if (data.success && data.profissionais) {
                    const select = document.getElementById('agend-profissional');
                    select.innerHTML = '<option value="">Selecione um profissional</option>' +
                        data.profissionais.map(p => `<option value="${p._id}">${p.nome} - ${p.especialidade || 'Profissional'}</option>`).join('');
                }
            } catch (e) {
                console.error('Erro ao carregar profissionais:', e);
            }
        },
        preConfirm: () => {
            const cliente = document.getElementById('agend-cliente').value;
            const telefone = document.getElementById('agend-telefone').value;
            const profissional = document.getElementById('agend-profissional').value;
            const tamanho = document.getElementById('agend-tamanho').value;
            const data = document.getElementById('agend-data').value;
            const hora = document.getElementById('agend-hora').value;
            const obs = document.getElementById('agend-obs').value;

            if (!cliente || !data || !hora) {
                Swal.showValidationMessage('Preencha cliente, data e hor√°rio');
                return false;
            }

            return { cliente, telefone, profissional, tamanho, data, hora, obs };
        }
    }).then(async (result) => {
        if (result.isConfirmed) {
            try {
                const payload = {
                    cliente_nome: result.value.cliente,
                    telefone: result.value.telefone,
                    profissional_id: result.value.profissional,
                    tamanho: result.value.tamanho,
                    data: result.value.data,
                    horario: result.value.hora,
                    observacoes: result.value.obs,
                    status: 'Agendado'
                };

                const response = await fetch('/api/agendamentos', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    credentials: 'include',
                    body: JSON.stringify(payload)
                });

                const data = await response.json();

                if (data.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Agendamento Criado!',
                        text: `${result.value.cliente} agendado para ${result.value.data} √†s ${result.value.hora}`,
                        timer: 2500
                    });
                    carregarCalendario();
                } else {
                    throw new Error(data.message || 'Erro ao criar agendamento');
                }
            } catch (error) {
                console.error('Erro ao criar agendamento:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Erro',
                    text: error.message || 'N√£o foi poss√≠vel criar o agendamento'
                });
            }
        }
    });
}

// Fun√ß√£o para visualizar agendamento clicado no calend√°rio
function visualizarAgendamentoCalendario(event) {
    const props = event.extendedProps;

    Swal.fire({
        title: 'üìã Detalhes do Agendamento',
        html: `
            <div style="text-align: left; padding: 20px;">
                <p><strong>Cliente:</strong> ${props.cliente}</p>
                <p><strong>Profissional:</strong> ${props.profissional}</p>
                <p><strong>Telefone:</strong> ${props.telefone}</p>
                ${props.tamanho ? `<p><strong>Tamanho:</strong> <span class="badge" style="background: var(--primary); color: white;">${props.tamanho}</span></p>` : ''}
                <p><strong>Data/Hora:</strong> ${event.start.toLocaleString('pt-BR')}</p>
                <p><strong>Status:</strong> <span class="badge success">${props.status}</span></p>
                <p><strong>Observa√ß√µes:</strong> ${props.observacoes}</p>
            </div>
        `,
        showCancelButton: true,
        confirmButtonText: 'Cancelar Agendamento',
        confirmButtonColor: '#EF4444',
        cancelButtonText: 'Fechar'
    }).then(async (result) => {
        if (result.isConfirmed) {
            // Cancelar agendamento
            try {
                await fetch(`/api/agendamentos/${event.id}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                mostrarNotificacao('success', 'Agendamento cancelado com sucesso!');
                carregarCalendario();
            } catch (error) {
                mostrarNotificacao('error', 'N√£o foi poss√≠vel cancelar o agendamento');
            }
        }
    });
}

// Fun√ß√£o para atualizar data de agendamento (drag & drop)
async function atualizarDataAgendamento(agendamentoId, novaData, novaDataFim) {
    try {
        const data = novaData.toISOString().split('T')[0];
        const hora = novaData.toISOString().split('T')[1].substring(0, 5);

        const response = await fetch(`/api/agendamentos/${agendamentoId}`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            credentials: 'include',
            body: JSON.stringify({ data, horario: hora })
        });

        const result = await response.json();

        if (result.success) {
            toast('‚úÖ Agendamento atualizado', 'success');
        } else {
            throw new Error(result.message);
        }
    } catch (error) {
        console.error('Erro ao atualizar agendamento:', error);
        toast('‚ùå Erro ao atualizar', 'error');
        carregarCalendario(); // Recarregar para desfazer mudan√ßa visual
    }
}

// Fun√ß√£o para voltar ao dia de hoje
function calendarioHoje() {
    console.log('üìÖ Fun√ß√£o calendarioHoje() chamada');
    if (calendarioProfissionaisInstance) {
        calendarioProfissionaisInstance.today();
        console.log('‚úÖ Calend√°rio navegado para hoje');
    } else {
        console.warn('‚ö†Ô∏è Calend√°rio n√£o inicializado ainda. Inicializando...');
        inicializarCalendario();
    }
}

// Fun√ß√£o para alterar visualiza√ß√£o do calend√°rio
function alterarVisualizacaoCalendario() {
    console.log('üëÅÔ∏è Alterando visualiza√ß√£o do calend√°rio');
    const visualizacao = document.getElementById('visualizacaoCalendario')?.value;
    if (calendarioProfissionaisInstance && visualizacao) {
        calendarioProfissionaisInstance.changeView(visualizacao);
        console.log(`‚úÖ Visualiza√ß√£o alterada para: ${visualizacao}`);
    } else if (!calendarioProfissionaisInstance) {
        console.warn('‚ö†Ô∏è Calend√°rio n√£o inicializado');
    }
}

// Hook: Inicializar calend√°rio quando sub-tab for ativada
// Ser√° chamado pela fun√ß√£o showSubTab
document.addEventListener('DOMContentLoaded', function() {
    // Adicionar listener para detectar quando sub-tab de calend√°rio √© ativada
    const btnCalendario = document.querySelector('[onclick*="profissionais"][onclick*="calendario"]');
    if (btnCalendario) {
        btnCalendario.addEventListener('click', function() {
            setTimeout(() => {
                if (!calendarioProfissionaisInstance) {
                    inicializarCalendario();
                }
            }, 300);
        });
    }
});

// ========== FIM CALEND√ÅRIO DE PROFISSIONAIS ====================

async function loadServicosLista(){
    const key = 'loadServicosLista';
    if (isLoading(key)) {
        console.warn(`‚ö†Ô∏è J√° carregando: ${key}`);
        return;
    }
    setLoading(key, true);

    try{
        const res=await fetch('/api/servicos',{credentials:'include'});
        const data=await res.json();

        // Atualizar TODOS os tbody de servi√ßos
        const tbodies = [
            document.getElementById('servicosTodosBody'),
            document.getElementById('servicosAtivosBody'),
            document.getElementById('servicosInativosBody')
        ];

        if(data.success&&data.servicos&&data.servicos.length>0){
            servicosDisponiveis = data.servicos;

            // Todos os servi√ßos
            if(tbodies[0]){
                const htmlTodos=data.servicos.map(s=>`<tr data-id="${s._id}"><td><strong>${s.nome}</strong></td><td>${s.categoria}</td><td>${s.tamanho}</td><td><strong>R$ ${s.preco.toFixed(2)}</strong></td><td><span class="badge ${s.ativo?'success':'danger'}">${s.ativo?'Ativo':'Inativo'}</span></td><td><button class="bioma-btn bioma-btn-sm bioma-btn-primary" onclick="editarServico('${s._id}')" title="Editar"><i class="bi bi-pencil"></i></button> <button class="bioma-btn bioma-btn-sm bioma-btn-danger" onclick="deleteServico('${s._id}')" title="Deletar"><i class="bi bi-trash"></i></button></td></tr>`).join('');
                tbodies[0].innerHTML=htmlTodos;
            }

            // Servi√ßos ativos
            if(tbodies[1]){
                const ativos = data.servicos.filter(s => s.ativo);
                const htmlAtivos = ativos.length > 0 ? ativos.map(s=>`<tr data-id="${s._id}"><td><strong>${s.nome}</strong></td><td>${s.categoria}</td><td>${s.tamanho}</td><td><strong>R$ ${s.preco.toFixed(2)}</strong></td><td><button class="bioma-btn bioma-btn-sm bioma-btn-primary" onclick="editarServico('${s._id}')" title="Editar"><i class="bi bi-pencil"></i></button> <button class="bioma-btn bioma-btn-sm bioma-btn-danger" onclick="deleteServico('${s._id}')" title="Deletar"><i class="bi bi-trash"></i></button></td></tr>`).join('') : '<tr data-keep-visible="true"><td colspan="5" class="text-center text-muted">Nenhum servi√ßo ativo</td></tr>';
                tbodies[1].innerHTML=htmlAtivos;
            }

            // Servi√ßos inativos
            if(tbodies[2]){
                const inativos = data.servicos.filter(s => !s.ativo);
                const htmlInativos = inativos.length > 0 ? inativos.map(s=>`<tr data-id="${s._id}"><td><strong>${s.nome}</strong></td><td>${s.categoria}</td><td>${s.tamanho}</td><td><strong>R$ ${s.preco.toFixed(2)}</strong></td><td><button class="bioma-btn bioma-btn-sm bioma-btn-primary" onclick="editarServico('${s._id}')" title="Editar"><i class="bi bi-pencil"></i></button> <button class="bioma-btn bioma-btn-sm bioma-btn-success" onclick="ativarServico('${s._id}')"><i class="bi bi-check-circle"></i> Ativar</button></td></tr>`).join('') : '<tr data-keep-visible="true"><td colspan="5" class="text-center text-muted">Nenhum servi√ßo inativo</td></tr>';
                tbodies[2].innerHTML=htmlInativos;
            }
        }else{
            tbodies.forEach(tb => {
                if(tb) tb.innerHTML='<tr data-keep-visible="true"><td colspan="6" class="text-center text-muted">Nenhum servi√ßo cadastrado</td></tr>';
            });
        }
    }catch(e){
        console.error('‚ùå Erro ao carregar servi√ßos:', e);
    } finally {
        setTimeout(() => setLoading(key, false), 250);
    }
}

async function deleteServico(id){
    const result=await Swal.fire({title:'Deletar servi√ßo?',text:'Esta a√ß√£o n√£o pode ser desfeita',icon:'warning',showCancelButton:true,confirmButtonText:'Sim, deletar',cancelButtonText:'Cancelar'});
    if(result.isConfirmed){
        try{
            const response = await fetchWithTimeout(`/api/servicos/${id}`, {method:'DELETE',credentials:'include'}, 30000, 1);
            const data = await response.json();
            if(data.success){
                Swal.fire('Deletado!','Servi√ßo removido com sucesso','success');
                await autoRefreshAfterOperation('servicos'); // v7.1: Auto-refresh
            }else{
                Swal.fire('Erro',data.message || 'Erro ao deletar servi√ßo','error');
            }
        }catch(e){
            console.error('Erro ao deletar servi√ßo:',e);
            Swal.fire('Erro','N√£o foi poss√≠vel deletar o servi√ßo','error');
        }
    }
}

async function visualizarProfissional(id){
    try{
        const res=await fetch(`/api/profissionais/${id}`,{credentials:'include'});
        const data=await res.json();
        if(data.success&&data.profissional){
            const p=data.profissional;
            Swal.fire({
                title:`<strong>üë®‚Äçüíº ${p.nome}</strong>`,
                html:`<div style="text-align:left"><div style="background:linear-gradient(135deg,#7C3AED,#EC4899);color:#fff;padding:20px;border-radius:15px;margin-bottom:20px"><p style="margin:5px 0"><strong>CPF:</strong> ${p.cpf}</p>${p.especialidade?`<p style="margin:5px 0"><strong>Especialidade:</strong> ${p.especialidade}</p>`:''}${p.telefone?`<p style="margin:5px 0"><strong>Telefone:</strong> ${p.telefone}</p>`:''}</div><div style="background:#f3f4f6;padding:15px;border-radius:10px"><p><strong>üí∞ Comiss√£o:</strong> <span style="color:#7C3AED;font-size:1.3rem">${p.comissao_perc}%</span></p><p><strong>üìä Status:</strong> <span class="badge ${p.ativo?'success':'danger'}">${p.ativo?'ATIVO':'INATIVO'}</span></p></div><p style="margin-top:15px;font-size:0.85rem;color:#6B7280">Cadastrado em: ${new Date(p.created_at).toLocaleString('pt-BR')}</p></div>`,
                width:'600px',
                confirmButtonText:'Fechar',
                confirmButtonColor:'#7C3AED',
                allowEscapeKey: true,
                allowOutsideClick: true,
                showCloseButton: true,
                focusConfirm: true
            });
        }
    }catch(e){
        Swal.fire('Erro','N√£o foi poss√≠vel carregar os detalhes','error');
    }
}

async function editarProfissional(id){
    try{
        const res=await fetch(`/api/profissionais/${id}`,{credentials:'include'});
        const data=await res.json();
        if(data.success&&data.profissional){
            const p=data.profissional;
            Swal.fire({
                title:'Editar Profissional',
                html:`<input type="text" id="swal-nome" class="form-control mb-3" placeholder="Nome" value="${p.nome}"><input type="text" id="swal-cpf" class="form-control mb-3" placeholder="CPF" value="${p.cpf}"><input type="text" id="swal-espec" class="form-control mb-3" placeholder="Especialidade" value="${p.especialidade||''}"><input type="number" id="swal-comissao" class="form-control mb-3" placeholder="Comiss√£o %" value="${p.comissao_perc}"><select id="swal-ativo" class="form-select"><option value="true" ${p.ativo?'selected':''}>Ativo</option><option value="false" ${!p.ativo?'selected':''}>Inativo</option></select>`,
                showCancelButton:true,
                confirmButtonText:'Salvar',
                cancelButtonText:'Cancelar',
                allowEscapeKey: true,
                allowOutsideClick: true,
                showCloseButton: true,
                preConfirm:()=>{
                const nome=document.getElementById('swal-nome').value;
                const cpf=document.getElementById('swal-cpf').value;
                if(!nome||!cpf){Swal.showValidationMessage('Nome e CPF obrigat√≥rios');return false;}
                return {nome,cpf,especialidade:document.getElementById('swal-espec').value,comissao_perc:document.getElementById('swal-comissao').value,ativo:document.getElementById('swal-ativo').value==='true'};
            }}).then(async(result)=>{
                if(result.isConfirmed){
                    try{
                        await fetch(`/api/profissionais/${id}`,{method:'PUT',headers:{'Content-Type':'application/json'},credentials:'include',body:JSON.stringify(result.value)});
                        Swal.fire('Sucesso!','Profissional atualizado','success');
                        loadProfissionais();
                    }catch(e){
                        Swal.fire('Erro','N√£o foi poss√≠vel atualizar','error');
                    }
                }
            });
        }
    }catch(e){
        Swal.fire('Erro','N√£o foi poss√≠vel carregar para edi√ß√£o','error');
    }
}

function showModalServico(){
    Swal.fire({
        title:'Novo Servi√ßo',
        html:`<input type="text" id="swal-nome" class="form-control mb-3" placeholder="Nome"><div class="row"><div class="col-6"><input type="number" id="swal-kids" class="form-control mb-2" placeholder="Kids" step="0.01"><input type="number" id="swal-masc" class="form-control mb-2" placeholder="Masculino" step="0.01"><input type="number" id="swal-curto" class="form-control" placeholder="Curto" step="0.01"></div><div class="col-6"><input type="number" id="swal-medio" class="form-control mb-2" placeholder="M√©dio" step="0.01"><input type="number" id="swal-longo" class="form-control mb-2" placeholder="Longo" step="0.01"><input type="number" id="swal-xl" class="form-control" placeholder="XL" step="0.01"></div></div>`,
        showCancelButton:true,
        width:'600px',
        allowEscapeKey: true,
        allowOutsideClick: true,
        showCloseButton: true,
        preConfirm:()=>{
        const nome=document.getElementById('swal-nome').value;
        if(!nome){Swal.showValidationMessage('Nome obrigat√≥rio');return false;}
        return {nome,preco_kids:document.getElementById('swal-kids').value||0,preco_masculino:document.getElementById('swal-masc').value||0,preco_curto:document.getElementById('swal-curto').value||0,preco_medio:document.getElementById('swal-medio').value||0,preco_longo:document.getElementById('swal-longo').value||0,preco_extra_longo:document.getElementById('swal-xl').value||0};
    }}).then(async(result)=>{
        if(result.isConfirmed){
            try{
                const res=await fetch('/api/servicos',{method:'POST',headers:{'Content-Type':'application/json'},credentials:'include',body:JSON.stringify(result.value)});
                const data=await res.json();
                if(data.success){
                    Swal.fire('Sucesso!',`${data.count} SKUs criados`,'success');
                    await loadServicosLista();
                }
            }catch(e){
                Swal.fire('Erro','','error');
            }
        }
    });
}

// Fun√ß√£o para editar servi√ßo
async function editarServico(id) {
    try {
        // Buscar dados do servi√ßo
        const res = await fetch(`/api/servicos/${id}`, { credentials: 'include' });
        const data = await res.json();

        if (!data.success || !data.servico) {
            throw new Error('Servi√ßo n√£o encontrado');
        }

        const s = data.servico;

        // Criar formul√°rio de edi√ß√£o
        const html = `
            <div class="text-start">
                <div class="row g-3">
                    <div class="col-md-12">
                        <label class="form-label">Nome do Servi√ßo *</label>
                        <input type="text" id="swal-servico-nome" class="form-control" value="${s.nome || ''}">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Categoria</label>
                        <input type="text" id="swal-servico-categoria" class="form-control" value="${s.categoria || ''}">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Tamanho</label>
                        <input type="text" id="swal-servico-tamanho" class="form-control" value="${s.tamanho || ''}">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Pre√ßo (R$) *</label>
                        <input type="number" id="swal-servico-preco" class="form-control" step="0.01" value="${s.preco || 0}">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Dura√ß√£o (minutos)</label>
                        <input type="number" id="swal-servico-duracao" class="form-control" value="${s.duracao || 30}">
                    </div>
                    <div class="col-md-12">
                        <label class="form-label">Status *</label>
                        <select id="swal-servico-ativo" class="form-select">
                            <option value="true" ${s.ativo !== false ? 'selected' : ''}>Ativo</option>
                            <option value="false" ${s.ativo === false ? 'selected' : ''}>Inativo</option>
                        </select>
                    </div>
                </div>
            </div>
        `;

        const result = await Swal.fire({
            title: '‚úèÔ∏è Editar Servi√ßo',
            html: html,
            width: '700px',
            showCancelButton: true,
            confirmButtonText: 'Salvar Altera√ß√µes',
            cancelButtonText: 'Cancelar',
            confirmButtonColor: '#7C3AED',
            preConfirm: () => {
                const nome = document.getElementById('swal-servico-nome').value.trim();
                const preco = document.getElementById('swal-servico-preco').value;

                if (!nome) {
                    Swal.showValidationMessage('Nome do servi√ßo √© obrigat√≥rio');
                    return false;
                }
                if (!preco || preco <= 0) {
                    Swal.showValidationMessage('Pre√ßo deve ser maior que zero');
                    return false;
                }

                return {
                    nome: nome,
                    categoria: document.getElementById('swal-servico-categoria').value.trim(),
                    tamanho: document.getElementById('swal-servico-tamanho').value.trim(),
                    preco: parseFloat(preco),
                    duracao: parseInt(document.getElementById('swal-servico-duracao').value) || 30,
                    ativo: document.getElementById('swal-servico-ativo').value === 'true'
                };
            }
        });

        if (result.isConfirmed) {
            try {
                const updateRes = await fetch(`/api/servicos/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(result.value)
                });

                const updateData = await updateRes.json();

                if (updateData.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Servi√ßo Atualizado!',
                        text: `${result.value.nome} foi atualizado com sucesso.`,
                        timer: 2000
                    });
                    // Recarregar lista de servi√ßos (v7.1: Auto-refresh otimizado)
                    await autoRefreshAfterOperation('servicos');
                } else {
                    throw new Error(updateData.message || 'Erro ao atualizar servi√ßo');
                }
            } catch (error) {
                console.error('‚ùå Erro ao atualizar servi√ßo:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Erro',
                    text: error.message || 'N√£o foi poss√≠vel atualizar o servi√ßo'
                });
            }
        }

    } catch (error) {
        console.error('‚ùå Erro ao carregar servi√ßo para edi√ß√£o:', error);
        Swal.fire({
            icon: 'error',
            title: 'Erro',
            text: error.message || 'N√£o foi poss√≠vel carregar os detalhes do servi√ßo'
        });
    }
}

// Fun√ß√£o para ativar todos os servi√ßos
async function ativarTodosServicos() {
    console.log('üîÑ ativarTodosServicos() chamada');

    const result = await window.Swal.fire({
        title: 'Ativar Todos os Servi√ßos?',
        text: 'Esta a√ß√£o ir√° ativar todos os servi√ßos cadastrados no sistema.',
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#10B981',
        cancelButtonColor: '#6c757d',
        confirmButtonText: '<i class="bi bi-check-circle-fill"></i> Sim, Ativar Todos',
        cancelButtonText: 'Cancelar'
    });

    if (result.isConfirmed) {
        console.log('‚úÖ Confirma√ß√£o recebida, enviando requisi√ß√£o...');
        try {
            const res = await fetch('/api/servicos/toggle-todos', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({ ativo: true })
            });

            console.log('üì° Resposta recebida:', res.status);
            const data = await res.json();
            console.log('üì¶ Dados:', data);

            if (data.success) {
                toast(`‚úÖ ${data.count || 0} servi√ßos ativados com sucesso!`, 'success');
                await loadServicosLista();
                console.log('üîÑ Lista de servi√ßos recarregada');
            } else {
                toast(`‚ùå ${data.message || 'N√£o foi poss√≠vel ativar os servi√ßos'}`, 'error');
            }
        } catch (e) {
            console.error('‚ùå Erro ao ativar servi√ßos:', e);
            toast('‚ùå Falha ao ativar servi√ßos', 'error');
        }
    } else {
        console.log('‚ùå Opera√ß√£o cancelada pelo usu√°rio');
    }

}

// Fun√ß√£o para desativar todos os servi√ßos
async function desativarTodosServicos() {
    console.log('üîÑ desativarTodosServicos() chamada');

    const result = await window.Swal.fire({
        title: 'Desativar Todos os Servi√ßos?',
        text: 'Esta a√ß√£o ir√° desativar todos os servi√ßos cadastrados no sistema.',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#EF4444',
        cancelButtonColor: '#6c757d',
        confirmButtonText: '<i class="bi bi-x-circle-fill"></i> Sim, Desativar Todos',
        cancelButtonText: 'Cancelar'
    });

    if (result.isConfirmed) {
        console.log('‚úÖ Confirma√ß√£o recebida, enviando requisi√ß√£o...');
        try {
            const res = await fetch('/api/servicos/toggle-todos', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({ ativo: false })
            });

            console.log('üì° Resposta recebida:', res.status);
            const data = await res.json();
            console.log('üì¶ Dados:', data);

            if (data.success) {
                toast(`‚úÖ ${data.count || 0} servi√ßos desativados com sucesso!`, 'success');
                await loadServicosLista();
                console.log('üîÑ Lista de servi√ßos recarregada');
            } else {
                toast(`‚ùå ${data.message || 'N√£o foi poss√≠vel desativar os servi√ßos'}`, 'error');
            }
        } catch (e) {
            console.error('‚ùå Erro ao desativar servi√ßos:', e);
            toast('‚ùå Falha ao desativar servi√ßos', 'error');
        }
    } else {
        console.log('‚ùå Opera√ß√£o cancelada pelo usu√°rio');
    }

}

async function loadProdutosLista(){
    const key = 'loadProdutosLista';
    if (isLoading(key)) {
        console.warn(`‚ö†Ô∏è J√° carregando: ${key}`);
        return;
    }
    setLoading(key, true);

    try{
        const res=await fetch('/api/produtos',{credentials:'include'});
        const data=await res.json();

        // Atualizar TODOS os tbody de produtos
        const tbodies = [
            document.getElementById('produtosTodosBody'),
            document.getElementById('produtosAtivosBody'),
            document.getElementById('produtosInativosBody')
        ];

        if(data.success&&data.produtos&&data.produtos.length>0){
            produtosDisponiveis = data.produtos;
            produtosCache = data.produtos;

            // Todos os produtos
            if(tbodies[0]){
                const htmlTodos=data.produtos.map(p=>`<tr data-id="${p._id}"><td><strong>${p.nome}</strong></td><td>${p.marca||'-'}</td><td><strong>R$ ${p.preco.toFixed(2)}</strong></td><td><span class="badge ${(p.estoque||0)<5?'badge-pulse-danger':'success'}">${p.estoque||0}</span></td><td><span class="badge ${p.ativo?'success':'danger'}">${p.ativo?'Ativo':'Inativo'}</span></td><td><button class="bioma-btn bioma-btn-sm bioma-btn-primary" onclick="editarProduto('${p._id}')" title="Editar"><i class="bi bi-pencil"></i></button> <button class="bioma-btn bioma-btn-sm bioma-btn-danger" onclick="deleteProduto('${p._id}')" title="Deletar"><i class="bi bi-trash"></i></button></td></tr>`).join('');
                tbodies[0].innerHTML=htmlTodos;
            }

            // Produtos ativos
            if(tbodies[1]){
                const ativos = data.produtos.filter(p => p.ativo);
                const htmlAtivos = ativos.length > 0 ? ativos.map(p=>`<tr data-id="${p._id}"><td><strong>${p.nome}</strong></td><td>${p.marca||'-'}</td><td><strong>R$ ${p.preco.toFixed(2)}</strong></td><td><span class="badge ${(p.estoque||0)<5?'badge-pulse-danger':'success'}">${p.estoque||0}</span></td><td><button class="bioma-btn bioma-btn-sm bioma-btn-primary" onclick="editarProduto('${p._id}')" title="Editar"><i class="bi bi-pencil"></i></button> <button class="bioma-btn bioma-btn-sm bioma-btn-danger" onclick="deleteProduto('${p._id}')" title="Deletar"><i class="bi bi-trash"></i></button></td></tr>`).join('') : '<tr data-keep-visible="true"><td colspan="5" class="text-center text-muted">Nenhum produto ativo</td></tr>';
                tbodies[1].innerHTML=htmlAtivos;
            }

            // Produtos inativos
            if(tbodies[2]){
                const inativos = data.produtos.filter(p => !p.ativo);
                const htmlInativos = inativos.length > 0 ? inativos.map(p=>`<tr data-id="${p._id}"><td><strong>${p.nome}</strong></td><td>${p.marca||'-'}</td><td><strong>R$ ${p.preco.toFixed(2)}</strong></td><td><span class="badge danger">${p.estoque||0}</span></td><td><button class="bioma-btn bioma-btn-sm bioma-btn-primary" onclick="editarProduto('${p._id}')" title="Editar"><i class="bi bi-pencil"></i></button> <button class="bioma-btn bioma-btn-sm bioma-btn-success" onclick="ativarProduto('${p._id}')"><i class="bi bi-check-circle"></i> Ativar</button></td></tr>`).join('') : '<tr data-keep-visible="true"><td colspan="5" class="text-center text-muted">Nenhum produto inativo</td></tr>';
                tbodies[2].innerHTML=htmlInativos;
            }
        }else{
            tbodies.forEach(tb => {
                if(tb) tb.innerHTML='<tr data-keep-visible="true"><td colspan="6" class="text-center text-muted">Nenhum produto cadastrado</td></tr>';
            });
        }
    }catch(e){
        console.error('‚ùå Erro ao carregar produtos:', e);
    } finally {
        setTimeout(() => setLoading(key, false), 250);
    }
}

async function deleteProduto(id){
    const result=await Swal.fire({title:'Deletar produto?',text:'Esta a√ß√£o n√£o pode ser desfeita',icon:'warning',showCancelButton:true,confirmButtonText:'Sim, deletar',cancelButtonText:'Cancelar'});
    if(result.isConfirmed){
        try{
            const response = await fetchWithTimeout(`/api/produtos/${id}`, {method:'DELETE',credentials:'include'}, 30000, 1);
            const data = await response.json();
            if(data.success){
                Swal.fire('Deletado!','Produto removido com sucesso','success');
                await autoRefreshAfterOperation('produtos'); // v7.1: Auto-refresh
                await autoRefreshAfterOperation('estoque'); // Atualizar estoque tamb√©m
            }else{
                Swal.fire('Erro',data.message || 'Erro ao deletar produto','error');
            }
        }catch(e){
            console.error('Erro ao deletar produto:',e);
            Swal.fire('Erro','N√£o foi poss√≠vel deletar o produto','error');
        }
    }

}

function showModalProduto(){
    Swal.fire({
        title:'Novo Produto',
        html:`<input type="text" id="swal-nome" class="form-control mb-3" placeholder="Nome"><input type="text" id="swal-marca" class="form-control mb-3" placeholder="Marca"><input type="number" id="swal-preco" class="form-control mb-3" placeholder="Pre√ßo" step="0.01"><input type="number" id="swal-estoque" class="form-control" placeholder="Estoque" value="0">`,
        showCancelButton:true,
        allowEscapeKey: true,
        allowOutsideClick: true,
        showCloseButton: true,
        preConfirm:()=>{
        const nome=document.getElementById('swal-nome').value;
        const preco=document.getElementById('swal-preco').value;
        if(!nome||!preco){Swal.showValidationMessage('Nome e Pre√ßo obrigat√≥rios');return false;}
        return {nome,marca:document.getElementById('swal-marca').value,preco,estoque:document.getElementById('swal-estoque').value};
    }}).then(async(result)=>{
        if(result.isConfirmed){
            try{
                await fetch('/api/produtos',{method:'POST',headers:{'Content-Type':'application/json'},credentials:'include',body:JSON.stringify(result.value)});
                Swal.fire('Sucesso!','','success');
                loadProdutosLista();
            }catch(e){
                Swal.fire('Erro','','error');
            }
        }
    });
}

// Fun√ß√£o para ativar todos os produtos
async function ativarTodosProdutos() {
    console.log('üîÑ ativarTodosProdutos() chamada');

    const result = await window.Swal.fire({
        title: 'Ativar Todos os Produtos?',
        text: 'Esta a√ß√£o ir√° ativar todos os produtos cadastrados no sistema.',
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#10B981',
        cancelButtonColor: '#6c757d',
        confirmButtonText: '<i class="bi bi-check-circle-fill"></i> Sim, Ativar Todos',
        cancelButtonText: 'Cancelar'
    });

    if (result.isConfirmed) {
        console.log('‚úÖ Confirma√ß√£o recebida, enviando requisi√ß√£o...');
        try {
            const res = await fetch('/api/produtos/toggle-todos', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({ ativo: true })
            });

            console.log('üì° Resposta recebida:', res.status);
            const data = await res.json();
            console.log('üì¶ Dados:', data);

            if (data.success) {
                toast(`‚úÖ ${data.count || 0} produtos ativados com sucesso!`, 'success');
                await loadProdutosLista();
                console.log('üîÑ Lista de produtos recarregada');
            } else {
                toast(`‚ùå ${data.message || 'N√£o foi poss√≠vel ativar os produtos'}`, 'error');
            }
        } catch (e) {
            console.error('‚ùå Erro ao ativar produtos:', e);
            toast('‚ùå Falha ao ativar produtos', 'error');
        }
    } else {
        console.log('‚ùå Opera√ß√£o cancelada pelo usu√°rio');
    }

}

// Fun√ß√£o para desativar todos os produtos
async function desativarTodosProdutos() {
    console.log('üîÑ desativarTodosProdutos() chamada');

    const result = await window.Swal.fire({
        title: 'Desativar Todos os Produtos?',
        text: 'Esta a√ß√£o ir√° desativar todos os produtos cadastrados no sistema.',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#EF4444',
        cancelButtonColor: '#6c757d',
        confirmButtonText: '<i class="bi bi-x-circle-fill"></i> Sim, Desativar Todos',
        cancelButtonText: 'Cancelar'
    });

    if (result.isConfirmed) {
        console.log('‚úÖ Confirma√ß√£o recebida, enviando requisi√ß√£o...');
        try {
            const res = await fetch('/api/produtos/toggle-todos', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({ ativo: false })
            });

            console.log('üì° Resposta recebida:', res.status);
            const data = await res.json();
            console.log('üì¶ Dados:', data);

            if (data.success) {
                toast(`‚úÖ ${data.count || 0} produtos desativados com sucesso!`, 'success');
                await loadProdutosLista();
                console.log('üîÑ Lista de produtos recarregada');
            } else {
                toast(`‚ùå ${data.message || 'N√£o foi poss√≠vel desativar os produtos'}`, 'error');
            }
        } catch (e) {
            console.error('‚ùå Erro ao desativar produtos:', e);
            toast('‚ùå Falha ao desativar produtos', 'error');
        }
    } else {
        console.log('‚ùå Opera√ß√£o cancelada pelo usu√°rio');
    }

}

// Fun√ß√£o para deletar TODOS os produtos
async function deletarTodosProdutos() {
    console.log('üóëÔ∏è deletarTodosProdutos() chamada');

    const result = await window.Swal.fire({
        title: '‚ö†Ô∏è DELETAR TODOS OS PRODUTOS?',
        html: `
            <div style="color: #EF4444; font-weight: bold; margin-bottom: 15px;">
                <i class="bi bi-exclamation-triangle-fill"></i> ATEN√á√ÉO: ESTA A√á√ÉO √â IRREVERS√çVEL!
            </div>
            <p>Esta a√ß√£o ir√° <strong>DELETAR PERMANENTEMENTE</strong> todos os produtos do sistema.</p>
            <p style="color: #6B7280;">Digite <strong>CONFIRMAR</strong> para prosseguir:</p>
            <input type="text" id="confirmacao-deletar-produtos" class="swal2-input" placeholder="Digite CONFIRMAR">
        `,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#EF4444',
        cancelButtonColor: '#6c757d',
        confirmButtonText: '<i class="bi bi-trash-fill"></i> Sim, Deletar Todos',
        cancelButtonText: 'Cancelar',
        preConfirm: () => {
            const confirmacao = document.getElementById('confirmacao-deletar-produtos').value;
            if (confirmacao !== 'CONFIRMAR') {
                Swal.showValidationMessage('Digite "CONFIRMAR" para prosseguir');
                return false;
            }
            return true;
        }
    });

    if (result.isConfirmed) {
        console.log('‚úÖ Confirma√ß√£o recebida, deletando todos os produtos...');

        let cancelarProcesso = false;
        let processoCompleto = false;
        let deletados = 0;
        let erros = 0;
        let errosDetalhados = [];

        try {
            // Buscar todos os produtos primeiro
            const listRes = await fetch('/api/produtos', { credentials: 'include' });
            const listData = await listRes.json();

            if (!listData.success || !listData.produtos) {
                throw new Error(listData.message || 'N√£o foi poss√≠vel buscar a lista de produtos');
            }

            const produtos = listData.produtos;
            const total = produtos.length;

            if (total === 0) {
                Swal.fire('Aviso', 'N√£o h√° produtos para deletar', 'info');
                return;
            }

            // Mostrar modal de progresso com novo spinner moderno
            Swal.fire({
                title: '<span class="animate__animated animate__fadeInDown">üóëÔ∏è Deletando produtos...</span>',
                html: `
                    <div class="mb-4 animate__animated animate__fadeIn animate__faster">
                        <!-- BIOMA Modern Loader - Spinner Premium -->
                        <div class="bioma-loader">
                            <div class="bioma-loader-ring"></div>
                            <div class="bioma-loader-ring"></div>
                            <div class="bioma-loader-ring"></div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="progress" style="height: 25px;">
                            <div id="barra-progresso-delete-produtos" class="progress-bar progress-bar-striped progress-bar-animated bg-danger"
                                 role="progressbar" style="width: 0%">0%</div>
                        </div>
                    </div>
                    <div class="text-start">
                        <p><strong>üì¶ Total:</strong> ${total} produtos</p>
                        <p><strong>‚öôÔ∏è Processados:</strong> <span id="progresso-delete-produtos">0</span>/${total}</p>
                        <p><strong>‚úÖ Deletados:</strong> <span id="deletados-produtos">0</span></p>
                        <p><strong>‚ùå Erros:</strong> <span id="erros-produtos">0</span></p>
                    </div>
                `,
                allowOutsideClick: false,
                showConfirmButton: false,
                showCancelButton: true,
                showCloseButton: true,
                cancelButtonText: '<i class="bi bi-x-circle"></i> Cancelar Processo',
                cancelButtonColor: '#dc3545',
                didOpen: () => {
                    // Bot√£o cancelar ativo, confirmar/fechar escondido
                    const confirmBtn = Swal.getConfirmButton();
                    const cancelBtn = Swal.getCancelButton();
                    const closeBtn = Swal.getCloseButton();

                    if (confirmBtn) confirmBtn.style.display = 'none';
                    if (closeBtn) closeBtn.style.display = 'none';

                    if (cancelBtn) {
                        cancelBtn.onclick = () => {
                            cancelarProcesso = true;
                            cancelBtn.disabled = true;
                            cancelBtn.innerHTML = '<i class="bi bi-hourglass"></i> Cancelando...';
                            cancelBtn.style.backgroundColor = '#6c757d';
                        };
                    }
                }
            });

            // Deletar cada produto
            for (let i = 0; i < total && !cancelarProcesso; i++) {
                const produto = produtos[i];
                try {
                    // Usar fetchWithTimeout para evitar travamento (timeout 30s, 1 retry)
                    const res = await fetchWithTimeout(`/api/produtos/${produto._id}`, {
                        method: 'DELETE',
                        credentials: 'include'
                    }, 30000, 1);

                    if (res.ok) {
                        deletados++;
                        const deletadosEl = document.getElementById('deletados-produtos');
                        if (deletadosEl) deletadosEl.textContent = deletados;
                    } else {
                        const errorData = await res.json().catch(() => ({}));
                        let motivo = errorData.message || `Erro HTTP ${res.status}`;

                        // Mensagem espec√≠fica para erro 520
                        if (res.status === 520) {
                            motivo = 'Servidor inst√°vel (erro 520). Tente novamente.';
                        }

                        erros++;
                        errosDetalhados.push({
                            produto: produto.nome || 'Sem nome',
                            motivo: motivo
                        });
                        const errosEl = document.getElementById('erros-produtos');
                        if (errosEl) errosEl.textContent = erros;
                    }
                } catch (e) {
                    erros++;
                    const motivo = e.message === 'Timeout: O servidor demorou muito para responder'
                        ? 'Timeout (servidor lento)'
                        : (e.message || 'Erro de conex√£o');
                    errosDetalhados.push({
                        produto: produto.nome || 'Sem nome',
                        motivo: motivo
                    });
                    const errosEl = document.getElementById('erros-produtos');
                    if (errosEl) errosEl.textContent = erros;
                }

                // Atualizar progresso
                const processados = i + 1;
                const percentual = Math.round((processados / total) * 100);
                const progressoEl = document.getElementById('progresso-delete-produtos');
                if (progressoEl) progressoEl.textContent = processados;
                const barra = document.getElementById('barra-progresso-delete-produtos');
                if (barra) {
                    barra.style.width = `${percentual}%`;
                    barra.textContent = `${percentual}%`;
                }
            }

            processoCompleto = !cancelarProcesso;

            // Montar mensagem de resultado
            let htmlResultado = `
                <div class="text-start">
                    <p><strong>Status:</strong> ${cancelarProcesso ? 'üõë Cancelado pelo usu√°rio' : '‚úÖ Conclu√≠do'}</p>
                    <p><strong>Processados:</strong> ${deletados + erros}/${total}</p>
                    <p><strong>‚úÖ Deletados:</strong> ${deletados}</p>
                    <p><strong>‚ùå Erros:</strong> ${erros}</p>
            `;

            if (errosDetalhados.length > 0 && errosDetalhados.length <= 10) {
                htmlResultado += '<hr><p><strong>Detalhes dos erros:</strong></p><ul>';
                errosDetalhados.forEach(erro => {
                    htmlResultado += `<li><strong>${erro.produto}:</strong> ${erro.motivo}</li>`;
                });
                htmlResultado += '</ul>';
            } else if (errosDetalhados.length > 10) {
                htmlResultado += `<hr><p><strong>Detalhes:</strong> ${errosDetalhados.length} erros (muito para exibir)</p>`;
            }

            htmlResultado += '</div>';

            // Mostrar resultado final com bot√£o OK
            await Swal.fire({
                title: cancelarProcesso ? 'Opera√ß√£o Cancelada' : 'Opera√ß√£o Conclu√≠da!',
                html: htmlResultado,
                icon: cancelarProcesso ? 'warning' : (deletados > 0 ? 'success' : 'error'),
                confirmButtonText: 'OK',
                confirmButtonColor: '#3085d6'
            });

            // SSE j√° faz o auto-refresh, n√£o precisamos chamar manualmente
            // (evita conflito entre refresh manual e m√∫ltiplos broadcasts SSE)
            await new Promise(resolve => setTimeout(resolve, 500));

        } catch (e) {
            console.error('‚ùå Erro ao deletar produtos:', e);
            Swal.fire({
                title: 'Erro',
                html: `
                    <p>Falha ao deletar produtos.</p>
                    <p><strong>Motivo:</strong> ${e.message || 'Erro desconhecido'}</p>
                `,
                icon: 'error'
            });
        }
    } else {
        console.log('‚ùå Opera√ß√£o cancelada pelo usu√°rio');
    }
}

// Fun√ß√£o para deletar TODOS os servi√ßos
async function deletarTodosServicos() {
    console.log('üóëÔ∏è deletarTodosServicos() chamada');

    const result = await window.Swal.fire({
        title: '‚ö†Ô∏è DELETAR TODOS OS SERVI√áOS?',
        html: `
            <div style="color: #EF4444; font-weight: bold; margin-bottom: 15px;">
                <i class="bi bi-exclamation-triangle-fill"></i> ATEN√á√ÉO: ESTA A√á√ÉO √â IRREVERS√çVEL!
            </div>
            <p>Esta a√ß√£o ir√° <strong>DELETAR PERMANENTEMENTE</strong> todos os servi√ßos do sistema.</p>
            <p style="color: #6B7280;">Digite <strong>CONFIRMAR</strong> para prosseguir:</p>
            <input type="text" id="confirmacao-deletar-servicos" class="swal2-input" placeholder="Digite CONFIRMAR">
        `,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#EF4444',
        cancelButtonColor: '#6c757d',
        confirmButtonText: '<i class="bi bi-trash-fill"></i> Sim, Deletar Todos',
        cancelButtonText: 'Cancelar',
        preConfirm: () => {
            const confirmacao = document.getElementById('confirmacao-deletar-servicos').value;
            if (confirmacao !== 'CONFIRMAR') {
                Swal.showValidationMessage('Digite "CONFIRMAR" para prosseguir');
                return false;
            }
            return true;
        }
    });

    if (result.isConfirmed) {
        console.log('‚úÖ Confirma√ß√£o recebida, deletando todos os servi√ßos...');

        let cancelarProcesso = false;
        let processoCompleto = false;
        let deletados = 0;
        let erros = 0;
        let errosDetalhados = [];

        try {
            // Buscar todos os servi√ßos primeiro
            const listRes = await fetch('/api/servicos', { credentials: 'include' });
            const listData = await listRes.json();

            if (!listData.success || !listData.servicos) {
                throw new Error(listData.message || 'N√£o foi poss√≠vel buscar a lista de servi√ßos');
            }

            const servicos = listData.servicos;
            const total = servicos.length;

            if (total === 0) {
                Swal.fire('Aviso', 'N√£o h√° servi√ßos para deletar', 'info');
                return;
            }

            // Mostrar modal de progresso com novo spinner moderno
            Swal.fire({
                title: '<span class="animate__animated animate__fadeInDown">üóëÔ∏è Deletando servi√ßos...</span>',
                html: `
                    <div class="mb-4 animate__animated animate__fadeIn animate__faster">
                        <!-- BIOMA Modern Loader - Spinner Premium -->
                        <div class="bioma-loader">
                            <div class="bioma-loader-ring"></div>
                            <div class="bioma-loader-ring"></div>
                            <div class="bioma-loader-ring"></div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="progress" style="height: 25px;">
                            <div id="barra-progresso-delete-servicos" class="progress-bar progress-bar-striped progress-bar-animated bg-danger"
                                 role="progressbar" style="width: 0%">0%</div>
                        </div>
                    </div>
                    <div class="text-start">
                        <p><strong>üì¶ Total:</strong> ${total} servi√ßos</p>
                        <p><strong>‚öôÔ∏è Processados:</strong> <span id="progresso-delete-servicos">0</span>/${total}</p>
                        <p><strong>‚úÖ Deletados:</strong> <span id="deletados-servicos">0</span></p>
                        <p><strong>‚ùå Erros:</strong> <span id="erros-servicos">0</span></p>
                    </div>
                `,
                allowOutsideClick: false,
                showConfirmButton: false,
                showCancelButton: true,
                showCloseButton: true,
                cancelButtonText: '<i class="bi bi-x-circle"></i> Cancelar Processo',
                cancelButtonColor: '#dc3545',
                didOpen: () => {
                    // Bot√£o cancelar ativo, confirmar/fechar escondido
                    const confirmBtn = Swal.getConfirmButton();
                    const cancelBtn = Swal.getCancelButton();
                    const closeBtn = Swal.getCloseButton();

                    if (confirmBtn) confirmBtn.style.display = 'none';
                    if (closeBtn) closeBtn.style.display = 'none';

                    if (cancelBtn) {
                        cancelBtn.onclick = () => {
                            cancelarProcesso = true;
                            cancelBtn.disabled = true;
                            cancelBtn.innerHTML = '<i class="bi bi-hourglass"></i> Cancelando...';
                            cancelBtn.style.backgroundColor = '#6c757d';
                        };
                    }
                }
            });

            // Deletar cada servi√ßo
            for (let i = 0; i < total && !cancelarProcesso; i++) {
                const servico = servicos[i];
                try {
                    // Usar fetchWithTimeout para evitar travamento (timeout 30s, 1 retry)
                    const res = await fetchWithTimeout(`/api/servicos/${servico._id}`, {
                        method: 'DELETE',
                        credentials: 'include'
                    }, 30000, 1);

                    if (res.ok) {
                        deletados++;
                        const deletadosEl = document.getElementById('deletados-servicos');
                        if (deletadosEl) deletadosEl.textContent = deletados;
                    } else {
                        const errorData = await res.json().catch(() => ({}));
                        let motivo = errorData.message || `Erro HTTP ${res.status}`;

                        // Mensagem espec√≠fica para erro 520
                        if (res.status === 520) {
                            motivo = 'Servidor inst√°vel (erro 520). Tente novamente.';
                        }

                        erros++;
                        errosDetalhados.push({
                            servico: servico.nome || 'Sem nome',
                            motivo: motivo
                        });
                        const errosEl = document.getElementById('erros-servicos');
                        if (errosEl) errosEl.textContent = erros;
                    }
                } catch (e) {
                    erros++;
                    const motivo = e.message === 'Timeout: O servidor demorou muito para responder'
                        ? 'Timeout (servidor lento)'
                        : (e.message || 'Erro de conex√£o');
                    errosDetalhados.push({
                        servico: servico.nome || 'Sem nome',
                        motivo: motivo
                    });
                    const errosEl = document.getElementById('erros-servicos');
                    if (errosEl) errosEl.textContent = erros;
                }

                // Atualizar progresso
                const processados = i + 1;
                const percentual = Math.round((processados / total) * 100);
                const progressoEl = document.getElementById('progresso-delete-servicos');
                if (progressoEl) progressoEl.textContent = processados;
                const barra = document.getElementById('barra-progresso-delete-servicos');
                if (barra) {
                    barra.style.width = `${percentual}%`;
                    barra.textContent = `${percentual}%`;
                }
            }

            processoCompleto = !cancelarProcesso;

            // Montar mensagem de resultado
            let htmlResultado = `
                <div class="text-start">
                    <p><strong>Status:</strong> ${cancelarProcesso ? 'üõë Cancelado pelo usu√°rio' : '‚úÖ Conclu√≠do'}</p>
                    <p><strong>Processados:</strong> ${deletados + erros}/${total}</p>
                    <p><strong>‚úÖ Deletados:</strong> ${deletados}</p>
                    <p><strong>‚ùå Erros:</strong> ${erros}</p>
            `;

            if (errosDetalhados.length > 0 && errosDetalhados.length <= 10) {
                htmlResultado += '<hr><p><strong>Detalhes dos erros:</strong></p><ul>';
                errosDetalhados.forEach(erro => {
                    htmlResultado += `<li><strong>${erro.servico}:</strong> ${erro.motivo}</li>`;
                });
                htmlResultado += '</ul>';
            } else if (errosDetalhados.length > 10) {
                htmlResultado += `<hr><p><strong>Detalhes:</strong> ${errosDetalhados.length} erros (muito para exibir)</p>`;
            }

            htmlResultado += '</div>';

            // Mostrar resultado final com bot√£o OK
            await Swal.fire({
                title: cancelarProcesso ? 'Opera√ß√£o Cancelada' : 'Opera√ß√£o Conclu√≠da!',
                html: htmlResultado,
                icon: cancelarProcesso ? 'warning' : (deletados > 0 ? 'success' : 'error'),
                confirmButtonText: 'OK',
                confirmButtonColor: '#3085d6'
            });

            // SSE j√° faz o auto-refresh, n√£o precisamos chamar manualmente
            // (evita conflito entre refresh manual e m√∫ltiplos broadcasts SSE)
            await new Promise(resolve => setTimeout(resolve, 500));

        } catch (e) {
            console.error('‚ùå Erro ao deletar servi√ßos:', e);
            Swal.fire({
                title: 'Erro',
                html: `
                    <p>Falha ao deletar servi√ßos.</p>
                    <p><strong>Motivo:</strong> ${e.message || 'Erro desconhecido'}</p>
                `,
                icon: 'error'
            });
        }
    } else {
        console.log('‚ùå Opera√ß√£o cancelada pelo usu√°rio');
    }
}

// Global variable to store all budgets for filtering
let todosOrcamentos = [];

async function loadConsultar(){
    const key = 'loadConsultar';
    if (isLoading(key)) {
        console.warn(`‚ö†Ô∏è J√° carregando: ${key}`);
        return;
    }
    setLoading(key, true);

    try{
        const res=await fetch('/api/orcamentos',{credentials:'include'});
        const data=await res.json();
        if(data.success&&data.orcamentos&&data.orcamentos.length>0){
            todosOrcamentos = data.orcamentos; // Store all budgets
            filtrarOrcamentos(); // Apply filters
        }else{
            todosOrcamentos = [];
            const tbody=document.getElementById('consultaBody');
            tbody.innerHTML='<tr><td colspan="6" class="text-center text-muted">Nenhum or√ßamento encontrado</td></tr>';
            document.getElementById('consultaResultCount').textContent = '0 or√ßamentos encontrados';
        }
    }catch(e){
        console.error(e);
        todosOrcamentos = [];
        const tbody=document.getElementById('consultaBody');
        tbody.innerHTML='<tr><td colspan="6" class="text-center text-danger">Erro ao carregar or√ßamentos</td></tr>';
    } finally {
        setTimeout(() => setLoading(key, false), 250);
    }
}

function filtrarOrcamentos(){
    const searchTerm = document.getElementById('consultaSearch').value.toLowerCase();
    const statusFilter = document.getElementById('consultaStatusFilter').value;
    const dataInicio = document.getElementById('consultaDataInicio').value;
    const dataFim = document.getElementById('consultaDataFim').value;

    let filtrados = todosOrcamentos;

    // Apply search filter
    if(searchTerm){
        filtrados = filtrados.filter(o => {
            const numero = String(o.numero).toLowerCase();
            const cliente = (o.cliente_nome || '').toLowerCase();
            return numero.includes(searchTerm) || cliente.includes(searchTerm);
        });
    }

    // Apply status filter
    if(statusFilter){
        filtrados = filtrados.filter(o => o.status === statusFilter);
    }

    // Apply date range filter
    if(dataInicio){
        const dataInicioDate = new Date(dataInicio);
        filtrados = filtrados.filter(o => {
            const orcamentoDate = new Date(o.created_at);
            return orcamentoDate >= dataInicioDate;
        });
    }

    if(dataFim){
        const dataFimDate = new Date(dataFim);
        dataFimDate.setHours(23, 59, 59, 999); // Include entire day
        filtrados = filtrados.filter(o => {
            const orcamentoDate = new Date(o.created_at);
            return orcamentoDate <= dataFimDate;
        });
    }

    // Render filtered results
    const tbody = document.getElementById('consultaBody');
    if(filtrados.length > 0){
        const html = filtrados.map(o => {
            const statusClass = o.status === 'Aprovado' ? 'success' : (o.status === 'Cancelado' ? 'danger' : 'warning');
            return `<tr><td><strong>#${o.numero}</strong></td><td>${new Date(o.created_at).toLocaleDateString('pt-BR')}</td><td>${o.cliente_nome}</td><td><strong>R$ ${o.total_final.toFixed(2)}</strong></td><td><span class="badge ${statusClass}">${o.status}</span></td><td><button class="bioma-btn bioma-btn-sm bioma-btn-info" onclick="visualizarOrcamento('${o._id}')" style="background:linear-gradient(135deg,#3B82F6,#2563EB);color:#fff;margin-right:5px"><i class="bi bi-eye"></i></button><button class="bioma-btn bioma-btn-sm bioma-btn-primary" onclick="editarOrcamento('${o._id}')" style="margin-right:5px"><i class="bi bi-pencil"></i></button><button class="bioma-btn bioma-btn-sm bioma-btn-danger" onclick="deleteOrcamento('${o._id}')"><i class="bi bi-trash"></i></button></td></tr>`;
        }).join('');
        tbody.innerHTML = html;
    }else{
        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Nenhum or√ßamento encontrado com os filtros aplicados</td></tr>';
    }

    // Update result count
    document.getElementById('consultaResultCount').textContent =
        `${filtrados.length} de ${todosOrcamentos.length} or√ßamentos encontrados`;
}

function limparFiltrosOrcamentos(){
    document.getElementById('consultaSearch').value = '';
    document.getElementById('consultaStatusFilter').value = '';
    document.getElementById('consultaDataInicio').value = '';
    document.getElementById('consultaDataFim').value = '';
    filtrarOrcamentos();
}

async function deleteOrcamento(id){
    const result=await Swal.fire({title:'Deletar?',icon:'warning',showCancelButton:true});
    if(result.isConfirmed){
        try{
            await fetch(`/api/orcamentos/${id}`,{method:'DELETE',credentials:'include'});
            Swal.fire('Deletado!','','success');
            loadConsultar();
        }catch(e){
            Swal.fire('Erro','','error');
        }
    }
}

async function loadContratos(){
    const key = 'loadContratos';
    if (isLoading(key)) {
        console.warn(`‚ö†Ô∏è J√° carregando: ${key}`);
        return;
    }
    setLoading(key, true);

    try{
        const res=await fetch('/api/contratos',{credentials:'include'});
        const data=await res.json();
        const tbody=document.getElementById('contratosBody');
        if(data.success&&data.contratos&&data.contratos.length>0){
            const html=data.contratos.map(c=>{
                const dataFormatada = new Date(c.created_at).toLocaleDateString('pt-BR');
                return `<tr>
                    <td><strong style="color: var(--primary); font-size: 1.1rem;">#${c.numero}</strong></td>
                    <td>${dataFormatada}</td>
                    <td><strong>${c.cliente_nome}</strong></td>
                    <td><strong style="color: var(--success); font-size: 1.1rem;">R$ ${c.total_final.toFixed(2)}</strong></td>
                    <td><span class="badge success">APROVADO</span></td>
                    <td>
                        <button class="btn btn-sm" onclick="visualizarOrcamento('${c._id}')" style="background:linear-gradient(135deg,#3B82F6,#2563EB);color:#fff;margin-right:5px" title="Visualizar Detalhes">
                            <i class="bi bi-eye"></i>
                        </button>
                        <a href="/api/orcamento/${c._id}/pdf" target="_blank" class="bioma-btn bioma-btn-sm bioma-btn-danger" style="margin-right:5px" title="Gerar PDF">
                            <i class="bi bi-file-pdf"></i>
                        </a>
                        <button class="btn btn-sm" onclick="enviarContratoEmail('${c._id}')" style="background:linear-gradient(135deg,#10B981,#059669);color:#fff;margin-right:5px" title="Enviar por Email">
                            <i class="bi bi-envelope-fill"></i>
                        </button>
                        <button class="btn btn-sm" onclick="enviarContratoWhatsApp('${c._id}')" style="background:linear-gradient(135deg,#25D366,#128C7E);color:#fff" title="Enviar por WhatsApp">
                            <i class="bi bi-whatsapp"></i>
                        </button>
                    </td>
                </tr>`;
            }).join('');
            tbody.innerHTML=html;
        }else{
            tbody.innerHTML='<tr><td colspan="6" class="text-center text-muted"><i class="bi bi-inbox" style="font-size: 3rem; opacity: 0.3;"></i><br>Nenhum contrato aprovado ainda</td></tr>';
        }
    }catch(e){
        console.error('‚ùå Erro ao carregar contratos:',e);
        Swal.fire('Erro','N√£o foi poss√≠vel carregar os contratos','error');
    } finally {
        setTimeout(() => setLoading(key, false), 250);
    }
}

// ========== FUN√á√ïES DE ENVIO DE CONTRATOS ==========

/**
 * Enviar contrato via WhatsApp
 */
async function enviarContratoWhatsApp(contratoId) {
    try {
        // Buscar dados do contrato
        const res = await fetch(`/api/orcamento/${contratoId}`, {credentials: 'include'});
        const data = await res.json();

        if(!data.success) {
            throw new Error(data.message || 'Erro ao buscar contrato');
        }

        const contrato = data.orcamento;

        // Buscar dados do cliente para telefone
        const clienteRes = await fetch(`/api/cliente/${contrato.cliente_id}`, {credentials: 'include'});
        const clienteData = await clienteRes.json();

        if(!clienteData.success || !clienteData.cliente.telefone) {
            Swal.fire({
                icon: 'warning',
                title: 'Cliente sem telefone',
                text: 'Este cliente n√£o possui telefone cadastrado',
                confirmButtonText: 'OK'
            });
            return;
        }

        const telefone = clienteData.cliente.telefone.replace(/\D/g, ''); // Remove formata√ß√£o

        // Montar mensagem
        const dataFormatada = new Date(contrato.created_at).toLocaleDateString('pt-BR');
        const mensagem = `
üå≥ *BIOMA Uberaba - Contrato #${contrato.numero}*

Ol√°, ${contrato.cliente_nome}!

Seu contrato foi aprovado! ‚úÖ

üìä *Valor Total:* R$ ${contrato.total_final.toFixed(2)}
üìÖ *Data:* ${dataFormatada}
üí≥ *Pagamento:* ${contrato.forma_pagamento || 'Cr√©dito √† Vista'}

üîó *Visualizar PDF:*
${window.location.origin}/api/orcamento/${contratoId}/pdf

Obrigado pela prefer√™ncia! üåø
_Equipe BIOMA Uberaba_
        `.trim();

        // Abrir WhatsApp
        const url = `https://wa.me/55${telefone}?text=${encodeURIComponent(mensagem)}`;
        window.open(url, '_blank');

        console.log('‚úÖ WhatsApp aberto com sucesso');

    } catch(error) {
        console.error('‚ùå Erro ao enviar WhatsApp:', error);
        Swal.fire({
            icon: 'error',
            title: 'Erro ao abrir WhatsApp',
            text: error.message || 'N√£o foi poss√≠vel enviar pelo WhatsApp',
            confirmButtonText: 'OK'
        });
    }
}

/**
 * Enviar contrato via Email
 */
async function enviarContratoEmail(contratoId) {
    try {
        // Show loading modal
        Swal.fire({
            title: 'Enviando E-mail...',
            html: '<div class="spinner"></div><p style="margin-top:20px">Aguarde enquanto enviamos o contrato...</p>',
            allowOutsideClick: false,
            showConfirmButton: false
        });

        const res = await fetch(`/api/orcamento/${contratoId}/enviar-email`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            credentials: 'include'
        });

        const data = await res.json();

        // IMPORTANT: Close loading modal before showing result
        Swal.close();

        if(data.success) {
            Swal.fire({
                icon: 'success',
                title: 'E-mail Enviado!',
                html: `
                    <p>Contrato enviado com sucesso para:</p>
                    <p style="font-weight:700;color:var(--primary);font-size:1.1rem">${data.destinatario || 'cliente'}</p>
                `,
                timer: 4000,
                timerProgressBar: true,
                showConfirmButton: true,
                confirmButtonText: 'OK'
            });
        } else {
            throw new Error(data.message || 'Erro ao enviar e-mail');
        }
    } catch(error) {
        console.error('‚ùå Erro ao enviar email:', error);

        // CRITICAL: Always close loading modal on error
        Swal.close();

        // Then show error
        Swal.fire({
            icon: 'error',
            title: 'Erro ao Enviar E-mail',
            text: error.message || 'N√£o foi poss√≠vel enviar o e-mail. Verifique as configura√ß√µes SMTP.',
            confirmButtonText: 'OK'
        });
    }
}

async function loadComissoes(){
    const key = 'loadComissoes';
    if (isLoading(key)) {
        console.warn(`‚ö†Ô∏è J√° carregando: ${key}`);
        return;
    }
    setLoading(key, true);

    console.log('üí∞ Carregando hist√≥rico de comiss√µes...');

    // Carregar tamb√©m gr√°ficos e top performers em paralelo
    loadComissoesChart();
    loadTopPerformers();

    // Adicionar timeout para evitar carregamento infinito
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 15000); // 15 segundos de timeout

    try{
        const res = await fetch('/api/comissoes', {
            credentials: 'include',
            signal: controller.signal
        });
        clearTimeout(timeoutId);
        const data = await res.json();
        // Tentar m√∫ltiplos elementos para comiss√µes
        let tbody = document.getElementById('comissoesBody');
        if(!tbody) tbody = document.getElementById('historicoComissoesBody');
        if(!tbody) tbody = document.getElementById('tabelaHistoricoComissoes');

        if(!tbody){
            console.error('‚ùå Nenhum elemento tbody de comiss√µes encontrado');
            setLoading(key, false);
            return;
        }

        // A API retorna hist√≥rico de comiss√µes, n√£o regras
        if(data.success && data.comissoes && data.comissoes.length > 0){
            const html = data.comissoes.map(c => `
                <tr>
                    <td><strong>${c.profissional_nome}</strong></td>
                    <td>${c.cliente_nome}</td>
                    <td>#${c.orcamento_numero}</td>
                    <td><strong style="color: var(--success);">R$ ${c.comissao_valor.toFixed(2)}</strong></td>
                    <td>${new Date(c.data_registro).toLocaleDateString('pt-BR')}</td>
                </tr>
            `).join('');
            tbody.innerHTML = html;
            console.log(`‚úÖ ${data.comissoes.length} comiss√µes carregadas`);
        }else{
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center" style="padding: 40px; color: var(--text-muted);">
                        <i class="bi bi-info-circle" style="font-size: 3rem; opacity: 0.3;"></i>
                        <p style="margin-top: 15px; font-weight: 600; font-size: 1.1rem;">Nenhuma comiss√£o registrada ainda</p>
                        <p style="color: var(--text-secondary); font-size: 0.9rem;">As comiss√µes aparecer√£o aqui quando or√ßamentos forem aprovados</p>
                    </td>
                </tr>
            `;
            console.log('‚ÑπÔ∏è Nenhuma comiss√£o no hist√≥rico');
        }
    }catch(e){
        console.error('‚ùå Erro ao carregar comiss√µes:', e);
        // Tentar m√∫ltiplos elementos
        let tbody = document.getElementById('comissoesBody');
        if(!tbody) tbody = document.getElementById('historicoComissoesBody');
        if(!tbody) tbody = document.getElementById('tabelaHistoricoComissoes');
        if(tbody){
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center" style="padding: 40px; color: var(--danger);">
                        <i class="bi bi-exclamation-triangle" style="font-size: 2rem;"></i>
                        <p style="margin-top: 10px;">Erro ao carregar comiss√µes</p>
                        <small>${e.message || 'Verifique a conex√£o com o servidor'}</small>
                        <br>
                        <button class="bioma-btn bioma-btn-sm bioma-btn-outline" onclick="loadComissoes()" style="margin-top: 10px;">
                            <i class="bi bi-arrow-clockwise"></i> Tentar Novamente
                        </button>
                    </td>
                </tr>
            `;
        }
        setLoading(key, false);
    } finally {
        setTimeout(() => setLoading(key, false), 500);
    }
}

// Carregar gr√°fico de desempenho de comiss√µes (por m√™s)
async function loadComissoesChart(){
    try {
        const res = await fetch('/api/comissoes', {credentials: 'include'});
        const data = await res.json();

        if (!data.success || !data.comissoes || data.comissoes.length === 0) {
            const canvas = document.getElementById('chartComissoes');
            if (canvas) {
                canvas.style.display = 'none';
                canvas.parentElement.innerHTML = '<p class="text-center text-muted" style="padding: 40px;">Nenhum dado de comiss√µes dispon√≠vel</p>';
            }
            return;
        }

        // Agrupar comiss√µes por m√™s
        const meses = {};
        data.comissoes.forEach(c => {
            const data_registro = new Date(c.data_registro);
            const mesAno = `${data_registro.getMonth() + 1}/${data_registro.getFullYear()}`;
            if (!meses[mesAno]) {
                meses[mesAno] = 0;
            }
            meses[mesAno] += c.comissao_valor || 0;
        });

        // Ordenar por data
        const labels = Object.keys(meses).sort((a, b) => {
            const [mesA, anoA] = a.split('/').map(Number);
            const [mesB, anoB] = b.split('/').map(Number);
            return (anoA * 12 + mesA) - (anoB * 12 + mesB);
        });
        const valores = labels.map(label => meses[label]);

        // Criar gr√°fico com Chart.js
        const ctx = document.getElementById('chartComissoes');
        if (ctx && window.Chart) {
            // Destruir gr√°fico anterior se existir
            if (window.chartComissoesInstance) {
                window.chartComissoesInstance.destroy();
            }

            window.chartComissoesInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Comiss√µes (R$)',
                        data: valores,
                        borderColor: 'rgb(124, 58, 237)',
                        backgroundColor: 'rgba(124, 58, 237, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'R$ ' + value.toFixed(0);
                                }
                            }
                        }
                    }
                }
            });
        }
    } catch (error) {
        console.error('Erro ao carregar gr√°fico de comiss√µes:', error);
    }
}

// Carregar Top Performers
async function loadTopPerformers(){
    try {
        const res = await fetch('/api/comissoes', {credentials: 'include'});
        const data = await res.json();

        const container = document.getElementById('topPerformersBody');
        if (!container) return;

        if (!data.success || !data.comissoes || data.comissoes.length === 0) {
            container.innerHTML = '<p class="text-center text-muted" style="padding: 20px;">Nenhum dado dispon√≠vel</p>';
            return;
        }

        // Agrupar por profissional
        const profissionais = {};
        data.comissoes.forEach(c => {
            const nome = c.profissional_nome;
            if (!profissionais[nome]) {
                profissionais[nome] = {
                    nome: nome,
                    total: 0,
                    quantidade: 0
                };
            }
            profissionais[nome].total += c.comissao_valor || 0;
            profissionais[nome].quantidade += 1;
        });

        // Ordenar por total e pegar top 5
        const top = Object.values(profissionais)
            .sort((a, b) => b.total - a.total)
            .slice(0, 5);

        if (top.length === 0) {
            container.innerHTML = '<p class="text-center text-muted" style="padding: 20px;">Nenhum profissional com comiss√µes</p>';
            return;
        }

        // Renderizar top performers
        const html = top.map((prof, index) => `
            <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background: var(--bg-main); border-radius: 10px; margin-bottom: 10px;">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div style="background: linear-gradient(135deg, var(--primary), var(--secondary)); color: #fff; width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 0.9rem;">
                        ${index + 1}
                    </div>
                    <div>
                        <div style="font-weight: 700; color: var(--text-primary);">${prof.nome}</div>
                        <div style="font-size: 0.85rem; color: var(--text-secondary);">${prof.quantidade} comiss√µes</div>
                    </div>
                </div>
                <div style="text-align: right;">
                    <div style="font-weight: 900; font-size: 1.1rem; color: var(--success);">R$ ${prof.total.toFixed(2)}</div>
                </div>
            </div>
        `).join('');

        container.innerHTML = html;
    } catch (error) {
        console.error('Erro ao carregar top performers:', error);
        const container = document.getElementById('topPerformersBody');
        if (container) {
            container.innerHTML = '<p class="text-center text-danger" style="padding: 20px;">Erro ao carregar dados</p>';
        }
    }
}

// Fun√ß√£o para modal de nova comiss√£o
function showModalComissao() {
    window.Swal.fire({
        title: '<i class="bi bi-info-circle"></i> Comiss√µes Autom√°ticas',
        html: `
            <div style="text-align: left; padding: 20px;">
                <p style="margin-bottom: 15px;">
                    <i class="bi bi-check-circle-fill" style="color: var(--success);"></i>
                    <strong>As comiss√µes s√£o geradas automaticamente</strong> quando um or√ßamento √© aprovado.
                </p>
                <p style="margin-bottom: 15px;">
                    <i class="bi bi-calculator" style="color: var(--primary);"></i>
                    O valor da comiss√£o √© calculado com base no <strong>percentual configurado</strong>
                    para cada profissional.
                </p>
                <p style="margin-bottom: 15px;">
                    <i class="bi bi-person-badge" style="color: var(--info);"></i>
                    Para ajustar o <strong>percentual de comiss√£o</strong> de um profissional,
                    v√° para a se√ß√£o <strong>Profissionais</strong> e edite as informa√ß√µes do profissional.
                </p>
                <div style="background: rgba(var(--warning-rgb), 0.1); padding: 15px; border-radius: 8px; border-left: 4px solid var(--warning); margin-top: 20px;">
                    <i class="bi bi-lightbulb" style="color: var(--warning);"></i>
                    <strong>Dica:</strong> As comiss√µes aparecem na aba <em>Comiss√µes</em> do m√≥dulo Financeiro.
                </div>
            </div>
        `,
        icon: 'info',
        confirmButtonText: '<i class="bi bi-check-lg"></i> Entendi',
        confirmButtonColor: 'var(--primary)',
        width: '600px'
    });
}

// Vari√°vel para controlar o auto-refresh da fila
let filaRefreshInterval = null;

async function loadFila(silent = false){
    const key = 'loadFila';
    if (isLoading(key)) {
        console.warn(`‚ö†Ô∏è J√° carregando: ${key}`);
        return;
    }
    setLoading(key, true);

    try{
        const res=await fetch('/api/fila',{credentials:'include'});
        const data=await res.json();
        const container=document.getElementById('filaContainer');

        if(data.success&&data.fila&&data.fila.length>0){
            document.getElementById('totalFila').textContent=data.fila.length;
            
            const html=data.fila.map((f,idx)=>`
                <div style="padding:20px;border:2px solid var(--border-color);border-radius:15px;margin-bottom:15px;display:flex;justify-content:space-between;align-items:center;background:var(--bg-card);transition:all 0.3s;box-shadow:var(--shadow);" onmouseover="this.style.transform='translateX(5px)';this.style.borderColor='var(--primary)'" onmouseout="this.style.transform='translateX(0)';this.style.borderColor='var(--border-color)'">
                    <div style="flex:1">
                        <div style="display:flex;align-items:center;gap:15px;">
                            <div style="width:60px;height:60px;border-radius:50%;background:linear-gradient(135deg,var(--primary),var(--secondary));color:white;display:flex;align-items:center;justify-content:center;font-size:1.8rem;font-weight:900;box-shadow:0 5px 15px rgba(124,58,237,0.3);">
                                #${idx+1}
                            </div>
                            <div>
                                <strong style="font-size:1.2rem;color:var(--text-primary);display:block;">${f.cliente_nome}</strong>
                                <small style="color:var(--text-secondary);display:flex;align-items:center;gap:5px;margin-top:5px;">
                                    <i class="bi bi-telephone"></i> ${f.cliente_telefone||'Sem telefone'}
                                </small>
                                <small style="color:var(--text-muted);display:block;margin-top:3px;">
                                    <i class="bi bi-clock"></i> Adicionado: ${new Date(f.created_at || new Date()).toLocaleTimeString('pt-BR')}
                                </small>
                            </div>
                        </div>
                    </div>
                    <div>
                        <button class="bioma-btn bioma-btn-sm bioma-btn-success" onclick="chamarProximo('${f._id}')" style="margin-right:8px;" title="Chamar para atendimento">
                            <i class="bi bi-check-circle"></i> Chamar
                        </button>
                        <button class="bioma-btn bioma-btn-sm bioma-btn-danger" onclick="removeFila('${f._id}')" title="Remover da fila">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML=html;
        }else{
            document.getElementById('totalFila').textContent='0';
            container.innerHTML=`
                <div style="text-align:center;padding:60px 20px;color:var(--text-muted);">
                    <i class="bi bi-people" style="font-size:5rem;opacity:0.3;"></i>
                    <h3 style="margin-top:20px;color:var(--text-secondary);">Fila Vazia</h3>
                    <p>Nenhuma pessoa aguardando atendimento</p>
                </div>
            `;
        }
    }catch(e){
        console.error('‚ùå Erro ao carregar fila:',e);
        if (!silent) {
            Swal.fire('Erro','N√£o foi poss√≠vel carregar a fila','error');
        }
    } finally {
        setTimeout(() => setLoading(key, false), 250);
    }
}

async function chamarProximo(id){
    const result = await Swal.fire({
        title: 'Chamar para Atendimento?',
        text: 'Este cliente ser√° atendido e removido da fila',
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'Sim, chamar',
        cancelButtonText: 'Cancelar'
    });

    if(result.isConfirmed){
        try{
            await fetch(`/api/fila/${id}`,{method:'DELETE',credentials:'include'});
            Swal.fire({
                icon: 'success',
                title: '‚úÖ Cliente Chamado!',
                text: 'Cliente pronto para atendimento',
                timer: 2000
            });
            loadFila();
        }catch(e){
            Swal.fire('Erro','N√£o foi poss√≠vel processar','error');
        }
    }

}

async function removeFila(id){
    const result = await Swal.fire({
        title: 'Remover da Fila?',
        text: 'O cliente ser√° removido da fila de atendimento',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Sim, remover',
        cancelButtonText: 'Cancelar',
        confirmButtonColor: '#EF4444'
    });

    if(result.isConfirmed){
        try{
            await fetch(`/api/fila/${id}`,{method:'DELETE',credentials:'include'});
            Swal.fire({
                icon: 'success',
                title: 'Removido!',
                text: 'Cliente removido da fila',
                timer: 1500
            });
            loadFila();
        }catch(e){
            console.error('‚ùå Erro ao remover da fila:',e);
            Swal.fire('Erro','N√£o foi poss√≠vel remover da fila','error');
        }
    }

}

function showModalFila(){
    Swal.fire({
        title: '<strong>üë• Adicionar √† Fila</strong>',
        html: `
            <div style="text-align: left; padding: 10px;">
                <div class="mb-3">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">
                        <i class="bi bi-person"></i> Nome do Cliente:
                    </label>
                    <input type="text" id="swal-nome" class="form-control" placeholder="Digite o nome completo">
                </div>
                <div class="mb-3">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">
                        <i class="bi bi-telephone"></i> Telefone (opcional):
                    </label>
                    <input type="text" id="swal-telefone" class="form-control" placeholder="(00) 00000-0000">
                </div>
                <div class="alert alert-info" style="margin-top: 15px; font-size: 0.9rem;">
                    <i class="bi bi-info-circle"></i> O cliente ser√° adicionado ao final da fila de atendimento
                </div>
            </div>
        `,
        showCancelButton: true,
        confirmButtonText: '<i class="bi bi-plus-circle"></i> Adicionar',
        cancelButtonText: 'Cancelar',
        width: '500px',
        allowEscapeKey: true,
        allowOutsideClick: true,
        showCloseButton: true,
        preConfirm: () => {
            const cliente_nome = document.getElementById('swal-nome').value.trim();
            const cliente_telefone = document.getElementById('swal-telefone').value.trim();
            
            if(!cliente_nome){
                Swal.showValidationMessage('Nome do cliente √© obrigat√≥rio');
                return false;
            }
            
            return {
                cliente_nome,
                cliente_telefone: cliente_telefone || 'N√£o informado'
            };
        }
    }).then(async(result) => {
        if(result.isConfirmed){
            try{
                const response = await fetch('/api/fila',{
                    method:'POST',
                    headers:{'Content-Type':'application/json'},
                    credentials:'include',
                    body:JSON.stringify(result.value)
                });
                
                const data = await response.json();
                
                if(data.success){
                    Swal.fire({
                        icon: 'success',
                        title: '‚úÖ Adicionado!',
                        text: 'Cliente adicionado √† fila com sucesso',
                        timer: 2000
                    });
                    loadFila();
                } else {
                    mostrarNotificacao('error', data.message || 'Erro ao adicionar √† fila');
                }
            }catch(e){
                console.error('Erro:', e);
                mostrarNotificacao('error', 'N√£o foi poss√≠vel adicionar √† fila');
            }
        }
    });
}

async function loadAgendamentos(){
    const key = 'loadAgendamentos';

    // PROTE√á√ÉO ANTI-LOOP
    if (isLoading(key)) {
        console.warn(`‚ö†Ô∏è J√° carregando: ${key}`);
        return;
    }

    setLoading(key, true);

    try{
        const res=await fetch('/api/agendamentos',{credentials:'include'});
        const data=await res.json();

        // Atualizar TODOS os tbody de agendamentos
        const tbodies = [
            document.getElementById('agendamentosHojeBody'),
            document.getElementById('agendamentosSemanaBody'),
            document.getElementById('agendamentosMesBody'),
            document.getElementById('agendamentosTodosBody')
        ];

        if(data.success&&data.agendamentos&&data.agendamentos.length>0){
            const hoje = new Date();
            hoje.setHours(0, 0, 0, 0);

            const amanha = new Date(hoje);
            amanha.setDate(amanha.getDate() + 1);

            const proximaSemana = new Date(hoje);
            proximaSemana.setDate(proximaSemana.getDate() + 7);

            const proximoMes = new Date(hoje);
            proximoMes.setMonth(proximoMes.getMonth() + 1);

            // Filtrar agendamentos
            const agendamentosHoje = data.agendamentos.filter(a => {
                const dataAgend = new Date(a.data);
                dataAgend.setHours(0, 0, 0, 0);
                return dataAgend.getTime() === hoje.getTime();
            });

            const agendamentosSemana = data.agendamentos.filter(a => {
                const dataAgend = new Date(a.data);
                return dataAgend >= hoje && dataAgend < proximaSemana;
            });

            const agendamentosMes = data.agendamentos.filter(a => {
                const dataAgend = new Date(a.data);
                return dataAgend >= hoje && dataAgend < proximoMes;
            });

            // Fun√ß√£o auxiliar para renderizar HTML
            const renderAgendamento = (a) => {
                const dataFormatada = new Date(a.data).toLocaleDateString('pt-BR');
                const statusBadge = a.status === 'Confirmado' ? 'success' :
                                   a.status === 'Pendente' ? 'warning' :
                                   a.status === 'Cancelado' ? 'danger' : 'secondary';
                return `<tr>
                    <td><strong>${dataFormatada}</strong></td>
                    <td><strong style="color: var(--primary); font-size: 1.1rem;">${a.horario}</strong></td>
                    <td>${a.cliente_nome}</td>
                    <td>${a.servico_nome||'<span class="text-muted">N√£o especificado</span>'}</td>
                    <td>${a.profissional_nome||'<span class="text-muted">N√£o atribu√≠do</span>'}</td>
                    <td><span class="badge ${statusBadge}">${a.status||'Pendente'}</span></td>
                    <td>
                        <button class="bioma-btn bioma-btn-sm bioma-btn-danger" onclick="cancelarAgendamento('${a._id}')" title="Cancelar">
                            <i class="bi bi-x-circle"></i>
                        </button>
                    </td>
                </tr>`;
            };

            // Hoje
            if(tbodies[0]){
                const html = agendamentosHoje.length > 0 ? agendamentosHoje.map(renderAgendamento).join('') : '<tr><td colspan="7" class="text-center text-muted">Nenhum agendamento para hoje</td></tr>';
                tbodies[0].innerHTML = html;
            }

            // Pr√≥xima semana
            if(tbodies[1]){
                const html = agendamentosSemana.length > 0 ? agendamentosSemana.map(renderAgendamento).join('') : '<tr><td colspan="7" class="text-center text-muted">Nenhum agendamento nos pr√≥ximos 7 dias</td></tr>';
                tbodies[1].innerHTML = html;
            }

            // Pr√≥ximo m√™s
            if(tbodies[2]){
                const html = agendamentosMes.length > 0 ? agendamentosMes.map(renderAgendamento).join('') : '<tr><td colspan="7" class="text-center text-muted">Nenhum agendamento nos pr√≥ximos 30 dias</td></tr>';
                tbodies[2].innerHTML = html;
            }

            // Todos
            if(tbodies[3]){
                const html = data.agendamentos.map(renderAgendamento).join('');
                tbodies[3].innerHTML = html;
            }
        }else{
            tbodies.forEach(tb => {
                if(tb) tb.innerHTML='<tr><td colspan="7" class="text-center text-muted"><i class="bi bi-calendar-x" style="font-size: 3rem; opacity: 0.3;"></i><br>Nenhum agendamento cadastrado</td></tr>';
            });
        }
    }catch(e){
        console.error('‚ùå Erro ao carregar agendamentos:',e);
    } finally {
        setTimeout(() => setLoading(key, false), 250);
    }
}

async function cancelarAgendamento(id){
    const result = await Swal.fire({
        title: 'Cancelar Agendamento?',
        text: 'Esta a√ß√£o n√£o pode ser desfeita',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Sim, cancelar',
        cancelButtonText: 'N√£o'
    });

    if(result.isConfirmed){
        try{
            await fetch(`/api/agendamentos/${id}`,{method:'DELETE',credentials:'include'});
            Swal.fire('Cancelado!','Agendamento cancelado com sucesso','success');
            loadAgendamentos();
        }catch(e){
            Swal.fire('Erro','N√£o foi poss√≠vel cancelar o agendamento','error');
        }
    }

}

async function visualizarAgendamento(id){
    try{
        const res = await fetch(`/api/agendamentos/${id}`, {credentials:'include'});
        const data = await res.json();

        if(data.success && data.agendamento){
            const ag = data.agendamento;
            const dataHora = new Date(ag.data_hora).toLocaleString('pt-BR');

            Swal.fire({
                title: '<strong>üìÖ Detalhes do Agendamento</strong>',
                html: `
                    <div style="text-align: left; padding: 20px;">
                        <div style="background: linear-gradient(135deg, #7C3AED, #EC4899); color: #fff; padding: 20px; border-radius: 15px; margin-bottom: 20px;">
                            <h3 style="margin: 0;">üë§ ${ag.cliente_nome || 'N√£o informado'}</h3>
                            <p style="margin: 10px 0 0; opacity: 0.9;">üìû ${ag.cliente_telefone || 'N√£o informado'}</p>
                        </div>

                        <div style="margin-bottom: 15px;">
                            <strong style="color: #7C3AED;">‚úÇÔ∏è Servi√ßo:</strong>
                            <p style="margin: 5px 0 0;">${ag.servico || 'N√£o especificado'}</p>
                        </div>

                        <div style="margin-bottom: 15px;">
                            <strong style="color: #7C3AED;">üë®‚Äç‚öïÔ∏è Profissional:</strong>
                            <p style="margin: 5px 0 0;">${ag.profissional || 'N√£o atribu√≠do'}</p>
                        </div>

                        <div style="margin-bottom: 15px;">
                            <strong style="color: #7C3AED;">üóìÔ∏è Data e Hora:</strong>
                            <p style="margin: 5px 0 0;">${dataHora}</p>
                        </div>

                        ${ag.observacoes ? `
                            <div style="margin-bottom: 15px;">
                                <strong style="color: #7C3AED;">üìù Observa√ß√µes:</strong>
                                <p style="margin: 5px 0 0; background: #F3F4F6; padding: 10px; border-radius: 8px;">${ag.observacoes}</p>
                            </div>
                        ` : ''}

                        <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #E5E7EB;">
                            <p style="font-size: 0.85rem; color: #6B7280; margin: 0;">
                                <strong>Status:</strong> <span class="badge ${ag.status === 'confirmado' ? 'success' : 'warning'}">${ag.status || 'Pendente'}</span>
                            </p>
                            <p style="font-size: 0.85rem; color: #6B7280; margin: 10px 0 0;">
                                Criado em: ${new Date(ag.created_at || ag.data_hora).toLocaleString('pt-BR')}
                            </p>
                        </div>
                    </div>
                `,
                width: '600px',
                confirmButtonText: 'Fechar',
                confirmButtonColor: '#7C3AED',
                showCancelButton: true,
                cancelButtonText: '<i class="bi bi-trash"></i> Cancelar Agendamento',
                cancelButtonColor: '#EF4444',
                allowEscapeKey: true,
                allowOutsideClick: true,
                showCloseButton: true,
                focusConfirm: true
            }).then((result) => {
                if (result.dismiss === Swal.DismissReason.cancel) {
                    cancelarAgendamento(id);
                }
            });
        } else {
            Swal.fire('Erro', 'Agendamento n√£o encontrado', 'error');
        }
    }catch(e){
        console.error('Erro ao visualizar agendamento:', e);
        Swal.fire('Erro', 'N√£o foi poss√≠vel carregar os detalhes do agendamento', 'error');
    }
}

async function showModalAgendamento(){
    // Buscar clientes e servi√ßos para preencher os selects
    let clientesOptions = '<option value="">Selecione o cliente...</option>';
    let servicosOptions = '<option value="">Selecione o servi√ßo...</option>';
    let profissionaisOptions = '<option value="">Selecione o profissional...</option>';
    
    try {
        const [clientesRes, servicosRes, profissionaisRes] = await Promise.all([
            fetch('/api/clientes',{credentials:'include'}),
            fetch('/api/servicos',{credentials:'include'}),
            fetch('/api/profissionais',{credentials:'include'})
        ]);
        
        const [clientesData, servicosData, profissionaisData] = await Promise.all([
            clientesRes.json(),
            servicosRes.json(),
            profissionaisRes.json()
        ]);
        
        if(clientesData.success && clientesData.clientes){
            clientesOptions += clientesData.clientes.map(c => 
                `<option value="${c.nome}">${c.nome} - ${c.cpf}</option>`
            ).join('');
        }
        
        if(servicosData.success && servicosData.servicos){
            servicosOptions += servicosData.servicos.map(s => 
                `<option value="${s.nome}">${s.nome} - R$ ${s.preco.toFixed(2)}</option>`
            ).join('');
        }
        
        if(profissionaisData.success && profissionaisData.profissionais){
            profissionaisOptions += profissionaisData.profissionais.map(p => 
                `<option value="${p.nome}">${p.nome} - ${p.especialidade||'Geral'}</option>`
            ).join('');
        }
    } catch(e) {
        console.error('Erro ao buscar dados:', e);
    }
    
    Swal.fire({
        title: '<strong>üóìÔ∏è Novo Agendamento</strong>',
        html: `
            <div style="text-align: left; padding: 10px;">
                <div class="mb-3">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Cliente:</label>
                    <select id="swal-cliente" class="form-select">${clientesOptions}</select>
                </div>
                <div class="mb-3">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Servi√ßo:</label>
                    <select id="swal-servico" class="form-select">${servicosOptions}</select>
                </div>
                <div class="mb-3">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Profissional:</label>
                    <select id="swal-profissional" class="form-select">${profissionaisOptions}</select>
                </div>
                <div class="mb-3">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Data:</label>
                    <input type="date" id="swal-data" class="form-control" min="${new Date().toISOString().split('T')[0]}">
                </div>
                <div class="mb-3">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Hor√°rio:</label>
                    <select id="swal-horario" class="form-select">
                        <option value="">Selecione o hor√°rio...</option>
                        <option value="08:00">08:00</option>
                        <option value="08:30">08:30</option>
                        <option value="09:00">09:00</option>
                        <option value="09:30">09:30</option>
                        <option value="10:00">10:00</option>
                        <option value="10:30">10:30</option>
                        <option value="11:00">11:00</option>
                        <option value="11:30">11:30</option>
                        <option value="13:00">13:00</option>
                        <option value="13:30">13:30</option>
                        <option value="14:00">14:00</option>
                        <option value="14:30">14:30</option>
                        <option value="15:00">15:00</option>
                        <option value="15:30">15:30</option>
                        <option value="16:00">16:00</option>
                        <option value="16:30">16:30</option>
                        <option value="17:00">17:00</option>
                        <option value="17:30">17:30</option>
                        <option value="18:00">18:00</option>
                    </select>
                </div>
            </div>
        `,
        showCancelButton: true,
        confirmButtonText: '<i class="bi bi-check-circle"></i> Agendar',
        cancelButtonText: 'Cancelar',
        width: '600px',
        allowEscapeKey: true,
        allowOutsideClick: true,
        showCloseButton: true,
        preConfirm: () => {
            const cliente_nome = document.getElementById('swal-cliente').value;
            const servico_nome = document.getElementById('swal-servico').value;
            const profissional_nome = document.getElementById('swal-profissional').value;
            const data = document.getElementById('swal-data').value;
            const horario = document.getElementById('swal-horario').value;
            
            if(!cliente_nome || !data || !horario){
                Swal.showValidationMessage('Cliente, data e hor√°rio s√£o obrigat√≥rios');
                return false;
            }
            
            return {
                cliente_nome,
                servico_nome: servico_nome || 'N√£o especificado',
                profissional_nome: profissional_nome || 'N√£o atribu√≠do',
                data: new Date(data+'T12:00:00').toISOString(),
                horario,
                status: 'Confirmado'
            };
        }
    }).then(async(result) => {
        if(result.isConfirmed){
            try{
                const response = await fetch('/api/agendamentos',{
                    method:'POST',
                    headers:{'Content-Type':'application/json'},
                    credentials:'include',
                    body:JSON.stringify(result.value)
                });
                
                const data = await response.json();
                
                if(data.success){
                    Swal.fire({
                        icon: 'success',
                        title: '‚úÖ Agendado!',
                        text: 'Agendamento criado com sucesso',
                        timer: 2000
                    });
                    loadAgendamentos();
                } else {
                    Swal.fire('Erro', data.message || 'Erro ao criar agendamento', 'error');
                }
            }catch(e){
                console.error('Erro:', e);
                Swal.fire('Erro','N√£o foi poss√≠vel criar o agendamento','error');
            }
        }
    });
}

async function handleUpload(input,tipo){
    const file=input.files[0];
    if(!file){
        return;
    }

    // Validar tipo de arquivo
    const validExtensions = ['.csv', '.xlsx', '.xls'];
    const fileName = file.name.toLowerCase();
    const isValidFile = validExtensions.some(ext => fileName.endsWith(ext));

    if(!isValidFile){
        Swal.fire({
            icon: 'error',
            title: 'Arquivo Inv√°lido',
            text: 'Por favor, selecione um arquivo CSV ou Excel (.xlsx, .xls)'
        });
        input.value = '';
        return;
    }

    const formData=new FormData();
    formData.append('file',file);
    formData.append('tipo',tipo);

    let cancelarProcesso = false;

    // Mostrar modal de progresso com controle de cancelamento e Spinkit spinner
    Swal.fire({
        title: `<span class="animate__animated animate__fadeInDown"><i class="bi bi-cloud-arrow-up-fill"></i> Importando ${tipo}...</span>`,
        html: `
            <div style="padding: 20px;">
                <div class="mb-4 animate__animated animate__fadeIn animate__faster">
                    <!-- BIOMA Modern Loader - Sim√©trico e Elegante -->
                    <div class="bioma-loader">
                        <div class="bioma-loader-ring"></div>
                        <div class="bioma-loader-ring"></div>
                        <div class="bioma-loader-ring"></div>
                    </div>
                </div>
                <div class="mb-3">
                    <div class="progress" style="height: 25px;">
                        <div id="barra-progresso-upload" class="progress-bar progress-bar-striped progress-bar-animated bg-info"
                             role="progressbar" style="width: 100%">
                            <i class="bi bi-hourglass-split"></i> Processando arquivo no servidor...
                        </div>
                    </div>
                </div>
                <p style="margin-top: 20px; font-size: 1.1rem;">
                    <strong>üìÅ Arquivo:</strong> ${file.name}
                </p>
                <p id="status-upload" style="margin-top: 10px; color: var(--text-secondary);">
                    <i class="bi bi-info-circle"></i> Aguarde enquanto processamos seus dados...
                </p>
                <p style="margin-top: 10px; font-size: 0.9rem; color: var(--text-muted);">
                    ‚ö†Ô∏è N√£o feche esta janela. A importa√ß√£o pode levar alguns minutos dependendo do tamanho do arquivo.
                </p>
                <div id="detalhes-upload" style="display: none; margin-top: 15px;"></div>
            </div>
        `,
        allowOutsideClick: false,
        showConfirmButton: true,
        confirmButtonText: 'OK',
        showCancelButton: false,
        showCloseButton: false,
        didOpen: () => {
            const confirmBtn = Swal.getConfirmButton();

            // Esconder bot√£o OK inicialmente (ser√° mostrado ap√≥s conclus√£o)
            if (confirmBtn) {
                confirmBtn.style.display = 'none';
            }
        }
    });

    try{
        if (cancelarProcesso) {
            throw new Error('Importa√ß√£o cancelada pelo usu√°rio');
        }

        // Aguardar um pouco para garantir que o modal foi renderizado
        await new Promise(resolve => setTimeout(resolve, 100));

        const statusElement = document.getElementById('status-upload');
        if (statusElement) {
            statusElement.innerHTML = '<i class="bi bi-gear-fill spin"></i> Processando e validando dados...';
        }

        const res=await fetch('/api/importar',{
            method:'POST',
            credentials:'include',
            body:formData
        });

        // Atualizar status para "conclu√≠do"
        const barra = document.getElementById('barra-progresso-upload');
        if (barra) {
            barra.classList.remove('bg-info');
            barra.classList.add('bg-success');
            barra.innerHTML = '<i class="bi bi-check-circle-fill"></i> Processamento conclu√≠do!';
        }

        if(!res.ok){
            throw new Error(`Erro HTTP: ${res.status}`);
        }

        const data=await res.json();

        if(data.success){
            const totalRegistros = data.count_success + (data.count_error || 0);
            const porcentagemSucesso = ((data.count_success / totalRegistros) * 100).toFixed(1);

            // Atualizar status e barra de progresso
            const barra = document.getElementById('barra-progresso-upload');
            if (barra) {
                barra.classList.remove('bg-info');
                barra.classList.add(data.count_error > 0 ? 'bg-warning' : 'bg-success');
            }

            const statusUpload = document.getElementById('status-upload');
            if (statusUpload) {
                statusUpload.innerHTML = data.count_error > 0 ?
                    '<i class="bi bi-exclamation-triangle"></i> ‚ö†Ô∏è Importa√ß√£o Parcial' :
                    '<i class="bi bi-check-circle"></i> ‚úÖ Importa√ß√£o Conclu√≠da!';
            }

            // Atualizar detalhes
            const detalhesDiv = document.getElementById('detalhes-upload');
            if (detalhesDiv) {
                detalhesDiv.style.display = 'block';
                detalhesDiv.innerHTML = `
                    <div style="background: var(--bg-main); border-radius: 12px; padding: 15px; text-align: left;">
                        <p style="color: var(--success); margin: 5px 0;">
                            <strong><i class="bi bi-check-circle"></i> Importados:</strong> ${data.count_success}
                        </p>
                        ${data.count_error > 0 ? `
                            <p style="color: var(--danger); margin: 5px 0;">
                                <strong><i class="bi bi-x-circle"></i> Erros:</strong> ${data.count_error}
                            </p>
                        ` : ''}
                        <p style="margin: 5px 0; color: var(--text-secondary);">
                            Taxa de sucesso: <strong>${porcentagemSucesso}%</strong>
                        </p>
                        ${data.errors && data.errors.length > 0 ? `
                            <hr style="margin: 10px 0;">
                            <strong>Detalhes dos erros:</strong>
                            <ul style="max-height: 120px; overflow-y: auto; margin: 5px 0; padding-left: 20px; font-size: 0.9rem;">
                                ${data.errors.slice(0, 5).map(err => `<li style="margin: 3px 0;">${err}</li>`).join('')}
                                ${data.errors.length > 5 ? `<li style="color: var(--text-muted);">... e mais ${data.errors.length - 5} erros</li>` : ''}
                            </ul>
                        ` : ''}
                    </div>
                `;
            }

            // Mostrar bot√£o OK e esconder cancelar
            const confirmBtn = Swal.getConfirmButton();
            const cancelBtn = Swal.getCancelButton();
            if (confirmBtn) {
                confirmBtn.style.display = 'inline-block';
                confirmBtn.textContent = 'OK';
                confirmBtn.style.backgroundColor = '#3085d6';
            }
            if (cancelBtn) cancelBtn.style.display = 'none';

            // Recarregar a lista apropriada
            if(tipo==='produtos') await loadProdutosLista();
            else if(tipo==='servicos') await loadServicosLista();
            else if(tipo==='clientes') await loadClientes();
            else if(tipo==='profissionais') await loadProfissionais();

            // Salvar informa√ß√µes da √∫ltima importa√ß√£o para permitir desfazer
            window.ultimaImportacao = {
                tipo: tipo,
                timestamp: new Date().toISOString(),
                count: data.count_success
            };

            // Ativar bot√£o de desfazer
            const btnDesfazer = document.getElementById('btnDesfazerImportacao');
            if(btnDesfazer) {
                btnDesfazer.disabled = false;
            }

        }else{
            // Atualizar barra para erro
            const barra = document.getElementById('barra-progresso-upload');
            if (barra) {
                barra.classList.remove('bg-info');
                barra.classList.add('bg-danger');
            }

            // An√°lise detalhada do erro
            let errorIcon = '‚ùå';
            let errorTitle = 'Erro na Importa√ß√£o';
            let errorDetails = '';

            if(data.message){
                if(data.message.includes('formato') || data.message.includes('coluna')){
                    errorIcon = 'üìã';
                    errorTitle = 'Formato Incorreto';
                    errorDetails = `
                        <hr style="margin: 10px 0;">
                        <h4 style="font-size: 1rem; margin-bottom: 10px;">üîç Poss√≠veis causas:</h4>
                        <ul style="margin: 5px 0; padding-left: 20px; font-size: 0.9rem;">
                            <li>Arquivo n√£o est√° no formato CSV ou Excel</li>
                            <li>Colunas obrigat√≥rias est√£o faltando</li>
                            <li>Cabe√ßalhos das colunas est√£o incorretos</li>
                            <li>Dados est√£o em formato incompat√≠vel</li>
                        </ul>
                        <div style="margin-top: 10px; padding: 10px; background: rgba(124, 58, 237, 0.1); border-radius: 8px; font-size: 0.9rem;">
                            <strong>üí° Dica:</strong> Baixe o template de exemplo e use-o como base
                        </div>
                    `;
                }else if(data.message.includes('duplica') || data.message.includes('existe')){
                    errorIcon = 'üîÑ';
                    errorTitle = 'Registros Duplicados';
                    errorDetails = `
                        <hr style="margin: 10px 0;">
                        <p style="font-size: 0.9rem; margin: 5px 0;">Alguns registros j√° existem no banco de dados.</p>
                        <p style="font-size: 0.9rem; margin: 5px 0;"><strong>Campos √∫nicos que n√£o podem ser duplicados:</strong></p>
                        <ul style="margin: 5px 0; padding-left: 20px; font-size: 0.9rem;">
                            ${tipo === 'clientes' ? '<li>CPF do cliente</li>' : ''}
                            ${tipo === 'profissionais' ? '<li>CPF do profissional</li>' : ''}
                            ${tipo === 'produtos' ? '<li>C√≥digo do produto</li>' : ''}
                            ${tipo === 'servicos' ? '<li>Nome do servi√ßo + categoria</li>' : ''}
                        </ul>
                    `;
                }else if(data.message.includes('vazio') || data.message.includes('empty')){
                    errorIcon = 'üìÑ';
                    errorTitle = 'Arquivo Vazio';
                    errorDetails = `
                        <hr style="margin: 10px 0;">
                        <p style="font-size: 0.9rem; margin: 5px 0;">O arquivo parece estar vazio ou sem dados v√°lidos.</p>
                        <p style="font-size: 0.9rem; margin: 5px 0;">Verifique se:</p>
                        <ul style="margin: 5px 0; padding-left: 20px; font-size: 0.9rem;">
                            <li>O arquivo cont√©m dados al√©m do cabe√ßalho</li>
                            <li>A planilha correta est√° selecionada (para Excel)</li>
                            <li>Os dados n√£o est√£o em c√©lulas muito distantes</li>
                        </ul>
                    `;
                }
            }

            const statusUploadError = document.getElementById('status-upload');
            if (statusUploadError) {
                statusUploadError.innerHTML = `${errorIcon} ${errorTitle}`;
            }

            const detalhesDiv = document.getElementById('detalhes-upload');
            if (detalhesDiv) {
                detalhesDiv.style.display = 'block';
                detalhesDiv.innerHTML = `
                    <div style="background: rgba(239, 68, 68, 0.1); border-radius: 12px; padding: 15px; text-align: left;">
                        <p style="color: var(--danger); font-size: 0.95rem; margin-bottom: 10px;">
                            <strong>Motivo:</strong> ${data.message || 'Ocorreu um erro ao processar o arquivo'}
                        </p>
                        ${errorDetails}
                        ${data.errors && data.errors.length > 0 ? `
                            <hr style="margin: 10px 0;">
                            <strong style="font-size: 0.9rem;">üìù Erros espec√≠ficos encontrados:</strong>
                            <ul style="max-height: 120px; overflow-y: auto; margin: 5px 0; padding-left: 20px; font-size: 0.85rem;">
                                ${data.errors.slice(0, 5).map(err => `<li style="margin: 3px 0; color: var(--danger);">${err}</li>`).join('')}
                                ${data.errors.length > 5 ? `<li style="color: var(--text-muted);">... e mais ${data.errors.length - 5} erros</li>` : ''}
                            </ul>
                        ` : ''}
                        <div style="margin-top: 10px; text-align: center;">
                            <a href="/api/template/download/${tipo}" class="btn btn-sm" style="background: var(--primary); color: white; padding: 5px 15px; border-radius: 5px; text-decoration: none;">
                                <i class="bi bi-download"></i> Baixar Template de Exemplo
                            </a>
                        </div>
                    </div>
                `;
            }

            // Mostrar bot√£o Fechar e esconder cancelar
            const confirmBtn = Swal.getConfirmButton();
            const cancelBtn = Swal.getCancelButton();
            if (confirmBtn) {
                confirmBtn.style.display = 'inline-block';
                confirmBtn.textContent = 'Fechar';
                confirmBtn.style.backgroundColor = '#dc3545';
            }
            if (cancelBtn) cancelBtn.style.display = 'none';
        }
    }catch(e){
        console.error('‚ùå Erro na importa√ß√£o:',e);

        // Atualizar barra para erro
        const barra = document.getElementById('barra-progresso-upload');
        if (barra) {
            barra.classList.remove('bg-info');
            barra.classList.add('bg-danger');
        }

        // An√°lise do erro de conex√£o
        let errorMsg = e.message || 'N√£o foi poss√≠vel enviar o arquivo.';
        let errorHelp = '';

        if(e.message.includes('cancelad')){
            errorMsg = 'Importa√ß√£o cancelada pelo usu√°rio';
            errorHelp = 'Nenhum dado foi importado.';
        }else if(e.message.includes('Failed to fetch') || e.message.includes('NetworkError')){
            errorMsg = 'Erro de conex√£o com o servidor.';
            errorHelp = 'Verifique se o servidor est√° rodando e tente novamente.';
        }else if(e.message.includes('413') || file.size > 10485760){ // 10MB
            errorMsg = 'Arquivo muito grande!';
            errorHelp = `O arquivo tem ${(file.size / 1048576).toFixed(2)}MB. O limite √© 10MB.`;
        }else if(e.message.includes('timeout')){
            errorMsg = 'Tempo limite excedido.';
            errorHelp = 'O servidor demorou muito para responder. Tente com um arquivo menor.';
        }

        const statusUploadCatch = document.getElementById('status-upload');
        if (statusUploadCatch) {
            statusUploadCatch.innerHTML = 'üö´ Erro no Upload';
        }

        const detalhesDiv = document.getElementById('detalhes-upload');
        if (detalhesDiv) {
            detalhesDiv.style.display = 'block';
            detalhesDiv.innerHTML = `
                <div style="background: rgba(239, 68, 68, 0.1); border-radius: 12px; padding: 15px; text-align: left;">
                    <p style="color: var(--danger); font-size: 0.95rem; margin-bottom: 10px;">
                        <strong>Erro:</strong> ${errorMsg}
                    </p>
                    ${errorHelp ? `<p style="color: var(--text-secondary); font-size: 0.9rem; margin: 5px 0;">${errorHelp}</p>` : ''}
                    ${!e.message.includes('cancelad') ? `
                        <hr style="margin: 10px 0;">
                        <strong style="font-size: 0.9rem;">üí° Poss√≠veis solu√ß√µes:</strong>
                        <ul style="margin: 5px 0; padding-left: 20px; font-size: 0.85rem;">
                            <li>Verifique sua conex√£o com a internet</li>
                            <li>Reduza o tamanho do arquivo</li>
                            <li>Tente importar em lotes menores</li>
                            <li>Reinicie o servidor se necess√°rio</li>
                        </ul>
                    ` : ''}
                </div>
            `;
        }

        // Mostrar bot√£o Fechar e esconder cancelar
        const confirmBtn = Swal.getConfirmButton();
        const cancelBtn = Swal.getCancelButton();
        if (confirmBtn) {
            confirmBtn.style.display = 'inline-block';
            confirmBtn.textContent = 'Fechar';
            confirmBtn.style.backgroundColor = '#dc3545';
        }
        if (cancelBtn) cancelBtn.style.display = 'none';
    }
    
    // Limpar o input para permitir upload do mesmo arquivo novamente
    input.value='';
}

// Fun√ß√£o para desfazer √∫ltima importa√ß√£o
async function desfazerUltimaImportacao() {
    if(!window.ultimaImportacao) {
        Swal.fire({
            icon: 'info',
            title: 'Nenhuma Importa√ß√£o Recente',
            text: 'N√£o h√° importa√ß√µes recentes para desfazer.',
            confirmButtonText: 'OK'
        });
        return;
    }

    const { tipo, timestamp, count } = window.ultimaImportacao;
    const dataImportacao = new Date(timestamp).toLocaleString('pt-BR');

    const result = await Swal.fire({
        icon: 'warning',
        title: '‚ö†Ô∏è Confirmar Desfazer Importa√ß√£o?',
        html: `
            <div style="padding: 20px; text-align: left;">
                <p><strong>Tipo:</strong> ${tipo}</p>
                <p><strong>Data:</strong> ${dataImportacao}</p>
                <p><strong>Registros importados:</strong> ${count}</p>
                <div style="margin-top: 20px; padding: 15px; background: rgba(239, 68, 68, 0.1); border-radius: 8px;">
                    <strong>‚ö†Ô∏è Aten√ß√£o:</strong> Esta a√ß√£o ir√° remover os <strong>${count}</strong> registros de <strong>${tipo}</strong> que foram importados.
                    Esta a√ß√£o n√£o pode ser desfeita!
                </div>
            </div>
        `,
        showCancelButton: true,
        confirmButtonText: 'Sim, Desfazer',
        cancelButtonText: 'Cancelar',
        confirmButtonColor: '#EF4444',
        allowOutsideClick: false
    });

    if(!result.isConfirmed) {
        return;
    }

    // Mostrar loading
    Swal.fire({
        title: 'Desfazendo Importa√ß√£o...',
        html: 'Por favor, aguarde...',
        allowOutsideClick: false,
        allowEscapeKey: false,
        showConfirmButton: false,
        willOpen: () => {
            Swal.showLoading();
        }
    });

    try {
        const res = await fetch('/api/importar/desfazer', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({
                tipo: tipo,
                timestamp: timestamp,
                count: count
            })
        });

        const data = await res.json();

        Swal.close();

        if(data.success) {
            Swal.fire({
                icon: 'success',
                title: '‚úÖ Importa√ß√£o Desfeita!',
                html: `<p>${data.message || `${data.deleted || count} registros foram removidos com sucesso.`}</p>`,
                confirmButtonText: 'OK'
            });

            // Limpar √∫ltima importa√ß√£o
            window.ultimaImportacao = null;

            // Desativar bot√£o
            const btnDesfazer = document.getElementById('btnDesfazerImportacao');
            if(btnDesfazer) {
                btnDesfazer.disabled = true;
            }

            // Recarregar lista
            if(tipo==='produtos') await loadProdutosLista();
            else if(tipo==='servicos') await loadServicosLista();
            else if(tipo==='clientes') await loadClientes();
            else if(tipo==='profissionais') await loadProfissionais();
        } else {
            throw new Error(data.message || 'Erro ao desfazer importa√ß√£o');
        }
    } catch(e) {
        console.error('Erro ao desfazer importa√ß√£o:', e);
        Swal.fire({
            icon: 'error',
            title: 'Erro',
            text: e.message || 'N√£o foi poss√≠vel desfazer a importa√ß√£o.',
            confirmButtonText: 'OK'
        });
    }
}

// Adicionar atalho CTRL+Z para desfazer importa√ß√£o
document.addEventListener('keydown', (e) => {
    if(e.ctrlKey && e.key === 'z') {
        const activeSection = document.querySelector('.content-section.active')?.id;
        if(activeSection === 'section-importar' && window.ultimaImportacao) {
            e.preventDefault();
            desfazerUltimaImportacao();
        }
    }
});

async function buscarClientePorCPF(){
    const cpf=document.getElementById('orcCPF').value.trim();
    const cpfInput = document.getElementById('orcCPF');
    const cpfResults = document.getElementById('cpfResults');

    if(cpf.length<3){
        cpfResults.style.display='none';
        return;
    }

    try{
        const res=await fetch(`/api/clientes/buscar?termo=${cpf}`,{credentials:'include'});
        const data=await res.json();
        if(data.success&&data.clientes.length>0){
            const html=data.clientes.map(c=>`<div class="autocomplete-item" onclick="selecionarCliente('${c._id}','${c.cpf}','${c.nome}','${c.email||''}','${c.telefone||''}')"><strong>${c.nome}</strong><small>${c.cpf} | ${c.telefone||'Sem telefone'}</small></div>`).join('');
            cpfResults.innerHTML=html;

            // Calcular posi√ß√£o para dropdown fixo
            const rect = cpfInput.getBoundingClientRect();
            cpfResults.style.top = (rect.bottom + 5) + 'px';
            cpfResults.style.left = rect.left + 'px';
            cpfResults.style.width = rect.width + 'px';
            cpfResults.style.display='block';
        }else{
            cpfResults.style.display='none';
        }
    }catch(e){
        console.error('‚ùå Erro buscar cliente:',e);
    }
}

function selecionarCliente(id,cpf,nome,email,telefone){
    document.getElementById('orcCPF').value=cpf;
    document.getElementById('orcNomeCliente').value=nome;
    document.getElementById('orcEmail').value=email;
    document.getElementById('orcTelefone').value=telefone;
    document.getElementById('cpfResults').style.display='none';
}

function limparCliente(){
    document.getElementById('orcCPF').value='';
    document.getElementById('orcNomeCliente').value='';
    document.getElementById('orcEmail').value='';
    document.getElementById('orcTelefone').value='';
}

async function buscarServicos(){
    const termo=document.getElementById('buscaServico').value.trim();
    if(termo.length<2){document.getElementById('servicoResults').style.display='none';return;}
    try{
        const res=await fetch(`/api/servicos/buscar?termo=${termo}`,{credentials:'include'});
        const data=await res.json();
        if(data.success&&data.servicos.length>0){
            servicosDisponiveis=data.servicos;
            const servicosAgrupados={};
            data.servicos.forEach(s=>{if(!servicosAgrupados[s.nome])servicosAgrupados[s.nome]=[];servicosAgrupados[s.nome].push(s);});
            const html=Object.keys(servicosAgrupados).map(nome=>`<div class="autocomplete-item" onclick="selecionarServico('${nome}')"><strong>${nome}</strong><small>${servicosAgrupados[nome].length} tamanhos dispon√≠veis</small></div>`).join('');
            document.getElementById('servicoResults').innerHTML=html;
            document.getElementById('servicoResults').style.display='block';
        }else{
            document.getElementById('servicoResults').style.display='none';
        }
    }catch(e){
        console.error(e);
    }
}

function selecionarServico(nome){
    document.getElementById('buscaServico').value=nome;
    document.getElementById('servicoResults').style.display='none';
    const servicosFiltrados=servicosDisponiveis.filter(s=>s.nome===nome);
    const selectTamanho=document.getElementById('servicoTamanho');

    if(!selectTamanho){
        console.error('‚ùå Elemento servicoTamanho n√£o encontrado');
        return;
    }

    selectTamanho.innerHTML='<option value="">Selecione o tamanho...</option>';

    // Se s√≥ houver um servi√ßo, selecionar automaticamente
    if(servicosFiltrados.length === 1){
        const s = servicosFiltrados[0];
        const option=document.createElement('option');
        option.value=s._id;
        option.textContent=`${s.tamanho || '√önico'} - R$ ${(s.preco || 0).toFixed(2)}`;
        option.dataset.preco=s.preco || 0;
        option.dataset.nome=s.nome;
        option.dataset.tamanho=s.tamanho || '√önico';
        option.selected = true;
        selectTamanho.appendChild(option);

        // Definir automaticamente o servi√ßo selecionado
        document.getElementById('servicoPreco').value=(s.preco || 0).toFixed(2);
        window.servicoSelecionado={
            id:s._id,
            nome:s.nome,
            tamanho:s.tamanho || '√önico',
            preco:parseFloat(s.preco || 0)
        };
    } else {
        servicosFiltrados.forEach(s=>{
            const option=document.createElement('option');
            option.value=s._id;
            option.textContent=`${s.tamanho || 'Padr√£o'} - R$ ${(s.preco || 0).toFixed(2)}`;
            option.dataset.preco=s.preco || 0;
            option.dataset.nome=s.nome;
            option.dataset.tamanho=s.tamanho || 'Padr√£o';
            selectTamanho.appendChild(option);
        });
    }

    // Remover listener anterior para evitar duplica√ß√£o
    const newSelectTamanho = selectTamanho.cloneNode(true);
    selectTamanho.parentNode.replaceChild(newSelectTamanho, selectTamanho);

    newSelectTamanho.addEventListener('change',function(){
        const selected=this.options[this.selectedIndex];
        if(selected && selected.value && selected.dataset && selected.dataset.preco){
            document.getElementById('servicoPreco').value=selected.dataset.preco;
            window.servicoSelecionado={
                id:this.value,
                nome:selected.dataset.nome,
                tamanho:selected.dataset.tamanho,
                preco:parseFloat(selected.dataset.preco)
            };
        } else {
            window.servicoSelecionado = null;
            document.getElementById('servicoPreco').value = '';
        }
    });
}

function addServico(){
    if(!window.servicoSelecionado || !window.servicoSelecionado.id){
        Swal.fire('Aten√ß√£o','Por favor, selecione um servi√ßo e tamanho','warning');
        return;
    }

    const qtdElement = document.getElementById('servicoQtd');
    const precoElement = document.getElementById('servicoPreco');
    const descontoElement = document.getElementById('servicoDesconto');

    if(!qtdElement || !precoElement || !descontoElement){
        console.error('‚ùå Elementos do formul√°rio n√£o encontrados');
        Swal.fire('Erro','Erro ao adicionar servi√ßo. Recarregue a p√°gina.','error');
        return;
    }

    const qtd=parseInt(qtdElement.value)||1;
    const preco=parseFloat(precoElement.value)||0;
    const desconto=parseInt(descontoElement.value)||0;

    if(preco<=0){
        Swal.fire('Aten√ß√£o','Pre√ßo inv√°lido','warning');
        return;
    }

    if(desconto<0 || desconto>100){
        Swal.fire('Aten√ß√£o','Desconto deve estar entre 0% e 100%','warning');
        return;
    }

    const subtotal=qtd*preco;
    const total=subtotal-(subtotal*desconto/100);

    // Verificar se orcamento existe
    if(!window.orcamento){
        window.orcamento = {servicos:[], produtos:[]};
    }

    orcamento.servicos.push({
        id:window.servicoSelecionado.id,
        nome:window.servicoSelecionado.nome,
        tamanho:window.servicoSelecionado.tamanho,
        qtd:qtd,
        preco_unit:preco,
        desconto:desconto,
        total:total
    });

    atualizarTabelaServicos();

    // Limpar campos
    document.getElementById('buscaServico').value='';
    document.getElementById('servicoTamanho').innerHTML='<option value="">Selecione...</option>';
    qtdElement.value='1';
    precoElement.value='';
    descontoElement.value='0';
    window.servicoSelecionado=null;

    calcularTotais();

    // Feedback visual
    Swal.fire({
        icon:'success',
        title:'Servi√ßo adicionado!',
        timer:1500,
        showConfirmButton:false
    });
}

function atualizarTabelaServicos(){
    const tbody=document.getElementById('servicosBody');
    if(orcamento.servicos.length===0){tbody.innerHTML='<tr><td colspan="7" class="text-center text-muted">Nenhum servi√ßo</td></tr>';return;}
    const html=orcamento.servicos.map((s,idx)=>`<tr><td><strong>${s.nome}</strong></td><td>${s.tamanho}</td><td>${s.qtd}</td><td>R$ ${s.preco_unit.toFixed(2)}</td><td>${s.desconto}%</td><td><strong>R$ ${s.total.toFixed(2)}</strong></td><td><button class="bioma-btn bioma-btn-sm bioma-btn-danger" onclick="removerServico(${idx})"><i class="bi bi-trash"></i></button></td></tr>`).join('');
    tbody.innerHTML=html;
}

function removerServico(idx){
    orcamento.servicos.splice(idx,1);
    atualizarTabelaServicos();
    calcularTotais();
}

async function buscarProdutos(){
    const termo=document.getElementById('buscaProduto').value.trim();
    if(termo.length<2){document.getElementById('produtoResults').style.display='none';return;}
    try{
        const res=await fetch(`/api/produtos/buscar?termo=${termo}`,{credentials:'include'});
        const data=await res.json();
        if(data.success&&data.produtos.length>0){
            produtosDisponiveis=data.produtos;
            const html=data.produtos.map(p=>{
                let nomeCompleto=p.nome;
                if(p.marca)nomeCompleto+=` - ${p.marca}`;
                return `<div class="autocomplete-item" onclick="selecionarProduto('${p._id}','${nomeCompleto.replace(/'/g,"\\'")}','${p.marca||''}','${p.sku}',${p.preco})"><strong>${nomeCompleto}</strong><small>R$ ${p.preco.toFixed(2)} | Estoque: ${p.estoque||0} unidades</small></div>`;
            }).join('');
            document.getElementById('produtoResults').innerHTML=html;
            document.getElementById('produtoResults').style.display='block';
        }else{
            document.getElementById('produtoResults').style.display='none';
        }
    }catch(e){
        console.error(e);
    }
}

function selecionarProduto(id,nome,marca,sku,preco){
    document.getElementById('buscaProduto').value=nome;
    document.getElementById('produtoResults').style.display='none';

    const precoElement = document.getElementById('produtoPreco');
    if(precoElement){
        precoElement.value=(preco || 0).toFixed(2);
    }

    window.produtoSelecionado={
        id:id,
        nome:nome,
        marca:marca || '',
        sku:sku || '',
        preco:parseFloat(preco) || 0
    };
}

function addProduto(){
    if(!window.produtoSelecionado || !window.produtoSelecionado.id){
        Swal.fire('Aten√ß√£o','Por favor, selecione um produto','warning');
        return;
    }

    const qtdElement = document.getElementById('produtoQtd');
    const precoElement = document.getElementById('produtoPreco');
    const descontoElement = document.getElementById('produtoDesconto');

    if(!qtdElement || !precoElement || !descontoElement){
        console.error('‚ùå Elementos do formul√°rio de produto n√£o encontrados');
        Swal.fire('Erro','Erro ao adicionar produto. Recarregue a p√°gina.','error');
        return;
    }

    const qtd=parseInt(qtdElement.value)||1;
    const preco=parseFloat(precoElement.value)||0;
    const desconto=parseInt(descontoElement.value)||0;

    if(preco<=0){
        Swal.fire('Aten√ß√£o','Pre√ßo inv√°lido','warning');
        return;
    }

    if(desconto<0 || desconto>100){
        Swal.fire('Aten√ß√£o','Desconto deve estar entre 0% e 100%','warning');
        return;
    }

    const subtotal=qtd*preco;
    const total=subtotal-(subtotal*desconto/100);

    // Verificar se orcamento existe
    if(!window.orcamento){
        window.orcamento = {servicos:[], produtos:[]};
    }

    orcamento.produtos.push({
        id:window.produtoSelecionado.id,
        nome:window.produtoSelecionado.nome,
        marca:window.produtoSelecionado.marca || '',
        sku:window.produtoSelecionado.sku || '',
        qtd:qtd,
        preco_unit:preco,
        desconto:desconto,
        total:total
    });

    atualizarTabelaProdutos();

    // Limpar campos
    document.getElementById('buscaProduto').value='';
    qtdElement.value='1';
    precoElement.value='';
    descontoElement.value='0';
    window.produtoSelecionado=null;

    calcularTotais();

    // Feedback visual
    Swal.fire({
        icon:'success',
        title:'Produto adicionado!',
        timer:1500,
        showConfirmButton:false
    });
}

function atualizarTabelaProdutos(){
    const tbody=document.getElementById('produtosBody');
    if(orcamento.produtos.length===0){tbody.innerHTML='<tr><td colspan="7" class="text-center text-muted">Nenhum produto</td></tr>';return;}
    const html=orcamento.produtos.map((p,idx)=>`<tr><td><strong>${p.nome}</strong></td><td>${p.marca||'-'}</td><td>${p.qtd}</td><td>R$ ${p.preco_unit.toFixed(2)}</td><td>${p.desconto}%</td><td><strong>R$ ${p.total.toFixed(2)}</strong></td><td><button class="bioma-btn bioma-btn-sm bioma-btn-danger" onclick="removerProduto(${idx})"><i class="bi bi-trash"></i></button></td></tr>`).join('');
    tbody.innerHTML=html;
}

function removerProduto(idx){
    orcamento.produtos.splice(idx,1);
    atualizarTabelaProdutos();
    calcularTotais();
}

function calcularTotais(){
    const subtotalServicos=orcamento.servicos.reduce((acc,s)=>acc+s.total,0);
    const subtotalProdutos=orcamento.produtos.reduce((acc,p)=>acc+p.total,0);
    const subtotal=subtotalServicos+subtotalProdutos;
    const descontoGlobal=parseFloat(document.getElementById('descontoGlobal').value)||0;
    const descontoValor=subtotal*(descontoGlobal/100);
    const totalComDesconto=subtotal-descontoValor;
    const cashbackPerc=parseFloat(document.getElementById('cashbackPerc').value)||0;
    const cashbackValor=totalComDesconto*(cashbackPerc/100);
    document.getElementById('subtotalServicos').textContent=`R$ ${subtotalServicos.toFixed(2)}`;
    document.getElementById('subtotalProdutos').textContent=`R$ ${subtotalProdutos.toFixed(2)}`;
    document.getElementById('totalFinalOrc').textContent=`R$ ${totalComDesconto.toFixed(2)}`;
    document.getElementById('cashbackValor').textContent=`üéÅ Cashback: R$ ${cashbackValor.toFixed(2)}`;
    
    // Atualizar comiss√µes dos profissionais vinculados
    atualizarTabelaProfissionaisVinculados();
    
    // Calcular e exibir total de comiss√µes
    const totalComissoes = profissionaisVinculados.reduce((acc, prof) => {
        return acc + ((totalComDesconto * prof.comissao_perc) / 100);
    }, 0);
    
    const totalComissoesElement = document.getElementById('totalComissoes');
    const footerElement = document.getElementById('profissionaisVinculadosFooter');
    
    if (profissionaisVinculados.length > 0 && totalComissoesElement && footerElement) {
        totalComissoesElement.textContent = `R$ ${totalComissoes.toFixed(2)}`;
        footerElement.style.display = '';
    } else if (footerElement) {
        footerElement.style.display = 'none';
    }
}

async function salvarOrc(status){
    const cpf=document.getElementById('orcCPF').value.trim();
    const nome=document.getElementById('orcNomeCliente').value.trim();
    if(!cpf||!nome){Swal.fire('Aten√ß√£o','Preencha CPF e Nome','warning');return;}
    if(orcamento.servicos.length===0&&orcamento.produtos.length===0){Swal.fire('Aten√ß√£o','Adicione pelo menos um item','warning');return;}
    
    // Calcular comiss√µes dos profissionais vinculados
    const totalOrcamento = calcularTotalOrcamentoBase();
    const profissionaisComComissoes = profissionaisVinculados.map(prof => ({
        profissional_id: prof.id,
        nome: prof.nome,
        tipo: prof.tipo,
        comissao_perc: prof.comissao_perc,
        comissao_valor: (totalOrcamento * prof.comissao_perc) / 100
    }));
    
    const data={
        cliente_cpf:cpf,
        cliente_nome:nome,
        cliente_email:document.getElementById('orcEmail').value.trim(),
        cliente_telefone:document.getElementById('orcTelefone').value.trim(),
        servicos:orcamento.servicos,
        produtos:orcamento.produtos,
        desconto_global:parseFloat(document.getElementById('descontoGlobal').value)||0,
        cashback_perc:parseFloat(document.getElementById('cashbackPerc').value)||0,
        pagamento:{tipo:document.getElementById('pagamento').value},
        profissionais_vinculados: profissionaisComComissoes, // NOVO: array de profissionais
        status:status
    };
    
    try{
        let res,result;
        if(window.orcamentoEditandoId){
            res=await fetch(`/api/orcamentos/${window.orcamentoEditandoId}`,{method:'PUT',headers:{'Content-Type':'application/json'},credentials:'include',body:JSON.stringify(data)});
            result=await res.json();
            if(result.success){
                Swal.fire({icon:'success',title:'‚úÖ Atualizado!',html:`<p>Or√ßamento <strong>#${result.numero||window.orcamentoEditandoId}</strong> atualizado</p>`,timer:2000}).then(()=>{delete window.orcamentoEditandoId;cancelarOrc();goTo('consultar');});
            }else{
                Swal.fire('Erro',result.message,'error');
            }
        }else{
            res=await fetch('/api/orcamentos',{method:'POST',headers:{'Content-Type':'application/json'},credentials:'include',body:JSON.stringify(data)});
            result=await res.json();
            if(result.success){
                Swal.fire({icon:'success',title:status==='Aprovado'?'‚úÖ Contrato Gerado!':'‚úÖ Salvo!',html:`<p>Or√ßamento <strong>#${result.numero}</strong></p>${status==='Aprovado'?'<p>üìß Email enviado!</p>':''}${profissionaisComComissoes.length > 0 ? `<p>üë• ${profissionaisComComissoes.length} profissional(is) vinculado(s)</p>` : ''}`,timer:2500}).then(()=>{cancelarOrc();goTo('consultar');});
            }else{
                Swal.fire('Erro',result.message,'error');
            }
        }
    }catch(e){
        Swal.fire('Erro','Erro ao salvar','error');
    }
}

async function visualizarOrcamento(id){
    // Vers√£o melhorada v6.4.0 com detalhamento completo

    // Mostrar loading com spinner moderno
    Swal.fire({
        title: '<span class="animate__animated animate__fadeInDown">Carregando Or√ßamento...</span>',
        html: `
            <div class="sk-chase" style="margin: 20px auto;">
                <div class="sk-chase-dot"></div>
                <div class="sk-chase-dot"></div>
                <div class="sk-chase-dot"></div>
                <div class="sk-chase-dot"></div>
                <div class="sk-chase-dot"></div>
                <div class="sk-chase-dot"></div>
            </div>
        `,
        showConfirmButton: false,
        allowOutsideClick: false
    });

    try{
        // Buscar dados do backend
        const res = await fetch(`/api/orcamentos/${id}`, {credentials:'include'});
        const data = await res.json();

        if(data.success && data.orcamento){
            const orc = data.orcamento;

            // Calcular totais parciais
            const totalServicos = orc.servicos.reduce((sum, s) => sum + s.total, 0);
            const totalProdutos = orc.produtos.reduce((sum, p) => sum + p.total, 0);
            const subtotal = totalServicos + totalProdutos;

            // Badge de status com cores
            let statusBadge = '';
            let statusColor = '#6c757d';
            switch(orc.status?.toLowerCase()) {
                case 'aprovado':
                    statusColor = '#11998e';
                    statusBadge = `<span style="background:linear-gradient(135deg,#11998e,#38ef7d);color:#fff;padding:8px 16px;border-radius:20px;font-weight:600;display:inline-block;box-shadow:0 4px 15px rgba(17,153,142,0.4)">‚úì APROVADO</span>`;
                    break;
                case 'pendente':
                    statusColor = '#f2994a';
                    statusBadge = `<span style="background:linear-gradient(135deg,#f2994a,#f2c94c);color:#fff;padding:8px 16px;border-radius:20px;font-weight:600;display:inline-block;box-shadow:0 4px 15px rgba(242,153,74,0.4)">‚è± PENDENTE</span>`;
                    break;
                case 'rejeitado':
                    statusColor = '#ee0979';
                    statusBadge = `<span style="background:linear-gradient(135deg,#ee0979,#ff6a00);color:#fff;padding:8px 16px;border-radius:20px;font-weight:600;display:inline-block;box-shadow:0 4px 15px rgba(238,9,121,0.4)">‚úó REJEITADO</span>`;
                    break;
                default:
                    statusBadge = `<span style="background:#6c757d;color:#fff;padding:8px 16px;border-radius:20px;font-weight:600;display:inline-block">${orc.status || 'SEM STATUS'}</span>`;
            }

            // Tabela de servi√ßos melhorada
            const servicosHtml = orc.servicos.length > 0 ? orc.servicos.map((s, idx) => `
                <tr style="${idx % 2 === 0 ? 'background:#f9fafb' : 'background:#fff'}">
                    <td style="padding:12px 8px;border-bottom:1px solid #e5e7eb">
                        <strong>${s.nome}</strong>
                        ${s.observacao ? `<br><small style="color:#6b7280">${s.observacao}</small>` : ''}
                    </td>
                    <td style="padding:12px 8px;text-align:center;border-bottom:1px solid #e5e7eb">${s.tamanho || '-'}</td>
                    <td style="padding:12px 8px;text-align:center;border-bottom:1px solid #e5e7eb">${s.qtd}</td>
                    <td style="padding:12px 8px;text-align:right;border-bottom:1px solid #e5e7eb">R$ ${s.preco_unit.toFixed(2)}</td>
                    <td style="padding:12px 8px;text-align:center;border-bottom:1px solid #e5e7eb;color:#f2994a;font-weight:600">${s.desconto}%</td>
                    <td style="padding:12px 8px;text-align:right;border-bottom:1px solid #e5e7eb;font-weight:700;color:#667eea">R$ ${s.total.toFixed(2)}</td>
                </tr>
            `).join('') : '<tr><td colspan="6" style="text-align:center;padding:30px;color:#9ca3af"><i class="bi bi-inbox" style="font-size:2rem"></i><br>Nenhum servi√ßo inclu√≠do</td></tr>';

            // Tabela de produtos melhorada
            const produtosHtml = orc.produtos.length > 0 ? orc.produtos.map((p, idx) => `
                <tr style="${idx % 2 === 0 ? 'background:#f9fafb' : 'background:#fff'}">
                    <td style="padding:12px 8px;border-bottom:1px solid #e5e7eb">
                        <strong>${p.nome}</strong>
                        ${p.marca ? `<br><small style="color:#6b7280">Marca: ${p.marca}</small>` : ''}
                    </td>
                    <td style="padding:12px 8px;text-align:center;border-bottom:1px solid #e5e7eb">${p.qtd}</td>
                    <td style="padding:12px 8px;text-align:right;border-bottom:1px solid #e5e7eb">R$ ${p.preco_unit.toFixed(2)}</td>
                    <td style="padding:12px 8px;text-align:center;border-bottom:1px solid #e5e7eb;color:#f2994a;font-weight:600">${p.desconto}%</td>
                    <td style="padding:12px 8px;text-align:right;border-bottom:1px solid #e5e7eb;font-weight:700;color:#667eea">R$ ${p.total.toFixed(2)}</td>
                </tr>
            `).join('') : '<tr><td colspan="5" style="text-align:center;padding:30px;color:#9ca3af"><i class="bi bi-inbox" style="font-size:2rem"></i><br>Nenhum produto inclu√≠do</td></tr>';

            // Profissionais
            const profissionaisHtml = orc.profissionais && orc.profissionais.length > 0 ?
                orc.profissionais.map(p => `<span style="display:inline-block;background:#667eea;color:#fff;padding:6px 12px;border-radius:15px;margin:4px;font-size:0.85rem"><i class="bi bi-person-badge"></i> ${p.nome}</span>`).join('') :
                '<span style="color:#9ca3af">Nenhum profissional atribu√≠do</span>';

            // Modal completo
            Swal.fire({
                title: `<div style="display:flex;align-items:center;justify-content:space-between;gap:20px">
                    <span style="background:linear-gradient(135deg,#667eea,#764ba2);-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent;font-size:1.8rem">
                        <i class="bi bi-file-earmark-text"></i> Or√ßamento #${orc.numero}
                    </span>
                    ${statusBadge}
                </div>`,
                html:`
                <div style="text-align:left;max-height:600px;overflow-y:auto;padding:10px">

                    <!-- Card do Cliente -->
                    <div style="background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;padding:25px;border-radius:20px;margin-bottom:25px;box-shadow:0 10px 30px rgba(102,126,234,0.3)">
                        <h3 style="margin:0 0 15px 0;font-size:1.5rem"><i class="bi bi-person-circle"></i> ${orc.cliente_nome}</h3>
                        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px;font-size:0.95rem">
                            <div><i class="bi bi-credit-card"></i> <strong>CPF:</strong> ${orc.cliente_cpf}</div>
                            ${orc.cliente_email ? `<div><i class="bi bi-envelope"></i> <strong>Email:</strong> ${orc.cliente_email}</div>` : ''}
                            ${orc.cliente_telefone ? `<div><i class="bi bi-telephone"></i> <strong>Tel:</strong> ${orc.cliente_telefone}</div>` : ''}
                        </div>
                    </div>

                    <!-- Se√ß√£o de Servi√ßos -->
                    <div style="margin-bottom:25px">
                        <h4 style="color:#667eea;border-bottom:3px solid #667eea;padding-bottom:10px;margin-bottom:15px;display:flex;align-items:center;gap:10px">
                            <i class="bi bi-scissors"></i> Servi√ßos Contratados
                            <span style="background:#667eea;color:#fff;padding:4px 12px;border-radius:15px;font-size:0.85rem;margin-left:auto">${orc.servicos.length} item(ns)</span>
                        </h4>
                        <div style="overflow-x:auto">
                            <table style="width:100%;border-collapse:collapse;box-shadow:0 2px 8px rgba(0,0,0,0.1);border-radius:10px;overflow:hidden">
                                <thead>
                                    <tr style="background:linear-gradient(135deg,#667eea,#764ba2);color:#fff">
                                        <th style="padding:12px 8px;text-align:left;font-weight:600">Servi√ßo</th>
                                        <th style="padding:12px 8px;text-align:center;font-weight:600">Tamanho</th>
                                        <th style="padding:12px 8px;text-align:center;font-weight:600">Qtd</th>
                                        <th style="padding:12px 8px;text-align:right;font-weight:600">Pre√ßo Unit.</th>
                                        <th style="padding:12px 8px;text-align:center;font-weight:600">Desc.</th>
                                        <th style="padding:12px 8px;text-align:right;font-weight:600">Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${servicosHtml}
                                </tbody>
                                ${orc.servicos.length > 0 ? `
                                <tfoot>
                                    <tr style="background:#f3f4f6;font-weight:700">
                                        <td colspan="5" style="padding:12px 8px;text-align:right;border-top:2px solid #667eea">Subtotal Servi√ßos:</td>
                                        <td style="padding:12px 8px;text-align:right;color:#667eea;border-top:2px solid #667eea">R$ ${totalServicos.toFixed(2)}</td>
                                    </tr>
                                </tfoot>` : ''}
                            </table>
                        </div>
                    </div>

                    <!-- Se√ß√£o de Produtos -->
                    <div style="margin-bottom:25px">
                        <h4 style="color:#764ba2;border-bottom:3px solid #764ba2;padding-bottom:10px;margin-bottom:15px;display:flex;align-items:center;gap:10px">
                            <i class="bi bi-box-seam"></i> Produtos Inclu√≠dos
                            <span style="background:#764ba2;color:#fff;padding:4px 12px;border-radius:15px;font-size:0.85rem;margin-left:auto">${orc.produtos.length} item(ns)</span>
                        </h4>
                        <div style="overflow-x:auto">
                            <table style="width:100%;border-collapse:collapse;box-shadow:0 2px 8px rgba(0,0,0,0.1);border-radius:10px;overflow:hidden">
                                <thead>
                                    <tr style="background:linear-gradient(135deg,#764ba2,#667eea);color:#fff">
                                        <th style="padding:12px 8px;text-align:left;font-weight:600">Produto</th>
                                        <th style="padding:12px 8px;text-align:center;font-weight:600">Qtd</th>
                                        <th style="padding:12px 8px;text-align:right;font-weight:600">Pre√ßo Unit.</th>
                                        <th style="padding:12px 8px;text-align:center;font-weight:600">Desc.</th>
                                        <th style="padding:12px 8px;text-align:right;font-weight:600">Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${produtosHtml}
                                </tbody>
                                ${orc.produtos.length > 0 ? `
                                <tfoot>
                                    <tr style="background:#f3f4f6;font-weight:700">
                                        <td colspan="4" style="padding:12px 8px;text-align:right;border-top:2px solid #764ba2">Subtotal Produtos:</td>
                                        <td style="padding:12px 8px;text-align:right;color:#764ba2;border-top:2px solid #764ba2">R$ ${totalProdutos.toFixed(2)}</td>
                                    </tr>
                                </tfoot>` : ''}
                            </table>
                        </div>
                    </div>

                    <!-- Profissionais Atribu√≠dos -->
                    ${orc.profissionais && orc.profissionais.length > 0 ? `
                    <div style="background:#f3f4f6;padding:15px;border-radius:15px;margin-bottom:20px;border-left:4px solid #667eea">
                        <h5 style="margin:0 0 10px 0;color:#667eea;font-size:1rem"><i class="bi bi-people"></i> Profissionais Respons√°veis:</h5>
                        ${profissionaisHtml}
                    </div>` : ''}

                    <!-- Observa√ß√µes -->
                    ${orc.observacoes ? `
                    <div style="background:#fff3cd;padding:15px;border-radius:15px;margin-bottom:20px;border-left:4px solid #f2994a">
                        <h5 style="margin:0 0 10px 0;color:#f2994a;font-size:1rem"><i class="bi bi-chat-left-text"></i> Observa√ß√µes:</h5>
                        <p style="margin:0;color:#856404;white-space:pre-wrap">${orc.observacoes}</p>
                    </div>` : ''}

                    <!-- Resumo Financeiro -->
                    <div style="background:linear-gradient(135deg,#f3f4f6,#e5e7eb);padding:20px;border-radius:20px;box-shadow:0 4px 15px rgba(0,0,0,0.1)">
                        <h4 style="margin:0 0 15px 0;color:#1f2937;font-size:1.3rem"><i class="bi bi-calculator"></i> Resumo Financeiro</h4>
                        <div style="display:grid;gap:10px;font-size:1rem">
                            <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #d1d5db">
                                <span>Subtotal (Servi√ßos + Produtos):</span>
                                <strong>R$ ${subtotal.toFixed(2)}</strong>
                            </div>
                            <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #d1d5db;color:#f2994a">
                                <span><i class="bi bi-percent"></i> Desconto Global:</span>
                                <strong>${orc.desconto_global || 0}%</strong>
                            </div>
                            <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #d1d5db;color:#11998e">
                                <span><i class="bi bi-gift"></i> Cashback:</span>
                                <strong>${orc.cashback_perc || 0}% (R$ ${(orc.cashback_valor || 0).toFixed(2)})</strong>
                            </div>
                            <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #d1d5db">
                                <span><i class="bi bi-credit-card"></i> Forma de Pagamento:</span>
                                <strong>${orc.pagamento?.tipo || 'N√£o especificado'}</strong>
                            </div>
                            <div style="display:flex;justify-content:space-between;padding:15px 0 0 0;font-size:1.4rem">
                                <span style="color:#1f2937;font-weight:700">VALOR TOTAL:</span>
                                <strong style="color:#11998e;font-size:1.6rem">R$ ${orc.total_final.toFixed(2)}</strong>
                            </div>
                        </div>
                    </div>

                    <!-- Metadados -->
                    <div style="margin-top:20px;padding-top:15px;border-top:2px dashed #e5e7eb;font-size:0.85rem;color:#6b7280;display:flex;justify-content:space-between;flex-wrap:wrap;gap:10px">
                        <span><i class="bi bi-calendar-plus"></i> Criado: ${new Date(orc.created_at).toLocaleString('pt-BR')}</span>
                        ${orc.updated_at ? `<span><i class="bi bi-calendar-check"></i> Atualizado: ${new Date(orc.updated_at).toLocaleString('pt-BR')}</span>` : ''}
                    </div>

                </div>
                `,
                width: '900px',
                confirmButtonText: '<i class="bi bi-x-circle"></i> Fechar',
                showCancelButton: orc.status?.toLowerCase() === 'pendente',
                cancelButtonText: '<i class="bi bi-pencil"></i> Editar',
                showDenyButton: orc.status?.toLowerCase() === 'pendente',
                denyButtonText: '<i class="bi bi-check-circle"></i> Aprovar',
                allowEscapeKey: true,
                allowOutsideClick: true,
                showCloseButton: true,
                customClass: {
                    popup: 'animate__animated animate__fadeInUp animate__faster'
                }
            }).then((result) => {
                if (result.isDenied) {
                    // Aprovar or√ßamento
                    aprovarOrcamento(id);
                } else if (result.dismiss === Swal.DismissReason.cancel) {
                    // Editar or√ßamento
                    editarOrcamento(id);
                }
            });
        } else {
            throw new Error('Or√ßamento n√£o encontrado');
        }
    }catch(e){
        console.error('Erro ao carregar or√ßamento:', e);
        Swal.fire({
            icon: 'error',
            title: 'Erro ao Carregar',
            text: 'N√£o foi poss√≠vel carregar os detalhes do or√ßamento. Tente novamente.',
            confirmButtonText: 'OK'
        });
    }
}

async function editarOrcamento(id){
    try{
        const res=await fetch(`/api/orcamentos/${id}`,{credentials:'include'});
        const data=await res.json();
        if(data.success&&data.orcamento){
            const orc=data.orcamento;
            orcamento={servicos:orc.servicos||[],produtos:orc.produtos||[]};
            document.getElementById('orcCPF').value=orc.cliente_cpf;
            document.getElementById('orcNomeCliente').value=orc.cliente_nome;
            document.getElementById('orcEmail').value=orc.cliente_email||'';
            document.getElementById('orcTelefone').value=orc.cliente_telefone||'';
            document.getElementById('descontoGlobal').value=orc.desconto_global||0;
            document.getElementById('cashbackPerc').value=orc.cashback_perc||0;
            if(orc.pagamento?.tipo)document.getElementById('pagamento').value=orc.pagamento.tipo;
            atualizarTabelaServicos();
            atualizarTabelaProdutos();
            calcularTotais();

            // Navegar para a se√ß√£o de or√ßamento
            goTo('orcamento');

            // CORRE√á√ÉO: Ir direto para sub-aba "novo" SEM BUG DE SCROLL
            setTimeout(() => {
                // Chamar switchSubTab diretamente (mais confi√°vel)
                switchSubTab('orcamento', 'novo');

                // Scroll suave para o formul√°rio (evitar saltos bruscos)
                const formSection = document.getElementById('orcamento-subtab-novo');
                if (formSection) {
                    formSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }, 300); // Aguardar goTo() completar

            const pageHeader=document.querySelector('#section-orcamento .page-header h1');
            if(pageHeader){pageHeader.innerHTML=`<i class="bi bi-pencil-square"></i> Editando Or√ßamento #${orc.numero}`;}

            // Modal informativo
            Swal.fire({
                icon:'info',
                title:'‚úèÔ∏è Modo Edi√ß√£o',
                html:`<p>Or√ßamento <strong>#${orc.numero}</strong> carregado</p><p style="color:#7C3AED">Fa√ßa as altera√ß√µes e clique em Salvar</p>`,
                timer:2500,
                showConfirmButton:false
            });

            window.orcamentoEditandoId=id;
        }
    }catch(e){
        Swal.fire('Erro','N√£o foi poss√≠vel carregar para edi√ß√£o','error');
    }
}

async function imprimirContrato(id) {
    try {
        // Buscar dados do or√ßamento
        const res = await fetch(`/api/orcamentos/${id}`, {credentials: 'include'});
        const data = await res.json();

        if (!data.success || !data.orcamento) {
            Swal.fire('Erro', 'Or√ßamento n√£o encontrado', 'error');
            return;
        }

        const orc = data.orcamento;

        // Gerar PDF via backend
        const pdfRes = await fetch(`/api/orcamentos/${id}/pdf`, {
            method: 'GET',
            credentials: 'include'
        });

        if (pdfRes.ok) {
            // Baixar o PDF
            const blob = await pdfRes.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `contrato_${orc.numero || id}.pdf`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);

            Swal.fire({
                icon: 'success',
                title: 'Contrato gerado!',
                text: 'O PDF do contrato foi baixado com sucesso',
                timer: 2000,
                showConfirmButton: false
            });
        } else {
            // Fallback: abrir em nova janela para impress√£o
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Contrato #${orc.numero || id}</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 40px; }
                        h1 { color: #7C3AED; border-bottom: 3px solid #7C3AED; padding-bottom: 10px; }
                        .info { margin: 20px 0; }
                        .info strong { color: #333; }
                        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
                        th { background-color: #7C3AED; color: white; }
                        .total { font-size: 1.2em; font-weight: bold; color: #7C3AED; }
                        @media print { button { display: none; } }
                    </style>
                </head>
                <body>
                    <h1>CONTRATO DE SERVI√áOS - #${orc.numero || id}</h1>

                    <div class="info">
                        <p><strong>Cliente:</strong> ${orc.cliente_nome || 'N/A'}</p>
                        <p><strong>CPF:</strong> ${orc.cliente_cpf || 'N/A'}</p>
                        <p><strong>Email:</strong> ${orc.cliente_email || 'N/A'}</p>
                        <p><strong>Telefone:</strong> ${orc.cliente_telefone || 'N/A'}</p>
                        <p><strong>Data:</strong> ${orc.data || new Date().toLocaleDateString('pt-BR')}</p>
                        <p><strong>Status:</strong> ${orc.status || 'Pendente'}</p>
                    </div>

                    ${orc.servicos && orc.servicos.length > 0 ? `
                    <h2>Servi√ßos Contratados</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>Servi√ßo</th>
                                <th>Quantidade</th>
                                <th>Valor Unit.</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${orc.servicos.map(s => `
                                <tr>
                                    <td>${s.nome || 'N/A'}</td>
                                    <td>${s.quantidade || 1}</td>
                                    <td>R$ ${(s.preco || 0).toFixed(2)}</td>
                                    <td>R$ ${((s.quantidade || 1) * (s.preco || 0)).toFixed(2)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    ` : ''}

                    ${orc.produtos && orc.produtos.length > 0 ? `
                    <h2>Produtos Inclusos</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>Produto</th>
                                <th>Quantidade</th>
                                <th>Valor Unit.</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${orc.produtos.map(p => `
                                <tr>
                                    <td>${p.nome || 'N/A'}</td>
                                    <td>${p.quantidade || 1}</td>
                                    <td>R$ ${(p.preco || 0).toFixed(2)}</td>
                                    <td>R$ ${((p.quantidade || 1) * (p.preco || 0)).toFixed(2)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    ` : ''}

                    <div style="text-align: right; margin-top: 30px;">
                        <p class="total">VALOR TOTAL: R$ ${(orc.total_final || 0).toFixed(2)}</p>
                        ${orc.desconto_global ? `<p>Desconto: R$ ${orc.desconto_global.toFixed(2)}</p>` : ''}
                        ${orc.cashback_valor ? `<p>Cashback: R$ ${orc.cashback_valor.toFixed(2)}</p>` : ''}
                    </div>

                    <div style="margin-top: 60px;">
                        <p><strong>Termos e Condi√ß√µes:</strong></p>
                        <p>${orc.observacoes || 'Contrato v√°lido conforme termos gerais da empresa.'}</p>
                    </div>

                    <div style="margin-top: 80px; display: flex; justify-content: space-between;">
                        <div style="border-top: 1px solid #000; padding-top: 10px; width: 45%;">
                            <p style="text-align: center;">Assinatura do Cliente</p>
                        </div>
                        <div style="border-top: 1px solid #000; padding-top: 10px; width: 45%;">
                            <p style="text-align: center;">Assinatura BIOMA</p>
                        </div>
                    </div>

                    <button onclick="window.print()" style="margin-top: 20px; padding: 10px 20px; background: #7C3AED; color: white; border: none; border-radius: 8px; cursor: pointer;">Imprimir</button>
                </body>
                </html>
            `);
            printWindow.document.close();
        }
    } catch (error) {
        console.error('Erro ao imprimir contrato:', error);
        Swal.fire('Erro', 'N√£o foi poss√≠vel gerar o contrato', 'error');
    }
}

function cancelarOrc(){
    orcamento={servicos:[],produtos:[]};
    profissionaisVinculados=[]; // Limpar profissionais vinculados
    limparCliente();
    document.getElementById('descontoGlobal').value='0';
    document.getElementById('cashbackPerc').value='0';
    document.getElementById('pagamento').value='Pix';
    document.getElementById('buscaProfissionalOrc').value=''; // Limpar campo de busca
    document.getElementById('profComissaoPerc').value='10'; // Reset comiss√£o padr√£o
    atualizarTabelaServicos();
    atualizarTabelaProdutos();
    atualizarTabelaProfissionaisVinculados(); // Atualizar tabela de profissionais
    calcularTotais();
    const pageHeader=document.querySelector('#section-orcamento .page-header h1');
    if(pageHeader){pageHeader.innerHTML='<i class="bi bi-file-earmark-plus"></i> Novo Or√ßamento';}
    if(window.orcamentoEditandoId){delete window.orcamentoEditandoId;}
}

// (Ponto 5) Fun√ß√µes de aprova√ß√£o/rejei√ß√£o de or√ßamento
async function aprovarOrcamento(id) {
    const result = await Swal.fire({
        title: 'Aprovar Or√ßamento?',
        text: 'O or√ßamento ser√° movido para "Aprovados".',
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'Sim, Aprovar',
        cancelButtonText: 'Cancelar',
        confirmButtonColor: '#10B981'
    });

    if (result.isConfirmed) {
        try {
            const res = await fetch(`/api/orcamentos/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({ status: 'Aprovado' })
            });

            if (!res.ok) throw new Error('Erro ao aprovar or√ßamento');

            Swal.fire('Aprovado!', 'Or√ßamento aprovado com sucesso', 'success');
            // Recarregar ambas as abas
            carregarOrcamentosPendentes();
            carregarOrcamentosAprovados();

        } catch (error) {
            console.error('Erro:', error);
            Swal.fire('Erro', 'N√£o foi poss√≠vel aprovar o or√ßamento', 'error');
        }
    }
}

async function rejeitarOrcamento(id) {
    const { value: motivo } = await Swal.fire({
        title: 'Rejeitar Or√ßamento',
        input: 'textarea',
        inputLabel: 'Motivo da rejei√ß√£o (opcional)',
        inputPlaceholder: 'Digite o motivo...',
        showCancelButton: true,
        confirmButtonText: 'Confirmar Rejei√ß√£o',
        cancelButtonText: 'Cancelar',
        confirmButtonColor: '#EF4444'
    });

    if (motivo !== undefined) { // Permite motivo vazio
        try {
            const res = await fetch(`/api/orcamentos/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({ status: 'Rejeitado', motivo_rejeicao: motivo || 'Nenhum motivo informado' })
            });

            if (!res.ok) throw new Error('Erro ao rejeitar or√ßamento');

            Swal.fire('Rejeitado!', 'Or√ßamento rejeitado com sucesso', 'success');
            // Recarregar ambas as abas
            carregarOrcamentosPendentes();
            carregarOrcamentosRejeitados();

        } catch (error) {
            console.error('Erro:', error);
            Swal.fire('Erro', 'N√£o foi poss√≠vel rejeitar o or√ßamento', 'error');
        }
    }
}

async function deletarOrcamento(id) {
    const result = await Swal.fire({
        title: 'Deletar Or√ßamento?',
        text: 'Esta a√ß√£o n√£o pode ser desfeita e remover√° o registro permanentemente.',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Sim, Deletar',
        cancelButtonText: 'Cancelar',
        confirmButtonColor: '#EF4444'
    });
    if (result.isConfirmed) {
        try {
            await fetch(`/api/orcamentos/${id}`, { method: 'DELETE', credentials: 'include' });
            Swal.fire('Deletado!', 'Or√ßamento removido com sucesso.', 'success');
            // Recarregar todas as abas de or√ßamento
            carregarOrcamentosPendentes();
            carregarOrcamentosAprovados();
            carregarOrcamentosRejeitados();
            carregarHistoricoOrcamentos();
        } catch (e) {
            Swal.fire('Erro', 'N√£o foi poss√≠vel deletar o or√ßamento.', 'error');
        }
    }
}

let chartServicos=null,chartFaturamento=null;
let assistentesCache=[];
let anamneseDef=null;
let prontuarioDef=null;
// Vari√°veis globais para filtros
let filtrosRelatorios = {
    dataInicio: null,
    dataFim: null
};

let filtrosFinanceiro = {
    dataInicio: null,
    dataFim: null
};

// ==========================================================
// ========== (Ponto 1 & 3) FILTROS E PDF C/GR√ÅFICOS (v6.0) ====
// ==========================================================

/**
 * Obt√©m os filtros de data ativos nas abas Financeiro ou Relat√≥rios.
 * Retorna um objeto { data_inicio, data_fim }
 */
function getFiltrosDeDataAtivos() {
    const activeSection = document.querySelector('.content-section.active')?.id;
    let data_inicio = '', data_fim = '';

    if (activeSection === 'section-financeiro') {
        data_inicio = document.getElementById('financeiroDataInicio')?.value;
        data_fim = document.getElementById('financeiroDataFim')?.value;
    } else if (activeSection === 'section-relatorios') {
        data_inicio = document.getElementById('relatorioDataInicio')?.value;
        data_fim = document.getElementById('relatorioDataFim')?.value;
    }

    // Formatar para ISOString se existirem
    if (data_inicio) data_inicio = new Date(data_inicio + 'T00:00:00').toISOString();
    if (data_fim) data_fim = new Date(data_fim + 'T23:59:59').toISOString();

    return { data_inicio, data_fim };
}

/**
 * Recarrega todos os gr√°ficos da aba atual, aplicando filtros.
 */
async function recarregarGraficosComFiltros() {
    const { data_inicio, data_fim } = getFiltrosDeDataAtivos();
    const activeSection = document.querySelector('.content-section.active')?.id;

    if (activeSection === 'section-financeiro') {
        await carregarFaturamentoMensal(data_inicio, data_fim);
        await carregarServicosMaisVendidos(data_inicio, data_fim);
        await carregarProdutosMaisVendidos(data_inicio, data_fim);
    } else if (activeSection === 'section-relatorios') {
        await loadRelatorios(data_inicio, data_fim);
    }
}

/**
 * Exporta um relat√≥rio em PDF, incluindo imagens dos gr√°ficos.
 */
async function exportarRelatorioComGrafico() {
    const { data_inicio, data_fim } = getFiltrosDeDataAtivos();
    const activeSection = document.querySelector('.content-section.active')?.id;

    let chart1_id = null;
    let chart2_id = null;

    if (activeSection === 'section-financeiro') {
        chart1_id = 'graficoFaturamentoMensal';
        chart2_id = 'graficoServicosMaisVendidos';
    } else if (activeSection === 'section-relatorios') {
        chart1_id = 'chartFaturamento';
        chart2_id = 'chartServicos';
    } else {
        mostrarNotificacao('error', 'N√£o h√° gr√°ficos para exportar nesta aba', 3000);
        return;
    }

    try {
        Swal.fire({
            title: 'Gerando PDF...',
            html: 'Convertendo gr√°ficos e montando o documento...',
            allowOutsideClick: false,
            didOpen: () => Swal.showLoading()
        });

        // 1. Converter gr√°ficos para imagem base64
        const getChartImage = (canvasId) => {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return null;
            return canvas.toDataURL('image/png');
        };

        const img_grafico1 = getChartImage(chart1_id);
        const img_grafico2 = getChartImage(chart2_id);

        // 2. Montar payload
        const payload = {
            data_inicio: data_inicio ? new Date(data_inicio).toLocaleDateString('pt-BR') : 'N/A',
            data_fim: data_fim ? new Date(data_fim).toLocaleDateString('pt-BR') : 'N/A',
            img_vendas_mes: img_grafico1,
            img_top_servicos: img_grafico2
        };

        // 3. Enviar para o backend
        const res = await fetch('/api/relatorios/exportar-pdf', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify(payload)
        });

        if (!res.ok) {
            const err = await res.json();
            throw new Error(err.message || 'Erro do servidor ao gerar PDF');
        }

        // 4. Baixar o PDF retornado
        const blob = await res.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `Relatorio_${activeSection}_${new Date().toISOString().split('T')[0]}.pdf`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        window.URL.revokeObjectURL(url);

        Swal.close();
        mostrarNotificacao('success', 'PDF gerado com sucesso!', 3000);

    } catch (err) {
        console.error('Erro ao exportar PDF com gr√°ficos:', err);
        Swal.fire('Erro', `N√£o foi poss√≠vel gerar o PDF: ${err.message}`, 'error');
    }
}

// ========== FIM FILTROS E EXPORTA√á√ÉO (v6.0) ==========

// Fun√ß√£o para atualizar relat√≥rios
async function atualizarRelatorios() {
    toast('Atualizando relat√≥rios...', 'info');
    await loadRelatorios();
    await carregarMapaCalor();
    mostrarNotificacao('success', 'Relat√≥rios atualizados!', 2000);
}

// Fun√ß√µes de filtro para Relat√≥rios
function aplicarPeriodoRapidoRelatorios(periodo) {
    const hoje = new Date();
    let dataInicio = new Date();
    let dataFim = new Date();

    switch(periodo) {
        case 'hoje':
            dataInicio = new Date(hoje.setHours(0,0,0,0));
            dataFim = new Date(hoje.setHours(23,59,59,999));
            break;
        case 'semana':
            const diaSemana = hoje.getDay();
            dataInicio = new Date(hoje.setDate(hoje.getDate() - diaSemana));
            dataFim = new Date();
            break;
        case 'mes':
            dataInicio = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
            dataFim = new Date();
            break;
        case 'trimestre':
            dataInicio = new Date(hoje.setMonth(hoje.getMonth() - 3));
            dataFim = new Date();
            break;
        case 'semestre':
            dataInicio = new Date(hoje.setMonth(hoje.getMonth() - 6));
            dataFim = new Date();
            break;
        case 'ano':
            dataInicio = new Date(hoje.getFullYear(), 0, 1);
            dataFim = new Date();
            break;
        case 'tudo':
            dataInicio = null;
            dataFim = null;
            break;
        default:
            return;
    }

    if(dataInicio) {
        document.getElementById('relatorioDataInicio').value = dataInicio.toISOString().split('T')[0];
    } else {
        document.getElementById('relatorioDataInicio').value = '';
    }

    if(dataFim) {
        document.getElementById('relatorioDataFim').value = dataFim.toISOString().split('T')[0];
    } else {
        document.getElementById('relatorioDataFim').value = '';
    }

    aplicarFiltrosRelatorios();
}

function aplicarFiltrosRelatorios() {
    const dataInicio = document.getElementById('relatorioDataInicio').value;
    const dataFim = document.getElementById('relatorioDataFim').value;

    filtrosRelatorios.dataInicio = dataInicio ? new Date(dataInicio) : null;
    filtrosRelatorios.dataFim = dataFim ? new Date(dataFim) : null;

    loadRelatorios();
}

function limparFiltrosRelatorios() {
    document.getElementById('relatorioDataInicio').value = '';
    document.getElementById('relatorioDataFim').value = '';
    document.getElementById('relatorioPeriodoRapido').value = 'tudo';
    filtrosRelatorios = { dataInicio: null, dataFim: null };
    loadRelatorios();
}

// Fun√ß√µes de filtro para Financeiro
function aplicarPeriodoRapidoFinanceiro(periodo) {
    const hoje = new Date();
    let dataInicio = new Date();
    let dataFim = new Date();

    switch(periodo) {
        case 'hoje':
            dataInicio = new Date(hoje.setHours(0,0,0,0));
            dataFim = new Date(hoje.setHours(23,59,59,999));
            break;
        case 'semana':
            const diaSemana = hoje.getDay();
            dataInicio = new Date(hoje.setDate(hoje.getDate() - diaSemana));
            dataFim = new Date();
            break;
        case 'mes':
            dataInicio = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
            dataFim = new Date();
            break;
        case 'trimestre':
            dataInicio = new Date(hoje.setMonth(hoje.getMonth() - 3));
            dataFim = new Date();
            break;
        case 'semestre':
            dataInicio = new Date(hoje.setMonth(hoje.getMonth() - 6));
            dataFim = new Date();
            break;
        case 'ano':
            dataInicio = new Date(hoje.getFullYear(), 0, 1);
            dataFim = new Date();
            break;
        case 'tudo':
            dataInicio = null;
            dataFim = null;
            break;
        default:
            return;
    }

    if(dataInicio) {
        document.getElementById('financeiroDataInicio').value = dataInicio.toISOString().split('T')[0];
    } else {
        document.getElementById('financeiroDataInicio').value = '';
    }

    if(dataFim) {
        document.getElementById('financeiroDataFim').value = dataFim.toISOString().split('T')[0];
    } else {
        document.getElementById('financeiroDataFim').value = '';
    }

    aplicarFiltrosFinanceiro();
}

function aplicarFiltrosFinanceiro() {
    const dataInicio = document.getElementById('financeiroDataInicio').value;
    const dataFim = document.getElementById('financeiroDataFim').value;

    filtrosFinanceiro.dataInicio = dataInicio ? new Date(dataInicio) : null;
    filtrosFinanceiro.dataFim = dataFim ? new Date(dataFim) : null;

    carregarDadosFinanceiro();
}

function limparFiltrosFinanceiro() {
    document.getElementById('financeiroDataInicio').value = '';
    document.getElementById('financeiroDataFim').value = '';
    document.getElementById('financeiroPeriodoRapido').value = 'mes';
    filtrosFinanceiro = { dataInicio: null, dataFim: null };
    carregarDadosFinanceiro();
}

// Fun√ß√£o para exportar relat√≥rios como PDF com gr√°ficos
async function exportarRelatoriosPDF() {
    try {
        mostrarNotificacao('info', 'Gerando PDF com gr√°ficos...', 2000);

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'mm', 'a4');

        // Cabe√ßalho
        doc.setFontSize(20);
        doc.setTextColor(124, 58, 237);
        doc.text('BIOMA - Relat√≥rio de An√°lises', 105, 20, { align: 'center' });

        // Informa√ß√µes do per√≠odo
        doc.setFontSize(10);
        doc.setTextColor(100, 100, 100);
        const dataHoje = new Date().toLocaleDateString('pt-BR');
        doc.text(`Gerado em: ${dataHoje}`, 105, 28, { align: 'center' });

        if(filtrosRelatorios.dataInicio || filtrosRelatorios.dataFim) {
            const inicio = filtrosRelatorios.dataInicio ? filtrosRelatorios.dataInicio.toLocaleDateString('pt-BR') : 'In√≠cio';
            const fim = filtrosRelatorios.dataFim ? filtrosRelatorios.dataFim.toLocaleDateString('pt-BR') : 'Hoje';
            doc.text(`Per√≠odo: ${inicio} at√© ${fim}`, 105, 33, { align: 'center' });
        }

        // Linha separadora
        doc.setDrawColor(124, 58, 237);
        doc.setLineWidth(0.5);
        doc.line(20, 38, 190, 38);

        // Cards de resumo
        let yPos = 48;
        doc.setFontSize(14);
        doc.setTextColor(50, 50, 50);
        doc.text('Resumo Geral', 20, yPos);

        yPos += 10;
        doc.setFontSize(10);

        const faturamentoTotal = document.getElementById('relFaturamentoTotal').textContent;
        const faturamentoMes = document.getElementById('relFaturamentoMes').textContent;
        const cashbackTotal = document.getElementById('relCashbackTotal').textContent;
        const ticketMedio = document.getElementById('relTicketMedio').textContent;

        doc.setTextColor(16, 185, 129);
        doc.text(`Faturamento Total: ${faturamentoTotal}`, 20, yPos);
        doc.text(`Faturamento do M√™s: ${faturamentoMes}`, 110, yPos);

        yPos += 8;
        doc.text(`Cashback Gerado: ${cashbackTotal}`, 20, yPos);
        doc.text(`Ticket M√©dio: ${ticketMedio}`, 110, yPos);

        // Capturar gr√°ficos como imagens
        yPos += 15;

        // Gr√°fico de Servi√ßos
        if(chartServicos) {
            try {
                const imgServicos = chartServicos.toBase64Image();
                doc.setFontSize(12);
                doc.setTextColor(50, 50, 50);
                doc.text('Top 5 Servi√ßos Mais Vendidos', 20, yPos);
                yPos += 5;
                doc.addImage(imgServicos, 'PNG', 20, yPos, 170, 70);
                yPos += 75;
            } catch(e) {
                console.warn('Erro ao capturar gr√°fico de servi√ßos:', e);
            }
        }

        // Nova p√°gina se necess√°rio
        if(yPos > 220) {
            doc.addPage();
            yPos = 20;
        }

        // Gr√°fico de Faturamento
        if(chartFaturamento) {
            try {
                const imgFaturamento = chartFaturamento.toBase64Image();
                doc.setFontSize(12);
                doc.setTextColor(50, 50, 50);
                doc.text('Faturamento Mensal', 20, yPos);
                yPos += 5;
                doc.addImage(imgFaturamento, 'PNG', 20, yPos, 170, 70);
                yPos += 75;
            } catch(e) {
                console.warn('Erro ao capturar gr√°fico de faturamento:', e);
            }
        }

        // Nova p√°gina para Top Clientes
        doc.addPage();
        yPos = 20;

        doc.setFontSize(14);
        doc.setTextColor(50, 50, 50);
        doc.text('Top 10 Clientes', 20, yPos);
        yPos += 10;

        // Tabela de Top Clientes
        const topClientesTable = [];
        const topClientesBody = document.getElementById('topClientesBody');
        if(topClientesBody) {
            const rows = topClientesBody.querySelectorAll('tr');
            rows.forEach((row, idx) => {
                if(idx < 10 && row.cells.length >= 3) {
                    topClientesTable.push([
                        row.cells[0].textContent.trim(),
                        row.cells[1].textContent.trim(),
                        row.cells[2].textContent.trim()
                    ]);
                }
            });
        }

        if(topClientesTable.length > 0) {
            doc.autoTable({
                startY: yPos,
                head: [['Posi√ß√£o', 'Nome', 'Total Gasto']],
                body: topClientesTable,
                theme: 'grid',
                headStyles: { fillColor: [124, 58, 237] },
                margin: { left: 20, right: 20 }
            });
        }

        // Rodap√© em todas as p√°ginas
        const pageCount = doc.internal.getNumberOfPages();
        for(let i = 1; i <= pageCount; i++) {
            doc.setPage(i);
            doc.setFontSize(8);
            doc.setTextColor(150, 150, 150);
            doc.text(`P√°gina ${i} de ${pageCount}`, 105, 285, { align: 'center' });
            doc.text('BIOMA - Sistema de Gest√£o', 105, 290, { align: 'center' });
        }

        // Salvar PDF
        const nomeArquivo = `BIOMA_Relatorio_${new Date().toISOString().split('T')[0]}.pdf`;
        doc.save(nomeArquivo);

        mostrarNotificacao('success', 'PDF gerado com sucesso!', 3000);
    } catch(e) {
        console.error('Erro ao gerar PDF:', e);
        mostrarNotificacao('error', 'Erro ao gerar PDF. Verifique o console.', 3000);
    }
}

// Fun√ß√£o para exportar financeiro como PDF
async function exportarFinanceiroPDF() {
    try {
        mostrarNotificacao('info', 'Gerando PDF financeiro...', 2000);

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'mm', 'a4');

        // Cabe√ßalho
        doc.setFontSize(20);
        doc.setTextColor(124, 58, 237);
        doc.text('BIOMA - Relat√≥rio Financeiro', 105, 20, { align: 'center' });

        // Informa√ß√µes do per√≠odo
        doc.setFontSize(10);
        doc.setTextColor(100, 100, 100);
        const dataHoje = new Date().toLocaleDateString('pt-BR');
        doc.text(`Gerado em: ${dataHoje}`, 105, 28, { align: 'center' });

        if(filtrosFinanceiro.dataInicio || filtrosFinanceiro.dataFim) {
            const inicio = filtrosFinanceiro.dataInicio ? filtrosFinanceiro.dataInicio.toLocaleDateString('pt-BR') : 'In√≠cio';
            const fim = filtrosFinanceiro.dataFim ? filtrosFinanceiro.dataFim.toLocaleDateString('pt-BR') : 'Hoje';
            doc.text(`Per√≠odo: ${inicio} at√© ${fim}`, 105, 33, { align: 'center' });
        }

        // Linha separadora
        doc.setDrawColor(124, 58, 237);
        doc.setLineWidth(0.5);
        doc.line(20, 38, 190, 38);

        // Cards de resumo financeiro
        let yPos = 48;
        doc.setFontSize(14);
        doc.setTextColor(50, 50, 50);
        doc.text('Resumo Financeiro', 20, yPos);

        yPos += 10;
        doc.setFontSize(11);

        const receitas = document.getElementById('financeiroReceitas').textContent;
        const despesas = document.getElementById('financeiroDespesas').textContent;
        const comissoes = document.getElementById('financeiroComissoes').textContent;
        const lucro = document.getElementById('financeiroLucro').textContent;

        doc.setTextColor(16, 185, 129);
        doc.text(`Receitas: ${receitas}`, 20, yPos);

        doc.setTextColor(239, 68, 68);
        doc.text(`Despesas: ${despesas}`, 110, yPos);

        yPos += 10;
        doc.setTextColor(245, 158, 11);
        doc.text(`Comiss√µes a Pagar: ${comissoes}`, 20, yPos);

        doc.setTextColor(59, 130, 246);
        doc.text(`Lucro L√≠quido: ${lucro}`, 110, yPos);

        // Rodap√©
        doc.setPage(1);
        doc.setFontSize(8);
        doc.setTextColor(150, 150, 150);
        doc.text('P√°gina 1 de 1', 105, 285, { align: 'center' });
        doc.text('BIOMA - Sistema de Gest√£o', 105, 290, { align: 'center' });

        // Salvar PDF
        const nomeArquivo = `BIOMA_Financeiro_${new Date().toISOString().split('T')[0]}.pdf`;
        doc.save(nomeArquivo);

        mostrarNotificacao('success', 'PDF financeiro gerado com sucesso!', 3000);
    } catch(e) {
        console.error('Erro ao gerar PDF financeiro:', e);
        mostrarNotificacao('error', 'Erro ao gerar PDF. Verifique o console.', 3000);
    }
}

async function loadRelatorios(){
    const key = 'loadRelatorios';
    if (isLoading(key)) {
        console.warn(`‚ö†Ô∏è J√° carregando: ${key}`);
        return;
    }
    setLoading(key, true);

    try{
        const res=await fetch('/api/orcamentos',{credentials:'include'});
        const data=await res.json();
        if(!data.success||!data.orcamentos)return;

        // Aplicar filtros de data
        let orcamentos = data.orcamentos.filter(o=>o.status==='Aprovado');
        if(filtrosRelatorios.dataInicio || filtrosRelatorios.dataFim) {
            orcamentos = orcamentos.filter(o => {
                const dataOrcamento = new Date(o.created_at);
                let atendeFiltro = true;

                if(filtrosRelatorios.dataInicio) {
                    atendeFiltro = atendeFiltro && dataOrcamento >= filtrosRelatorios.dataInicio;
                }

                if(filtrosRelatorios.dataFim) {
                    const dataFimAjustada = new Date(filtrosRelatorios.dataFim);
                    dataFimAjustada.setHours(23, 59, 59, 999);
                    atendeFiltro = atendeFiltro && dataOrcamento <= dataFimAjustada;
                }

                return atendeFiltro;
            });
        }
        const faturamentoTotal=orcamentos.reduce((acc,o)=>acc+(o.total_final||0),0);
        document.getElementById('relFaturamentoTotal').textContent=`R$ ${faturamentoTotal.toFixed(0)}`;
        const mesAtual=new Date().getMonth();
        const anoAtual=new Date().getFullYear();
        const faturamentoMes=orcamentos.filter(o=>{const d=new Date(o.created_at);return d.getMonth()===mesAtual&&d.getFullYear()===anoAtual;}).reduce((acc,o)=>acc+o.total_final,0);
        document.getElementById('relFaturamentoMes').textContent=`R$ ${faturamentoMes.toFixed(0)}`;
        const cashbackTotal=orcamentos.reduce((acc,o)=>acc+(o.cashback_valor||0),0);
        document.getElementById('relCashbackTotal').textContent=`R$ ${cashbackTotal.toFixed(0)}`;
        const ticketMedio=orcamentos.length>0?faturamentoTotal/orcamentos.length:0;
        document.getElementById('relTicketMedio').textContent=`R$ ${ticketMedio.toFixed(0)}`;
        const servicosCount={};
        orcamentos.forEach(o=>{(o.servicos||[]).forEach(s=>{const key=s.nome;if(!servicosCount[key])servicosCount[key]={total:0,qtd:0};servicosCount[key].total+=s.total||0;servicosCount[key].qtd+=s.qtd||1;});});
        const topServicos=Object.entries(servicosCount).sort((a,b)=>b[1].total-a[1].total).slice(0,5);
        const ctxServicos=document.getElementById('chartServicos');
        if(chartServicos)chartServicos.destroy();
        if(topServicos.length>0){
            chartServicos=new Chart(ctxServicos,{type:'bar',data:{labels:topServicos.map(s=>s[0]),datasets:[{label:'Faturamento (R$)',data:topServicos.map(s=>s[1].total),backgroundColor:'rgba(124,58,237,0.8)',borderColor:'rgba(124,58,237,1)',borderWidth:2}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}}}});
        } else {
            // Mostrar mensagem quando n√£o houver dados
            const canvas = document.getElementById('chartServicos');
            if(canvas) {
                const parent = canvas.parentElement;
                parent.innerHTML = '<div style="padding: 60px 20px; text-align: center; color: var(--text-muted);"><i class="bi bi-inbox" style="font-size: 3rem; opacity: 0.3;"></i><p style="margin-top: 15px; font-size: 1.1rem;">Ainda n√£o h√° dados para exibir</p><p style="font-size: 0.9rem;">Os servi√ßos aparecer√£o aqui ap√≥s a aprova√ß√£o de or√ßamentos</p></div><canvas id="chartServicos" style="max-height:300px; display:none;"></canvas>';
            }
        }
        const meses=[];
        const faturamentoMensal=[];
        for(let i=5;i>=0;i--){
            const d=new Date();
            d.setMonth(d.getMonth()-i);
            const mes=d.getMonth();
            const ano=d.getFullYear();
            meses.push(d.toLocaleDateString('pt-BR',{month:'short'}));
            const fat=orcamentos.filter(o=>{const od=new Date(o.created_at);return od.getMonth()===mes&&od.getFullYear()===ano;}).reduce((acc,o)=>acc+o.total_final,0);
            faturamentoMensal.push(fat);
        }
        const ctxFaturamento=document.getElementById('chartFaturamento');
        if(chartFaturamento)chartFaturamento.destroy();
        const temDados = faturamentoMensal.some(val => val > 0);
        if(temDados){
            chartFaturamento=new Chart(ctxFaturamento,{type:'line',data:{labels:meses,datasets:[{label:'Faturamento (R$)',data:faturamentoMensal,backgroundColor:'rgba(16,185,129,0.2)',borderColor:'rgba(16,185,129,1)',borderWidth:3,fill:true,tension:0.4}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}}}});
        } else {
            // Mostrar mensagem quando n√£o houver dados
            const canvas = document.getElementById('chartFaturamento');
            if(canvas) {
                const parent = canvas.parentElement;
                parent.innerHTML = '<div style="padding: 60px 20px; text-align: center; color: var(--text-muted);"><i class="bi bi-inbox" style="font-size: 3rem; opacity: 0.3;"></i><p style="margin-top: 15px; font-size: 1.1rem;">Ainda n√£o h√° dados para exibir</p><p style="font-size: 0.9rem;">O faturamento mensal aparecer√° aqui ap√≥s a aprova√ß√£o de or√ßamentos</p></div><canvas id="chartFaturamento" style="max-height:300px; display:none;"></canvas>';
            }
        }
        const resClientes=await fetch('/api/clientes',{credentials:'include'});
        const dataClientes=await resClientes.json();
        if(dataClientes.success&&dataClientes.clientes){
            const topClientes=dataClientes.clientes.sort((a,b)=>(b.total_gasto||0)-(a.total_gasto||0)).slice(0,10);
            const htmlClientes=topClientes.length > 0 ? topClientes.map((c,idx)=>`<tr><td><strong style="font-size:1.5rem;color:${idx===0?'#FFD700':idx===1?'#C0C0C0':idx===2?'#CD7F32':'var(--text-primary)'}">${idx+1}¬∫</strong></td><td><strong>${c.nome}</strong></td><td><strong style="color:var(--success)">R$ ${(c.total_gasto||0).toFixed(2)}</strong></td><td>${c.total_visitas||0}</td><td>${c.ultima_visita?new Date(c.ultima_visita).toLocaleDateString('pt-BR'):'-'}</td></tr>`).join('') : '<tr><td colspan="5" class="text-center" style="padding: 40px; color: var(--text-muted);"><i class="bi bi-inbox" style="font-size: 2rem; opacity: 0.3; display: block; margin-bottom: 10px;"></i>Ainda n√£o h√° dados para exibir</td></tr>';
            document.getElementById('topClientesBody').innerHTML=htmlClientes;
        } else {
            document.getElementById('topClientesBody').innerHTML='<tr><td colspan="5" class="text-center" style="padding: 40px; color: var(--text-muted);"><i class="bi bi-inbox" style="font-size: 2rem; opacity: 0.3; display: block; margin-bottom: 10px;"></i>Ainda n√£o h√° dados para exibir</td></tr>';
        }
        const produtosCount={};
        orcamentos.forEach(o=>{(o.produtos||[]).forEach(p=>{const key=p.nome;if(!produtosCount[key])produtosCount[key]={total:0,qtd:0};produtosCount[key].total+=p.total||0;produtosCount[key].qtd+=p.qtd||1;});});
        const topProdutos=Object.entries(produtosCount).sort((a,b)=>b[1].qtd-a[1].qtd).slice(0,10);
        if(topProdutos.length>0){
            const htmlProdutos=topProdutos.map(p=>`<tr><td><strong>${p[0]}</strong></td><td>${p[1].qtd}</td><td><strong>R$ ${p[1].total.toFixed(2)}</strong></td></tr>`).join('');
            document.getElementById('topProdutosBody').innerHTML=htmlProdutos;
        }else{
            document.getElementById('topProdutosBody').innerHTML='<tr><td colspan="3" class="text-center" style="padding: 40px; color: var(--text-muted);"><i class="bi bi-inbox" style="font-size: 2rem; opacity: 0.3; display: block; margin-bottom: 10px;"></i>Ainda n√£o h√° dados para exibir</td></tr>';
        }
    }catch(e){
        console.error('‚ùå Relat√≥rios error:',e);
    } finally {
        setTimeout(() => setLoading(key, false), 250);
    }
}

async function exportarRelatorio(){
    try{
        // Usar toast em vez de modal pesado
        toast('Preparando relat√≥rio Excel...', 'info');

        const response = await fetch('/api/relatorios/completo', {
            method: 'GET',
            credentials: 'include'
        });

        if(!response.ok){
            throw new Error('Erro ao gerar relat√≥rio');
        }

        // A API retorna JSON, n√£o um arquivo Excel
        // Vamos usar SheetJS para gerar o Excel no frontend
        const data = await response.json();

        // Criar workbook
        const wb = XLSX.utils.book_new();

        // Criar planilha com dados gerais
        const wsData = [
            ['RELAT√ìRIO BIOMA - RESUMO GERAL'],
            [],
            ['Estat√≠sticas Gerais'],
            ['Total Clientes', data.estatisticas?.total_clientes || 0],
            ['Total Produtos', data.estatisticas?.total_produtos || 0],
            ['Total Servi√ßos', data.estatisticas?.total_servicos || 0],
            ['Total Profissionais', data.estatisticas?.total_profissionais || 0],
            [],
            ['Faturamento'],
            ['Faturamento Total', `R$ ${(data.faturamento?.total || 0).toFixed(2)}`],
            ['Faturamento Servi√ßos', `R$ ${(data.faturamento?.servicos || 0).toFixed(2)}`],
            ['Faturamento Produtos', `R$ ${(data.faturamento?.produtos || 0).toFixed(2)}`],
            ['Ticket M√©dio', `R$ ${(data.vendas?.ticket_medio || 0).toFixed(2)}`],
            ['Taxa de Convers√£o', `${(data.vendas?.taxa_conversao || 0).toFixed(2)}%`]
        ];

        const ws = XLSX.utils.aoa_to_sheet(wsData);
        XLSX.utils.book_append_sheet(wb, ws, 'Resumo');

        // Adicionar planilha de top clientes se houver
        if(data.top_clientes && data.top_clientes.length > 0){
            const clientesData = [
                ['Top Clientes'],
                ['Nome', 'Total Gasto', 'Total Compras'],
                ...data.top_clientes.map(c => [
                    c.cliente_nome || 'N/A',
                    `R$ ${(c.total_gasto || 0).toFixed(2)}`,
                    c.total_compras || 0
                ])
            ];
            const wsClientes = XLSX.utils.aoa_to_sheet(clientesData);
            XLSX.utils.book_append_sheet(wb, wsClientes, 'Top Clientes');
        }

        // Nome do arquivo com data atual
        const dataAtual = new Date().toISOString().split('T')[0];
        const fileName = `relatorio_bioma_${dataAtual}.xlsx`;

        // Gerar arquivo Excel e baixar
        XLSX.writeFile(wb, fileName);

        toast('‚úÖ Relat√≥rio exportado com sucesso!', 'success');

    }catch(e){
        console.error('‚ùå Erro ao exportar relat√≥rio:', e);
        toast('Erro ao exportar relat√≥rio', 'error');
    }
}

async function salvarConfig(){
    try{
        const payload = {
            nome_empresa: document.getElementById('cfgNome').value.trim(),
            cnpj: document.getElementById('cfgCNPJ').value.trim(),
            endereco: document.getElementById('cfgEndereco').value.trim(),
            telefone: document.getElementById('cfgTelefone').value.trim(),
            email: document.getElementById('cfgEmail').value.trim(),
            logo_url: logosPersonalizados.principal || '',
            logo_login_url: logosPersonalizados.login || ''
        };
        const res = await fetch('/api/config',{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            credentials:'include',
            body:JSON.stringify(payload)
        });
        const data = await res.json();
        if(data.success){
            configuracoesAtuais = Object.assign({}, configuracoesAtuais || {}, payload);
            Swal.fire({icon:'success',title:'Configura√ß√µes salvas!',timer:2000});
        }else{
            throw new Error(data.message || 'N√£o foi poss√≠vel salvar');
        }
    }catch(error){
        console.error('Erro ao salvar configura√ß√µes', error);
        Swal.fire('Erro','N√£o foi poss√≠vel salvar as configura√ß√µes.','error');
    }
}

// Fun√ß√£o para testar configura√ß√£o de e-mail
async function testarEmailConfig() {
    const emailDestino = document.getElementById('emailTesteDestino')?.value?.trim();

    if (!emailDestino) {
        Swal.fire({
            icon: 'warning',
            title: 'E-mail Necess√°rio',
            text: 'Por favor, digite um endere√ßo de e-mail para enviar o teste.'
        });
        return;
    }

    // Validar formato de email
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(emailDestino)) {
        Swal.fire({
            icon: 'error',
            title: 'E-mail Inv√°lido',
            text: 'Por favor, digite um endere√ßo de e-mail v√°lido.'
        });
        return;
    }

    try {
        // Mostrar loading
        Swal.fire({
            title: 'Enviando E-mail de Teste...',
            html: 'Por favor, aguarde enquanto o e-mail √© enviado.',
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });

        const response = await fetch('/api/email/test', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ email: emailDestino })
        });

        const data = await response.json();

        if (data.success) {
            Swal.fire({
                icon: 'success',
                title: 'E-mail Enviado com Sucesso!',
                html: `
                    <p>‚úÖ O e-mail de teste foi enviado para:</p>
                    <p><strong>${emailDestino}</strong></p>
                    <p class="text-muted">Verifique a caixa de entrada (e spam) do destinat√°rio.</p>
                `,
                confirmButtonText: 'OK'
            });

            // Limpar campo
            document.getElementById('emailTesteDestino').value = '';

        } else {
            throw new Error(data.message || 'Erro ao enviar e-mail de teste');
        }

    } catch (error) {
        console.error('‚ùå Erro ao testar e-mail:', error);

        Swal.fire({
            icon: 'error',
            title: 'Erro ao Enviar E-mail',
            html: `
                <p>${error.message || 'N√£o foi poss√≠vel enviar o e-mail de teste.'}</p>
                <hr>
                <p class="text-muted"><strong>Poss√≠veis causas:</strong></p>
                <ul style="text-align: left; font-size: 0.9rem;">
                    <li>Configura√ß√µes SMTP incorretas no arquivo .env</li>
                    <li>Credenciais de e-mail inv√°lidas</li>
                    <li>Servidor SMTP bloqueando conex√£o</li>
                    <li>Porta SMTP incorreta ou bloqueada por firewall</li>
                </ul>
                <p class="text-muted">Verifique o console do servidor para mais detalhes.</p>
            `,
            confirmButtonText: 'Entendi'
        });
    }
}

// (Ponto 2) Fun√ß√£o atualizada para salvar configs operacionais
async function salvarConfigOp() {
    try {
        const payload = {
            horario_abertura: document.getElementById('cfgHorarioAbertura').value,
            horario_fechamento: document.getElementById('cfgHorarioFechamento').value,
            duracao_padrao: parseInt(document.getElementById('cfgDuracaoPadrao').value) || 60,
            cashback_padrao: parseFloat(document.getElementById('cfgCashbackPadrao').value) || 5,
            comissao_padrao: parseFloat(document.getElementById('cfgComissaoPadrao').value) || 10,
        };

        // Usar o endpoint /api/config existente
        const res = await fetch('/api/config', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify(payload) // Envia SOMENTE os campos operacionais
        });

        const data = await res.json();

        if (data.success) {
            Swal.fire({ icon: 'success', title: 'Configura√ß√µes salvas!', timer: 2000 });
            // Atualizar cache local
            if (configuracoesAtuais) {
                configuracoesAtuais = { ...configuracoesAtuais, ...payload };
            }
        } else {
            throw new Error(data.message || 'N√£o foi poss√≠vel salvar');
        }
    } catch (error) {
        console.error('Erro ao salvar config operacional:', error);
        Swal.fire('Erro', 'N√£o foi poss√≠vel salvar as configura√ß√µes.', 'error');
    }
}

// ====== NOVAS FUN√á√ïES - AUDITORIA E DASHBOARD ======

// Vari√°veis globais para auditoria
window.currentPageAuditoria = 1;
window.totalPagesAuditoria = 1;

// Fun√ß√£o para carregar auditoria
async function loadAuditoria() {
    const key = 'loadAuditoria';
    if (isLoading(key)) {
        console.warn(`‚ö†Ô∏è J√° carregando: ${key}`);
        return;
    }

    const tbody = document.getElementById('auditoriaTableBody');
    if (!tbody) return;

    setLoading(key, true);
    tbody.innerHTML = '<tr><td colspan="7" class="text-center"><div class="spinner"></div></td></tr>';

    try {
        const username = document.getElementById('auditoriaUsername')?.value || '';
        const acao = document.getElementById('auditoriaAcao')?.value || '';
        const entidade = document.getElementById('auditoriaEntidade')?.value || '';
        const dataInicio = document.getElementById('auditoriaDataInicio')?.value || '';
        const dataFim = document.getElementById('auditoriaDataFim')?.value || '';
        const page = window.currentPageAuditoria || 1;
        
        let url = `/api/auditoria?page=${page}&per_page=50`;
        if (username) url += `&username=${encodeURIComponent(username)}`;
        if (acao) url += `&acao=${acao}`;
        if (entidade) url += `&entidade=${entidade}`;
        if (dataInicio) url += `&data_inicio=${dataInicio}`;
        if (dataFim) url += `&data_fim=${dataFim}`;
        
        const res = await fetch(url, {credentials: 'include'});
        const data = await res.json();
        
        if (data.success && data.registros && data.registros.length > 0) {
            tbody.innerHTML = data.registros.map(r => `
                <tr>
                    <td>${formatarDataHora(r.timestamp)}</td>
                    <td><strong>${r.username}</strong></td>
                    <td><span class="badge ${getBadgeClassAcao(r.acao)}">${r.acao}</span></td>
                    <td>${r.entidade}</td>
                    <td><code style="font-size:0.8em">${r.entidade_id.substring(0, 8)}...</code></td>
                    <td><small>${r.ip || '-'}</small></td>
                    <td>
                        <button class="bioma-btn bioma-btn-sm bioma-btn-outline" onclick="verDetalhesAuditoria('${r._id}')" title="Ver detalhes">
                            <i class="bi bi-eye"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            
            // Atualizar pagina√ß√£o
            if (data.pagination) {
                window.totalPagesAuditoria = data.pagination.total_pages;
                window.currentPageAuditoria = data.pagination.page;
                
                const paginacaoDiv = document.getElementById('paginacaoAuditoria');
                const infoPagina = document.getElementById('infoPaginaAuditoria');
                
                if (paginacaoDiv && infoPagina) {
                    paginacaoDiv.style.display = 'flex';
                    infoPagina.textContent = `P√°gina ${data.pagination.page} de ${data.pagination.total_pages} (${data.pagination.total} registros)`;
                }
            }
            
            // Atualizar estat√≠sticas
            if (data.stats) {
                document.getElementById('auditoriaStats').style.display = 'flex';
                document.getElementById('auditoriaTotalAcoes').textContent = data.stats.total_acoes || 0;
                document.getElementById('auditoriaUsuariosAtivos').textContent = data.stats.usuarios_ativos?.length || 0;
                
                if (data.stats.acoes_por_tipo && data.stats.acoes_por_tipo.length > 0) {
                    document.getElementById('auditoriaPrincipalAcao').textContent = data.stats.acoes_por_tipo[0]._id || '-';
                } else {
                    document.getElementById('auditoriaPrincipalAcao').textContent = '-';
                }
            }
        } else {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">Nenhum registro de auditoria encontrado</td></tr>';
            document.getElementById('paginacaoAuditoria')?.style.setProperty('display', 'none', 'important');
            document.getElementById('auditoriaStats').style.display = 'none';
        }
    } catch (error) {
        console.error('Erro ao carregar auditoria:', error);
        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-danger">Erro ao carregar registros de auditoria</td></tr>';
    } finally {
        setTimeout(() => setLoading(key, false), 250);
    }
}

async function loadClube(){
    const key = 'loadClube';
    if (isLoading(key)) {
        console.warn(`‚ö†Ô∏è J√° carregando: ${key}`);
        return;
    }
    setLoading(key, true);

    try{
        // A se√ß√£o de clube √© est√°tica (HTML puro), n√£o precisa carregar dados do backend
        // Esta fun√ß√£o existe apenas para manter consist√™ncia
        console.log('üì¢ Se√ß√£o Comunidade carregada');
    } finally {
        setTimeout(() => setLoading(key, false), 100);
    }
}

// Fun√ß√£o auxiliar para badge de a√ß√£o
function getBadgeClassAcao(acao) {
    const classes = {
        'criar': 'success',
        'editar': 'warning',
        'deletar': 'danger',
        'aprovar': 'success',
        'rejeitar': 'danger'
    };
    return classes[acao] || 'neutral';
}

// Fun√ß√£o para mudar p√°gina de auditoria
function mudarPaginaAuditoria(direcao) {
    const currentPage = window.currentPageAuditoria || 1;
    const totalPages = window.totalPagesAuditoria || 1;
    
    let newPage = currentPage + direcao;
    if (newPage < 1) newPage = 1;
    if (newPage > totalPages) newPage = totalPages;
    
    window.currentPageAuditoria = newPage;
    loadAuditoria();
}

// Fun√ß√£o para ver detalhes de auditoria
async function verDetalhesAuditoria(id) {
    // Implementa√ß√£o simplificada - pode ser expandida
    if (window.Swal) {
        Swal.fire({
            icon: 'info',
            title: 'Detalhes da Auditoria',
            text: `Registro ID: ${id}`,
            html: '<p>Funcionalidade completa em desenvolvimento</p>'
        });
    }
}

// Fun√ß√£o para atualizar dashboard com stats em tempo real
let dashboardRealtimeInterval = null;

async function startDashboardRealtime() {
    // Limpar intervalo anterior se existir
    if (dashboardRealtimeInterval) {
        clearInterval(dashboardRealtimeInterval);
    }
    
    // Primeira execu√ß√£o imediata
    await updateDashboardRealtime();

    // ‚ö†Ô∏è AUTO-ATUALIZA√á√ÉO DESABILITADA - use bot√£o de refresh manual
    // dashboardRealtimeInterval = setInterval(updateDashboardRealtime, 60000);
}

async function updateDashboardRealtime() {
    try {
        const res = await fetch('/api/dashboard/stats/realtime', {credentials: 'include'});
        const data = await res.json();
        
        if (data.success && data.stats) {
            const stats = data.stats;
            
            // Atualizar cards do dashboard (se existirem)
            const updateElement = (id, value) => {
                const el = document.getElementById(id);
                if (el) el.textContent = value;
            };
            
            // Totais
            updateElement('totalClientes', stats.totais?.clientes || 0);
            updateElement('totalProfissionais', stats.totais?.profissionais || 0);
            updateElement('totalProdutos', stats.totais?.produtos || 0);
            
            // Faturamento
            if (stats.faturamento) {
                updateElement('faturamentoMes', formatarMoeda(stats.faturamento.mes));
                updateElement('faturamentoHoje', formatarMoeda(stats.faturamento.hoje));
                updateElement('ticketMedio', formatarMoeda(stats.faturamento.ticket_medio));
            }
            
            // Pend√™ncias - adicionar badge com contador se houver
            if (stats.pendencias && stats.pendencias.total > 0) {
                const menuEstoque = document.getElementById('menu-estoque');
                if (menuEstoque && !menuEstoque.querySelector('.badge')) {
                    const badge = document.createElement('span');
                    badge.className = 'badge badge-sm bg-danger ms-2';
                    badge.textContent = stats.pendencias.total;
                    badge.style.cssText = 'padding: 4px 8px; border-radius: 10px; font-size: 0.7em;';
                    menuEstoque.appendChild(badge);
                }
            }
            
            // Log para debug
            console.log('%cüìä Dashboard atualizado', 'color:#10B981;font-weight:bold', new Date().toLocaleTimeString());
        }
    } catch (error) {
        console.error('Erro ao atualizar dashboard em tempo real:', error);
    }
}

// Parar atualiza√ß√£o autom√°tica quando sair do dashboard
function stopDashboardRealtime() {
    if (dashboardRealtimeInterval) {
        clearInterval(dashboardRealtimeInterval);
        dashboardRealtimeInterval = null;
    }
}

// ====== FUN√á√ïES DE FOTO DE PROFISSIONAIS ======

/**
 * Exibir foto do profissional ou avatar padr√£o
 */
function exibirFotoProfissional(fotoUrl) {
    if (fotoUrl && fotoUrl !== '') {
        return `<img src="${fotoUrl}" alt="Foto" style="width:45px;height:45px;border-radius:50%;object-fit:cover;border:2px solid var(--primary);">`;
    } else {
        return `<div style="width:45px;height:45px;border-radius:50%;background:linear-gradient(135deg,#7C3AED,#EC4899);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:1.2rem;"><i class="bi bi-person"></i></div>`;
    }
}

/**
 * Valida√ß√£o de imagem para upload
 * @param {File} file - Arquivo de imagem
 * @param {Object} options - Op√ß√µes de valida√ß√£o
 * @returns {Object} - {valid: boolean, error: string}
 */
function validarImagemUpload(file, options = {}) {
    const config = {
        maxSizeMB: options.maxSizeMB || 5,
        allowedTypes: options.allowedTypes || ['image/jpeg', 'image/jpg', 'image/png', 'image/webp', 'image/gif'],
        ...options
    };

    // Validar se arquivo existe
    if (!file) {
        return { valid: false, error: 'Nenhum arquivo selecionado' };
    }

    // Validar tipo de arquivo
    if (!config.allowedTypes.includes(file.type.toLowerCase())) {
        const tipos = config.allowedTypes.map(t => t.split('/')[1].toUpperCase()).join(', ');
        return {
            valid: false,
            error: `Formato n√£o permitido. Use: ${tipos}`
        };
    }

    // Validar tamanho
    const sizeMB = file.size / (1024 * 1024);
    if (sizeMB > config.maxSizeMB) {
        return {
            valid: false,
            error: `Arquivo muito grande (${sizeMB.toFixed(2)}MB). M√°ximo: ${config.maxSizeMB}MB`
        };
    }

    return {
        valid: true,
        fileInfo: {
            name: file.name,
            size: sizeMB.toFixed(2) + 'MB',
            type: file.type.split('/')[1].toUpperCase()
        }
    };
}

/**
 * Formatar bytes para formato leg√≠vel
 */
function formatarTamanhoArquivo(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round((bytes / Math.pow(k, i)) * 100) / 100 + ' ' + sizes[i];
}

// ========== BIBLIOTECA DE EXPORTA√á√ÉO ==========

/**
 * Biblioteca unificada para exporta√ß√£o de dados
 * Suporta: Excel (XLSX), CSV, PDF
 */
const ExportLibrary = {
    /**
     * Exportar dados para CSV
     * @param {Array} data - Array de objetos com os dados
     * @param {Array} columns - Array de objetos {key: 'campo', label: 'Label'}
     * @param {String} filename - Nome do arquivo
     */
    toCSV: function(data, columns, filename) {
        if (!data || data.length === 0) {
            Swal.fire('Aten√ß√£o', 'Nenhum dado dispon√≠vel para exportar', 'warning');
            return;
        }

        // BOM UTF-8 para Excel reconhecer acentos
        let csv = '\uFEFF';

        // Cabe√ßalhos
        csv += columns.map(col => col.label).join(';') + '\n';

        // Dados
        data.forEach(row => {
            const line = columns.map(col => {
                let value = row[col.key] ?? '';

                // Tratar tipos especiais
                if (typeof value === 'object' && value !== null) {
                    value = JSON.stringify(value);
                }

                // Escapar ponto e v√≠rgula
                value = String(value).replace(/;/g, ',');

                return value;
            }).join(';');

            csv += line + '\n';
        });

        // Download
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `${filename}_${new Date().toISOString().split('T')[0]}.csv`;
        link.click();
        URL.revokeObjectURL(link.href);

        // Toast notification simples sem bloquear
        console.log(`‚úÖ CSV exportado: ${data.length} registros`);

        const toast = document.createElement('div');
        toast.style.cssText = 'position:fixed;top:20px;right:20px;background:linear-gradient(135deg,#3B82F6,#2563EB);color:white;padding:16px 24px;border-radius:12px;box-shadow:0 8px 25px rgba(59,130,246,0.4);z-index:99999;font-weight:700;animation:slideInRight 0.4s ease;';
        toast.innerHTML = `<i class="bi bi-check-circle-fill"></i> CSV exportado! (${data.length} registros)`;
        document.body.appendChild(toast);

        setTimeout(() => {
            toast.style.animation = 'slideOutRight 0.4s ease';
            setTimeout(() => toast.remove(), 400);
        }, 2500);
    },

    /**
     * Exportar dados para Excel usando biblioteca SheetJS
     * @param {Array} data - Array de objetos com os dados
     * @param {Array} columns - Array de objetos {key: 'campo', label: 'Label'}
     * @param {String} filename - Nome do arquivo
     * @param {String} sheetName - Nome da planilha
     */
    toExcel: async function(data, columns, filename, sheetName = 'Dados') {
        if (!data || data.length === 0) {
            Swal.fire('Aten√ß√£o', 'Nenhum dado dispon√≠vel para exportar', 'warning');
            return;
        }

        try {
            // Criar workbook com SheetJS
            if (typeof XLSX === 'undefined') {
                throw new Error('Biblioteca XLSX n√£o carregada');
            }

            const wb = XLSX.utils.book_new();

            // Adicionar informa√ß√µes do cabe√ßalho corporativo
            const headerData = [
                ['BIOMA BEAUTY SYSTEM - RELAT√ìRIO EXPORTADO'],
                ['Data de Exporta√ß√£o: ' + new Date().toLocaleDateString('pt-BR') + ' √†s ' + new Date().toLocaleTimeString('pt-BR')],
                ['Total de Registros: ' + data.length],
                [], // Linha vazia
            ];

            // Preparar dados no formato de tabela
            const tableData = [];

            // Adicionar cabe√ßalhos das colunas
            tableData.push(columns.map(col => col.label));

            // Dados formatados
            data.forEach(row => {
                const rowData = columns.map(col => {
                    let value = row[col.key] ?? '';

                    // Formatar datas
                    if (col.type === 'date' && value) {
                        value = new Date(value).toLocaleDateString('pt-BR');
                    }
                    // Formatar moeda - sem s√≠mbolo R$ para Excel processar corretamente
                    else if (col.type === 'currency' && value) {
                        value = Number(value);
                    }
                    // Formatar boolean
                    else if (col.type === 'boolean') {
                        value = value ? 'Sim' : 'N√£o';
                    }

                    return value;
                });
                tableData.push(rowData);
            });

            // Combinar header com dados
            const finalData = [...headerData, ...tableData];

            // Criar worksheet
            const ws = XLSX.utils.aoa_to_sheet(finalData);

            // Definir larguras das colunas
            const wscols = columns.map(col => ({ wch: col.width || 20 }));
            // Adicionar largura extra para a primeira coluna do cabe√ßalho
            wscols.unshift({ wch: 50 });
            ws['!cols'] = wscols;

            // Mesclar c√©lulas do cabe√ßalho
            if(!ws['!merges']) ws['!merges'] = [];
            ws['!merges'].push(
                {s: {r: 0, c: 0}, e: {r: 0, c: columns.length - 1}}, // T√≠tulo principal
                {s: {r: 1, c: 0}, e: {r: 1, c: columns.length - 1}}, // Data de exporta√ß√£o
                {s: {r: 2, c: 0}, e: {r: 2, c: columns.length - 1}}  // Total de registros
            );

            // Aplicar estilos (se a biblioteca suportar)
            const range = XLSX.utils.decode_range(ws['!ref']);
            for (let R = 0; R <= range.e.r; R++) {
                for (let C = 0; C <= range.e.c; C++) {
                    const cellAddress = XLSX.utils.encode_cell({r: R, c: C});

                    if (!ws[cellAddress]) continue;

                    // Estilo para cabe√ßalho corporativo
                    if (R < 3) {
                        ws[cellAddress].s = {
                            font: { bold: true, sz: R === 0 ? 16 : 12 },
                            alignment: { horizontal: 'center', vertical: 'center' },
                            fill: R === 0 ? { fgColor: { rgb: '7C3AED' } } : {}
                        };
                    }
                    // Estilo para cabe√ßalhos das colunas
                    else if (R === 4) {
                        ws[cellAddress].s = {
                            font: { bold: true, color: { rgb: 'FFFFFF' } },
                            fill: { fgColor: { rgb: '7C3AED' } },
                            alignment: { horizontal: 'center', vertical: 'center' },
                            border: {
                                top: { style: 'thin', color: { rgb: '000000' } },
                                bottom: { style: 'thin', color: { rgb: '000000' } },
                                left: { style: 'thin', color: { rgb: '000000' } },
                                right: { style: 'thin', color: { rgb: '000000' } }
                            }
                        };
                    }
                    // Formatar c√©lulas de moeda
                    else if (R > 4 && columns[C] && columns[C].type === 'currency') {
                        ws[cellAddress].z = 'R$ #,##0.00';
                        ws[cellAddress].t = 'n';
                    }
                }
            }

            // Adicionar auto-filtro
            ws['!autofilter'] = { ref: `A5:${XLSX.utils.encode_col(columns.length - 1)}${range.e.r + 1}` };

            // Adicionar planilha ao workbook
            XLSX.utils.book_append_sheet(wb, ws, sheetName);

            // Adicionar propriedades do documento
            wb.Props = {
                Title: sheetName,
                Author: 'BIOMA Beauty System',
                Company: 'BIOMA Uberaba',
                CreatedDate: new Date()
            };

            // Gerar arquivo
            XLSX.writeFile(wb, `${filename}_${new Date().toISOString().split('T')[0]}.xlsx`);

            // Mensagem de sucesso toast (n√£o bloqueia)
            console.log(`‚úÖ Excel exportado: ${data.length} registros`);

            // Toast notification simples sem bloquear
            const toast = document.createElement('div');
            toast.style.cssText = 'position:fixed;top:20px;right:20px;background:linear-gradient(135deg,#10B981,#059669);color:white;padding:16px 24px;border-radius:12px;box-shadow:0 8px 25px rgba(16,185,129,0.4);z-index:99999;font-weight:700;animation:slideInRight 0.4s ease;';
            toast.innerHTML = `<i class="bi bi-check-circle-fill"></i> Excel exportado! (${data.length} registros)`;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'slideOutRight 0.4s ease';
                setTimeout(() => toast.remove(), 400);
            }, 2500);

        } catch (error) {
            console.error('Erro ao gerar Excel:', error);
            Swal.fire('Erro', 'N√£o foi poss√≠vel gerar o arquivo Excel', 'error');
        }
    },

    /**
     * Exportar tabela HTML existente para CSV
     * @param {String} tableId - ID da tabela HTML
     * @param {String} filename - Nome do arquivo
     */
    tableToCSV: function(tableId, filename) {
        const table = document.getElementById(tableId);
        if (!table) {
            Swal.fire('Erro', 'Tabela n√£o encontrada', 'error');
            return;
        }

        const rows = table.querySelectorAll('tr');
        if (rows.length <= 1) {
            Swal.fire('Aten√ß√£o', 'Nenhum dado na tabela para exportar', 'warning');
            return;
        }

        let csv = '\uFEFF'; // BOM UTF-8

        rows.forEach((row, index) => {
            const cells = row.querySelectorAll(index === 0 ? 'th' : 'td');
            const line = Array.from(cells).map(cell => {
                return cell.textContent.trim().replace(/;/g, ',');
            }).join(';');
            csv += line + '\n';
        });

        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `${filename}_${new Date().toISOString().split('T')[0]}.csv`;
        link.click();
        URL.revokeObjectURL(link.href);

        // Toast notification simples sem bloquear
        console.log(`‚úÖ CSV exportado da tabela`);

        const toast = document.createElement('div');
        toast.style.cssText = 'position:fixed;top:20px;right:20px;background:linear-gradient(135deg,#3B82F6,#2563EB);color:white;padding:16px 24px;border-radius:12px;box-shadow:0 8px 25px rgba(59,130,246,0.4);z-index:99999;font-weight:700;animation:slideInRight 0.4s ease;';
        toast.innerHTML = `<i class="bi bi-check-circle-fill"></i> CSV exportado!`;
        document.body.appendChild(toast);

        setTimeout(() => {
            toast.style.animation = 'slideOutRight 0.4s ease';
            setTimeout(() => toast.remove(), 400);
        }, 2500);
    }
};

// ========== FIM BIBLIOTECA DE EXPORTA√á√ÉO ==========

// ========== FUN√á√ïES DE EXPORTA√á√ÉO ESPEC√çFICAS ==========

/**
 * Exportar Or√ßamentos para Excel
 */
async function exportarOrcamentosExcel() {
    try {
        const res = await fetch('/api/orcamentos', { credentials: 'include' });
        const data = await res.json();

        if (!data.success || !data.orcamentos || data.orcamentos.length === 0) {
            Swal.fire('Aten√ß√£o', 'Nenhum or√ßamento dispon√≠vel para exportar', 'info');
            return;
        }

        const columns = [
            { key: 'numero', label: 'N√∫mero', width: 10 },
            { key: 'cliente_nome', label: 'Cliente', width: 25 },
            { key: 'created_at', label: 'Data', type: 'date', width: 12 },
            { key: 'profissional_nome', label: 'Profissional', width: 25 },
            { key: 'total_servicos', label: 'Total Servi√ßos', type: 'currency', width: 15 },
            { key: 'total_produtos', label: 'Total Produtos', type: 'currency', width: 15 },
            { key: 'desconto', label: 'Desconto', type: 'currency', width: 12 },
            { key: 'total_final', label: 'Total Final', type: 'currency', width: 15 },
            { key: 'status', label: 'Status', width: 12 }
        ];

        await ExportLibrary.toExcel(data.orcamentos, columns, 'orcamentos_bioma', 'Or√ßamentos');
    } catch (error) {
        console.error('Erro ao exportar or√ßamentos:', error);
        Swal.fire('Erro', 'N√£o foi poss√≠vel exportar os or√ßamentos', 'error');
    }
}

/**
 * Exportar Or√ßamentos para CSV
 */
async function exportarOrcamentosCSV() {
    try {
        const res = await fetch('/api/orcamentos', { credentials: 'include' });
        const data = await res.json();

        if (!data.success || !data.orcamentos || data.orcamentos.length === 0) {
            Swal.fire('Aten√ß√£o', 'Nenhum or√ßamento dispon√≠vel para exportar', 'info');
            return;
        }

        const columns = [
            { key: 'numero', label: 'N√∫mero' },
            { key: 'cliente_nome', label: 'Cliente' },
            { key: 'created_at', label: 'Data' },
            { key: 'profissional_nome', label: 'Profissional' },
            { key: 'total_final', label: 'Total Final' },
            { key: 'status', label: 'Status' }
        ];

        ExportLibrary.toCSV(data.orcamentos, columns, 'orcamentos_bioma');
    } catch (error) {
        console.error('Erro ao exportar or√ßamentos:', error);
        Swal.fire('Erro', 'N√£o foi poss√≠vel exportar os or√ßamentos', 'error');
    }
}

/**
 * Exportar Servi√ßos para Excel/CSV
 */
async function exportarServicos(formato = 'excel') {
    try {
        const res = await fetch('/api/servicos', { credentials: 'include' });
        const data = await res.json();

        if (!data.success || !data.servicos || data.servicos.length === 0) {
            Swal.fire('Aten√ß√£o', 'Nenhum servi√ßo dispon√≠vel para exportar', 'info');
            return;
        }

        const columns = [
            { key: 'nome', label: 'Nome do Servi√ßo', width: 30 },
            { key: 'categoria', label: 'Categoria', width: 15 },
            { key: 'tamanho', label: 'Tamanho', width: 12 },
            { key: 'preco', label: 'Pre√ßo', type: 'currency', width: 15 },
            { key: 'duracao', label: 'Dura√ß√£o (min)', width: 12 },
            { key: 'ativo', label: 'Ativo', type: 'boolean', width: 10 }
        ];

        if (formato === 'excel') {
            await ExportLibrary.toExcel(data.servicos, columns, 'servicos_bioma', 'Servi√ßos');
        } else {
            ExportLibrary.toCSV(data.servicos, columns, 'servicos_bioma');
        }
    } catch (error) {
        console.error('Erro ao exportar servi√ßos:', error);
        Swal.fire('Erro', 'N√£o foi poss√≠vel exportar os servi√ßos', 'error');
    }
}

/**
 * Exportar Produtos para Excel/CSV
 */
async function exportarProdutos(formato = 'excel') {
    try {
        const res = await fetch('/api/produtos', { credentials: 'include' });
        const data = await res.json();

        if (!data.success || !data.produtos || data.produtos.length === 0) {
            Swal.fire('Aten√ß√£o', 'Nenhum produto dispon√≠vel para exportar', 'info');
            return;
        }

        const columns = [
            { key: 'nome', label: 'Nome do Produto', width: 30 },
            { key: 'marca', label: 'Marca', width: 20 },
            { key: 'preco', label: 'Pre√ßo', type: 'currency', width: 15 },
            { key: 'estoque', label: 'Estoque', width: 10 },
            { key: 'estoque_minimo', label: 'Estoque M√≠nimo', width: 15 },
            { key: 'ativo', label: 'Ativo', type: 'boolean', width: 10 }
        ];

        if (formato === 'excel') {
            await ExportLibrary.toExcel(data.produtos, columns, 'produtos_bioma', 'Produtos');
        } else {
            ExportLibrary.toCSV(data.produtos, columns, 'produtos_bioma');
        }
    } catch (error) {
        console.error('Erro ao exportar produtos:', error);
        Swal.fire('Erro', 'N√£o foi poss√≠vel exportar os produtos', 'error');
    }
}

/**
 * Exportar Clientes para Excel/CSV
 */
async function exportarClientes(formato = 'excel') {
    try {
        const res = await fetch('/api/clientes', { credentials: 'include' });
        const data = await res.json();

        if (!data.success || !data.clientes || data.clientes.length === 0) {
            Swal.fire('Aten√ß√£o', 'Nenhum cliente dispon√≠vel para exportar', 'info');
            return;
        }

        const columns = [
            { key: 'nome', label: 'Nome', width: 30 },
            { key: 'telefone', label: 'Telefone', width: 15 },
            { key: 'email', label: 'E-mail', width: 30 },
            { key: 'cpf', label: 'CPF', width: 15 },
            { key: 'data_nascimento', label: 'Data Nascimento', type: 'date', width: 15 },
            { key: 'endereco', label: 'Endere√ßo', width: 35 }
        ];

        if (formato === 'excel') {
            await ExportLibrary.toExcel(data.clientes, columns, 'clientes_bioma', 'Clientes');
        } else {
            ExportLibrary.toCSV(data.clientes, columns, 'clientes_bioma');
        }
    } catch (error) {
        console.error('Erro ao exportar clientes:', error);
        Swal.fire('Erro', 'N√£o foi poss√≠vel exportar os clientes', 'error');
    }
}

/**
 * Exportar Profissionais para Excel/CSV
 */
async function exportarProfissionais(formato = 'excel') {
    try {
        const res = await fetch('/api/profissionais', { credentials: 'include' });
        const data = await res.json();

        if (!data.success || !data.profissionais || data.profissionais.length === 0) {
            Swal.fire('Aten√ß√£o', 'Nenhum profissional dispon√≠vel para exportar', 'info');
            return;
        }

        const columns = [
            { key: 'nome', label: 'Nome', width: 30 },
            { key: 'especialidade', label: 'Especialidade', width: 25 },
            { key: 'telefone', label: 'Telefone', width: 15 },
            { key: 'email', label: 'E-mail', width: 30 },
            { key: 'comissao_padrao', label: 'Comiss√£o Padr√£o (%)', width: 18 },
            { key: 'ativo', label: 'Ativo', type: 'boolean', width: 10 }
        ];

        if (formato === 'excel') {
            await ExportLibrary.toExcel(data.profissionais, columns, 'profissionais_bioma', 'Profissionais');
        } else {
            ExportLibrary.toCSV(data.profissionais, columns, 'profissionais_bioma');
        }
    } catch (error) {
        console.error('Erro ao exportar profissionais:', error);
        Swal.fire('Erro', 'N√£o foi poss√≠vel exportar os profissionais', 'error');
    }
}

// ========== FIM FUN√á√ïES DE EXPORTA√á√ÉO ESPEC√çFICAS ==========

/**
 * Mostrar nome do arquivo selecionado
 */
function mostrarNomeArquivo(input, containerId) {
    const file = input.files[0];
    if (file) {
        const container = document.getElementById(containerId);
        const fileNameSpan = container.querySelector('span');

        if (container && fileNameSpan) {
            fileNameSpan.textContent = file.name;
            container.style.display = 'block';
        }
    }
}

/**
 * Carregar lista de profissionais em um select
 */
async function loadProfissionaisSelect(selectId) {
    try {
        const res = await fetch('/api/profissionais', { credentials: 'include' });
        const data = await res.json();

        const select = document.getElementById(selectId);
        if (select && data.success && data.profissionais) {
            select.innerHTML = '<option value="">Selecione o profissional...</option>';
            data.profissionais.forEach(prof => {
                const option = document.createElement('option');
                option.value = prof._id;
                option.textContent = prof.nome + (prof.especialidade ? ` - ${prof.especialidade}` : '');
                select.appendChild(option);
            });
        }
    } catch (error) {
        console.error('Erro ao carregar profissionais:', error);
    }
}

/**
 * Validar arquivo de imagem antes do upload
 */
function validarImagemUpload(file, options = {}) {
    const maxSizeMB = options.maxSizeMB || 5;
    const allowedTypes = options.allowedTypes || ['image/jpeg', 'image/jpg', 'image/png', 'image/webp', 'image/gif'];
    const maxSizeBytes = maxSizeMB * 1024 * 1024;

    const result = {
        valid: true,
        error: null,
        fileInfo: {
            name: file.name,
            size: formatarTamanhoArquivo(file.size),
            sizeBytes: file.size,
            type: file.type.split('/')[1].toUpperCase()
        }
    };

    // Validar tipo
    if (!allowedTypes.includes(file.type)) {
        result.valid = false;
        result.error = `Tipo de arquivo inv√°lido. Use: ${allowedTypes.map(t => t.split('/')[1].toUpperCase()).join(', ')}`;
        return result;
    }

    // Validar tamanho
    if (file.size > maxSizeBytes) {
        result.valid = false;
        result.error = `Arquivo muito grande. M√°ximo: ${maxSizeMB}MB (seu arquivo: ${result.fileInfo.size})`;
        return result;
    }

    // Validar se √© realmente uma imagem
    if (!file.type.startsWith('image/')) {
        result.valid = false;
        result.error = 'O arquivo selecionado n√£o √© uma imagem v√°lida';
        return result;
    }

    return result;
}

/**
 * Formatar tamanho de arquivo
 */
function formatarTamanhoArquivo(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
}

/**
 * Upload de foto para profissional
 */
async function uploadFotoProfissional(profissionalId) {
    // Fun√ß√£o auxiliar para comprimir imagem
    function compressImage(file, maxWidth = 800) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = function(event) {
                const img = new Image();
                img.src = event.target.result;
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;

                    // Calcular novo tamanho mantendo propor√ß√£o
                    if (width > maxWidth) {
                        height = (height * maxWidth) / width;
                        width = maxWidth;
                    }

                    canvas.width = width;
                    canvas.height = height;

                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);

                    // Converter para blob com qualidade otimizada
                    canvas.toBlob((blob) => {
                        resolve(new File([blob], file.name, {
                            type: 'image/jpeg',
                            lastModified: Date.now()
                        }));
                    }, 'image/jpeg', 0.85);
                };
                img.onerror = reject;
            };
            reader.onerror = reject;
        });
    }

    const {value: file} = await Swal.fire({
        title: '<i class="bi bi-camera-fill"></i> Upload de Foto Profissional',
        html: `
            <div style="text-align:center;padding:20px;">
                <label for="fotoInput" style="cursor:pointer;display:block;margin-bottom:15px;">
                    <div id="uploadArea" style="width:200px;height:200px;margin:0 auto;border-radius:50%;border:3px dashed var(--primary);display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg, #f5f3ff, #ffffff);transition:all 0.3s;position:relative;overflow:hidden;box-shadow:0 8px 20px rgba(124,58,237,0.1);"
                         onmouseover="this.style.borderColor='var(--secondary)';this.style.transform='scale(1.05)'"
                         onmouseout="this.style.borderColor='var(--primary)';this.style.transform='scale(1)'">
                        <i class="bi bi-camera" id="cameraIcon" style="font-size:4rem;color:var(--primary);transition:all 0.3s;"></i>
                        <img id="fotoPreview" style="display:none;width:100%;height:100%;object-fit:cover;border-radius:50%;">
                    </div>
                    <p style="margin-top:15px;color:var(--text-secondary);font-weight:600;font-size:1.1rem;">
                        <i class="bi bi-cloud-upload"></i> Clique para selecionar foto
                    </p>
                </label>
                <input type="file" id="fotoInput" accept="image/jpeg,image/jpg,image/png,image/webp,image/gif" style="display:none;">

                <div id="uploadProgress" style="display:none;margin-top:20px;">
                    <div class="progress" style="height:25px;border-radius:15px;overflow:hidden;">
                        <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width:0%;background:linear-gradient(90deg, var(--primary), var(--secondary));">
                            <span id="progressText">0%</span>
                        </div>
                    </div>
                </div>

                <div id="fileInfo" style="display:none;margin-top:15px;padding:15px;background:var(--bg-secondary);border-radius:15px;text-align:left;border:1px solid var(--border-color);">
                    <p style="margin:8px 0;color:var(--text-primary);"><strong><i class="bi bi-file-earmark-image"></i> Arquivo:</strong> <span id="fileName"></span></p>
                    <p style="margin:8px 0;color:var(--text-primary);"><strong><i class="bi bi-hdd"></i> Tamanho:</strong> <span id="fileSize"></span></p>
                    <p style="margin:8px 0;color:var(--text-primary);"><strong><i class="bi bi-aspect-ratio"></i> Dimens√µes:</strong> <span id="fileDimensions"></span></p>
                    <p style="margin:8px 0;color:var(--text-primary);"><strong><i class="bi bi-filetype-jpg"></i> Tipo:</strong> <span id="fileType"></span></p>
                </div>

                <div class="alert alert-info" style="margin-top:15px;font-size:0.9rem;">
                    <i class="bi bi-info-circle"></i> <strong>Dicas:</strong>
                    <ul style="text-align:left;margin:10px 0;">
                        <li>Use fotos quadradas para melhor resultado</li>
                        <li>Formatos aceitos: JPG, PNG, WebP, GIF</li>
                        <li>Tamanho m√°ximo: 5MB</li>
                        <li>A imagem ser√° automaticamente otimizada</li>
                    </ul>
                </div>
            </div>
        `,
        width: '550px',
        showCancelButton: true,
        confirmButtonText: '<i class="bi bi-cloud-arrow-up"></i> Enviar Foto',
        cancelButtonText: '<i class="bi bi-x-circle"></i> Cancelar',
        confirmButtonColor: '#7C3AED',
        cancelButtonColor: '#6c757d',
        didOpen: () => {
            const input = document.getElementById('fotoInput');
            const uploadArea = document.getElementById('uploadArea');

            // Click no label
            uploadArea.parentElement.addEventListener('click', () => input.click());

            // Preview e valida√ß√£o ao selecionar
            input.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;

                // Validar imagem
                const validation = validarImagemUpload(file, { maxSizeMB: 5 });

                if (!validation.valid) {
                    Swal.showValidationMessage(validation.error);
                    input.value = '';
                    return;
                }

                // Mostrar preview
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('cameraIcon').style.display = 'none';
                    const preview = document.getElementById('fotoPreview');
                    preview.src = e.target.result;
                    preview.style.display = 'block';

                    // Mostrar info do arquivo
                    document.getElementById('fileName').textContent = validation.fileInfo.name;
                    document.getElementById('fileSize').textContent = validation.fileInfo.size;
                    document.getElementById('fileType').textContent = validation.fileInfo.type;
                    document.getElementById('fileInfo').style.display = 'block';
                };
                reader.readAsDataURL(file);
            });
        },
        preConfirm: () => {
            const fileInput = document.getElementById('fotoInput');
            if (!fileInput.files || fileInput.files.length === 0) {
                Swal.showValidationMessage('Selecione uma imagem primeiro');
                return false;
            }

            // Validar novamente
            const validation = validarImagemUpload(fileInput.files[0], { maxSizeMB: 5 });
            if (!validation.valid) {
                Swal.showValidationMessage(validation.error);
                return false;
            }

            return fileInput.files[0];
        }
    });

    if (file) {
        const formData = new FormData();
        formData.append('foto', file);
        formData.append('profissional_id', profissionalId);

        try {
            // Modal com progress bar
            Swal.fire({
                title: 'Enviando Foto...',
                html: `
                    <div style="padding:20px;">
                        <div style="margin-bottom:15px;">
                            <div style="width:100%;height:30px;background:var(--bg-secondary);border-radius:15px;overflow:hidden;position:relative;">
                                <div id="progressBar" style="width:0%;height:100%;background:linear-gradient(90deg,#7C3AED,#EC4899);transition:width 0.3s;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:0.9rem;"></div>
                            </div>
                        </div>
                        <p id="progressText" style="color:var(--text-secondary);margin-top:10px;">Iniciando upload...</p>
                    </div>
                `,
                allowOutsideClick: false,
                showConfirmButton: false
            });

            // Upload com XMLHttpRequest para ter progress
            const xhr = new XMLHttpRequest();

            xhr.upload.addEventListener('progress', (e) => {
                if (e.lengthComputable) {
                    const percentComplete = Math.round((e.loaded / e.total) * 100);
                    const progressBar = document.getElementById('progressBar');
                    const progressText = document.getElementById('progressText');

                    if (progressBar) {
                        progressBar.style.width = percentComplete + '%';
                        progressBar.textContent = percentComplete + '%';
                    }
                    if (progressText) {
                        progressText.textContent = `Enviando... ${formatarTamanhoArquivo(e.loaded)} de ${formatarTamanhoArquivo(e.total)}`;
                    }
                }
            });

            xhr.addEventListener('load', () => {
                if (xhr.status === 200) {
                    const data = JSON.parse(xhr.responseText);
                    if (data.success) {
                        Swal.fire({
                            icon: 'success',
                            title: 'Foto Enviada!',
                            text: 'A foto do profissional foi atualizada com sucesso',
                            timer: 2000,
                            showConfirmButton: false
                        });
                        loadProfissionais(); // Recarregar lista
                    } else {
                        Swal.fire('Erro', data.message || 'Falha no upload', 'error');
                    }
                } else {
                    Swal.fire('Erro', 'Erro ao enviar foto (HTTP ' + xhr.status + ')', 'error');
                }
            });

            xhr.addEventListener('error', () => {
                Swal.fire('Erro', 'Falha na conex√£o durante o upload', 'error');
            });

            xhr.open('POST', '/api/upload/foto-profissional');
            xhr.setRequestHeader('Accept', 'application/json');
            xhr.withCredentials = true;
            xhr.send(formData);

        } catch (error) {
            console.error('Erro no upload:', error);
            Swal.fire('Erro', 'N√£o foi poss√≠vel enviar a foto', 'error');
        }
    }
}

/**
 * Preview da foto antes do upload
 */
function previewFotoUpload(event) {
    const file = event.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('previewContainer').style.display = 'block';
            document.getElementById('fotoPreview').src = e.target.result;
        };
        reader.readAsDataURL(file);
    }
}

// ====== FUN√á√ïES DE M√öLTIPLOS PROFISSIONAIS EM OR√áAMENTOS ======

// Arrays globais para or√ßamento
let profissionaisVinculados = [];
let profissionalSelecionado = null;

/**
 * Buscar profissionais e assistentes para vincular ao or√ßamento
 */
async function buscarProfissionaisOrcamento() {
    const termo = document.getElementById('buscaProfissionalOrc').value;
    if (termo.length < 2) {
        document.getElementById('profissionalOrcResults').style.display = 'none';
        return;
    }

    try {
        // Buscar profissionais
        const resProf = await fetch('/api/profissionais', {credentials: 'include'});
        const dataProf = await resProf.json();
        
        // Buscar assistentes
        const resAsst = await fetch('/api/assistentes', {credentials: 'include'});
        const dataAsst = await resAsst.json();

        const profissionais = dataProf.profissionais || [];
        const assistentes = dataAsst.assistentes || [];
        
        const todos = [
            ...profissionais.map(p => ({...p, tipo: 'profissional'})),
            ...assistentes.map(a => ({...a, tipo: 'assistente'}))
        ];

        const filtrados = todos.filter(p => 
            p.nome.toLowerCase().includes(termo.toLowerCase())
        );

        const resultsDiv = document.getElementById('profissionalOrcResults');
        if (filtrados.length === 0) {
            resultsDiv.innerHTML = '<div class="autocomplete-item">Nenhum resultado encontrado</div>';
        } else {
            resultsDiv.innerHTML = filtrados.map(p => `
                <div class="autocomplete-item" onclick='selecionarProfissionalOrcamento(${JSON.stringify(p).replace(/'/g, "&apos;")})'>
                    <div style="display:flex;align-items:center;gap:10px;">
                        ${exibirFotoProfissional(p.foto || p.foto_url)}
                        <div>
                            <strong>${p.nome}</strong><br>
                            <small style="color:var(--text-secondary);">
                                ${p.tipo === 'profissional' ? 'üë®‚Äç‚öïÔ∏è Profissional' : 'üë§ Assistente'} | 
                                Comiss√£o: ${p.comissao_perc || 10}%
                            </small>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        resultsDiv.style.display = 'block';
    } catch (error) {
        console.error('Erro ao buscar profissionais:', error);
    }
}

/**
 * Selecionar profissional do autocomplete
 */
function selecionarProfissionalOrcamento(prof) {
    profissionalSelecionado = prof;
    document.getElementById('buscaProfissionalOrc').value = prof.nome;
    document.getElementById('profComissaoPerc').value = prof.comissao_perc || 10;
    document.getElementById('profissionalOrcResults').style.display = 'none';
}

/**
 * Adicionar profissional √† lista de vinculados
 */
function addProfissionalOrcamento() {
    if (!profissionalSelecionado) {
        Swal.fire('Aten√ß√£o', 'Selecione um profissional primeiro', 'warning');
        return;
    }

    const comissaoPerc = parseFloat(document.getElementById('profComissaoPerc').value);
    
    if (isNaN(comissaoPerc) || comissaoPerc < 0 || comissaoPerc > 100) {
        Swal.fire('Aten√ß√£o', 'Comiss√£o deve estar entre 0% e 100%', 'warning');
        return;
    }

    // Verificar se j√° est√° na lista
    if (profissionaisVinculados.find(p => p.id === profissionalSelecionado._id)) {
        Swal.fire('Aten√ß√£o', 'Este profissional j√° est√° vinculado ao or√ßamento', 'warning');
        return;
    }

    profissionaisVinculados.push({
        id: profissionalSelecionado._id,
        nome: profissionalSelecionado.nome,
        tipo: profissionalSelecionado.tipo,
        foto: profissionalSelecionado.foto || profissionalSelecionado.foto_url || '',
        comissao_perc: comissaoPerc
    });

    atualizarTabelaProfissionaisVinculados();
    
    // Limpar campos
    document.getElementById('buscaProfissionalOrc').value = '';
    document.getElementById('profComissaoPerc').value = '10';
    profissionalSelecionado = null;

    Swal.fire({
        icon: 'success',
        title: 'Adicionado!',
        text: `${profissionaisVinculados[profissionaisVinculados.length - 1].nome} foi vinculado ao or√ßamento`,
        timer: 1500,
        showConfirmButton: false
    });
}

/**
 * Atualizar tabela de profissionais vinculados
 */
function atualizarTabelaProfissionaisVinculados() {
    const tbody = document.getElementById('profissionaisVinculadosBody');
    
    if (profissionaisVinculados.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Nenhum profissional vinculado</td></tr>';
        return;
    }

    const totalOrcamento = calcularTotalOrcamentoBase();

    tbody.innerHTML = profissionaisVinculados.map((prof, idx) => {
        const valorComissao = (totalOrcamento * prof.comissao_perc) / 100;
        const fotoHtml = exibirFotoProfissional(prof.foto);

        return `
            <tr>
                <td>${fotoHtml}</td>
                <td><strong>${prof.nome}</strong></td>
                <td><span class="badge ${prof.tipo === 'profissional' ? 'success' : 'neutral'}">
                    ${prof.tipo === 'profissional' ? 'üë®‚Äç‚öïÔ∏è Profissional' : 'üë§ Assistente'}
                </span></td>
                <td>${prof.comissao_perc}%</td>
                <td><strong style="color:var(--success);">R$ ${valorComissao.toFixed(2)}</strong></td>
                <td>
                    <button class="bioma-btn bioma-btn-sm bioma-btn-danger" onclick="removerProfissionalVinculado(${idx})" title="Remover">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>
            </tr>
        `;
    }).join('');
}

/**
 * Remover profissional vinculado
 */
function removerProfissionalVinculado(index) {
    const nome = profissionaisVinculados[index].nome;
    profissionaisVinculados.splice(index, 1);
    atualizarTabelaProfissionaisVinculados();
    
    Swal.fire({
        icon: 'info',
        title: 'Removido',
        text: `${nome} foi desvinculado do or√ßamento`,
        timer: 1500,
        showConfirmButton: false
    });
}

/**
 * Calcular total base do or√ßamento (para comiss√µes)
 */
function calcularTotalOrcamentoBase() {
    const subtotalServicos = orcamento.servicos.reduce((sum, s) => sum + (s.total || 0), 0);
    const subtotalProdutos = orcamento.produtos.reduce((sum, p) => sum + (p.total || 0), 0);
    const descontoGlobal = parseFloat(document.getElementById('descontoGlobal')?.value || 0);
    const subtotal = subtotalServicos + subtotalProdutos;
    return subtotal - (subtotal * descontoGlobal / 100);
}

// ====== FIM NOVAS FUN√á√ïES ======

// Fun√ß√£o removida - duplicada, j√° implementada acima

console.log('%c‚úÖ BIOMA v4.0 COMPLETO - 100% FUNCIONAL','color:#10B981;font-size:18px;font-weight:900');
console.log('%cüî• Todas as fun√ß√µes implementadas sem erros','color:#7C3AED;font-size:14px;font-weight:700');
console.log('%cüìÖ 2025-10-05 22:38 UTC | Dev: @juanmarco1999','color:#6B7280;font-size:12px');

document.addEventListener('click',function(e){
    if(!e.target.closest('#orcCPF')&&!e.target.closest('#cpfResults')){
        const cpfResults = document.getElementById('cpfResults');
        if(cpfResults) cpfResults.style.display='none';
    }
    if(!e.target.closest('#buscaServico')&&!e.target.closest('#servicoResults')){
        const servicoResults = document.getElementById('servicoResults');
        if(servicoResults) servicoResults.style.display='none';
    }
    if(!e.target.closest('#buscaProduto')&&!e.target.closest('#produtoResults')){
        const produtoResults = document.getElementById('produtoResults');
        if(produtoResults) produtoResults.style.display='none';
    }
    if(!e.target.closest('.global-search-container')){
        limparResultadosBuscaGlobal();
    }
});
</script>

<!-- BIOMA ENHANCEMENTS APPENDED -->
<script>
/* === BIOMA v4.0 ‚Äì Enhancements (n√£o altera a estrutura, s√≥ adiciona funcionalidades) ===
   Este bloco conecta o frontend base ao backend (appchatgpt.py):
   - Login/Cadastro/Logout
   - Tema, System Health
   - Dashboard (stats, alertas, √∫ltimos or√ßamentos)
   - Busca Global (sugest√µes/resultados)
   - Clientes (listar, editar, PDF)
   - Profissionais (listar, foto, comiss√µes PDF)
   - Produtos & Servi√ßos (buscar)
   - Estoque (entrada/sa√≠da, alertas, export/PDF/import templates)
   - Or√ßamentos (salvar, PDF/Contrato)
   - Agendamentos (disponibilidade + heatmap)
   - Comunidade (SSE /api/stream)
*/
// ===== Helpers =====
const $ = (s, r=document)=>r.querySelector(s);
const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));

/**
 * Fetch com timeout e retry autom√°tico
 * @param {string} url - URL da requisi√ß√£o
 * @param {object} options - Op√ß√µes do fetch
 * @param {number} timeout - Timeout em ms (padr√£o: 30000 = 30s)
 * @param {number} retries - N√∫mero de tentativas (padr√£o: 1)
 */
async function fetchWithTimeout(url, options = {}, timeout = 30000, retries = 1) {
    for (let attempt = 0; attempt <= retries; attempt++) {
        try {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), timeout);

            const response = await fetch(url, {
                ...options,
                signal: controller.signal
            });

            clearTimeout(timeoutId);

            // Se erro 520, tentar novamente
            if (response.status === 520 && attempt < retries) {
                console.warn(`‚ö†Ô∏è Erro 520 na tentativa ${attempt + 1}/${retries + 1}, tentando novamente...`);
                await new Promise(resolve => setTimeout(resolve, 1000)); // Aguardar 1s antes de retry
                continue;
            }

            return response;
        } catch (error) {
            if (error.name === 'AbortError') {
                console.error(`‚ùå Timeout na requisi√ß√£o: ${url}`);
                if (attempt < retries) {
                    console.warn(`‚ö†Ô∏è Tentativa ${attempt + 1}/${retries + 1} falhou, tentando novamente...`);
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    continue;
                }
                throw new Error('Timeout: O servidor demorou muito para responder');
            }

            if (attempt < retries) {
                console.warn(`‚ö†Ô∏è Erro na tentativa ${attempt + 1}/${retries + 1}: ${error.message}`);
                await new Promise(resolve => setTimeout(resolve, 1000));
                continue;
            }

            throw error;
        }
    }
    throw new Error('Todas as tentativas falharam');
}

const API = {
  async get(u){ const r = await fetch(u,{credentials:'include'}); if(!r.ok) throw new Error(await r.text()); try{ return await r.json(); }catch{ return await r.text(); } },
  async post(u,b){ const r = await fetch(u,{method:'POST',headers:{'Content-Type':'application/json'},credentials:'include',body:JSON.stringify(b)}); if(!r.ok) throw new Error(await r.text()); return r.json(); },
  async put(u,b){ const r = await fetch(u,{method:'PUT',headers:{'Content-Type':'application/json'},credentials:'include',body:JSON.stringify(b)}); if(!r.ok) throw new Error(await r.text()); return r.json(); },
  async del(u){ const r = await fetch(u,{method:'DELETE',credentials:'include'}); if(!r.ok) throw new Error(await r.text()); return r.json(); },
  async upload(u, fd){ const r = await fetch(u,{method:'POST',credentials:'include',body:fd}); if(!r.ok) throw new Error(await r.text()); return r.json(); }
};
function money(v){ if(v==null||isNaN(v)) v=0; return v.toLocaleString('pt-BR',{style:'currency',currency:'BRL'}); }
function fmtDate(d){ try{ return new Date(d).toLocaleString('pt-BR'); }catch{ return d||''; } }
function toast(msg, type='info'){
    if(window.Swal){
        // Usar Swal diretamente para toasts (n√£o window.Swal, pois toasts devem ser n√£o-bloqueantes)
        const Toast = Swal.mixin({
            toast: true,
            position: 'bottom-end',
            timer: 3000,
            timerProgressBar: true,
            showConfirmButton: false,
            didOpen: (toast) => {
                // Garantir que o toast n√£o interfira com cliques
                toast.addEventListener('mouseenter', Swal.stopTimer);
                toast.addEventListener('mouseleave', Swal.resumeTimer);
            },
            didClose: () => {
                // Limpar qualquer backdrop residual de toasts
                document.querySelectorAll('.bioma-dialog').forEach(el => {
                    if(el.classList.contains('swal2-toast-shown')){
                        el.remove();
                    }
                });
            }
        });

        Toast.fire({
            icon: type,
            title: msg
        });
    } else {
        alert(msg);
    }
}
function openFile(url){ window.open(url,'_blank','noopener'); }

/**
 * Helper para bot√µes de refresh manual com anima√ß√£o
 * Busca dados APENAS do MongoDB via API, sem recarregar UI/modais
 *
 * @param {HTMLElement} button - O bot√£o clicado
 * @param {Function} loadFunction - Fun√ß√£o async que busca os dados
 * @param {string} successMessage - Mensagem de sucesso (opcional)
 */
async function refreshData(button, loadFunction, successMessage = 'Dados atualizados') {
    // Prevenir m√∫ltiplos cliques
    if (button.classList.contains('refreshing')) {
        return;
    }

    // Adicionar classe de anima√ß√£o
    button.classList.add('refreshing');

    try {
        // Executar fun√ß√£o de carregamento (busca do MongoDB)
        await loadFunction();

        // Remover classe de loading
        button.classList.remove('refreshing');

        // Adicionar anima√ß√£o de sucesso
        button.classList.add('btn-refresh-success');
        setTimeout(() => {
            button.classList.remove('btn-refresh-success');
        }, 600);

        // Mostrar toast de sucesso
        console.log(`‚úÖ ${successMessage}`);
    } catch (error) {
        // Remover classe de loading em caso de erro
        button.classList.remove('refreshing');
        console.error('‚ùå Erro ao atualizar dados:', error);
        toast('Erro ao atualizar dados', 'error');
    }
}

// ===== Controle de Loading e Debounce (ANTI-LOOP INFINITO) =====
const loadingStates = {}; // Track loading state for each function
const debounceTimers = {}; // Track debounce timers

function isLoading(key) {
    return loadingStates[key] === true;
}

function setLoading(key, state) {
    loadingStates[key] = state;
}

// Debounce helper - prevents excessive API calls
function debounce(key, func, delay = 300) {
    clearTimeout(debounceTimers[key]);
    debounceTimers[key] = setTimeout(func, delay);
}

// v7.1: Auto-refresh ap√≥s opera√ß√µes (CREATE, UPDATE, DELETE)
async function autoRefreshAfterOperation(section) {
    console.log(`üîÑ Auto-refresh ap√≥s opera√ß√£o: ${section}`);

    const refreshMap = {
        'servicos': loadServicosLista,
        'produtos': loadProdutosLista,
        'clientes': loadClientes,
        'profissionais': loadProfissionais,
        'estoque': loadEstoque,
        'dashboard': () => {
            loadMensalResumo();
            loadEstoqueResumo();
        }
    };

    const refreshFunc = refreshMap[section];
    if (refreshFunc) {
        try {
            await refreshFunc();
            console.log(`‚úÖ ${section} atualizado com sucesso`);
        } catch (e) {
            console.error(`‚ùå Erro ao atualizar ${section}:`, e);
        }
    }
}

// Wrap async functions to prevent concurrent calls
async function safeCall(key, asyncFunc) {
    if (isLoading(key)) {
        console.log(`‚è≥ ${key} j√° est√° carregando, ignorando chamada duplicada`);
        return null;
    }
    
    setLoading(key, true);
    try {
        return await asyncFunc();
    } catch (error) {
        console.error(`‚ùå Erro em ${key}:`, error);
        return null;
    } finally {
        setLoading(key, false);
    }
}

// ===== Auth =====
/**
 * SISTEMA DE LOGIN REFATORADO - v4.1
 * - Mais robusto e sem travamentos
 * - Melhor tratamento de erros
 * - Toast notifications em vez de modais pesados
 */
async function handleLogin(e){
    e?.preventDefault?.();

    const btnLogin = document.getElementById('btnLogin');
    const btnContent = btnLogin?.querySelector('.btn-content');
    const btnLoading = btnLogin?.querySelector('.btn-loading');

    try{
        // Valida√ß√£o de campos
        const username = $('#loginUsername')?.value?.trim();
        const password = $('#loginPassword')?.value;
        const rememberMe = $('#rememberMe')?.checked || false;

        if(!username || !password){
            toast('Por favor, preencha todos os campos', 'warning');
            return false;
        }

        // Mostrar loading no bot√£o
        if(btnLogin){
            btnLogin.disabled = true;
            if(btnContent) btnContent.style.display = 'none';
            if(btnLoading) btnLoading.style.display = 'flex';
        }

        // Fazer login
        const r = await API.post('/api/login', {username, password});

        if(r.success){
            // Salvar sess√£o
            sessionStorage.setItem('bioma_user', JSON.stringify(r.user));

            // Lembrar por 7 dias se marcado
            if(rememberMe){
                const expiryDate = new Date();
                expiryDate.setDate(expiryDate.getDate() + 7);
                localStorage.setItem('bioma_remember', JSON.stringify({
                    username: username,
                    password: btoa(password),
                    expiry: expiryDate.toISOString()
                }));
            } else {
                localStorage.removeItem('bioma_remember');
            }

            // Mensagem de sucesso SIMPLES
            console.log('‚úÖ Login bem-sucedido:', r.user.name || r.user.username);
            toast(`Bem-vindo, ${r.user.name || r.user.username}!`, 'success');

            // Redirecionar ap√≥s 500ms
            setTimeout(() => {
                initApp(r.user);
            }, 500);

        } else {
            // Erro de credenciais
            toast(r.message || 'Usu√°rio ou senha incorretos', 'error');

            // Reset bot√£o
            if(btnLogin){
                btnLogin.disabled = false;
                if(btnContent) btnContent.style.display = 'flex';
                if(btnLoading) btnLoading.style.display = 'none';
            }
        }
    }catch(err){
        console.error('‚ùå Login error:', err);
        toast('Erro ao conectar ao servidor', 'error');

        // CRITICAL: Reset bot√£o sempre
        if(btnLogin){
            btnLogin.disabled = false;
            if(btnContent) btnContent.style.display = 'flex';
            if(btnLoading) btnLoading.style.display = 'none';
        }
    }

    return false;
}
async function handleRegister(e){ e?.preventDefault?.(); try{ const data = {name:$('#registerName').value, username:$('#registerUsername').value, email:$('#registerEmail').value, telefone:$('#registerTelefone').value, password:$('#registerPassword').value}; const r = await API.post('/api/register', data); if(r.success){ toast('Conta criada! Fa√ßa login.','success'); $('#loginTab').click(); } else { toast(r.message||'Erro ao registrar','error'); } }catch(err){ toast('Erro ao registrar','error'); } return false; }
/**
 * LOGOUT REFATORADO - v4.1
 * - Mais simples e direto
 * - Sem modais pesados que podem travar
 */
async function doLogout(){
    try{
        // Confirmar com modal simples
        const result = await Swal.fire({
            title: 'Confirmar Logout',
            text: 'Deseja realmente sair do sistema?',
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'Sim, Sair',
            cancelButtonText: 'Cancelar',
            confirmButtonColor: '#EF4444',
            cancelButtonColor: '#6B7280',
            reverseButtons: true
        });

        if(result.isConfirmed){
            // Fazer logout
            await API.post('/api/logout',{});

            // Limpar dados locais
            sessionStorage.removeItem('bioma_user');
            localStorage.removeItem('bioma_remember');

            console.log('‚úÖ Logout bem-sucedido');
            toast('At√© logo!', 'success');

            // Reload ap√≥s 500ms
            setTimeout(() => {
                location.reload();
            }, 500);
        }
    }catch(err){
        console.error('‚ùå Logout error:', err);

        // For√ßar logout mesmo em caso de erro
        sessionStorage.removeItem('bioma_user');
        localStorage.removeItem('bioma_remember');
        location.reload();
    }

}
function switchTab(which){ const login=$('#loginForm'), reg=$('#registerForm'); if(which==='login'){ login.style.display='block'; reg.style.display='none'; $('#loginTab').classList.add('active'); $('#registerTab').classList.remove('active'); } else { login.style.display='none'; reg.style.display='block'; $('#registerTab').classList.add('active'); $('#loginTab').classList.remove('active'); } }

// ===== Theme ===== (Fun√ß√£o principal est√° em linha 4353)
// ===== Navigation ===== [REMOVIDO - usando a fun√ß√£o principal na linha 2829]

// ===== Sub-Tabs Navigation =====
function showSubTab(section, subTab){
  // Remove active de todos os bot√µes da se√ß√£o
  const buttons = document.querySelectorAll(`#section-${section} .sub-tab-btn, #section-${section} .sub-tab`);
  buttons.forEach(btn => btn.classList.remove('active'));
  
  // Remove active de todos os conte√∫dos da se√ß√£o
  const contents = document.querySelectorAll(`#section-${section} .sub-tab-content`);
  contents.forEach(content => content.classList.remove('active'));
  
  // Ativa o bot√£o clicado
  const activeButton = document.querySelector(`#section-${section} [onclick*="'${subTab}'"]`);
  if(activeButton) activeButton.classList.add('active');
  
  // Ativa o conte√∫do correspondente
  const activeContent = document.getElementById(`${section}-${subTab}`);
  if(activeContent) activeContent.classList.add('active');
  
  console.log(`‚úÖ Sub-tab ativada: ${section} > ${subTab}`);
}

// Fun√ß√£o de fallback para estoque (compatibilidade)
function mudarTabEstoque(tab){
  showSubTab('estoque', tab);
}

// ===== Global Search =====
async function buscarGlobal(q){
  const box = $('#globalSearchResults'); if(!box) return;
  if(!q || q.trim().length<2){ box.classList.remove('active'); box.innerHTML=''; return; }
  try{
    let res; try{ res = await API.get('/api/search/suggest?q='+encodeURIComponent(q)); }catch{ res=null; }
    box.innerHTML='';
    if(res && (res.success || res.suggestions)){
      const list = res.suggestions || res.resultados || [];
      const groups = {};
      list.forEach(s=>{ (groups[s.type]=groups[s.type]||[]).push(s); });
      for(const tipo of Object.keys(groups)){
        const sec = document.createElement('div'); sec.className='global-search-section';
        sec.innerHTML = `<h6>${tipo.toUpperCase()}</h6>` + groups[tipo].map(s=>`<div class="global-search-item" data-tipo="${s.type}" data-id="${s.id||''}" onclick="abrirResultado('${s.type}','${s.id||''}')"><strong>${s.text||s.nome||''}</strong><span>${s.type}</span></div>`).join('');
        box.appendChild(sec);
      }
      box.classList.add('active');
    } else {
      box.innerHTML = `<div class="global-search-item"><strong>Pressione Enter para buscar</strong><span>${q}</span></div>`;
      box.classList.add('active');
    }
  }catch(err){ box.classList.remove('active'); }
}
function executarBuscaGlobal(){ const q=$('#globalSearchInput')?.value||''; if(q) buscarGlobal(q); }
async function abrirResultado(tipo,id){
  $('#globalSearchResults').classList.remove('active');
  if(tipo==='cliente'){ goTo('clientes'); }
  if(tipo==='produto'){ goTo('produtos'); }
  if(tipo==='servico'){ goTo('servicos'); }
  if(tipo==='profissional'){ goTo('profissionais'); }
  if(tipo==='orcamento'){ goTo('contratos'); }
}

// ===== [REMOVIDO] Fun√ß√µes duplicadas - usando as vers√µes originais completas com anti-loop =====

// ===== Agendamentos =====
async function heatmapDias(dias=60){
  try{
    const r = await API.get('/api/agendamentos/heatmap?dias='+dias);
    if(!r.success) return;
    const canvas = document.querySelector('#chartHeatmap');
    if(canvas && window.Chart){
      const labels = r.heatmap.map(d=>d.data);
      const a = r.heatmap.map(d=>d.agendamentos);
      const o = r.heatmap.map(d=>d.orcamentos);
      const v = r.heatmap.map(d=>d.vendas);
      const ctx = canvas.getContext('2d');
      new Chart(ctx,{type:'line',data:{labels,datasets:[{label:'Agendamentos',data:a},{label:'Or√ßamentos',data:o},{label:'Vendas',data:v}]}});
    }
  }catch{}
}

// ========== FUN√á√ïES AUXILIARES - AUTOCOMPLETE E MAPA DE CALOR ==========
function bindAutocompletes() {
  console.log('üìù Inicializando autocompletes...');
  // Stub: Autocompletes ser√£o implementados conforme necess√°rio
  // Esta fun√ß√£o evita erro de "is not defined" no initApp
}

// Vari√°vel para prevenir carregamento simult√¢neo do mapa de calor
let mapaCalorLoading = false;

async function carregarMapaCalor(){
    console.log('üóìÔ∏è Carregando mapa de calor...');

    // PROTE√á√ÉO ANTI-CARREGAMENTO INFINITO
    if (mapaCalorLoading) {
        console.warn('‚ö†Ô∏è Mapa de calor j√° est√° carregando, ignorando chamada duplicada');
        return;
    }

    const container = document.getElementById('mapaCalorContainer');

    if(!container){
        console.error('‚ùå Container do mapa de calor n√£o encontrado');
        return;
    }

    try{
        mapaCalorLoading = true;

        // Loading indicator
        container.innerHTML = `
            <div style="text-align: center; padding: 40px;">
                <div class="spinner" style="margin: 0 auto 15px;"></div>
                <p style="color: var(--text-muted);">Carregando mapa de calor...</p>
            </div>
        `;

        const res = await fetch('/api/relatorios/mapa-calor', {
            credentials: 'include',
            signal: AbortSignal.timeout(30000) // Timeout de 30 segundos (queries grandes)
        });

        const data = await res.json();

        if(data.success && data.data && data.data.length > 0){
            // Verificar se h√° dados suficientes (m√≠nimo 7 dias)
            if (data.data.length < 7) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; background: linear-gradient(135deg, rgba(251, 191, 36, 0.1), rgba(245, 158, 11, 0.05)); border-radius: 15px; border: 2px dashed #F59E0B;">
                        <i class="bi bi-exclamation-circle" style="font-size: 3rem; color: #F59E0B;"></i>
                        <p style="margin-top: 15px; font-weight: 700; color: #D97706;">Dados Insuficientes para An√°lise</p>
                        <p style="font-size: 0.9rem; margin-top: 8px; color: var(--text-secondary);">
                            Apenas ${data.data.length} ${data.data.length === 1 ? 'dia' : 'dias'} com atendimentos registrados.
                        </p>
                        <p style="font-size: 0.85rem; margin-top: 5px; color: var(--text-muted);">
                            üí° Realize mais atendimentos para gerar estat√≠sticas confi√°veis (recomendado: m√≠nimo 7 dias)
                        </p>
                    </div>
                `;
                console.log(`‚ö†Ô∏è Dados insuficientes: apenas ${data.data.length} dias`);
                return;
            }

            let html = '';

            data.data.forEach(dia => {
                const atendimentos = dia.total_atendimentos || 0;
                const receita = dia.receita_total || 0;

                // Definir intensidade baseada no n√∫mero de atendimentos
                let intensidade = 1;
                if(atendimentos > 20) intensidade = 5;
                else if(atendimentos > 15) intensidade = 4;
                else if(atendimentos > 10) intensidade = 3;
                else if(atendimentos > 5) intensidade = 2;

                html += `
                    <div class="mapa-dia intensidade-${intensidade}">
                        <div class="mapa-dia-header">${dia.dia_semana || 'N/A'}</div>
                        <div class="mapa-dia-data">${dia.data_formatada || dia.data || 'N/A'}</div>
                        <div class="mapa-dia-valor">${atendimentos}</div>
                        <div style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 8px;">
                            R$ ${receita.toFixed(2)}
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
            console.log(`‚úÖ Mapa de calor carregado com sucesso: ${data.data.length} dias`);
        } else {
            // Nenhum dado dispon√≠vel
            container.innerHTML = `
                <div style="text-align: center; padding: 40px; background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(220, 38, 38, 0.05)); border-radius: 15px; border: 2px dashed #EF4444;">
                    <i class="bi bi-calendar-x" style="font-size: 3rem; color: #EF4444; opacity: 0.7;"></i>
                    <p style="margin-top: 15px; font-weight: 700; color: #DC2626;">Nenhum Dado Dispon√≠vel</p>
                    <p style="font-size: 0.9rem; margin-top: 8px; color: var(--text-secondary);">
                        N√£o h√° atendimentos registrados no per√≠odo analisado (√∫ltimos 90 dias).
                    </p>
                    <p style="font-size: 0.85rem; margin-top: 5px; color: var(--text-muted);">
                        üí° Registre atendimentos e or√ßamentos para visualizar o mapa de calor
                    </p>
                </div>
            `;
            console.log('‚ö†Ô∏è Nenhum dado dispon√≠vel para o mapa de calor');
        }
    }catch(err){
        console.error('‚ùå Erro ao carregar mapa de calor:', err);
        container.innerHTML = `
            <div style="text-align: center; padding: 40px; background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(220, 38, 38, 0.05)); border-radius: 15px; border: 2px solid #EF4444;">
                <i class="bi bi-exclamation-triangle" style="font-size: 3rem; color: #EF4444;"></i>
                <p style="margin-top: 15px; font-weight: 700; color: #DC2626;">Erro ao Carregar Mapa de Calor</p>
                <p style="font-size: 0.9rem; margin-top: 8px; color: var(--text-secondary);">
                    ${err.name === 'TimeoutError' ? 'A requisi√ß√£o demorou muito tempo (timeout)' : err.message || 'Erro desconhecido'}
                </p>
                <p style="font-size: 0.85rem; margin-top: 5px; color: var(--text-muted);">
                    Tente novamente em alguns instantes
                </p>
            </div>
        `;
    } finally {
        // SEMPRE liberar o lock ap√≥s 2 segundos, mesmo se houver erro
        setTimeout(() => {
            mapaCalorLoading = false;
            console.log('üîì Lock do mapa de calor liberado');
        }, 2000);
    }
}

async function carregarDadosFinanceiro() {
  console.log('üí∞ Atualizando dados financeiros...');
  try {
    // Carregar dashboard completo
    const dashRes = await fetch('/api/financeiro/dashboard', {credentials: 'include'});
    const dashData = await dashRes.json();

    if (dashData.success && dashData.financeiro) {
      const fin = dashData.financeiro;

      // Atualizar cards principais
      document.getElementById('financeiroReceitas').textContent = `R$ ${fin.receita_total.toFixed(2)}`;
      document.getElementById('financeiroDespesas').textContent = `R$ ${fin.despesas_total.toFixed(2)}`;
      document.getElementById('financeiroLucro').textContent = `R$ ${fin.lucro_liquido.toFixed(2)}`;

      // Atualizar margem de lucro
      const margemEl = document.getElementById('margemLucro');
      if (margemEl) {
        margemEl.textContent = `${fin.margem_lucro_perc.toFixed(1)}%`;
        margemEl.style.color = fin.margem_lucro_perc > 0 ? 'var(--success)' : 'var(--danger)';
      }
    }

    // Carregar gr√°ficos em paralelo
    carregarFaturamentoMensal();
    carregarServicosMaisVendidos();
    carregarProdutosMaisVendidos();

    // Carrega comiss√µes
    carregarHistoricoComissoes();

    // Toast n√£o bloqueante
    toast('‚úÖ Dados financeiros atualizados', 'success');
  } catch (error) {
    console.error('Erro ao carregar dados financeiros:', error);
    toast('‚ùå Erro ao atualizar dados financeiros', 'error');
  }
}

// Carregar faturamento mensal dos √∫ltimos 12 meses
async function carregarFaturamentoMensal() {
  try {
    console.log('üìä Carregando faturamento mensal...');

    // Verificar se Chart.js est√° dispon√≠vel
    if (!window.Chart) {
      console.error('‚ùå Chart.js n√£o est√° carregado!');
      return;
    }

    // Verificar se canvas existe
    const ctx = document.getElementById('graficoFaturamentoMensal') || document.getElementById('chartFaturamento');
    if (!ctx) {
      console.warn('‚ö†Ô∏è Canvas de faturamento mensal n√£o encontrado (IDs: graficoFaturamentoMensal, chartFaturamento)');
      return;
    }

    // Buscar dados
    const res = await fetch('/api/orcamentos', {credentials: 'include'});

    if (!res.ok) {
      console.error(`‚ùå Erro HTTP ao buscar or√ßamentos: ${res.status}`);
      return;
    }

    const data = await res.json();
    console.log('üì¶ Dados recebidos:', { success: data.success, total_orcamentos: data.orcamentos?.length });

    if (!data.success || !data.orcamentos) {
      console.warn('‚ö†Ô∏è Resposta da API n√£o cont√©m or√ßamentos');
      renderizarGraficoFaturamentoVazio(ctx, 'Nenhum or√ßamento dispon√≠vel');
      return;
    }

    // Filtrar aprovados dos √∫ltimos 12 meses
    const hoje = new Date();
    const doze_meses_atras = new Date(hoje.getFullYear(), hoje.getMonth() - 11, 1);

    const aprovados = data.orcamentos.filter(o => {
      if (!o || o.status !== 'Aprovado') return false;
      try {
        const dataOrc = new Date(o.created_at || o.data_criacao || o.data);
        return dataOrc >= doze_meses_atras && dataOrc <= hoje;
      } catch (err) {
        console.warn('‚ö†Ô∏è Erro ao parsear data do or√ßamento:', o);
        return false;
      }
    });

    console.log(`‚úÖ Or√ßamentos aprovados nos √∫ltimos 12 meses: ${aprovados.length}`);

    // Agrupar por m√™s (√∫ltimos 12 meses)
    const faturamentoPorMes = {};
    const mesesNomes = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
    const labelsFormatados = [];

    for (let i = 11; i >= 0; i--) {
      const mes = new Date(hoje.getFullYear(), hoje.getMonth() - i, 1);
      const mesAno = `${mes.getMonth() + 1}/${mes.getFullYear()}`;
      const mesAnoFormatado = `${mesesNomes[mes.getMonth()]}/${mes.getFullYear().toString().slice(-2)}`;
      faturamentoPorMes[mesAno] = 0;
      labelsFormatados.push(mesAnoFormatado);
    }

    // Acumular valores
    aprovados.forEach(orc => {
      try {
        const data = new Date(orc.created_at || orc.data_criacao || orc.data);
        const mesAno = `${data.getMonth() + 1}/${data.getFullYear()}`;
        if (faturamentoPorMes[mesAno] !== undefined) {
          const valor = parseFloat(orc.total || orc.total_final || orc.valor_total || 0);
          faturamentoPorMes[mesAno] += valor;
        }
      } catch (err) {
        console.warn('‚ö†Ô∏è Erro ao processar or√ßamento:', orc, err);
      }
    });

    const valores = Object.values(faturamentoPorMes);
    const totalFaturamento = valores.reduce((sum, val) => sum + val, 0);
    console.log(`üí∞ Faturamento total (12 meses): R$ ${totalFaturamento.toFixed(2)}`);

    // Destruir gr√°fico anterior se existir
    if (window.chartFaturamentoInstance) {
      window.chartFaturamentoInstance.destroy();
    }

    // Criar gr√°fico
    window.chartFaturamentoInstance = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labelsFormatados,
        datasets: [{
          label: 'Faturamento (R$)',
          data: valores,
          backgroundColor: 'rgba(16, 185, 129, 0.7)',
          borderColor: 'rgba(16, 185, 129, 1)',
          borderWidth: 2,
          borderRadius: 6,
          hoverBackgroundColor: 'rgba(16, 185, 129, 0.9)'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
          legend: {
            display: true,
            labels: {
              font: { size: 12, weight: 'bold' }
            }
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                return `Faturamento: R$ ${context.parsed.y.toFixed(2).replace('.', ',')}`;
              }
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              callback: function(value) {
                return 'R$ ' + value.toLocaleString('pt-BR', {minimumFractionDigits: 0, maximumFractionDigits: 0});
              }
            }
          }
        }
      }
    });

    console.log('‚úÖ Gr√°fico de faturamento mensal renderizado com sucesso');

  } catch (error) {
    console.error('‚ùå Erro ao carregar faturamento mensal:', error);
    const ctx = document.getElementById('graficoFaturamentoMensal') || document.getElementById('chartFaturamento');
    if (ctx) {
      renderizarGraficoFaturamentoVazio(ctx, `Erro ao carregar dados: ${error.message}`);
    }
  }
}

// Fun√ß√£o auxiliar para renderizar gr√°fico vazio com mensagem
function renderizarGraficoFaturamentoVazio(ctx, mensagem) {
  if (window.chartFaturamentoInstance) {
    window.chartFaturamentoInstance.destroy();
  }

  window.chartFaturamentoInstance = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: ['Sem dados'],
      datasets: [{
        label: 'Faturamento (R$)',
        data: [0],
        backgroundColor: 'rgba(156, 163, 175, 0.5)',
        borderColor: 'rgba(156, 163, 175, 1)',
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        legend: { display: false },
        title: {
          display: true,
          text: mensagem,
          color: 'rgba(156, 163, 175, 1)',
          font: { size: 14 }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          max: 100,
          ticks: {
            callback: function(value) {
              return 'R$ ' + value;
            }
          }
        }
      }
    }
  });
}

// Carregar servi√ßos mais vendidos
async function carregarServicosMaisVendidos() {
  try {
    const res = await fetch('/api/orcamentos', {credentials: 'include'});
    const data = await res.json();

    if (!data.success || !data.orcamentos) return;

    const aprovados = data.orcamentos.filter(o => o.status === 'Aprovado');

    // Agrupar servi√ßos
    const servicos = {};
    aprovados.forEach(orc => {
      (orc.servicos || []).forEach(serv => {
        const nome = serv.nome || serv.servico || 'Servi√ßo';
        if (!servicos[nome]) {
          servicos[nome] = { quantidade: 0, valor: 0 };
        }
        servicos[nome].quantidade += 1;
        servicos[nome].valor += serv.valor || serv.preco || 0;
      });
    });

    // Top 5 por quantidade
    const top = Object.entries(servicos)
      .sort((a, b) => b[1].quantidade - a[1].quantidade)
      .slice(0, 5);

    if (top.length === 0) {
      const canvas = document.getElementById('graficoServicosMaisVendidos');
      if (canvas) {
        canvas.style.display = 'none';
        canvas.parentElement.innerHTML = '<p class="text-center text-muted" style="padding: 40px;">Nenhum servi√ßo vendido</p>';
      }
      return;
    }

    const labels = top.map(t => t[0]);
    const valores = top.map(t => t[1].quantidade);

    // Criar gr√°fico
    const ctx = document.getElementById('graficoServicosMaisVendidos');
    if (ctx && window.Chart) {
      if (window.chartServicosInstance) {
        window.chartServicosInstance.destroy();
      }

      window.chartServicosInstance = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: labels,
          datasets: [{
            data: valores,
            backgroundColor: [
              'rgba(124, 58, 237, 0.8)',
              'rgba(236, 72, 153, 0.8)',
              'rgba(245, 158, 11, 0.8)',
              'rgba(16, 185, 129, 0.8)',
              'rgba(59, 130, 246, 0.8)'
            ]
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom'
            }
          }
        }
      });
    }
  } catch (error) {
    console.error('Erro ao carregar servi√ßos mais vendidos:', error);
  }
}

// Carregar produtos mais vendidos
async function carregarProdutosMaisVendidos() {
  try {
    const res = await fetch('/api/estoque/movimentacoes?tipo=saida&per_page=1000', {credentials: 'include'});
    const data = await res.json();

    if (!data.success || !data.movimentacoes || data.movimentacoes.length === 0) {
      const canvas = document.getElementById('graficoProdutosMaisVendidos');
      if (canvas) {
        canvas.style.display = 'none';
        canvas.parentElement.innerHTML = '<p class="text-center text-muted" style="padding: 40px;">Nenhum produto vendido</p>';
      }
      return;
    }

    // Agrupar produtos
    const produtos = {};
    data.movimentacoes.forEach(mov => {
      const nome = mov.produto_nome || 'Produto';
      if (!produtos[nome]) {
        produtos[nome] = 0;
      }
      produtos[nome] += mov.quantidade || 0;
    });

    // Top 5 por quantidade
    const top = Object.entries(produtos)
      .sort((a, b) => b[1] - a[1])
      .slice(0, 5);

    const labels = top.map(t => t[0]);
    const valores = top.map(t => t[1]);

    // Criar gr√°fico
    const ctx = document.getElementById('graficoProdutosMaisVendidos');
    if (ctx && window.Chart) {
      if (window.chartProdutosInstance) {
        window.chartProdutosInstance.destroy();
      }

      window.chartProdutosInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Quantidade Vendida',
            data: valores,
            backgroundColor: 'rgba(236, 72, 153, 0.7)',
            borderColor: 'rgba(236, 72, 153, 1)',
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          indexAxis: 'y',
          plugins: {
            legend: { display: false }
          },
          scales: {
            x: {
              beginAtZero: true,
              ticks: {
                precision: 0
              }
            }
          }
        }
      });
    }
  } catch (error) {
    console.error('Erro ao carregar produtos mais vendidos:', error);
  }
}

async function disponibilidade(profId, dataISO){
  try{
    const r = await API.get(`/api/agendamentos/disponibilidade?profissional_id=${profId}&data=${dataISO}`);
    const box = document.querySelector('#agendaSlots'); if(!box) return;
    box.innerHTML = (r.slots||[]).map(s=>`<span class="community-pill" style="background:${s.status==='livre'?'#DCFCE7':'#fee2e2'};color:${s.status==='livre'?'#166534':'#991B1B'}">${s.hora} ‚Ä¢ ${s.status}</span>`).join('');
  }catch{}
}

// ===== Comunidade (SSE) ===== [Vari√°veis j√° declaradas nas linhas 2689-2692]

function startSSE(){
  // Evitar m√∫ltiplas inst√¢ncias do SSE
  if (sseInstance) {
    return;
  }

  try{
    const ev = new EventSource('/api/stream');
    sseInstance = ev;

    ev.onopen = () => {
      console.log('‚úÖ SSE conectado');
      sseReconnectAttempts = 0; // Reset contador de reconex√£o
    };

    ev.onerror = (error) => {
      // Verificar se √© um erro real ou apenas uma desconex√£o normal
      if (ev.readyState === EventSource.CLOSED) {
        // Conex√£o foi fechada
        ev.close();
        sseInstance = null;

        // Reconectar apenas se n√£o exceder o limite
        if (sseReconnectAttempts < MAX_SSE_RECONNECT) {
          sseReconnectAttempts++;
          const delay = Math.min(2000 * sseReconnectAttempts, 10000); // Backoff linear
          setTimeout(startSSE, delay);
        }
      } else if (ev.readyState === EventSource.CONNECTING) {
        // Tentando reconectar automaticamente
        // N√£o fazer nada, o EventSource est√° tratando
      }
    };
    
    ev.onmessage = (e)=>{
      let data = {}; try{ data = JSON.parse(e.data); }catch{}

      // v7.0: Sistema de Broadcast em Tempo Real
      if (data.type === 'data_changed') {
        const section = data.data?.section;
        const action = data.data?.action;

        if (section) {
          console.log(`üì° SSE Recebido: ${section} (${action})`);
          // Auto-refresh autom√°tico quando outro usu√°rio faz mudan√ßas
          autoRefreshAfterOperation(section).catch(err => {
            console.warn(`‚ö†Ô∏è Erro no auto-refresh SSE de ${section}:`, err);
          });
        }
        return;
      }

      // Heartbeat e conex√£o
      if (data.type === 'heartbeat' || data.type === 'connected') {
        return;
      }

      // Compatibilidade com sistema antigo (channel)
      if(data.channel==='hello') return;
      const feed = document.querySelector('#feedCards') || document.querySelector('#feed');
      if(feed){ const card = document.createElement('div'); card.className='community-card'; card.innerHTML = `<h5>${data.channel||'evento'}</h5><pre style="white-space:pre-wrap">${JSON.stringify(data.payload,null,2)}</pre><small class="text-muted">${new Date().toLocaleString()}</small>`; feed.prepend(card); while(feed.children.length>50){ feed.removeChild(feed.lastChild);} }
      // SOMENTE carregar estoque se a se√ß√£o estiver vis√≠vel
      if(data.channel==='estoque'){
        const estoqueSection = document.getElementById('section-estoque');
        if(estoqueSection && estoqueSection.style.display !== 'none'){
          loadEstoque();
        }
      }
      if(data.channel==='profissionais'){ loadProfissionais(); }
    };
  }catch(e){
    console.error('‚ùå Falha ao iniciar SSE:', e);
    sseInstance = null;
  }
}

// ===== Sistema / Config =====
async function loadSystem(){
  const key = 'loadSystem';
  if (isLoading(key)) {
      console.warn(`‚ö†Ô∏è J√° carregando: ${key}`);
      return;
  }
  setLoading(key, true);

  try{
    const r = await API.get('/api/system/status');
    const el = document.querySelector('#sistemaStatus'); if(!el) return;
    el.innerHTML = `
      <div class="row g-4">
        <div class="col-md-4"><div class="stat-card"><div class="icon"><i class="bi bi-database-check"></i></div><h3>${r.status.mongodb.operational?'OK':'OFF'}</h3><p>MongoDB</p></div></div>
        <div class="col-md-4"><div class="stat-card"><div class="icon"><i class="bi bi-envelope-check"></i></div><h3>${r.status.mailersend.operational?'OK':'OFF'}</h3><p>MailerSend</p></div></div>
        <div class="col-md-4"><div class="stat-card"><div class="icon"><i class="bi bi-hdd-network"></i></div><h3>${r.status.server.version}</h3><p>Vers√£o</p></div></div>
      </div>`;
  }catch{}
  finally {
      setTimeout(() => setLoading(key, false), 250);
  }
}

// Fun√ß√£o para limpar banco de dados
async function limparBancoDados() {
    // Primeira confirma√ß√£o
    const result1 = await Swal.fire({
        icon: 'warning',
        title: '‚ö†Ô∏è ATEN√á√ÉO CR√çTICA!',
        html: `
            <div style="text-align: left; padding: 20px;">
                <p style="font-size: 1.1rem; font-weight: 600; margin-bottom: 15px;">
                    Voc√™ est√° prestes a <span style="color: #EF4444;">APAGAR TODOS OS DADOS</span> do sistema!
                </p>
                <p style="margin-bottom: 10px;">Isso incluir√° a exclus√£o permanente de:</p>
                <ul style="margin-left: 20px; color: var(--text-secondary);">
                    <li>Todos os clientes cadastrados</li>
                    <li>Todos os profissionais e assistentes</li>
                    <li>Todos os servi√ßos e produtos</li>
                    <li>Todos os or√ßamentos e contratos</li>
                    <li>Todos os agendamentos</li>
                    <li>Todo o hist√≥rico de movimenta√ß√µes de estoque</li>
                    <li>Todas as comiss√µes e despesas</li>
                    <li>Toda a fila de atendimento</li>
                </ul>
                <div style="margin-top: 20px; padding: 15px; background: rgba(239, 68, 68, 0.1); border-left: 4px solid #EF4444; border-radius: 4px;">
                    <strong style="color: #EF4444;">‚ö†Ô∏è ESTA A√á√ÉO N√ÉO PODE SER DESFEITA!</strong>
                    <p style="margin-top: 10px; margin-bottom: 0;">Os dados de usu√°rios e auditoria ser√£o mantidos para fins de seguran√ßa.</p>
                </div>
            </div>
        `,
        showCancelButton: true,
        confirmButtonText: 'Continuar',
        cancelButtonText: 'Cancelar',
        confirmButtonColor: '#EF4444',
        allowOutsideClick: false
    });

    if (!result1.isConfirmed) {
        return;
    }

    // Segunda confirma√ß√£o com c√≥digo
    const result2 = await Swal.fire({
        icon: 'error',
        title: 'üîê Confirma√ß√£o de Seguran√ßa',
        html: `
            <div style="text-align: left; padding: 20px;">
                <p style="font-size: 1.1rem; margin-bottom: 15px;">
                    Para prosseguir, digite o c√≥digo de confirma√ß√£o:
                </p>
                <div style="text-align: center; margin: 20px 0;">
                    <code style="background: #f0f0f0; padding: 10px 20px; font-size: 1.3rem; border-radius: 8px; font-weight: 700; color: #EF4444;">
                        LIMPAR_TUDO_2025
                    </code>
                </div>
                <input type="text" id="codigo-confirmacao" class="swal2-input" placeholder="Digite o c√≥digo aqui" style="margin-top: 20px;">
            </div>
        `,
        showCancelButton: true,
        confirmButtonText: 'LIMPAR BANCO DE DADOS',
        cancelButtonText: 'Cancelar',
        confirmButtonColor: '#EF4444',
        allowOutsideClick: false,
        preConfirm: () => {
            const codigo = document.getElementById('codigo-confirmacao').value;
            if (codigo !== 'LIMPAR_TUDO_2025') {
                Swal.showValidationMessage('C√≥digo de confirma√ß√£o incorreto!');
                return false;
            }
            return codigo;
        }
    });

    if (!result2.isConfirmed) {
        return;
    }

    // Mostrar loading
    Swal.fire({
        title: 'Limpando Banco de Dados...',
        html: 'Por favor, aguarde. Esta opera√ß√£o pode levar alguns segundos.',
        allowOutsideClick: false,
        allowEscapeKey: false,
        showConfirmButton: false,
        willOpen: () => {
            Swal.showLoading();
        }
    });

    try {
        const res = await fetch('/api/sistema/limpar-banco', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({
                codigo_confirmacao: result2.value
            })
        });

        const data = await res.json();

        Swal.close();

        if (data.success) {
            // Mostrar estat√≠sticas de limpeza
            let statsHTML = '<div style="text-align: left; padding: 15px;">';
            statsHTML += '<p style="margin-bottom: 15px;">Registros removidos por cole√ß√£o:</p>';
            statsHTML += '<ul style="margin-left: 20px;">';

            for (const [colecao, info] of Object.entries(data.stats || {})) {
                statsHTML += `<li><strong>${colecao}:</strong> ${info.deletados} registros</li>`;
            }

            statsHTML += '</ul></div>';

            await Swal.fire({
                icon: 'success',
                title: '‚úÖ Banco de Dados Limpo!',
                html: statsHTML,
                confirmButtonText: 'OK'
            });

            // Recarregar a p√°gina para atualizar todas as se√ß√µes
            location.reload();
        } else {
            throw new Error(data.message || 'Erro ao limpar banco de dados');
        }
    } catch (e) {
        console.error('Erro ao limpar banco:', e);
        Swal.fire({
            icon: 'error',
            title: 'Erro',
            text: e.message || 'N√£o foi poss√≠vel limpar o banco de dados.',
            confirmButtonText: 'OK'
        });
    }
}

async function uploadLogo(inputSel='#logoArquivo'){
  const f = document.querySelector(inputSel)?.files?.[0]; if(!f) return toast('Selecione um arquivo','warning');
  const fd = new FormData(); fd.append('file', f);
  try{
    const up = await API.upload('/api/upload/imagem', fd);
    const filename = up.filename || up.name || up.id || up.path || up.url?.split('/').pop();
    const logo_url = up.url || '/api/imagem/'+filename;
    await API.post('/api/config', { logo_url });
    if(document.querySelector('#authLogoCustom')){ document.querySelector('#authLogoCustom').src = logo_url; document.querySelector('#authLogoCustom').style.display='block'; }
    toast('Logo atualizado','success');
  }catch{ toast('Falha no upload','error'); }
}
window.uploadLogo = uploadLogo;

// ===== Init =====
async function initApp(user=null){
  // Evitar m√∫ltiplas inicializa√ß√µes
  if (appInitialized) {
    console.log('‚è≥ App j√° foi inicializado');
    return;
  }
  appInitialized = true;
  
  console.log('üöÄ Inicializando aplicativo...');

  // CRITICAL FIX: Load theme BEFORE showing app to prevent dark mode flash
  try{
    const cu = await API.get('/api/current-user');
    const theme = (cu.success && cu.user && cu.user.theme) ? cu.user.theme : 'light';
    document.documentElement.setAttribute('data-theme', theme);
    console.log(`üé® Tema do usu√°rio aplicado: ${theme}`);
  }catch(e){
    console.error('Erro ao carregar tema:', e);
    document.documentElement.setAttribute('data-theme', 'light'); // Fallback to light
  }

  // NOW hide auth and show app AFTER theme is set
  document.querySelector('#authScreen').style.display='none';
  document.querySelector('#app').style.display='block';
  
  // CARREGAR LOGO IMEDIATAMENTE (antes de tudo)
  await loadConfiguracoes(true); // force=true para garantir carregamento

  // INICIAR SCANNER DE C√ìDIGO DE BARRAS
  iniciarScannerBarcode();

  // ========== REFRESH GERAL INICIAL (antes do auto-refresh) ==========
  console.log('üîÑ Executando REFRESH GERAL de todos os dados...');

  // Carregar TODAS as se√ß√µes em paralelo para inicializa√ß√£o r√°pida
  Promise.allSettled([
    loadDashboard().catch(e => console.error('‚ùå Erro loadDashboard:', e)),
    loadClientes().catch(e => console.error('‚ùå Erro loadClientes:', e)),
    loadProfissionais().catch(e => console.error('‚ùå Erro loadProfissionais:', e)),
    loadServicosLista().catch(e => console.error('‚ùå Erro loadServicosLista:', e)),
    loadEstoque().catch(e => console.error('‚ùå Erro loadEstoque:', e)), // Inclu√≠do: carregar estoque no in√≠cio
    loadContratos().catch(e => console.error('‚ùå Erro loadContratos:', e)),
    carregarMapaCalor().catch(e => console.error('‚ùå Erro carregarMapaCalor:', e)),
    loadFila(true).catch(e => console.error('‚ùå Erro loadFila:', e)), // silent=true
    loadSystem().catch(e => console.error('‚ùå Erro loadSystem:', e))
  ]).then((results) => {
    const failed = results.filter(r => r.status === 'rejected');
    if (failed.length > 0) {
      console.warn(`‚ö†Ô∏è ${failed.length} fun√ß√£o(√µes) falharam no carregamento inicial`);
    }
    console.log('‚úÖ Carregamento inicial completo');
    console.log('üí° Use os bot√µes de refresh para atualizar dados manualmente');
  });

  // ========== AUTO-REFRESH DE UI COMPLETAMENTE REMOVIDO ==========
  //
  // ‚ö†Ô∏è IMPORTANTE: Auto-refresh autom√°tico de UI foi REMOVIDO para n√£o interferir com modais
  //
  // Os dados s√£o atualizados via:
  // 1. SSE (Server-Sent Events) para notifica√ß√µes em tempo real
  // 2. Bot√µes de refresh manual em cada se√ß√£o
  // 3. Recarregamento ap√≥s opera√ß√µes CRUD (criar/editar/deletar)
  //

  console.log('‚úÖ Sistema de notifica√ß√µes em tempo real ativo (SSE)');
  console.log('‚ö†Ô∏è Auto-refresh autom√°tico de UI foi DESABILITADO');
  console.log('üí° Use os bot√µes de refresh em cada se√ß√£o para atualizar manualmente');

  // Fun√ß√µes para mostrar/esconder indicador de auto-refresh
  function showAutoRefreshIndicator() {
    const indicator = document.getElementById('auto-refresh-indicator');
    if (indicator) {
      indicator.classList.add('show');
      indicator.innerHTML = '<div class="spinner-small"></div> Atualizando dados...';
    }
  }

  function hideAutoRefreshIndicator() {
    const indicator = document.getElementById('auto-refresh-indicator');
    if (indicator) {
      indicator.classList.remove('show');
    }
  }

  // Iniciar features que n√£o dependem de dados
  bindAutocompletes();
  heatmapDias(60);
  startSSE();

  // Pausar SSE quando p√°gina fica inativa (otimiza√ß√£o de recursos)
  document.addEventListener('visibilitychange', () => {
    if (document.hidden) {
      console.log('‚è∏Ô∏è  P√°gina inativa - pausando SSE');
      if (sseInstance) {
        sseInstance.close();
        sseInstance = null;
      }
    } else {
      console.log('‚ñ∂Ô∏è  P√°gina ativa - reconectando SSE');
      // Aguardar 1 segundo antes de reconectar (evitar m√∫ltiplas conex√µes)
      setTimeout(() => {
        if (!sseInstance) {
          startSSE();
        }
      }, 1000);
    }
  });
}

// ========== SISTEMA DE COMISS√ïES - FASE 3 ==========
let graficoComissoesInstance = null;

async function carregarProfissionaisFiltro() {
    try {
        const [resProfissionais, resAssistentes] = await Promise.all([
            fetch('/api/profissionais', {credentials: 'include'}),
            fetch('/api/assistentes', {credentials: 'include'})
        ]);

        const profissionais = (await resProfissionais.json()).profissionais || [];
        const assistentes = (await resAssistentes.json()).assistentes || [];

        const select = document.getElementById('filtroComissoesProfissional');
        if (!select) return;
        
        select.innerHTML = '<option value="">Selecione um profissional</option>';

        profissionais.forEach(p => {
            const option = document.createElement('option');
            option.value = p._id;
            option.textContent = `${p.nome} (Profissional)`;
            select.appendChild(option);
        });

        assistentes.forEach(a => {
            const option = document.createElement('option');
            option.value = a._id;
            option.textContent = `${a.nome} (Assistente)`;
            select.appendChild(option);
        });
    } catch (error) {
        console.error('Erro ao carregar profissionais:', error);
    }
}

async function carregarComissoesProfissional() {
    const profissionalId = document.getElementById('filtroComissoesProfissional')?.value;

    if (!profissionalId) {
        Swal.fire('Aten√ß√£o', 'Selecione um profissional', 'warning');
        return;
    }

    const dataInicio = document.getElementById('filtroComissoesDataInicio')?.value || '';
    const dataFim = document.getElementById('filtroComissoesDataFim')?.value || '';
    const status = document.getElementById('filtroComissoesStatus')?.value || '';

    const params = new URLSearchParams();
    if (dataInicio) params.append('data_inicio', dataInicio + 'T00:00:00');
    if (dataFim) params.append('data_fim', dataFim + 'T23:59:59');
    if (status) params.append('status', status);

    // Mostrar loading na tabela
    const tbody = document.getElementById('tabelaHistoricoComissoes');
    if (tbody) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Carregando...</span></div></td></tr>';
    }

    try {
        const res = await fetch(`/api/profissionais/${profissionalId}/comissoes?${params}`, {
            credentials: 'include'
        });

        if (!res.ok) {
            const errorText = await res.text();
            console.error('‚ùå Erro HTTP ao carregar comiss√µes:', res.status, errorText);
            throw new Error(`Erro ${res.status}: ${errorText || 'Falha ao carregar comiss√µes'}`);
        }

        const responseData = await res.json();
        console.log('üìä Dados recebidos do backend:', responseData);

        // Verificar estrutura de dados e aplicar fallbacks
        const data = responseData.data || responseData;
        const estatisticas = data.estatisticas || {};
        const historico = data.historico || data.comissoes || [];

        // Valores com fallback
        const totalComissoes = estatisticas.total_comissoes ?? 0;
        const totalOrcamentos = estatisticas.total_orcamentos ?? 0;
        const mediaComissao = estatisticas.media_comissao ?? 0;
        const comissoesPorMes = estatisticas.comissoes_por_mes || [];

        // Atualizar estat√≠sticas
        const statTotalComissoesElem = document.getElementById('statTotalComissoes');
        const statTotalOrcamentosElem = document.getElementById('statTotalOrcamentos');
        const statMediaComissaoElem = document.getElementById('statMediaComissao');

        if (statTotalComissoesElem) {
            statTotalComissoesElem.textContent = `R$ ${totalComissoes.toFixed(2).replace('.', ',')}`;
        }
        if (statTotalOrcamentosElem) {
            statTotalOrcamentosElem.textContent = totalOrcamentos;
        }
        if (statMediaComissaoElem) {
            statMediaComissaoElem.textContent = `R$ ${mediaComissao.toFixed(2).replace('.', ',')}`;
        }

        // Mostrar/ocultar se√ß√µes
        const cardsElem = document.getElementById('comissoesEstatisticasCards');
        const msgInicialElem = document.getElementById('comissoesMensagemInicial');

        if (cardsElem) cardsElem.style.display = 'block';
        if (msgInicialElem) msgInicialElem.style.display = 'none';

        // Renderizar gr√°fico e tabela
        renderizarGraficoComissoes(comissoesPorMes);
        renderizarTabelaHistoricoComissoes(historico, totalComissoes);

        console.log('‚úÖ Comiss√µes carregadas com sucesso:', {
            total_comissoes: totalComissoes,
            total_orcamentos: totalOrcamentos,
            historico_length: historico.length
        });

    } catch (error) {
        console.error('‚ùå Erro ao carregar comiss√µes:', error);

        // Mostrar mensagem de erro amig√°vel na tabela
        if (tbody) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center text-danger">
                        <i class="bi bi-exclamation-triangle"></i>
                        <strong>Erro ao carregar comiss√µes</strong><br>
                        <small>${error.message || 'Verifique sua conex√£o ou contate o suporte'}</small>
                    </td>
                </tr>
            `;
        }

        Swal.fire({
            icon: 'error',
            title: 'Erro ao Carregar Comiss√µes',
            html: `<p>${error.message || 'N√£o foi poss√≠vel carregar as comiss√µes'}</p>
                   <small class="text-muted">Verifique o console para mais detalhes</small>`,
            confirmButtonText: 'OK'
        });
    }
}

function renderizarGraficoComissoes(comissoesPorMes) {
    const ctx = document.getElementById('graficoComissoesMensal');
    if (!ctx) {
        console.warn('‚ö†Ô∏è Canvas graficoComissoesMensal n√£o encontrado');
        return;
    }

    // Destruir gr√°fico anterior se existir
    if (graficoComissoesInstance) {
        graficoComissoesInstance.destroy();
    }

    // Validar dados de entrada
    if (!comissoesPorMes || typeof comissoesPorMes !== 'object' || Object.keys(comissoesPorMes).length === 0) {
        console.warn('‚ö†Ô∏è Dados de comiss√µes por m√™s vazios ou inv√°lidos');
        // Renderizar gr√°fico vazio com mensagem
        graficoComissoesInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: ['Sem dados'],
                datasets: [{
                    label: 'Valor Total (R$)',
                    data: [0],
                    borderColor: 'rgb(124, 58, 237)',
                    backgroundColor: 'rgba(124, 58, 237, 0.1)',
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Nenhum dado dispon√≠vel para o per√≠odo selecionado'
                    }
                }
            }
        });
        return;
    }

    try {
        const meses = Object.keys(comissoesPorMes).sort();
        const valores = meses.map(mes => {
            const dadosMes = comissoesPorMes[mes];
            return dadosMes?.valor ?? dadosMes?.total ?? 0;
        });
        const quantidades = meses.map(mes => {
            const dadosMes = comissoesPorMes[mes];
            return dadosMes?.quantidade ?? dadosMes?.count ?? 0;
        });

        const labels = meses.map(mes => {
            try {
                const [ano, mesNum] = mes.split('-');
                const mesesNomes = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
                const mesIndex = parseInt(mesNum) - 1;
                return mesesNomes[mesIndex] ? `${mesesNomes[mesIndex]}/${ano}` : mes;
            } catch (err) {
                console.warn('‚ö†Ô∏è Erro ao formatar label do m√™s:', mes, err);
                return mes;
            }
        });

    graficoComissoesInstance = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Valor Total (R$)',
                    data: valores,
                    borderColor: 'rgb(124, 58, 237)',
                    backgroundColor: 'rgba(124, 58, 237, 0.1)',
                    tension: 0.4,
                    fill: true,
                    yAxisID: 'y'
                },
                {
                    label: 'Quantidade',
                    data: quantidades,
                    borderColor: 'rgb(236, 72, 153)',
                    backgroundColor: 'rgba(236, 72, 153, 0.1)',
                    tension: 0.4,
                    fill: true,
                    yAxisID: 'y1'
                }
            ]
        },
        options: {
            responsive: true,
            interaction: {
                mode: 'index',
                intersect: false
            },
            scales: {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: {
                        display: true,
                        text: 'Valor (R$)'
                    }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    title: {
                        display: true,
                        text: 'Quantidade'
                    },
                    grid: {
                        drawOnChartArea: false
                    }
                }
            }
        }
    });

    console.log('‚úÖ Gr√°fico de comiss√µes renderizado com sucesso');

    } catch (error) {
        console.error('‚ùå Erro ao renderizar gr√°fico de comiss√µes:', error);
        // Renderizar gr√°fico vazio em caso de erro
        graficoComissoesInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: ['Erro'],
                datasets: [{
                    label: 'Dados n√£o dispon√≠veis',
                    data: [0],
                    borderColor: 'rgb(239, 68, 68)',
                    backgroundColor: 'rgba(239, 68, 68, 0.1)',
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Erro ao carregar dados do gr√°fico',
                        color: 'rgb(239, 68, 68)'
                    }
                }
            }
        });
    }
}

function renderizarTabelaHistoricoComissoes(historico, totalComissoes) {
    const tbody = document.getElementById('tabelaHistoricoComissoes');
    if (!tbody) return;

    if (!historico || historico.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted"><i class="bi bi-inbox"></i> Nenhuma comiss√£o encontrada para os filtros selecionados</td></tr>';
        const tfoot = document.getElementById('tfootComissoes');
        if (tfoot) tfoot.style.display = 'none';
        return;
    }

    tbody.innerHTML = historico.map((comissao, index) => {
        try {
            // Fallbacks para todos os campos
            const dataRegistro = comissao.data_registro || comissao.data || comissao.created_at;
            const data = dataRegistro ? new Date(dataRegistro).toLocaleDateString('pt-BR') : 'Data n√£o dispon√≠vel';

            const valorBase = (comissao.valor_base ?? comissao.valorBase ?? 0);
            const valorBaseFormatado = typeof valorBase === 'number' ? valorBase.toFixed(2).replace('.', ',') : '0,00';

            const comissaoValor = (comissao.comissao_valor ?? comissao.comissaoValor ?? comissao.valor ?? 0);
            const comissaoValorFormatado = typeof comissaoValor === 'number' ? comissaoValor.toFixed(2).replace('.', ',') : '0,00';

            const comissaoPerc = (comissao.comissao_perc ?? comissao.percentual ?? comissao.porcentagem ?? 0);
            const comissaoPercFormatado = typeof comissaoPerc === 'number' ? comissaoPerc : parseFloat(comissaoPerc) || 0;

            const orcamentoId = comissao.orcamento_id || comissao.orcamentoId || `OR√á-${index + 1}`;
            const orcamentoIdDisplay = typeof orcamentoId === 'string' && orcamentoId.length > 6
                ? orcamentoId.slice(-6)
                : orcamentoId;

            const statusOrcamento = comissao.status_orcamento || comissao.statusOrcamento || comissao.status || 'Desconhecido';
            const badgeStatus =
                statusOrcamento === 'Aprovado' || statusOrcamento === 'aprovado' ? 'success' :
                statusOrcamento === 'Pendente' || statusOrcamento === 'pendente' ? 'warning' :
                statusOrcamento === 'Cancelado' || statusOrcamento === 'cancelado' ? 'danger' : 'secondary';

            const tipo = comissao.tipo || comissao.tipo_comissao || 'profissional';
            const badgeTipo = tipo === 'profissional' ? 'primary' : tipo === 'indicacao' ? 'info' : 'secondary';

            return `
                <tr>
                    <td>${data}</td>
                    <td>#${orcamentoIdDisplay}</td>
                    <td><span class="badge ${badgeTipo}">${tipo}</span></td>
                    <td>R$ ${valorBaseFormatado}</td>
                    <td>${comissaoPercFormatado}%</td>
                    <td><strong>R$ ${comissaoValorFormatado}</strong></td>
                    <td><span class="badge ${badgeStatus}">${statusOrcamento}</span></td>
                </tr>
            `;
        } catch (err) {
            console.error('‚ùå Erro ao renderizar comiss√£o:', err, comissao);
            return `
                <tr>
                    <td colspan="7" class="text-center text-warning">
                        <i class="bi bi-exclamation-triangle"></i> Erro ao exibir comiss√£o #${index + 1}
                    </td>
                </tr>
            `;
        }
    }).join('');

    // Atualizar rodap√© com total
    const footerElem = document.getElementById('totalComissoesFooter');
    const tfootElem = document.getElementById('tfootComissoes');

    const totalFormatado = typeof totalComissoes === 'number'
        ? totalComissoes.toFixed(2).replace('.', ',')
        : '0,00';

    if (footerElem) footerElem.textContent = `R$ ${totalFormatado}`;
    if (tfootElem) tfootElem.style.display = '';
}

function limparFiltrosComissoes() {
    const els = {
        profissional: document.getElementById('filtroComissoesProfissional'),
        dataInicio: document.getElementById('filtroComissoesDataInicio'),
        dataFim: document.getElementById('filtroComissoesDataFim'),
        status: document.getElementById('filtroComissoesStatus')
    };
    
    if (els.profissional) els.profissional.value = '';
    if (els.dataInicio) els.dataInicio.value = '';
    if (els.dataFim) els.dataFim.value = '';
    if (els.status) els.status.value = '';
    
    const cards = document.getElementById('comissoesEstatisticasCards');
    const msg = document.getElementById('comissoesMensagemInicial');
    if (cards) cards.style.display = 'none';
    if (msg) msg.style.display = 'block';
    
    const tbody = document.getElementById('tabelaHistoricoComissoes');
    if (tbody) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">Selecione um profissional nos filtros acima</td></tr>';
    }
}

async function exportarComissoesExcel() {
    const profissionalId = document.getElementById('filtroComissoesProfissional')?.value;

    if (!profissionalId) {
        Swal.fire('Aten√ß√£o', 'Selecione um profissional primeiro', 'warning');
        return;
    }

    try {
        // Buscar dados do profissional
        const res = await fetch(`/api/profissionais/${profissionalId}/comissoes`, {credentials: 'include'});
        const data = await res.json();

        if (!data.success || !data.historico || data.historico.length === 0) {
            Swal.fire('Aten√ß√£o', 'Nenhuma comiss√£o dispon√≠vel para exportar', 'info');
            return;
        }

        const profissionalNome = document.getElementById('filtroComissoesProfissional')
            ?.selectedOptions[0]?.textContent || 'Profissional';

        const columns = [
            { key: 'data_registro', label: 'Data', type: 'date', width: 12 },
            { key: 'orcamento_numero', label: 'Or√ßamento', width: 12 },
            { key: 'tipo', label: 'Tipo', width: 15 },
            { key: 'valor_base', label: 'Valor Base', type: 'currency', width: 15 },
            { key: 'comissao_percentual', label: 'Comiss√£o %', width: 12 },
            { key: 'comissao_valor', label: 'Valor Comiss√£o', type: 'currency', width: 15 },
            { key: 'status', label: 'Status', width: 12 }
        ];

        await ExportLibrary.toExcel(data.historico, columns, `comissoes_${profissionalNome.replace(/\s/g, '_')}`, 'Comiss√µes');
    } catch (error) {
        console.error('Erro ao exportar comiss√µes:', error);
        Swal.fire('Erro', 'N√£o foi poss√≠vel exportar as comiss√µes', 'error');
    }
}

async function carregarRankingProfissionais() {
    try {
        const [resProfissionais, resAssistentes] = await Promise.all([
            fetch('/api/profissionais', {credentials: 'include'}),
            fetch('/api/assistentes', {credentials: 'include'})
        ]);

        const profissionais = (await resProfissionais.json()).profissionais || [];
        const assistentes = (await resAssistentes.json()).assistentes || [];

        const todos = [
            ...profissionais.map(p => ({...p, tipo: 'profissional'})),
            ...assistentes.map(a => ({...a, tipo: 'assistente'}))
        ];

        const promises = todos.map(pessoa => 
            fetch(`/api/profissionais/${pessoa._id}/comissoes`, {credentials: 'include'})
                .then(r => r.json())
                .then(data => ({
                    ...pessoa,
                    total_comissoes: data.data.estatisticas.total_comissoes,
                    total_orcamentos: data.data.estatisticas.total_orcamentos,
                    media_comissao: data.data.estatisticas.media_comissao
                }))
                .catch(() => ({
                    ...pessoa,
                    total_comissoes: 0,
                    total_orcamentos: 0,
                    media_comissao: 0
                }))
        );

        const ranking = await Promise.all(promises);
        ranking.sort((a, b) => b.total_comissoes - a.total_comissoes);

        const tbody = document.getElementById('rankingProfissionaisBody');
        if (!tbody) return;
        
        tbody.innerHTML = ranking.map((pessoa, index) => {
            const foto = pessoa.foto ? 
                `<img src="${pessoa.foto}" alt="${pessoa.nome}" style="width:40px;height:40px;border-radius:50%;object-fit:cover;">` :
                `<div style="width:40px;height:40px;border-radius:50%;background:linear-gradient(135deg,#7C3AED,#EC4899);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700">${pessoa.nome[0]}</div>`;

            const badgeTipo = pessoa.tipo === 'profissional' ? 'primary' : 'info';
            const medalha = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : '';

            return `
                <tr>
                    <td><strong>${index + 1}¬∫ ${medalha}</strong></td>
                    <td>${foto}</td>
                    <td><strong>${pessoa.nome}</strong></td>
                    <td><span class="badge ${badgeTipo}">${pessoa.tipo}</span></td>
                    <td><strong style="color:var(--success)">R$ ${pessoa.total_comissoes.toFixed(2).replace('.', ',')}</strong></td>
                    <td>${pessoa.total_orcamentos}</td>
                    <td>R$ ${pessoa.media_comissao.toFixed(2).replace('.', ',')}</td>
                </tr>
            `;
        }).join('');

    } catch (error) {
        console.error('Erro ao carregar ranking:', error);
        const tbody = document.getElementById('rankingProfissionaisBody');
        if (tbody) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center text-danger">Erro ao carregar ranking</td></tr>';
        }
    }
}

// Modificar showSubTab existente para carregar dados
const originalShowSubTab = typeof showSubTab !== 'undefined' ? showSubTab : null;
function showSubTab(section, tab) {
    // Chamar fun√ß√£o original se existir
    if (originalShowSubTab && originalShowSubTab !== showSubTab) {
        originalShowSubTab(section, tab);
    } else {
        // Implementa√ß√£o padr√£o
        const sectionElement = document.getElementById(`section-${section}`);
        if (!sectionElement) return;
        
        // Desativar todos os bot√µes e conte√∫dos
        sectionElement.querySelectorAll('.sub-tab-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        sectionElement.querySelectorAll('.sub-tab-content').forEach(content => {
            content.classList.remove('active');
        });

        // Ativar bot√£o clicado
        const clickedBtn = Array.from(sectionElement.querySelectorAll('.sub-tab-btn'))
            .find(btn => btn.onclick.toString().includes(`'${tab}'`));
        if (clickedBtn) clickedBtn.classList.add('active');

        // Ativar conte√∫do correspondente
        const tabContent = document.getElementById(`${section}-${tab}`);
        if (tabContent) tabContent.classList.add('active');
    }
    
    // Carregar dados espec√≠ficos da tab
    if (section === 'profissionais') {
        if (tab === 'comissoes') {
            carregarProfissionaisFiltro();
        } else if (tab === 'estatisticas') {
            carregarRankingProfissionais();
        }
    }
}
// ========== FIM SISTEMA DE COMISS√ïES ==========

// ========== FUN√á√ÉO DE FORMATA√á√ÉO DE CPF ====================
function formatCPF(cpf) {
    // Remove todos os caracteres n√£o num√©ricos
    cpf = cpf.replace(/\D/g, '');

    // Limita a 11 d√≠gitos
    cpf = cpf.substring(0, 11);

    // Aplica a m√°scara XXX.XXX.XXX-XX
    if (cpf.length <= 3) {
        return cpf;
    } else if (cpf.length <= 6) {
        return cpf.substring(0, 3) + '.' + cpf.substring(3);
    } else if (cpf.length <= 9) {
        return cpf.substring(0, 3) + '.' + cpf.substring(3, 6) + '.' + cpf.substring(6);
    } else {
        return cpf.substring(0, 3) + '.' + cpf.substring(3, 6) + '.' + cpf.substring(6, 9) + '-' + cpf.substring(9);
    }
}

// Aplicar formata√ß√£o automaticamente em campos de CPF
function applyCPFFormatting(inputElement) {
    inputElement.addEventListener('input', function() {
        const cursorPos = this.selectionStart;
        const oldLength = this.value.length;
        const unformattedValue = this.value.replace(/\D/g, '');

        this.value = formatCPF(this.value);

        // Ajustar posi√ß√£o do cursor
        const newLength = this.value.length;
        const diff = newLength - oldLength;

        // Se adicionamos caracteres de formata√ß√£o, mova o cursor para frente
        if (diff > 0) {
            this.setSelectionRange(cursorPos + diff, cursorPos + diff);
        } else {
            this.setSelectionRange(cursorPos, cursorPos);
        }
    });
}

// ========== SISTEMA DE ANAMNESE E PRONTU√ÅRIO MELHORADO ====================
let currentClienteCPF = null;
let currentClienteNome = null;
let uploadedDocuments = new Map(); // Armazenar documentos temporariamente

// Fun√ß√£o auxiliar para mostrar nome do arquivo selecionado
function mostrarNomeArquivo(input, divId) {
    const div = document.getElementById(divId);
    const fileNameSpan = div.querySelector('#anamneseFileName, #prontuarioFileName');

    if (input.files && input.files[0]) {
        const fileName = input.files[0].name;
        const fileSize = (input.files[0].size / 1024 / 1024).toFixed(2);

        if (input.files[0].size > 10485760) { // 10MB
            Swal.fire({
                icon: 'error',
                title: 'Arquivo muito grande',
                text: `O arquivo deve ter no m√°ximo 10MB. Seu arquivo tem ${fileSize}MB`
            });
            input.value = '';
            return;
        }

        div.style.display = 'block';
        if (fileNameSpan) {
            fileNameSpan.textContent = `${fileName} (${fileSize}MB)`;
        }
    } else {
        div.style.display = 'none';
    }
}

async function buscarAnamnesesCliente() {
    const cpf = document.getElementById('anamneseCPF')?.value?.trim();
    
    if (!cpf) {
        Swal.fire('Aten√ß√£o', 'Digite o CPF do cliente', 'warning');
        return;
    }
    
    try {
        const res = await fetch(`/api/clientes/${cpf}/anamnese`, {credentials: 'include'});
        
        if (!res.ok) {
            if (res.status === 404) {
                Swal.fire('Erro', 'Cliente n√£o encontrado', 'error');
                return;
            }
            throw new Error('Erro ao buscar anamneses');
        }
        
        const { cliente, anamneses } = await res.json();
        
        currentClienteCPF = cpf;
        document.getElementById('anamnesesClienteNome').textContent = cliente.nome;
        document.getElementById('anamnesesResultado').style.display = 'block';
        document.getElementById('anamneseMensagemInicial').style.display = 'none';
        
        renderizarHistoricoAnamneses(anamneses);
        
    } catch (error) {
        console.error('Erro:', error);
        Swal.fire('Erro', 'N√£o foi poss√≠vel carregar as anamneses', 'error');
    }
}

function renderizarHistoricoAnamneses(anamneses) {
    const tbody = document.getElementById('anamnesesHistoricoBody');
    if (!tbody) return;
    
    if (!anamneses || anamneses.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">Nenhuma anamnese encontrada</td></tr>';
        return;
    }
    
    tbody.innerHTML = anamneses.map(anamnese => {
        const data = new Date(anamnese.data_cadastro).toLocaleDateString('pt-BR');
        return `
            <tr>
                <td><span class="badge primary">v${anamnese.versao}</span></td>
                <td>${data}</td>
                <td>${anamnese.cadastrado_por || 'N/A'}</td>
                <td>
                    <button class="bioma-btn bioma-btn-sm bioma-btn-outline" onclick="visualizarAnamnese('${anamnese._id}')">
                        <i class="bi bi-eye"></i> Visualizar
                    </button>
                    <button class="bioma-btn bioma-btn-sm bioma-btn-danger" onclick="deletarAnamnese('${anamnese._id}')">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>
            </tr>
        `;
    }).join('');
}

async function novaAnamneseModal() {
    const { value: formValues } = await Swal.fire({
        title: '<i class="bi bi-file-medical"></i> Nova Anamnese',
        html: `
            <div style="text-align:left;max-height:500px;overflow-y:auto;padding:10px;">
                <!-- Se√ß√£o: Informa√ß√µes B√°sicas -->
                <div class="card mb-3">
                    <div class="card-header" style="background:linear-gradient(135deg, #667eea, #764ba2);color:white;">
                        <i class="bi bi-person-lines-fill"></i> Informa√ß√µes B√°sicas
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label"><strong>Queixa Principal:</strong></label>
                            <textarea id="anamneseQueixa" class="form-control" rows="2" placeholder="Motivo principal da consulta..."></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label"><strong>Hist√≥rico:</strong></label>
                            <textarea id="anamneseHistorico" class="form-control" rows="2" placeholder="Hist√≥rico m√©dico relevante..."></textarea>
                        </div>
                    </div>
                </div>

                <!-- Se√ß√£o: Sa√∫de -->
                <div class="card mb-3">
                    <div class="card-header" style="background:linear-gradient(135deg, #f093fb, #f5576c);color:white;">
                        <i class="bi bi-heart-pulse-fill"></i> Informa√ß√µes de Sa√∫de
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label"><strong>Alergias:</strong></label>
                            <input type="text" id="anamneseAlergias" class="form-control" placeholder="Liste alergias conhecidas...">
                        </div>
                        <div class="mb-3">
                            <label class="form-label"><strong>Medicamentos em uso:</strong></label>
                            <input type="text" id="anamneseMedicamentos" class="form-control" placeholder="Medicamentos atuais...">
                        </div>
                        <div class="mb-3">
                            <label class="form-label"><strong>Problemas de pele:</strong></label>
                            <input type="text" id="anamneseProblemasPele" class="form-control" placeholder="Condi√ß√µes de pele existentes...">
                        </div>
                    </div>
                </div>

                <!-- Se√ß√£o: Upload de Documento ESCANEADO -->
                <div class="card mb-3">
                    <div class="card-header" style="background:linear-gradient(135deg, #4facfe, #00f2fe);color:white;">
                        <i class="bi bi-cloud-arrow-up-fill"></i> Anexar Documento Escaneado
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info" style="background: linear-gradient(135deg, rgba(79,172,254,0.1), rgba(0,242,254,0.1)); border: 1px solid #4facfe;">
                            <i class="bi bi-info-circle-fill"></i> <strong>Dica Importante:</strong>
                            <br>Para anexar a ficha de anamnese f√≠sica, voc√™ deve primeiro <strong>ESCANEAR</strong> o documento f√≠sico.
                            <br>Use um scanner ou aplicativo de celular como CamScanner, Adobe Scan ou similar.
                        </div>
                        <div class="mb-3">
                            <label for="anamneseDocumento" class="form-label">
                                <strong>Ficha de Anamnese Escaneada:</strong>
                            </label>
                            <div class="upload-area" style="border:2px dashed #4facfe;border-radius:10px;padding:30px;text-align:center;cursor:pointer;transition:all 0.3s;background:linear-gradient(135deg, rgba(79,172,254,0.05), rgba(0,242,254,0.05));"
                                 onclick="document.getElementById('anamneseDocumento').click();"
                                 onmouseover="this.style.borderColor='#00f2fe';this.style.backgroundColor='rgba(79,172,254,0.1)'"
                                 onmouseout="this.style.borderColor='#4facfe';this.style.background='linear-gradient(135deg, rgba(79,172,254,0.05), rgba(0,242,254,0.05))'">
                                <i class="bi bi-scanner" style="font-size:3rem;color:#4facfe;"></i>
                                <p style="margin:15px 0 5px;color:#333;font-weight:600;">Clique para anexar documento escaneado</p>
                                <small style="color:#666;">Formatos aceitos: PDF, JPG, PNG (m√°x. 10MB)</small>
                                <br>
                                <small style="color:#999;font-style:italic;">Recomendamos PDF para melhor qualidade</small>
                            </div>
                            <input type="file" id="anamneseDocumento" style="display:none;" accept=".pdf,.jpg,.jpeg,.png" onchange="mostrarNomeArquivo(this, 'anamneseNomeArquivo')">
                            <div id="anamneseNomeArquivo" class="mt-3" style="display:none;">
                                <span class="badge bg-success" style="font-size:0.9rem;padding:8px 12px;">
                                    <i class="bi bi-check-circle"></i> Arquivo selecionado: <span id="anamneseFileName"></span>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Observa√ß√µes Gerais -->
                <div class="card mb-3">
                    <div class="card-header" style="background:linear-gradient(135deg, #fa709a, #fee140);color:white;">
                        <i class="bi bi-chat-text-fill"></i> Observa√ß√µes
                    </div>
                    <div class="card-body">
                        <textarea id="anamneseObs" class="form-control" rows="3" placeholder="Observa√ß√µes adicionais..."></textarea>
                    </div>
                </div>
            </div>
        `,
        width: '700px',
        focusConfirm: false,
        showCancelButton: true,
        confirmButtonText: '<i class="bi bi-floppy"></i> Salvar Anamnese',
        cancelButtonText: '<i class="bi bi-x-circle"></i> Cancelar',
        confirmButtonColor: '#7c3aed',
        preConfirm: () => {
            return {
                queixa_principal: document.getElementById('anamneseQueixa').value,
                historico: document.getElementById('anamneseHistorico').value,
                alergias: document.getElementById('anamneseAlergias').value,
                medicamentos: document.getElementById('anamneseMedicamentos').value,
                problemas_pele: document.getElementById('anamneseProblemasPele').value,
                observacoes: document.getElementById('anamneseObs').value,
                documento: document.getElementById('anamneseDocumento').files[0] || null
            };
        }
    });
    
    if (formValues) {
        try {
            const res = await fetch(`/api/clientes/${currentClienteCPF}/anamnese`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                credentials: 'include',
                body: JSON.stringify({
                    respostas: {},
                    observacoes: formValues.observacoes
                })
            });

            if (!res.ok) throw new Error('Erro ao salvar anamnese');

            mostrarNotificacao('success', 'Anamnese salva com sucesso!');
            buscarAnamnesesCliente(); // Recarregar lista

        } catch (error) {
            console.error('Erro:', error);
            mostrarNotificacao('error', 'N√£o foi poss√≠vel salvar a anamnese');
        }
    }
}

async function visualizarAnamnese(id) {
    try {
        const res = await fetch(`/api/clientes/${currentClienteCPF}/anamnese/${id}`, {
            credentials: 'include'
        });

        if (!res.ok) throw new Error('Erro ao buscar anamnese');

        const { anamnese } = await res.json();
        const data = new Date(anamnese.data_cadastro).toLocaleDateString('pt-BR');

        // Criar bot√£o para visualizar documento se existir
        let documentoHtml = '';
        if (anamnese.documento_anexado) {
            documentoHtml = `
                <div style="margin: 20px 0; padding: 15px; background: linear-gradient(135deg, rgba(79,172,254,0.1), rgba(0,242,254,0.1)); border-radius: 10px;">
                    <p style="margin-bottom: 10px;"><strong><i class="bi bi-paperclip"></i> Documento Anexado:</strong></p>
                    <button class="btn btn-primary btn-sm" onclick="visualizarDocumento('${anamnese.documento_anexado}', 'anamnese')">
                        <i class="bi bi-eye"></i> Visualizar Documento Escaneado
                    </button>
                    <button class="btn btn-info btn-sm" onclick="baixarDocumento('${anamnese.documento_anexado}', 'anamnese_${id}')">
                        <i class="bi bi-download"></i> Baixar
                    </button>
                </div>
            `;
        }

        // Mostrar informa√ß√µes completas da anamnese
        Swal.fire({
            title: `<i class="bi bi-file-medical"></i> Anamnese v${anamnese.versao}`,
            html: `
                <div style="text-align:left; max-height: 500px; overflow-y: auto;">
                    <div style="background: var(--bg-main); padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                        <p><strong><i class="bi bi-calendar"></i> Data:</strong> ${data}</p>
                        <p><strong><i class="bi bi-person"></i> Cadastrado por:</strong> ${anamnese.cadastrado_por || 'N/A'}</p>
                    </div>

                    ${anamnese.queixa_principal ? `
                    <div style="margin-bottom: 15px;">
                        <h4 style="color: var(--primary); margin-bottom: 10px;"><i class="bi bi-chat-dots"></i> Queixa Principal</h4>
                        <p style="padding: 10px; background: var(--bg-main); border-radius: 8px;">${anamnese.queixa_principal}</p>
                    </div>
                    ` : ''}

                    ${anamnese.historico ? `
                    <div style="margin-bottom: 15px;">
                        <h4 style="color: var(--primary); margin-bottom: 10px;"><i class="bi bi-clock-history"></i> Hist√≥rico</h4>
                        <p style="padding: 10px; background: var(--bg-main); border-radius: 8px;">${anamnese.historico}</p>
                    </div>
                    ` : ''}

                    ${anamnese.alergias ? `
                    <div style="margin-bottom: 15px;">
                        <h4 style="color: var(--danger); margin-bottom: 10px;"><i class="bi bi-exclamation-triangle"></i> Alergias</h4>
                        <p style="padding: 10px; background: rgba(239,68,68,0.1); border-radius: 8px;">${anamnese.alergias}</p>
                    </div>
                    ` : ''}

                    ${anamnese.medicamentos ? `
                    <div style="margin-bottom: 15px;">
                        <h4 style="color: var(--info); margin-bottom: 10px;"><i class="bi bi-capsule"></i> Medicamentos</h4>
                        <p style="padding: 10px; background: rgba(59,130,246,0.1); border-radius: 8px;">${anamnese.medicamentos}</p>
                    </div>
                    ` : ''}

                    ${anamnese.problemas_pele ? `
                    <div style="margin-bottom: 15px;">
                        <h4 style="color: var(--warning); margin-bottom: 10px;"><i class="bi bi-bandaid"></i> Problemas de Pele</h4>
                        <p style="padding: 10px; background: rgba(245,158,11,0.1); border-radius: 8px;">${anamnese.problemas_pele}</p>
                    </div>
                    ` : ''}

                    ${anamnese.observacoes ? `
                    <div style="margin-bottom: 15px;">
                        <h4 style="color: var(--primary); margin-bottom: 10px;"><i class="bi bi-chat-text"></i> Observa√ß√µes</h4>
                        <p style="padding: 10px; background: var(--bg-main); border-radius: 8px;">${anamnese.observacoes}</p>
                    </div>
                    ` : ''}

                    ${documentoHtml}
                </div>
            `,
            width: 700,
            confirmButtonText: 'Fechar',
            confirmButtonColor: '#7c3aed',
            allowEscapeKey: true,
            allowOutsideClick: true,
            showCloseButton: true,
            focusConfirm: true
        });

    } catch (error) {
        console.error('Erro:', error);
        Swal.fire('Erro', 'N√£o foi poss√≠vel visualizar a anamnese', 'error');
    }
}

async function deletarAnamnese(id) {
    const result = await Swal.fire({
        title: 'Confirmar exclus√£o?',
        text: 'Esta a√ß√£o n√£o pode ser desfeita!',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Sim, deletar!',
        cancelButtonText: 'Cancelar'
    });

    if (result.isConfirmed) {
        try {
            const res = await fetch(`/api/clientes/${currentClienteCPF}/anamnese/${id}`, {
                method: 'DELETE',
                credentials: 'include'
            });

            if (!res.ok) throw new Error('Erro ao deletar anamnese');

            Swal.fire('Deletado!', 'Anamnese removida com sucesso', 'success');
            buscarAnamnesesCliente(); // Recarregar lista

        } catch (error) {
            console.error('Erro:', error);
            Swal.fire('Erro', 'N√£o foi poss√≠vel deletar a anamnese', 'error');
        }
    }

}

// Fun√ß√µes para visualizar e baixar documentos
async function visualizarDocumento(documentoUrl, tipo) {
    try {
        const fileExt = documentoUrl.split('.').pop().toLowerCase();

        if (fileExt === 'pdf') {
            // Para PDFs, abrir em nova aba
            window.open(documentoUrl, '_blank');
        } else {
            // Para imagens, mostrar em modal
            Swal.fire({
                title: 'Documento Escaneado',
                html: `
                    <div style="max-height: 600px; overflow: auto;">
                        <img src="${documentoUrl}" style="width: 100%; height: auto; border-radius: 10px;">
                    </div>
                    <div style="margin-top: 15px;">
                        <button class="btn btn-info btn-sm" onclick="window.open('${documentoUrl}', '_blank')">
                            <i class="bi bi-box-arrow-up-right"></i> Abrir em Nova Aba
                        </button>
                        <button class="btn btn-success btn-sm" onclick="baixarDocumento('${documentoUrl}', '${tipo}')">
                            <i class="bi bi-download"></i> Baixar
                        </button>
                    </div>
                `,
                width: '80%',
                showConfirmButton: false,
                showCloseButton: true
            });
        }
    } catch (error) {
        console.error('Erro ao visualizar documento:', error);
        Swal.fire('Erro', 'N√£o foi poss√≠vel visualizar o documento', 'error');
    }
}

function baixarDocumento(documentoUrl, nomeArquivo) {
    try {
        const link = document.createElement('a');
        link.href = documentoUrl;
        link.download = nomeArquivo || 'documento';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    } catch (error) {
        console.error('Erro ao baixar documento:', error);
        Swal.fire('Erro', 'N√£o foi poss√≠vel baixar o documento', 'error');
    }
}

// ========== PRONTU√ÅRIO MELHORADO ==========
async function buscarProntuariosCliente() {
    const cpf = document.getElementById('prontuarioCPF')?.value?.trim();
    
    if (!cpf) {
        Swal.fire('Aten√ß√£o', 'Digite o CPF do cliente', 'warning');
        return;
    }
    
    try {
        const res = await fetch(`/api/clientes/${cpf}/prontuario`, {credentials: 'include'});
        
        if (!res.ok) {
            if (res.status === 404) {
                Swal.fire('Erro', 'Cliente n√£o encontrado', 'error');
                return;
            }
            throw new Error('Erro ao buscar prontu√°rios');
        }
        
        const { cliente, prontuarios } = await res.json();
        
        currentClienteCPF = cpf;
        document.getElementById('prontuariosClienteNome').textContent = cliente.nome;
        document.getElementById('prontuariosResultado').style.display = 'block';
        document.getElementById('prontuarioMensagemInicial').style.display = 'none';
        
        renderizarHistoricoProntuarios(prontuarios);
        
    } catch (error) {
        console.error('Erro:', error);
        Swal.fire('Erro', 'N√£o foi poss√≠vel carregar os prontu√°rios', 'error');
    }
}

function renderizarHistoricoProntuarios(prontuarios) {
    const tbody = document.getElementById('prontuariosHistoricoBody');
    if (!tbody) return;
    
    if (!prontuarios || prontuarios.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Nenhum prontu√°rio encontrado</td></tr>';
        return;
    }
    
    tbody.innerHTML = prontuarios.map(pront => {
        const data = new Date(pront.data_atendimento).toLocaleDateString('pt-BR');
        const proxima = pront.proxima_sessao ? new Date(pront.proxima_sessao).toLocaleDateString('pt-BR') : 'N/A';
        
        return `
            <tr>
                <td>${data}</td>
                <td>${pront.profissional || 'N/A'}</td>
                <td>${pront.procedimento || 'N/A'}</td>
                <td>${proxima}</td>
                <td>
                    <button class="bioma-btn bioma-btn-sm bioma-btn-outline" onclick="visualizarProntuario('${pront._id}')">
                        <i class="bi bi-eye"></i> Visualizar
                    </button>
                    <button class="bioma-btn bioma-btn-sm bioma-btn-primary" onclick="editarProntuario('${pront._id}')">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <button class="bioma-btn bioma-btn-sm bioma-btn-danger" onclick="deletarProntuario('${pront._id}')">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>
            </tr>
        `;
    }).join('');
}

async function novoProntuarioModal() {
    const { value: formValues } = await Swal.fire({
        title: '<i class="bi bi-clipboard2-pulse"></i> Novo Prontu√°rio',
        html: `
            <div style="text-align:left;max-height:500px;overflow-y:auto;padding:10px;">
                <!-- Se√ß√£o: Informa√ß√µes do Atendimento -->
                <div class="card mb-3">
                    <div class="card-header" style="background:linear-gradient(135deg, #667eea, #764ba2);color:white;">
                        <i class="bi bi-calendar-event"></i> Informa√ß√µes do Atendimento
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label"><strong>Data do Atendimento:</strong></label>
                                <input type="date" id="prontDataAtend" class="form-control" value="${new Date().toISOString().split('T')[0]}">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label"><strong>Hor√°rio:</strong></label>
                                <input type="time" id="prontHorario" class="form-control" value="${new Date().toTimeString().slice(0,5)}">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label"><strong>Profissional Respons√°vel:</strong></label>
                            <select id="prontProfissional" class="form-control">
                                <option value="">Selecione o profissional...</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Se√ß√£o: Procedimento Realizado -->
                <div class="card mb-3">
                    <div class="card-header" style="background:linear-gradient(135deg, #f093fb, #f5576c);color:white;">
                        <i class="bi bi-activity"></i> Procedimento Realizado
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label"><strong>Tipo de Procedimento:</strong></label>
                            <input type="text" id="prontProcedimento" class="form-control" placeholder="Ex: Limpeza de pele, Botox, Peeling...">
                        </div>
                        <div class="mb-3">
                            <label class="form-label"><strong>√Årea Tratada:</strong></label>
                            <input type="text" id="prontAreaTratada" class="form-control" placeholder="Ex: Face, pesco√ßo, m√£os...">
                        </div>
                        <div class="mb-3">
                            <label class="form-label"><strong>Produtos Utilizados:</strong></label>
                            <textarea id="prontProdutos" class="form-control" rows="2" placeholder="Liste os produtos utilizados no procedimento..."></textarea>
                        </div>
                    </div>
                </div>

                <!-- Se√ß√£o: Fotos Antes/Depois -->
                <div class="card mb-3">
                    <div class="card-header" style="background:linear-gradient(135deg, #4facfe, #00f2fe);color:white;">
                        <i class="bi bi-camera-fill"></i> Registro Fotogr√°fico
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label"><strong>Foto Antes:</strong></label>
                                <div class="upload-area" style="border:2px dashed #4facfe;border-radius:10px;padding:15px;text-align:center;cursor:pointer;transition:all 0.3s;height:120px;background:linear-gradient(135deg, rgba(79,172,254,0.05), rgba(0,242,254,0.05));"
                                     onclick="document.getElementById('prontFotoAntes').click();"
                                     onmouseover="this.style.borderColor='#00f2fe';this.style.backgroundColor='rgba(79,172,254,0.1)'"
                                     onmouseout="this.style.borderColor='#4facfe';this.style.background='linear-gradient(135deg, rgba(79,172,254,0.05), rgba(0,242,254,0.05))'">
                                    <i class="bi bi-camera" style="font-size:1.5rem;color:#4facfe;"></i>
                                    <p style="margin:5px 0;color:#666;font-size:0.9rem;">Foto Antes</p>
                                </div>
                                <input type="file" id="prontFotoAntes" style="display:none;" accept="image/*" onchange="mostrarNomeArquivo(this, 'prontNomeAntes')">
                                <div id="prontNomeAntes" class="mt-1" style="display:none;">
                                    <small class="text-success"><i class="bi bi-check-circle"></i> <span id="prontFileNameAntes"></span></small>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label"><strong>Foto Depois:</strong></label>
                                <div class="upload-area" style="border:2px dashed #4facfe;border-radius:10px;padding:15px;text-align:center;cursor:pointer;transition:all 0.3s;height:120px;background:linear-gradient(135deg, rgba(79,172,254,0.05), rgba(0,242,254,0.05));"
                                     onclick="document.getElementById('prontFotoDepois').click();"
                                     onmouseover="this.style.borderColor='#00f2fe';this.style.backgroundColor='rgba(79,172,254,0.1)'"
                                     onmouseout="this.style.borderColor='#4facfe';this.style.background='linear-gradient(135deg, rgba(79,172,254,0.05), rgba(0,242,254,0.05))'">
                                    <i class="bi bi-camera-fill" style="font-size:1.5rem;color:#4facfe;"></i>
                                    <p style="margin:5px 0;color:#666;font-size:0.9rem;">Foto Depois</p>
                                </div>
                                <input type="file" id="prontFotoDepois" style="display:none;" accept="image/*" onchange="mostrarNomeArquivo(this, 'prontNomeDepois')">
                                <div id="prontNomeDepois" class="mt-1" style="display:none;">
                                    <small class="text-success"><i class="bi bi-check-circle"></i> <span id="prontFileNameDepois"></span></small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Se√ß√£o: Upload de Prontu√°rio Escaneado -->
                <div class="card mb-3">
                    <div class="card-header" style="background:linear-gradient(135deg, #16A34A, #059669);color:white;">
                        <i class="bi bi-file-earmark-medical"></i> Anexar Prontu√°rio Escaneado
                    </div>
                    <div class="card-body">
                        <div class="alert alert-success" style="background: linear-gradient(135deg, rgba(22,163,74,0.1), rgba(5,150,105,0.1)); border: 1px solid #16A34A;">
                            <i class="bi bi-info-circle-fill"></i> <strong>Dica Importante:</strong>
                            <br>Se voc√™ possui um prontu√°rio f√≠sico preenchido, <strong>ESCANEIE</strong> o documento.
                            <br>Use um scanner profissional ou apps como CamScanner, Adobe Scan, Office Lens.
                            <br>Isso garante que todos os detalhes m√©dicos fiquem registrados digitalmente.
                        </div>
                        <div class="mb-3">
                            <label for="prontuarioDocumento" class="form-label">
                                <strong>Prontu√°rio F√≠sico Escaneado (opcional):</strong>
                            </label>
                            <div class="upload-area" style="border:2px dashed #16A34A;border-radius:10px;padding:30px;text-align:center;cursor:pointer;transition:all 0.3s;background:linear-gradient(135deg, rgba(22,163,74,0.05), rgba(5,150,105,0.05));"
                                 onclick="document.getElementById('prontuarioDocumento').click();"
                                 onmouseover="this.style.borderColor='#059669';this.style.backgroundColor='rgba(22,163,74,0.1)'"
                                 onmouseout="this.style.borderColor='#16A34A';this.style.background='linear-gradient(135deg, rgba(22,163,74,0.05), rgba(5,150,105,0.05))'">
                                <i class="bi bi-scanner" style="font-size:3rem;color:#16A34A;"></i>
                                <p style="margin:15px 0 5px;color:#333;font-weight:600;">Clique para anexar prontu√°rio escaneado</p>
                                <small style="color:#666;">Formatos aceitos: PDF, JPG, PNG (m√°x. 10MB)</small>
                                <br>
                                <small style="color:#999;font-style:italic;">PDF preserva melhor a qualidade do documento</small>
                            </div>
                            <input type="file" id="prontuarioDocumento" style="display:none;" accept=".pdf,.jpg,.jpeg,.png" onchange="mostrarNomeArquivo(this, 'prontuarioNomeArquivo')">
                            <div id="prontuarioNomeArquivo" class="mt-3" style="display:none;">
                                <span class="badge bg-success" style="font-size:0.9rem;padding:8px 12px;">
                                    <i class="bi bi-check-circle"></i> Arquivo selecionado: <span id="prontuarioFileName"></span>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Se√ß√£o: Observa√ß√µes e Recomenda√ß√µes -->
                <div class="card mb-3">
                    <div class="card-header" style="background:linear-gradient(135deg, #fa709a, #fee140);color:white;">
                        <i class="bi bi-chat-text-fill"></i> Observa√ß√µes e Recomenda√ß√µes
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label"><strong>Observa√ß√µes do Atendimento:</strong></label>
                            <textarea id="prontObs" class="form-control" rows="3" placeholder="Detalhes do atendimento, rea√ß√µes, observa√ß√µes importantes..."></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label"><strong>Cuidados P√≥s-Procedimento:</strong></label>
                            <textarea id="prontCuidados" class="form-control" rows="2" placeholder="Instru√ß√µes e cuidados que o cliente deve seguir..."></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label"><strong>Pr√≥xima Sess√£o (opcional):</strong></label>
                            <input type="date" id="prontProxima" class="form-control">
                        </div>
                    </div>
                </div>
            </div>
        `,
        width: '750px',
        focusConfirm: false,
        showCancelButton: true,
        confirmButtonText: '<i class="bi bi-floppy"></i> Salvar Prontu√°rio',
        cancelButtonText: '<i class="bi bi-x-circle"></i> Cancelar',
        confirmButtonColor: '#7c3aed',
        didOpen: () => {
            // Carregar lista de profissionais
            loadProfissionaisSelect('prontProfissional');
        },
        preConfirm: () => {
            return {
                data_atendimento: document.getElementById('prontDataAtend').value + 'T' + document.getElementById('prontHorario').value,
                profissional: document.getElementById('prontProfissional').value,
                procedimento: document.getElementById('prontProcedimento').value,
                area_tratada: document.getElementById('prontAreaTratada').value,
                produtos_utilizados: document.getElementById('prontProdutos').value,
                observacoes: document.getElementById('prontObs').value,
                cuidados_pos: document.getElementById('prontCuidados').value,
                proxima_sessao: document.getElementById('prontProxima').value || '',
                foto_antes: document.getElementById('prontFotoAntes').files[0] || null,
                foto_depois: document.getElementById('prontFotoDepois').files[0] || null
            };
        }
    });
    
    if (formValues) {
        try {
            const res = await fetch(`/api/clientes/${currentClienteCPF}/prontuario`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                credentials: 'include',
                body: JSON.stringify(formValues)
            });

            if (!res.ok) throw new Error('Erro ao salvar prontu√°rio');

            mostrarNotificacao('success', 'Prontu√°rio salvo com sucesso!');
            buscarProntuariosCliente(); // Recarregar lista

        } catch (error) {
            console.error('Erro:', error);
            mostrarNotificacao('error', 'N√£o foi poss√≠vel salvar o prontu√°rio');
        }
    }
}

async function visualizarProntuario(id) {
    try {
        const res = await fetch(`/api/clientes/${currentClienteCPF}/prontuario/${id}`, {
            credentials: 'include'
        });

        if (!res.ok) throw new Error('Erro ao buscar prontu√°rio');

        const { prontuario } = await res.json();
        const data = new Date(prontuario.data_atendimento).toLocaleDateString('pt-BR');
        const hora = new Date(prontuario.data_atendimento).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
        const proxima = prontuario.proxima_sessao ? new Date(prontuario.proxima_sessao).toLocaleDateString('pt-BR') : 'N√£o agendada';

        // Criar HTML para fotos se existirem
        let fotosHtml = '';
        if (prontuario.foto_antes || prontuario.foto_depois) {
            fotosHtml = `
                <div style="margin: 20px 0; padding: 15px; background: linear-gradient(135deg, rgba(79,172,254,0.1), rgba(0,242,254,0.1)); border-radius: 10px;">
                    <h4 style="color: var(--primary); margin-bottom: 15px;"><i class="bi bi-camera-fill"></i> Registro Fotogr√°fico</h4>
                    <div style="display: flex; gap: 15px; justify-content: center;">
                        ${prontuario.foto_antes ? `
                            <button class="btn btn-info btn-sm" onclick="visualizarDocumento('${prontuario.foto_antes}', 'foto_antes')">
                                <i class="bi bi-image"></i> Ver Foto Antes
                            </button>
                        ` : ''}
                        ${prontuario.foto_depois ? `
                            <button class="btn btn-info btn-sm" onclick="visualizarDocumento('${prontuario.foto_depois}', 'foto_depois')">
                                <i class="bi bi-image-fill"></i> Ver Foto Depois
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        // Criar HTML para documento escaneado se existir
        let documentoHtml = '';
        if (prontuario.documento_anexado) {
            documentoHtml = `
                <div style="margin: 20px 0; padding: 15px; background: linear-gradient(135deg, rgba(22,163,74,0.1), rgba(5,150,105,0.1)); border-radius: 10px;">
                    <p style="margin-bottom: 10px;"><strong><i class="bi bi-paperclip"></i> Prontu√°rio Escaneado:</strong></p>
                    <button class="btn btn-success btn-sm" onclick="visualizarDocumento('${prontuario.documento_anexado}', 'prontuario')">
                        <i class="bi bi-eye"></i> Visualizar Documento
                    </button>
                    <button class="btn btn-info btn-sm" onclick="baixarDocumento('${prontuario.documento_anexado}', 'prontuario_${id}')">
                        <i class="bi bi-download"></i> Baixar
                    </button>
                </div>
            `;
        }

        Swal.fire({
            title: '<i class="bi bi-clipboard2-pulse"></i> Prontu√°rio de Atendimento',
            html: `
                <div style="text-align:left; max-height: 550px; overflow-y: auto;">
                    <!-- Informa√ß√µes do Atendimento -->
                    <div style="background: var(--bg-main); padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                        <h4 style="color: var(--primary); margin-bottom: 15px;"><i class="bi bi-calendar-event"></i> Informa√ß√µes do Atendimento</h4>
                        <p><strong>Data:</strong> ${data} √†s ${hora}</p>
                        <p><strong>Profissional:</strong> ${prontuario.profissional || 'N/A'}</p>
                        <p><strong>Pr√≥xima Sess√£o:</strong> ${proxima}</p>
                    </div>

                    <!-- Procedimento Realizado -->
                    ${prontuario.procedimento ? `
                    <div style="background: linear-gradient(135deg, rgba(240,147,251,0.1), rgba(245,87,108,0.1)); padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                        <h4 style="color: var(--primary); margin-bottom: 10px;"><i class="bi bi-activity"></i> Procedimento Realizado</h4>
                        <p><strong>Tipo:</strong> ${prontuario.procedimento}</p>
                        ${prontuario.area_tratada ? `<p><strong>√Årea Tratada:</strong> ${prontuario.area_tratada}</p>` : ''}
                        ${prontuario.produtos_utilizados ? `<p><strong>Produtos:</strong> ${prontuario.produtos_utilizados}</p>` : ''}
                    </div>
                    ` : ''}

                    <!-- Observa√ß√µes -->
                    ${prontuario.observacoes ? `
                    <div style="background: var(--bg-main); padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                        <h4 style="color: var(--primary); margin-bottom: 10px;"><i class="bi bi-chat-text"></i> Observa√ß√µes</h4>
                        <p>${prontuario.observacoes}</p>
                    </div>
                    ` : ''}

                    <!-- Cuidados P√≥s-Procedimento -->
                    ${prontuario.cuidados_pos ? `
                    <div style="background: linear-gradient(135deg, rgba(250,112,154,0.1), rgba(254,225,64,0.1)); padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                        <h4 style="color: var(--warning); margin-bottom: 10px;"><i class="bi bi-exclamation-triangle"></i> Cuidados P√≥s-Procedimento</h4>
                        <p>${prontuario.cuidados_pos}</p>
                    </div>
                    ` : ''}

                    <!-- Registro Fotogr√°fico -->
                    ${fotosHtml}

                    <!-- Documento Escaneado -->
                    ${documentoHtml}

                    <!-- Informa√ß√µes de Registro -->
                    <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--border-color); color: var(--text-muted); font-size: 0.9rem;">
                        <p><i class="bi bi-person"></i> Cadastrado por: ${prontuario.cadastrado_por || 'N/A'}</p>
                        <p><i class="bi bi-clock"></i> Data de registro: ${new Date(prontuario.created_at || prontuario.data_cadastro).toLocaleString('pt-BR')}</p>
                    </div>
                </div>
            `,
            width: 750,
            confirmButtonText: 'Fechar',
            confirmButtonColor: '#7c3aed',
            allowEscapeKey: true,
            allowOutsideClick: true,
            showCloseButton: true,
            focusConfirm: true
        });

    } catch (error) {
        console.error('Erro:', error);
        Swal.fire('Erro', 'N√£o foi poss√≠vel visualizar o prontu√°rio', 'error');
    }
}

async function editarProntuario(id) {
    try {
        // Buscar prontu√°rio atual
        const res = await fetch(`/api/clientes/${currentClienteCPF}/prontuario/${id}`, {
            credentials: 'include'
        });
        
        if (!res.ok) throw new Error('Erro ao buscar prontu√°rio');
        
        const { prontuario } = await res.json();
        
        const { value: formValues } = await Swal.fire({
            title: 'Editar Prontu√°rio',
            html: `
                <div style="text-align:left;">
                    <label>Data do Atendimento:</label>
                    <input type="date" id="prontDataAtend" class="form-control" value="${prontuario.data_atendimento.split('T')[0]}">
                    
                    <label>Profissional:</label>
                    <input type="text" id="prontProfissional" class="form-control" value="${prontuario.profissional || ''}" placeholder="Nome do profissional">
                    
                    <label>Procedimento:</label>
                    <input type="text" id="prontProcedimento" class="form-control" value="${prontuario.procedimento || ''}" placeholder="Tipo de procedimento">
                    
                    <label>Observa√ß√µes:</label>
                    <textarea id="prontObs" class="form-control" placeholder="Observa√ß√µes do atendimento">${prontuario.observacoes || ''}</textarea>
                    
                    <label>Pr√≥xima Sess√£o (opcional):</label>
                    <input type="date" id="prontProxima" class="form-control" value="${prontuario.proxima_sessao ? prontuario.proxima_sessao.split('T')[0] : ''}">
                </div>
            `,
            width: 600,
            focusConfirm: false,
            showCancelButton: true,
            confirmButtonText: 'Salvar',
            cancelButtonText: 'Cancelar',
            preConfirm: () => {
                return {
                    data_atendimento: document.getElementById('prontDataAtend').value + 'T00:00:00',
                    profissional: document.getElementById('prontProfissional').value,
                    procedimento: document.getElementById('prontProcedimento').value,
                    observacoes: document.getElementById('prontObs').value,
                    proxima_sessao: document.getElementById('prontProxima').value || ''
                };
            }
        });
        
        if (formValues) {
            const updateRes = await fetch(`/api/clientes/${currentClienteCPF}/prontuario/${id}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                credentials: 'include',
                body: JSON.stringify(formValues)
            });

            if (!updateRes.ok) throw new Error('Erro ao atualizar prontu√°rio');

            mostrarNotificacao('success', 'Prontu√°rio atualizado com sucesso!');
            buscarProntuariosCliente(); // Recarregar lista
        }

    } catch (error) {
        console.error('Erro:', error);
        mostrarNotificacao('error', 'N√£o foi poss√≠vel editar o prontu√°rio');
    }
}

async function deletarProntuario(id) {
    const result = await mostrarConfirmacao({
        title: 'Confirmar exclus√£o?',
        text: 'Esta a√ß√£o n√£o pode ser desfeita!',
        icon: 'warning',
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Sim, deletar!',
        cancelButtonText: 'Cancelar'
    });

    if (result.isConfirmed) {
        try {
            const res = await fetch(`/api/clientes/${currentClienteCPF}/prontuario/${id}`, {
                method: 'DELETE',
                credentials: 'include'
            });

            if (!res.ok) throw new Error('Erro ao deletar prontu√°rio');

            Swal.fire('Deletado!', 'Prontu√°rio removido com sucesso', 'success');
            buscarProntuariosCliente(); // Recarregar lista

        } catch (error) {
            console.error('Erro:', error);
            Swal.fire('Erro', 'N√£o foi poss√≠vel deletar o prontu√°rio', 'error');
        }
    }

}
// ========== FIM ANAMNESE E PRONTU√ÅRIO ==========

// ========== SISTEMA DE SUB-TABS GLOBAL ====================
// switchSubTab j√° foi definida no in√≠cio do script (linha ~2709)

async function carregarDadosSubTab(section, subtab) {
    console.log(`üöÄ Loading data for sub-tab: ${section} -> ${subtab}`);

    try {
        // Add specific calls based on section and subtab
        if (section === 'orcamento') {
            if (subtab === 'pendentes') await carregarOrcamentosPendentes();
            else if (subtab === 'aprovados') await carregarOrcamentosAprovados();
            else if (subtab === 'rejeitados') await carregarOrcamentosRejeitados();
            else if (subtab === 'historico') await carregarHistoricoOrcamentos();
        } else if (section === 'agendamentos') {
            if (subtab === 'novo') await carregarFormularioNovoAgendamento();
            else if (subtab === 'hoje') await carregarAgendamentosHoje();
            else if (subtab === 'semana') await carregarAgendamentosSemana();
            else if (subtab === 'mes') await carregarAgendamentosMes();
            else if (subtab === 'todos') await carregarTodosAgendamentos();
        } else if (section === 'produtos') {
            if (subtab === 'todos') await carregarProdutosTodos();
            else if (subtab === 'ativos') await carregarProdutosAtivos();
            else if (subtab === 'inativos') await carregarProdutosInativos();
        } else if (section === 'servicos') {
            if (subtab === 'todos') await carregarServicosTodos();
            else if (subtab === 'ativos') await carregarServicosAtivos();
            else if (subtab === 'inativos') await carregarServicosInativos();
        } else if (section === 'estoque') {
            if (subtab === 'visaogeral') await carregarEstoqueVisaoGeral();
            else if (subtab === 'produtos') await carregarProdutosEstoque();
            else if (subtab === 'movimentacoes') await carregarMovimentacoesEstoque();
            else if (subtab === 'relatorios') await carregarRelatoriosEstoque();
        } else if (section === 'profissionais') {
            if (subtab === 'lista') await loadProfissionais();
            else if (subtab === 'comissoes') await carregarComissoesProfissionais();
            else if (subtab === 'estatisticas') await carregarEstatisticasProfissionais();
            else if (subtab === 'assistentes') await loadAssistentes();
        } else if (section === 'financeiro') {
            if (subtab === 'resumo') await carregarFinanceiroResumo();
            else if (subtab === 'receitas') await carregarReceitas();
            else if (subtab === 'despesas') await carregarDespesas();
            else if (subtab === 'comissoes') await carregarHistoricoComissoes();
        }

        console.log(`‚úÖ Finished loading: ${section} -> ${subtab}`);
    } catch(e) {
        console.error(`‚ùå Error loading sub-tab ${section} -> ${subtab}:`, e);
    }
}
// ========== FIM SUB-TABS GLOBAL ==========

// ========== SISTEMA DE SUB-TABS - OR√áAMENTOS ====================
async function carregarOrcamentosPendentes() {
    const tbody = document.getElementById('orcamentosPendentesBody');
    if (!tbody) return;
    
    try {
        const res = await fetch('/api/orcamentos?status=Pendente', {credentials: 'include'});
        if (!res.ok) throw new Error('Erro ao carregar or√ßamentos');

        const data = await res.json();
        const orcamentos = data.orcamentos || [];

        if (!orcamentos || orcamentos.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Nenhum or√ßamento pendente</td></tr>';
            return;
        }

        tbody.innerHTML = orcamentos.map((orc, index) => {
            const dataStr = orc.data || orc.created_at || new Date().toISOString();
            const data = new Date(dataStr).toLocaleDateString('pt-BR');
            const profs = orc.profissionais_vinculados?.map(p => p.nome).join(', ') || 'N/A';
            const nome = orc.cliente_nome || orc.nome || 'Sem nome';
            const cpf = orc.cliente_cpf || orc.cpf || 'Sem CPF';

            // Obter ID com m√∫ltiplos fallbacks
            const orcId = orc._id || orc.id || orc.orcamento_id || `temp-${index}`;

            // Log para debug (remover em produ√ß√£o)
            if (!orc._id) {
                console.warn(`‚ö†Ô∏è Or√ßamento sem _id (√≠ndice ${index}):`, orc);
            }

            return `
                <tr>
                    <td><strong>#${String(orcId).slice(-6)}</strong></td>
                    <td>${data}</td>
                    <td>${nome}</td>
                    <td>${cpf}</td>
                    <td>R$ ${parseFloat(orc.total_final || 0).toFixed(2)}</td>
                    <td>${profs}</td>
                    <td>
                        <button class="bioma-btn bioma-btn-sm bioma-btn-outline" onclick="visualizarOrcamento('${orcId}')" title="Visualizar">
                            <i class="bi bi-eye"></i>
                        </button>
                        <button class="bioma-btn bioma-btn-sm bioma-btn-success" onclick="aprovarOrcamento('${orcId}')" title="Aprovar">
                            <i class="bi bi-check"></i>
                        </button>
                        <button class="bioma-btn bioma-btn-sm bioma-btn-danger" onclick="rejeitarOrcamento('${orcId}')" title="Rejeitar">
                            <i class="bi bi-x"></i>
                        </button>
                    </td>
                </tr>
            `;
        }).join('');
        
    } catch (error) {
        console.error('Erro:', error);
        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Erro ao carregar or√ßamentos</td></tr>';
    }
}

async function carregarOrcamentosAprovados() {
    const tbody = document.getElementById('orcamentosAprovadosBody');
    if (!tbody) return;
    
    try {
        const res = await fetch('/api/orcamentos?status=Aprovado', {credentials: 'include'});
        if (!res.ok) throw new Error('Erro ao carregar or√ßamentos');

        const data = await res.json();
        const orcamentos = data.orcamentos || [];

        if (!orcamentos || orcamentos.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Nenhum or√ßamento aprovado</td></tr>';
            return;
        }

        tbody.innerHTML = orcamentos.map((orc, index) => {
            const dataStr = orc.data || orc.created_at || new Date().toISOString();
            const data = new Date(dataStr).toLocaleDateString('pt-BR');
            const nome = orc.cliente_nome || orc.nome || 'Sem nome';
            const cpf = orc.cliente_cpf || orc.cpf || 'Sem CPF';

            // Obter ID com m√∫ltiplos fallbacks
            const orcId = orc._id || orc.id || orc.orcamento_id || `temp-${index}`;

            if (!orc._id) {
                console.warn(`‚ö†Ô∏è Or√ßamento aprovado sem _id (√≠ndice ${index}):`, orc);
            }

            return `
                <tr>
                    <td><strong>#${String(orcId).slice(-6)}</strong></td>
                    <td>${data}</td>
                    <td>${nome}</td>
                    <td>${cpf}</td>
                    <td>R$ ${parseFloat(orc.total_final || 0).toFixed(2)}</td>
                    <td>${(typeof orc.pagamento === 'object' ? orc.pagamento.tipo : orc.pagamento) || orc.forma_pagamento || 'N/A'}</td>
                    <td>
                        <button class="bioma-btn bioma-btn-sm bioma-btn-outline" onclick="visualizarOrcamento('${orcId}')" title="Visualizar">
                            <i class="bi bi-eye"></i>
                        </button>
                        <button class="bioma-btn bioma-btn-sm bioma-btn-primary" onclick="imprimirContrato('${orcId}')" title="Imprimir Contrato">
                            <i class="bi bi-printer"></i>
                        </button>
                    </td>
                </tr>
            `;
        }).join('');
        
    } catch (error) {
        console.error('Erro:', error);
        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Erro ao carregar or√ßamentos</td></tr>';
    }
}

async function carregarOrcamentosRejeitados() {
    const tbody = document.getElementById('orcamentosRejeitadosBody');
    if (!tbody) return;
    
    try {
        const res = await fetch('/api/orcamentos?status=Rejeitado', {credentials: 'include'});
        if (!res.ok) throw new Error('Erro ao carregar or√ßamentos');

        const data = await res.json();
        const orcamentos = data.orcamentos || [];

        if (!orcamentos || orcamentos.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Nenhum or√ßamento rejeitado</td></tr>';
            return;
        }

        tbody.innerHTML = orcamentos.map((orc, index) => {
            const dataStr = orc.data || orc.created_at || new Date().toISOString();
            const data = new Date(dataStr).toLocaleDateString('pt-BR');
            const nome = orc.cliente_nome || orc.nome || 'Sem nome';
            const cpf = orc.cliente_cpf || orc.cpf || 'Sem CPF';

            // Obter ID com m√∫ltiplos fallbacks
            const orcId = orc._id || orc.id || orc.orcamento_id || `temp-${index}`;

            if (!orc._id) {
                console.warn(`‚ö†Ô∏è Or√ßamento rejeitado sem _id (√≠ndice ${index}):`, orc);
            }

            return `
                <tr>
                    <td><strong>#${String(orcId).slice(-6)}</strong></td>
                    <td>${data}</td>
                    <td>${nome}</td>
                    <td>${cpf}</td>
                    <td>R$ ${parseFloat(orc.total_final || 0).toFixed(2)}</td>
                    <td>${orc.motivo_rejeicao || 'N/A'}</td>
                    <td>
                        <button class="bioma-btn bioma-btn-sm bioma-btn-outline" onclick="visualizarOrcamento('${orcId}')" title="Visualizar">
                            <i class="bi bi-eye"></i>
                        </button>
                        <button class="bioma-btn bioma-btn-sm bioma-btn-danger" onclick="deletarOrcamento('${orcId}')" title="Deletar">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
        }).join('');
        
    } catch (error) {
        console.error('Erro:', error);
        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Erro ao carregar or√ßamentos</td></tr>';
    }
}

async function carregarHistoricoOrcamentos() {
    const tbody = document.getElementById('orcamentosHistoricoBody');
    if (!tbody) return;
    
    const periodo = document.getElementById('filtroHistoricoPeriodo')?.value || '30';
    const status = document.getElementById('filtroHistoricoStatus')?.value || '';
    const cliente = document.getElementById('filtroHistoricoCliente')?.value || '';
    
    try {
        let url = `/api/orcamentos?periodo=${periodo}`;
        if (status) url += `&status=${status}`;
        if (cliente) url += `&cliente=${encodeURIComponent(cliente)}`;
        
        const res = await fetch(url, {credentials: 'include'});
        if (!res.ok) throw new Error('Erro ao carregar hist√≥rico');

        const data = await res.json();
        const orcamentos = data.orcamentos || [];

        if (!orcamentos || orcamentos.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Nenhum or√ßamento encontrado</td></tr>';
            return;
        }

        tbody.innerHTML = orcamentos.map(orc => {
            const dataStr = orc.data || orc.created_at || new Date().toISOString();
            const data = new Date(dataStr).toLocaleDateString('pt-BR');
            const nome = orc.cliente_nome || orc.nome || 'Sem nome';
            const cpf = orc.cliente_cpf || orc.cpf || 'Sem CPF';
            const statusClass = orc.status === 'Aprovado' ? 'success' : orc.status === 'Rejeitado' ? 'danger' : 'warning';
            return `
                <tr>
                    <td>${data}</td>
                    <td>${nome}</td>
                    <td>${cpf}</td>
                    <td>R$ ${parseFloat(orc.total_final || 0).toFixed(2)}</td>
                    <td><span class="badge ${statusClass}">${orc.status}</span></td>
                    <td>
                        <button class="bioma-btn bioma-btn-sm bioma-btn-outline" onclick="visualizarOrcamento('${orc._id}')">
                            <i class="bi bi-eye"></i>
                        </button>
                    </td>
                </tr>
            `;
        }).join('');
        
    } catch (error) {
        console.error('Erro:', error);
        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Erro ao carregar hist√≥rico</td></tr>';
    }
}

async function aprovarOrcamento(id) {
    const result = await Swal.fire({
        title: 'Aprovar Or√ßamento?',
        text: 'O or√ßamento ser√° marcado como aprovado',
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'Sim, aprovar',
        cancelButtonText: 'Cancelar'
    });
    
    if (result.isConfirmed) {
        try {
            const res = await fetch(`/api/orcamentos/${id}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                credentials: 'include',
                body: JSON.stringify({ status: 'Aprovado' })
            });
            
            if (!res.ok) throw new Error('Erro ao aprovar or√ßamento');
            
            Swal.fire('Aprovado!', 'Or√ßamento aprovado com sucesso', 'success');
            carregarOrcamentosPendentes();
            
        } catch (error) {
            console.error('Erro:', error);
            Swal.fire('Erro', 'N√£o foi poss√≠vel aprovar o or√ßamento', 'error');
        }
    }
}

async function rejeitarOrcamento(id) {
    const { value: motivo } = await Swal.fire({
        title: 'Rejeitar Or√ßamento',
        input: 'textarea',
        inputLabel: 'Motivo da rejei√ß√£o',
        inputPlaceholder: 'Digite o motivo...',
        showCancelButton: true,
        confirmButtonText: 'Rejeitar',
        cancelButtonText: 'Cancelar'
    });
    
    if (motivo) {
        try {
            const res = await fetch(`/api/orcamentos/${id}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                credentials: 'include',
                body: JSON.stringify({ status: 'Rejeitado', motivo_rejeicao: motivo })
            });
            
            if (!res.ok) throw new Error('Erro ao rejeitar or√ßamento');
            
            Swal.fire('Rejeitado!', 'Or√ßamento rejeitado', 'success');
            carregarOrcamentosPendentes();
            
        } catch (error) {
            console.error('Erro:', error);
            Swal.fire('Erro', 'N√£o foi poss√≠vel rejeitar o or√ßamento', 'error');
        }
    }
}
// ========== FIM SUB-TABS OR√áAMENTOS ==========

// ========== SISTEMA DE SUB-TABS - AGENDAMENTOS (CORRIGIDO) ====================

// Fun√ß√£o para carregar o formul√°rio de novo agendamento
async function carregarFormularioNovoAgendamento() {
    console.log('üìù Carregando formul√°rio de novo agendamento...');

    try {
        // Carregar clientes
        const clientesRes = await fetch('/api/clientes', {credentials: 'include'});
        if (clientesRes.ok) {
            const clientesData = await clientesRes.json();
            const clienteSelect = document.getElementById('novoAgendCliente');
            if (clienteSelect) {
                clienteSelect.innerHTML = '<option value="">Selecione o cliente...</option>';
                if (clientesData.success && clientesData.clientes) {
                    clientesData.clientes.forEach(cliente => {
                        const option = document.createElement('option');
                        option.value = cliente._id;
                        option.textContent = `${cliente.nome} - ${cliente.cpf || 'Sem CPF'}`;
                        clienteSelect.appendChild(option);
                    });
                }
            }
        }

        // Carregar profissionais
        const profissionaisRes = await fetch('/api/profissionais', {credentials: 'include'});
        if (profissionaisRes.ok) {
            const profissionaisData = await profissionaisRes.json();
            const profissionalSelect = document.getElementById('novoAgendProfissional');
            if (profissionalSelect) {
                profissionalSelect.innerHTML = '<option value="">Selecione o profissional...</option>';
                if (profissionaisData.success && profissionaisData.profissionais) {
                    profissionaisData.profissionais.forEach(prof => {
                        if (prof.ativo !== false) { // Apenas profissionais ativos
                            const option = document.createElement('option');
                            option.value = prof._id;
                            option.textContent = `${prof.nome} - ${prof.especialidade || 'Sem especialidade'}`;
                            profissionalSelect.appendChild(option);
                        }
                    });
                }
            }
        }

        // Carregar servi√ßos
        const servicosRes = await fetch('/api/servicos', {credentials: 'include'});
        if (servicosRes.ok) {
            const servicosData = await servicosRes.json();
            const servicoSelect = document.getElementById('novoAgendServico');
            if (servicoSelect) {
                servicoSelect.innerHTML = '<option value="">Selecione o servi√ßo...</option>';
                if (servicosData.success && servicosData.servicos) {
                    servicosData.servicos.forEach(servico => {
                        const option = document.createElement('option');
                        option.value = servico._id;
                        option.textContent = `${servico.nome} - R$ ${parseFloat(servico.preco || 0).toFixed(2)}`;
                        servicoSelect.appendChild(option);
                    });
                }
            }
        }

        // Definir data e hora padr√£o (hoje)
        const hoje = new Date();
        const dataInput = document.getElementById('novoAgendData');
        if (dataInput) {
            dataInput.value = hoje.toISOString().split('T')[0];
        }

        const horaInput = document.getElementById('novoAgendHora');
        if (horaInput && !horaInput.value) {
            horaInput.value = '09:00';
        }

        console.log('‚úÖ Formul√°rio de novo agendamento carregado com sucesso');
    } catch(e) {
        console.error('‚ùå Erro ao carregar formul√°rio de novo agendamento:', e);
    }
}

// Fun√ß√£o para salvar novo agendamento
async function salvarNovoAgendamento() {
    const cliente = document.getElementById('novoAgendCliente')?.value;
    const profissional = document.getElementById('novoAgendProfissional')?.value;
    const servico = document.getElementById('novoAgendServico')?.value;
    const data = document.getElementById('novoAgendData')?.value;
    const hora = document.getElementById('novoAgendHora')?.value;
    const observacoes = document.getElementById('novoAgendObservacoes')?.value;

    if (!cliente || !profissional || !servico || !data || !hora) {
        Swal.fire({
            icon: 'warning',
            title: 'Campos obrigat√≥rios',
            text: 'Por favor, preencha todos os campos obrigat√≥rios'
        });
        return;
    }

    try {
        const response = await fetch('/api/agendamentos', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            credentials: 'include',
            body: JSON.stringify({
                cliente_id: cliente,
                profissional_id: profissional,
                servico_id: servico,
                data,
                hora,
                observacoes,
                status: 'Confirmado'
            })
        });

        const result = await response.json();

        if (result.success) {
            Swal.fire({
                icon: 'success',
                title: 'Agendamento criado!',
                text: 'O agendamento foi criado com sucesso'
            });

            // Limpar formul√°rio
            limparFormularioNovoAgendamento();

            // Mudar para aba de hoje
            switchSubTab('agendamentos', 'hoje');
        } else {
            Swal.fire({
                icon: 'error',
                title: 'Erro',
                text: result.message || 'Erro ao criar agendamento'
            });
        }
    } catch(e) {
        console.error('Erro ao salvar agendamento:', e);
        Swal.fire({
            icon: 'error',
            title: 'Erro',
            text: 'Erro ao criar agendamento'
        });
    }
}

// Fun√ß√£o para limpar formul√°rio de novo agendamento
function limparFormularioNovoAgendamento() {
    document.getElementById('novoAgendCliente').value = '';
    document.getElementById('novoAgendProfissional').value = '';
    document.getElementById('novoAgendServico').value = '';
    document.getElementById('novoAgendData').value = new Date().toISOString().split('T')[0];
    document.getElementById('novoAgendHora').value = '09:00';
    document.getElementById('novoAgendObservacoes').value = '';
}

async function carregarAgendamentosHoje() {
    const FUNC_KEY = 'agendamentosHoje';
    const tbody = document.getElementById('agendamentosHojeBody');
    if (!tbody) return;
    
    // Prevenir m√∫ltiplas chamadas
    if (window.loadingStates && window.loadingStates[FUNC_KEY]) {
        console.log('‚è≥ J√° est√° carregando agendamentos hoje...');
        return;
    }
    
    try {
        // Marcar como carregando
        if (!window.loadingStates) window.loadingStates = {};
        window.loadingStates[FUNC_KEY] = true;
        
        console.log('üìÖ Carregando agendamentos de hoje...');
        
        const res = await fetch('/api/agendamentos/hoje', {credentials: 'include'});
        if (!res.ok) throw new Error('Erro ao carregar agendamentos');
        
        const data = await res.json();
        
        if (!data.success) {
            throw new Error(data.message || 'Erro ao carregar agendamentos');
        }
        
        const agendamentos = data.agendamentos || [];
        
        // Atualizar estat√≠sticas (vindas do backend)
        document.getElementById('agendamentosHojeTotal').textContent = data.total || 0;
        document.getElementById('agendamentosHojePendentes').textContent = data.pendentes || 0;
        document.getElementById('agendamentosHojeConfirmados').textContent = data.confirmados || 0;
        document.getElementById('agendamentosHojeCancelados').textContent = data.cancelados || 0;
        
        if (!agendamentos || agendamentos.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">Nenhum agendamento para hoje</td></tr>';
            return;
        }

        tbody.innerHTML = agendamentos.map(ag => {
            const statusClass = ag.status === 'Confirmado' ? 'success' : ag.status === 'Cancelado' ? 'danger' : 'warning';
            const horario = ag.horario || ag.hora || 'N/A';
            const clienteNome = ag.cliente_nome || ag.cliente?.nome || 'Cliente n√£o informado';
            const servico = ag.servico || ag.servico_nome || ag.servico?.nome || 'Servi√ßo n√£o informado';
            const tamanho = ag.tamanho || '-';
            const profissional = ag.profissional || ag.profissional_nome || ag.profissional?.nome || 'Profissional n√£o informado';
            const status = ag.status || 'Pendente';

            return `
                <tr>
                    <td>${horario}</td>
                    <td>${clienteNome}</td>
                    <td>${servico}</td>
                    <td><span class="badge" style="background: var(--primary); color: white;">${tamanho}</span></td>
                    <td>${profissional}</td>
                    <td><span class="badge ${statusClass}">${status}</span></td>
                    <td>
                        <button class="bioma-btn bioma-btn-sm bioma-btn-outline" onclick="visualizarAgendamento('${ag._id}')">
                            <i class="bi bi-eye"></i>
                        </button>
                        <button class="bioma-btn bioma-btn-sm bioma-btn-primary" onclick="editarAgendamento('${ag._id}')">
                            <i class="bi bi-pencil"></i>
                        </button>
                    </td>
                </tr>
            `;
        }).join('');

        console.log(`‚úÖ ${agendamentos.length} agendamentos de hoje carregados`);

    } catch (error) {
        console.error('‚ùå Erro ao carregar agendamentos de hoje:', error);
        Swal.fire('Erro', 'N√£o foi poss√≠vel carregar os agendamentos de hoje', 'error');
        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-danger">Erro ao carregar dados</td></tr>';
    } finally {
        // SEMPRE limpar estado
        if (window.loadingStates) {
            window.loadingStates[FUNC_KEY] = false;
        }
    }
}

async function carregarAgendamentosSemana() {
    const FUNC_KEY = 'agendamentosSemana';
    const tbody = document.getElementById('agendamentosSemanaBody');
    if (!tbody) return;

    if (window.loadingStates?.[FUNC_KEY]) return;

    try {
        if (!window.loadingStates) window.loadingStates = {};
        window.loadingStates[FUNC_KEY] = true;

        const res = await fetch('/api/agendamentos/semana', {credentials: 'include'});
        if (!res.ok) throw new Error('Erro ao carregar agendamentos');

        const data = await res.json();
        const agendamentos = data.agendamentos || data;

        if (!agendamentos || agendamentos.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">Nenhum agendamento esta semana</td></tr>';
            return;
        }

        tbody.innerHTML = agendamentos.map(ag => {
            const dataFormatada = ag.data ? new Date(ag.data).toLocaleDateString('pt-BR') : 'Data n√£o informada';
            const statusClass = ag.status === 'Confirmado' ? 'success' : ag.status === 'Cancelado' ? 'danger' : 'warning';
            const horario = ag.horario || ag.hora || 'N/A';
            const clienteNome = ag.cliente_nome || ag.cliente?.nome || 'Cliente n√£o informado';
            const servico = ag.servico || ag.servico_nome || ag.servico?.nome || 'Servi√ßo n√£o informado';
            const tamanho = ag.tamanho || '-';
            const profissional = ag.profissional || ag.profissional_nome || ag.profissional?.nome || 'Profissional n√£o informado';
            const status = ag.status || 'Pendente';

            return `
                <tr>
                    <td>${dataFormatada}</td>
                    <td>${horario}</td>
                    <td>${clienteNome}</td>
                    <td>${servico}</td>
                    <td><span class="badge" style="background: var(--primary); color: white;">${tamanho}</span></td>
                    <td>${profissional}</td>
                    <td><span class="badge ${statusClass}">${status}</span></td>
                    <td>
                        <button class="bioma-btn bioma-btn-sm bioma-btn-outline" onclick="visualizarAgendamento('${ag._id}')">
                            <i class="bi bi-eye"></i>
                        </button>
                        <button class="bioma-btn bioma-btn-sm bioma-btn-primary" onclick="editarAgendamento('${ag._id}')">
                            <i class="bi bi-pencil"></i>
                        </button>
                    </td>
                </tr>
            `;
        }).join('');

        console.log(`‚úÖ ${agendamentos.length} agendamentos da semana carregados`);

    } catch (error) {
        console.error('‚ùå Erro ao carregar agendamentos da semana:', error);
        Swal.fire('Erro', 'Falha ao carregar agendamentos da semana', 'error');
        tbody.innerHTML = '<tr><td colspan="8" class="text-center text-danger">Erro ao carregar agendamentos</td></tr>';
    } finally {
        if (window.loadingStates) window.loadingStates[FUNC_KEY] = false;
    }
}

async function carregarAgendamentosMes() {
    const FUNC_KEY = 'agendamentosMes';
    const tbody = document.getElementById('agendamentosMesBody');
    if (!tbody) return;

    if (window.loadingStates?.[FUNC_KEY]) return;

    try {
        if (!window.loadingStates) window.loadingStates = {};
        window.loadingStates[FUNC_KEY] = true;

        const res = await fetch('/api/agendamentos/mes', {credentials: 'include'});
        if (!res.ok) throw new Error('Erro ao carregar agendamentos');

        const data = await res.json();
        const agendamentos = data.agendamentos || data;

        if (!agendamentos || agendamentos.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">Nenhum agendamento este m√™s</td></tr>';
            return;
        }

        tbody.innerHTML = agendamentos.map(ag => {
            const dataFormatada = ag.data ? new Date(ag.data).toLocaleDateString('pt-BR') : 'Data n√£o informada';
            const statusClass = ag.status === 'Confirmado' ? 'success' : ag.status === 'Cancelado' ? 'danger' : 'warning';
            const horario = ag.horario || ag.hora || 'N/A';
            const clienteNome = ag.cliente_nome || ag.cliente?.nome || 'Cliente n√£o informado';
            const servico = ag.servico || ag.servico_nome || ag.servico?.nome || 'Servi√ßo n√£o informado';
            const tamanho = ag.tamanho || '-';
            const profissional = ag.profissional || ag.profissional_nome || ag.profissional?.nome || 'Profissional n√£o informado';
            const status = ag.status || 'Pendente';

            return `
                <tr>
                    <td>${dataFormatada}</td>
                    <td>${horario}</td>
                    <td>${clienteNome}</td>
                    <td>${servico}</td>
                    <td><span class="badge" style="background: var(--primary); color: white;">${tamanho}</span></td>
                    <td>${profissional}</td>
                    <td><span class="badge ${statusClass}">${status}</span></td>
                    <td>
                        <button class="bioma-btn bioma-btn-sm bioma-btn-outline" onclick="visualizarAgendamento('${ag._id}')">
                            <i class="bi bi-eye"></i>
                        </button>
                        <button class="bioma-btn bioma-btn-sm bioma-btn-primary" onclick="editarAgendamento('${ag._id}')">
                            <i class="bi bi-pencil"></i>
                        </button>
                    </td>
                </tr>
            `;
        }).join('');

        console.log(`‚úÖ ${agendamentos.length} agendamentos do m√™s carregados`);

    } catch (error) {
        console.error('‚ùå Erro ao carregar agendamentos do m√™s:', error);
        Swal.fire('Erro', 'Falha ao carregar agendamentos do m√™s', 'error');
        tbody.innerHTML = '<tr><td colspan="8" class="text-center text-danger">Erro ao carregar agendamentos</td></tr>';
    } finally {
        if (window.loadingStates) window.loadingStates[FUNC_KEY] = false;
    }
}

async function carregarTodosAgendamentos() {
    const FUNC_KEY = 'todosAgendamentos';
    const tbody = document.getElementById('agendamentosTodosBody');
    if (!tbody) return;
    
    if (window.loadingStates?.[FUNC_KEY]) return;
    
    const dataInicio = document.getElementById('filtroAgendamentoDataInicio')?.value || '';
    const dataFim = document.getElementById('filtroAgendamentoDataFim')?.value || '';
    const status = document.getElementById('filtroAgendamentoStatus')?.value || '';
    
    try {
        let url = '/api/agendamentos?';
        if (dataInicio) url += `data_inicio=${dataInicio}&`;
        if (dataFim) url += `data_fim=${dataFim}&`;
        if (status) url += `status=${status}&`;
        
        const res = await fetch(url, {credentials: 'include'});
        if (!res.ok) throw new Error('Erro ao carregar agendamentos');

        const data = await res.json();
        const agendamentos = data.agendamentos || [];

        if (!agendamentos || agendamentos.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">Nenhum agendamento encontrado</td></tr>';
            return;
        }

        tbody.innerHTML = agendamentos.map(ag => {
            const data = new Date(ag.data).toLocaleDateString('pt-BR');
            const statusClass = ag.status === 'Confirmado' ? 'success' : ag.status === 'Cancelado' ? 'danger' : 'warning';
            const tamanho = ag.tamanho || '-';
            return `
                <tr>
                    <td>${data}</td>
                    <td>${ag.horario}</td>
                    <td>${ag.cliente_nome}</td>
                    <td>${ag.servico}</td>
                    <td><span class="badge" style="background: var(--primary); color: white;">${tamanho}</span></td>
                    <td>${ag.profissional}</td>
                    <td><span class="badge ${statusClass}">${ag.status}</span></td>
                    <td>
                        <button class="bioma-btn bioma-btn-sm bioma-btn-outline" onclick="visualizarAgendamento('${ag._id}')">
                            <i class="bi bi-eye"></i>
                        </button>
                        <button class="bioma-btn bioma-btn-sm bioma-btn-primary" onclick="editarAgendamento('${ag._id}')">
                            <i class="bi bi-pencil"></i>
                        </button>
                    </td>
                </tr>
            `;
        }).join('');

    } catch (error) {
        console.error('‚ùå Erro:', error);
        Swal.fire('Erro', 'Falha ao carregar todos os agendamentos', 'error');
        tbody.innerHTML = '<tr><td colspan="8" class="text-center text-danger">Erro ao carregar agendamentos</td></tr>';
    } finally {
        if (window.loadingStates) window.loadingStates[FUNC_KEY] = false;
    }
}
// ========== FIM SUB-TABS AGENDAMENTOS ==========

// ========== SISTEMA DE SUB-TABS - PRODUTOS ====================
async function carregarProdutosTodos() {
    const FUNC_KEY = 'produtosTodos';
    const tbody = document.getElementById('produtosTodosBody');
    if (!tbody) return;
    if (window.loadingStates?.[FUNC_KEY]) return;

    try {
        if (!window.loadingStates) window.loadingStates = {};
        window.loadingStates[FUNC_KEY] = true;

        const res = await fetch('/api/produtos', {credentials: 'include'});
        if (!res.ok) throw new Error('Erro ao carregar produtos');

        const data = await res.json();
        const produtos = data.produtos || data;

        // Armazenar dados globalmente para filtro
        window.produtosTodosData = produtos;

        renderizarTabelaProdutos(produtos, tbody, true);

    } catch (error) {
        console.error('‚ùå Erro:', error);
        Swal.fire('Erro', 'Falha ao carregar produtos', 'error');
        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Erro ao carregar produtos</td></tr>';
    } finally {
        if (window.loadingStates) window.loadingStates[FUNC_KEY] = false;
    }
}

async function carregarProdutosAtivos() {
    const FUNC_KEY = 'produtosAtivos';
    const tbody = document.getElementById('produtosAtivosBody');
    if (!tbody) return;
    if (window.loadingStates?.[FUNC_KEY]) return;
    
    try {
        if (!window.loadingStates) window.loadingStates = {};
        window.loadingStates[FUNC_KEY] = true;
        
        const res = await fetch('/api/produtos?status=Ativo', {credentials: 'include'});
        if (!res.ok) throw new Error('Erro ao carregar produtos');
        
        const data = await res.json();
        const produtos = data.produtos || data;
        
        renderizarTabelaProdutos(produtos, tbody, false);
        
    } catch (error) {
        console.error('‚ùå Erro:', error);
        Swal.fire('Erro', 'Falha ao carregar produtos ativos', 'error');
        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Erro ao carregar produtos</td></tr>';
    } finally {
        if (window.loadingStates) window.loadingStates[FUNC_KEY] = false;
    }
}

async function carregarProdutosInativos() {
    const FUNC_KEY = 'produtosInativos';
    const tbody = document.getElementById('produtosInativosBody');
    if (!tbody) return;
    if (window.loadingStates?.[FUNC_KEY]) return;
    
    try {
        if (!window.loadingStates) window.loadingStates = {};
        window.loadingStates[FUNC_KEY] = true;
        
        const res = await fetch('/api/produtos?status=Inativo', {credentials: 'include'});
        if (!res.ok) throw new Error('Erro ao carregar produtos');
        
        const data = await res.json();
        const produtos = data.produtos || data;
        
        if (!produtos || produtos.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Nenhum produto inativo</td></tr>';
            return;
        }
        
        renderizarTabelaProdutos(produtos, tbody, false);
        
    } catch (error) {
        console.error('‚ùå Erro:', error);
        Swal.fire('Erro', 'Falha ao carregar produtos inativos', 'error');
        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Erro ao carregar produtos</td></tr>';
    } finally {
        if (window.loadingStates) window.loadingStates[FUNC_KEY] = false;
    }
}

function renderizarTabelaProdutos(produtos, tbody, incluirStatus) {
    if (!produtos || produtos.length === 0) {
        const colspan = incluirStatus ? 6 : 5;
        tbody.innerHTML = `<tr><td colspan="${colspan}" class="text-center text-muted">Nenhum produto encontrado</td></tr>`;
        return;
    }
    
    tbody.innerHTML = produtos.map(p => {
        const estoqueClass = p.estoque_atual <= p.estoque_minimo ? 'danger' : 'success';
        const statusBadge = incluirStatus ? `<td><span class="badge ${p.status === 'Ativo' ? 'success' : 'secondary'}">${p.status}</span></td>` : '';
        
        return `
            <tr>
                <td>${p.nome}</td>
                <td>${p.marca || 'N/A'}</td>
                <td>R$ ${parseFloat(p.preco || 0).toFixed(2)}</td>
                <td>
                    <span class="badge ${estoqueClass}" style="cursor: pointer;" onclick="editarEstoqueInline('${p._id}', ${p.estoque_atual || 0})" title="Clique para editar">
                        <i class="bi bi-pencil-square"></i> ${p.estoque_atual || 0}
                    </span>
                </td>
                ${statusBadge}
                <td>
                    <button class="bioma-btn bioma-btn-sm bioma-btn-primary" onclick="editarProduto('${p._id}')" title="Editar produto">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <button class="bioma-btn bioma-btn-sm bioma-btn-info" onclick="editarEstoqueInline('${p._id}', ${p.estoque_atual || 0})" title="Ajustar estoque">
                        <i class="bi bi-box-seam"></i>
                    </button>
                    <button class="bioma-btn bioma-btn-sm bioma-btn-${p.status === 'Ativo' ? 'warning' : 'success'}" onclick="toggleStatusProduto('${p._id}', '${p.status}')" title="${p.status === 'Ativo' ? 'Desativar' : 'Ativar'}">
                        <i class="bi bi-${p.status === 'Ativo' ? 'x' : 'check'}-circle"></i>
                    </button>
                </td>
            </tr>
        `;
    }).join('');
}

function filtrarProdutosTodos() {
    const tbody = document.getElementById('produtosTodosBody');
    const searchInput = document.getElementById('buscaProdutosTodos');
    const statusFilter = document.getElementById('filtroProdutoStatus');

    if (!tbody || !window.produtosTodosData) return;

    const searchTerm = searchInput?.value?.toLowerCase() || '';
    const statusValue = statusFilter?.value || '';

    // Filtrar produtos
    const produtosFiltrados = window.produtosTodosData.filter(produto => {
        // Filtro de busca (nome ou marca)
        const matchSearch = !searchTerm ||
            (produto.nome && produto.nome.toLowerCase().includes(searchTerm)) ||
            (produto.marca && produto.marca.toLowerCase().includes(searchTerm));

        // Filtro de status
        const matchStatus = !statusValue || produto.status === statusValue;

        return matchSearch && matchStatus;
    });

    // Renderizar produtos filtrados
    renderizarTabelaProdutos(produtosFiltrados, tbody, true);
}

function filtrarProdutosAtivos() {
    const termo = document.getElementById('buscaProdutoAtivo')?.value.toLowerCase() || '';
    const tbody = document.getElementById('produtosAtivosBody');

    if (!tbody) return;

    const rows = tbody.querySelectorAll('tr');
    let visibleCount = 0;

    rows.forEach(row => {
        if (row.cells.length <= 1) { // Linha de "nenhum produto"
            row.style.display = visibleCount === 0 ? '' : 'none';
            return;
        }

        const nome = row.cells[0]?.textContent.toLowerCase() || '';
        const marca = row.cells[1]?.textContent.toLowerCase() || '';
        const sku = row.cells[2]?.textContent.toLowerCase() || '';
        const categoria = row.cells[3]?.textContent.toLowerCase() || '';

        if (nome.includes(termo) || marca.includes(termo) ||
            sku.includes(termo) || categoria.includes(termo)) {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    });

    // Atualizar contador se existir
    const counter = document.getElementById('produtosAtivosCont');
    if (counter) {
        counter.textContent = visibleCount;
    }
}

async function toggleStatusProduto(id, statusAtual) {
    const novoStatus = statusAtual === 'Ativo' ? 'Inativo' : 'Ativo';
    const acao = novoStatus === 'Ativo' ? 'ativar' : 'inativar';
    
    const result = await Swal.fire({
        title: `${acao.charAt(0).toUpperCase() + acao.slice(1)} produto?`,
        text: `Voc√™ est√° prestes a ${acao} este produto`,
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: `Sim, ${acao}`,
        cancelButtonText: 'Cancelar'
    });
    
    if (result.isConfirmed) {
        try {
            const res = await fetch(`/api/produtos/${id}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                credentials: 'include',
                body: JSON.stringify({ status: novoStatus })
            });

            if (!res.ok) throw new Error('Erro ao atualizar produto');

            mostrarNotificacao('success', `Produto ${novoStatus.toLowerCase()} com sucesso!`);

            // Recarregar a sub-tab atual
            const activeSubTab = document.querySelector('#section-produtos .sub-tab-btn.active');
            if (activeSubTab) {
                const subtab = activeSubTab.textContent.trim().toLowerCase();
                if (subtab.includes('todos')) carregarProdutosTodos();
                else if (subtab.includes('ativos')) carregarProdutosAtivos();
                else if (subtab.includes('inativos')) carregarProdutosInativos();
            }

        } catch (error) {
            console.error('Erro:', error);
            mostrarNotificacao('error', 'N√£o foi poss√≠vel atualizar o produto');
        }
    }

}
// ========== FIM SUB-TABS PRODUTOS ==========

// ========== SISTEMA DE SUB-TABS - SERVI√áOS ====================
async function carregarServicosTodos() {
    const FUNC_KEY = 'servicosTodos';
    const tbody = document.getElementById('servicosTodosBody');
    if (!tbody) return;
    if (window.loadingStates?.[FUNC_KEY]) return;

    try {
        if (!window.loadingStates) window.loadingStates = {};
        window.loadingStates[FUNC_KEY] = true;

        const res = await fetch('/api/servicos', {credentials: 'include'});
        if (!res.ok) throw new Error('Erro ao carregar servi√ßos');

        const data = await res.json();
        const servicos = data.servicos || data;

        // Armazenar dados globalmente para filtro
        window.servicosTodosData = servicos;

        renderizarTabelaServicos(servicos, tbody, true);

    } catch (error) {
        console.error('‚ùå Erro:', error);
        Swal.fire('Erro', 'Falha ao carregar servi√ßos', 'error');
        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Erro ao carregar servi√ßos</td></tr>';
    } finally {
        if (window.loadingStates) window.loadingStates[FUNC_KEY] = false;
    }
}

async function carregarServicosAtivos() {
    const FUNC_KEY = 'servicosAtivos';
    const tbody = document.getElementById('servicosAtivosBody');
    if (!tbody) return;
    if (window.loadingStates?.[FUNC_KEY]) return;
    
    try {
        if (!window.loadingStates) window.loadingStates = {};
        window.loadingStates[FUNC_KEY] = true;
        
        const res = await fetch('/api/servicos?status=Ativo', {credentials: 'include'});
        if (!res.ok) throw new Error('Erro ao carregar servi√ßos');
        
        const data = await res.json();
        const servicos = data.servicos || data;
        
        renderizarTabelaServicos(servicos, tbody, false);
        
    } catch (error) {
        console.error('‚ùå Erro:', error);
        Swal.fire('Erro', 'Falha ao carregar servi√ßos ativos', 'error');
        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Erro ao carregar servi√ßos</td></tr>';
    } finally {
        if (window.loadingStates) window.loadingStates[FUNC_KEY] = false;
    }
}

async function carregarServicosInativos() {
    const FUNC_KEY = 'servicosInativos';
    const tbody = document.getElementById('servicosInativosBody');
    if (!tbody) return;
    if (window.loadingStates?.[FUNC_KEY]) return;
    
    try {
        if (!window.loadingStates) window.loadingStates = {};
        window.loadingStates[FUNC_KEY] = true;
        
        const res = await fetch('/api/servicos?status=Inativo', {credentials: 'include'});
        if (!res.ok) throw new Error('Erro ao carregar servi√ßos');
        
        const data = await res.json();
        const servicos = data.servicos || data;
        
        if (!servicos || servicos.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Nenhum servi√ßo inativo</td></tr>';
            return;
        }
        
        renderizarTabelaServicos(servicos, tbody, false);
        
    } catch (error) {
        console.error('‚ùå Erro:', error);
        Swal.fire('Erro', 'Falha ao carregar servi√ßos inativos', 'error');
        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Erro ao carregar servi√ßos</td></tr>';
    } finally {
        if (window.loadingStates) window.loadingStates[FUNC_KEY] = false;
    }
}

function renderizarTabelaServicos(servicos, tbody, incluirStatus) {
    if (!servicos || servicos.length === 0) {
        const colspan = incluirStatus ? 6 : 5;
        tbody.innerHTML = `<tr><td colspan="${colspan}" class="text-center text-muted">Nenhum servi√ßo encontrado</td></tr>`;
        return;
    }
    
    tbody.innerHTML = servicos.map(s => {
        const statusBadge = incluirStatus ? `<td><span class="badge ${s.status === 'Ativo' ? 'success' : 'secondary'}">${s.status}</span></td>` : '';
        
        return `
            <tr>
                <td>${s.nome}</td>
                <td>${s.categoria || 'N/A'}</td>
                <td>${s.tamanho || 'N/A'}</td>
                <td>R$ ${parseFloat(s.preco || 0).toFixed(2)}</td>
                ${statusBadge}
                <td>
                    <button class="bioma-btn bioma-btn-sm bioma-btn-outline" onclick="editarServico('${s._id}')">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <button class="bioma-btn bioma-btn-sm bioma-btn-${s.status === 'Ativo' ? 'warning' : 'success'}" onclick="toggleStatusServico('${s._id}', '${s.status}')">
                        <i class="bi bi-${s.status === 'Ativo' ? 'x' : 'check'}-circle"></i>
                    </button>
                </td>
            </tr>
        `;
    }).join('');
}

function filtrarServicosTodos() {
    const tbody = document.getElementById('servicosTodosBody');
    const searchInput = document.getElementById('buscaServicosTodos');
    const categoriaFilter = document.getElementById('filtroCategoria');

    if (!tbody || !window.servicosTodosData) return;

    const searchTerm = searchInput?.value?.toLowerCase() || '';
    const categoriaValue = categoriaFilter?.value || '';

    // Filtrar servi√ßos
    const servicosFiltrados = window.servicosTodosData.filter(servico => {
        // Filtro de busca (nome ou categoria)
        const matchSearch = !searchTerm ||
            (servico.nome && servico.nome.toLowerCase().includes(searchTerm)) ||
            (servico.categoria && servico.categoria.toLowerCase().includes(searchTerm));

        // Filtro de categoria
        const matchCategoria = !categoriaValue || servico.categoria === categoriaValue;

        return matchSearch && matchCategoria;
    });

    // Renderizar servi√ßos filtrados
    renderizarTabelaServicos(servicosFiltrados, tbody, true);
}

function filtrarServicosAtivos() {
    const termo = document.getElementById('buscaServicoAtivo')?.value.toLowerCase() || '';
    const tbody = document.getElementById('servicosAtivosBody');

    if (!tbody) return;

    const rows = tbody.querySelectorAll('tr');
    let visibleCount = 0;

    rows.forEach(row => {
        if (row.cells.length <= 1) { // Linha de "nenhum servi√ßo"
            row.style.display = visibleCount === 0 ? '' : 'none';
            return;
        }

        const nome = row.cells[0]?.textContent.toLowerCase() || '';
        const tamanho = row.cells[1]?.textContent.toLowerCase() || '';
        const categoria = row.cells[2]?.textContent.toLowerCase() || '';
        const preco = row.cells[3]?.textContent.toLowerCase() || '';

        if (nome.includes(termo) || tamanho.includes(termo) ||
            categoria.includes(termo) || preco.includes(termo)) {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    });

    // Atualizar contador se existir
    const counter = document.getElementById('servicosAtivosCont');
    if (counter) {
        counter.textContent = visibleCount;
    }
}

async function toggleStatusServico(id, statusAtual) {
    const novoStatus = statusAtual === 'Ativo' ? 'Inativo' : 'Ativo';
    const acao = novoStatus === 'Ativo' ? 'ativar' : 'inativar';
    
    const result = await Swal.fire({
        title: `${acao.charAt(0).toUpperCase() + acao.slice(1)} servi√ßo?`,
        text: `Voc√™ est√° prestes a ${acao} este servi√ßo`,
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: `Sim, ${acao}`,
        cancelButtonText: 'Cancelar'
    });
    
    if (result.isConfirmed) {
        try {
            const res = await fetch(`/api/servicos/${id}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                credentials: 'include',
                body: JSON.stringify({ status: novoStatus })
            });

            if (!res.ok) throw new Error('Erro ao atualizar servi√ßo');

            mostrarNotificacao('success', `Servi√ßo ${novoStatus.toLowerCase()} com sucesso!`);

            // Recarregar a sub-tab atual
            const activeSubTab = document.querySelector('#section-servicos .sub-tab-btn.active');
            if (activeSubTab) {
                const subtab = activeSubTab.textContent.trim().toLowerCase();
                if (subtab.includes('todos')) carregarServicosTodos();
                else if (subtab.includes('ativos')) carregarServicosAtivos();
                else if (subtab.includes('inativos')) carregarServicosInativos();
            }

        } catch (error) {
            console.error('Erro:', error);
            mostrarNotificacao('error', 'N√£o foi poss√≠vel atualizar o servi√ßo');
        }
    }

}
// ========== FIM SUB-TABS SERVI√áOS ==========

// ========== SISTEMA DE SUB-TABS - ESTOQUE ====================
async function carregarEstoqueVisaoGeral() {
    const FUNC_KEY = 'estoqueVisaoGeral';
    if (window.loadingStates?.[FUNC_KEY]) {
        console.warn('‚ö†Ô∏è carregarEstoqueVisaoGeral j√° est√° em execu√ß√£o');
        return;
    }

    try {
        if (!window.loadingStates) window.loadingStates = {};
        window.loadingStates[FUNC_KEY] = true;

        console.log('üì¶ Carregando vis√£o geral do estoque...');

        // Verificar Chart.js
        if (!window.Chart) {
            console.error('‚ùå Chart.js n√£o est√° carregado!');
            return;
        }

        // Buscar produtos para estat√≠sticas
        const prodRes = await fetch('/api/produtos', {credentials: 'include'});

        if (!prodRes.ok) {
            console.error(`‚ùå Erro HTTP ao buscar produtos: ${prodRes.status}`);
            throw new Error(`Erro ${prodRes.status}: Falha ao carregar produtos`);
        }

        const prodData = await prodRes.json();
        console.log('üì¶ Produtos recebidos:', { success: prodData.success, total: prodData.produtos?.length });

        // Buscar movimenta√ß√µes do m√™s
        const hoje = new Date();
        const inicioMes = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
        const movRes = await fetch(`/api/estoque/movimentacoes?data_inicio=${inicioMes.toISOString()}&per_page=10000`, {credentials: 'include'});

        if (!movRes.ok) {
            console.warn(`‚ö†Ô∏è Erro HTTP ao buscar movimenta√ß√µes: ${movRes.status}`);
        }

        const movData = await movRes.json();
        console.log('üì¶ Movimenta√ß√µes recebidas:', { success: movData.success, total: movData.movimentacoes?.length });

        // Atualizar cards de estat√≠sticas
        if (prodData.success && prodData.produtos) {
            const produtos = prodData.produtos;

            const totalProdutosEl = document.getElementById('totalProdutosEstoque');
            const valorTotalEl = document.getElementById('valorTotalEstoque');
            const abaixoMinimoEl = document.getElementById('itensAbaixoMinimo');

            if (totalProdutosEl) {
                totalProdutosEl.textContent = produtos.length;
            }

            // Valor total em estoque
            const valorTotal = produtos.reduce((sum, p) => {
                const preco = parseFloat(p.preco || 0);
                const quantidade = parseFloat(p.quantidade || p.estoque || 0);
                return sum + (preco * quantidade);
            }, 0);

            if (valorTotalEl) {
                valorTotalEl.textContent = `R$ ${valorTotal.toFixed(2).replace('.', ',')}`;
            }

            // Produtos abaixo do m√≠nimo
            const abaixoMinimo = produtos.filter(p => {
                const estoque = parseFloat(p.quantidade || p.estoque || 0);
                const minimo = parseFloat(p.estoque_minimo || 0);
                return estoque < minimo && minimo > 0;
            }).length;

            if (abaixoMinimoEl) {
                abaixoMinimoEl.textContent = abaixoMinimo;
            }

            console.log('‚úÖ Cards atualizados:', {
                total_produtos: produtos.length,
                valor_total: valorTotal,
                abaixo_minimo: abaixoMinimo
            });
        }

        // Movimenta√ß√µes do m√™s
        const movimentacoesEl = document.getElementById('movimentacoesEstoque');
        if (movData.success && movData.movimentacoes) {
            if (movimentacoesEl) {
                movimentacoesEl.textContent = movData.movimentacoes.length;
            }

            // Popula tabela de √öltimas Movimenta√ß√µes
            const ultimasMovBody = document.getElementById('estoqueUltimasMovimentacoesVisaoGeral');
            if (ultimasMovBody && movData.movimentacoes.length > 0) {
                // Ordenar por data (mais recentes primeiro) e pegar s√≥ as 10 primeiras
                const movimentacoesRecentes = [...movData.movimentacoes]
                    .sort((a, b) => {
                        const dateA = new Date(a.data || a.data_movimentacao || a.created_at);
                        const dateB = new Date(b.data || b.data_movimentacao || b.created_at);
                        return dateB - dateA; // Descendente
                    })
                    .slice(0, 10);

                ultimasMovBody.innerHTML = movimentacoesRecentes.map(mov => {
                    try {
                        // Extrair informa√ß√µes com fallbacks
                        const data = mov.data || mov.data_movimentacao || mov.created_at || 'N/A';
                        const produtoNome = mov.produto_nome || mov.produto?.nome || mov.descricao || 'Produto desconhecido';
                        const tipo = mov.tipo || 'N/A';
                        const quantidade = mov.quantidade ?? mov.qtd ?? 0;
                        const responsavel = mov.responsavel || mov.usuario || mov.profissional || 'Sistema';

                        // Formatar data
                        let dataFormatada = 'N/A';
                        try {
                            if (data !== 'N/A') {
                                const dt = new Date(data);
                                if (!isNaN(dt.getTime())) {
                                    dataFormatada = dt.toLocaleDateString('pt-BR', {
                                        day: '2-digit',
                                        month: '2-digit',
                                        year: 'numeric',
                                        hour: '2-digit',
                                        minute: '2-digit'
                                    });
                                }
                            }
                        } catch (e) {
                            console.warn('Erro ao formatar data:', e);
                        }

                        // Badge de tipo com cor
                        const tipoLower = String(tipo).toLowerCase();
                        let tipoBadgeClass = 'secondary';
                        if (tipoLower.includes('entrada')) {
                            tipoBadgeClass = 'success';
                        } else if (tipoLower.includes('saida') || tipoLower.includes('sa√≠da')) {
                            tipoBadgeClass = 'danger';
                        }

                        return `
                            <tr>
                                <td>${dataFormatada}</td>
                                <td>${produtoNome}</td>
                                <td><span class="badge ${tipoBadgeClass}">${tipo}</span></td>
                                <td>${quantidade}</td>
                                <td>${responsavel}</td>
                            </tr>
                        `;
                    } catch (err) {
                        console.error('Erro ao renderizar movimenta√ß√£o:', err, mov);
                        return '<tr><td colspan="5" class="text-center text-danger">Erro ao carregar movimenta√ß√£o</td></tr>';
                    }
                }).join('');

                console.log(`‚úÖ Tabela de √öltimas Movimenta√ß√µes populada com ${movimentacoesRecentes.length} registros`);
            } else if (ultimasMovBody) {
                ultimasMovBody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Nenhuma movimenta√ß√£o recente</td></tr>';
            }

            console.log('üìä Preparando gr√°ficos do estoque...');

            // IMPORTANTE: setTimeout para garantir que canvas est√° vis√≠vel
            setTimeout(() => {
                try {
                    // Criar gr√°fico de Resumo de Movimenta√ß√µes
                    const entradas = movData.movimentacoes.filter(m => m.tipo === 'entrada' || m.tipo === 'Entrada').length;
                    const saidas = movData.movimentacoes.filter(m => m.tipo === 'saida' || m.tipo === 'sa√≠da' || m.tipo === 'Saida' || m.tipo === 'Sa√≠da').length;

                    console.log(`üìä Movimenta√ß√µes: ${entradas} entradas, ${saidas} sa√≠das`);

                    const ctxMovimentacoes = document.getElementById('chartEstoqueVisaoGeral');
                    if (!ctxMovimentacoes) {
                        console.warn('‚ö†Ô∏è Canvas chartEstoqueVisaoGeral n√£o encontrado');
                    } else {
                        if (window.chartEstoqueVisaoGeralInstance) {
                            window.chartEstoqueVisaoGeralInstance.destroy();
                        }

                        window.chartEstoqueVisaoGeralInstance = new Chart(ctxMovimentacoes, {
                            type: 'bar',
                            data: {
                                labels: ['Entradas', 'Sa√≠das'],
                                datasets: [{
                                    label: 'Movimenta√ß√µes do M√™s',
                                    data: [entradas, saidas],
                                    backgroundColor: [
                                        'rgba(16, 185, 129, 0.7)',
                                        'rgba(239, 68, 68, 0.7)'
                                    ],
                                    borderColor: [
                                        'rgba(16, 185, 129, 1)',
                                        'rgba(239, 68, 68, 1)'
                                    ],
                                    borderWidth: 2,
                                    borderRadius: 6
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: true,
                                plugins: {
                                    legend: {
                                        display: true,
                                        position: 'top'
                                    },
                                    tooltip: {
                                        callbacks: {
                                            label: function(context) {
                                                return `${context.label}: ${context.parsed.y} movimenta√ß√µes`;
                                            }
                                        }
                                    }
                                },
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        ticks: {
                                            precision: 0,
                                            callback: function(value) {
                                                return value + ' mov.';
                                            }
                                        }
                                    }
                                }
                            }
                        });

                        console.log('‚úÖ Gr√°fico de movimenta√ß√µes renderizado');
                    }
                } catch (chartErr) {
                    console.error('‚ùå Erro ao criar gr√°fico de movimenta√ß√µes:', chartErr);
                }
            }, 50);
        } else {
            console.warn('‚ö†Ô∏è Sem dados de movimenta√ß√µes para o gr√°fico');
        }

        // Criar gr√°fico de Distribui√ß√£o (Produtos por Status)
        if (prodData.success && prodData.produtos) {
            // setTimeout para garantir renderiza√ß√£o correta
            setTimeout(() => {
                try {
                    const produtos = prodData.produtos;

                    const disponiveis = produtos.filter(p => {
                        const estoque = parseFloat(p.quantidade || p.estoque || 0);
                        const minimo = parseFloat(p.estoque_minimo || 0);
                        return estoque >= (minimo * 1.5);
                    }).length;

                    const baixo = produtos.filter(p => {
                        const estoque = parseFloat(p.quantidade || p.estoque || 0);
                        const minimo = parseFloat(p.estoque_minimo || 0);
                        return estoque >= minimo && estoque < (minimo * 1.5) && minimo > 0;
                    }).length;

                    const critico = produtos.filter(p => {
                        const estoque = parseFloat(p.quantidade || p.estoque || 0);
                        const minimo = parseFloat(p.estoque_minimo || 0);
                        return estoque < minimo && minimo > 0;
                    }).length;

                    console.log(`üìä Distribui√ß√£o: ${disponiveis} dispon√≠veis, ${baixo} baixo, ${critico} cr√≠tico`);

                    const ctxDistribuicao = document.getElementById('chartDistribuicaoEstoque');
                    if (!ctxDistribuicao) {
                        console.warn('‚ö†Ô∏è Canvas chartDistribuicaoEstoque n√£o encontrado');
                        // Tentar inserir mensagem alternativa
                        const parent = document.querySelector('[id*="chartDistribuicaoEstoque"]')?.parentElement;
                        if (parent) {
                            parent.innerHTML = `
                                <div style="text-align: center; padding: 30px;">
                                    <i class="bi bi-graph-down" style="font-size: 2.5rem; color: var(--text-muted); opacity: 0.5;"></i>
                                    <p style="margin-top: 12px; color: var(--text-muted);">Gr√°fico n√£o dispon√≠vel</p>
                                </div>
                            `;
                        }
                    } else {
                        // Verificar se h√° produtos para mostrar
                        const totalProdutos = disponiveis + baixo + critico;

                        if (totalProdutos === 0) {
                            console.log('‚ö†Ô∏è Nenhum produto cadastrado - mostrando mensagem');
                            ctxDistribuicao.style.display = 'none';
                            const parent = ctxDistribuicao.parentElement;
                            if (parent) {
                                parent.innerHTML = `
                                    <div style="text-align: center; padding: 30px;">
                                        <i class="bi bi-box-seam" style="font-size: 2.5rem; color: #F59E0B; opacity: 0.6;"></i>
                                        <p style="margin-top: 12px; font-weight: 600; color: #D97706;">Nenhum Produto Cadastrado</p>
                                        <p style="font-size: 0.85rem; margin-top: 5px; color: var(--text-muted);">
                                            Cadastre produtos no estoque para visualizar a distribui√ß√£o
                                        </p>
                                    </div>
                                `;
                            }
                        } else {
                            if (window.chartDistribuicaoEstoqueInstance) {
                                window.chartDistribuicaoEstoqueInstance.destroy();
                            }

                            window.chartDistribuicaoEstoqueInstance = new Chart(ctxDistribuicao, {
                                type: 'doughnut',
                                data: {
                                    labels: ['Dispon√≠vel', 'Estoque Baixo', 'Cr√≠tico'],
                                    datasets: [{
                                        label: 'Produtos',
                                        data: [disponiveis, baixo, critico],
                                        backgroundColor: [
                                            'rgba(16, 185, 129, 0.8)',
                                            'rgba(245, 158, 11, 0.8)',
                                            'rgba(239, 68, 68, 0.8)'
                                        ],
                                        borderColor: [
                                            'rgba(16, 185, 129, 1)',
                                            'rgba(245, 158, 11, 1)',
                                            'rgba(239, 68, 68, 1)'
                                        ],
                                        borderWidth: 2
                                    }]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: true,
                                    plugins: {
                                        legend: {
                                            position: 'bottom',
                                            labels: {
                                                font: { size: 12, weight: 'bold' }
                                            }
                                        },
                                        tooltip: {
                                            callbacks: {
                                                label: function(context) {
                                                    const label = context.label || '';
                                                    const value = context.parsed || 0;
                                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                                    return `${label}: ${value} produtos (${percentage}%)`;
                                                }
                                            }
                                        }
                                    }
                                }
                            });

                            console.log('‚úÖ Gr√°fico de distribui√ß√£o renderizado com sucesso!');
                        }
                    }
                } catch (chartErr) {
                    console.error('‚ùå Erro ao criar gr√°fico de distribui√ß√£o:', chartErr);
                }
            }, 50);
        } else {
            console.warn('‚ö†Ô∏è Sem dados de produtos para o gr√°fico de distribui√ß√£o');
        }

        console.log('‚úÖ Vis√£o geral do estoque carregada completamente');

    } catch (error) {
        console.error('‚ùå Erro ao carregar vis√£o geral do estoque:', error);
        toast('‚ùå Erro ao carregar vis√£o geral do estoque', 'error');

        // Mostrar valores zerados em caso de erro
        const zeroElements = {
            totalProdutosEstoque: document.getElementById('totalProdutosEstoque'),
            valorTotalEstoque: document.getElementById('valorTotalEstoque'),
            itensAbaixoMinimo: document.getElementById('itensAbaixoMinimo'),
            movimentacoesEstoque: document.getElementById('movimentacoesEstoque')
        };

        if (zeroElements.totalProdutosEstoque) zeroElements.totalProdutosEstoque.textContent = '0';
        if (zeroElements.valorTotalEstoque) zeroElements.valorTotalEstoque.textContent = 'R$ 0,00';
        if (zeroElements.itensAbaixoMinimo) zeroElements.itensAbaixoMinimo.textContent = '0';
        if (zeroElements.movimentacoesEstoque) zeroElements.movimentacoesEstoque.textContent = '0';

    } finally {
        if (window.loadingStates) window.loadingStates[FUNC_KEY] = false;
    }
}

async function carregarMovimentacoesEstoque() {
    const FUNC_KEY = 'movimentacoesEstoque';
    const tbody = document.getElementById('estoqueMovimentacoesBody');
    if (!tbody) return;
    if (window.loadingStates?.[FUNC_KEY]) return;
    
    try {
        if (!window.loadingStates) window.loadingStates = {};
        window.loadingStates[FUNC_KEY] = true;
        
        const tipo = document.getElementById('filtroTipoMov')?.value || '';
        const dataInicio = document.getElementById('filtroDataInicioMov')?.value || '';
        const dataFim = document.getElementById('filtroDataFimMov')?.value || '';
        
        let url = '/api/estoque/movimentacoes?';
        if (tipo) url += `tipo=${tipo}&`;
        if (dataInicio) url += `data_inicio=${dataInicio}&`;
        if (dataFim) url += `data_fim=${dataFim}&`;
        
        const res = await fetch(url, {credentials: 'include'});
        if (!res.ok) throw new Error('Erro ao carregar movimenta√ß√µes');

        const data = await res.json();
        const movimentacoes = data.movimentacoes || [];

        if (!movimentacoes || movimentacoes.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Nenhuma movimenta√ß√£o encontrada</td></tr>';
            return;
        }
        
        tbody.innerHTML = movimentacoes.map(m => {
            const data = new Date(m.data).toLocaleDateString('pt-BR');
            const tipoClass = m.tipo === 'entrada' ? 'success' : 'danger';
            const tipoIcon = m.tipo === 'entrada' ? 'arrow-down-circle' : 'arrow-up-circle';
            
            return `
                <tr>
                    <td>${data}</td>
                    <td><span class="badge ${tipoClass}"><i class="bi bi-${tipoIcon}"></i> ${m.tipo.toUpperCase()}</span></td>
                    <td>${m.produto_nome}</td>
                    <td>${m.quantidade}</td>
                    <td>${m.motivo || 'N/A'}</td>
                    <td>${m.responsavel || 'N/A'}</td>
                </tr>
            `;
        }).join('');
        
    } catch (error) {
        console.error('‚ùå Erro:', error);
        Swal.fire('Erro', 'Falha ao carregar movimenta√ß√µes de estoque', 'error');
        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Erro ao carregar movimenta√ß√µes</td></tr>';
    } finally {
        if (window.loadingStates) window.loadingStates[FUNC_KEY] = false;
    }
}

async function carregarRelatoriosEstoque() {
    const FUNC_KEY = 'relatoriosEstoque';
    if (window.loadingStates?.[FUNC_KEY]) return;
    
    try {
        if (!window.loadingStates) window.loadingStates = {};
        window.loadingStates[FUNC_KEY] = true;
        
        // Inicializar gr√°ficos se necess√°rio
        console.log('üìä Relat√≥rios de estoque carregados');
        
    } catch (error) {
        console.error('‚ùå Erro:', error);
        Swal.fire('Erro', 'Falha ao carregar relat√≥rios', 'error');
    } finally {
        if (window.loadingStates) window.loadingStates[FUNC_KEY] = false;
    }
}

function filtrarEstoqueGeral() {
    // Implementar filtro local
}

async function gerarRelatorioEstoque() {
    const dataInicio = document.getElementById('relatorioDataInicio')?.value;
    const dataFim = document.getElementById('relatorioDataFim')?.value;
    const tipo = document.getElementById('relatorioTipo')?.value || 'movimentacoes';
    
    if (!dataInicio || !dataFim) {
        Swal.fire('Aten√ß√£o', 'Selecione o per√≠odo do relat√≥rio', 'warning');
        return;
    }
    
    try {
        const url = `/api/estoque/relatorio?tipo=${tipo}&data_inicio=${dataInicio}&data_fim=${dataFim}`;
        const res = await fetch(url, {credentials: 'include'});
        if (!res.ok) throw new Error('Erro ao gerar relat√≥rio');
        
        const data = await res.json();
        
        // Exibir resultados
        const resultadosDiv = document.getElementById('relatorioEstoqueResultados');
        resultadosDiv.style.display = 'block';
        resultadosDiv.innerHTML = `
            <div class="alert alert-success">
                <h5><i class="bi bi-check-circle"></i> Relat√≥rio Gerado!</h5>
                <p>Per√≠odo: ${new Date(dataInicio).toLocaleDateString('pt-BR')} a ${new Date(dataFim).toLocaleDateString('pt-BR')}</p>
                <p>Total de registros: ${data.total || 0}</p>
            </div>
        `;
        
        Swal.fire('Sucesso', 'Relat√≥rio gerado com sucesso!', 'success');
        
    } catch (error) {
        console.error('Erro:', error);
        Swal.fire('Erro', 'N√£o foi poss√≠vel gerar o relat√≥rio', 'error');
    }
}

async function exportarRelatorioPDF() {
    Swal.fire('Info', 'Funcionalidade de exporta√ß√£o PDF ser√° implementada em breve', 'info');
}
// ========== FIM SUB-TABS ESTOQUE ==========

// ========== STUB FUNCTIONS FOR MISSING SUB-TAB LOADERS ==========
// TODO: Implementar estas fun√ß√µes completamente quando os endpoints estiverem prontos

async function carregarProdutosEstoque() {
    console.log('üì¶ Carregando produtos do estoque...');
    const tbody = document.getElementById('estoqueProdutosBody');

    if(!tbody){
        console.error('tbody estoqueProdutosBody n√£o encontrado');
        return;
    }

    try{
        tbody.innerHTML = '<tr><td colspan="8" class="text-center"><div class="spinner"></div></td></tr>';

        const res = await fetch('/api/produtos', {credentials: 'include'});
        const data = await res.json();

        if(data.success && data.produtos && data.produtos.length > 0){
            // Armazenar produtos para filtro de busca
            window.produtosEstoqueData = data.produtos;

            tbody.innerHTML = data.produtos.map(prod => {
                const quantidade = prod.quantidade || 0;
                const minimo = prod.estoque_minimo || 0;
                const preco = parseFloat(prod.preco || 0);
                const valorTotal = quantidade * preco;

                // L√ìGICA V6.0: < 5 = Vermelho Pulsante, >= 5 = Verde
                let statusBadge = '';
                let statusClass = '';

                if(quantidade < 5){
                    statusBadge = '<span class="badge badge-pulse-danger">Cr√≠tico</span>';
                    statusClass = 'text-danger';
                } else {
                    statusBadge = '<span class="badge success">Dispon√≠vel</span>';
                    statusClass = '';
                }

                return `
                    <tr class="${statusClass}">
                        <td><strong>${prod.nome || 'N/A'}</strong></td>
                        <td>${prod.marca || 'N/A'}</td>
                        <td>${prod.sku || 'N/A'}</td>
                        <td><strong>${quantidade}</strong></td>
                        <td>${minimo}</td>
                        <td>R$ ${preco.toFixed(2)}</td>
                        <td><strong>R$ ${valorTotal.toFixed(2)}</strong></td>
                        <td>${statusBadge}</td>
                        <td>
                            <button class="bioma-btn bioma-btn-sm bioma-btn-primary" onclick="editarEstoqueProduto('${prod._id}')" title="Editar Estoque">
                                <i class="bi bi-pencil"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');

            console.log(`‚úÖ ${data.produtos.length} produtos carregados no estoque`);
        } else {
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" class="text-center" style="padding: 40px; color: var(--text-muted);">
                        <i class="bi bi-inbox" style="font-size: 3rem; opacity: 0.3;"></i>
                        <p style="margin-top: 15px;">Nenhum produto cadastrado no sistema</p>
                    </td>
                </tr>
            `;
        }
    }catch(err){
        console.error('Erro ao carregar produtos do estoque:', err);
        tbody.innerHTML = `
            <tr>
                <td colspan="8" class="text-center text-danger" style="padding: 40px;">
                    <i class="bi bi-exclamation-triangle" style="font-size: 3rem;"></i>
                    <p style="margin-top: 15px;">Erro ao carregar produtos</p>
                </td>
            </tr>
        `;
    }
}

// Fun√ß√£o para editar estoque de produto
async function editarEstoqueProduto(id) {
    try {
        // Buscar dados do produto
        const res = await fetch(`/api/produtos/${id}`, { credentials: 'include' });
        const data = await res.json();

        if (!data.success || !data.produto) {
            throw new Error('Produto n√£o encontrado');
        }

        const p = data.produto;

        // Criar formul√°rio de edi√ß√£o de estoque
        const html = `
            <div class="text-start">
                <div class="alert alert-info mb-3">
                    <strong>${p.nome}</strong> ${p.marca ? `- ${p.marca}` : ''}
                    <br>Estoque atual: <strong>${p.estoque || 0}</strong>
                </div>
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">Tipo de Movimenta√ß√£o *</label>
                        <select id="swal-tipo-movimento" class="form-select" onchange="toggleMovimentacaoFields()">
                            <option value="">Selecione...</option>
                            <option value="entrada">‚úÖ Entrada</option>
                            <option value="saida">üì§ Sa√≠da</option>
                            <option value="ajuste">üîß Ajuste Manual</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Quantidade *</label>
                        <input type="number" id="swal-quantidade" class="form-control" min="1" placeholder="0">
                    </div>
                    <div class="col-md-12" id="campo-novo-estoque" style="display: none;">
                        <label class="form-label">Novo Estoque (Ajuste Manual)</label>
                        <input type="number" id="swal-novo-estoque" class="form-control" min="0" placeholder="${p.estoque || 0}">
                    </div>
                    <div class="col-md-12">
                        <label class="form-label">Motivo/Observa√ß√£o</label>
                        <textarea id="swal-motivo" class="form-control" rows="2" placeholder="Ex: Compra, venda, quebra, ajuste de invent√°rio..."></textarea>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Nota Fiscal</label>
                        <input type="text" id="swal-nota-fiscal" class="form-control" placeholder="N√∫mero da NF (opcional)">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Fornecedor</label>
                        <input type="text" id="swal-fornecedor" class="form-control" placeholder="Nome do fornecedor (opcional)">
                    </div>
                </div>
            </div>
        `;

        // Script para alternar campos baseado no tipo de movimenta√ß√£o
        window.toggleMovimentacaoFields = function() {
            const tipo = document.getElementById('swal-tipo-movimento').value;
            const campoNovoEstoque = document.getElementById('campo-novo-estoque');
            const campoQuantidade = document.getElementById('swal-quantidade').parentElement.parentElement;

            if (tipo === 'ajuste') {
                campoNovoEstoque.style.display = 'block';
                campoQuantidade.style.display = 'none';
            } else {
                campoNovoEstoque.style.display = 'none';
                campoQuantidade.style.display = 'block';
            }
        };

        const result = await Swal.fire({
            title: 'üì¶ Movimenta√ß√£o de Estoque',
            html: html,
            width: '700px',
            showCancelButton: true,
            confirmButtonText: 'Confirmar Movimenta√ß√£o',
            cancelButtonText: 'Cancelar',
            confirmButtonColor: '#7C3AED',
            preConfirm: () => {
                const tipo = document.getElementById('swal-tipo-movimento').value;
                const quantidade = document.getElementById('swal-quantidade').value;
                const novoEstoque = document.getElementById('swal-novo-estoque').value;
                const motivo = document.getElementById('swal-motivo').value.trim();

                if (!tipo) {
                    Swal.showValidationMessage('Selecione o tipo de movimenta√ß√£o');
                    return false;
                }

                if (tipo === 'ajuste') {
                    if (!novoEstoque && novoEstoque !== 0) {
                        Swal.showValidationMessage('Informe o novo valor do estoque');
                        return false;
                    }
                } else {
                    if (!quantidade || quantidade <= 0) {
                        Swal.showValidationMessage('Quantidade deve ser maior que zero');
                        return false;
                    }
                }

                if (!motivo) {
                    Swal.showValidationMessage('Informe o motivo da movimenta√ß√£o');
                    return false;
                }

                return {
                    tipo: tipo,
                    quantidade: tipo === 'ajuste' ? (parseInt(novoEstoque) - p.estoque) : parseInt(quantidade),
                    novo_estoque: tipo === 'ajuste' ? parseInt(novoEstoque) : null,
                    motivo: motivo,
                    nota_fiscal: document.getElementById('swal-nota-fiscal').value.trim(),
                    fornecedor: document.getElementById('swal-fornecedor').value.trim(),
                    produto_id: id,
                    produto_nome: p.nome
                };
            }
        });

        if (result.isConfirmed) {
            try {
                // Registrar movimenta√ß√£o
                const movRes = await fetch('/api/estoque/movimentacao', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(result.value)
                });

                const movData = await movRes.json();

                if (movData.success) {
                    // Atualizar estoque do produto
                    let novoEstoque;
                    if (result.value.tipo === 'ajuste') {
                        novoEstoque = result.value.novo_estoque;
                    } else if (result.value.tipo === 'entrada') {
                        novoEstoque = (p.estoque || 0) + result.value.quantidade;
                    } else {
                        novoEstoque = Math.max(0, (p.estoque || 0) - result.value.quantidade);
                    }

                    const updateRes = await fetch(`/api/produtos/${id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({ estoque: novoEstoque })
                    });

                    const updateData = await updateRes.json();

                    if (updateData.success) {
                        Swal.fire({
                            icon: 'success',
                            title: 'Movimenta√ß√£o Registrada!',
                            text: `Estoque atualizado: ${p.estoque || 0} ‚Üí ${novoEstoque}`,
                            timer: 2000
                        });

                        // Recarregar lista de produtos do estoque
                        carregarProdutosEstoque();

                        // Se estiver na aba de vis√£o geral, atualizar tamb√©m
                        if (document.getElementById('totalProdutosEstoque')) {
                            loadEstoqueResumo();
                        }
                    } else {
                        throw new Error(updateData.message || 'Erro ao atualizar estoque');
                    }
                } else {
                    throw new Error(movData.message || 'Erro ao registrar movimenta√ß√£o');
                }
            } catch (error) {
                console.error('‚ùå Erro ao processar movimenta√ß√£o:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Erro',
                    text: error.message || 'N√£o foi poss√≠vel processar a movimenta√ß√£o'
                });
            }
        }

    } catch (error) {
        console.error('‚ùå Erro ao carregar produto para edi√ß√£o de estoque:', error);
        Swal.fire({
            icon: 'error',
            title: 'Erro',
            text: error.message || 'N√£o foi poss√≠vel carregar os detalhes do produto'
        });
    }
}

function filtrarProdutosEstoque(){
    const busca = document.getElementById('buscaProdutosEstoque').value.toLowerCase();
    const tbody = document.getElementById('estoqueProdutosBody');

    if(!window.produtosEstoqueData || window.produtosEstoqueData.length === 0){
        console.warn('Nenhum produto dispon√≠vel para filtrar');
        return;
    }

    const produtosFiltrados = window.produtosEstoqueData.filter(prod => {
        const nome = (prod.nome || '').toLowerCase();
        const marca = (prod.marca || '').toLowerCase();
        const sku = (prod.sku || '').toLowerCase();
        return nome.includes(busca) || marca.includes(busca) || sku.includes(busca);
    });

    if(produtosFiltrados.length > 0){
        tbody.innerHTML = produtosFiltrados.map(prod => {
            const quantidade = prod.quantidade || 0;
            const minimo = prod.estoque_minimo || 0;
            const preco = parseFloat(prod.preco || 0);
            const valorTotal = quantidade * preco;

            let statusBadge = '';
            let statusClass = '';

            // L√ìGICA V6.0: < 5 = Vermelho Pulsante, >= 5 = Verde
            if(quantidade < 5){
                statusBadge = '<span class="badge badge-pulse-danger">Cr√≠tico</span>';
                statusClass = 'text-danger';
            } else {
                statusBadge = '<span class="badge success">Dispon√≠vel</span>';
                statusClass = '';
            }

            return `
                <tr class="${statusClass}">
                    <td><strong>${prod.nome || 'N/A'}</strong></td>
                    <td>${prod.marca || 'N/A'}</td>
                    <td>${prod.sku || 'N/A'}</td>
                    <td><strong>${quantidade}</strong></td>
                    <td>${minimo}</td>
                    <td>R$ ${preco.toFixed(2)}</td>
                    <td><strong>R$ ${valorTotal.toFixed(2)}</strong></td>
                    <td>${statusBadge}</td>
                </tr>
            `;
        }).join('');
    } else {
        tbody.innerHTML = `
            <tr>
                <td colspan="8" class="text-center" style="padding: 40px; color: var(--text-muted);">
                    <i class="bi bi-search" style="font-size: 3rem; opacity: 0.3;"></i>
                    <p style="margin-top: 15px;">Nenhum produto encontrado com "${document.getElementById('buscaProdutosEstoque').value}"</p>
                </td>
            </tr>
        `;
    }
}

async function carregarComissoesProfissionais(){
    console.log('üí∞ Inicializando se√ß√£o de comiss√µes dos profissionais...');

    try{
        // Carregar lista de profissionais no dropdown
        const resProfissionais = await fetch('/api/profissionais', {credentials: 'include'});
        const dataProfissionais = await resProfissionais.json();

        const selectProfissional = document.getElementById('filtroComissoesProfissional');

        if(selectProfissional && dataProfissionais.success){
            selectProfissional.innerHTML = '<option value="">Selecione um profissional</option>';

            (dataProfissionais.profissionais || []).forEach(prof => {
                const option = document.createElement('option');
                option.value = prof._id;
                option.textContent = `${prof.nome} (${prof.especialidade || 'N/A'})`;
                selectProfissional.appendChild(option);
            });

            console.log(`‚úÖ ${dataProfissionais.profissionais.length} profissionais carregados no filtro`);
        }

        // Carregar tamb√©m assistentes
        const resAssistentes = await fetch('/api/assistentes', {credentials: 'include'});
        const dataAssistentes = await resAssistentes.json();

        if(dataAssistentes.success && dataAssistentes.assistentes && dataAssistentes.assistentes.length > 0){
            dataAssistentes.assistentes.forEach(assis => {
                const option = document.createElement('option');
                option.value = assis._id;
                option.textContent = `${assis.nome} (Assistente)`;
                selectProfissional.appendChild(option);
            });

            console.log(`‚úÖ ${dataAssistentes.assistentes.length} assistentes carregados no filtro`);
        }

        // Mostrar mensagem inicial
        document.getElementById('comissoesMensagemInicial').style.display = 'block';
        document.getElementById('comissoesEstatisticasCards').style.display = 'none';

    }catch(err){
        console.error('Erro ao carregar profissionais para comiss√µes:', err);
        Swal.fire({
            icon: 'error',
            title: 'Erro ao Carregar',
            text: 'N√£o foi poss√≠vel carregar a lista de profissionais',
            confirmButtonColor: '#7C3AED'
        });
    }
}

async function carregarEstatisticasProfissionais() {
    console.log('üìä Carregando estat√≠sticas dos profissionais...');

    const tbody = document.getElementById('rankingProfissionaisBody');
    if (!tbody) {
        console.error('‚ùå tbody rankingProfissionaisBody n√£o encontrado');
        return;
    }

    try {
        // Mostrar loading
        tbody.innerHTML = '<tr><td colspan="7" class="text-center"><div class="spinner"></div></td></tr>';

        // Buscar profissionais e comiss√µes em paralelo
        const [profRes, comRes] = await Promise.all([
            fetch('/api/profissionais', {credentials: 'include'}),
            fetch('/api/comissoes', {credentials: 'include'})
        ]);

        if (!profRes.ok || !comRes.ok) {
            throw new Error('Erro ao buscar dados');
        }

        const profData = await profRes.json();
        const comData = await comRes.json();

        console.log('üìä Dados recebidos:', {
            profissionais: profData.profissionais?.length,
            comissoes: comData.comissoes?.length
        });

        // Validar dados
        if (!profData.success || !profData.profissionais || profData.profissionais.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted" style="padding: 40px;"><i class="bi bi-inbox" style="font-size: 3rem; opacity: 0.3;"></i><p style="margin-top: 15px;">Nenhum profissional cadastrado</p></td></tr>';
            return;
        }

        const profissionais = profData.profissionais;
        const comissoes = comData.comissoes || [];

        // Agrupar comiss√µes por profissional ID
        const estatisticasPorProf = {};

        comissoes.forEach(com => {
            const profId = com.profissional_id || com.profissional?._id;
            if (!profId) return;

            if (!estatisticasPorProf[profId]) {
                estatisticasPorProf[profId] = {
                    totalComissoes: 0,
                    quantidadeOrcamentos: 0,
                    somaValores: 0
                };
            }

            const valorComissao = parseFloat(com.comissao_valor || com.valor || 0);
            estatisticasPorProf[profId].totalComissoes += valorComissao;
            estatisticasPorProf[profId].quantidadeOrcamentos += 1;
            estatisticasPorProf[profId].somaValores += valorComissao;
        });

        // Mesclar dados de profissionais com estat√≠sticas
        const ranking = profissionais.map(prof => {
            const stats = estatisticasPorProf[prof._id] || {
                totalComissoes: 0,
                quantidadeOrcamentos: 0,
                somaValores: 0
            };

            const media = stats.quantidadeOrcamentos > 0
                ? stats.totalComissoes / stats.quantidadeOrcamentos
                : 0;

            return {
                id: prof._id,
                nome: prof.nome || 'N/A',
                foto: prof.foto || prof.foto_url || '',
                tipo: prof.tipo || prof.especialidade || 'Profissional',
                totalComissoes: stats.totalComissoes,
                quantidadeOrcamentos: stats.quantidadeOrcamentos,
                media: media
            };
        });

        // Ordenar por total de comiss√µes (decrescente)
        ranking.sort((a, b) => b.totalComissoes - a.totalComissoes);

        // Renderizar tabela
        if (ranking.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted" style="padding: 40px;">Nenhum dado de comiss√µes dispon√≠vel</td></tr>';
            return;
        }

        tbody.innerHTML = ranking.map((prof, index) => {
            // Foto com fallback
            const fotoHtml = prof.foto
                ? `<img src="${prof.foto}" alt="${prof.nome}" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary);">`
                : `<div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, var(--primary), var(--secondary)); display: flex; align-items: center; justify-content: center; color: #fff; font-weight: bold; font-size: 1.2rem;">${prof.nome.charAt(0).toUpperCase()}</div>`;

            // Badge para posi√ß√£o (top 3 com cores especiais)
            let posicaoBadge = '';
            if (index === 0) {
                posicaoBadge = '<span style="background: linear-gradient(135deg, #FFD700, #FFA500); color: #000; padding: 4px 10px; border-radius: 20px; font-weight: 900; font-size: 0.9rem;">ü•á 1¬∫</span>';
            } else if (index === 1) {
                posicaoBadge = '<span style="background: linear-gradient(135deg, #C0C0C0, #A0A0A0); color: #000; padding: 4px 10px; border-radius: 20px; font-weight: 900; font-size: 0.9rem;">ü•à 2¬∫</span>';
            } else if (index === 2) {
                posicaoBadge = '<span style="background: linear-gradient(135deg, #CD7F32, #8B4513); color: #fff; padding: 4px 10px; border-radius: 20px; font-weight: 900; font-size: 0.9rem;">ü•â 3¬∫</span>';
            } else {
                posicaoBadge = `<span style="color: var(--text-secondary); font-weight: 600; font-size: 1.1rem;">${index + 1}¬∫</span>`;
            }

            return `
                <tr style="${index < 3 ? 'background: rgba(124, 58, 237, 0.05);' : ''}">
                    <td>${posicaoBadge}</td>
                    <td>${fotoHtml}</td>
                    <td><strong>${prof.nome}</strong></td>
                    <td><span class="badge secondary">${prof.tipo}</span></td>
                    <td><strong style="color: var(--success); font-size: 1.1rem;">R$ ${prof.totalComissoes.toFixed(2)}</strong></td>
                    <td><span class="badge primary">${prof.quantidadeOrcamentos}</span></td>
                    <td><strong>R$ ${prof.media.toFixed(2)}</strong></td>
                </tr>
            `;
        }).join('');

        console.log(`‚úÖ Ranking de ${ranking.length} profissionais carregado`);

    } catch (error) {
        console.error('‚ùå Erro ao carregar estat√≠sticas:', error);
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="text-center text-danger" style="padding: 40px;">
                    <i class="bi bi-exclamation-triangle" style="font-size: 3rem;"></i>
                    <p style="margin-top: 15px;">Erro ao carregar estat√≠sticas dos profissionais</p>
                </td>
            </tr>
        `;
    }
}

async function carregarFinanceiroResumo(){
    console.log('üíµ Carregando resumo financeiro...');

    try{
        // Carregar dados de dashboard (mais completo que resumo)
        const res = await fetch('/api/financeiro/dashboard', {credentials: 'include'});

        if (!res.ok) {
            console.error(`‚ùå Erro HTTP ao buscar dashboard financeiro: ${res.status}`);
            throw new Error(`Erro ${res.status}: Falha ao carregar dashboard`);
        }

        const data = await res.json();
        console.log('üì¶ Dados do dashboard financeiro:', { success: data.success, hasData: !!data.financeiro });

        if(data.success && data.financeiro){
            const fin = data.financeiro;

            // Atualizar cards principais com fallbacks
            const financeiroReceitasEl = document.getElementById('financeiroReceitas');
            const financeiroDespesasEl = document.getElementById('financeiroDespesas');
            const financeiroComissoesEl = document.getElementById('financeiroComissoes');
            const financeiroLucroEl = document.getElementById('financeiroLucro');

            if (financeiroReceitasEl) {
                const receita = parseFloat(fin.receita_total || fin.receitas || 0);
                financeiroReceitasEl.textContent = `R$ ${receita.toFixed(2).replace('.', ',')}`;
            }

            if (financeiroDespesasEl) {
                const despesas = parseFloat(fin.despesas_total || fin.despesas || 0);
                financeiroDespesasEl.textContent = `R$ ${despesas.toFixed(2).replace('.', ',')}`;
            }

            if (financeiroComissoesEl) {
                const comissoes = parseFloat(fin.comissoes_pendentes || fin.comissoes || 0);
                financeiroComissoesEl.textContent = `R$ ${comissoes.toFixed(2).replace('.', ',')}`;
            }

            if (financeiroLucroEl) {
                const lucro = parseFloat(fin.lucro_liquido || fin.lucro || 0);
                financeiroLucroEl.textContent = `R$ ${lucro.toFixed(2).replace('.', ',')}`;
                // Colorir baseado no valor
                financeiroLucroEl.style.color = lucro >= 0 ? 'var(--success)' : 'var(--danger)';
            }

            // Atualizar margem de lucro
            const margemEl = document.getElementById('margemLucro');
            if (margemEl) {
                const margem = parseFloat(fin.margem_lucro_perc || fin.margem || 0);
                margemEl.textContent = `${margem.toFixed(1)}%`;
                margemEl.style.color = margem > 0 ? 'var(--success)' : margem < 0 ? 'var(--danger)' : 'var(--text-muted)';
            }

            console.log('‚úÖ Cards financeiros atualizados:', {
                receita: fin.receita_total,
                despesas: fin.despesas_total,
                comissoes: fin.comissoes_pendentes,
                lucro: fin.lucro_liquido
            });

            // IMPORTANTE: Aguardar um frame para garantir que o DOM esteja vis√≠vel antes de renderizar gr√°ficos
            // Isso resolve o problema de gr√°ficos desaparecendo ao trocar de sub-tab
            setTimeout(() => {
                console.log('üìä Recarregando gr√°ficos financeiros...');

                // Recarregar gr√°ficos (importante para manter dados vis√≠veis ao trocar sub-tabs)
                carregarFaturamentoMensal();
                carregarServicosMaisVendidos();
                carregarProdutosMaisVendidos();

                // For√ßar atualiza√ß√£o de charts existentes (caso j√° tenham sido criados)
                if (window.chartFaturamentoInstance) {
                    try {
                        window.chartFaturamentoInstance.update();
                        console.log('‚úÖ Gr√°fico de faturamento atualizado');
                    } catch (err) {
                        console.warn('‚ö†Ô∏è Erro ao atualizar gr√°fico de faturamento:', err);
                    }
                }

                console.log('‚úÖ Gr√°ficos financeiros recarregados');
            }, 50); // Pequeno delay para garantir que o CSS tenha aplicado display:block

            console.log('‚úÖ Resumo financeiro atualizado completamente');
        } else {
            console.warn('‚ö†Ô∏è Resposta do dashboard n√£o cont√©m dados financeiros');
        }
    }catch(err){
        console.error('‚ùå Erro ao carregar resumo financeiro:', err);

        // Mostrar valores zerados em caso de erro (evita campos vazios)
        const zeroValue = 'R$ 0,00';
        const elements = {
            financeiroReceitas: document.getElementById('financeiroReceitas'),
            financeiroDespesas: document.getElementById('financeiroDespesas'),
            financeiroComissoes: document.getElementById('financeiroComissoes'),
            financeiroLucro: document.getElementById('financeiroLucro'),
            margemLucro: document.getElementById('margemLucro')
        };

        if (elements.financeiroReceitas) elements.financeiroReceitas.textContent = zeroValue;
        if (elements.financeiroDespesas) elements.financeiroDespesas.textContent = zeroValue;
        if (elements.financeiroComissoes) elements.financeiroComissoes.textContent = zeroValue;
        if (elements.financeiroLucro) {
            elements.financeiroLucro.textContent = zeroValue;
            elements.financeiroLucro.style.color = 'var(--text-muted)';
        }
        if (elements.margemLucro) {
            elements.margemLucro.textContent = '0.0%';
            elements.margemLucro.style.color = 'var(--text-muted)';
        }
    }
}

async function carregarReceitas(){
    console.log('üí∞ Carregando receitas...');
    const tbody = document.getElementById('receitasTableBody');

    if(!tbody){
        console.error('tbody receitasTableBody n√£o encontrado');
        return;
    }

    try{
        tbody.innerHTML = '<tr><td colspan="5" class="text-center"><div class="spinner"></div></td></tr>';

        const res = await fetch('/api/financeiro/receitas', {credentials: 'include'});
        const data = await res.json();

        if(data.success && data.receitas && data.receitas.length > 0){
            tbody.innerHTML = data.receitas.map((receita, index) => {
                // Obter ID com fallbacks e formatar
                const orcId = receita.orcamento_id || receita._id || receita.id || `temp-${index}`;
                // Pegar √∫ltimos 6 caracteres ou usar formato mais curto
                const displayId = String(orcId).length > 8 ? String(orcId).slice(-6).toUpperCase() : String(orcId);

                return `
                <tr>
                    <td><strong>${new Date(receita.data || receita.created_at).toLocaleDateString('pt-BR')}</strong></td>
                    <td><span class="badge success">#${displayId}</span></td>
                    <td>${receita.cliente_nome || receita.nome_cliente || 'N/A'}</td>
                    <td><strong style="color: var(--success);">R$ ${parseFloat(receita.valor || receita.total || 0).toFixed(2)}</strong></td>
                    <td>${receita.categoria || receita.tipo || 'Servi√ßo'}</td>
                </tr>
            `}).join('');

            console.log(`‚úÖ ${data.receitas.length} receitas carregadas`);
        } else {
            tbody.innerHTML = `
                <tr>
                    <td colspan="5" class="text-center" style="padding: 40px; color: var(--text-muted);">
                        <i class="bi bi-inbox" style="font-size: 3rem; opacity: 0.3;"></i>
                        <p style="margin-top: 15px; font-weight: 600;">Nenhuma receita registrada</p>
                    </td>
                </tr>
            `;
        }
    }catch(err){
        console.error('Erro ao carregar receitas:', err);
        tbody.innerHTML = `
            <tr>
                <td colspan="5" class="text-center" style="padding: 40px; color: var(--danger);">
                    <i class="bi bi-exclamation-triangle" style="font-size: 2rem;"></i>
                    <p style="margin-top: 10px;">Erro ao carregar receitas</p>
                    <button class="bioma-btn bioma-btn-sm bioma-btn-primary" onclick="carregarReceitas()" style="margin-top: 10px;">
                        <i class="bi bi-arrow-clockwise"></i> Tentar Novamente
                    </button>
                </td>
            </tr>
        `;
    }
}

// ========== GERENCIAMENTO DE DESPESAS ==========

async function novaDespesa(){
    const result = await window.Swal.fire({
        title: '<i class="bi bi-plus-circle"></i> Nova Despesa',
        html: `
            <div style="text-align: left;">
                <label style="display: block; margin-bottom: 5px; font-weight: 600;">Descri√ß√£o *</label>
                <input type="text" id="swal-descricao" class="form-control mb-3" placeholder="Ex: Conta de luz" required>

                <label style="display: block; margin-bottom: 5px; font-weight: 600;">Categoria</label>
                <select id="swal-categoria" class="form-select mb-3">
                    <option value="Geral">Geral</option>
                    <option value="Sal√°rios">Sal√°rios</option>
                    <option value="Aluguel">Aluguel</option>
                    <option value="Contas">Contas (√°gua, luz, internet)</option>
                    <option value="Produtos">Produtos</option>
                    <option value="Manuten√ß√£o">Manuten√ß√£o</option>
                    <option value="Marketing">Marketing</option>
                    <option value="Impostos">Impostos</option>
                    <option value="Outros">Outros</option>
                </select>

                <label style="display: block; margin-bottom: 5px; font-weight: 600;">Valor (R$) *</label>
                <input type="number" id="swal-valor" class="form-control mb-3" placeholder="0.00" step="0.01" min="0" required>

                <label style="display: block; margin-bottom: 5px; font-weight: 600;">Data</label>
                <input type="date" id="swal-data" class="form-control mb-3" value="${new Date().toISOString().split('T')[0]}">

                <label style="display: block; margin-bottom: 5px; font-weight: 600;">Forma de Pagamento</label>
                <select id="swal-forma-pagamento" class="form-select mb-3">
                    <option value="Dinheiro">Dinheiro</option>
                    <option value="PIX">PIX</option>
                    <option value="D√©bito">D√©bito</option>
                    <option value="Cr√©dito">Cr√©dito</option>
                    <option value="Transfer√™ncia">Transfer√™ncia</option>
                </select>

                <label style="display: block; margin-bottom: 5px; font-weight: 600;">Observa√ß√µes</label>
                <textarea id="swal-observacoes" class="form-control" rows="2" placeholder="Informa√ß√µes adicionais (opcional)"></textarea>
            </div>
        `,
        showCancelButton: true,
        confirmButtonText: '<i class="bi bi-check-circle"></i> Registrar',
        cancelButtonText: '<i class="bi bi-x-circle"></i> Cancelar',
        width: '600px',
        preConfirm: async () => {
            const descricao = document.getElementById('swal-descricao').value.trim();
            const categoria = document.getElementById('swal-categoria').value;
            const valor = document.getElementById('swal-valor').value;
            const data = document.getElementById('swal-data').value;
            const forma_pagamento = document.getElementById('swal-forma-pagamento').value;
            const observacoes = document.getElementById('swal-observacoes').value.trim();

            if (!descricao) {
                Swal.showValidationMessage('Por favor, informe uma descri√ß√£o');
                return false;
            }
            if (!valor || parseFloat(valor) <= 0) {
                Swal.showValidationMessage('Por favor, informe um valor v√°lido');
                return false;
            }

            try {
                const response = await fetch('/api/financeiro/despesas', {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        descricao,
                        categoria,
                        valor: parseFloat(valor),
                        data,
                        forma_pagamento,
                        observacoes
                    })
                });

                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.message || 'Erro ao registrar despesa');
                }

                return result;
            } catch (error) {
                Swal.showValidationMessage(`Erro: ${error.message}`);
                return false;
            }
        }
    });

    if (result.isConfirmed) {
        toast('‚úÖ Despesa registrada com sucesso!', 'success');
        await carregarDespesas();
        await carregarDadosFinanceiro(); // Atualizar resumo financeiro
    }

    // Limpeza de seguran√ßa: remover qualquer backdrop residual
    setTimeout(() => {
        document.querySelectorAll('.bioma-dialog').forEach(el => {
            if (!Swal.isVisible()) {
                el.remove();
            }
        });
        // Classes swal2 removidas - nao mais necessario
    }, 100);
}

async function excluirDespesa(id){
    const result = await window.Swal.fire({
        title: 'Confirmar Exclus√£o',
        text: 'Tem certeza que deseja excluir esta despesa? Esta a√ß√£o n√£o pode ser desfeita.',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: '<i class="bi bi-trash"></i> Sim, excluir',
        cancelButtonText: '<i class="bi bi-x"></i> Cancelar',
        confirmButtonColor: '#dc3545'
    });

    if (result.isConfirmed) {
        try {
            const response = await fetch(`/api/financeiro/despesas/${id}`, {
                method: 'DELETE',
                credentials: 'include'
            });

            const data = await response.json();

            if (data.success) {
                toast('‚úÖ Despesa exclu√≠da com sucesso', 'success');
                await carregarDespesas();
                await carregarDadosFinanceiro(); // Atualizar resumo financeiro
            } else {
                throw new Error(data.message || 'Erro ao excluir despesa');
            }
        } catch (error) {
            console.error('Erro ao excluir despesa:', error);
            toast('‚ùå Erro ao excluir despesa', 'error');
        }
    }

}

async function carregarDespesas(){
    console.log('üí∏ Carregando despesas...');
    const tbody = document.getElementById('despesasTableBody');

    if(!tbody){
        console.error('tbody despesasTableBody n√£o encontrado');
        return;
    }

    try{
        tbody.innerHTML = '<tr><td colspan="5" class="text-center"><div class="spinner"></div></td></tr>';

        const res = await fetch('/api/financeiro/despesas', {credentials: 'include'});
        const data = await res.json();

        if(data.success && data.despesas && data.despesas.length > 0){
            tbody.innerHTML = data.despesas.map(desp => `
                <tr>
                    <td><strong>${new Date(desp.data || desp.created_at).toLocaleDateString('pt-BR')}</strong></td>
                    <td>${desp.descricao || 'N/A'}</td>
                    <td><span class="badge warning">${desp.categoria || 'Geral'}</span></td>
                    <td><strong style="color: var(--danger);">R$ ${parseFloat(desp.valor || 0).toFixed(2)}</strong></td>
                    <td>
                        <button class="bioma-btn bioma-btn-sm bioma-btn-danger" onclick="excluirDespesa('${desp._id}')" title="Excluir">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');

            console.log(`‚úÖ ${data.despesas.length} despesas carregadas`);
        } else {
            tbody.innerHTML = `
                <tr>
                    <td colspan="5" class="text-center" style="padding: 40px; color: var(--text-muted);">
                        <i class="bi bi-inbox" style="font-size: 3rem; opacity: 0.3;"></i>
                        <p style="margin-top: 15px; font-weight: 600;">Nenhuma despesa registrada</p>
                    </td>
                </tr>
            `;
        }
    }catch(err){
        console.error('Erro ao carregar despesas:', err);
        tbody.innerHTML = `
            <tr>
                <td colspan="5" class="text-center" style="padding: 40px; color: var(--danger);">
                    <i class="bi bi-exclamation-triangle" style="font-size: 2rem;"></i>
                    <p style="margin-top: 10px;">Erro ao carregar despesas</p>
                    <button class="bioma-btn bioma-btn-sm bioma-btn-primary" onclick="carregarDespesas()" style="margin-top: 10px;">
                        <i class="bi bi-arrow-clockwise"></i> Tentar Novamente
                    </button>
                </td>
            </tr>
        `;
    }
}

// ========== FIM STUB FUNCTIONS ==========

// ==========================================================
// ========== SISTEMA DE SCANNER DE C√ìDIGO DE BARRAS ==========
// ==========================================================
let barcodeBuffer = '';
let lastKeyTime = 0;
let barcodeScannerAtivo = false;

/**
 * Inicia o "ouvinte" global para o scanner de c√≥digo de barras.
 * Ele detecta digita√ß√£o r√°pida terminada com "Enter".
 */
function iniciarScannerBarcode() {
    if (barcodeScannerAtivo) return; // Prevenir m√∫ltiplos listeners

    console.log('üî´ Scanner de c√≥digo de barras ATIVADO');
    barcodeScannerAtivo = true;

    document.addEventListener('keydown', async (e) => {
        // N√£o capturar se o usu√°rio estiver em um modal (Swal) ou em um input/textarea
        const inModal = document.body.classList.contains('swal2-shown') || document.querySelector('.bioma-modal-overlay');
        const inInput = e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.isContentEditable;

        if (inInput || inModal) {
            barcodeBuffer = ''; // Resetar buffer se estiver digitando em um campo
            return;
        }

        const now = Date.now();

        // Resetar buffer se a digita√ß√£o for lenta (humano)
        // Um scanner "digita" muito r√°pido (menos de 50ms entre teclas)
        if (now - lastKeyTime > 100) {
            barcodeBuffer = '';
        }

        if (e.key === 'Enter') {
            // Um c√≥digo de barras v√°lido deve ter > 8 d√≠gitos e ser num√©rico
            if (barcodeBuffer.length > 8 && /^\d+$/.test(barcodeBuffer)) {
                console.log('C√≥digo de barras detectado:', barcodeBuffer);
                e.preventDefault(); // Prevenir que o "Enter" envie um formul√°rio
                await handleBarcodeScan(barcodeBuffer);
            }
            barcodeBuffer = '';
        } else if (e.key.length === 1) {
            // Adicionar apenas teclas "imprim√≠veis"
            barcodeBuffer += e.key;
        }

        lastKeyTime = now;
    });
}

/**
 * Processa o c√≥digo de barras capturado.
 * Chama a API e decide onde preencher os dados do produto.
 * @param {string} barcode - O c√≥digo de barras lido.
 */
async function handleBarcodeScan(barcode) {
    try {
        // Mostrar um feedback visual de "lendo"
        mostrarNotificacao('info', `Buscando c√≥digo: ${barcode}`, 1500);

        const data = await API.get(`/api/produto/barcode/${barcode}`);

        if (data.success && data.produto) {
            const produto = data.produto;
            const activeSection = document.querySelector('.content-section.active')?.id;

            // Decidir onde preencher os dados
            if (activeSection === 'section-orcamento') {
                preencherCamposProdutoOrcamento(produto);
                mostrarNotificacao('success', `Produto ${produto.nome} adicionado`, 2000);

            } else if (activeSection === 'section-estoque') {
                preencherCamposProdutoEstoque(produto);
                mostrarNotificacao('success', `Produto ${produto.nome} selecionado`, 2000);

            } else {
                // Apenas notificar se n√£o estiver na tela certa
                mostrarNotificacao('success', `Produto encontrado: ${produto.nome}`, 3000);
            }
        } else {
            mostrarNotificacao('error', 'Produto n√£o encontrado para este c√≥digo', 3000);
        }
    } catch (err) {
        console.error('Erro no scan:', err);
        mostrarNotificacao('error', 'Erro ao buscar produto', 3000);
    }
}

/**
 * Preenche os campos de produto na tela de "Novo Or√ßamento".
 * @param {object} produto - O objeto do produto retornado pela API.
 */
function preencherCamposProdutoOrcamento(produto) {
    // Ir para a se√ß√£o de or√ßamento se n√£o estiver nela
    if (document.querySelector('.content-section.active')?.id !== 'section-orcamento') {
        goTo('orcamento');
    }

    // Simular a sele√ß√£o do produto
    document.getElementById('buscaProduto').value = `${produto.nome} ${produto.marca || ''}`;
    document.getElementById('produtoPreco').value = (produto.preco || 0).toFixed(2);

    // Define a vari√°vel global que a fun√ß√£o addProduto() usa
    window.produtoSelecionado = {
        id: produto._id,
        nome: produto.nome,
        marca: produto.marca || '',
        sku: produto.sku || '',
        preco: parseFloat(produto.preco || 0)
    };

    // Focar no campo de quantidade para agilidade
    document.getElementById('produtoQtd').focus();
    document.getElementById('produtoQtd').select();
}

/**
 * Preenche os campos de produto na tela de "Estoque" (Entrada/Sa√≠da).
 * @param {object} produto - O objeto do produto retornado pela API.
 */
function preencherCamposProdutoEstoque(produto) {
    // Ir para a se√ß√£o de estoque se n√£o estiver nela
    if (document.querySelector('.content-section.active')?.id !== 'section-estoque') {
        goTo('estoque');
    }

    // Esperar a navega√ß√£o (se houver)
    setTimeout(() => {
        const activeSubTab = document.querySelector('#section-estoque .sub-tab-content.active')?.id;

        if (activeSubTab === 'estoque-subtab-nova-entrada') {
            const select = document.getElementById('novaEntradaProduto');
            select.value = produto._id; // O <select> deve ser populado com IDs

            document.getElementById('novaEntradaQuantidade').focus();
            document.getElementById('novaEntradaQuantidade').select();

        } else if (activeSubTab === 'estoque-subtab-nova-saida') {
            const select = document.getElementById('novaSaidaProduto');
            select.value = produto._id;

            document.getElementById('novaSaidaQuantidade').focus();
            document.getElementById('novaSaidaQuantidade').select();

        } else {
            // Se n√£o estiver na aba certa, ir para "Nova Entrada" como padr√£o
            switchSubTab('estoque', 'nova-entrada');
            // Tentar preencher novamente ap√≥s a troca de aba
            setTimeout(() => preencherCamposProdutoEstoque(produto), 200);
        }
    }, 300); // Atraso para esperar a troca de aba
}

// ========== FIM SISTEMA DE SCANNER ==========

(async function boot(){
  try{
    const cu = await API.get('/api/current-user');
    if(cu.success){ 
      initApp(cu.user); 
    } else { 
      document.querySelector('#authScreen').style.display='flex'; 
      document.querySelector('#app').style.display='none'; 
    }
  }catch(e){
    console.error('Erro no boot:', e);
    document.querySelector('#authScreen').style.display='flex';
    document.querySelector('#app').style.display='none';
  }
})();
</script>
<!-- MODALS E SE√á√ïES ADICIONAIS -->

<!-- Modal: Upload de Foto de Servi√ßo -->
<div id="modalFotoServico" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.7); z-index:10000; align-items:center; justify-content:center;">
    <div style="background:var(--bg-card); border-radius:20px; padding:40px; max-width:700px; width:90%; max-height:90vh; overflow-y:auto;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;">
            <h2><i class="bi bi-camera"></i> Gerenciar Fotos do Servi√ßo</h2>
            <button class="bioma-btn bioma-btn-sm bioma-btn-danger" onclick="fecharModalFotoServico()" style="border-radius:50%; width:40px; height:40px;">√ó</button>
        </div>

        <div class="mb-4">
            <label style="display:block; font-weight:700; margin-bottom:10px;">Adicionar Nova Foto</label>
            <input type="file" id="fotoServicoInput-modal" accept="image/*" class="form-control" style="margin-bottom:15px;">
            <button class="bioma-btn bioma-btn-primary" onclick="uploadFotoServicoModal()">
                <i class="bi bi-upload"></i> Fazer Upload
            </button>
        </div>

        <div class="mb-4">
            <h4>Fotos Atuais</h4>
            <div id="fotosServico-modal" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(200px, 1fr)); gap:20px; margin-top:20px;">
                <!-- Fotos ser√£o carregadas aqui via JS -->
            </div>
        </div>
    </div>
</div>

<style>
/* Estilos para fotos de servi√ßos */
.foto-servico-item {
    position: relative;
    border: 2px solid var(--border-color);
    border-radius: 15px;
    overflow: hidden;
    transition: all 0.3s;
}

.foto-servico-item.principal {
    border-color: var(--primary);
    border-width: 4px;
}

.foto-servico-item img {
    width: 100%;
    height: 150px;
    object-fit: cover;
}

.foto-servico-item:hover {
    transform: translateY(-5px);
    box-shadow: var(--shadow-hover);
}

.foto-servico-item .badge {
    position: absolute;
    top: 10px;
    right: 10px;
}

.foto-servico-item .foto-acoes {
    padding: 10px;
    background: var(--bg-card);
    display: flex;
    gap: 10px;
    flex-direction: column;
}
</style>

<script>
// Fun√ß√µes auxiliares para modais
let servicoIdAtual = null;

function abrirModalFotoServico(servicoId) {
    servicoIdAtual = servicoId;
    document.getElementById('modalFotoServico').style.display = 'flex';
    carregarFotosServico(servicoId);
}

function fecharModalFotoServico() {
    document.getElementById('modalFotoServico').style.display = 'none';
    servicoIdAtual = null;
}

function uploadFotoServicoModal() {
    if (!servicoIdAtual) return;

    const fileInput = document.getElementById('fotoServicoInput-modal');
    if (!fileInput || !fileInput.files[0]) {
        mostrarErro('Selecione uma imagem');
        return;
    }

    const formData = new FormData();
    formData.append('foto', fileInput.files[0]);

    fetch(`/api/servicos/${servicoIdAtual}/foto`, {
        method: 'POST',
        body: formData
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            mostrarSucesso('Foto adicionada com sucesso!');
            carregarFotosServico(servicoIdAtual);
            fileInput.value = '';
        } else {
            throw new Error(data.message || 'Erro ao fazer upload');
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        mostrarErro('Erro ao fazer upload da foto: ' + error.message);
    });
}

function carregarFotosServico(servicoId) {
    fetch(`/api/servicos/${servicoId}/fotos`)
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            renderFotosServicoModal(data.fotos, data.foto_principal_index);
        }
    })
    .catch(error => {
        console.error('Erro:', error);
    });
}

function renderFotosServicoModal(fotos, principalIndex) {
    const container = document.getElementById('fotosServico-modal');
    if (!container) return;

    if (!fotos || fotos.length === 0) {
        container.innerHTML = '<p class="text-muted">Nenhuma foto adicionada</p>';
        return;
    }

    container.innerHTML = fotos.map((foto, index) => `
        <div class="foto-servico-item ${index === principalIndex ? 'principal' : ''}">
            <img src="${foto.url}" alt="Foto ${index + 1}">
            ${index === principalIndex ? '<span class="badge badge-primary">Principal</span>' : ''}
            <div class="foto-acoes">
                <button class="bioma-btn bioma-btn-sm bioma-btn-danger" onclick="deletarFotoServico('${servicoIdAtual}', ${index})">
                    <i class="bi bi-trash"></i> Excluir
                </button>
            </div>
            <small class="text-muted" style="display:block; padding:10px; text-align:center;">Enviada em ${new Date(foto.data_upload).toLocaleDateString()}</small>
        </div>
    `).join('');
}


// Carregar gr√°ficos quando a se√ß√£o financeira for ativada
const originalCarregarDadosSecao = window.carregarDadosSecao;
window.carregarDadosSecao = function(section) {
    if (typeof originalCarregarDadosSecao === 'function') {
        originalCarregarDadosSecao(section);
    }
    if (section === 'financeiro') {
        setTimeout(() => {
            if (typeof carregarTodosGraficos === 'function') {
                carregarTodosGraficos();
            }
        }, 500);
    }
};

// ========== SISTEMA DE AUTO-ATUALIZA√á√ÉO (DIRETRIZ 0.1) ==========

/**
 * Sistema de atualiza√ß√£o autom√°tica de dados
 * Atualiza o dashboard e se√ß√£o atual a cada 30 segundos
 */

let autoUpdateInterval = null;
let autoUpdateEnabled = true;

// √öltima se√ß√£o ativa
let lastActiveSection = 'dashboard';
// ========== AUTO-ATUALIZA√á√ÉO COMPLETAMENTE REMOVIDA ==========
//
// ‚ö†Ô∏è TODO O C√ìDIGO DE AUTO-ATUALIZA√á√ÉO FOI DELETADO
//
// Use os bot√µes de "Atualizar" em cada se√ß√£o para refresh manual
//
console.log('‚ö†Ô∏è Auto-atualiza√ß√£o REMOVIDA - use bot√µes de refresh manual');

// ========== FIM ==========

</script>

<!-- BIOMA v4.0 - Document Generator (PDF & Excel profissionais) -->
<script src="/static/js/document-generator.js"></script>

<!-- BIOMA v4.0 - Offline Manager (IndexedDB + Sync) -->
<script src="/static/js/offline-manager.js"></script>

</body>
</html>