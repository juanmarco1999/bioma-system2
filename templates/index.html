<!DOCTYPE html>
<html lang="pt-BR" data-theme="light">
<head>
    <!-- FORÇAR LIGHT MODE AGRESSIVAMENTE - ANTES DE TUDO -->
    <script>
    (function() {
        // Executar IMEDIATAMENTE antes de qualquer CSS/JS
        localStorage.removeItem('theme');
        localStorage.removeItem('bioma_theme');
        sessionStorage.removeItem('theme');
        document.documentElement.setAttribute('data-theme', 'light');
        document.documentElement.style.setProperty('color-scheme', 'light');
        console.log('🌞 LIGHT MODE FORÇADO AGRESSIVAMENTE');
    })();
    </script>

    <!-- ULTRA FORCE LIGHT MODE - NUCLEAR OVERRIDE ALL CACHE AND CSS -->
    <style id="force-light-mode-nuclear">
    /* NUCLEAR OVERRIDE - DESTROY ALL DARK MODE WITH MAXIMUM PRIORITY */
    * {
        --bg-main: #F9FAFB !important;
        --bg-card: #FFFFFF !important;
        --bg-sidebar: #1F2937 !important;
        --text-primary: #1F2937 !important;
        --text-secondary: #6B7280 !important;
        --text-muted: #9CA3AF !important;
        --border-color: #E5E7EB !important;
        --primary: #7C3AED !important;
        --primary-dark: #6D28D9 !important;
        --secondary: #EC4899 !important;
        --success: #10B981 !important;
        --danger: #EF4444 !important;
        --warning: #F59E0B !important;
        --info: #3B82F6 !important;
    }

    html, html[data-theme], html[data-theme="dark"], html[data-theme="light"],
    body, body[data-theme], body[data-theme="dark"], body[data-theme="light"] {
        color-scheme: light only !important;
        background: #F9FAFB !important;
        background-color: #F9FAFB !important;
        color: #1F2937 !important;
    }

    /* AUTH SCREEN - ULTRA FORCE GRADIENT */
    #authScreen, .auth-screen, div.auth-screen, body .auth-screen,
    html .auth-screen, #authScreen.auth-screen {
        background: linear-gradient(135deg,#667eea 0%,#764ba2 100%) !important;
        background-image: linear-gradient(135deg,#667eea 0%,#764ba2 100%) !important;
        background-color: #667eea !important;
        color: #1F2937 !important;
    }

    /* AUTH BOX - ULTRA FORCE WHITE */
    .auth-box, div.auth-box, #authScreen .auth-box {
        background: rgba(255,255,255,0.98) !important;
        background-color: rgba(255,255,255,0.98) !important;
        backdrop-filter: blur(10px) !important;
        color: #1F2937 !important;
    }

    /* ALL TEXT - FORCE DARK COLOR */
    .auth-logo h2, .auth-logo p, .login-label, label,
    .auth-box *, .auth-screen *, #authScreen * {
        color: #1F2937 !important;
    }

    /* FORM INPUTS - ULTRA WHITE */
    input, input.form-control, .form-control, .form-select,
    textarea, select, #loginUsername, #loginPassword {
        background: #FFFFFF !important;
        background-color: #FFFFFF !important;
        color: #1F2937 !important;
        border: 2px solid #E5E7EB !important;
    }

    input::placeholder {
        color: #9CA3AF !important;
    }

    /* NAVIGATION TABS */
    .nav-pills .nav-link, .nav-link, button.nav-link {
        color: #6B7280 !important;
        background: transparent !important;
    }

    .nav-pills .nav-link.active, .nav-link.active, button.nav-link.active {
        background: linear-gradient(135deg,#7C3AED,#6D28D9) !important;
        color: #FFFFFF !important;
    }

    /* INFO BOX */
    .alert-info, .info-box {
        background: linear-gradient(135deg,#E0E7FF,#DBEAFE) !important;
        color: #1E40AF !important;
    }

    /* DESTROY DARK MODE ROOT VARIABLES */
    :root, :root[data-theme="dark"],
    html:root, html:root[data-theme="dark"] {
        --bg-main: #F9FAFB !important;
        --bg-card: #FFFFFF !important;
        --text-primary: #1F2937 !important;
        --text-secondary: #6B7280 !important;
    }
    </style>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="Sistema de Gestão BIOMA Uberaba v4.0 - Sistema Completo">
    <meta name="author" content="Juan Marco (@juanmarco1999)">
    <title>BIOMA Uberaba v4.0 - Sistema Profissional</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>🌳</text></svg>">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <!-- BIOMA v4.0 - Sistema Consolidado -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- SheetJS para exportação Excel -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <!-- jsPDF para geração de PDFs profissionais -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- jsPDF AutoTable para tabelas em PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <!-- FullCalendar para calendário de profissionais -->
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/locales/pt-br.global.min.js"></script>
    <style>
:root[data-theme="light"]{--primary:#7C3AED;--primary-dark:#6D28D9;--secondary:#EC4899;--accent:#F59E0B;--success:#10B981;--danger:#EF4444;--warning:#F59E0B;--info:#3B82F6;--bg-main:#F9FAFB;--bg-card:#FFFFFF;--bg-sidebar:#1F2937;--bg-sidebar-hover:#374151;--text-primary:#1F2937;--text-secondary:#6B7280;--text-muted:#9CA3AF;--border-color:#E5E7EB;--shadow:0 4px 20px rgba(0,0,0,0.08);--shadow-hover:0 8px 30px rgba(124,58,237,0.15);}:root[data-theme="dark"]{--primary:#8B5CF6;--primary-dark:#7C3AED;--secondary:#F472B6;--accent:#FBBF24;--success:#34D399;--danger:#F87171;--warning:#FBBF24;--info:#60A5FA;--bg-main:#0F172A;--bg-card:#1E293B;--bg-sidebar:#0F172A;--bg-sidebar-hover:#1E293B;--text-primary:#F1F5F9;--text-secondary:#CBD5E1;--text-muted:#94A3B8;--border-color:#334155;--shadow:0 4px 20px rgba(0,0,0,0.4);--shadow-hover:0 8px 30px rgba(139,92,246,0.3)}*{margin:0;padding:0;box-sizing:border-box}body,button,input,select,textarea{transition:background-color .2s ease,color .2s ease,border-color .2s ease}body{font-family:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:var(--bg-main);color:var(--text-primary);overflow-x:hidden;line-height:1.6}.auth-screen{min-height:100vh;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);padding:20px;animation:gradientAnimation 15s ease infinite;background-size:400% 400%}@keyframes gradientAnimation{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}.auth-box{background:rgba(255,255,255,0.98);backdrop-filter:blur(10px);border-radius:30px;padding:50px;max-width:500px;width:100%;box-shadow:0 30px 80px rgba(0,0,0,0.4);animation:slideUp 0.6s cubic-bezier(0.68,-0.55,0.265,1.55)}@keyframes slideUp{from{opacity:0;transform:translateY(50px) scale(0.9)}to{opacity:1;transform:translateY(0) scale(1)}}.auth-logo{text-align:center;margin-bottom:40px}.auth-logo .logo-icon{font-size:5rem;background:linear-gradient(135deg,#7C3AED,#EC4899);-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent;animation:pulse 2s ease-in-out infinite;filter:drop-shadow(0 5px 15px rgba(124,58,237,0.3))}@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}.auth-logo h2{font-weight:900;font-size:2.8rem;color:#1F2937;margin-top:20px;letter-spacing:2px}.auth-logo p{color:#6B7280;font-size:1.1rem;margin-top:10px;font-weight:500}.nav-pills .nav-link{border-radius:15px;font-weight:700;padding:12px 25px;transition:all .3s;color:#6B7280;border:none;background:transparent;cursor:pointer}.nav-pills .nav-link.active{background:linear-gradient(135deg,#7C3AED,#6D28D9);color:white;box-shadow:0 5px 20px rgba(124,58,237,0.4);transform:translateY(-2px)}.form-control,.form-select{border-radius:12px;border:2px solid #E5E7EB;padding:12px 18px;font-size:1rem;transition:all .3s;background:white;color:#1F2937}.form-control:focus,.form-select:focus{border-color:#7C3AED;box-shadow:0 0 0 5px rgba(124,58,237,0.1);outline:none;background:white}.alert{border-radius:15px;border:none;padding:15px 20px}.alert-info{background:linear-gradient(135deg,#E0E7FF,#DBEAFE);color:#1E40AF;border-left:5px solid #3B82F6}.alert-success{background:linear-gradient(135deg,#D1FAE5,#A7F3D0);color:#065F46;border-left:5px solid #10B981}.btn{border-radius:12px;padding:12px 30px;font-weight:700;border:none;cursor:pointer;transition:all .3s ease;display:inline-flex;align-items:center;gap:10px;font-size:1rem;text-transform:uppercase;letter-spacing:0.5px}.btn i{font-size:1.2rem}.btn-primary{background:linear-gradient(135deg,var(--primary),var(--primary-dark));color:#fff;box-shadow:0 5px 20px rgba(124,58,237,0.3)}.btn-primary:hover{transform:translateY(-3px);box-shadow:0 10px 30px rgba(124,58,237,0.5);color:#fff}.btn-success{background:linear-gradient(135deg,var(--success),#059669);color:#fff}.btn-success:hover{transform:translateY(-3px);color:#fff}.btn-danger{background:linear-gradient(135deg,var(--danger),#DC2626);color:#fff}.btn-outline{background:transparent;color:var(--primary);border:3px solid var(--primary)}.btn-outline:hover{background:var(--primary);color:#fff}.btn-secondary{background:#6B7280;color:#fff}.btn-sm{padding:8px 16px;font-size:0.85rem}.w-100{width:100%}.mt-3{margin-top:1rem}.mb-3{margin-bottom:1rem}#app{display:none}.sidebar{width:280px;background:var(--bg-sidebar);color:#fff;position:fixed;height:100vh;overflow-y:auto;z-index:1000;box-shadow:4px 0 25px rgba(0,0,0,0.2)}.sidebar::-webkit-scrollbar{width:8px}.sidebar::-webkit-scrollbar-track{background:rgba(255,255,255,0.05)}.sidebar::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.2);border-radius:4px}.sidebar-logo{padding:30px 20px;text-align:center;background:linear-gradient(135deg,var(--primary),var(--secondary));border-bottom:5px solid var(--accent)}.sidebar-logo h1{font-size:2.5rem;font-weight:900;letter-spacing:5px;margin:0;text-shadow:2px 2px 8px rgba(0,0,0,0.3)}.sidebar-logo p{font-size:1rem;opacity:0.95;margin:10px 0 0 0;letter-spacing:2px}.sidebar-menu{list-style:none;padding:20px 0}.sidebar-menu li a{display:flex;align-items:center;gap:12px;padding:14px 20px;color:rgba(255,255,255,0.85);text-decoration:none;transition:all .3s;border-left:5px solid transparent;font-weight:500;font-size:0.95rem}.sidebar-menu li a i{font-size:1.3rem;width:25px}.sidebar-menu li a:hover{background:var(--bg-sidebar-hover);color:#fff;border-left-color:var(--accent);padding-left:28px}.sidebar-menu li a.active{background:var(--bg-sidebar-hover);color:#fff;border-left-color:var(--primary);font-weight:700}.theme-toggle{padding:15px 20px;border-top:1px solid rgba(255,255,255,0.1)}.theme-toggle button{width:100%;padding:12px;background:rgba(255,255,255,0.1);border:2px solid rgba(255,255,255,0.2);border-radius:12px;color:#fff;font-weight:600;cursor:pointer;transition:all .3s;display:flex;align-items:center;justify-content:center;gap:10px}.main-content{margin-left:280px;padding:30px 40px 100px;min-height:100vh;overflow-y:auto;overflow-x:hidden}.main-content::-webkit-scrollbar{width:10px}.main-content::-webkit-scrollbar-track{background:var(--bg-main)}.main-content::-webkit-scrollbar-thumb{background:var(--primary);border-radius:5px}.content-section{display:none}.content-section.active{display:block;animation:fadeIn 0.4s ease}@keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}.page-header{margin-bottom:30px;padding-bottom:20px;border-bottom:3px solid var(--border-color);display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:20px}.page-header h1{font-size:2.2rem;font-weight:900;background:linear-gradient(135deg,var(--primary),var(--secondary));-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent;margin:0;display:flex;align-items:center;gap:15px}.stat-card{background:var(--bg-card);border-radius:20px;padding:30px;box-shadow:var(--shadow);transition:all .3s;text-align:center;position:relative;overflow:hidden;border:2px solid var(--border-color)}.stat-card::before{content:'';position:absolute;top:0;left:0;width:100%;height:6px;background:linear-gradient(90deg,var(--primary),var(--secondary))}.stat-card:hover{transform:translateY(-10px);box-shadow:var(--shadow-hover);border-color:var(--primary)}.stat-card .icon{width:70px;height:70px;border-radius:18px;display:flex;align-items:center;justify-content:center;font-size:2rem;margin:0 auto 15px;background:linear-gradient(135deg,var(--primary),var(--primary-dark));color:#fff;box-shadow:0 10px 25px rgba(124,58,237,0.3)}.stat-card h3{font-size:3rem;font-weight:900;margin:15px 0 10px;background:linear-gradient(135deg,var(--primary),var(--secondary));-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent}.stat-card p{color:var(--text-secondary);font-size:1rem;font-weight:700;margin:0;text-transform:uppercase;letter-spacing:1px}.card{background:var(--bg-card);border-radius:20px;box-shadow:var(--shadow);margin-bottom:30px;overflow:visible;transition:all .3s;border:2px solid var(--border-color)}.card-header{background:linear-gradient(135deg,var(--primary),var(--primary-dark));color:#fff;padding:20px 30px;font-weight:800;font-size:1.2rem;display:flex;align-items:center;gap:12px}.card-body{padding:30px}table{width:100%;border-collapse:collapse;font-size:0.95rem}table thead th{background:linear-gradient(135deg,var(--primary),var(--primary-dark));color:#fff;padding:16px 14px;text-align:left;font-weight:800;text-transform:uppercase;letter-spacing:0.5px;font-size:0.85rem}table tbody tr{border-bottom:2px solid var(--border-color);transition:all .2s}table tbody tr:hover{background:var(--bg-main);transform:scale(1.01)}table tbody td{padding:16px 14px;vertical-align:middle;color:var(--text-primary)}.badge{padding:8px 16px;border-radius:20px;font-weight:800;font-size:0.8rem;display:inline-block;text-transform:uppercase;letter-spacing:0.5px}.badge.success{background:linear-gradient(135deg,var(--success),#059669);color:#fff}.badge.warning{background:linear-gradient(135deg,var(--warning),#F59E0B);color:#000}.badge.danger{background:linear-gradient(135deg,var(--danger),#DC2626);color:#fff}.spinner{border:4px solid var(--border-color);border-top:4px solid var(--primary);border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite;margin:20px auto}@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}.text-center{text-align:center}.text-muted{color:var(--text-secondary)}.text-success{color:var(--success)}.text-danger{color:var(--danger)}.autocomplete-results{position:absolute;top:100%;left:0;right:0;background:var(--bg-card);border:2px solid var(--primary);border-radius:14px;margin-top:5px;max-height:350px;overflow-y:auto;z-index:9999;box-shadow:0 10px 40px rgba(124,58,237,0.3);display:none}.autocomplete-results::-webkit-scrollbar{width:8px}.autocomplete-results::-webkit-scrollbar-track{background:var(--bg-main);border-radius:10px}.autocomplete-results::-webkit-scrollbar-thumb{background:var(--primary);border-radius:10px}.autocomplete-item{padding:14px 18px;border-bottom:1px solid var(--border-color);cursor:pointer;transition:all .2s ease;word-wrap:break-word;white-space:normal}.autocomplete-item:hover{background:linear-gradient(135deg,rgba(124,58,237,0.1),rgba(236,72,153,0.1));transform:translateX(5px);border-left:4px solid var(--primary)}.autocomplete-item:last-child{border-bottom:none}.autocomplete-item strong{color:var(--primary);font-size:1.05rem;display:block;margin-bottom:5px}.autocomplete-item small{color:var(--text-secondary);font-size:0.9rem;display:block}.row{display:flex;flex-wrap:wrap;margin:0 -15px}.row.g-4>*{padding:0 15px;margin-bottom:25px}[class^="col-"]{padding:0 15px}.col-12{width:100%}@media (min-width:768px){.col-md-6{width:50%}.col-md-4{width:33.333%}.col-md-3{width:25%}.col-md-2{width:16.666%}}@media (min-width:992px){.col-lg-3{width:25%}.col-lg-4{width:33.333%}.col-lg-6{width:50%}}
            .global-search-container{margin-bottom:24px;background:var(--bg-card);border-radius:18px;padding:20px;box-shadow:var(--shadow);position:relative}
        .global-search-field{display:flex;gap:12px;align-items:center}
        .global-search-field .bi-search{font-size:1.4rem;color:var(--primary)}
        .global-search-input{flex:1;border:2px solid var(--border-color);border-radius:14px;padding:12px 18px;font-size:1rem;background:var(--bg-main);color:var(--text-primary)}
        .global-search-input:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(124,58,237,0.15)}
        .global-search-results{position:absolute;top:100%;left:0;right:0;background:var(--bg-card);border-radius:16px;box-shadow:var(--shadow);margin-top:12px;max-height:320px;overflow-y:auto;display:none;z-index:50;padding:12px}
        .global-search-results.active{display:block}
        .global-search-section{margin-bottom:14px}
        .global-search-section h6{font-size:0.75rem;text-transform:uppercase;font-weight:700;color:var(--text-muted);margin:8px 0}
        .global-search-item{border-radius:12px;padding:10px 12px;cursor:pointer;transition:all .2s;display:flex;flex-direction:column;gap:4px;border:1px solid transparent}
        .global-search-item:hover{background:rgba(124,58,237,0.08);border-color:rgba(124,58,237,0.25)}
        .global-search-item strong{color:var(--text-primary);font-size:0.95rem}
        .global-search-item span{color:var(--text-secondary);font-size:0.8rem}
        .highlight-row{animation:blinkHighlight 2s ease-in-out 0s 2 alternate}
        @keyframes blinkHighlight{from{background:rgba(59,130,246,0.15)}to{background:transparent}}
        .stock-summary-card{background:var(--bg-card);border-radius:18px;padding:24px;box-shadow:var(--shadow);height:100%}
        .stock-summary-card h3{font-size:2.1rem;font-weight:800;margin:0;color:var(--primary)}
        .stock-summary-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:18px;margin-top:20px}
        .stock-summary-metric{background:var(--bg-main);border-radius:14px;padding:16px;border:1px solid var(--border-color)}
        .stock-summary-metric strong{display:block;font-size:0.8rem;text-transform:uppercase;color:var(--text-muted);margin-bottom:6px}
        .stock-summary-metric span{font-size:1.2rem;font-weight:700;color:var(--text-primary)}
        .estoque-actions{display:flex;flex-wrap:wrap;gap:12px;align-items:center}
        .badge.neutral{background:rgba(107,114,128,0.15);color:#374151}
        .logo-preview-card{background:var(--bg-card);border-radius:18px;padding:20px;box-shadow:var(--shadow);text-align:center;height:100%;position:relative}
        .logo-preview-card button{margin-top:12px}
        .logo-preview{width:100%;max-width:220px;height:120px;border-radius:16px;background:var(--bg-main);border:2px dashed var(--border-color);display:flex;align-items:center;justify-content:center;margin:0 auto 12px;overflow:hidden}
        .logo-preview img{max-width:100%;max-height:100%;object-fit:contain}
        .community-hero{background:linear-gradient(135deg,var(--primary),var(--secondary));border-radius:22px;padding:32px;color:#fff;box-shadow:var(--shadow-hover);margin-bottom:26px}
        .community-hero h2{font-weight:800;margin-bottom:8px}
        .community-hero p{opacity:0.85}
        .community-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:20px;margin-top:20px}
        .community-card{background:var(--bg-card);border-radius:18px;padding:20px;box-shadow:var(--shadow);height:100%}
        .community-card h5{font-weight:700;margin-bottom:10px}
        .community-pill{display:inline-flex;align-items:center;gap:8px;background:rgba(124,58,237,0.12);color:var(--primary);padding:6px 12px;border-radius:999px;font-size:0.8rem;margin-right:8px;margin-bottom:8px}

        /* === CORREÇÃO RENDERIZAÇÃO DAS ABAS === */
        #section-clube, #section-importar, #section-sistema, #section-auditoria, #section-configuracoes {
            overflow: auto !important;
            max-width: 100% !important;
        }

        /* ================================================================ */
        /* === CONTROLE DE VISIBILIDADE DAS SEÇÕES - CORRIGIDO === */
        /* ================================================================ */

        /* Classe utilitária para esconder elementos */
        .d-none {
            display: none !important;
            visibility: hidden !important;
            pointer-events: none !important;
            position: absolute !important;
            left: -9999px !important;
            z-index: -1 !important;
        }

        /* Garantir que apenas seções ativas sejam exibidas */
        .content-section {
            display: none !important;
            visibility: hidden !important;
            pointer-events: none !important;
        }

        .content-section.active {
            display: block !important;
            visibility: visible !important;
            height: auto !important;
            overflow: auto !important;
            position: relative !important;
            left: 0 !important;
            opacity: 1 !important;
            pointer-events: auto !important;
            z-index: 1 !important;
        }

        .sub-tab-content {
            display: none !important;
        }

        .sub-tab-content.active {
            display: block !important;
            height: auto !important;
            overflow: revert !important;
            position: relative !important;
            left: 0 !important;
            opacity: 1 !important;
            visibility: visible !important;
        }

        /* === SUB-TABS SYSTEM === */
        .sub-tabs{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:24px;padding:12px;background:var(--bg-card);border-radius:16px;box-shadow:var(--shadow);border:2px solid var(--border-color)}
        .sub-tab,.sub-tab-btn{padding:12px 24px;border-radius:12px;font-weight:700;font-size:0.9rem;cursor:pointer;transition:all .3s ease;border:2px solid transparent;background:var(--bg-main);color:var(--text-secondary);text-transform:uppercase;letter-spacing:0.5px;white-space:nowrap}
        .sub-tab:hover,.sub-tab-btn:hover{background:rgba(124,58,237,0.1);color:var(--primary);border-color:var(--primary);transform:translateY(-2px)}
        .sub-tab.active,.sub-tab-btn.active{background:linear-gradient(135deg,var(--primary),var(--primary-dark));color:#fff;border-color:var(--primary);box-shadow:0 5px 15px rgba(124,58,237,0.4);transform:translateY(-2px)}
        .sub-tab-content{display:none;animation:fadeInContent 0.4s ease}
        .sub-tab-content.active{display:block}
        @keyframes fadeInContent{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}

        /* Fotos de perfil profissionais */
        .foto-profissional-container{position:relative;display:inline-block}
        .foto-profissional{width:80px;height:80px;border-radius:50%;object-fit:cover;border:4px solid var(--primary);box-shadow:0 5px 15px rgba(124,58,237,0.3);cursor:pointer;transition:all .3s}
        .foto-profissional:hover{transform:scale(1.1);box-shadow:0 8px 25px rgba(124,58,237,0.5)}
        .foto-upload-btn{position:absolute;bottom:0;right:0;background:var(--primary);color:#fff;border:none;border-radius:50%;width:30px;height:30px;display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 3px 10px rgba(0,0,0,0.3)}

        /* Mapa de Calor */
        .mapa-calor-container{background:var(--bg-card);border-radius:18px;padding:24px;box-shadow:var(--shadow)}
        .mapa-calor-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:12px;margin-top:20px}
        .mapa-dia{background:var(--bg-main);border-radius:12px;padding:16px;text-align:center;border:2px solid var(--border-color);transition:all .3s}
        .mapa-dia:hover{transform:scale(1.05);box-shadow:0 5px 15px rgba(0,0,0,0.1)}
        .mapa-dia-header{font-size:0.85rem;font-weight:700;color:var(--text-muted);margin-bottom:8px}
        .mapa-dia-data{font-size:0.75rem;color:var(--text-secondary);margin-bottom:12px}
        .mapa-dia-valor{font-size:2rem;font-weight:900;color:var(--primary)}
        .intensidade-1{border-left:5px solid #DCFCE7}
        .intensidade-2{border-left:5px solid #86EFAC}
        .intensidade-3{border-left:5px solid #4ADE80}
        .intensidade-4{border-left:5px solid #22C55E}
        .intensidade-5{border-left:5px solid #16A34A;background:linear-gradient(135deg,rgba(22,163,74,0.1),rgba(34,197,94,0.2))}

        /* Formulários Anamnese/Prontuário */
        .form-anamnese,.form-prontuario{background:var(--bg-card);border-radius:18px;padding:30px;box-shadow:var(--shadow);margin-bottom:20px}
        .form-section-title{font-size:1.3rem;font-weight:800;color:var(--primary);margin:25px 0 15px;padding-bottom:10px;border-bottom:3px solid var(--border-color)}
        .form-group-inline{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px;margin-bottom:20px}
        .form-label-custom{display:block;font-weight:700;margin-bottom:8px;color:var(--text-primary);font-size:0.95rem}
        .form-textarea-custom{width:100%;min-height:120px;border-radius:12px;border:2px solid var(--border-color);padding:14px;font-family:inherit;resize:vertical;transition:all .3s}
        .form-textarea-custom:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 4px rgba(124,58,237,0.1)}

        /* Loading States */
        .loading-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:99999;backdrop-filter:blur(5px)}
        .loading-content{background:var(--bg-card);padding:40px;border-radius:20px;text-align:center;box-shadow:0 15px 50px rgba(0,0,0,0.5)}
        .loading-spinner-large{border:6px solid var(--border-color);border-top:6px solid var(--primary);border-radius:50%;width:60px;height:60px;animation:spin 1s linear infinite;margin:0 auto 20px}

        /* ========== CORREÇÃO OVERFLOW/SCROLL ========== */
        .content-section{padding:20px}
        .content-section::-webkit-scrollbar{width:8px}
        .content-section::-webkit-scrollbar-thumb{background:#888;border-radius:4px}
        /* REMOVIDO :hover para evitar piscar */
        .table-responsive{max-height:600px;overflow-y:auto;margin-bottom:20px}
        .table-responsive::-webkit-scrollbar{width:6px}
        .table-responsive::-webkit-scrollbar-thumb{background:var(--primary);border-radius:3px}
        .row{margin-left:-10px;margin-right:-10px}
        .col-md-3,.col-md-4,.col-md-6{padding-left:10px;padding-right:10px}

        /* ========== OTIMIZAÇÕES DE PERFORMANCE ========== */
        /* Remove transform em hover de tabelas para evitar travamentos */
        table tbody tr:hover {
            background: var(--bg-main) !important;
            transform: none !important; /* Remove scale que causa reflow */
        }

        /* Hardware acceleration para elementos animados */
        .stat-card, .btn, .sidebar-menu li a {
            will-change: transform;
            transform: translate3d(0, 0, 0); /* Force GPU */
        }

        /* Otimizar scrollbar para evitar jank */
        .main-content {
            scrollbar-width: thin;
            scrollbar-color: var(--primary) var(--bg-main);
        }

        /* Reduzir uso de backdrop-filter (caro para performance) */
        .auth-box {
            backdrop-filter: none !important;
        }

        /* Smooth scrolling sem impacto de performance */
        * {
            scroll-behavior: smooth;
        }

        /* Containment para melhor performance */
        .card, .stat-card {
            contain: layout style paint;
        }

        /* ========== FIX SCROLL PISCANDO ========== */
        /* Remover TODOS os efeitos hover das scrollbars */
        *::-webkit-scrollbar-thumb:hover,
        *::-webkit-scrollbar-track:hover,
        *::-webkit-scrollbar:hover {
            /* Sem mudanças no hover */
        }

        /* Estabilizar scrollbars */
        *::-webkit-scrollbar {
            background: transparent;
        }

        *::-webkit-scrollbar-thumb {
            transition: none !important; /* Sem transições */
        }

        *::-webkit-scrollbar-track {
            transition: none !important; /* Sem transições */
        }

        /* Sub-tabs System */
        .sub-tabs{display:flex;gap:12px;margin-bottom:30px;border-bottom:3px solid var(--border-color);padding-bottom:0;flex-wrap:wrap}
        .sub-tab-btn{background:transparent;border:none;padding:14px 24px;font-weight:700;font-size:0.95rem;color:var(--text-secondary);cursor:pointer;border-bottom:4px solid transparent;transition:all .3s;display:flex;align-items:center;gap:8px;position:relative;bottom:-3px}
        .sub-tab-btn:hover{color:var(--primary);background:rgba(124,58,237,0.05)}
        .sub-tab-btn.active{color:var(--primary);border-bottom-color:var(--primary);background:rgba(124,58,237,0.08)}
        .sub-tab-content{display:none;animation:fadeIn 0.4s ease}
        .sub-tab-content.active{display:block}

        /* ISOLAMENTO DAS SEÇÕES - Otimizado para Performance */
        .content-section:not(.active) {
            display: none !important;
            /* Removido visibility e pointer-events de * para evitar reflow massivo */
        }

        .content-section.active {
            display: block !important;
        }

        /* PROTEÇÃO ESPECÍFICA PARA SEÇÃO DE ESTOQUE */
        #section-estoque:not(.active),
        #section-estoque:not(.active) * {
            display: none !important;
            visibility: hidden !important;
            pointer-events: none !important;
            position: absolute !important;
            left: -9999px !important;
            top: -9999px !important;
            opacity: 0 !important;
        }

        /* Garantir que apenas seção ativa de estoque seja visível */
        #section-estoque.active {
            display: block !important;
            visibility: visible !important;
            position: relative !important;
            left: 0 !important;
            top: 0 !important;
            opacity: 1 !important;
        }

        /* Responsive Sub-tabs */
        @media (max-width:768px){
            .sub-tabs{flex-direction:column}
            .sub-tab,.sub-tab-btn{width:100%;text-align:center}
            .main-content{margin-left:0;padding:20px}
            .sidebar{width:100%;height:auto;position:relative}
        }

        /* ========== LOGO PERSONALIZADO: DINÂMICO E SEM FUNDO ========== */
        .sidebar-logo {
            padding: 20px !important;
            display: flex !important;
            flex-direction: column !important;
            justify-content: center !important;
            align-items: center !important;
            background: var(--bg-sidebar) !important; /* Fundo da sidebar sem gradiente */
            border-bottom: none !important; /* Remove borda */
            min-height: 200px !important;
            max-height: none !important;
            overflow: visible !important;
            transition: all 0.3s ease !important;
        }

        #sidebarLogoImage {
            width: 90%;
            max-width: 200px;
            height: auto;
            object-fit: contain;
            display: block;
            margin: 0 auto;
            padding: 15px;
            background: transparent !important;
            border-radius: 50% !important;
            box-shadow:
                0 4px 15px rgba(0,0,0,0.2),
                0 0 20px rgba(255, 255, 255, 0.1),
                0 0 40px rgba(124, 58, 237, 0.2);
            position: relative;
            animation: logoGlamourGlow 2s ease-in-out infinite;
        }

        /* ✨ EFEITO GLAMOUR ESTRELADO - Múltiplas estrelas cintilantes ✨ */
        #sidebarLogoImage::before,
        #sidebarLogoImage::after {
            content: '✨';
            position: absolute;
            font-size: 25px;
            pointer-events: none;
            animation: sparkleGlamour 2s ease-in-out infinite;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.8);
        }

        #sidebarLogoImage::before {
            top: -10px;
            right: -10px;
            animation-delay: 0s;
        }

        #sidebarLogoImage::after {
            bottom: -10px;
            left: -10px;
            animation-delay: 1s;
        }

        /* Brilho glamour contínuo */
        @keyframes logoGlamourGlow {
            0%, 100% {
                filter: brightness(1) drop-shadow(0 0 8px rgba(124, 58, 237, 0.4));
                box-shadow:
                    0 4px 15px rgba(0,0,0,0.2),
                    0 0 20px rgba(255, 255, 255, 0.1),
                    0 0 40px rgba(124, 58, 237, 0.2);
            }
            25% {
                filter: brightness(1.15) drop-shadow(0 0 15px rgba(236, 72, 153, 0.6));
                box-shadow:
                    0 4px 15px rgba(0,0,0,0.2),
                    0 0 30px rgba(255, 255, 255, 0.3),
                    0 0 60px rgba(236, 72, 153, 0.4);
            }
            50% {
                filter: brightness(1.3) drop-shadow(0 0 20px rgba(245, 158, 11, 0.7));
                box-shadow:
                    0 4px 15px rgba(0,0,0,0.2),
                    0 0 40px rgba(255, 255, 255, 0.4),
                    0 0 80px rgba(245, 158, 11, 0.5);
            }
            75% {
                filter: brightness(1.15) drop-shadow(0 0 15px rgba(124, 58, 237, 0.6));
                box-shadow:
                    0 4px 15px rgba(0,0,0,0.2),
                    0 0 30px rgba(255, 255, 255, 0.3),
                    0 0 60px rgba(124, 58, 237, 0.4);
            }
        }

        /* Cintilação das estrelas ✨ */
        @keyframes sparkleGlamour {
            0%, 100% {
                opacity: 0;
                transform: scale(0) rotate(0deg);
            }
            25% {
                opacity: 1;
                transform: scale(1.2) rotate(90deg);
            }
            50% {
                opacity: 0.7;
                transform: scale(0.8) rotate(180deg);
            }
            75% {
                opacity: 1;
                transform: scale(1.3) rotate(270deg);
            }
        }

        /* Quando há logo personalizado, esconder texto */
        .sidebar-logo.has-custom-logo h1,
        .sidebar-logo.has-custom-logo p {
            display: none !important;
        }

        /* Quando NÃO há logo, mostrar texto normal */
        .sidebar-logo h1 {
            font-size: 2rem !important;
            margin: 0 !important;
        }

        .sidebar-logo p {
            font-size: 0.85rem !important;
            margin: 5px 0 0 0 !important;
        }

        /* ========== ANIMAÇÕES MELHORADAS (PARTE 4.2) ========== */

        /* Animações de entrada suaves */
        @keyframes slideInFromLeft {
            from {
                opacity: 0;
                transform: translateX(-30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes slideInFromRight {
            from {
                opacity: 0;
                transform: translateX(30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes slideInFromTop {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes bounceIn {
            0% {
                opacity: 0;
                transform: scale(0.3);
            }
            50% {
                opacity: 1;
                transform: scale(1.05);
            }
            70% {
                transform: scale(0.9);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* Aplicar animações aos elementos */
        .stat-card {
            animation: slideInFromTop 0.5s ease-out;
            animation-fill-mode: both;
        }

        .stat-card:nth-child(1) { animation-delay: 0.1s; }
        .stat-card:nth-child(2) { animation-delay: 0.2s; }
        .stat-card:nth-child(3) { animation-delay: 0.3s; }
        .stat-card:nth-child(4) { animation-delay: 0.4s; }

        .card {
            animation: slideInFromLeft 0.6s ease-out;
        }

        .sidebar-menu li {
            animation: slideInFromLeft 0.5s ease-out;
            animation-fill-mode: both;
        }

        .sidebar-menu li:nth-child(1) { animation-delay: 0.1s; }
        .sidebar-menu li:nth-child(2) { animation-delay: 0.15s; }
        .sidebar-menu li:nth-child(3) { animation-delay: 0.2s; }
        .sidebar-menu li:nth-child(4) { animation-delay: 0.25s; }
        .sidebar-menu li:nth-child(5) { animation-delay: 0.3s; }

        /* Hover animations */
        .btn {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        /* Animação de entrada suave para cards */
        .stat-card, .card {
            animation: fadeInUp 0.5s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Toast notification animations */
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(400px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes slideOutRight {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(400px);
            }
        }

        /* Micro-interação nos botões */
        .btn {
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:active::before {
            width: 300px;
            height: 300px;
        }

        /* Animação de pulsação para badges importantes */
        .badge.danger, .badge.warning {
            animation: subtlePulse 2s ease-in-out infinite;
        }

        @keyframes subtlePulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 0 0 8px rgba(239, 68, 68, 0);
            }
        }

        /* Loading spinner com rotação suave */
        @keyframes smoothSpin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .spinner {
            animation: smoothSpin 0.8s cubic-bezier(0.4, 0, 0.2, 1) infinite !important;
        }

        /* Animação de entrada para modais SweetAlert */
        .swal2-popup {
            animation: swal2FadeInDown 0.3s ease-out !important;
        }

        @keyframes swal2FadeInDown {
            from {
                opacity: 0;
                transform: translateY(-50px) scale(0.8);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* Hover em tabelas com elevação */
        table tbody tr {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1) !important;
        }

        table tbody tr:hover {
            transform: translateX(5px) !important;
            box-shadow: -5px 0 15px rgba(124, 58, 237, 0.1) !important;
        }

        /* Menu sidebar com slide suave */
        .sidebar-menu li a {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
        }

        .sidebar-menu li a:hover {
            transform: translateX(5px) !important;
        }

        /* Stat cards com rotação 3D ao hover */
        .stat-card {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1) !important;
        }

        .stat-card:hover {
            transform: translateY(-15px) rotateX(5deg) !important;
        }

        /* Form inputs com foco animado */
        .form-control, .form-select {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
        }

        .form-control:focus, .form-select:focus {
            transform: scale(1.02) !important;
        }

        /* Loading overlay com fade suave */
        .loading-overlay {
            animation: fadeIn 0.2s ease-out;
            backdrop-filter: blur(10px) !important;
        }

        /* Badge de atualização com entrada suave */
        #lastRefreshBadge {
            animation: slideInRight 0.5s ease-out;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(-30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* ========== ANIMAÇÕES EXTRAS SOFISTICADAS ========== */

        /* Shake animation para erros */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-8px); }
            20%, 40%, 60%, 80% { transform: translateX(8px); }
        }

        .shake-animation {
            animation: shake 0.5s ease-in-out;
        }

        /* Success glow effect */
        @keyframes successGlow {
            0%, 100% {
                box-shadow: 0 0 5px rgba(16, 185, 129, 0.3);
            }
            50% {
                box-shadow: 0 0 20px rgba(16, 185, 129, 0.8), 0 0 40px rgba(16, 185, 129, 0.4);
            }
        }

        .success-glow {
            animation: successGlow 1.5s ease-in-out 2;
        }

        /* Brilho pulsante para ícones (fixos, sem movimento vertical) */
        @keyframes iconGlow {
            0%, 100% {
                box-shadow: 0 10px 25px rgba(124, 58, 237, 0.3);
                filter: brightness(1);
            }
            50% {
                box-shadow: 0 10px 40px rgba(124, 58, 237, 0.6), 0 0 20px rgba(236, 72, 153, 0.4);
                filter: brightness(1.2);
            }
        }

        .stat-card .icon {
            animation: iconGlow 2s ease-in-out infinite;
        }

        .stat-card:nth-child(2) .icon {
            animation-delay: 0.3s;
        }

        .stat-card:nth-child(3) .icon {
            animation-delay: 0.6s;
        }

        .stat-card:nth-child(4) .icon {
            animation-delay: 0.9s;
        }

        /* Ripple effect para cards ao clicar */
        @keyframes ripple {
            0% {
                transform: scale(0);
                opacity: 1;
            }
            100% {
                transform: scale(4);
                opacity: 0;
            }
        }

        .card::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 100px;
            height: 100px;
            background: radial-gradient(circle, rgba(124, 58, 237, 0.3) 0%, transparent 70%);
            border-radius: 50%;
            transform: translate(-50%, -50%) scale(0);
            pointer-events: none;
        }

        .card:active::after {
            animation: ripple 0.6s ease-out;
        }

        /* Bounce in animation para badges */
        @keyframes bounceInBadge {
            0% {
                opacity: 0;
                transform: scale(0.3);
            }
            50% {
                opacity: 1;
                transform: scale(1.1);
            }
            70% {
                transform: scale(0.9);
            }
            100% {
                transform: scale(1);
            }
        }

        .badge {
            animation: bounceInBadge 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        /* Typewriter effect para títulos */
        @keyframes typewriter {
            from {
                width: 0;
            }
            to {
                width: 100%;
            }
        }

        .page-header h1 {
            overflow: hidden;
            white-space: nowrap;
            animation: typewriter 1s steps(30, end);
        }

        /* Gradient animation para botões primários */
        @keyframes gradientShift {
            0% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
            100% {
                background-position: 0% 50%;
            }
        }

        .btn-primary {
            background-size: 200% 200%;
            animation: gradientShift 3s ease infinite;
        }

        /* Slide up animation para form controls ao focar */
        @keyframes slideUpFocus {
            0% {
                transform: translateY(0);
            }
            100% {
                transform: translateY(-2px);
            }
        }

        .form-control:focus, .form-select:focus {
            animation: slideUpFocus 0.2s ease-out forwards;
        }

        /* Confetti effect para sucessos */
        @keyframes confetti-fall {
            0% {
                transform: translateY(-100%) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }

        /* Progress bar animation */
        @keyframes progressBar {
            0% {
                width: 0%;
            }
            100% {
                width: 100%;
            }
        }

        /* Fade in zoom para imagens */
        @keyframes fadeInZoom {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        #sidebarLogoImage, img.profile-pic {
            animation: fadeInZoom 0.6s ease-out;
        }

        /* Hover effect para links com underline animado */
        a {
            position: relative;
        }

        a::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 0;
            height: 2px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            transition: width 0.3s ease-out;
        }

        a:hover::after {
            width: 100%;
        }

        /* Skeleton loading animation */
        @keyframes skeleton-loading {
            0% {
                background-position: -200px 0;
            }
            100% {
                background-position: calc(200px + 100%) 0;
            }
        }

        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200px 100%;
            animation: skeleton-loading 1.5s ease-in-out infinite;
        }

        /* ========== TELA DE LOGIN: SEMPRE LIGHT MODE ========== */
        /* A tela de autenticação NUNCA deve ser afetada por dark mode */
        #authScreen,
        #authScreen *,
        .auth-screen,
        .auth-screen *,
        .auth-box,
        .auth-box * {
            /* Forçar tema light na tela de login */
            color: #1F2937 !important;
        }

        .auth-screen {
            /* Garantir que o fundo do gradiente sempre apareça */
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
        }

        .auth-box {
            /* Box de login sempre claro */
            background: rgba(255, 255, 255, 0.98) !important;
            color: #1F2937 !important;
        }

        .auth-logo h2 {
            color: #1F2937 !important;
        }

        .auth-logo p {
            color: #6B7280 !important;
        }

        .form-control,
        .form-select {
            background: white !important;
            color: #1F2937 !important;
            border-color: #E5E7EB !important;
        }

        .nav-pills .nav-link {
            color: #6B7280 !important;
        }

        /* ========== LOGIN MODERNIZADO COM DARK MODE (PARTE 5.1) ========== */

        /* Labels com cor dinâmica */
        .login-label {
            font-weight: 700;
            color: var(--text-primary) !important;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }

        /* Ícones animados */
        .animated-icon {
            animation: iconPulse 2s ease-in-out infinite;
        }

        @keyframes iconPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.15); }
        }

        /* Caixa "Lembrar por 7 dias" adaptável */
        .remember-box {
            display: flex;
            align-items: center;
            gap: 10px;
            background: linear-gradient(135deg, rgba(124, 58, 237, 0.1), rgba(236, 72, 153, 0.1));
            padding: 15px;
            border-radius: 12px;
            border: 2px solid var(--primary);
        }

        .remember-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: var(--primary);
        }

        .remember-label {
            cursor: pointer;
            margin: 0;
            font-weight: 600;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Caixa de informação adaptável */
        .info-box {
            border-left: 5px solid var(--info) !important;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(96, 165, 250, 0.1)) !important;
            color: var(--text-primary) !important;
        }

        .info-title {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-primary) !important;
        }

        .info-content {
            margin-top: 10px;
            padding-left: 28px;
        }

        .info-item {
            margin-bottom: 5px;
            color: var(--text-primary) !important;
        }

        .info-code {
            background: rgba(124, 58, 237, 0.15) !important;
            padding: 4px 10px;
            border-radius: 6px;
            font-weight: 700;
            color: var(--primary) !important;
        }

        /* Botão de login moderno */
        .login-btn {
            padding: 15px !important;
            font-size: 1.1rem !important;
            font-weight: 800 !important;
            position: relative;
            overflow: hidden;
        }

        .btn-content, .btn-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        /* Spinner moderno */
        .modern-spinner {
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top-color: #fff;
            border-radius: 50%;
            animation: modernSpin 0.8s linear infinite;
            display: inline-block;
        }

        @keyframes modernSpin {
            to { transform: rotate(360deg); }
        }

        /* Dark mode para auth screen */
        @media (prefers-color-scheme: dark) {
            .auth-box {
                background: rgba(30, 41, 59, 0.98) !important;
            }

            .auth-logo h2 {
                color: var(--text-primary) !important;
            }

            .auth-logo p {
                color: var(--text-secondary) !important;
            }
        }

        /* ========== INDICADOR DE CONECTIVIDADE OFFLINE (PARTE 5.7) ========== */

        .connectivity-indicator {
            padding: 12px 20px;
            text-align: center;
            font-weight: 700;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            border-radius: 10px;
            margin: 15px 20px;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .connectivity-indicator.online {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(5, 150, 105, 0.15));
            color: #10B981;
            border: 2px solid rgba(16, 185, 129, 0.3);
        }

        .connectivity-indicator.offline {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.15), rgba(220, 38, 38, 0.15));
            color: #EF4444;
            border: 2px solid rgba(239, 68, 68, 0.3);
            animation: pulse-offline 2s ease-in-out infinite;
        }

        .connectivity-indicator i {
            font-size: 1.1rem;
        }

        @keyframes pulse-offline {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
            }
        }

        /* ========== FIM INDICADOR DE CONECTIVIDADE ========== */

</style>

<!-- ========== MELHORIAS DE UX E ANIMAÇÕES V4.1 ========== -->
<style>
    /* ========== TRANSIÇÕES SUAVES ENTRE PÁGINAS ========== */
    .content-section {
        opacity: 0;
        transform: translateX(-30px);
        transition: opacity 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94),
                    transform 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    }

    .content-section.active {
        opacity: 1;
        transform: translateX(0);
        animation: smoothPageIn 0.7s cubic-bezier(0.16, 1, 0.3, 1);
    }

    @keyframes smoothPageIn {
        0% {
            opacity: 0;
            transform: translateX(-50px) scale(0.96);
        }
        100% {
            opacity: 1;
            transform: translateX(0) scale(1);
        }
    }

    /* ========== ANIMAÇÕES HOVER MODERNAS PARA BOTÕES ========== */
    .btn {
        position: relative;
        overflow: hidden;
        transform-style: preserve-3d;
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    .btn::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.3);
        transform: translate(-50%, -50%);
        transition: width 0.6s, height 0.6s;
    }

    .btn:hover::before {
        width: 300px;
        height: 300px;
    }

    .btn:hover {
        transform: translateY(-5px) scale(1.05);
        box-shadow: 0 15px 40px rgba(124, 58, 237, 0.6) !important;
    }

    .btn:active {
        transform: translateY(-2px) scale(0.98);
    }

    /* Botões com animação de pulso */
    .btn-primary {
        animation: subtlePulse 3s ease-in-out infinite;
    }

    @keyframes subtlePulse {
        0%, 100% {
            box-shadow: 0 5px 20px rgba(124, 58, 237, 0.3);
        }
        50% {
            box-shadow: 0 5px 30px rgba(124, 58, 237, 0.5);
        }
    }

    /* ========== SUB-TABS COM TRANSIÇÕES SUAVES ========== */
    .sub-tab-content {
        opacity: 0;
        transform: translateY(20px);
        transition: opacity 0.5s ease, transform 0.5s ease;
        pointer-events: none;
    }

    .sub-tab-content.active {
        opacity: 1;
        transform: translateY(0);
        pointer-events: auto;
        animation: tabSlideIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    @keyframes tabSlideIn {
        0% {
            opacity: 0;
            transform: translateY(30px) scale(0.95);
        }
        100% {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }

    /* ========== MELHORIAS NAS TABELAS ========== */
    table tbody tr {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    table tbody tr:hover {
        transform: translateX(4px) !important;
        background: linear-gradient(90deg,
            rgba(124, 58, 237, 0.05),
            transparent) !important;
        box-shadow: 0 2px 8px rgba(124, 58, 237, 0.1);
    }

    /* ========== INDICADOR DE AUTO-REFRESH ========== */
    #auto-refresh-indicator {
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        color: white;
        padding: 12px 20px;
        border-radius: 50px;
        box-shadow: 0 5px 25px rgba(124, 58, 237, 0.4);
        z-index: 9999;
        display: none;
        align-items: center;
        gap: 10px;
        font-weight: 700;
        font-size: 0.9rem;
        animation: slideInFromTop 0.4s ease, pulse 2s ease-in-out infinite;
    }

    #auto-refresh-indicator.show {
        display: flex;
    }

    #auto-refresh-indicator .spinner-small {
        width: 16px;
        height: 16px;
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-top-color: white;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes slideInFromTop {
        from {
            opacity: 0;
            transform: translateY(-30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* ========== DARK MODE APRIMORADO ========== */
    :root[data-theme="dark"] {
        --primary: #A78BFA;
        --primary-dark: #8B5CF6;
        --secondary: #F472B6;
        --accent: #FDE047;
        --success: #4ADE80;
        --danger: #F87171;
        --warning: #FBBF24;
        --info: #38BDF8;
        --bg-main: #0F1419;
        --bg-card: #1A1F2E;
        --bg-sidebar: #0A0E14;
        --bg-sidebar-hover: #1A1F2E;
        --text-primary: #F3F4F6;
        --text-secondary: #D1D5DB;
        --text-muted: #9CA3AF;
        --border-color: #374151;
        --shadow: 0 4px 20px rgba(0, 0, 0, 0.6);
        --shadow-hover: 0 8px 40px rgba(167, 139, 250, 0.4);
    }

    /* Garantir contraste no dark mode */
    :root[data-theme="dark"] .card-header,
    :root[data-theme="dark"] table thead th {
        background: linear-gradient(135deg, #6D28D9, #8B5CF6);
    }

    :root[data-theme="dark"] .stat-card h3 {
        color: var(--primary);
        -webkit-text-fill-color: var(--primary);
    }

    :root[data-theme="dark"] input,
    :root[data-theme="dark"] select,
    :root[data-theme="dark"] textarea {
        background: var(--bg-main);
        color: var(--text-primary);
        border-color: var(--border-color);
    }

    :root[data-theme="dark"] .badge {
        filter: brightness(1.2);
    }

    /* ========== SCROLL OTIMIZADO ========== */
    * {
        scrollbar-width: thin;
        scrollbar-color: var(--primary) var(--bg-main);
    }

    ::-webkit-scrollbar {
        width: 10px;
        height: 10px;
    }

    ::-webkit-scrollbar-track {
        background: var(--bg-main);
        border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb {
        background: linear-gradient(180deg, var(--primary), var(--secondary));
        border-radius: 10px;
        border: 2px solid var(--bg-main);
        transition: none;
    }

    ::-webkit-scrollbar-thumb:active {
        background: var(--primary-dark);
    }

    /* Hover removido completamente para evitar piscar ao passar mouse */

    /* ========== CARDS COM ANIMAÇÕES ========== */
    .stat-card {
        animation: cardFloat 6s ease-in-out infinite;
    }

    .stat-card:nth-child(2) {
        animation-delay: 0.2s;
    }

    .stat-card:nth-child(3) {
        animation-delay: 0.4s;
    }

    .stat-card:nth-child(4) {
        animation-delay: 0.6s;
    }

    @keyframes cardFloat {
        0%, 100% {
            transform: translateY(0);
        }
        50% {
            transform: translateY(-5px);
        }
    }

    /* ========== BADGES COM ANIMAÇÕES ========== */
    .badge {
        animation: badgePop 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }

    @keyframes badgePop {
        0% {
            transform: scale(0);
        }
        80% {
            transform: scale(1.1);
        }
        100% {
            transform: scale(1);
        }
    }

    /* ========== SIDEBAR MENU ANIMAÇÕES ========== */
    .sidebar-menu li a {
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .sidebar-menu li a:hover {
        transform: translateX(8px);
        background: linear-gradient(90deg,
            var(--bg-sidebar-hover),
            rgba(124, 58, 237, 0.1));
    }

    .sidebar-menu li a.active {
        animation: activeMenuPulse 2s ease-in-out infinite;
    }

    @keyframes activeMenuPulse {
        0%, 100% {
            box-shadow: inset 5px 0 0 var(--primary);
        }
        50% {
            box-shadow: inset 8px 0 0 var(--primary);
        }
    }

    /* ========== FORM CONTROLS COM FOCO SUAVE ========== */
    .form-control:focus,
    .form-select:focus {
        transform: scale(1.02);
        transition: all 0.3s ease;
    }

    /* ========== LOADING STATES ELEGANTES ========== */
    .spinner {
        animation: spin 1s linear infinite, colorChange 3s ease-in-out infinite;
    }

    @keyframes colorChange {
        0%, 100% {
            border-top-color: var(--primary);
        }
        33% {
            border-top-color: var(--secondary);
        }
        66% {
            border-top-color: var(--accent);
        }
    }

    /* ========== PERFORMANCE OTIMIZAÇÃO ========== */
    .main-content {
        will-change: scroll-position;
    }

    .content-section.active {
        will-change: transform, opacity;
    }

    table tbody tr {
        will-change: auto;
    }

    /* ========== COMUNIDADE ANIMAÇÕES ========== */
    .mapa-dia {
        animation: cardFadeIn 0.6s ease forwards;
        opacity: 0;
    }

    .mapa-dia:nth-child(1) { animation-delay: 0.05s; }
    .mapa-dia:nth-child(2) { animation-delay: 0.1s; }
    .mapa-dia:nth-child(3) { animation-delay: 0.15s; }
    .mapa-dia:nth-child(4) { animation-delay: 0.2s; }
    .mapa-dia:nth-child(5) { animation-delay: 0.25s; }

    @keyframes cardFadeIn {
        from {
            opacity: 0;
            transform: translateY(20px) scale(0.9);
        }
        to {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }

    /* ========== THEME TOGGLE MELHORADO ========== */
    .theme-toggle button:hover {
        transform: scale(1.05) rotate(180deg);
        background: rgba(255, 255, 255, 0.2);
        box-shadow: 0 5px 20px rgba(124, 58, 237, 0.5);
    }

    .theme-toggle button {
        transition: all 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }
</style>

</head>
<body>

<!-- ========== INDICADOR DE AUTO-REFRESH ========== -->
<div id="auto-refresh-indicator">
    <div class="spinner-small"></div>
    <span>Atualizando dados...</span>
</div>

<!-- SAFE SWAL SIMPLIFICADO: Previne modais empilhados -->
<script>
const _OriginalSwal = (typeof Swal !== 'undefined') ? Swal.fire.bind(Swal) : null;

window.SafeSwal = {
    _isOpen: false,
    _currentModal: null,

    fire: function(config) {
        // Fechar modal anterior se houver
        if (this._isOpen) {
            try {
                Swal.close();
            } catch(e) {
                console.warn('Erro ao fechar modal anterior:', e);
            }
        }
        this._isOpen = true;

        // Normalizar config
        if (typeof config === 'string') config = { title: config };

        // CORREÇÃO CRÍTICA: Garantir que SEMPRE seja possível fechar o modal
        const safeConfig = {
            ...config,
            allowEscapeKey: config.allowEscapeKey !== false,
            allowOutsideClick: config.allowOutsideClick !== false,
            showCloseButton: config.showCloseButton !== false,
            // Adicionar backdrop para garantir que clicks fora funcionem
            backdrop: config.backdrop !== false,
            // Timer de segurança: fechar automaticamente após 5 minutos (previne travamento)
            timer: config.timer || undefined
        };

        // Hook para marcar como fechado em TODOS os cenários
        const originalDidClose = safeConfig.didClose;
        const originalWillClose = safeConfig.willClose;
        const originalDidDestroy = safeConfig.didDestroy;

        safeConfig.willClose = () => {
            this._isOpen = false;
            this._currentModal = null;
            if (originalWillClose) originalWillClose();
        };

        safeConfig.didClose = () => {
            this._isOpen = false;
            this._currentModal = null;
            // Limpar qualquer overlay residual
            document.querySelectorAll('.swal2-container, .swal2-backdrop-show').forEach(el => {
                if (el.style) el.style.display = 'none';
            });
            if (originalDidClose) originalDidClose();
        };

        safeConfig.didDestroy = () => {
            this._isOpen = false;
            this._currentModal = null;
            if (originalDidDestroy) originalDidDestroy();
        };

        // Chamar Swal original e guardar referência
        const result = _OriginalSwal(safeConfig);
        this._currentModal = result;

        return result;
    },

    // Método de emergência para forçar fechamento
    forceClose: function() {
        this._isOpen = false;
        this._currentModal = null;
        try {
            Swal.close();
            // Forçar remoção de todos os elementos do SweetAlert2
            document.querySelectorAll('.swal2-container, .swal2-backdrop-show, .swal2-shown').forEach(el => {
                el.remove();
            });
            // Remover classes do body
            document.body.classList.remove('swal2-shown', 'swal2-height-auto');
        } catch(e) {
            console.error('Erro ao forçar fechamento:', e);
        }
    }
};

// Sobrescrever Swal.fire
if (typeof Swal !== 'undefined') {
    Swal.fire = function(...args) {
        return window.SafeSwal.fire(...args);
    };
}

// Adicionar listener de emergência para ESC (funciona mesmo se modal não responder)
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && window.SafeSwal._isOpen) {
        console.log('🚨 ESC pressionado - forçando fechamento do modal');
        window.SafeSwal.forceClose();
    }
});

// Botão de emergência invisível para fechar modais travados
window.addEventListener('load', function() {
    const emergencyButton = document.createElement('div');
    emergencyButton.id = 'modalEmergencyClose';
    emergencyButton.innerHTML = '✕ Fechar';
    emergencyButton.style.cssText = `
        position: fixed;
        top: 10px;
        right: 10px;
        z-index: 999999;
        background: #EF4444;
        color: white;
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
        box-shadow: 0 4px 12px rgba(239,68,68,0.4);
        display: none;
        font-size: 14px;
    `;
    emergencyButton.onclick = function() {
        console.log('🆘 Botão de emergência acionado');
        window.SafeSwal.forceClose();
        this.style.display = 'none';
    };
    document.body.appendChild(emergencyButton);

    // Mostrar botão de emergência se modal estiver aberto por mais de 3 segundos
    setInterval(function() {
        if (window.SafeSwal._isOpen) {
            const modalVisible = document.querySelector('.swal2-container');
            if (modalVisible) {
                emergencyButton.style.display = 'block';
            }
        } else {
            emergencyButton.style.display = 'none';
        }
    }, 3000);
});
</script>

<div id="authScreen" class="auth-screen">
    <div class="auth-box">
        <div class="auth-logo">
            <img id="authLogoCustom" alt="Logo personalizado" style="display:none;max-height:120px;margin:0 auto 20px;">
            <div class="logo-icon">🌳</div>
            <h2>BIOMA</h2>
            <p>Uberaba - v4.0</p>
        </div>
        <ul class="nav nav-pills nav-fill mb-4">
            <li class="nav-item"><button class="nav-link active" id="loginTab" onclick="switchTab('login')"><i class="bi bi-box-arrow-in-right"></i> Login</button></li>
            <li class="nav-item"><button class="nav-link" id="registerTab" onclick="switchTab('register')"><i class="bi bi-person-plus"></i> Cadastro</button></li>
        </ul>
        <div id="loginForm">
            <form onsubmit="return handleLogin(event)" id="formLogin">
                <div class="mb-3">
                    <label class="login-label">
                        <i class="bi bi-person-circle animated-icon"></i> Usuário ou E-mail
                    </label>
                    <input type="text" class="form-control" id="loginUsername" required autocomplete="username" placeholder="Digite seu usuário ou e-mail">
                </div>
                <div class="mb-3">
                    <label class="login-label">
                        <i class="bi bi-shield-lock animated-icon"></i> Senha
                    </label>
                    <input type="password" class="form-control" id="loginPassword" required autocomplete="current-password" placeholder="Digite sua senha">
                </div>

                <!-- Checkbox Lembrar por 7 dias -->
                <div class="mb-3 remember-box">
                    <input type="checkbox" id="rememberMe" class="remember-checkbox">
                    <label for="rememberMe" class="remember-label">
                        <i class="bi bi-clock-history"></i> Lembrar-se de mim por 7 dias
                    </label>
                </div>

                <div class="alert alert-info info-box">
                    <strong class="info-title">
                        <i class="bi bi-info-circle"></i> Acesso Padrão:
                    </strong>
                    <div class="info-content">
                        <div class="info-item"><strong>Usuário:</strong> <code class="info-code">admin</code></div>
                        <div class="info-item"><strong>Senha:</strong> <code class="info-code">admin123</code></div>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary w-100 login-btn" id="btnLogin">
                    <span class="btn-content">
                        <i class="bi bi-box-arrow-in-right"></i> ENTRAR NO SISTEMA
                    </span>
                    <span class="btn-loading" style="display: none;">
                        <span class="modern-spinner"></span>
                        AUTENTICANDO...
                    </span>
                </button>
            </form>
        </div>
        <div id="registerForm" style="display:none">
            <form onsubmit="return handleRegister(event)">
                <div class="mb-3"><label>Nome Completo *</label><input type="text" class="form-control" id="registerName" required></div>
                <div class="mb-3"><label>Usuário *</label><input type="text" class="form-control" id="registerUsername" required autocomplete="username"></div>
                <div class="mb-3"><label>E-mail *</label><input type="email" class="form-control" id="registerEmail" required autocomplete="email"></div>
                <div class="mb-3"><label>Telefone (opcional)</label><input type="text" class="form-control" id="registerTelefone" placeholder="(34) 99999-9999"></div>
                <div class="mb-3"><label>Senha *</label><input type="password" class="form-control" id="registerPassword" required minlength="6" autocomplete="new-password"></div>
                <div class="alert alert-success"><strong>✅ Privilégios ADMIN</strong><br>Todos os novos usuários recebem acesso completo ao sistema!</div>
                <button type="submit" class="btn btn-primary w-100"><i class="bi bi-person-plus"></i> Criar Conta</button>
            </form>
        </div>
    </div>
</div>

<div id="app">
    <nav class="sidebar">
        <div class="sidebar-logo"><h1>BIOMA</h1><p>Uberaba v4.0</p></div>
        <ul class="sidebar-menu">
            <li><a href="javascript:void(0)" onclick="goTo('dashboard'); return false;" class="active" id="menu-dashboard"><i class="bi bi-speedometer2"></i> Dashboard</a></li>
            <li><a href="javascript:void(0)" onclick="goTo('orcamento'); return false;" id="menu-orcamento"><i class="bi bi-file-earmark-plus"></i> Novo Orçamento</a></li>
            <li><a href="javascript:void(0)" onclick="goTo('consultar'); return false;" id="menu-consultar"><i class="bi bi-search"></i> Consultar</a></li>
            <li><a href="javascript:void(0)" onclick="goTo('contratos'); return false;" id="menu-contratos"><i class="bi bi-file-earmark-check"></i> Contratos</a></li>
            <li><a href="javascript:void(0)" onclick="goTo('relatorios'); return false;" id="menu-relatorios"><i class="bi bi-bar-chart-line"></i> Relatórios</a></li>
            <li><a href="javascript:void(0)" onclick="goTo('perfil'); return false;" id="menu-perfil"><i class="bi bi-person-circle"></i> Perfil</a></li>
            <li><a href="javascript:void(0)" onclick="goTo('comissoes'); return false;" id="menu-comissoes"><i class="bi bi-cash-stack"></i> Comissões</a></li>
            <li><a href="javascript:void(0)" onclick="goTo('financeiro'); return false;" id="menu-financeiro"><i class="bi bi-currency-dollar"></i> Financeiro</a></li>
            <li><a href="javascript:void(0)" onclick="goTo('estoque'); return false;" id="menu-estoque"><i class="bi bi-box-seam"></i> Estoque</a></li>
            <li><a href="javascript:void(0)" onclick="goTo('agendamentos'); return false;" id="menu-agendamentos"><i class="bi bi-calendar-check"></i> Agendamentos</a></li>
            <li><a href="javascript:void(0)" onclick="goTo('fila'); return false;" id="menu-fila"><i class="bi bi-people-fill"></i> Fila</a></li>
            <li><a href="javascript:void(0)" onclick="goTo('clientes'); return false;" id="menu-clientes"><i class="bi bi-people"></i> Clientes</a></li>
            <li><a href="javascript:void(0)" onclick="goTo('profissionais'); return false;" id="menu-profissionais"><i class="bi bi-person-workspace"></i> Profissionais</a></li>
            <li><a href="javascript:void(0)" onclick="goTo('servicos'); return false;" id="menu-servicos"><i class="bi bi-scissors"></i> Serviços</a></li>
            <li><a href="javascript:void(0)" onclick="goTo('produtos'); return false;" id="menu-produtos"><i class="bi bi-box-seam"></i> Produtos</a></li>
            <li><a href="javascript:void(0)" onclick="goTo('clube'); return false;" id="menu-clube"><i class="bi bi-award"></i> Comunidade</a></li>
            <li><a href="javascript:void(0)" onclick="goTo('importar'); return false;" id="menu-importar"><i class="bi bi-cloud-upload"></i> Importar</a></li>
            <li><a href="javascript:void(0)" onclick="goTo('sistema'); return false;" id="menu-sistema"><i class="bi bi-activity"></i> Sistema</a></li>
            <li><a href="javascript:void(0)" onclick="goTo('auditoria'); return false;" id="menu-auditoria"><i class="bi bi-shield-check"></i> Auditoria</a></li>
            <li><a href="javascript:void(0)" onclick="goTo('configuracoes'); return false;" id="menu-configuracoes"><i class="bi bi-gear"></i> Configurações</a></li>
            <li><a href="javascript:void(0)" onclick="doLogout(); return false;"><i class="bi bi-box-arrow-right"></i> Sair</a></li>
        </ul>
        <div class="theme-toggle"><button onclick="toggleTheme()"><i class="bi bi-moon-stars-fill" id="themeIcon"></i><span id="themeText">Modo Escuro</span></button></div>

        <!-- Indicador de Conectividade -->
        <div id="connectivity-indicator" class="connectivity-indicator online" title="Conectado ao servidor">
            <i class="bi bi-wifi"></i> Online
        </div>
    </nav>

    <div class="main-content">
<div class="global-search-container">
    <div class="global-search-field">
        <i class="bi bi-search"></i>
        <input type="text" class="global-search-input" id="globalSearchInput" placeholder="Pesquisar clientes, produtos, serviços, profissionais, contratos..." oninput="buscarGlobal(this.value)">
        <button class="btn btn-outline" type="button" onclick="executarBuscaGlobal()"><i class="bi bi-arrow-repeat"></i></button>
    </div>
    <div id="globalSearchResults" class="global-search-results"></div>
</div>

        <div id="section-dashboard" class="content-section active">
            <div class="page-header"><h1><i class="bi bi-speedometer2"></i> Dashboard</h1></div>
            <div class="row g-4 mb-4">
                <div class="col-lg-3 col-md-6"><div class="stat-card"><div class="icon"><i class="bi bi-file-earmark-text"></i></div><h3 id="dashOrcamentos">0</h3><p>Orçamentos</p></div></div>
                <div class="col-lg-3 col-md-6"><div class="stat-card"><div class="icon"><i class="bi bi-people"></i></div><h3 id="dashClientes">0</h3><p>Clientes</p></div></div>
                <div class="col-lg-3 col-md-6"><div class="stat-card"><div class="icon"><i class="bi bi-calendar-check"></i></div><h3 id="dashAgendamentos">0</h3><p>Agendamentos Hoje</p></div></div>
                <div class="col-lg-3 col-md-6"><div class="stat-card"><div class="icon"><i class="bi bi-currency-dollar"></i></div><h3 id="dashFaturamento">R$ 0</h3><p>Faturamento</p></div></div>
            </div>
            <div class="row g-4">
                <div class="col-md-12"><div class="card"><div class="card-header"><i class="bi bi-calendar-event"></i> Próximos Agendamentos</div><div class="card-body" id="proximosAgendamentos"><div class="spinner"></div></div></div></div>
            </div>
            <div class="card mt-4"><div class="card-header"><i class="bi bi-clock-history"></i> Últimos Orçamentos</div><div class="card-body"><div class="table-responsive"><table><thead><tr><th>Nº</th><th>Data</th><th>Cliente</th><th>Valor</th><th>Status</th></tr></thead><tbody id="ultimosOrcamentosBody"><tr><td colspan="5" class="text-center"><div class="spinner"></div></td></tr></tbody></table></div></div></div>
        </div>

        <div id="section-orcamento" class="content-section">
            <div class="page-header">
                <h1><i class="bi bi-file-earmark-plus"></i> Orçamentos</h1>
                <button class="btn btn-primary" onclick="switchSubTab('orcamento', 'novo')">
                    <i class="bi bi-plus-circle"></i> Novo Orçamento
                </button>
            </div>
            
            <!-- Sub-tabs de Orçamentos -->
            <div class="sub-tabs" style="margin-bottom:25px;">
                <button class="sub-tab-btn active" onclick="switchSubTab('orcamento', 'novo')">
                    <i class="bi bi-file-earmark-plus"></i> Novo Orçamento
                </button>
                <button class="sub-tab-btn" onclick="switchSubTab('orcamento', 'pendentes')">
                    <i class="bi bi-clock-history"></i> Pendentes
                </button>
                <button class="sub-tab-btn" onclick="switchSubTab('orcamento', 'aprovados')">
                    <i class="bi bi-check-circle"></i> Aprovados
                </button>
                <button class="sub-tab-btn" onclick="switchSubTab('orcamento', 'rejeitados')">
                    <i class="bi bi-x-circle"></i> Rejeitados
                </button>
                <button class="sub-tab-btn" onclick="switchSubTab('orcamento', 'historico')">
                    <i class="bi bi-file-earmark-text"></i> Histórico
                </button>
            </div>
            
            <!-- Sub-tab: Novo Orçamento -->
            <div id="orcamento-subtab-novo" class="sub-tab-content active">
            <div class="card"><div class="card-header"><i class="bi bi-person-badge"></i> Dados do Cliente</div><div class="card-body"><div class="row g-3 mb-3"><div class="col-md-6"><label style="display:block;font-weight:700;margin-bottom:10px">CPF *</label><div style="position:relative"><input type="text" id="orcCPF" placeholder="Digite o CPF..." maxlength="14" class="form-control" onkeyup="buscarClientePorCPF()"><div id="cpfResults" class="autocomplete-results"></div></div></div><div class="col-md-6"><label style="display:block;font-weight:700;margin-bottom:10px">Nome Completo *</label><input type="text" id="orcNomeCliente" placeholder="Nome do cliente" class="form-control"></div></div><div class="row g-3 mb-3"><div class="col-md-6"><label style="display:block;font-weight:700;margin-bottom:10px">E-mail</label><input type="email" id="orcEmail" placeholder="email@exemplo.com" class="form-control"></div><div class="col-md-6"><label style="display:block;font-weight:700;margin-bottom:10px">Telefone</label><input type="text" id="orcTelefone" placeholder="(34) 99999-9999" class="form-control"></div></div><button class="btn btn-outline" onclick="limparCliente()"><i class="bi bi-x-circle"></i> Limpar</button></div></div>
            <h2 style="margin:40px 0 20px;color:var(--text-primary);padding-left:20px;border-left:6px solid var(--primary)"><i class="bi bi-scissors"></i> SERVIÇOS</h2>
            <div class="card"><div class="card-header"><i class="bi bi-plus-circle"></i> Adicionar Serviço</div><div class="card-body"><div class="row g-3"><div class="col-md-3"><label>Buscar Serviço</label><div style="position:relative"><input type="text" id="buscaServico" placeholder="Digite..." class="form-control" onkeyup="buscarServicos()"><div id="servicoResults" class="autocomplete-results"></div></div></div><div class="col-md-2"><label>Tamanho</label><select id="servicoTamanho" class="form-select"><option value="">Selecione...</option></select></div><div class="col-md-2"><label>Qtd</label><input type="number" id="servicoQtd" value="1" min="1" class="form-control"></div><div class="col-md-2"><label>Preço</label><input type="number" id="servicoPreco" step="0.01" class="form-control"></div><div class="col-md-2"><label>Desc %</label><input type="number" id="servicoDesconto" value="0" min="0" max="100" class="form-control"></div><div class="col-md-1"><label>&nbsp;</label><button class="btn btn-primary w-100" onclick="addServico()"><i class="bi bi-plus"></i></button></div></div></div></div>
            <div class="card"><div class="card-header"><i class="bi bi-list-check"></i> Serviços Adicionados</div><div class="card-body"><div class="table-responsive"><table><thead><tr><th>Serviço</th><th>Tamanho</th><th>Qtd</th><th>Preço Unit.</th><th>Desc %</th><th>Total</th><th></th></tr></thead><tbody id="servicosBody"><tr><td colspan="7" class="text-center text-muted">Nenhum serviço</td></tr></tbody><tfoot><tr><th colspan="5" style="text-align:right;padding:20px 18px;background:var(--bg-main);font-weight:800;border-top:4px solid var(--primary)">SUBTOTAL SERVIÇOS</th><th id="subtotalServicos" colspan="2" style="padding:20px 18px;background:var(--bg-main);font-weight:800;border-top:4px solid var(--primary)">R$ 0,00</th></tr></tfoot></table></div></div></div>
            <h2 style="margin:40px 0 20px;color:var(--text-primary);padding-left:20px;border-left:6px solid var(--primary)"><i class="bi bi-box-seam"></i> PRODUTOS</h2>
            <div class="card"><div class="card-header"><i class="bi bi-plus-circle"></i> Adicionar Produto</div><div class="card-body"><div class="row g-3"><div class="col-md-4"><label>Buscar Produto</label><div style="position:relative"><input type="text" id="buscaProduto" placeholder="Digite..." class="form-control" onkeyup="buscarProdutos()"><div id="produtoResults" class="autocomplete-results"></div></div></div><div class="col-md-2"><label>Qtd</label><input type="number" id="produtoQtd" value="1" min="1" class="form-control"></div><div class="col-md-2"><label>Preço</label><input type="number" id="produtoPreco" step="0.01" class="form-control"></div><div class="col-md-2"><label>Desc %</label><input type="number" id="produtoDesconto" value="0" min="0" max="100" class="form-control"></div><div class="col-md-2"><label>&nbsp;</label><button class="btn btn-primary w-100" onclick="addProduto()"><i class="bi bi-plus"></i> Add</button></div></div></div></div>
            <div class="card"><div class="card-header"><i class="bi bi-list-check"></i> Produtos Adicionados</div><div class="card-body"><div class="table-responsive"><table><thead><tr><th>Produto</th><th>Marca</th><th>Qtd</th><th>Preço Unit.</th><th>Desc %</th><th>Total</th><th></th></tr></thead><tbody id="produtosBody"><tr><td colspan="7" class="text-center text-muted">Nenhum produto</td></tr></tbody><tfoot><tr><th colspan="5" style="text-align:right;padding:20px 18px;background:var(--bg-main);font-weight:800;border-top:4px solid var(--primary)">SUBTOTAL PRODUTOS</th><th id="subtotalProdutos" colspan="2" style="padding:20px 18px;background:var(--bg-main);font-weight:800;border-top:4px solid var(--primary)">R$ 0,00</th></tr></tfoot></table></div></div></div>
            
            <!-- SEÇÃO DE PROFISSIONAIS VINCULADOS -->
            <h2 style="margin:40px 0 20px;color:var(--text-primary);padding-left:20px;border-left:6px solid var(--primary)">
                <i class="bi bi-people-fill"></i> PROFISSIONAIS E COMISSÕES
            </h2>
            
            <!-- Hidden fields para profissional selecionado -->
            <input type="hidden" id="profissionalSelecionadoId">
            <input type="hidden" id="profissionalSelecionadoNome">
            <input type="hidden" id="profissionalSelecionadoTipo">
            <input type="hidden" id="profissionalSelecionadoFoto">
            
            <div class="card">
                <div class="card-header">
                    <i class="bi bi-person-plus-fill"></i> Vincular Profissional/Assistente
                </div>
                <div class="card-body">
                    <div class="alert alert-info" style="margin-bottom:20px;">
                        <i class="bi bi-info-circle"></i> 
                        <strong>Multicomissões:</strong> Você pode adicionar múltiplos profissionais e assistentes ao orçamento. 
                        Cada um receberá a comissão percentual sobre o valor total.
                    </div>
                    
                    <div class="row g-3 mb-3">
                        <div class="col-md-5">
                            <label class="form-label" style="font-weight:700;">Buscar Profissional/Assistente</label>
                            <div style="position:relative;">
                                <input 
                                    type="text" 
                                    id="buscaProfissionalOrc" 
                                    placeholder="Digite o nome..." 
                                    class="form-control" 
                                    onkeyup="buscarProfissionaisOrcamento()"
                                    autocomplete="off"
                                >
                                <div id="profissionalOrcResults" class="autocomplete-results"></div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label" style="font-weight:700;">Comissão %</label>
                            <input 
                                type="number" 
                                id="profComissaoPerc" 
                                min="0" 
                                max="100" 
                                step="0.5" 
                                value="10" 
                                class="form-control"
                            >
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">&nbsp;</label>
                            <button class="btn btn-primary w-100" onclick="addProfissionalOrcamento()" style="font-weight:700;">
                                <i class="bi bi-plus-circle"></i> Adicionar ao Orçamento
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tabela de Profissionais Vinculados -->
            <div class="card">
                <div class="card-header">
                    <i class="bi bi-list-check"></i> Profissionais Vinculados ao Orçamento
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th style="width:60px;">Foto</th>
                                    <th>Nome</th>
                                    <th>Tipo</th>
                                    <th>Comissão %</th>
                                    <th>Valor Estimado</th>
                                    <th style="width:80px;">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="profissionaisVinculadosBody">
                                <tr>
                                    <td colspan="6" class="text-center text-muted" style="padding:30px;">
                                        <i class="bi bi-person-x" style="font-size:2rem;color:var(--text-muted);display:block;margin-bottom:10px;"></i>
                                        Nenhum profissional vinculado ao orçamento
                                    </td>
                                </tr>
                            </tbody>
                            <tfoot id="profissionaisVinculadosFooter" style="display:none;">
                                <tr>
                                    <th colspan="4" style="text-align:right;padding:20px 18px;background:var(--bg-main);font-weight:800;border-top:4px solid var(--success);">
                                        TOTAL DE COMISSÕES
                                    </th>
                                    <th colspan="2" id="totalComissoes" style="padding:20px 18px;background:var(--bg-main);font-weight:800;border-top:4px solid var(--success);color:var(--success);">
                                        R$ 0,00
                                    </th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
            <!-- FIM SEÇÃO DE PROFISSIONAIS -->
            
            <div class="card"><div class="card-header"><i class="bi bi-calculator"></i> Resumo e Pagamento</div><div class="card-body"><div class="row g-3 mb-3"><div class="col-md-4"><label>Desconto Global %</label><input type="number" id="descontoGlobal" value="0" min="0" max="100" onchange="calcularTotais()" class="form-control"></div><div class="col-md-4"><label>Cashback %</label><input type="number" id="cashbackPerc" value="0" min="0" max="100" onchange="calcularTotais()" class="form-control"></div><div class="col-md-4"><label>Forma de Pagamento</label><select id="pagamento" class="form-select"><option>Pix</option><option>Débito</option><option>Crédito à Vista</option><option>Crédito Parcelado</option><option>Dinheiro</option></select></div></div><div style="background:linear-gradient(135deg,var(--primary),var(--secondary));color:#fff;padding:40px;border-radius:22px;margin:30px 0;box-shadow:0 15px 40px rgba(124,58,237,0.4)"><div class="row align-items-center"><div class="col-md-6"><h3 id="totalFinalOrc" style="font-size:3.5rem;font-weight:900;margin:0;text-shadow:2px 2px 8px rgba(0,0,0,0.3)">R$ 0,00</h3><p style="font-size:1.3rem;margin:10px 0 0;opacity:0.95">TOTAL</p></div><div class="col-md-6" style="text-align:right"><p id="cashbackValor" style="font-size:1.5rem;margin:0;font-weight:700">🎁 Cashback: R$ 0,00</p></div></div></div><div style="text-align:center;margin-top:30px"><button class="btn btn-secondary" onclick="cancelarOrc()"><i class="bi bi-x-circle"></i> Cancelar</button> <button class="btn btn-outline" onclick="salvarOrc('Pendente')"><i class="bi bi-save"></i> Salvar Rascunho</button> <button class="btn btn-success" onclick="salvarOrc('Aprovado')"><i class="bi bi-check-circle"></i> Gerar Contrato</button></div></div></div>
            </div><!-- Fim sub-tab novo -->
            
            <!-- Sub-tab: Pendentes -->
            <div id="orcamento-subtab-pendentes" class="sub-tab-content">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-clock-history"></i> Orçamentos Pendentes
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Data</th>
                                        <th>Cliente</th>
                                        <th>CPF</th>
                                        <th>Valor Total</th>
                                        <th>Profissionais</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="orcamentosPendentesBody">
                                    <tr><td colspan="6" class="text-center text-muted">Carregando...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Sub-tab: Aprovados -->
            <div id="orcamento-subtab-aprovados" class="sub-tab-content">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-check-circle"></i> Orçamentos Aprovados
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Data</th>
                                        <th>Cliente</th>
                                        <th>CPF</th>
                                        <th>Valor Total</th>
                                        <th>Pagamento</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="orcamentosAprovadosBody">
                                    <tr><td colspan="6" class="text-center text-muted">Carregando...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Sub-tab: Rejeitados -->
            <div id="orcamento-subtab-rejeitados" class="sub-tab-content">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-x-circle"></i> Orçamentos Rejeitados
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Data</th>
                                        <th>Cliente</th>
                                        <th>CPF</th>
                                        <th>Valor Total</th>
                                        <th>Motivo</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="orcamentosRejeitadosBody">
                                    <tr><td colspan="6" class="text-center text-muted">Carregando...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Sub-tab: Histórico -->
            <div id="orcamento-subtab-historico" class="sub-tab-content">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-file-earmark-text"></i> Histórico Completo
                    </div>
                    <div class="card-body">
                        <div class="row g-3 mb-3">
                            <div class="col-md-3">
                                <label>Período</label>
                                <select id="filtroHistoricoPeriodo" class="form-select" onchange="carregarHistoricoOrcamentos()">
                                    <option value="7">Últimos 7 dias</option>
                                    <option value="30" selected>Últimos 30 dias</option>
                                    <option value="90">Últimos 3 meses</option>
                                    <option value="180">Últimos 6 meses</option>
                                    <option value="365">Último ano</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label>Status</label>
                                <select id="filtroHistoricoStatus" class="form-select" onchange="carregarHistoricoOrcamentos()">
                                    <option value="">Todos</option>
                                    <option value="Pendente">Pendente</option>
                                    <option value="Aprovado">Aprovado</option>
                                    <option value="Rejeitado">Rejeitado</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label>Buscar Cliente</label>
                                <input type="text" id="filtroHistoricoCliente" class="form-control" placeholder="Nome ou CPF" onkeyup="carregarHistoricoOrcamentos()">
                            </div>
                            <div class="col-md-2">
                                <label>&nbsp;</label>
                                <button class="btn btn-outline w-100" onclick="carregarHistoricoOrcamentos()">
                                    <i class="bi bi-search"></i> Filtrar
                                </button>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Data</th>
                                        <th>Cliente</th>
                                        <th>CPF</th>
                                        <th>Valor Total</th>
                                        <th>Status</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="orcamentosHistoricoBody">
                                    <tr><td colspan="6" class="text-center text-muted">Carregando...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
        </div>

        <div id="section-consultar" class="content-section">
            <div class="page-header">
                <h1><i class="bi bi-search"></i> Consultar Orçamentos</h1>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-success btn-sm" onclick="exportarOrcamentosExcel()" title="Exportar para Excel">
                        <i class="bi bi-file-earmark-excel"></i> Excel
                    </button>
                    <button class="btn btn-info btn-sm" onclick="exportarOrcamentosCSV()" title="Exportar para CSV">
                        <i class="bi bi-file-earmark-text"></i> CSV
                    </button>
                </div>
            </div>

            <!-- Filtros e Pesquisa -->
            <div class="card mb-3">
                <div class="card-body" style="padding: 15px;">
                    <div class="row g-3 align-items-end">
                        <div class="col-md-4">
                            <label style="display: block; margin-bottom: 5px; font-size: 0.9em; color: #6c757d;">
                                <i class="bi bi-search"></i> Pesquisar
                            </label>
                            <input type="text" id="consultaSearch" class="form-control" placeholder="Buscar por número, cliente..."
                                   oninput="filtrarOrcamentos()" style="font-size: 0.95em;">
                        </div>
                        <div class="col-md-2">
                            <label style="display: block; margin-bottom: 5px; font-size: 0.9em; color: #6c757d;">
                                <i class="bi bi-funnel"></i> Status
                            </label>
                            <select id="consultaStatusFilter" class="form-control" onchange="filtrarOrcamentos()" style="font-size: 0.95em;">
                                <option value="">Todos</option>
                                <option value="Pendente">Pendente</option>
                                <option value="Aprovado">Aprovado</option>
                                <option value="Cancelado">Cancelado</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label style="display: block; margin-bottom: 5px; font-size: 0.9em; color: #6c757d;">
                                <i class="bi bi-calendar"></i> Data Início
                            </label>
                            <input type="date" id="consultaDataInicio" class="form-control" onchange="filtrarOrcamentos()" style="font-size: 0.95em;">
                        </div>
                        <div class="col-md-2">
                            <label style="display: block; margin-bottom: 5px; font-size: 0.9em; color: #6c757d;">
                                <i class="bi bi-calendar-check"></i> Data Fim
                            </label>
                            <input type="date" id="consultaDataFim" class="form-control" onchange="filtrarOrcamentos()" style="font-size: 0.95em;">
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-outline w-100" onclick="limparFiltrosOrcamentos()" style="font-size: 0.95em;">
                                <i class="bi bi-x-circle"></i> Limpar
                            </button>
                        </div>
                    </div>
                    <div style="margin-top: 10px; font-size: 0.85em; color: #6c757d;">
                        <i class="bi bi-info-circle"></i> <span id="consultaResultCount">Carregando...</span>
                    </div>
                </div>
            </div>

            <div class="card"><div class="card-header"><i class="bi bi-list-ul"></i> Todos os Orçamentos</div><div class="card-body"><div class="table-responsive"><table><thead><tr><th>Nº</th><th>Data</th><th>Cliente</th><th>Total</th><th>Status</th><th>Ações</th></tr></thead><tbody id="consultaBody"><tr><td colspan="6" class="text-center"><div class="spinner"></div></td></tr></tbody></table></div></div></div>
        </div>

        <div id="section-contratos" class="content-section">
            <div class="page-header">
                <h1><i class="bi bi-file-earmark-check"></i> Contratos Aprovados</h1>
                <button class="btn btn-success" onclick="loadContratos()"><i class="bi bi-arrow-clockwise"></i> Atualizar</button>
            </div>
            <div class="card">
                <div class="card-header"><i class="bi bi-file-check-fill"></i> Orçamentos Aprovados como Contratos</div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>Nº Orçamento</th>
                                    <th>Data Aprovação</th>
                                    <th>Cliente</th>
                                    <th>Valor Total</th>
                                    <th>Status</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="contratosBody">
                                <tr><td colspan="6" class="text-center"><div class="spinner"></div></td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="section-relatorios" class="content-section">
            <div class="page-header">
                <h1><i class="bi bi-bar-chart-line"></i> Relatórios e Análises</h1>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-outline" onclick="loadRelatorios()"><i class="bi bi-arrow-clockwise"></i> Atualizar</button>
                    <button class="btn btn-success" onclick="exportarRelatorio()"><i class="bi bi-file-earmark-excel"></i> Exportar Excel</button>
                </div>
            </div>

            <!-- Sub-tabs para Relatórios -->
            <div class="sub-tabs">
                <button class="sub-tab-btn active" onclick="showSubTab('relatorios', 'resumo')">
                    <i class="bi bi-graph-up"></i> Resumo
                </button>
                <button class="sub-tab-btn" onclick="showSubTab('relatorios', 'mapa')">
                    <i class="bi bi-calendar-heat"></i> Mapa de Calor
                </button>
                <button class="sub-tab-btn" onclick="showSubTab('relatorios', 'clientes')">
                    <i class="bi bi-people-fill"></i> Top Clientes
                </button>
                <button class="sub-tab-btn" onclick="showSubTab('relatorios', 'produtos')">
                    <i class="bi bi-box-seam"></i> Top Produtos
                </button>
            </div>

            <!-- Sub-tab: Resumo -->
            <div id="relatorios-resumo" class="sub-tab-content active">
                <div class="row g-4 mb-4">
                    <div class="col-md-3"><div class="stat-card"><div class="icon"><i class="bi bi-cash-stack"></i></div><h3 id="relFaturamentoTotal">R$ 0</h3><p>Faturamento Total</p></div></div>
                    <div class="col-md-3"><div class="stat-card"><div class="icon"><i class="bi bi-calendar-month"></i></div><h3 id="relFaturamentoMes">R$ 0</h3><p>Faturamento Mês</p></div></div>
                    <div class="col-md-3"><div class="stat-card"><div class="icon"><i class="bi bi-award"></i></div><h3 id="relCashbackTotal">R$ 0</h3><p>Cashback Gerado</p></div></div>
                    <div class="col-md-3"><div class="stat-card"><div class="icon"><i class="bi bi-graph-up"></i></div><h3 id="relTicketMedio">R$ 0</h3><p>Ticket Médio</p></div></div>
                </div>
                <div class="row g-4">
                    <div class="col-md-6"><div class="card"><div class="card-header"><i class="bi bi-trophy"></i> Top 5 Serviços</div><div class="card-body"><canvas id="chartServicos" style="max-height:300px"></canvas></div></div></div>
                    <div class="col-md-6"><div class="card"><div class="card-header"><i class="bi bi-calendar3"></i> Faturamento Mensal</div><div class="card-body"><canvas id="chartFaturamento" style="max-height:300px"></canvas></div></div></div>
                </div>
            </div>

            <!-- Sub-tab: Mapa de Calor -->
            <div id="relatorios-mapa" class="sub-tab-content">
                <div class="card mb-4">
                    <div class="card-header">
                        <i class="bi bi-calendar-heat"></i> Mapa de Calor - Dias Mais Movimentados
                        <button class="btn btn-sm btn-outline" onclick="carregarMapaCalor()" style="float: right;">
                            <i class="bi bi-arrow-clockwise"></i> Atualizar
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i> Este mapa mostra os dias mais movimentados da unidade nos últimos 90 dias.
                            Quanto mais escuro, mais atendimentos realizados.
                        </div>
                        <div id="mapaCalorContainer" class="mapa-calor-grid">
                            <div class="spinner"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sub-tab: Top Clientes -->
            <div id="relatorios-clientes" class="sub-tab-content">
                <div class="card">
                    <div class="card-header"><i class="bi bi-people-fill"></i> Top 10 Clientes VIP</div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table>
                                <thead><tr><th>Posição</th><th>Cliente</th><th>Total Gasto</th><th>Visitas</th><th>Última Visita</th></tr></thead>
                                <tbody id="topClientesBody"><tr><td colspan="5" class="text-center text-muted">Clique em "Atualizar"</td></tr></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sub-tab: Top Produtos -->
            <div id="relatorios-produtos" class="sub-tab-content">
                <div class="card">
                    <div class="card-header"><i class="bi bi-box-seam"></i> Produtos Mais Vendidos</div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table>
                                <thead><tr><th>Produto</th><th>Qtd Vendida</th><th>Faturamento</th></tr></thead>
                                <tbody id="topProdutosBody"><tr><td colspan="3" class="text-center text-muted">Clique em "Atualizar"</td></tr></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="section-agendamentos" class="content-section">
            <div class="page-header">
                <h1><i class="bi bi-calendar-check"></i> Agendamentos</h1>
                <button class="btn btn-primary" onclick="showModalAgendamento()"><i class="bi bi-plus-circle"></i> Novo Agendamento</button>
            </div>
            
            <!-- Sub-tabs de Agendamentos -->
            <div class="sub-tabs" style="margin-bottom:25px;">
                <button class="sub-tab-btn active" onclick="switchSubTab('agendamentos', 'hoje')">
                    <i class="bi bi-calendar-day"></i> Hoje
                </button>
                <button class="sub-tab-btn" onclick="switchSubTab('agendamentos', 'semana')">
                    <i class="bi bi-calendar-week"></i> Esta Semana
                </button>
                <button class="sub-tab-btn" onclick="switchSubTab('agendamentos', 'mes')">
                    <i class="bi bi-calendar-month"></i> Este Mês
                </button>
                <button class="sub-tab-btn" onclick="switchSubTab('agendamentos', 'todos')">
                    <i class="bi bi-calendar3"></i> Todos
                </button>
            </div>
            
            <!-- Sub-tab: Hoje -->
            <div id="agendamentos-subtab-hoje" class="sub-tab-content active">
                <div class="row g-4 mb-4">
                    <div class="col-md-3">
                        <div class="stat-card" style="background:linear-gradient(135deg,#10b981,#059669);">
                            <div class="stat-icon"><i class="bi bi-calendar-check"></i></div>
                            <div class="stat-info">
                                <div class="stat-value" id="agendamentosHojeTotal">0</div>
                                <div class="stat-label">Agendamentos Hoje</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card" style="background:linear-gradient(135deg,#3b82f6,#2563eb);">
                            <div class="stat-icon"><i class="bi bi-clock"></i></div>
                            <div class="stat-info">
                                <div class="stat-value" id="agendamentosHojePendentes">0</div>
                                <div class="stat-label">Pendentes</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card" style="background:linear-gradient(135deg,#8b5cf6,#7c3aed);">
                            <div class="stat-icon"><i class="bi bi-check-circle"></i></div>
                            <div class="stat-info">
                                <div class="stat-value" id="agendamentosHojeConfirmados">0</div>
                                <div class="stat-label">Confirmados</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card" style="background:linear-gradient(135deg,#ef4444,#dc2626);">
                            <div class="stat-icon"><i class="bi bi-x-circle"></i></div>
                            <div class="stat-info">
                                <div class="stat-value" id="agendamentosHojeCancelados">0</div>
                                <div class="stat-label">Cancelados</div>
                            </div>
                        </div>
                    </div>
                </div>
            <div class="row g-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header"><i class="bi bi-calendar-day"></i> Agendamentos de Hoje</div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Horário</th>
                                            <th>Cliente</th>
                                            <th>Serviço</th>
                                            <th>Profissional</th>
                                            <th>Status</th>
                                            <th>Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody id="agendamentosHojeBody">
                                        <tr><td colspan="6" class="text-center"><div class="spinner"></div></td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            </div>
            
            <!-- Sub-tab: Esta Semana -->
            <div id="agendamentos-subtab-semana" class="sub-tab-content d-none">
                <div class="card">
                    <div class="card-header"><i class="bi bi-calendar-week"></i> Agendamentos da Semana</div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Data</th>
                                        <th>Horário</th>
                                        <th>Cliente</th>
                                        <th>Serviço</th>
                                        <th>Profissional</th>
                                        <th>Status</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="agendamentosSemanaBody">
                                    <tr><td colspan="7" class="text-center"><div class="spinner"></div></td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Sub-tab: Este Mês -->
            <div id="agendamentos-subtab-mes" class="sub-tab-content d-none">
                <div class="card">
                    <div class="card-header"><i class="bi bi-calendar-month"></i> Agendamentos do Mês</div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Data</th>
                                        <th>Horário</th>
                                        <th>Cliente</th>
                                        <th>Serviço</th>
                                        <th>Profissional</th>
                                        <th>Status</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="agendamentosMesBody">
                                    <tr><td colspan="7" class="text-center"><div class="spinner"></div></td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Sub-tab: Todos -->
            <div id="agendamentos-subtab-todos" class="sub-tab-content d-none">
                <div class="card">
                    <div class="card-header"><i class="bi bi-calendar3"></i> Todos os Agendamentos</div>
                    <div class="card-body">
                        <div class="row g-3 mb-3">
                            <div class="col-md-4">
                                <label>Data Inicial</label>
                                <input type="date" id="filtroAgendamentoDataInicio" class="form-control">
                            </div>
                            <div class="col-md-4">
                                <label>Data Final</label>
                                <input type="date" id="filtroAgendamentoDataFim" class="form-control">
                            </div>
                            <div class="col-md-4">
                                <label>Status</label>
                                <select id="filtroAgendamentoStatus" class="form-select">
                                    <option value="">Todos</option>
                                    <option value="Confirmado">Confirmado</option>
                                    <option value="Pendente">Pendente</option>
                                    <option value="Cancelado">Cancelado</option>
                                    <option value="Concluído">Concluído</option>
                                </select>
                            </div>
                        </div>
                        <button class="btn btn-primary mb-3" onclick="carregarTodosAgendamentos()">
                            <i class="bi bi-search"></i> Filtrar
                        </button>
                        <div class="table-responsive">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Data</th>
                                        <th>Horário</th>
                                        <th>Cliente</th>
                                        <th>Serviço</th>
                                        <th>Profissional</th>
                                        <th>Status</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="agendamentosTodosBody">
                                    <tr><td colspan="7" class="text-center"><div class="spinner"></div></td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="section-fila" class="content-section">
            <div class="page-header">
                <h1><i class="bi bi-people-fill"></i> Fila de Atendimento</h1>
                <button class="btn btn-primary" onclick="showModalFila()"><i class="bi bi-plus-circle"></i> Adicionar à Fila</button>
            </div>
            <div class="card">
                <div class="card-header">
                    <i class="bi bi-list-ol"></i> Fila Atual 
                    <span class="badge success" style="margin-left: 10px; font-size: 1rem;">
                        <i class="bi bi-people"></i> <span id="totalFila">0</span> pessoas
                    </span>
                </div>
                <div class="card-body" id="filaContainer">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>

        <div id="section-clientes" class="content-section">
            <div class="page-header">
                <h1><i class="bi bi-people"></i> Clientes</h1>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn btn-success btn-sm" onclick="exportarClientes('excel')" title="Exportar para Excel">
                        <i class="bi bi-file-earmark-excel"></i> Excel
                    </button>
                    <button class="btn btn-info btn-sm" onclick="exportarClientes('csv')" title="Exportar para CSV">
                        <i class="bi bi-file-earmark-text"></i> CSV
                    </button>
                    <button class="btn btn-primary" onclick="showModalCliente()"><i class="bi bi-person-plus"></i> Novo</button>
                </div>
            </div>

            <!-- Sub-tabs para Clientes -->
            <div class="sub-tabs">
                <button class="sub-tab-btn active" onclick="showSubTab('clientes', 'lista')">
                    <i class="bi bi-people-fill"></i> Lista
                </button>
                <button class="sub-tab-btn" onclick="showSubTab('clientes', 'anamnese')">
                    <i class="bi bi-file-medical"></i> Anamnese
                </button>
                <button class="sub-tab-btn" onclick="showSubTab('clientes', 'prontuario')">
                    <i class="bi bi-clipboard2-pulse"></i> Prontuário
                </button>
                <button class="sub-tab-btn" onclick="showSubTab('clientes', 'faturamento')">
                    <i class="bi bi-currency-dollar"></i> Faturamento
                </button>
            </div>

            <!-- Sub-tab: Lista de Clientes -->
            <div id="clientes-lista" class="sub-tab-content active">
                <div class="card">
                    <div class="card-header"><i class="bi bi-people-fill"></i> Lista de Clientes</div>
                    <div class="card-body">
                        <div class="mb-3"><input type="text" class="form-control" id="buscaCliente" placeholder="🔍 Buscar..." onkeyup="filtrarClientes()"></div>
                        <div class="table-responsive">
                            <table>
                                <thead><tr><th>Nome</th><th>CPF</th><th>Telefone</th><th>Total Gasto</th><th>Visitas</th><th>Ações</th></tr></thead>
                                <tbody id="clientesBody"><tr><td colspan="6" class="text-center"><div class="spinner"></div></td></tr></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sub-tab: Anamnese -->
            <div id="clientes-anamnese" class="sub-tab-content">
                <div class="card mb-4">
                    <div class="card-header"><i class="bi bi-funnel"></i> Buscar Cliente</div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-8">
                                <label class="form-label">CPF do Cliente</label>
                                <input type="text" id="anamneseCPF" class="form-control" placeholder="000.000.000-00" maxlength="14">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">&nbsp;</label>
                                <button class="btn btn-primary w-100" onclick="buscarAnamnesesCliente()">
                                    <i class="bi bi-search"></i> Buscar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="anamnesesResultado" style="display:none;">
                    <div class="card mb-4">
                        <div class="card-header">
                            <i class="bi bi-person-badge"></i> Cliente: <span id="anamnesesClienteNome"></span>
                            <button class="btn btn-sm btn-success float-end" onclick="novaAnamneseModal()">
                                <i class="bi bi-plus-circle"></i> Nova Anamnese
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle"></i> 
                                <strong>Histórico de Anamneses:</strong> Visualize todas as anamneses anteriores e compare as mudanças ao longo do tempo.
                            </div>
                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Versão</th>
                                            <th>Data</th>
                                            <th>Cadastrado por</th>
                                            <th>Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody id="anamnesesHistoricoBody">
                                        <tr><td colspan="4" class="text-center text-muted">Nenhuma anamnese encontrada</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="anamneseMensagemInicial">
                    <div class="alert alert-info">
                        <h4><i class="bi bi-info-circle"></i> Sistema de Anamnese</h4>
                        <p><strong>1.</strong> Digite o CPF do cliente no campo acima</p>
                        <p><strong>2.</strong> Clique em "Buscar" para ver o histórico de anamneses</p>
                        <p><strong>3.</strong> Clique em "Nova Anamnese" para cadastrar uma nova</p>
                        <p><strong>4.</strong> Visualize ou compare anamneses anteriores</p>
                    </div>
                </div>
            </div>

            <!-- Sub-tab: Prontuário -->
            <div id="clientes-prontuario" class="sub-tab-content">
                <div class="card mb-4">
                    <div class="card-header"><i class="bi bi-funnel"></i> Buscar Cliente</div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-8">
                                <label class="form-label">CPF do Cliente</label>
                                <input type="text" id="prontuarioCPF" class="form-control" placeholder="000.000.000-00" maxlength="14">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">&nbsp;</label>
                                <button class="btn btn-primary w-100" onclick="buscarProntuariosCliente()">
                                    <i class="bi bi-search"></i> Buscar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="prontuariosResultado" style="display:none;">
                    <div class="card mb-4">
                        <div class="card-header">
                            <i class="bi bi-person-badge"></i> Cliente: <span id="prontuariosClienteNome"></span>
                            <button class="btn btn-sm btn-success float-end" onclick="novoProntuarioModal()">
                                <i class="bi bi-plus-circle"></i> Novo Prontuário
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle"></i> 
                                <strong>Histórico de Atendimentos:</strong> Registro completo de todos os procedimentos realizados.
                            </div>
                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Data Atendimento</th>
                                            <th>Profissional</th>
                                            <th>Procedimento</th>
                                            <th>Próxima Sessão</th>
                                            <th>Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody id="prontuariosHistoricoBody">
                                        <tr><td colspan="5" class="text-center text-muted">Nenhum prontuário encontrado</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="prontuarioMensagemInicial">
                    <div class="alert alert-info">
                        <h4><i class="bi bi-info-circle"></i> Sistema de Prontuário</h4>
                        <p><strong>1.</strong> Digite o CPF do cliente no campo acima</p>
                        <p><strong>2.</strong> Clique em "Buscar" para ver o histórico de atendimentos</p>
                        <p><strong>3.</strong> Clique em "Novo Prontuário" para registrar um atendimento</p>
                        <p><strong>4.</strong> Visualize, edite ou delete prontuários anteriores</p>
                    </div>
                </div>
            </div>

            <!-- Sub-tab: Faturamento -->
            <div id="clientes-faturamento" class="sub-tab-content">
                <div class="card">
                    <div class="card-header"><i class="bi bi-currency-dollar"></i> Faturamento por Cliente</div>
                    <div class="card-body">
                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <label class="form-label-custom">Selecionar Cliente</label>
                                <select class="form-select" id="selectClienteFaturamento">
                                    <option value="">-- Escolha um cliente --</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label-custom">&nbsp;</label>
                                <button class="btn btn-primary w-100" onclick="carregarFaturamentoCliente()">
                                    <i class="bi bi-bar-chart"></i> Carregar Dados
                                </button>
                            </div>
                        </div>
                        <div id="faturamentoClienteInfo">
                            <p class="text-center text-muted">Selecione um cliente para ver o faturamento total</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="section-profissionais" class="content-section">
            <div class="page-header">
                <h1><i class="bi bi-person-workspace"></i> Profissionais</h1>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn btn-success btn-sm" onclick="exportarProfissionais('excel')" title="Exportar para Excel">
                        <i class="bi bi-file-earmark-excel"></i> Excel
                    </button>
                    <button class="btn btn-info btn-sm" onclick="exportarProfissionais('csv')" title="Exportar para CSV">
                        <i class="bi bi-file-earmark-text"></i> CSV
                    </button>
                    <button class="btn btn-primary" onclick="showModalProfissional()"><i class="bi bi-person-plus"></i> Novo</button>
                </div>
            </div>
            
            <!-- Sub-tabs para Profissionais -->
            <div class="sub-tabs">
                <button class="sub-tab-btn active" onclick="showSubTab('profissionais', 'lista')">
                    <i class="bi bi-people-fill"></i> Lista de Profissionais
                </button>
                <button class="sub-tab-btn" onclick="showSubTab('profissionais', 'calendario')">
                    <i class="bi bi-calendar3"></i> Calendário
                </button>
                <button class="sub-tab-btn" onclick="showSubTab('profissionais', 'comissoes')">
                    <i class="bi bi-cash-stack"></i> Comissões
                </button>
                <button class="sub-tab-btn" onclick="showSubTab('profissionais', 'estatisticas')">
                    <i class="bi bi-graph-up"></i> Estatísticas
                </button>
                <button class="sub-tab-btn" onclick="showSubTab('profissionais', 'assistentes')">
                    <i class="bi bi-person-badge"></i> Assistentes
                </button>
            </div>

            <!-- Sub-tab: Lista de Profissionais -->
            <div id="profissionais-lista" class="sub-tab-content active">
                <div class="card">
                    <div class="card-header"><i class="bi bi-people-fill"></i> Equipe BIOMA</div>
                    <div class="card-body">
                        <div class="mb-3">
                            <input type="text" class="form-control" id="buscaProfissionais" placeholder="Buscar profissional..." oninput="filtrarProfissionais()">
                        </div>
                        <div class="table-responsive">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Foto</th>
                                        <th>Nome</th>
                                        <th>CPF</th>
                                        <th>Especialidade</th>
                                        <th>Comissão</th>
                                        <th>Assistentes</th>
                                        <th>Status</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="profissionaisBody">
                                    <tr><td colspan="8" class="text-center"><div class="spinner"></div></td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sub-tab: Calendário de Profissionais -->
            <div id="profissionais-calendario" class="sub-tab-content">
                <!-- Controles do Calendário -->
                <div class="card mb-4">
                    <div class="card-header">
                        <i class="bi bi-funnel-fill"></i> Filtros e Visualização
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label">
                                    <i class="bi bi-person"></i> Filtrar por Profissional
                                </label>
                                <select id="filtroCalendarioProfissional" class="form-select" onchange="carregarCalendario()">
                                    <option value="">Todos os Profissionais</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">
                                    <i class="bi bi-eye"></i> Visualização
                                </label>
                                <select id="visualizacaoCalendario" class="form-select" onchange="alterarVisualizacaoCalendario()">
                                    <option value="dayGridMonth">Mês</option>
                                    <option value="timeGridWeek">Semana</option>
                                    <option value="timeGridDay">Dia</option>
                                    <option value="listWeek">Lista Semanal</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">
                                    <i class="bi bi-calendar-plus"></i> Ações Rápidas
                                </label>
                                <div style="display: flex; gap: 10px;">
                                    <button class="btn btn-success flex-fill" onclick="novoAgendamentoRapido()">
                                        <i class="bi bi-plus-circle"></i> Novo Agendamento
                                    </button>
                                    <button class="btn btn-outline" onclick="calendarioHoje()">
                                        <i class="bi bi-calendar-event"></i> Hoje
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Legenda de Cores -->
                <div class="card mb-4">
                    <div class="card-body">
                        <div style="display: flex; align-items: center; gap: 20px; flex-wrap: wrap;">
                            <strong><i class="bi bi-palette"></i> Legenda:</strong>
                            <div id="legendaProfissionais" style="display: flex; gap: 15px; flex-wrap: wrap;">
                                <!-- Será populado dinamicamente -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Calendário Principal -->
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-calendar3"></i> Calendário de Agendamentos
                    </div>
                    <div class="card-body">
                        <div id="calendarioProfissionais" style="background: var(--bg-main); padding: 20px; border-radius: 15px;">
                            <!-- FullCalendar será renderizado aqui -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sub-tab: Comissões Multiníveis -->
            <div id="profissionais-comissoes" class="sub-tab-content">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-funnel"></i> Filtros
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label">Profissional</label>
                                <select id="filtroComissoesProfissional" class="form-select">
                                    <option value="">Selecione um profissional</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Data Início</label>
                                <input type="date" id="filtroComissoesDataInicio" class="form-control">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Data Fim</label>
                                <input type="date" id="filtroComissoesDataFim" class="form-control">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Status</label>
                                <select id="filtroComissoesStatus" class="form-select">
                                    <option value="">Todos</option>
                                    <option value="Pendente">Pendente</option>
                                    <option value="Aprovado">Aprovado</option>
                                    <option value="Rejeitado">Rejeitado</option>
                                </select>
                            </div>
                        </div>
                        <div class="mt-3">
                            <button class="btn btn-primary" onclick="carregarComissoesProfissional()">
                                <i class="bi bi-search"></i> Filtrar
                            </button>
                            <button class="btn btn-outline" onclick="limparFiltrosComissoes()">
                                <i class="bi bi-x-circle"></i> Limpar
                            </button>
                            <button class="btn btn-success" onclick="exportarComissoesExcel()">
                                <i class="bi bi-file-earmark-excel"></i> Exportar Excel
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Cards de Estatísticas -->
                <div id="comissoesEstatisticasCards" style="display:none;">
                    <div class="row g-4 mb-4 mt-3">
                        <div class="col-lg-4 col-md-6">
                            <div class="stat-card">
                                <div class="icon"><i class="bi bi-cash-coin"></i></div>
                                <h3 id="statTotalComissoes">R$ 0,00</h3>
                                <p>Total de Comissões</p>
                            </div>
                        </div>
                        <div class="col-lg-4 col-md-6">
                            <div class="stat-card">
                                <div class="icon"><i class="bi bi-file-earmark-text"></i></div>
                                <h3 id="statTotalOrcamentos">0</h3>
                                <p>Orçamentos Participados</p>
                            </div>
                        </div>
                        <div class="col-lg-4 col-md-6">
                            <div class="stat-card">
                                <div class="icon"><i class="bi bi-graph-up-arrow"></i></div>
                                <h3 id="statMediaComissao">R$ 0,00</h3>
                                <p>Média por Orçamento</p>
                            </div>
                        </div>
                    </div>

                    <!-- Gráfico de Evolução Mensal -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <i class="bi bi-graph-up"></i> Evolução de Comissões (Mensal)
                        </div>
                        <div class="card-body">
                            <canvas id="graficoComissoesMensal" height="80"></canvas>
                        </div>
                    </div>

                    <!-- Tabela de Histórico -->
                    <div class="card">
                        <div class="card-header">
                            <i class="bi bi-clock-history"></i> Histórico Detalhado
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Data</th>
                                            <th>Orçamento</th>
                                            <th>Tipo</th>
                                            <th>Valor Base</th>
                                            <th>Comissão %</th>
                                            <th>Valor Comissão</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tabelaHistoricoComissoes">
                                        <tr>
                                            <td colspan="7" class="text-center text-muted">
                                                Selecione um profissional nos filtros acima
                                            </td>
                                        </tr>
                                    </tbody>
                                    <tfoot id="tfootComissoes" style="display:none;">
                                        <tr>
                                            <th colspan="5" class="text-end">TOTAL:</th>
                                            <th id="totalComissoesFooter">R$ 0,00</th>
                                            <th></th>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Mensagem inicial -->
                <div id="comissoesMensagemInicial">
                    <div class="alert alert-info mt-4">
                        <h4><i class="bi bi-info-circle"></i> Como usar esta seção</h4>
                        <p><strong>1.</strong> Selecione um profissional no filtro acima</p>
                        <p><strong>2.</strong> (Opcional) Defina um período e status para filtrar</p>
                        <p><strong>3.</strong> Clique em "Filtrar" para ver as estatísticas e histórico</p>
                        <p><strong>4.</strong> Use "Exportar Excel" para gerar relatório completo</p>
                    </div>
                </div>
            </div>

            <!-- Sub-tab: Estatísticas Gerais -->
            <div id="profissionais-estatisticas" class="sub-tab-content">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-trophy"></i> Ranking de Profissionais
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Foto</th>
                                        <th>Nome</th>
                                        <th>Tipo</th>
                                        <th>Total Comissões</th>
                                        <th>Orçamentos</th>
                                        <th>Média</th>
                                    </tr>
                                </thead>
                                <tbody id="rankingProfissionaisBody">
                                    <tr>
                                        <td colspan="7" class="text-center">
                                            <div class="spinner"></div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sub-tab: Assistentes -->
            <div id="profissionais-assistentes" class="sub-tab-content">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-person-badge"></i> Gestão de Assistentes
                    </div>
                    <div class="card-body">
                        <button class="btn btn-success mb-3" onclick="cadastrarAssistenteIndependente()">
                            <i class="bi bi-person-plus"></i> Cadastrar Assistente Independente
                        </button>
                        
                        <div class="table-responsive">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Nome</th>
                                        <th>CPF</th>
                                        <th>Profissional Vinculado</th>
                                        <th>% Comissão</th>
                                        <th>Status</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="assistentesBody">
                                    <tr><td colspan="6" class="text-center">Carregando...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <div id="section-servicos" class="content-section">
            <div class="page-header">
                <h1><i class="bi bi-scissors"></i> Serviços</h1>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn btn-success btn-sm" onclick="ativarTodosServicos()" title="Ativar todos os serviços">
                        <i class="bi bi-check-circle-fill"></i> Ativar Todos
                    </button>
                    <button class="btn btn-danger btn-sm" onclick="desativarTodosServicos()" title="Desativar todos os serviços">
                        <i class="bi bi-x-circle-fill"></i> Desativar Todos
                    </button>
                    <button class="btn btn-success btn-sm" onclick="exportarServicos('excel')" title="Exportar para Excel">
                        <i class="bi bi-file-earmark-excel"></i> Excel
                    </button>
                    <button class="btn btn-info btn-sm" onclick="exportarServicos('csv')" title="Exportar para CSV">
                        <i class="bi bi-file-earmark-text"></i> CSV
                    </button>
                    <button class="btn btn-primary" onclick="showModalServico()"><i class="bi bi-plus-circle"></i> Novo</button>
                </div>
            </div>

            <!-- Sub-tabs para Serviços -->
            <div class="sub-tabs">
                <button class="sub-tab-btn active" onclick="switchSubTab('servicos', 'todos')">
                    <i class="bi bi-list-ul"></i> Todos
                </button>
                <button class="sub-tab-btn" onclick="switchSubTab('servicos', 'ativos')">
                    <i class="bi bi-check-circle"></i> Ativos
                </button>
                <button class="sub-tab-btn" onclick="switchSubTab('servicos', 'inativos')">
                    <i class="bi bi-x-circle"></i> Inativos
                </button>
            </div>

            <!-- Sub-tab: Todos -->
            <div id="servicos-subtab-todos" class="sub-tab-content active">
                <div class="card">
                    <div class="card-header"><i class="bi bi-list-ul"></i> Todos os Serviços</div>
                    <div class="card-body">
                        <div class="row g-3 mb-3">
                            <div class="col-md-8">
                                <input type="text" class="form-control" id="buscaServicosTodos" placeholder="Buscar por nome, categoria..." onkeyup="filtrarServicosTodos()">
                            </div>
                            <div class="col-md-4">
                                <select class="form-select" id="filtroCategoria" onchange="filtrarServicosTodos()">
                                    <option value="">Todas as categorias</option>
                                    <option value="Estética">Estética</option>
                                    <option value="Capilar">Capilar</option>
                                    <option value="Corporal">Corporal</option>
                                    <option value="Facial">Facial</option>
                                </select>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Nome</th>
                                        <th>Categoria</th>
                                        <th>Tamanho</th>
                                        <th>Preço</th>
                                        <th>Status</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="servicosTodosBody">
                                    <tr><td colspan="6" class="text-center"><div class="spinner"></div></td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sub-tab: Ativos -->
            <div id="servicos-subtab-ativos" class="sub-tab-content d-none">
                <div class="card">
                    <div class="card-header"><i class="bi bi-check-circle"></i> Serviços Ativos</div>
                    <div class="card-body">
                        <div class="mb-3">
                            <input type="text" class="form-control" id="buscaServicosAtivos" placeholder="Buscar serviço ativo..." onkeyup="filtrarServicosAtivos()">
                        </div>
                        <div class="table-responsive">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Nome</th>
                                        <th>Categoria</th>
                                        <th>Tamanho</th>
                                        <th>Preço</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="servicosAtivosBody">
                                    <tr><td colspan="5" class="text-center"><div class="spinner"></div></td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sub-tab: Inativos -->
            <div id="servicos-subtab-inativos" class="sub-tab-content d-none">
                <div class="card">
                    <div class="card-header"><i class="bi bi-x-circle"></i> Serviços Inativos</div>
                    <div class="card-body">
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle"></i> 
                            Serviços inativos não aparecem no sistema de orçamentos
                        </div>
                        <div class="table-responsive">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Nome</th>
                                        <th>Categoria</th>
                                        <th>Tamanho</th>
                                        <th>Preço</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="servicosInativosBody">
                                    <tr><td colspan="5" class="text-center text-muted">Nenhum serviço inativo</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="section-produtos" class="content-section">
            <div class="page-header">
                <h1><i class="bi bi-box-seam"></i> Produtos</h1>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn btn-success btn-sm" onclick="ativarTodosProdutos()" title="Ativar todos os produtos">
                        <i class="bi bi-check-circle-fill"></i> Ativar Todos
                    </button>
                    <button class="btn btn-danger btn-sm" onclick="desativarTodosProdutos()" title="Desativar todos os produtos">
                        <i class="bi bi-x-circle-fill"></i> Desativar Todos
                    </button>
                    <button class="btn btn-success btn-sm" onclick="exportarProdutos('excel')" title="Exportar para Excel">
                        <i class="bi bi-file-earmark-excel"></i> Excel
                    </button>
                    <button class="btn btn-info btn-sm" onclick="exportarProdutos('csv')" title="Exportar para CSV">
                        <i class="bi bi-file-earmark-text"></i> CSV
                    </button>
                    <button class="btn btn-primary" onclick="showModalProduto()"><i class="bi bi-plus-circle"></i> Novo</button>
                </div>
            </div>

            <!-- Sub-tabs para Produtos -->
            <div class="sub-tabs">
                <button class="sub-tab-btn active" onclick="switchSubTab('produtos', 'todos')">
                    <i class="bi bi-box-fill"></i> Todos
                </button>
                <button class="sub-tab-btn" onclick="switchSubTab('produtos', 'ativos')">
                    <i class="bi bi-check-circle"></i> Ativos
                </button>
                <button class="sub-tab-btn" onclick="switchSubTab('produtos', 'inativos')">
                    <i class="bi bi-x-circle"></i> Inativos
                </button>
            </div>

            <!-- Sub-tab: Todos -->
            <div id="produtos-subtab-todos" class="sub-tab-content active">
                <div class="card">
                    <div class="card-header"><i class="bi bi-box-fill"></i> Todos os Produtos</div>
                    <div class="card-body">
                        <div class="row g-3 mb-3">
                            <div class="col-md-8">
                                <input type="text" class="form-control" id="buscaProdutosTodos" placeholder="Buscar por nome, marca..." onkeyup="filtrarProdutosTodos()">
                            </div>
                            <div class="col-md-4">
                                <select class="form-select" id="filtroProdutoStatus" onchange="filtrarProdutosTodos()">
                                    <option value="">Todos os status</option>
                                    <option value="Ativo">Ativo</option>
                                    <option value="Inativo">Inativo</option>
                                </select>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Nome</th>
                                        <th>Marca</th>
                                        <th>Preço</th>
                                        <th>Estoque</th>
                                        <th>Status</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="produtosTodosBody">
                                    <tr><td colspan="6" class="text-center"><div class="spinner"></div></td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sub-tab: Ativos -->
            <div id="produtos-subtab-ativos" class="sub-tab-content d-none">
                <div class="card">
                    <div class="card-header"><i class="bi bi-check-circle"></i> Produtos Ativos</div>
                    <div class="card-body">
                        <div class="mb-3">
                            <input type="text" class="form-control" id="buscaProdutosAtivos" placeholder="Buscar produto ativo..." onkeyup="filtrarProdutosAtivos()">
                        </div>
                        <div class="table-responsive">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Nome</th>
                                        <th>Marca</th>
                                        <th>Preço</th>
                                        <th>Estoque</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="produtosAtivosBody">
                                    <tr><td colspan="5" class="text-center"><div class="spinner"></div></td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sub-tab: Inativos -->
            <div id="produtos-subtab-inativos" class="sub-tab-content d-none">
                <div class="card">
                    <div class="card-header"><i class="bi bi-x-circle"></i> Produtos Inativos</div>
                    <div class="card-body">
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle"></i> 
                            Produtos inativos não aparecem no sistema de orçamentos
                        </div>
                        <div class="table-responsive">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Nome</th>
                                        <th>Marca</th>
                                        <th>Preço</th>
                                        <th>Estoque</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="produtosInativosBody">
                                    <tr><td colspan="5" class="text-center text-muted">Nenhum produto inativo</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

<!-- Inicio novas seções -->
<!-- Seção de Perfil -->
<div id="section-perfil" class="content-section">
    <div class="page-header">
        <h1><i class="bi bi-person-circle"></i> Meu Perfil</h1>
        <button class="btn btn-primary" onclick="salvarAlteracoesPerfil()">
            <i class="bi bi-save"></i> Salvar Alterações
        </button>
    </div>
    
    <div class="row g-4">
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <i class="bi bi-camera"></i> Foto de Perfil
                </div>
                <div class="card-body text-center">
                    <!-- Placeholder SVG inline (SEM arquivos externos) -->
                    <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='120' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='50' fill='%23E5E7EB'/%3E%3Ccircle cx='50' cy='40' r='15' fill='%239CA3AF'/%3E%3Cpath d='M 25 75 Q 25 55 50 55 Q 75 55 75 75 Z' fill='%239CA3AF'/%3E%3C/svg%3E" alt="Foto de Perfil" class="profile-pic" style="width: 120px; height: 120px; margin-bottom: 20px; border-radius: 50%;">
                    <input type="file" id="profilePicInput" accept="image/*" style="display: none;">
                    <button class="btn btn-outline" onclick="document.getElementById('profilePicInput').click()">
                        <i class="bi bi-camera"></i> Alterar Foto
                    </button>
                </div>
            </div>

            <div class="card mt-4">
                <div class="card-header">
                    <i class="bi bi-building"></i> Logo da Empresa
                </div>
                <div class="card-body text-center">
                    <div class="logo-preview">
                        <!-- Placeholder SVG inline para logo da empresa (SEM arquivos externos) -->
                        <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='100' viewBox='0 0 200 100'%3E%3Crect width='200' height='100' fill='%23F3F4F6' rx='10'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-family='Arial' font-size='24' font-weight='bold' fill='%237C3AED'%3EBIOMA%3C/text%3E%3Ctext x='50%25' y='70%25' dominant-baseline='middle' text-anchor='middle' font-family='Arial' font-size='12' fill='%239CA3AF'%3EUberaba%3C/text%3E%3C/svg%3E" alt="Logo da Empresa" id="companyLogoPreview" style="max-width: 200px;">
                    </div>
                    <input type="file" id="logoInput" accept="image/*" style="display: none;">
                    <button class="btn btn-outline" onclick="document.getElementById('logoInput').click()">
                        <i class="bi bi-upload"></i> Upload Logo
                    </button>
                </div>
            </div>
        </div>

        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <i class="bi bi-person-vcard"></i> Dados do Perfil
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label>Nome Completo</label>
                            <input type="text" id="perfilNome" class="form-control">
                        </div>
                        <div class="col-md-6">
                            <label>E-mail</label>
                            <input type="email" id="perfilEmail" class="form-control">
                        </div>
                        <div class="col-md-6">
                            <label>Telefone</label>
                            <input type="text" id="perfilTelefone" class="form-control">
                        </div>
                        <div class="col-md-6">
                            <label>Cargo</label>
                            <input type="text" id="perfilCargo" class="form-control">
                        </div>
                    </div>
                </div>
            </div>

            <div class="card mt-4">
                <div class="card-header">
                    <i class="bi bi-shield-lock"></i> Segurança
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label>Nova Senha</label>
                            <input type="password" id="novaSenha" class="form-control">
                        </div>
                        <div class="col-md-6">
                            <label>Confirmar Nova Senha</label>
                            <input type="password" id="confirmarSenha" class="form-control">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Seção de Comissões -->
<div id="section-comissoes" class="content-section">
    <div class="page-header">
        <h1><i class="bi bi-cash-stack"></i> Sistema de Comissões</h1>
        <button class="btn btn-primary" onclick="showModalComissao()">
            <i class="bi bi-plus-circle"></i> Nova Regra
        </button>
    </div>

    <div class="row g-4">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <i class="bi bi-list-check"></i> Regras de Comissão
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>Profissional</th>
                                    <th>Cliente</th>
                                    <th>Orçamento</th>
                                    <th>Valor Comissão</th>
                                    <th>Data</th>
                                </tr>
                            </thead>
                            <tbody id="comissoesBody">
                                <tr><td colspan="5" class="text-center"><div class="spinner"></div></td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <i class="bi bi-graph-up"></i> Desempenho
                </div>
                <div class="card-body">
                    <canvas id="chartComissoes" style="max-height: 300px;"></canvas>
                </div>
            </div>

            <div class="card mt-4">
                <div class="card-header">
                    <i class="bi bi-trophy"></i> Top Performers
                </div>
                <div class="card-body">
                    <div id="topPerformersBody">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card mt-4">
        <div class="card-header">
            <i class="bi bi-calendar3"></i> Histórico de Comissões
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table>
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Profissional</th>
                            <th>Serviço/Produto</th>
                            <th>Valor Venda</th>
                            <th>Comissão</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="historicoComissoesBody">
                        <tr><td colspan="6" class="text-center"><div class="spinner"></div></td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- ==================== SEÇÃO FINANCEIRO ==================== -->
<div id="section-financeiro" class="content-section">
    <div class="page-header">
        <h1><i class="bi bi-wallet2"></i> Gestão Financeira</h1>
        <div style="display: flex; gap: 10px;">
            <button class="btn btn-primary" onclick="carregarDadosFinanceiro()">
                <i class="bi bi-arrow-clockwise"></i> Atualizar
            </button>
            <button class="btn btn-success" onclick="novaDespesa()">
                <i class="bi bi-plus-circle"></i> Nova Despesa
            </button>
        </div>
    </div>

    <!-- Cards de Resumo -->
    <div class="row g-4 mb-4">
        <div class="col-lg-3 col-md-6">
            <div class="stat-card">
                <div class="icon" style="background: linear-gradient(135deg, #10B981, #059669);">
                    <i class="bi bi-arrow-up-circle"></i>
                </div>
                <h3 id="financeiroReceitas">R$ 0,00</h3>
                <p>Receitas</p>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="stat-card">
                <div class="icon" style="background: linear-gradient(135deg, #EF4444, #DC2626);">
                    <i class="bi bi-arrow-down-circle"></i>
                </div>
                <h3 id="financeiroDespesas">R$ 0,00</h3>
                <p>Despesas</p>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="stat-card">
                <div class="icon" style="background: linear-gradient(135deg, #F59E0B, #D97706);">
                    <i class="bi bi-cash-stack"></i>
                </div>
                <h3 id="financeiroComissoes">R$ 0,00</h3>
                <p>Comissões a Pagar</p>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="stat-card">
                <div class="icon" style="background: linear-gradient(135deg, #3B82F6, #2563EB);">
                    <i class="bi bi-graph-up-arrow"></i>
                </div>
                <h3 id="financeiroLucro">R$ 0,00</h3>
                <p>Lucro Líquido</p>
            </div>
        </div>
    </div>

    <!-- Sub-tabs -->
    <div class="sub-tabs">
        <button class="sub-tab-btn active" onclick="switchSubTab('financeiro', 'resumo')">
            <i class="bi bi-pie-chart"></i> Resumo
        </button>
        <button class="sub-tab-btn" onclick="switchSubTab('financeiro', 'receitas')">
            <i class="bi bi-arrow-up-circle"></i> Receitas
        </button>
        <button class="sub-tab-btn" onclick="switchSubTab('financeiro', 'despesas')">
            <i class="bi bi-arrow-down-circle"></i> Despesas
        </button>
        <button class="sub-tab-btn" onclick="switchSubTab('financeiro', 'comissoes')">
            <i class="bi bi-cash-stack"></i> Comissões
        </button>
    </div>

    <!-- Sub-tab: Resumo -->
    <div id="financeiro-subtab-resumo" class="sub-tab-content active">
        <div class="row g-4 mb-4">
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-graph-up"></i> Faturamento Mensal - Últimos 12 Meses
                    </div>
                    <div class="card-body">
                        <canvas id="graficoFaturamentoMensal" style="height: 350px;"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-percent"></i> Margem de Lucro
                    </div>
                    <div class="card-body text-center">
                        <h1 id="margemLucro" style="font-size: 4rem; font-weight: 900; color: var(--primary);">0%</h1>
                        <p class="text-muted">Margem Líquida</p>
                    </div>
                </div>
            </div>
        </div>
        <div class="row g-4">
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-scissors"></i> Serviços Mais Vendidos
                    </div>
                    <div class="card-body">
                        <canvas id="graficoServicosMaisVendidos" style="height: 350px;"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-box"></i> Produtos Mais Vendidos
                    </div>
                    <div class="card-body">
                        <canvas id="graficoProdutosMaisVendidos" style="height: 350px;"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sub-tab: Receitas -->
    <div id="financeiro-subtab-receitas" class="sub-tab-content">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-arrow-up-circle"></i> Receitas (Orçamentos Aprovados)
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Orçamento #</th>
                                <th>Cliente</th>
                                <th>Valor</th>
                                <th>Categoria</th>
                            </tr>
                        </thead>
                        <tbody id="receitasTableBody">
                            <tr><td colspan="5" class="text-center"><div class="spinner"></div></td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Sub-tab: Despesas -->
    <div id="financeiro-subtab-despesas" class="sub-tab-content">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-arrow-down-circle"></i> Despesas
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Descrição</th>
                                <th>Categoria</th>
                                <th>Valor</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="despesasTableBody">
                            <tr><td colspan="5" class="text-center"><div class="spinner"></div></td></tr>
                        </tbody>
                    </table>
                </div>
                <div id="despesasPaginacao"></div>
            </div>
        </div>
    </div>

    <!-- Sub-tab: Comissões -->
    <div id="financeiro-subtab-comissoes" class="sub-tab-content">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-cash-stack"></i> Comissões a Pagar
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>Profissional</th>
                                <th>Orçamento</th>
                                <th>Data</th>
                                <th>Valor Comissão</th>
                                <th>Status</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="comissoesPagarTableBody">
                            <tr><td colspan="6" class="text-center"><div class="spinner"></div></td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Seção de Estoque Expandida -->
<div id="section-estoque" class="content-section">
    <div class="page-header">
        <h1><i class="bi bi-box-seam"></i> Gestão de Estoque</h1>
        <div class="estoque-actions">
            <button class="btn btn-success" onclick="abrirEntradaEstoque()">
                <i class="bi bi-box-arrow-in-down"></i> Nova Entrada
            </button>
            <button class="btn btn-danger" onclick="abrirSaidaEstoque()">
                <i class="bi bi-box-arrow-up"></i> Nova Saída
            </button>
            <button class="btn btn-primary" onclick="loadEstoque()">
                <i class="bi bi-arrow-repeat"></i> Atualizar
            </button>
        </div>
    </div>

    <!-- Sub-tabs para Estoque -->
    <div class="sub-tabs">
        <button class="sub-tab-btn active" onclick="switchSubTab('estoque', 'visaogeral')">
            <i class="bi bi-grid"></i> Visão Geral
        </button>
        <button class="sub-tab-btn" onclick="switchSubTab('estoque', 'produtos')">
            <i class="bi bi-box-seam"></i> Produtos
        </button>
        <button class="sub-tab-btn" onclick="switchSubTab('estoque', 'movimentacoes')">
            <i class="bi bi-arrow-left-right"></i> Movimentações
        </button>
        <button class="sub-tab-btn" onclick="switchSubTab('estoque', 'relatorios')">
            <i class="bi bi-file-earmark-text"></i> Relatórios
        </button>
    </div>

    <!-- Sub-tab: Visão Geral -->
    <div id="estoque-subtab-visaogeral" class="sub-tab-content active">
        <div class="row g-4 mb-4">
            <div class="col-xl-3 col-md-6">
                <div class="stat-card" style="background:linear-gradient(135deg,#3b82f6,#2563eb);">
                    <div class="stat-icon"><i class="bi bi-box-seam"></i></div>
                    <div class="stat-info">
                        <div class="stat-value" id="totalProdutosEstoque">0</div>
                        <div class="stat-label">Total de Produtos</div>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6">
                <div class="stat-card" style="background:linear-gradient(135deg,#10b981,#059669);">
                    <div class="stat-icon"><i class="bi bi-currency-dollar"></i></div>
                    <div class="stat-info">
                        <div class="stat-value" id="valorTotalEstoque">R$ 0</div>
                        <div class="stat-label">Valor em Estoque</div>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6">
                <div class="stat-card" style="background:linear-gradient(135deg,#f59e0b,#d97706);">
                    <div class="stat-icon"><i class="bi bi-archive"></i></div>
                    <div class="stat-info">
                        <div class="stat-value" id="itensAbaixoMinimo">0</div>
                        <div class="stat-label">Abaixo do Mínimo</div>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6">
                <div class="stat-card" style="background:linear-gradient(135deg,#8b5cf6,#7c3aed);">
                    <div class="stat-icon"><i class="bi bi-arrow-repeat"></i></div>
                    <div class="stat-info">
                        <div class="stat-value" id="movimentacoesEstoque">0</div>
                        <div class="stat-label">Movimentações (mês)</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-4">
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-graph-up"></i> Resumo de Movimentações
                    </div>
                    <div class="card-body">
                        <canvas id="chartEstoqueVisaoGeral" style="max-height: 300px;"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-pie-chart"></i> Distribuição
                    </div>
                    <div class="card-body">
                        <canvas id="chartDistribuicaoEstoque" style="max-height: 300px;"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mt-4">
            <div class="card-header">
                <i class="bi bi-clock-history"></i> Últimas Movimentações
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Produto</th>
                                <th>Tipo</th>
                                <th>Quantidade</th>
                                <th>Responsável</th>
                            </tr>
                        </thead>
                        <tbody id="estoqueUltimasMovimentacoesVisaoGeral">
                            <tr><td colspan="5" class="text-center text-muted">Nenhuma movimentação recente</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Sub-tab: Produtos -->
    <div id="estoque-subtab-produtos" class="sub-tab-content">
        <div class="card">
            <div class="card-header"><i class="bi bi-box"></i> Lista de Produtos</div>
            <div class="card-body">
                <div class="mb-3">
                    <input type="text" class="form-control" id="buscaProdutosEstoque" placeholder="Buscar por nome, marca ou SKU..." onkeyup="filtrarProdutosEstoque()">
                </div>
                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>Produto</th>
                                <th>Marca</th>
                                <th>SKU</th>
                                <th>Quantidade</th>
                                <th>Mínimo</th>
                                <th>Preço</th>
                                <th>Valor Total</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="estoqueProdutosBody">
                            <tr><td colspan="8" class="text-center"><div class="spinner"></div></td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Sub-tab: Movimentações -->
    <div id="estoque-subtab-movimentacoes" class="sub-tab-content">
        <div class="card">
            <div class="card-header"><i class="bi bi-arrow-left-right"></i> Histórico de Movimentações</div>
            <div class="card-body">
                <div class="row g-3 mb-4">
                    <div class="col-md-3">
                        <label class="form-label">Tipo</label>
                        <select id="filtroTipoMov" class="form-select" onchange="carregarMovimentacoesEstoque()">
                            <option value="">Todos</option>
                            <option value="entrada">Entrada</option>
                            <option value="saida">Saída</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Data Início</label>
                        <input type="date" id="filtroDataInicioMov" class="form-control">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Data Fim</label>
                        <input type="date" id="filtroDataFimMov" class="form-control">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">&nbsp;</label>
                        <button class="btn btn-primary w-100" onclick="carregarMovimentacoesEstoque()">
                            <i class="bi bi-search"></i> Filtrar
                        </button>
                    </div>
                </div>

                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Tipo</th>
                                <th>Produto</th>
                                <th>Quantidade</th>
                                <th>Motivo</th>
                                <th>Responsável</th>
                            </tr>
                        </thead>
                        <tbody id="estoqueMovimentacoesBody">
                            <tr><td colspan="6" class="text-center"><div class="spinner"></div></td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Sub-tab: Relatórios -->
    <div id="estoque-subtab-relatorios" class="sub-tab-content">
        <div class="card">
            <div class="card-header"><i class="bi bi-file-earmark-text"></i> Relatório Personalizado</div>
            <div class="card-body">
                <div class="row g-3 mb-3">
                    <div class="col-md-4">
                        <label class="form-label">Data Início</label>
                        <input type="date" id="relatorioDataInicio" class="form-control">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Data Fim</label>
                        <input type="date" id="relatorioDataFim" class="form-control">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Tipo de Relatório</label>
                        <select id="relatorioTipo" class="form-select">
                            <option value="movimentacoes">Movimentações</option>
                            <option value="estoque">Posição de Estoque</option>
                            <option value="valorizado">Estoque Valorizado</option>
                            <option value="criticos">Produtos Críticos</option>
                        </select>
                    </div>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-primary" onclick="gerarRelatorioEstoque()">
                        <i class="bi bi-bar-chart"></i> Gerar Relatório
                    </button>
                    <button class="btn btn-success" onclick="exportarRelatorioExcel()">
                        <i class="bi bi-file-earmark-excel"></i> Exportar Excel
                    </button>
                    <button class="btn btn-danger" onclick="exportarRelatorioPDF()">
                        <i class="bi bi-file-earmark-pdf"></i> Exportar PDF
                    </button>
                </div>
                <div id="relatorioEstoqueResultados" style="display:none;" class="mt-4"></div>
            </div>
        </div>

        <!-- Gráficos -->
        <div class="row g-4 mt-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-graph-up"></i> Movimentações por Mês
                    </div>
                    <div class="card-body">
                        <canvas id="chartMovimentacoesEstoque"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-pie-chart"></i> Distribuição de Valor
                    </div>
                    <div class="card-body">
                        <canvas id="chartValorEstoque"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Fim seção estoque -->

        <div id="section-clube" class="content-section">
            <div class="community-hero">
                <h2><i class="bi bi-stars"></i> Comunidade BIOMA</h2>
                <p>Resultados reais, desafios e experiências compartilhadas pelas nossas franquias.</p>
                <div class="community-pill"><i class="bi bi-chat-dots"></i> +250 feedbacks mensais</div>
                <div class="community-pill"><i class="bi bi-heart-fill"></i> 98% satisfação</div>
                <div class="community-pill"><i class="bi bi-award"></i> 32 mentorias concluídas</div>
            </div>
            <div class="community-grid">
                <div class="community-card">
                    <h5><i class="bi bi-people-fill"></i> Plano Conexão VIP</h5>
                    <p>Programa premium para clientes recorrentes com acompanhamento personalizado e experiências exclusivas.</p>
                    <ul class="mb-3">
                        <li>12 sessões anuais planejadas</li>
                        <li>Mentorias com especialistas BIOMA</li>
                        <li>Clube de benefícios com parceiros</li>
                    </ul>
                    <button class="btn btn-outline" type="button" onclick="abrirComunidadeDetalhe('conexao')"><i class="bi bi-eye"></i> Ver detalhes</button>
                </div>
                <div class="community-card">
                    <h5><i class="bi bi-lightbulb"></i> Novos Workshops</h5>
                    <p>Capacitações mensais sobre gestão de salão, neurovendas e cronogramas capilares.</p>
                    <ul class="mb-3">
                        <li>Agenda interativa com confirmação online</li>
                        <li>Materiais exclusivos pós-evento</li>
                        <li>Certificados digitais personalizados</li>
                    </ul>
                    <button class="btn btn-outline" type="button" onclick="abrirComunidadeDetalhe('workshops')"><i class="bi bi-calendar-event"></i> Próximas turmas</button>
                </div>
                <div class="community-card">
                    <h5><i class="bi bi-graph-up"></i> Histórias de Sucesso</h5>
                    <p>Empreendedores BIOMA compartilhando crescimento real com dados de faturamento e engajamento.</p>
                    <div class="mb-3">
                        <strong>+32%</strong> aumento médio de ticket em 90 dias<br>
                        <strong>+18%</strong> crescimento em produtos recomendados<br>
                        <strong>92%</strong> de adesão aos planos fidelidade
                    </div>
                    <button class="btn btn-outline" type="button" onclick="abrirComunidadeDetalhe('cases')"><i class="bi bi-play-circle"></i> Assistir depoimentos</button>
                </div>
                <div class="community-card">
                    <h5><i class="bi bi-chat-quote-fill"></i> Canal de Ideias</h5>
                    <p>Seleção das principais demandas sugeridas pelas franquias e status de implementação.</p>
                    <ul class="mb-3">
                        <li>App mobile para equipe - em desenvolvimento</li>
                        <li>Dashboard de indicadores em tempo real - entregue</li>
                        <li>Integração com BIOMA Pay - em testes</li>
                    </ul>
                    <button class="btn btn-outline" type="button" onclick="abrirComunidadeDetalhe('ideias')"><i class="bi bi-send"></i> Enviar sugestão</button>
                </div>
            </div>
        </div>

        <div id="section-importar" class="content-section">
            <div class="page-header">
                <h1><i class="bi bi-cloud-upload"></i> Importar Dados em Massa</h1>
            </div>
            <div class="alert alert-info">
                <strong><i class="bi bi-info-circle"></i> Informação:</strong> 
                Faça upload de arquivos CSV ou Excel (.xlsx, .xls) para importar dados em massa. 
                Baixe os templates para garantir o formato correto.
            </div>
            <div class="row g-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header"><i class="bi bi-people"></i> Clientes</div>
                        <div class="card-body">
                            <div style="border:3px dashed var(--border-color);border-radius:20px;padding:60px 20px;text-align:center;cursor:pointer;transition: all 0.3s;" onclick="document.getElementById('uploadClientes').click()" onmouseover="this.style.borderColor='var(--primary)'" onmouseout="this.style.borderColor='var(--border-color)'">
                                <i class="bi bi-cloud-upload" style="font-size:4rem;color:var(--primary)"></i>
                                <h4 style="margin-top:15px;">Clique para selecionar arquivo</h4>
                                <p class="text-muted">CSV ou Excel (xlsx, xls)</p>
                                <input type="file" id="uploadClientes" accept=".csv,.xlsx,.xls" style="display:none" onchange="handleUpload(this,'clientes')">
                            </div>
                            <a href="/api/template/download/clientes" class="btn btn-outline w-100 mt-3">
                                <i class="bi bi-download"></i> Baixar Template CSV
                            </a>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header"><i class="bi bi-person-workspace"></i> Profissionais</div>
                        <div class="card-body">
                            <div style="border:3px dashed var(--border-color);border-radius:20px;padding:60px 20px;text-align:center;cursor:pointer;transition: all 0.3s;" onclick="document.getElementById('uploadProfissionais').click()" onmouseover="this.style.borderColor='var(--primary)'" onmouseout="this.style.borderColor='var(--border-color)'">
                                <i class="bi bi-cloud-upload" style="font-size:4rem;color:var(--primary)"></i>
                                <h4 style="margin-top:15px;">Clique para selecionar arquivo</h4>
                                <p class="text-muted">CSV ou Excel (xlsx, xls)</p>
                                <input type="file" id="uploadProfissionais" accept=".csv,.xlsx,.xls" style="display:none" onchange="handleUpload(this,'profissionais')">
                            </div>
                            <a href="/api/template/download/profissionais" class="btn btn-outline w-100 mt-3">
                                <i class="bi bi-download"></i> Baixar Template CSV
                            </a>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header"><i class="bi bi-box-seam"></i> Produtos</div>
                        <div class="card-body">
                            <div style="border:3px dashed var(--border-color);border-radius:20px;padding:60px 20px;text-align:center;cursor:pointer;transition: all 0.3s;" onclick="document.getElementById('uploadProdutos').click()" onmouseover="this.style.borderColor='var(--primary)'" onmouseout="this.style.borderColor='var(--border-color)'">
                                <i class="bi bi-cloud-upload" style="font-size:4rem;color:var(--primary)"></i>
                                <h4 style="margin-top:15px;">Clique para selecionar arquivo</h4>
                                <p class="text-muted">CSV ou Excel (xlsx, xls)</p>
                                <input type="file" id="uploadProdutos" accept=".csv,.xlsx,.xls" style="display:none" onchange="handleUpload(this,'produtos')">
                            </div>
                            <a href="/api/template/download/produtos" class="btn btn-outline w-100 mt-3">
                                <i class="bi bi-download"></i> Baixar Template CSV
                            </a>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header"><i class="bi bi-scissors"></i> Serviços</div>
                        <div class="card-body">
                            <div style="border:3px dashed var(--border-color);border-radius:20px;padding:60px 20px;text-align:center;cursor:pointer;transition: all 0.3s;" onclick="document.getElementById('uploadServicos').click()" onmouseover="this.style.borderColor='var(--primary)'" onmouseout="this.style.borderColor='var(--border-color)'">
                                <i class="bi bi-cloud-upload" style="font-size:4rem;color:var(--primary)"></i>
                                <h4 style="margin-top:15px;">Clique para selecionar arquivo</h4>
                                <p class="text-muted">CSV ou Excel (xlsx, xls)</p>
                                <input type="file" id="uploadServicos" accept=".csv,.xlsx,.xls" style="display:none" onchange="handleUpload(this,'servicos')">
                            </div>
                            <a href="/api/template/download/servicos" class="btn btn-outline w-100 mt-3">
                                <i class="bi bi-download"></i> Baixar Template CSV
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="section-sistema" class="content-section">
            <div class="page-header"><h1><i class="bi bi-activity"></i> Status</h1><button class="btn btn-outline" onclick="verificarStatus()"><i class="bi bi-arrow-clockwise"></i> Atualizar</button></div>
            <div class="row g-4">
                <div class="col-md-4"><div class="card"><div class="card-header"><i class="bi bi-database"></i> MongoDB</div><div class="card-body text-center"><div id="mongoStatus" class="badge warning">Verificando...</div><p class="mt-3" id="mongoMessage">...</p></div></div></div>
                <div class="col-md-4"><div class="card"><div class="card-header"><i class="bi bi-envelope"></i> MailerSend</div><div class="card-body text-center"><div id="emailStatus" class="badge warning">Verificando...</div><p class="mt-3" id="emailMessage">...</p></div></div></div>
                <div class="col-md-4"><div class="card"><div class="card-header"><i class="bi bi-info-circle"></i> Versão</div><div class="card-body text-center"><h3>v4.0</h3><p>BIOMA Uberaba</p></div></div></div>
            </div>
        </div>

        <!-- Seção de Auditoria -->
        <div id="section-auditoria" class="content-section">
            <div class="page-header">
                <h1><i class="bi bi-shield-check"></i> Auditoria do Sistema</h1>
                <button class="btn btn-primary" onclick="loadAuditoria()">
                    <i class="bi bi-arrow-clockwise"></i> Atualizar
                </button>
            </div>

            <!-- Filtros de Auditoria -->
            <div class="card mb-4">
                <div class="card-header"><i class="bi bi-funnel"></i> Filtros</div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label">Usuário</label>
                            <input type="text" id="auditoriaUsername" class="form-control" placeholder="Nome do usuário">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Ação</label>
                            <select id="auditoriaAcao" class="form-select">
                                <option value="">Todas</option>
                                <option value="criar">Criar</option>
                                <option value="editar">Editar</option>
                                <option value="deletar">Deletar</option>
                                <option value="aprovar">Aprovar</option>
                                <option value="rejeitar">Rejeitar</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Entidade</label>
                            <select id="auditoriaEntidade" class="form-select">
                                <option value="">Todas</option>
                                <option value="cliente">Cliente</option>
                                <option value="produto">Produto</option>
                                <option value="orcamento">Orçamento</option>
                                <option value="profissional">Profissional</option>
                                <option value="estoque">Estoque</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Data Início</label>
                            <input type="date" id="auditoriaDataInicio" class="form-control">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Data Fim</label>
                            <input type="date" id="auditoriaDataFim" class="form-control">
                        </div>
                        <div class="col-md-1">
                            <label class="form-label">&nbsp;</label>
                            <button class="btn btn-primary w-100" onclick="loadAuditoria()">
                                <i class="bi bi-search"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Estatísticas de Auditoria -->
            <div class="row g-4 mb-4" id="auditoriaStats" style="display:none;">
                <div class="col-md-4">
                    <div class="stat-card">
                        <div class="icon"><i class="bi bi-activity"></i></div>
                        <h3 id="auditoriaTotalAcoes">0</h3>
                        <p>Total de Ações</p>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="stat-card">
                        <div class="icon"><i class="bi bi-people"></i></div>
                        <h3 id="auditoriaUsuariosAtivos">0</h3>
                        <p>Usuários Ativos</p>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="stat-card">
                        <div class="icon"><i class="bi bi-pie-chart"></i></div>
                        <h3 id="auditoriaPrincipalAcao">-</h3>
                        <p>Ação Mais Comum</p>
                    </div>
                </div>
            </div>

            <!-- Tabela de Auditoria -->
            <div class="card">
                <div class="card-header"><i class="bi bi-list-ul"></i> Registro de Ações</div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>Data/Hora</th>
                                    <th>Usuário</th>
                                    <th>Ação</th>
                                    <th>Entidade</th>
                                    <th>ID</th>
                                    <th>IP</th>
                                    <th>Detalhes</th>
                                </tr>
                            </thead>
                            <tbody id="auditoriaTableBody">
                                <tr><td colspan="7" class="text-center"><div class="spinner"></div></td></tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Paginação Auditoria -->
                    <div id="paginacaoAuditoria" class="d-flex justify-content-center align-items-center gap-3 mt-4" style="display:none !important;">
                        <button class="btn btn-sm btn-outline" onclick="mudarPaginaAuditoria(-1)">
                            <i class="bi bi-chevron-left"></i> Anterior
                        </button>
                        <span id="infoPaginaAuditoria" class="text-muted fw-bold">Página 1 de 1</span>
                        <button class="btn btn-sm btn-outline" onclick="mudarPaginaAuditoria(1)">
                            Próxima <i class="bi bi-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="section-configuracoes" class="content-section">
            <div class="page-header"><h1><i class="bi bi-gear"></i> Configurações</h1></div>
            <div class="card"><div class="card-header"><i class="bi bi-building"></i> Dados da Franquia BIOMA</div><div class="card-body"><div class="row g-3 mb-3"><div class="col-md-6"><label style="display:block;font-weight:700;margin-bottom:10px">Nome da Empresa *</label><input type="text" id="cfgNome" value="BIOMA UBERABA" class="form-control"></div><div class="col-md-6"><label style="display:block;font-weight:700;margin-bottom:10px">CNPJ *</label><input type="text" id="cfgCNPJ" value="49.470.937/0001-10" class="form-control"></div></div><div class="mb-3"><label style="display:block;font-weight:700;margin-bottom:10px">Endereço Completo *</label><input type="text" id="cfgEndereco" value="Av. Santos Dumont 3110 - Santa Maria - Uberaba/MG - CEP 38050-400" class="form-control"></div><div class="row g-3 mb-3"><div class="col-md-6"><label style="display:block;font-weight:700;margin-bottom:10px">Telefone *</label><input type="text" id="cfgTelefone" value="(34) 99235-5890" class="form-control"></div><div class="col-md-6"><label style="display:block;font-weight:700;margin-bottom:10px">E-mail *</label><input type="email" id="cfgEmail" value="biomauberaba@gmail.com" class="form-control"></div></div><button class="btn btn-primary" onclick="salvarConfig()"><i class="bi bi-save"></i> Salvar Dados da Franquia</button></div></div>
            <div class="card mt-4"><div class="card-header"><i class="bi bi-image"></i> Personalização Visual</div><div class="card-body"><div class="row g-4"><div class="col-md-6"><div class="logo-preview-card"><div class="logo-preview" id="logoPrincipalPreview"><span class="text-muted">Logo do sistema</span></div><button class="btn btn-outline" type="button" onclick="abrirUploadLogo('principal')"><i class="bi bi-upload"></i> Enviar logo principal</button><button class="btn btn-sm btn-link text-danger mt-2" type="button" onclick="removerLogo('principal')">Remover</button></div></div><div class="col-md-6"><div class="logo-preview-card"><div class="logo-preview" id="logoLoginPreview"><span class="text-muted">Logo da tela de login</span></div><button class="btn btn-outline" type="button" onclick="abrirUploadLogo('login')"><i class="bi bi-upload"></i> Enviar logo de login</button><button class="btn btn-sm btn-link text-danger mt-2" type="button" onclick="removerLogo('login')">Remover</button></div></div></div></div></div>
            <div class="card mt-4"><div class="card-header"><i class="bi bi-sliders"></i> Configurações Operacionais</div><div class="card-body"><div class="row g-3 mb-3"><div class="col-md-4"><label style="display:block;font-weight:700;margin-bottom:10px">Horário Abertura</label><input type="time" id="cfgHorarioAbertura" value="08:00" class="form-control"></div><div class="col-md-4"><label style="display:block;font-weight:700;margin-bottom:10px">Horário Fechamento</label><input type="time" id="cfgHorarioFechamento" value="19:00" class="form-control"></div><div class="col-md-4"><label style="display:block;font-weight:700;margin-bottom:10px">Duração Padrão (min)</label><input type="number" id="cfgDuracaoPadrao" value="60" class="form-control"></div></div><div class="row g-3 mb-3"><div class="col-md-6"><label style="display:block;font-weight:700;margin-bottom:10px">Cashback Padrão (%)</label><input type="number" id="cfgCashbackPadrao" value="5" min="0" max="100" class="form-control"></div><div class="col-md-6"><label style="display:block;font-weight:700;margin-bottom:10px">Comissão Padrão (%)</label><input type="number" id="cfgComissaoPadrao" value="10" min="0" max="100" class="form-control"></div></div><button class="btn btn-success" onclick="salvarConfigOp()"><i class="bi bi-check-circle"></i> Salvar Configurações Operacionais</button></div></div>
            <div class="card mt-4"><div class="card-header"><i class="bi bi-envelope"></i> Configurações de E-mail</div><div class="card-body"><p class="text-muted mb-3">Configure as credenciais SMTP para envio de e-mails automáticos (orçamentos, notificações, etc.)</p><div class="alert alert-info"><i class="bi bi-info-circle"></i> <strong>Importante:</strong> As configurações de SMTP devem ser definidas no arquivo <code>.env</code> do servidor:<br><code>EMAIL_HOST</code>, <code>EMAIL_PORT</code>, <code>EMAIL_USER</code>, <code>EMAIL_PASSWORD</code>, <code>EMAIL_FROM</code></div><div class="mb-3"><label style="display:block;font-weight:700;margin-bottom:10px">Testar Configuração de E-mail</label><div class="input-group"><input type="email" id="emailTesteDestino" placeholder="Digite um e-mail para teste" class="form-control"><button class="btn btn-primary" onclick="testarEmailConfig()"><i class="bi bi-send"></i> Enviar E-mail de Teste</button></div><small class="text-muted">Um e-mail de teste será enviado para verificar se as configurações estão corretas.</small></div></div></div>
            <div class="card mt-4"><div class="card-header"><i class="bi bi-shield-check"></i> Licença e Desenvolvedor</div><div class="card-body"><table style="width:100%"><tr style="border-bottom:1px solid var(--border-color)"><td style="padding:15px;font-weight:700">Plano Contratado:</td><td style="padding:15px"><span class="badge success">PROFISSIONAL PREMIUM</span></td></tr><tr style="border-bottom:1px solid var(--border-color)"><td style="padding:15px;font-weight:700">Franquia:</td><td style="padding:15px">BIOMA Uberaba - Oficial</td></tr><tr style="border-bottom:1px solid var(--border-color)"><td style="padding:15px;font-weight:700">Desenvolvedor:</td><td style="padding:15px">@juanmarco1999 (Juan Marco Bernardos Souza e Silva)</td></tr><tr style="border-bottom:1px solid var(--border-color)"><td style="padding:15px;font-weight:700">Email Suporte:</td><td style="padding:15px">180147064@aluno.unb.br</td></tr><tr style="border-bottom:1px solid var(--border-color)"><td style="padding:15px;font-weight:700">Versão:</td><td style="padding:15px">v4.0 (Build 2025.10.05)</td></tr><tr><td style="padding:15px;font-weight:700">Última Atualização:</td><td style="padding:15px">05 de Outubro de 2025 às 22:34 UTC</td></tr></table></div></div>
        </div>

    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>

let currentUser=null,currentTheme='light',orcamento={servicos:[],produtos:[]},servicosDisponiveis=[],produtosDisponiveis=[],servicoSelecionado=null,produtoSelecionado=null;
let produtosCache=[],buscaGlobalTimer=null,configuracoesAtuais=null,logosPersonalizados={principal:null,login:null};

// FLAGS ANTI-LOOP: Prevenir carregamento infinito
let loadingFlags = {};
let appInitialized = false;
let sseInstance = null;
let sseReconnectAttempts = 0;
const MAX_SSE_RECONNECT = 3;

function setLoading(key, value) {
    loadingFlags[key] = value;
    if (value) {
        setTimeout(() => { loadingFlags[key] = false; }, 10000); // Auto-reset após 10s
    }
}

function isLoading(key) {
    return loadingFlags[key] === true;
}

// ========== FUNÇÃO GLOBAL: SWITCH SUB-TAB ==========
function switchSubTab(section, subtab) {
    console.log(`🔄 Mudando sub-tab: ${section} → ${subtab}`);

    // 1. DESATIVAR todos os conteúdos desta seção (CSS controla display via .active)
    document.querySelectorAll(`[id^="${section}-subtab-"]`).forEach(content => {
        content.classList.remove('active');
    });

    // 2. DESATIVAR todos os botões
    const sectionElement = document.getElementById(`section-${section}`);
    if (sectionElement) {
        sectionElement.querySelectorAll('.sub-tab-btn').forEach(btn => {
            btn.classList.remove('active');
        });
    }

    // 3. ATIVAR apenas o selecionado
    const targetId = `${section}-subtab-${subtab}`;
    const targetContent = document.getElementById(targetId);

    if (!targetContent) {
        console.error(`❌ Sub-tab não encontrada: ${targetId}`);
        return;
    }

    targetContent.classList.add('active');

    // 4. ATIVAR botão clicado
    if (event?.target) {
        event.target.classList.add('active');
    }

    // 5. Carregar dados específicos da sub-tab
    if (typeof carregarDadosSubTab === 'function') {
        carregarDadosSubTab(section, subtab);
    }

    console.log(`✅ Sub-tab ativa: ${targetId}`);
}

/**
 * Auto-login: Verifica se há credenciais salvas no localStorage
 */
async function checkAutoLogin(){
    const rememberData = localStorage.getItem('bioma_remember');

    if(!rememberData){
        return false; // Nenhum dado salvo
    }

    try{
        const data = JSON.parse(rememberData);
        const expiryDate = new Date(data.expiry);
        const now = new Date();

        // Verificar se expirou
        if(now > expiryDate){
            console.log('⏰ Login salvo expirou (> 7 dias)');
            localStorage.removeItem('bioma_remember');
            return false;
        }

        // Auto-preencher campos
        console.log('🔑 Login salvo encontrado, preenchendo campos...');
        $('#loginUsername').value = data.username;
        $('#loginPassword').value = atob(data.password); // Decode Base64
        $('#rememberMe').checked = true;

        // Auto-login silencioso após 500ms
        setTimeout(async () => {
            console.log('🚀 Executando auto-login...');

            try {
                // Fazer login direto sem modal intermediário
                const username = data.username;
                const password = atob(data.password);

                console.log('📡 Enviando requisição de login...');
                const response = await API.post('/api/login', { username, password });
                console.log('📥 Resposta recebida:', response.success ? 'SUCCESS' : 'FAILED');

                if(response.success){
                    // Salvar sessão
                    sessionStorage.setItem('bioma_user', JSON.stringify(response.user));
                    console.log('💾 Sessão salva no sessionStorage');

                    // AUTO-LOGIN SILENCIOSO: Iniciar app diretamente sem modal
                    console.log('🎯 Iniciando app diretamente (sem modal)...');
                    await initApp(response.user);
                    console.log('✅ App inicializado com sucesso!');
                } else {
                    // Falha no auto-login: limpar dados salvos
                    console.warn('⚠️ Auto-login falhou:', response.message);
                    localStorage.removeItem('bioma_remember');
                }
            } catch(error) {
                console.error('❌ Erro no auto-login:', error);
                localStorage.removeItem('bioma_remember');
            }
        }, 500);

        return true;
    }catch(err){
        console.error('Erro ao verificar auto-login:', err);
        localStorage.removeItem('bioma_remember');
        return false;
    }
}

document.addEventListener('DOMContentLoaded', async () => {
    console.log('%c🌳 BIOMA v4.0 DEFINITIVO','background:#7C3AED;color:#fff;font-size:24px;padding:15px;border-radius:8px;font-weight:900');
    console.log('%c✅ Sistema 100% Completo Carregado','color:#10B981;font-size:16px;font-weight:700');

    // Verificar auto-login primeiro
    const autoLoginAttempted = await checkAutoLogin();

    // Se não tiver auto-login, verificar auth normal
    if(!autoLoginAttempted){
        checkAuth();
    }
});

async function checkAuth(){
    try{
        const res=await fetch('/api/current-user',{credentials:'include'});
        const data=await res.json();
        if(data.success&&data.user){
            currentUser=data.user;
            currentTheme=data.user.theme||'light';
            applyTheme(currentTheme);
            showApp();
        }else{
            showAuth();
        }
    }catch(e){
        console.error('❌ Auth error:',e);
        showAuth();
    }
}

function showAuth(){
    // SOLUÇÃO DO PDF: Limpar o tema do localStorage na tela de login
    localStorage.removeItem('theme');
    document.documentElement.setAttribute('data-theme', 'light');
    console.log('🌞 Tela de login: light mode forçado (localStorage limpo)');

    document.getElementById('authScreen').style.display='flex';
    document.getElementById('app').style.display='none';
}

function showApp(){
    document.getElementById('authScreen').style.display='none';
    document.getElementById('app').style.display='block';
    loadConfiguracoes();
    // setTimeout(()=>{loadDashboard();},100); // Removido: duplicado com initApp()
}

function switchTab(tab){
    if(tab==='login'){
        document.getElementById('loginTab').classList.add('active');
        document.getElementById('registerTab').classList.remove('active');
        document.getElementById('loginForm').style.display='block';
        document.getElementById('registerForm').style.display='none';
    }else{
        document.getElementById('registerTab').classList.add('active');
        document.getElementById('loginTab').classList.remove('active');
        document.getElementById('registerForm').style.display='block';
        document.getElementById('loginForm').style.display='none';
    }
}

// ===== FUNÇÕES ANTIGAS REMOVIDAS =====
// handleLogin(), handleRegister() e doLogout() foram movidas para o final do arquivo
// com implementações melhoradas (linhas 7882+)
// Remoção feita para evitar duplicação e vazamento de mensagens SweetAlert

function applyTheme(theme){
    document.documentElement.setAttribute('data-theme',theme);
    currentTheme=theme;
    if(theme==='dark'){
        document.getElementById('themeIcon').className='bi bi-sun-fill';
        document.getElementById('themeText').textContent='Modo Claro';
    }else{
        document.getElementById('themeIcon').className='bi bi-moon-stars-fill';
        document.getElementById('themeText').textContent='Modo Escuro';
    }
}

async function toggleTheme(){
    const newTheme=currentTheme==='light'?'dark':'light';
    applyTheme(newTheme);
    try{
        await fetch('/api/update-theme',{method:'POST',headers:{'Content-Type':'application/json'},credentials:'include',body:JSON.stringify({theme:newTheme})});
    }catch(e){
        console.error('❌ Theme error:',e);
    }
}

function goTo(section){
    const key = `goto-${section}`;

    // PROTEÇÃO ANTI-LOOP: Não navegar se já estiver navegando
    if (isLoading(key)) {
        console.warn(`⚠️ Navegação em andamento: ${section}`);
        return;
    }

    console.log('🔄 Navegando para:',section);
    setLoading(key, true);

    try{
        // 1. ESCONDER TODAS as seções de forma mais robusta
        document.querySelectorAll('.content-section').forEach(s => {
            s.classList.remove('active');
            s.classList.add('d-none');
            s.style.display = 'none';
            s.style.visibility = 'hidden';
            s.style.position = 'absolute';
            s.style.left = '-9999px';
            s.style.zIndex = '-1';
        });

        // 2. MOSTRAR apenas a selecionada
        const sectionElement=document.getElementById('section-'+section);
        if(sectionElement){
            sectionElement.classList.add('active');
            sectionElement.classList.remove('d-none');
            sectionElement.style.display = 'block';
            sectionElement.style.visibility = 'visible';
            sectionElement.style.position = 'relative';
            sectionElement.style.left = '0';
            sectionElement.style.zIndex = '1';
        } else {
            console.error('❌ Seção não encontrada:', section);
        }

        // 3. ATUALIZAR menu sidebar
        document.querySelectorAll('.sidebar-menu a').forEach(a=>a.classList.remove('active'));
        const menu=document.getElementById('menu-'+section);
        if(menu)menu.classList.add('active');

        // 4. SCROLL para topo
        const mainContent=document.querySelector('.main-content');
        if(mainContent)mainContent.scrollTo({top:0,behavior:'smooth'});

        // 5. CARREGAR dados da seção (com proteção individual) - REMOVIDO DUPLICAÇÃO
        if(section==='dashboard')loadDashboard();
        else if(section==='clientes')loadClientes();
        else if(section==='profissionais')loadProfissionais();
        else if(section==='servicos')loadServicosLista();
        else if(section==='produtos')loadProdutosLista();
        else if(section==='consultar')loadConsultar();
        else if(section==='contratos')loadContratos();
        else if(section==='fila')loadFila();
        else if(section==='sistema')verificarStatus();
        else if(section==='estoque')loadEstoque();
        else if(section==='configuracoes')loadConfiguracoes();
        else if(section==='agendamentos')loadAgendamentos();
        else if(section==='auditoria')loadAuditoria();
        else if(section==='clube')loadClube();
        else if(section==='comissoes')loadComissoes();
        else if(section==='relatorios')loadRelatorios();
    }catch(e){
        console.error('❌ Erro navegação:',e);
    } finally {
        // Resetar flag após 1 segundo
        setTimeout(() => setLoading(key, false), 1000);
    }

}

// Função para alternar sub-tabs
function showSubTab(section, tab) {
    // Remove active de todos os botões de sub-tab da seção
    document.querySelectorAll(`#section-${section} .sub-tab-btn`).forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Remove active de todos os conteúdos de sub-tab da seção
    document.querySelectorAll(`#section-${section} .sub-tab-content`).forEach(content => {
        content.classList.remove('active');
    });
    
    // Adiciona active no botão clicado
    event.target.classList.add('active');
    
    // Adiciona active no conteúdo correspondente
    const content = document.getElementById(`${section}-${tab}`);
    if (content) {
        content.classList.add('active');
        
        // Carrega dados específicos da sub-tab se necessário
        if (section === 'profissionais' && tab === 'comissoes') {
            carregarHistoricoComissoes();
        } else if (section === 'profissionais' && tab === 'assistentes') {
            loadAssistentes();
        }
    }
}

// ========== FUNÇÃO: CARREGAR HISTÓRICO DE COMISSÕES ==========
async function carregarHistoricoComissoes() {
    console.log('💰 Carregando histórico de comissões...');

    try {
        // Verificar se elementos existem
        const tbodyProfissionais = document.getElementById('profissionais-comissoes');
        const tbodyFinanceiro = document.getElementById('comissoesPagarTableBody');

        if (!tbodyProfissionais && !tbodyFinanceiro) {
            console.warn('⚠️ Nenhum elemento tbody de comissões encontrado');
            return;
        }

        // Mostrar loading spinner nos elementos ativos
        if (tbodyFinanceiro && tbodyFinanceiro.offsetParent !== null) {
            tbodyFinanceiro.innerHTML = '<tr><td colspan="6" class="text-center"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Carregando...</span></div></td></tr>';
        }

        const res = await fetch('/api/financeiro/comissoes', {credentials: 'include'});

        if (!res.ok) {
            console.error(`❌ Erro HTTP ao buscar comissões: ${res.status}`);
            throw new Error(`Erro ${res.status}: Falha ao carregar comissões`);
        }

        const data = await res.json();
        console.log('📦 Dados de comissões recebidos:', { success: data.success, total: data.comissoes?.length });

        if (data.success && data.comissoes && data.comissoes.length > 0) {
            // HTML para tabela de Profissionais (5 colunas)
            if (tbodyProfissionais) {
                const htmlProfissionais = data.comissoes.map(c => {
                    try {
                        const data = c.data || c.data_registro || c.created_at;
                        const dataFormatada = data ? new Date(data).toLocaleDateString('pt-BR') : 'Data não disponível';
                        const valor = parseFloat(c.valor || c.comissao_valor || c.valor_comissao || 0);
                        const status = c.status || c.status_pagamento || 'Pendente';

                        return `
                            <tr>
                                <td><strong>${dataFormatada}</strong></td>
                                <td>${c.profissional_nome || c.profissional || 'Profissional não identificado'}</td>
                                <td>${c.servico_nome || c.servico || 'N/A'}</td>
                                <td><strong>R$ ${valor.toFixed(2).replace('.', ',')}</strong></td>
                                <td><span class="badge ${status === 'Pago' || status === 'pago' ? 'success' : 'warning'}">${status}</span></td>
                            </tr>
                        `;
                    } catch (err) {
                        console.error('⚠️ Erro ao renderizar comissão:', c, err);
                        return '';
                    }
                }).filter(html => html !== '').join('');

                tbodyProfissionais.innerHTML = htmlProfissionais || '<tr data-keep-visible="true"><td colspan="5" class="text-center text-muted">Erro ao processar comissões</td></tr>';
            }

            // HTML para tabela de Financeiro (6 colunas - inclui Orçamento e Ações)
            if (tbodyFinanceiro) {
                const htmlFinanceiro = data.comissoes.map(c => {
                    try {
                        const data = c.data || c.data_registro || c.created_at;
                        const dataFormatada = data ? new Date(data).toLocaleDateString('pt-BR') : 'Data não disponível';
                        const valor = parseFloat(c.valor || c.comissao_valor || c.valor_comissao || 0);
                        const status = c.status || c.status_pagamento || 'Pendente';
                        const comissaoId = c._id || c.id || '';
                        const orcamentoNumero = c.orcamento_numero || c.orcamento_id || 'N/A';
                        const orcamentoDisplay = typeof orcamentoNumero === 'string' && orcamentoNumero.length > 6
                            ? orcamentoNumero.slice(-6)
                            : orcamentoNumero;

                        const isPago = status === 'Pago' || status === 'pago';

                        return `
                            <tr>
                                <td>${c.profissional_nome || c.profissional || 'Profissional não identificado'}</td>
                                <td>#${orcamentoDisplay}</td>
                                <td><strong>${dataFormatada}</strong></td>
                                <td><strong style="color: var(--warning);">R$ ${valor.toFixed(2).replace('.', ',')}</strong></td>
                                <td><span class="badge ${isPago ? 'success' : 'warning'}">${status}</span></td>
                                <td>
                                    <button class="btn btn-sm ${isPago ? 'btn-outline-secondary' : 'btn-success'}"
                                            onclick="marcarComissaoPaga('${comissaoId}')"
                                            ${isPago ? 'disabled' : ''}
                                            title="${isPago ? 'Comissão já paga' : 'Marcar como paga'}">
                                        <i class="bi ${isPago ? 'bi-check-circle-fill' : 'bi-check-circle'}"></i> ${isPago ? 'Pago' : 'Pagar'}
                                    </button>
                                </td>
                            </tr>
                        `;
                    } catch (err) {
                        console.error('⚠️ Erro ao renderizar comissão para financeiro:', c, err);
                        return '';
                    }
                }).filter(html => html !== '').join('');

                tbodyFinanceiro.innerHTML = htmlFinanceiro || '<tr><td colspan="6" class="text-center text-warning">Erro ao processar comissões</td></tr>';
            }

            console.log(`✅ ${data.comissoes.length} comissões carregadas e renderizadas`);
        } else {
            // Sem dados - exibir mensagem amigável
            console.warn('⚠️ Nenhuma comissão disponível');

            if (tbodyProfissionais) {
                tbodyProfissionais.innerHTML = '<tr data-keep-visible="true"><td colspan="5" class="text-center text-muted"><i class="bi bi-inbox"></i> Nenhuma comissão registrada</td></tr>';
            }
            if (tbodyFinanceiro) {
                tbodyFinanceiro.innerHTML = '<tr><td colspan="6" class="text-center text-muted"><i class="bi bi-inbox"></i> Nenhuma comissão a pagar no momento</td></tr>';
            }
        }
    } catch (e) {
        console.error('❌ Erro ao carregar comissões:', e);
        const tbodyProfissionais = document.getElementById('profissionais-comissoes');
        const tbodyFinanceiro = document.getElementById('comissoesPagarTableBody');

        if (tbodyProfissionais) {
            tbodyProfissionais.innerHTML = '<tr><td colspan="5" class="text-center text-danger"><i class="bi bi-exclamation-triangle"></i> Erro ao carregar comissões</td></tr>';
        }
        if (tbodyFinanceiro) {
            tbodyFinanceiro.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center text-danger">
                        <i class="bi bi-exclamation-triangle"></i>
                        <strong>Erro ao carregar comissões</strong><br>
                        <small>${e.message || 'Verifique sua conexão'}</small>
                    </td>
                </tr>
            `;
        }
    }
}

// ========== FUNÇÃO: MARCAR COMISSÃO COMO PAGA ==========
async function marcarComissaoPaga(comissaoId) {
    if (!comissaoId) {
        console.error('❌ ID de comissão inválido');
        Swal.fire('Erro', 'ID de comissão inválido', 'error');
        return;
    }

    try {
        const result = await Swal.fire({
            title: 'Confirmar Pagamento',
            text: 'Deseja marcar esta comissão como paga?',
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: '<i class="bi bi-check-circle"></i> Sim, Pagar',
            cancelButtonText: 'Cancelar',
            confirmButtonColor: 'var(--success)',
            cancelButtonColor: 'var(--danger)'
        });

        if (!result.isConfirmed) return;

        console.log(`💰 Marcando comissão ${comissaoId} como paga...`);

        const res = await fetch(`/api/financeiro/comissoes/${comissaoId}/pagar`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ status: 'Pago', data_pagamento: new Date().toISOString() })
        });

        if (!res.ok) {
            const errorText = await res.text();
            console.error(`❌ Erro HTTP ao marcar comissão: ${res.status}`, errorText);
            throw new Error(`Erro ${res.status}: ${errorText || 'Falha ao marcar comissão como paga'}`);
        }

        const data = await res.json();

        if (data.success) {
            console.log('✅ Comissão marcada como paga');
            await Swal.fire({
                icon: 'success',
                title: 'Comissão Paga!',
                text: 'A comissão foi marcada como paga com sucesso',
                timer: 2000,
                showConfirmButton: false
            });

            // Recarregar lista de comissões
            await carregarHistoricoComissoes();
        } else {
            throw new Error(data.message || 'Falha ao marcar comissão');
        }
    } catch (error) {
        console.error('❌ Erro ao marcar comissão como paga:', error);
        Swal.fire({
            icon: 'error',
            title: 'Erro ao Pagar Comissão',
            html: `<p>${error.message || 'Não foi possível marcar a comissão como paga'}</p>
                   <small class="text-muted">Verifique o console para mais detalhes</small>`,
            confirmButtonText: 'OK'
        });
    }

    // Limpeza de backdrop residual
    setTimeout(() => {
        document.querySelectorAll('.swal2-container, .swal2-backdrop-show').forEach(el => {
            if (!Swal.isVisible()) el.remove();
        });
        document.body.classList.remove('swal2-shown', 'swal2-height-auto');
    }, 100);
}

// ========== FUNÇÃO: CARREGAR ASSISTENTES ==========
async function loadAssistentes() {
    console.log('📋 Carregando assistentes...');
    // Implementação futura se necessário
}

function filtrarTabelaPorTermo(tbodySelector, termo){
    const normalized = (termo || '').toLowerCase();
    document.querySelectorAll(`${tbodySelector} tr`).forEach(row => {
        if(row.dataset.keepVisible === 'true'){
            row.style.display = '';
            return;
        }
        const texto = row.textContent.toLowerCase();
        row.style.display = texto.includes(normalized) ? '' : 'none';
    });
}

function filtrarProfissionais(){
    const termo = document.getElementById('buscaProfissionais')?.value || '';
    filtrarTabelaPorTermo('#profissionaisBody', termo.trim());
}

function filtrarServicosLista(){
    const termo = document.getElementById('buscaServicos')?.value || '';
    filtrarTabelaPorTermo('#servicosListBody', termo.trim());
}

function filtrarProdutosLista(){
    const termo = document.getElementById('buscaProdutos')?.value || '';
    filtrarTabelaPorTermo('#produtosListBody', termo.trim());
}

function limparResultadosBuscaGlobal(){
    const container = document.getElementById('globalSearchResults');
    if(container){
        container.classList.remove('active');
        container.innerHTML = '';
    }
}

function buscarGlobal(termo){
    termo = (termo || '').trim();
    if(buscaGlobalTimer){
        clearTimeout(buscaGlobalTimer);
    }
    if(termo.length < 2){
        limparResultadosBuscaGlobal();
        return;
    }
    buscaGlobalTimer = setTimeout(()=>executarBuscaGlobal(), 280);
}

async function executarBuscaGlobal(){
    const input = document.getElementById('globalSearchInput');
    if(!input){
        return;
    }
    const termo = input.value.trim();
    if(buscaGlobalTimer){
        clearTimeout(buscaGlobalTimer);
        buscaGlobalTimer = null;
    }
    if(termo.length < 2){
        limparResultadosBuscaGlobal();
        return;
    }
    try{
        const response = await fetch(`/api/busca/global?termo=${encodeURIComponent(termo)}`, {credentials:'include'});
        const data = await response.json();
        if(data.success){
            renderResultadosBuscaGlobal(data.resultados || {});
        }
    }catch(error){
        console.error('Erro na busca global', error);
    }
}

function renderResultadosBuscaGlobal(resultados){
    const container = document.getElementById('globalSearchResults');
    if(!container){
        return;
    }
    const categorias = [
        {chave:'clientes', titulo:'Clientes'},
        {chave:'profissionais', titulo:'Profissionais'},
        {chave:'servicos', titulo:'Serviços'},
        {chave:'produtos', titulo:'Produtos'},
        {chave:'orcamentos', titulo:'Contratos e Orçamentos'}
    ];
    let html = '';
    let total = 0;
    categorias.forEach(categoria => {
        const itens = resultados[categoria.chave] || [];
        if(itens.length){
            total += itens.length;
            const itensHtml = itens.map(item => `
                <div class="global-search-item" onclick="navegarResultadoGlobal('${categoria.chave}','${item.id}')">
                    <strong>${item.nome}</strong>
                    <span>${item.detalhe || ''}</span>
                </div>`).join('');
            html += `<div class="global-search-section"><h6>${categoria.titulo}</h6>${itensHtml}</div>`;
        }
    });
    if(total === 0){
        html = '<div class="text-muted" style="padding:12px;">Nenhum resultado encontrado</div>';
    }
    container.innerHTML = html;
    container.classList.add('active');
}

function navegarResultadoGlobal(tipo, id){
    limparResultadosBuscaGlobal();
    if(tipo === 'clientes'){
        goTo('clientes');
        setTimeout(()=>visualizarCliente(id), 250);
    }else if(tipo === 'profissionais'){
        goTo('profissionais');
        setTimeout(()=>destacarLinhaTabela('#profissionaisBody','id',id), 300);
    }else if(tipo === 'servicos'){
        goTo('servicos');
        setTimeout(()=>destacarLinhaTabela('#servicosListBody','id',id), 300);
    }else if(tipo === 'produtos'){
        goTo('produtos');
        setTimeout(()=>destacarLinhaTabela('#produtosListBody','id',id), 300);
    }else if(tipo === 'orcamentos'){
        goTo('consultar');
        setTimeout(()=>visualizarOrcamento(id), 350);
    }
}

function destacarLinhaTabela(tbodySelector, atributo, valor){
    const rows = document.querySelectorAll(`${tbodySelector} tr`);
    rows.forEach(row => {
        if(row.dataset[atributo] === valor){
            row.classList.add('highlight-row');
            row.scrollIntoView({behavior:'smooth', block:'center'});
            setTimeout(()=>row.classList.remove('highlight-row'), 2000);
        }
    });
}

async function loadEstoque(){
    const key = 'loadEstoque';

    // PROTEÇÃO ANTI-LOOP
    if (isLoading(key)) {
        console.warn(`⚠️ Já carregando: ${key}`);
        return;
    }

    setLoading(key, true);

    try {
        await Promise.all([
            loadEstoqueResumo(),
            loadEstoquePendentes(),
            loadEstoqueMovimentos()
        ]);
    } finally {
        setTimeout(() => setLoading(key, false), 1000);
    }
}

async function loadEstoqueResumo(){
    const key = 'loadEstoqueResumo';
    if (isLoading(key)) {
        console.warn(`⚠️ Já carregando: ${key}`);
        return;
    }
    setLoading(key, true);

    try{
        // Buscar produtos
        const prodRes = await fetch('/api/produtos', {credentials: 'include'});
        const prodData = await prodRes.json();

        // Buscar movimentações do mês
        const hoje = new Date();
        const inicioMes = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
        const movRes = await fetch(`/api/estoque/movimentacoes?data_inicio=${inicioMes.toISOString()}&per_page=10000`, {credentials: 'include'});
        const movData = await movRes.json();

        if (prodData.success && prodData.produtos) {
            const produtos = prodData.produtos;

            // Total de produtos
            document.getElementById('totalProdutosEstoque').textContent = produtos.length;

            // Valor total em estoque
            const valorTotal = produtos.reduce((sum, p) => {
                return sum + ((p.preco || 0) * (p.estoque || 0));
            }, 0);
            document.getElementById('valorTotalEstoque').textContent = `R$ ${valorTotal.toFixed(2)}`;

            // Produtos abaixo do mínimo
            const abaixoMinimo = produtos.filter(p => {
                const estoque = p.estoque || 0;
                const minimo = p.estoque_minimo || 0;
                return estoque < minimo && minimo > 0;
            }).length;
            document.getElementById('itensAbaixoMinimo').textContent = abaixoMinimo;
        }

        // Movimentações do mês
        if (movData.success && movData.movimentacoes) {
            document.getElementById('movimentacoesEstoque').textContent = movData.movimentacoes.length;

            // Criar gráfico de movimentações
            const entradas = movData.movimentacoes.filter(m => m.tipo === 'entrada').length;
            const saidas = movData.movimentacoes.filter(m => m.tipo === 'saida' || m.tipo === 'saída').length;

            const ctx = document.getElementById('chartEstoqueVisaoGeral');
            if (ctx && window.Chart) {
                if (window.chartEstoqueVisaoGeralInstance) {
                    window.chartEstoqueVisaoGeralInstance.destroy();
                }

                window.chartEstoqueVisaoGeralInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['Entradas', 'Saídas'],
                        datasets: [{
                            label: 'Movimentações',
                            data: [entradas, saidas],
                            backgroundColor: [
                                'rgba(16, 185, 129, 0.7)',
                                'rgba(239, 68, 68, 0.7)'
                            ],
                            borderColor: [
                                'rgba(16, 185, 129, 1)',
                                'rgba(239, 68, 68, 1)'
                            ],
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    precision: 0
                                }
                            }
                        }
                    }
                });
            }
        }
    }catch(error){
        console.error('Erro ao carregar resumo de estoque', error);
    } finally {
        setTimeout(() => setLoading(key, false), 1000);
    }
}

async function loadEstoquePendentes(){
    const key = 'loadEstoquePendentes';
    if (isLoading(key)) {
        console.warn(`⚠️ Já carregando: ${key}`);
        return;
    }

    const tbody = document.getElementById('estoquePendentesBody');
    const container = document.getElementById('estoqueAprovacoesBody');

    if(!tbody && !container){
        return;
    }

    setLoading(key, true);

    try{
        const res = await fetch('/api/estoque/produtos/pendentes',{credentials:'include'});
        const data = await res.json();

        if(data.success && data.entradas && data.entradas.length){
            const html = data.entradas.map(item => `
                <tr data-id="${item._id}">
                    <td>${item.produto_nome || 'Produto'}</td>
                    <td>${item.quantidade}</td>
                    <td>${item.fornecedor || '-'}</td>
                    <td>${item.motivo || '-'}</td>
                    <td>${item.usuario || '-'}</td>
                    <td>
                        <button class="btn btn-sm btn-success" onclick="aprovarEntradaProduto('${item._id}')">
                            <i class="bi bi-check2-circle"></i> Aprovar
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="rejeitarEntradaProduto('${item._id}')">
                            <i class="bi bi-x-circle"></i> Rejeitar
                        </button>
                    </td>
                </tr>`).join('');

            if(tbody) tbody.innerHTML = html;

            // Para a tab de aprovações com cards
            if(container) {
                const cards = data.entradas.map(item => `
                    <div class="pending-stock-card">
                        <div class="product-info">
                            <h5>${item.produto_nome || 'Produto'}</h5>
                            <p>Quantidade: <strong>${item.quantidade}</strong></p>
                            <p>Fornecedor: ${item.fornecedor || '-'}</p>
                            <p>Motivo: ${item.motivo || '-'}</p>
                            <p class="text-muted">Solicitado por: ${item.usuario || '-'}</p>
                        </div>
                        <div class="approval-actions">
                            <button class="btn btn-success" onclick="aprovarEntradaProduto('${item._id}')">
                                <i class="bi bi-check2-circle"></i> Aprovar
                            </button>
                            <button class="btn btn-danger" onclick="rejeitarEntradaProduto('${item._id}')">
                                <i class="bi bi-x-circle"></i> Rejeitar
                            </button>
                        </div>
                    </div>
                `).join('');
                container.innerHTML = cards;
            }
        }else{
            const emptyMsg = '<tr><td colspan="6" class="text-center text-muted">Nenhuma entrada pendente</td></tr>';
            if(tbody) tbody.innerHTML = emptyMsg;
            if(container) container.innerHTML = '<p class="text-center text-muted">Nenhuma entrada pendente de aprovação</p>';
        }
    }catch(error){
        console.error('Erro ao carregar pendências de estoque', error);
        const errorMsg = '<tr><td colspan="6" class="text-center text-muted">Erro ao carregar dados</td></tr>';
        if(tbody) tbody.innerHTML = errorMsg;
        if(container) container.innerHTML = '<p class="text-center text-danger">Erro ao carregar dados</p>';
    } finally {
        setTimeout(() => setLoading(key, false), 1000);
    }
}

async function loadEstoqueMovimentos(){
    const key = 'loadEstoqueMovimentos';
    if (isLoading(key)) {
        console.warn(`⚠️ Já carregando: ${key}`);
        return;
    }

    const tbody = document.getElementById('estoqueMovimentacoesBody');
    if(!tbody) return;

    setLoading(key, true);

    try {
        // Obter filtros
        const tipo = document.getElementById('filtroTipoMov')?.value || '';
        const dataInicio = document.getElementById('filtroDataInicioMov')?.value || '';
        const dataFim = document.getElementById('filtroDataFimMov')?.value || '';
        const perPage = document.getElementById('filtroPerPageMov')?.value || '50';
        const page = window.currentPageMov || 1;

        // Construir URL com parâmetros
        let url = `/api/estoque/movimentacoes?page=${page}&per_page=${perPage}`;
        if (tipo) url += `&tipo=${tipo}`;
        if (dataInicio) url += `&data_inicio=${dataInicio}`;
        if (dataFim) url += `&data_fim=${dataFim}`;

        const res = await fetch(url, {credentials: 'include'});
        const data = await res.json();

        if (data.success && data.movimentacoes && data.movimentacoes.length) {
            tbody.innerHTML = data.movimentacoes.map(item => `
                <tr>
                    <td>${formatarDataHora(item.data)}</td>
                    <td><span class="badge ${item.tipo === 'entrada' ? 'success' : 'danger'}">${item.tipo || '-'}</span></td>
                    <td>${item.produto_nome || item.produto_id || '-'}</td>
                    <td>${item.quantidade || 0}</td>
                    <td>${item.motivo || '-'}</td>
                    <td>${item.usuario || '-'}</td>
                    <td>${item.nota_fiscal || '-'}</td>
                </tr>`).join('');

            // Atualizar paginação
            if (data.pagination) {
                window.totalPagesMov = data.pagination.total_pages;
                window.currentPageMov = data.pagination.page;

                const paginacaoDiv = document.getElementById('paginacaoMovimentacoes');
                const infoPagina = document.getElementById('infoPaginaMov');

                if (paginacaoDiv && infoPagina) {
                    paginacaoDiv.style.display = 'flex';
                    infoPagina.textContent = `Página ${data.pagination.page} de ${data.pagination.total_pages} (Total: ${data.pagination.total} registros)`;
                }
            }
        } else {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">Nenhuma movimentação registrada</td></tr>';
            document.getElementById('paginacaoMovimentacoes')?.style.setProperty('display', 'none', 'important');
        }
    } catch (error) {
        console.error('Erro ao carregar movimentações', error);
        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-danger">Erro ao carregar dados</td></tr>';
    } finally {
        setTimeout(() => setLoading(key, false), 1000);
    }
}

// Função para mudar página de movimentações
function mudarPaginaMov(direcao) {
    const currentPage = window.currentPageMov || 1;
    const totalPages = window.totalPagesMov || 1;
    
    let newPage = currentPage + direcao;
    if (newPage < 1) newPage = 1;
    if (newPage > totalPages) newPage = totalPages;
    
    window.currentPageMov = newPage;
    loadEstoqueMovimentos();
}

// Função para gerar relatório de estoque
async function gerarRelatorioEstoque() {
    const dataInicio = document.getElementById('relatorioDataInicio')?.value || '';
    const dataFim = document.getElementById('relatorioDataFim')?.value || '';
    
    try {
        let url = '/api/estoque/relatorio?';
        if (dataInicio) url += `data_inicio=${dataInicio}&`;
        if (dataFim) url += `data_fim=${dataFim}&`;
        
        const res = await fetch(url, {credentials: 'include'});
        const data = await res.json();
        
        if (data.success && data.relatorio) {
            const rel = data.relatorio;
            
            // Atualizar cards
            document.getElementById('relTotalProdutos').textContent = rel.total_produtos || 0;
            document.getElementById('relValorEstoque').textContent = formatarMoeda(rel.valor_total_estoque);
            document.getElementById('relSemEstoque').textContent = rel.produtos_sem_estoque || 0;
            
            // Top produtos
            const topProdutosBody = document.getElementById('relTopProdutos');
            if (rel.mais_movimentados && rel.mais_movimentados.length > 0) {
                topProdutosBody.innerHTML = rel.mais_movimentados.map(p => `
                    <tr>
                        <td>${p.produto_nome || 'N/A'}</td>
                        <td>${p.total_movimentacoes || 0}</td>
                        <td>${p.total_quantidade || 0}</td>
                    </tr>
                `).join('');
            } else {
                topProdutosBody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">Sem dados</td></tr>';
            }
            
            // Últimas movimentações
            const ultimasMovBody = document.getElementById('relUltimasMovimentacoes');
            if (rel.ultimas_movimentacoes && rel.ultimas_movimentacoes.length > 0) {
                ultimasMovBody.innerHTML = rel.ultimas_movimentacoes.map(m => `
                    <tr>
                        <td>${formatarDataHora(m.data)}</td>
                        <td><span class="badge ${m.tipo === 'entrada' ? 'success' : 'danger'}">${m.tipo}</span></td>
                        <td>${m.quantidade || 0}</td>
                    </tr>
                `).join('');
            } else {
                ultimasMovBody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">Sem dados</td></tr>';
            }
            
            // Mostrar container de resultados
            document.getElementById('relatorioEstoqueContainer').style.display = 'block';
            
            if (window.Swal) {
                Swal.fire({
                    icon: 'success',
                    title: 'Relatório Gerado!',
                    text: 'Relatório gerado com sucesso',
                    timer: 2000,
                    showConfirmButton: false
                });
            }
        }
    } catch (error) {
        console.error('Erro ao gerar relatório:', error);
        if (window.Swal) {
            Swal.fire({
                icon: 'error',
                title: 'Erro',
                text: 'Erro ao gerar relatório de estoque'
            });
        }
    }
}

// Função para exportar relatório em Excel
function exportarRelatorioExcel() {
    const dataInicio = document.getElementById('relatorioDataInicio')?.value || '';
    const dataFim = document.getElementById('relatorioDataFim')?.value || '';
    
    let url = '/api/estoque/relatorio?formato=excel';
    if (dataInicio) url += `&data_inicio=${dataInicio}`;
    if (dataFim) url += `&data_fim=${dataFim}`;
    
    window.open(url, '_blank');
    
    if (window.Swal) {
        Swal.fire({
            icon: 'success',
            title: 'Download Iniciado!',
            text: 'O arquivo Excel será baixado em instantes',
            timer: 2000,
            showConfirmButton: false
        });
    }
}

function formatarMoeda(valor){
    return 'R$ ' + Number(valor || 0).toLocaleString('pt-BR',{minimumFractionDigits:2, maximumFractionDigits:2});
}

function formatarDataHora(valor){
    if(!valor){
        return '-';
    }
    const data = new Date(valor);
    if(Number.isNaN(data.getTime())){
        return '-';
    }
    return data.toLocaleString('pt-BR');
}

async function ensureProdutosCache(){
    if(produtosDisponiveis.length){
        produtosCache = produtosDisponiveis;
        return produtosCache;
    }
    if(!produtosCache.length){
        try{
            const res = await fetch('/api/produtos',{credentials:'include'});
            const data = await res.json();
            if(data.success && data.produtos){
                produtosCache = data.produtos;
            }
        }catch(error){
            console.error('Erro ao carregar produtos para estoque', error);
        }
    }
    return produtosCache;
}

async function abrirEntradaEstoque(){
    try{
        const produtos = await ensureProdutosCache();
        if(!produtos.length){
            Swal.fire('Aviso','Cadastre produtos antes de registrar entradas.','info');
            return;
        }
        const options = produtos.map(p=>`<option value="${p._id}">${p.nome}${p.sku ? ` - ${p.sku}` : ''} (Estoque: ${p.estoque || 0})</option>`).join('');
        const { value } = await Swal.fire({
            title:'Registrar entrada',
            html:`<div class="text-start">
                    <label class="form-label">Produto</label>
                    <select id="entradaProduto" class="form-select">${options}</select>
                    <label class="form-label mt-3">Quantidade</label>
                    <input type="number" id="entradaQuantidade" min="1" value="1" class="form-control">
                    <label class="form-label mt-3">Custo unitário (opcional)</label>
                    <input type="number" id="entradaCusto" step="0.01" class="form-control">
                    <label class="form-label mt-3">Fornecedor</label>
                    <input type="text" id="entradaFornecedor" class="form-control">
                    <label class="form-label mt-3">Nota fiscal</label>
                    <input type="text" id="entradaNota" class="form-control">
                    <label class="form-label mt-3">Motivo</label>
                    <textarea id="entradaMotivo" class="form-control" rows="2">Reposição de estoque</textarea>
                </div>`,
            showCancelButton:true,
            confirmButtonText:'Registrar',
            cancelButtonText:'Cancelar',
            preConfirm:()=>{
                const produto = document.getElementById('entradaProduto').value;
                const quantidade = Number(document.getElementById('entradaQuantidade').value);
                if(!produto || quantidade <= 0){
                    Swal.showValidationMessage('Informe o produto e uma quantidade válida');
                    return false;
                }
                return {
                    produto_id: produto,
                    quantidade: quantidade,
                    custo_unitario: Number(document.getElementById('entradaCusto').value || 0),
                    fornecedor: document.getElementById('entradaFornecedor').value.trim(),
                    nota_fiscal: document.getElementById('entradaNota').value.trim(),
                    motivo: document.getElementById('entradaMotivo').value.trim() || 'Reposição de estoque'
                };
            }
        });
        if(value){
            const res = await fetch('/api/estoque/entrada',{
                method:'POST',
                headers:{'Content-Type':'application/json'},
                credentials:'include',
                body:JSON.stringify(value)
            });
            const data = await res.json();
            if(data.success){
                Swal.fire('Sucesso', data.message || 'Entrada registrada e aguardando aprovação.', 'success');
                loadEstoque();
            }else{
                throw new Error(data.message || 'Não foi possível registrar a entrada');
            }
        }
    }catch(error){
        console.error('Erro ao registrar entrada', error);
        Swal.fire('Erro','Não foi possível registrar a entrada.','error');
    }
}

async function abrirSaidaEstoque(){
    try{
        const produtos = await ensureProdutosCache();
        if(!produtos.length){
            Swal.fire('Aviso','Cadastre produtos antes de registrar saídas.','info');
            return;
        }
        const options = produtos.map(p=>`<option value="${p._id}">${p.nome}${p.sku ? ` - ${p.sku}` : ''} (Estoque: ${p.estoque || 0})</option>`).join('');
        const { value } = await Swal.fire({
            title:'Registrar saída',
            html:`<div class="text-start">
                    <label class="form-label">Produto</label>
                    <select id="saidaProduto" class="form-select">${options}</select>
                    <label class="form-label mt-3">Quantidade</label>
                    <input type="number" id="saidaQuantidade" min="1" value="1" class="form-control">
                    <label class="form-label mt-3">Motivo</label>
                    <textarea id="saidaMotivo" class="form-control" rows="2">Consumo interno</textarea>
                </div>`,
            showCancelButton:true,
            confirmButtonText:'Registrar',
            cancelButtonText:'Cancelar',
            preConfirm:()=>{
                const produto = document.getElementById('saidaProduto').value;
                const quantidade = Number(document.getElementById('saidaQuantidade').value);
                if(!produto || quantidade <= 0){
                    Swal.showValidationMessage('Informe o produto e uma quantidade válida');
                    return false;
                }
                return {
                    produto_id: produto,
                    quantidade: quantidade,
                    motivo: document.getElementById('saidaMotivo').value.trim() || 'Saída manual'
                };
            }
        });
        if(value){
            const res = await fetch('/api/estoque/saida',{
                method:'POST',
                headers:{'Content-Type':'application/json'},
                credentials:'include',
                body:JSON.stringify(value)
            });
            const data = await res.json();
            if(data.success){
                Swal.fire('Sucesso', data.message || 'Saída registrada com sucesso.', 'success');
                loadEstoque();
            }else{
                throw new Error(data.message || 'Não foi possível registrar a saída');
            }
        }
    }catch(error){
        console.error('Erro ao registrar saída', error);
        Swal.fire('Erro','Não foi possível registrar a saída.','error');
    }
}

async function aprovarEntradaEstoque(id){
    try{
        const res = await fetch(`/api/estoque/entrada/${id}/aprovar`,{method:'POST',credentials:'include'});
        const data = await res.json();
        if(data.success){
            Swal.fire('Entrada aprovada!','Estoque atualizado com sucesso.','success');
            loadEstoque();
        }else{
            throw new Error(data.message || 'Não foi possível aprovar a entrada');
        }
    }catch(error){
        console.error('Erro ao aprovar entrada', error);
        Swal.fire('Erro','Não foi possível aprovar a entrada.','error');
    }
}

async function rejeitarEntradaEstoque(id){
    const { value: motivo } = await Swal.fire({
        title:'Rejeitar entrada',
        input:'textarea',
        inputLabel:'Informe o motivo',
        inputPlaceholder:'Motivo da rejeição',
        showCancelButton:true,
        confirmButtonText:'Rejeitar',
        cancelButtonText:'Cancelar',
        inputValidator:value=>!value && 'Informe o motivo'
    });
    if(!motivo){ return; }
    try{
        const res = await fetch(`/api/estoque/entrada/${id}/rejeitar`,{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            credentials:'include',
            body:JSON.stringify({motivo})
        });
        const data = await res.json();
        if(data.success){
            Swal.fire('Entrada rejeitada','Registro atualizado.','info');
            loadEstoque();
        }else{
            throw new Error(data.message || 'Não foi possível rejeitar');
        }
    }catch(error){
        console.error('Erro ao rejeitar entrada', error);
        Swal.fire('Erro','Não foi possível rejeitar a entrada.','error');
    }
}

async function importarPlanilhaEstoque(input){
    const file = input.files?.[0];
    if(!file){
        return;
    }
    const formData = new FormData();
    formData.append('file', file);
    formData.append('tipo', 'estoque');
    Swal.fire({title:'Importando estoque...',allowOutsideClick:false,didOpen:()=>Swal.showLoading()});
    try{
        const res = await fetch('/api/estoque/importar',{method:'POST',credentials:'include',body:formData});
        const data = await res.json();
        Swal.close();
        if(data.success){
            Swal.fire('Importação concluída',`Registros processados: ${data.importados || 0}
Falhas: ${data.erros || 0}`,'success');
            loadEstoque();
        }else{
            throw new Error(data.message || 'Erro ao importar arquivo');
        }
    }catch(error){
        console.error('Erro ao importar estoque', error);
        Swal.close();
        Swal.fire('Erro','Não foi possível importar o arquivo.','error');
    }finally{
        input.value='';
    }
}

function exportarEstoque(){
    window.open('/api/estoque/exportar','_blank');
}

function atualizarPreviewLogo(tipo, url){
    const previewId = tipo === 'login' ? 'logoLoginPreview' : 'logoPrincipalPreview';
    const preview = document.getElementById(previewId);
    if(!preview){
        return;
    }
    preview.innerHTML = '';
    if(url){
        const img = document.createElement('img');
        img.src = url;
        preview.appendChild(img);
    }else{
        preview.innerHTML = '<span class="text-muted">Selecione uma imagem</span>';
    }
}

function aplicarLogosNaInterface(){
    const sidebarLogo = document.querySelector('.sidebar-logo');
    if(!sidebarLogo){
        console.warn('⚠️ .sidebar-logo não encontrado');
        return;
    }
    let img = document.getElementById('sidebarLogoImage');
    const h1 = sidebarLogo.querySelector('h1');
    const p = sidebarLogo.querySelector('p');

    if(logosPersonalizados.principal){
        console.log('🖼️ Aplicando logo personalizado:', logosPersonalizados.principal);

        if(!img){
            img = document.createElement('img');
            img.id = 'sidebarLogoImage';
            img.alt = 'Logo Personalizado';
            sidebarLogo.prepend(img);
        }

        img.src = logosPersonalizados.principal;

        // Adicionar classe para esconder texto via CSS
        sidebarLogo.classList.add('has-custom-logo');

        // Log de sucesso
        img.onload = () => {
            console.log('✅ Logo carregado com sucesso!');
        };

        img.onerror = () => {
            console.error('❌ Erro ao carregar logo');
            sidebarLogo.classList.remove('has-custom-logo');
        };
    }else{
        console.log('📝 Usando texto padrão (sem logo personalizado)');

        if(img) img.remove();

        // Remover classe para mostrar texto
        sidebarLogo.classList.remove('has-custom-logo');
    }
    let authImg = document.getElementById('authLogoCustom');
    if(!authImg){
        authImg = document.createElement('img');
        authImg.id = 'authLogoCustom';
        authImg.style.display='none';
        authImg.style.maxHeight='120px';
        authImg.style.margin='0 auto 20px';
        const authLogoContainer = document.querySelector('.auth-logo');
        if(authLogoContainer){
            authLogoContainer.insertBefore(authImg, authLogoContainer.firstChild);
        }
    }
    const iconLogo = document.querySelector('.auth-logo .logo-icon');
    if(logosPersonalizados.login){
        authImg.src = logosPersonalizados.login;
        authImg.style.display='block';
        if(iconLogo){ iconLogo.style.display='none'; }
    }else{
        authImg.style.display='none';
        if(iconLogo){ iconLogo.style.display='block'; }
    }
}

async function loadConfiguracoes(force=false){
    const key = 'loadConfiguracoes';

    if(!force && configuracoesAtuais){
        aplicarLogosNaInterface();
        return configuracoesAtuais;
    }

    if (isLoading(key)) {
        console.warn(`⚠️ Já carregando: ${key}`);
        return;
    }
    setLoading(key, true);

    try{
        const res = await fetch('/api/config',{credentials:'include'});
        const data = await res.json();
        if(data.success && data.config){
            configuracoesAtuais = data.config;
            document.getElementById('cfgNome').value = configuracoesAtuais.nome_empresa || '';
            document.getElementById('cfgCNPJ').value = configuracoesAtuais.cnpj || '';
            document.getElementById('cfgEndereco').value = configuracoesAtuais.endereco || '';
            document.getElementById('cfgTelefone').value = configuracoesAtuais.telefone || '';
            document.getElementById('cfgEmail').value = configuracoesAtuais.email || '';
            logosPersonalizados.principal = configuracoesAtuais.logo_url || null;
            logosPersonalizados.login = configuracoesAtuais.logo_login_url || null;
            atualizarPreviewLogo('principal', logosPersonalizados.principal);
            atualizarPreviewLogo('login', logosPersonalizados.login);
            aplicarLogosNaInterface();
        }
    }catch(error){
        console.error('Erro ao carregar configurações', error);
    } finally {
        setTimeout(() => setLoading(key, false), 1000);
    }
    return configuracoesAtuais;
}

async function abrirUploadLogo(tipo){
    const tipoLabel = tipo === 'login' ? 'Logo de Login' : 'Logo Principal do Sistema';

    const {value: file} = await Swal.fire({
        title: `Upload de ${tipoLabel}`,
        html: `
            <div style="text-align:center;padding:20px;">
                <label for="logoInput" style="cursor:pointer;display:block;margin-bottom:15px;">
                    <div id="logoUploadArea" style="width:200px;height:140px;margin:0 auto;border:3px dashed var(--primary);border-radius:15px;display:flex;align-items:center;justify-content:center;background:var(--bg-main);transition:all 0.3s;position:relative;overflow:hidden;">
                        <i class="bi bi-image" id="logoIcon" style="font-size:4rem;color:var(--primary);"></i>
                        <img id="logoPreview" style="display:none;max-width:100%;max-height:100%;object-fit:contain;padding:10px;">
                    </div>
                    <p style="margin-top:15px;color:var(--text-secondary);font-weight:600;">
                        <i class="bi bi-cloud-upload"></i> Clique para selecionar logo
                    </p>
                </label>
                <input type="file" id="logoInput" accept="image/jpeg,image/jpg,image/png,image/webp" style="display:none;">
                <div id="logoFileInfo" style="display:none;margin-top:15px;padding:15px;background:var(--bg-secondary);border-radius:10px;text-align:left;">
                    <p style="margin:5px 0;color:var(--text-primary);"><strong><i class="bi bi-file-earmark-image"></i> Arquivo:</strong> <span id="logoFileName"></span></p>
                    <p style="margin:5px 0;color:var(--text-primary);"><strong><i class="bi bi-hdd"></i> Tamanho:</strong> <span id="logoFileSize"></span></p>
                    <p style="margin:5px 0;color:var(--text-primary);"><strong><i class="bi bi-filetype-jpg"></i> Tipo:</strong> <span id="logoFileType"></span></p>
                </div>
                <p style="margin-top:15px;font-size:0.85rem;color:var(--text-muted);">
                    <i class="bi bi-info-circle"></i> Formatos: PNG, JPG, WebP | Máximo: 2MB<br>
                    <span style="font-size:0.8rem;">Recomendado: fundo transparente (PNG)</span>
                </p>
            </div>
        `,
        width: '550px',
        showCancelButton: true,
        confirmButtonText: '<i class="bi bi-upload"></i> Enviar Logo',
        cancelButtonText: '<i class="bi bi-x-circle"></i> Cancelar',
        confirmButtonColor: '#3B82F6',
        cancelButtonColor: '#6c757d',
        didOpen: () => {
            const input = document.getElementById('logoInput');
            const uploadArea = document.getElementById('logoUploadArea');

            // Click no label
            uploadArea.parentElement.addEventListener('click', () => input.click());

            // Preview e validação ao selecionar
            input.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;

                // Validar imagem (logos = 2MB máximo)
                const validation = validarImagemUpload(file, {
                    maxSizeMB: 2,
                    allowedTypes: ['image/jpeg', 'image/jpg', 'image/png', 'image/webp']
                });

                if (!validation.valid) {
                    Swal.showValidationMessage(validation.error);
                    input.value = '';
                    return;
                }

                // Mostrar preview
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('logoIcon').style.display = 'none';
                    const preview = document.getElementById('logoPreview');
                    preview.src = e.target.result;
                    preview.style.display = 'block';

                    // Mostrar info do arquivo
                    document.getElementById('logoFileName').textContent = validation.fileInfo.name;
                    document.getElementById('logoFileSize').textContent = validation.fileInfo.size;
                    document.getElementById('logoFileType').textContent = validation.fileInfo.type;
                    document.getElementById('logoFileInfo').style.display = 'block';
                };
                reader.readAsDataURL(file);
            });
        },
        preConfirm: () => {
            const fileInput = document.getElementById('logoInput');
            if (!fileInput.files || fileInput.files.length === 0) {
                Swal.showValidationMessage('Selecione uma imagem primeiro');
                return false;
            }

            // Validar novamente
            const validation = validarImagemUpload(fileInput.files[0], {
                maxSizeMB: 2,
                allowedTypes: ['image/jpeg', 'image/jpg', 'image/png', 'image/webp']
            });
            if (!validation.valid) {
                Swal.showValidationMessage(validation.error);
                return false;
            }

            return fileInput.files[0];
        }
    });

    if (file) {
        await processarUploadLogo(file, tipo);
    }
}

async function processarUploadLogo(file, tipo){
    const reader = new FileReader();

    reader.onload = async () => {
        try{
            // Modal com progress
            Swal.fire({
                title: 'Enviando Logo...',
                html: `
                    <div style="padding:20px;">
                        <div style="margin-bottom:15px;">
                            <div style="width:100%;height:30px;background:var(--bg-secondary);border-radius:15px;overflow:hidden;">
                                <div id="logoProgressBar" style="width:0%;height:100%;background:linear-gradient(90deg,#3B82F6,#2563EB);transition:width 0.3s;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:0.9rem;"></div>
                            </div>
                        </div>
                        <p id="logoProgressText" style="color:var(--text-secondary);margin-top:10px;">Processando imagem...</p>
                    </div>
                `,
                allowOutsideClick: false,
                showConfirmButton: false
            });

            // Simular progresso (já que é base64)
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += 10;
                const bar = document.getElementById('logoProgressBar');
                const text = document.getElementById('logoProgressText');
                if (bar) {
                    bar.style.width = progress + '%';
                    bar.textContent = progress + '%';
                }
                if (text && progress < 80) {
                    text.textContent = 'Enviando logo...';
                }
                if (progress >= 90) clearInterval(progressInterval);
            }, 100);

            const res = await fetch('/api/upload/imagem',{
                method:'POST',
                headers:{'Content-Type':'application/json'},
                credentials:'include',
                body:JSON.stringify({image_data: reader.result, tipo: tipo === 'login' ? 'logo_login' : 'logo'})
            });

            clearInterval(progressInterval);

            const data = await res.json();
            if(data.success){
                const url = data.data_url || data.url;
                if(tipo === 'login'){
                    logosPersonalizados.login = url;
                }else{
                    logosPersonalizados.principal = url;
                }
                atualizarPreviewLogo(tipo, url);
                aplicarLogosNaInterface();

                Swal.fire({
                    icon: 'success',
                    title: 'Logo Atualizada!',
                    text: `${tipo === 'login' ? 'Logo de login' : 'Logo principal'} foi atualizada com sucesso`,
                    timer: 2000,
                    showConfirmButton: false
                });
            }else{
                throw new Error(data.message || 'Erro ao enviar imagem');
            }
        }catch(error){
            console.error('Erro ao processar logo', error);
            Swal.fire('Erro','Não foi possível enviar a logo. Tente novamente.','error');
        }
    };

    reader.readAsDataURL(file);
}

function removerLogo(tipo){
    if(tipo === 'login'){
        logosPersonalizados.login = null;
    }else{
        logosPersonalizados.principal = null;
    }
    atualizarPreviewLogo(tipo, null);
    aplicarLogosNaInterface();
}

function abrirComunidadeDetalhe(tipo){
    const mensagens = {
        conexao: {titulo:'Plano Conexão VIP', descricao:'Programa pensado para clientes recorrentes com foco em alta performance e personalização total.'},
        workshops: {titulo:'Workshops BIOMA', descricao:'Inscrições abertas para capacitações em neurovendas, gestão de agenda inteligente e protocolos de alopecia.'},
        cases: {titulo:'Histórias de Sucesso', descricao:'Veja depoimentos em vídeo com resultados de faturamento, fidelização e novos produtos.'},
        ideias: {titulo:'Canal de Ideias', descricao:'Envie novas sugestões diretamente para o time de produto BIOMA e acompanhe o status de implementação.'}
    };
    const info = mensagens[tipo] || {titulo:'Comunidade BIOMA', descricao:'Recurso exclusivo para franquias.'};
    Swal.fire({title: info.titulo, text: info.descricao, icon:'info'});
}

async function loadDashboard(){
    const key = 'loadDashboard';

    // PROTEÇÃO ANTI-LOOP
    if (isLoading(key)) {
        console.warn(`⚠️ Já carregando: ${key}`);
        return;
    }

    setLoading(key, true);

    try{
        const res=await fetch('/api/dashboard/stats',{credentials:'include'});
        const data=await res.json();
        if(data.success){
            document.getElementById('dashOrcamentos').textContent=data.stats.total_orcamentos||0;
            document.getElementById('dashClientes').textContent=data.stats.total_clientes||0;
            document.getElementById('dashAgendamentos').textContent=data.stats.agendamentos_hoje||0;
            document.getElementById('dashFaturamento').textContent='R$ '+(data.stats.faturamento||0).toFixed(0);
        }
        const estoqueRes=await fetch('/api/estoque/alerta',{credentials:'include'});
        const estoqueData=await estoqueRes.json();
        if(estoqueData.success&&estoqueData.produtos&&estoqueData.produtos.length>0){
            const html=estoqueData.produtos.slice(0,5).map(p=>`<div style="padding:10px;border-bottom:1px solid var(--border-color)"><strong>${p.nome}</strong><br><small>Estoque: ${p.estoque} | Mínimo: ${p.estoque_minimo}</small></div>`).join('');
            // document.getElementById('alertasEstoque').innerHTML=html;
        }else{
            // document.getElementById('alertasEstoque').innerHTML='<p class="text-center text-success">✅ Estoque OK</p>';
        }
        const agendRes=await fetch('/api/agendamentos',{credentials:'include'});
        const agendData=await agendRes.json();
        if(agendData.success&&agendData.agendamentos&&agendData.agendamentos.length>0){
            const html=agendData.agendamentos.map(a=>{
                const dataFormatada=new Date(a.data).toLocaleDateString('pt-BR');
                return `<div style="padding:10px;border-bottom:1px solid var(--border-color)"><strong>${a.cliente_nome||'Cliente'}</strong><br><small>${dataFormatada} às ${a.horario}</small></div>`;
            }).join('');
            document.getElementById('proximosAgendamentos').innerHTML=html;
        }else{
            document.getElementById('proximosAgendamentos').innerHTML='<p class="text-center text-muted">📅 Nenhum agendamento</p>';
        }
        const orcRes=await fetch('/api/orcamentos',{credentials:'include'});
        const orcData=await orcRes.json();
        if(orcData.success&&orcData.orcamentos&&orcData.orcamentos.length>0){
            const html=orcData.orcamentos.slice(0,10).map(o=>`<tr><td><strong>#${o.numero}</strong></td><td>${new Date(o.created_at).toLocaleDateString('pt-BR')}</td><td>${o.cliente_nome}</td><td><strong>R$ ${o.total_final.toFixed(2)}</strong></td><td><span class="badge ${o.status==='Aprovado'?'success':'warning'}">${o.status}</span></td></tr>`).join('');
            document.getElementById('ultimosOrcamentosBody').innerHTML=html;
        }else{
            document.getElementById('ultimosOrcamentosBody').innerHTML='<tr><td colspan="5" class="text-center text-muted">Nenhum</td></tr>';
        }
    }catch(e){
        console.error('❌ Dashboard error:',e);
    } finally {
        setTimeout(() => setLoading(key, false), 1000);
    }
}

async function verificarStatus(){
    const key = 'verificarStatus';
    if (isLoading(key)) {
        console.warn(`⚠️ Já carregando: ${key}`);
        return;
    }
    setLoading(key, true);

    try{
        const res=await fetch('/api/system/status',{credentials:'include'});
        const data=await res.json();
        if(data.success){
            const mongoStatus=document.getElementById('mongoStatus');
            const mongoMsg=document.getElementById('mongoMessage');
            if(data.status.mongodb.operational){
                mongoStatus.className='badge success';
                mongoStatus.innerHTML='✅ Online';
                mongoMsg.textContent=data.status.mongodb.message;
            }else{
                mongoStatus.className='badge danger';
                mongoStatus.innerHTML='❌ Offline';
                mongoMsg.textContent=data.status.mongodb.message;
            }
            const emailStatus=document.getElementById('emailStatus');
            if(data.status.mailersend.operational){
                emailStatus.className='badge success';
                emailStatus.innerHTML='✅ Ativo';
                document.getElementById('emailMessage').textContent=data.status.mailersend.message;
            }else{
                emailStatus.className='badge danger';
                emailStatus.innerHTML='❌ Inativo';
                document.getElementById('emailMessage').textContent=data.status.mailersend.message;
            }
        }
    }catch(e){
        console.error('❌ Status error:',e);
    } finally {
        setTimeout(() => setLoading(key, false), 1000);
    }
}

async function carregarFormulariosCliente(){
    if (anamneseDef && prontuarioDef) return;
    try {
        const res = await fetch('/api/clientes/formularios', {credentials: 'include'});
        const data = await res.json();
        if (data.success) {
            anamneseDef = data.anamnese || [];
            prontuarioDef = data.prontuario || [];
        }
    } catch (error) {
        console.error('Erro ao carregar formularios de cliente', error);
    }
}

async function loadClientes(){
    const key = 'loadClientes';

    // PROTEÇÃO ANTI-LOOP
    if (isLoading(key)) {
        console.warn(`⚠️ Já carregando: ${key}`);
        return;
    }

    setLoading(key, true);

    try{
        await carregarFormulariosCliente();
        const res = await fetch('/api/clientes',{credentials:'include'});
        const data = await res.json();
        const tbody = document.getElementById('clientesBody');
        if(data.success && Array.isArray(data.clientes) && data.clientes.length){
            const html = data.clientes.map(c => {
                return `<tr>
                    <td><strong>${c.nome}</strong><br><small class="text-muted">${c.email||''}</small></td>
                    <td>${c.cpf}</td>
                    <td>${c.telefone||'-'}</td>
                    <td><strong>R$ ${(c.total_gasto||0).toFixed(2)}</strong></td>
                    <td>${c.total_visitas||0}</td>
                    <td class="d-flex flex-wrap gap-2">
                        <button class="btn btn-sm btn-info" onclick="visualizarCliente('${c._id}')"><i class="bi bi-eye"></i></button>
                        <button class="btn btn-sm btn-primary" onclick="editarCliente('${c._id}')"><i class="bi bi-pencil"></i></button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="abrirAnamneseCliente('${c._id}')"><i class="bi bi-file-earmark-medical"></i></button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="abrirProntuarioCliente('${c._id}')"><i class="bi bi-journal-medical"></i></button>
                        <button class="btn btn-sm btn-danger" onclick="deleteCliente('${c._id}')"><i class="bi bi-trash"></i></button>
                    </td>
                </tr>`;
            }).join('');
            tbody.innerHTML = html;
        } else {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Nenhum cliente</td></tr>';
        }
    }catch(e){
        console.error('Erro ao carregar clientes', e);
        document.getElementById('clientesBody').innerHTML='<tr><td colspan="6" class="text-center text-danger">Erro</td></tr>';
    } finally {
        setTimeout(() => setLoading(key, false), 1000);
    }
}

async function deleteCliente(id){
    const result=await Swal.fire({title:'Deletar?',icon:'warning',showCancelButton:true});
    if(result.isConfirmed){
        try{
            await fetch(`/api/clientes/${id}`,{method:'DELETE',credentials:'include'});
            Swal.fire('Deletado!','','success');
            loadClientes();
        }catch(e){
            Swal.fire('Erro','','error');
        }
    }

    // Limpeza de backdrop residual
    setTimeout(() => {
        document.querySelectorAll('.swal2-container, .swal2-backdrop-show').forEach(el => {
            if (!Swal.isVisible()) el.remove();
        });
        document.body.classList.remove('swal2-shown', 'swal2-height-auto');
    }, 100);
}

function filtrarClientes(){
    const termo=document.getElementById('buscaCliente').value.toLowerCase();
    const rows=document.querySelectorAll('#clientesBody tr');
    rows.forEach(row=>{
        const text=row.textContent.toLowerCase();
        row.style.display=text.includes(termo)?'':'none';
    });
}

function showModalCliente(){
    Swal.fire({
        title:'Novo Cliente',
        html:`<div class="text-start">
                <div class="row g-3">
                    <div class="col-md-6"><label class="form-label">Nome *</label><input type="text" id="swal-nome" class="form-control" placeholder="Nome completo"></div>
                    <div class="col-md-6"><label class="form-label">CPF *</label><input type="text" id="swal-cpf" class="form-control" placeholder="000.000.000-00"></div>
                    <div class="col-md-6"><label class="form-label">E-mail</label><input type="email" id="swal-email" class="form-control" placeholder="email@exemplo.com"></div>
                    <div class="col-md-6"><label class="form-label">Telefone</label><input type="text" id="swal-telefone" class="form-control" placeholder="(00) 00000-0000"></div>
                    <div class="col-md-6"><label class="form-label">Data de nascimento</label><input type="date" id="swal-data-nascimento" class="form-control"></div>
                    <div class="col-md-6"><label class="form-label">Indicação</label><input type="text" id="swal-indicacao" class="form-control"></div>
                    <div class="col-md-6"><label class="form-label">Preferências</label><textarea id="swal-preferencias" class="form-control" rows="2"></textarea></div>
                    <div class="col-md-6"><label class="form-label">Restrições</label><textarea id="swal-restricoes" class="form-control" rows="2"></textarea></div>
                    <div class="col-12"><label class="form-label">Observações</label><textarea id="swal-observacoes" class="form-control" rows="2"></textarea></div>
                </div>
            </div>`,
        showCancelButton:true,
        confirmButtonText:'Salvar',
        cancelButtonText:'Cancelar',
        allowEscapeKey: true,
        allowOutsideClick: true,
        showCloseButton: true,
        preConfirm:()=>{
            const nome=document.getElementById('swal-nome').value.trim();
            const cpf=document.getElementById('swal-cpf').value.trim();
            if(!nome || !cpf){
                Swal.showValidationMessage('Nome e CPF são obrigatórios');
                return false;
            }
            return {
                nome,
                cpf,
                email:document.getElementById('swal-email').value.trim(),
                telefone:document.getElementById('swal-telefone').value.trim(),
                data_nascimento:document.getElementById('swal-data-nascimento').value,
                indicacao:document.getElementById('swal-indicacao').value.trim(),
                preferencias:document.getElementById('swal-preferencias').value.trim(),
                restricoes:document.getElementById('swal-restricoes').value.trim(),
                observacoes:document.getElementById('swal-observacoes').value.trim()
            };
        }
    }).then(async(result)=>{
        if(result.isConfirmed){
            try{
                await fetch('/api/clientes',{method:'POST',headers:{'Content-Type':'application/json'},credentials:'include',body:JSON.stringify(result.value)});
                Swal.fire('Sucesso!','Cliente cadastrado','success');
                loadClientes();
            }catch(error){
                console.error('Erro ao cadastrar cliente', error);
                Swal.fire('Erro','Não foi possível cadastrar','error');
            }
        }
    });
}


function renderFormularioCampos(definicoes, prefixo, respostas){
    return (definicoes || []).map(item => {
        const campoId = `${prefixo}_${item.ordem}`;
        const valor = respostas && respostas[item.campo] !== undefined ? respostas[item.campo] : '';
        if(item.tipo === 'select'){
            const opcoes = (item.opcoes || []).map(op => `<option value="${op}" ${valor === op ? 'selected' : ''}>${op}</option>`).join('');
            return `<div class="mb-3"><label class="form-label">${item.campo}</label><select class="form-select" id="${campoId}">${opcoes}</select></div>`;
        }
        if(item.tipo === 'radio'){
            const opcoes = (item.opcoes || []).map((op,idx)=>`
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="${campoId}" id="${campoId}_${idx}" value="${op}" ${valor === op ? 'checked' : ''}>
                    <label class="form-check-label" for="${campoId}_${idx}">${op}</label>
                </div>`).join('');
            return `<div class="mb-3"><label class="form-label">${item.campo}</label>${opcoes}</div>`;
        }
        if(item.tipo === 'checkbox'){
            const selecionados = Array.isArray(valor) ? valor : (valor ? String(valor).split(';').map(v=>v.trim()).filter(Boolean) : []);
            const opcoes = (item.opcoes || []).map((op,idx)=>`
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="${campoId}_${idx}" value="${op}" ${selecionados.includes(op) ? 'checked' : ''}>
                    <label class="form-check-label" for="${campoId}_${idx}">${op}</label>
                </div>`).join('');
            return `<div class="mb-3"><label class="form-label">${item.campo}</label>${opcoes}</div>`;
        }
        if(item.tipo === 'textarea'){
            return `<div class="mb-3"><label class="form-label">${item.campo}</label><textarea class="form-control" id="${campoId}" rows="3">${valor || ''}</textarea></div>`;
        }
        return `<div class="mb-3"><label class="form-label">${item.campo}</label><input type="text" class="form-control" id="${campoId}" value="${valor || ''}"></div>`;
    }).join('');
}

function coletarFormularioRespostas(definicoes, prefixo){
    const respostas = {};
    (definicoes || []).forEach(item => {
        const campoId = `${prefixo}_${item.ordem}`;
        if(item.tipo === 'select'){
            respostas[item.campo] = document.getElementById(campoId)?.value || '';
        } else if(item.tipo === 'radio'){
            const selecionado = document.querySelector(`input[name="${campoId}"]:checked`);
            respostas[item.campo] = selecionado ? selecionado.value : '';
        } else if(item.tipo === 'checkbox'){
            const selecionados = Array.from(document.querySelectorAll(`input[id^="${campoId}_"]:checked`)).map(el=>el.value);
            respostas[item.campo] = selecionados.join('; ');
        } else if(item.tipo === 'textarea'){
            respostas[item.campo] = document.getElementById(campoId)?.value || '';
        } else {
            respostas[item.campo] = document.getElementById(campoId)?.value || '';
        }
    });
    return respostas;
}

function renderResumoFormulario(definicoes, respostas, titulo){
    if(!definicoes || !definicoes.length) return '';
    const itens = definicoes.map(item => {
        const valor = respostas ? respostas[item.campo] : '';
        if(!valor) return '';
        return `<li class="list-group-item d-flex justify-content-between align-items-start">
            <div class="ms-2 me-auto">
                <div class="fw-bold">${item.campo}</div>
                <span>${valor}</span>
            </div>
        </li>`;
    }).filter(Boolean).join('');
    if(!itens) return '';
    return `<div class="mt-3">
        <h6 class="fw-bold">${titulo}</h6>
        <ul class="list-group list-group-flush small">
            ${itens}
        </ul>
    </div>`;
}

async function abrirAnamneseCliente(id){
    try{
        await carregarFormulariosCliente();
        const cliente = await obterCliente(id);
        const respostas = cliente.anamnese || {};
        const html = `<div style="text-align:left;max-height:60vh;overflow:auto">${renderFormularioCampos(anamneseDef,'anamnese',respostas)}</div>`;
        const result = await Swal.fire({
            title: 'Ficha de Anamnese',
            html,
            width: 720,
            focusConfirm: false,
            showCancelButton: true,
            confirmButtonText: 'Salvar',
            cancelButtonText: 'Cancelar'
        });
        if(result.isConfirmed){
            const dados = coletarFormularioRespostas(anamneseDef,'anamnese');
            await fetch(`/api/clientes/${id}`,{
                method:'PUT',
                headers:{'Content-Type':'application/json'},
                credentials:'include',
                body:JSON.stringify({anamnese:dados})
            });
            Swal.fire('Sucesso!','Ficha de anamnese atualizada','success');
            loadClientes();
        }
    }catch(error){
        console.error('Erro ao abrir anamnese', error);
        Swal.fire('Erro','Não foi possível carregar a ficha','error');
    }
}

async function abrirProntuarioCliente(id){
    try{
        await carregarFormulariosCliente();
        const cliente = await obterCliente(id);
        const respostas = cliente.prontuario || {};
        const html = `<div style="text-align:left;max-height:60vh;overflow:auto">${renderFormularioCampos(prontuarioDef,'prontuario',respostas)}</div>`;
        const result = await Swal.fire({
            title: 'Prontuário',
            html,
            width: 720,
            focusConfirm: false,
            showCancelButton: true,
            confirmButtonText: 'Salvar',
            cancelButtonText: 'Cancelar'
        });
        if(result.isConfirmed){
            const dados = coletarFormularioRespostas(prontuarioDef,'prontuario');
            await fetch(`/api/clientes/${id}`,{
                method:'PUT',
                headers:{'Content-Type':'application/json'},
                credentials:'include',
                body:JSON.stringify({prontuario:dados})
            });
            Swal.fire('Sucesso!','Prontuário atualizado','success');
        }
    }catch(error){
        console.error('Erro ao abrir prontuário', error);
        Swal.fire('Erro','Não foi possível carregar o prontuário','error');
    }
}

async function obterCliente(id){
    const res = await fetch(`/api/clientes/${id}`,{credentials:'include'});
    const data = await res.json();
    if(data.success && data.cliente){
        return data.cliente;
    }
    throw new Error(data.message || 'Cliente nao encontrado');
}

async function visualizarCliente(id){
    try{
        await carregarFormulariosCliente();
        const c = await obterCliente(id);
        const blocoResumo = `
            <div style="background:linear-gradient(135deg,#7C3AED,#EC4899);color:#fff;padding:20px;border-radius:15px;margin-bottom:20px">
                <p style="margin:5px 0"><strong>CPF:</strong> ${c.cpf}</p>
                ${c.email?`<p style="margin:5px 0"><strong>Email:</strong> ${c.email}</p>`:''}
                ${c.telefone?`<p style="margin:5px 0"><strong>Telefone:</strong> ${c.telefone}</p>`:''}
                ${c.endereco?`<p style="margin:5px 0"><strong>Endereço:</strong> ${c.endereco}</p>`:''}
            </div>`;
        const blocoEstatisticas = `
            <div style="background:#f3f4f6;padding:15px;border-radius:10px">
                <p><strong>💰 Total Gasto:</strong> <span style="color:#10B981;font-size:1.3rem">R$ ${(c.total_gasto||0).toFixed(2)}</span></p>
                <p><strong>📊 Total de Visitas:</strong> ${c.total_visitas||0}</p>
                ${c.ultima_visita?`<p><strong>🗓️ Última Visita:</strong> ${new Date(c.ultima_visita).toLocaleDateString('pt-BR')}</p>`:''}
            </div>`;
        const blocoObservacoes = c.observacoes ? `<div style="margin-top:15px;padding:10px;background:#FEF3C7;border-left:4px solid #F59E0B;border-radius:5px"><strong>📝 Observações:</strong><p style="margin:5px 0 0">${c.observacoes}</p></div>` : '';
        const fichaAnamnese = renderResumoFormulario(anamneseDef, c.anamnese || {}, 'Anamnese');
        const fichaProntuario = renderResumoFormulario(prontuarioDef, c.prontuario || {}, 'Prontuário');
        Swal.fire({
            title:`<strong>👤 ${c.nome}</strong>`,
            html:`<div style="text-align:left">${blocoResumo}${blocoEstatisticas}${blocoObservacoes}${fichaAnamnese}${fichaProntuario}<p style="margin-top:15px;font-size:0.85rem;color:#6B7280">Cadastrado em: ${c.created_at?new Date(c.created_at).toLocaleString('pt-BR'):''}</p></div>`,
            width:680,
            confirmButtonText:'Fechar',
            confirmButtonColor:'#7C3AED',
            allowEscapeKey: true,
            allowOutsideClick: true,
            showCloseButton: true,
            focusConfirm: true
        });
    }catch(error){
        console.error('Erro ao visualizar cliente', error);
        Swal.fire('Erro','Não foi possível carregar os detalhes','error');
    }
}

async function editarCliente(id){
    try{
        await carregarFormulariosCliente();
        const c = await obterCliente(id);
        const resumo = `<div class="bg-light p-3 rounded mb-3">
                <div><strong>Total gasto:</strong> ${formatarMoeda(c.total_gasto || 0)}</div>
                <div><strong>Visitas:</strong> ${c.total_visitas || 0}</div>
                <div><strong>Última visita:</strong> ${c.ultima_visita ? new Date(c.ultima_visita).toLocaleDateString('pt-BR') : '-'}</div>
            </div>`;
        const html = `<div class="text-start">
                <div class="row g-3">
                    <div class="col-md-6"><label class="form-label">Nome *</label><input type="text" id="swal-nome" class="form-control" value="${c.nome || ''}"></div>
                    <div class="col-md-6"><label class="form-label">CPF *</label><input type="text" id="swal-cpf" class="form-control" value="${c.cpf || ''}"></div>
                    <div class="col-md-6"><label class="form-label">E-mail</label><input type="email" id="swal-email" class="form-control" value="${c.email || ''}"></div>
                    <div class="col-md-6"><label class="form-label">Telefone</label><input type="text" id="swal-telefone" class="form-control" value="${c.telefone || ''}"></div>
                    <div class="col-md-6"><label class="form-label">Data de nascimento</label><input type="date" id="swal-data-nascimento" class="form-control" value="${c.data_nascimento ? c.data_nascimento.substring(0,10) : ''}"></div>
                    <div class="col-md-6"><label class="form-label">Gênero</label><input type="text" id="swal-genero" class="form-control" value="${c.genero || ''}"></div>
                    <div class="col-md-6"><label class="form-label">Estado civil</label><input type="text" id="swal-estado-civil" class="form-control" value="${c.estado_civil || ''}"></div>
                    <div class="col-md-6"><label class="form-label">Profissão</label><input type="text" id="swal-profissao" class="form-control" value="${c.profissao || ''}"></div>
                    <div class="col-md-6"><label class="form-label">Instagram</label><input type="text" id="swal-instagram" class="form-control" value="${c.instagram || ''}"></div>
                    <div class="col-md-6"><label class="form-label">Indicação</label><input type="text" id="swal-indicacao" class="form-control" value="${c.indicacao || ''}"></div>
                    <div class="col-md-12"><label class="form-label">Observações gerais</label><textarea id="swal-observacoes" class="form-control" rows="2">${c.observacoes || ''}</textarea></div>
                    <div class="col-md-6"><label class="form-label">Preferências</label><textarea id="swal-preferencias" class="form-control" rows="2">${c.preferencias || ''}</textarea></div>
                    <div class="col-md-6"><label class="form-label">Restrições</label><textarea id="swal-restricoes" class="form-control" rows="2">${c.restricoes || ''}</textarea></div>
                    <div class="col-md-6"><label class="form-label">Tipo de cabelo</label><input type="text" id="swal-tipo-cabelo" class="form-control" value="${c.tipo_cabelo || ''}"></div>
                    <div class="col-md-6"><label class="form-label">Histórico de tratamentos</label><textarea id="swal-historico" class="form-control" rows="2">${c.historico_tratamentos || ''}</textarea></div>
                </div>
                ${resumo}
            </div>`;
        const { value } = await Swal.fire({
            title:'Editar Cliente',
            html: html,
            focusConfirm:false,
            width:720,
            showCancelButton:true,
            confirmButtonText:'Salvar',
            cancelButtonText:'Cancelar',
            allowEscapeKey: true,
            allowOutsideClick: true,
            showCloseButton: true,
            preConfirm:()=>{
                const nome=document.getElementById('swal-nome').value.trim();
                const cpf=document.getElementById('swal-cpf').value.trim();
                if(!nome || !cpf){
                    Swal.showValidationMessage('Nome e CPF são obrigatórios');
                    return false;
                }
                return {
                    nome,
                    cpf,
                    email:document.getElementById('swal-email').value.trim(),
                    telefone:document.getElementById('swal-telefone').value.trim(),
                    endereco:c.endereco || '',
                    data_nascimento:document.getElementById('swal-data-nascimento').value,
                    genero:document.getElementById('swal-genero').value.trim(),
                    estado_civil:document.getElementById('swal-estado-civil').value.trim(),
                    profissao:document.getElementById('swal-profissao').value.trim(),
                    instagram:document.getElementById('swal-instagram').value.trim(),
                    indicacao:document.getElementById('swal-indicacao').value.trim(),
                    preferencias:document.getElementById('swal-preferencias').value.trim(),
                    restricoes:document.getElementById('swal-restricoes').value.trim(),
                    tipo_cabelo:document.getElementById('swal-tipo-cabelo').value.trim(),
                    historico_tratamentos:document.getElementById('swal-historico').value.trim(),
                    observacoes:document.getElementById('swal-observacoes').value.trim()
                };
            }
        });
        if(value){
            await fetch(`/api/clientes/${id}`,{
                method:'PUT',
                headers:{'Content-Type':'application/json'},
                credentials:'include',
                body:JSON.stringify(value)
            });
            Swal.fire('Sucesso!','Cliente atualizado','success');
            loadClientes();
        }
    }catch(error){
        console.error('Erro ao carregar cliente para edição', error);
        Swal.fire('Erro','Não foi possível carregar para edição','error');
    }
}

async function loadProfissionais(){
    const key = 'loadProfissionais';

    // PROTEÇÃO ANTI-LOOP
    if (isLoading(key)) {
        console.warn(`⚠️ Já carregando: ${key}`);
        return;
    }

    setLoading(key, true);

    try{
        const res=await fetch('/api/profissionais',{credentials:'include'});
        const data=await res.json();
        const tbody=document.getElementById('profissionaisBody');
        if(data.success&&data.profissionais&&data.profissionais.length>0){
            const html=data.profissionais.map(p=>{
                const assistentes = (p.assistentes||[]).map(a=>a.nome||a).join(', ') || '-';
                const fotoHtml = exibirFotoProfissional(p.foto);
                return `<tr data-id="${p._id}">
                    <td>${fotoHtml}</td>
                    <td><strong>${p.nome}</strong></td>
                    <td>${p.cpf||'-'}</td>
                    <td>${p.especialidade||'-'}</td>
                    <td>${p.comissao_perc||0}%</td>
                    <td>${assistentes}</td>
                    <td><span class="badge ${p.ativo?'success':'danger'}">${p.ativo?'Ativo':'Inativo'}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline" onclick="uploadFotoProfissional('${p._id}')" title="Upload Foto">
                            <i class="bi bi-camera"></i>
                        </button>
                        <button class="btn btn-sm btn-info" onclick="visualizarProfissional('${p._id}')" style="background:linear-gradient(135deg,#3B82F6,#2563EB);color:#fff;margin-right:5px">
                            <i class="bi bi-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-primary" onclick="editarProfissional('${p._id}')" style="margin-right:5px">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteProfissional('${p._id}')">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>`;
            }).join('');
            tbody.innerHTML=html;
        }else{
            tbody.innerHTML='<tr data-keep-visible="true"><td colspan="8" class="text-center text-muted">Nenhum</td></tr>';
        }
    }catch(e){
        console.error(e);
    } finally {
        setTimeout(() => setLoading(key, false), 1000);
    }
}

// Função para carregar lista de assistentes
async function loadAssistentes() {
    const key = 'loadAssistentes';
    if (isLoading(key)) {
        console.warn(`⚠️ Já carregando: ${key}`);
        return;
    }
    setLoading(key, true);

    try {
        const res = await fetch('/api/assistentes', {credentials: 'include'});
        const data = await res.json();
        const tbody = document.getElementById('assistentesBody');

        if (data.success && data.assistentes && data.assistentes.length > 0) {
            const html = data.assistentes.map(a => {
                const profissionalNome = a.profissional?.nome || 'Independente';
                return `<tr>
                    <td><strong>${a.nome}</strong></td>
                    <td>${a.cpf || '-'}</td>
                    <td>${profissionalNome}</td>
                    <td>10%</td>
                    <td><span class="badge ${a.ativo ? 'success' : 'danger'}">${a.ativo ? 'Ativo' : 'Inativo'}</span></td>
                    <td>
                        <button class="btn btn-sm btn-danger" onclick="deleteAssistente('${a._id}')">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>`;
            }).join('');
            tbody.innerHTML = html;
        } else {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Nenhum assistente cadastrado</td></tr>';
        }
    } catch(e) {
        console.error('Erro ao carregar assistentes:', e);
    } finally {
        setTimeout(() => setLoading(key, false), 1000);
    }
}

async function deleteAssistente(id) {
    const result = await Swal.fire({
        title: 'Deletar assistente?',
        icon: 'warning',
        showCancelButton: true
    });

    if (result.isConfirmed) {
        try {
            await fetch(`/api/assistentes/${id}`, {method: 'DELETE', credentials: 'include'});
            Swal.fire('Deletado!', '', 'success');
            loadAssistentes();
        } catch(e) {
            Swal.fire('Erro', '', 'error');
        }
    }

    // Limpeza de backdrop residual
    setTimeout(() => {
        document.querySelectorAll('.swal2-container, .swal2-backdrop-show').forEach(el => {
            if (!Swal.isVisible()) el.remove();
        });
        document.body.classList.remove('swal2-shown', 'swal2-height-auto');
    }, 100);
}

async function deleteProfissional(id){
    const result=await Swal.fire({title:'Deletar?',icon:'warning',showCancelButton:true});
    if(result.isConfirmed){
        try{
            await fetch(`/api/profissionais/${id}`,{method:'DELETE',credentials:'include'});
            Swal.fire('Deletado!','','success');
            loadProfissionais();
        }catch(e){
            Swal.fire('Erro','','error');
        }
    }

    // Limpeza de backdrop residual
    setTimeout(() => {
        document.querySelectorAll('.swal2-container, .swal2-backdrop-show').forEach(el => {
            if (!Swal.isVisible()) el.remove();
        });
        document.body.classList.remove('swal2-shown', 'swal2-height-auto');
    }, 100);
}

function showModalProfissional(){
    Swal.fire({
        title:'Novo Profissional',
        html:`<input type="text" id="swal-nome" class="form-control mb-3" placeholder="Nome"><input type="text" id="swal-cpf" class="form-control mb-3" placeholder="CPF"><input type="text" id="swal-espec" class="form-control mb-3" placeholder="Especialidade"><input type="number" id="swal-comissao" class="form-control" placeholder="Comissão %" value="10">`,
        showCancelButton:true,
        allowEscapeKey: true,
        allowOutsideClick: true,
        showCloseButton: true,
        preConfirm:()=>{
        const nome=document.getElementById('swal-nome').value;
        const cpf=document.getElementById('swal-cpf').value;
        if(!nome||!cpf){Swal.showValidationMessage('Nome e CPF obrigatórios');return false;}
        return {nome,cpf,especialidade:document.getElementById('swal-espec').value,comissao_perc:document.getElementById('swal-comissao').value};
    }}).then(async(result)=>{
        if(result.isConfirmed){
            try{
                await fetch('/api/profissionais',{method:'POST',headers:{'Content-Type':'application/json'},credentials:'include',body:JSON.stringify(result.value)});
                Swal.fire('Sucesso!','','success');
                loadProfissionais();
            }catch(e){
                Swal.fire('Erro','','error');
            }
        }
    });
}

// ========== CALENDÁRIO DE PROFISSIONAIS ====================

// Variável global para armazenar instância do calendário
let calendarioProfissionaisInstance = null;

// Paleta de cores para profissionais (12 cores vibrantes e distintas)
const CORES_PROFISSIONAIS = [
    '#7C3AED', // Roxo (primary)
    '#EC4899', // Rosa (secondary)
    '#10B981', // Verde
    '#F59E0B', // Laranja
    '#3B82F6', // Azul
    '#EF4444', // Vermelho
    '#8B5CF6', // Roxo claro
    '#14B8A6', // Teal
    '#F472B6', // Rosa claro
    '#FCD34D', // Amarelo
    '#60A5FA', // Azul claro
    '#34D399'  // Verde claro
];

// Função para obter cor de um profissional (hash determinístico)
function getCorProfissional(profissionalId, profissionais) {
    if (!profissionais) return CORES_PROFISSIONAIS[0];
    const index = profissionais.findIndex(p => p._id === profissionalId);
    return CORES_PROFISSIONAIS[index % CORES_PROFISSIONAIS.length];
}

// Função para inicializar o calendário
async function inicializarCalendario() {
    console.log('📅 Inicializando calendário de profissionais...');

    try {
        // Buscar profissionais para preencher filtro e legenda
        const resProfissionais = await fetch('/api/profissionais', {credentials: 'include'});
        const dataProfissionais = await resProfissionais.json();

        if (!dataProfissionais.success || !dataProfissionais.profissionais) {
            console.error('Erro ao carregar profissionais');
            return;
        }

        const profissionais = dataProfissionais.profissionais;

        // Preencher select de filtro
        const selectFiltro = document.getElementById('filtroCalendarioProfissional');
        if (selectFiltro) {
            const optionsHTML = profissionais.map(p =>
                `<option value="${p._id}">${p.nome} - ${p.especialidade || 'Profissional'}</option>`
            ).join('');
            selectFiltro.innerHTML = '<option value="">Todos os Profissionais</option>' + optionsHTML;
        }

        // Criar legenda de cores
        const legendaDiv = document.getElementById('legendaProfissionais');
        if (legendaDiv) {
            const legendaHTML = profissionais.map((p, index) => {
                const cor = CORES_PROFISSIONAIS[index % CORES_PROFISSIONAIS.length];
                return `<div style="display: flex; align-items: center; gap: 8px;">
                    <div style="width: 20px; height: 20px; background: ${cor}; border-radius: 5px; border: 2px solid #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.2);"></div>
                    <span style="font-size: 0.9rem;">${p.nome}</span>
                </div>`;
            }).join('');
            legendaDiv.innerHTML = legendaHTML;
        }

        // Inicializar FullCalendar
        const calendarEl = document.getElementById('calendarioProfissionais');
        if (!calendarEl) {
            console.error('Elemento do calendário não encontrado');
            return;
        }

        // Destruir calendário existente se houver
        if (calendarioProfissionaisInstance) {
            calendarioProfissionaisInstance.destroy();
        }

        // Criar nova instância do calendário
        calendarioProfissionaisInstance = new FullCalendar.Calendar(calendarEl, {
            locale: 'pt-br',
            initialView: 'dayGridMonth',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'
            },
            buttonText: {
                today: 'Hoje',
                month: 'Mês',
                week: 'Semana',
                day: 'Dia',
                list: 'Lista'
            },
            height: 'auto',
            navLinks: true,
            editable: true,
            selectable: true,
            selectMirror: true,
            dayMaxEvents: true,
            weekends: true,
            slotMinTime: '08:00:00',
            slotMaxTime: '20:00:00',
            allDaySlot: false,

            // Eventos customizados
            select: function(info) {
                novoAgendamentoRapido(info.startStr, info.endStr);
            },

            eventClick: function(info) {
                visualizarAgendamentoCalendario(info.event);
            },

            eventDrop: function(info) {
                atualizarDataAgendamento(info.event.id, info.event.start, info.event.end);
            },

            eventResize: function(info) {
                atualizarDataAgendamento(info.event.id, info.event.start, info.event.end);
            },

            // Carregar eventos
            events: async function(fetchInfo, successCallback, failureCallback) {
                try {
                    await carregarEventosCalendario(fetchInfo, successCallback, failureCallback, profissionais);
                } catch (error) {
                    console.error('Erro ao carregar eventos:', error);
                    failureCallback(error);
                }
            }
        });

        calendarioProfissionaisInstance.render();
        console.log('✅ Calendário inicializado com sucesso');

    } catch (error) {
        console.error('❌ Erro ao inicializar calendário:', error);
        Swal.fire({
            icon: 'error',
            title: 'Erro ao carregar calendário',
            text: 'Não foi possível inicializar o calendário. Tente recarregar a página.',
        });
    }
}

// Função para carregar eventos do calendário
async function carregarEventosCalendario(fetchInfo, successCallback, failureCallback, profissionais) {
    try {
        const filtroProf = document.getElementById('filtroCalendarioProfissional')?.value;

        // Buscar agendamentos
        const res = await fetch('/api/agendamentos', {credentials: 'include'});
        const data = await res.json();

        if (!data.success || !data.agendamentos) {
            successCallback([]);
            return;
        }

        // Filtrar por profissional se selecionado
        let agendamentos = data.agendamentos;
        if (filtroProf) {
            agendamentos = agendamentos.filter(a =>
                a.profissional_id === filtroProf ||
                a.profissional?._id === filtroProf
            );
        }

        // Converter agendamentos para eventos do FullCalendar
        const eventos = agendamentos.map(agendamento => {
            const profissionalId = agendamento.profissional_id || agendamento.profissional?._id;
            const profissionalNome = agendamento.profissional_nome || agendamento.profissional?.nome || 'Sem profissional';
            const cor = getCorProfissional(profissionalId, profissionais);

            // Criar data/hora do evento
            let start, end;
            if (agendamento.data && agendamento.horario) {
                // data format: "2025-10-27", horario: "14:30"
                start = `${agendamento.data}T${agendamento.horario}`;
                // Assumir 1 hora de duração padrão
                const startDate = new Date(start);
                const endDate = new Date(startDate.getTime() + 60 * 60 * 1000);
                end = endDate.toISOString().slice(0, 16);
            } else {
                start = agendamento.created_at;
                end = agendamento.created_at;
            }

            return {
                id: agendamento._id,
                title: `${profissionalNome} - ${agendamento.cliente_nome || 'Cliente'}`,
                start: start,
                end: end,
                backgroundColor: cor,
                borderColor: cor,
                extendedProps: {
                    cliente: agendamento.cliente_nome || 'Cliente não informado',
                    profissional: profissionalNome,
                    telefone: agendamento.telefone || '-',
                    observacoes: agendamento.observacoes || '-',
                    status: agendamento.status || 'Agendado'
                }
            };
        });

        successCallback(eventos);
    } catch (error) {
        console.error('Erro ao carregar eventos:', error);
        failureCallback(error);
    }
}

// Função para recarregar calendário (útil após filtrar)
function carregarCalendario() {
    if (calendarioProfissionaisInstance) {
        calendarioProfissionaisInstance.refetchEvents();
    } else {
        inicializarCalendario();
    }
}

// Função para criar novo agendamento rápido
function novoAgendamentoRapido(dataInicio, dataFim) {
    let dataDefault = '';
    let horaDefault = '';

    if (dataInicio) {
        const dt = new Date(dataInicio);
        dataDefault = dt.toISOString().split('T')[0];
        horaDefault = dt.toISOString().split('T')[1].substring(0, 5);
    }

    Swal.fire({
        title: '📅 Novo Agendamento',
        html: `
            <div style="text-align: left;">
                <div class="mb-3">
                    <label class="form-label">Cliente</label>
                    <input type="text" id="agend-cliente" class="form-control" placeholder="Nome do cliente">
                </div>
                <div class="mb-3">
                    <label class="form-label">Telefone</label>
                    <input type="text" id="agend-telefone" class="form-control" placeholder="(34) 99999-9999">
                </div>
                <div class="mb-3">
                    <label class="form-label">Profissional</label>
                    <select id="agend-profissional" class="form-select">
                        <option value="">Selecione um profissional</option>
                    </select>
                </div>
                <div class="row g-2">
                    <div class="col-md-6">
                        <label class="form-label">Data</label>
                        <input type="date" id="agend-data" class="form-control" value="${dataDefault}">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Horário</label>
                        <input type="time" id="agend-hora" class="form-control" value="${horaDefault}">
                    </div>
                </div>
                <div class="mb-3 mt-3">
                    <label class="form-label">Observações</label>
                    <textarea id="agend-obs" class="form-control" rows="2" placeholder="Observações opcionais"></textarea>
                </div>
            </div>
        `,
        width: '600px',
        showCancelButton: true,
        confirmButtonText: 'Agendar',
        cancelButtonText: 'Cancelar',
        didOpen: async () => {
            // Carregar profissionais no select
            try {
                const res = await fetch('/api/profissionais', {credentials: 'include'});
                const data = await res.json();
                if (data.success && data.profissionais) {
                    const select = document.getElementById('agend-profissional');
                    select.innerHTML = '<option value="">Selecione um profissional</option>' +
                        data.profissionais.map(p => `<option value="${p._id}">${p.nome} - ${p.especialidade || 'Profissional'}</option>`).join('');
                }
            } catch (e) {
                console.error('Erro ao carregar profissionais:', e);
            }
        },
        preConfirm: () => {
            const cliente = document.getElementById('agend-cliente').value;
            const telefone = document.getElementById('agend-telefone').value;
            const profissional = document.getElementById('agend-profissional').value;
            const data = document.getElementById('agend-data').value;
            const hora = document.getElementById('agend-hora').value;
            const obs = document.getElementById('agend-obs').value;

            if (!cliente || !data || !hora) {
                Swal.showValidationMessage('Preencha cliente, data e horário');
                return false;
            }

            return { cliente, telefone, profissional, data, hora, obs };
        }
    }).then(async (result) => {
        if (result.isConfirmed) {
            try {
                const payload = {
                    cliente_nome: result.value.cliente,
                    telefone: result.value.telefone,
                    profissional_id: result.value.profissional,
                    data: result.value.data,
                    horario: result.value.hora,
                    observacoes: result.value.obs,
                    status: 'Agendado'
                };

                const response = await fetch('/api/agendamentos', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    credentials: 'include',
                    body: JSON.stringify(payload)
                });

                const data = await response.json();

                if (data.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Agendamento Criado!',
                        text: `${result.value.cliente} agendado para ${result.value.data} às ${result.value.hora}`,
                        timer: 2500
                    });
                    carregarCalendario();
                } else {
                    throw new Error(data.message || 'Erro ao criar agendamento');
                }
            } catch (error) {
                console.error('Erro ao criar agendamento:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Erro',
                    text: error.message || 'Não foi possível criar o agendamento'
                });
            }
        }
    });
}

// Função para visualizar agendamento clicado no calendário
function visualizarAgendamentoCalendario(event) {
    const props = event.extendedProps;

    Swal.fire({
        title: '📋 Detalhes do Agendamento',
        html: `
            <div style="text-align: left; padding: 20px;">
                <p><strong>Cliente:</strong> ${props.cliente}</p>
                <p><strong>Profissional:</strong> ${props.profissional}</p>
                <p><strong>Telefone:</strong> ${props.telefone}</p>
                <p><strong>Data/Hora:</strong> ${event.start.toLocaleString('pt-BR')}</p>
                <p><strong>Status:</strong> <span class="badge success">${props.status}</span></p>
                <p><strong>Observações:</strong> ${props.observacoes}</p>
            </div>
        `,
        showCancelButton: true,
        confirmButtonText: 'Cancelar Agendamento',
        confirmButtonColor: '#EF4444',
        cancelButtonText: 'Fechar'
    }).then(async (result) => {
        if (result.isConfirmed) {
            // Cancelar agendamento
            try {
                await fetch(`/api/agendamentos/${event.id}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                Swal.fire('Cancelado!', 'Agendamento cancelado com sucesso', 'success');
                carregarCalendario();
            } catch (error) {
                Swal.fire('Erro', 'Não foi possível cancelar o agendamento', 'error');
            }
        }
    });
}

// Função para atualizar data de agendamento (drag & drop)
async function atualizarDataAgendamento(agendamentoId, novaData, novaDataFim) {
    try {
        const data = novaData.toISOString().split('T')[0];
        const hora = novaData.toISOString().split('T')[1].substring(0, 5);

        const response = await fetch(`/api/agendamentos/${agendamentoId}`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            credentials: 'include',
            body: JSON.stringify({ data, horario: hora })
        });

        const result = await response.json();

        if (result.success) {
            toast('✅ Agendamento atualizado', 'success');
        } else {
            throw new Error(result.message);
        }
    } catch (error) {
        console.error('Erro ao atualizar agendamento:', error);
        toast('❌ Erro ao atualizar', 'error');
        carregarCalendario(); // Recarregar para desfazer mudança visual
    }
}

// Função para voltar ao dia de hoje
function calendarioHoje() {
    if (calendarioProfissionaisInstance) {
        calendarioProfissionaisInstance.today();
    }
}

// Função para alterar visualização do calendário
function alterarVisualizacaoCalendario() {
    const visualizacao = document.getElementById('visualizacaoCalendario')?.value;
    if (calendarioProfissionaisInstance && visualizacao) {
        calendarioProfissionaisInstance.changeView(visualizacao);
    }
}

// Hook: Inicializar calendário quando sub-tab for ativada
// Será chamado pela função showSubTab
document.addEventListener('DOMContentLoaded', function() {
    // Adicionar listener para detectar quando sub-tab de calendário é ativada
    const btnCalendario = document.querySelector('[onclick*="profissionais"][onclick*="calendario"]');
    if (btnCalendario) {
        btnCalendario.addEventListener('click', function() {
            setTimeout(() => {
                if (!calendarioProfissionaisInstance) {
                    inicializarCalendario();
                }
            }, 300);
        });
    }
});

// ========== FIM CALENDÁRIO DE PROFISSIONAIS ====================

async function loadServicosLista(){
    const key = 'loadServicosLista';
    if (isLoading(key)) {
        console.warn(`⚠️ Já carregando: ${key}`);
        return;
    }
    setLoading(key, true);

    try{
        const res=await fetch('/api/servicos',{credentials:'include'});
        const data=await res.json();

        // Atualizar TODOS os tbody de serviços
        const tbodies = [
            document.getElementById('servicosTodosBody'),
            document.getElementById('servicosAtivosBody'),
            document.getElementById('servicosInativosBody')
        ];

        if(data.success&&data.servicos&&data.servicos.length>0){
            servicosDisponiveis = data.servicos;

            // Todos os serviços
            if(tbodies[0]){
                const htmlTodos=data.servicos.map(s=>`<tr data-id="${s._id}"><td><strong>${s.nome}</strong></td><td>${s.categoria}</td><td>${s.tamanho}</td><td><strong>R$ ${s.preco.toFixed(2)}</strong></td><td><span class="badge ${s.ativo?'success':'danger'}">${s.ativo?'Ativo':'Inativo'}</span></td><td><button class="btn btn-sm btn-danger" onclick="deleteServico('${s._id}')"><i class="bi bi-trash"></i></button></td></tr>`).join('');
                tbodies[0].innerHTML=htmlTodos;
            }

            // Serviços ativos
            if(tbodies[1]){
                const ativos = data.servicos.filter(s => s.ativo);
                const htmlAtivos = ativos.length > 0 ? ativos.map(s=>`<tr data-id="${s._id}"><td><strong>${s.nome}</strong></td><td>${s.categoria}</td><td>${s.tamanho}</td><td><strong>R$ ${s.preco.toFixed(2)}</strong></td><td><button class="btn btn-sm btn-danger" onclick="deleteServico('${s._id}')"><i class="bi bi-trash"></i></button></td></tr>`).join('') : '<tr data-keep-visible="true"><td colspan="5" class="text-center text-muted">Nenhum serviço ativo</td></tr>';
                tbodies[1].innerHTML=htmlAtivos;
            }

            // Serviços inativos
            if(tbodies[2]){
                const inativos = data.servicos.filter(s => !s.ativo);
                const htmlInativos = inativos.length > 0 ? inativos.map(s=>`<tr data-id="${s._id}"><td><strong>${s.nome}</strong></td><td>${s.categoria}</td><td>${s.tamanho}</td><td><strong>R$ ${s.preco.toFixed(2)}</strong></td><td><button class="btn btn-sm btn-success" onclick="ativarServico('${s._id}')"><i class="bi bi-check-circle"></i> Ativar</button></td></tr>`).join('') : '<tr data-keep-visible="true"><td colspan="5" class="text-center text-muted">Nenhum serviço inativo</td></tr>';
                tbodies[2].innerHTML=htmlInativos;
            }
        }else{
            tbodies.forEach(tb => {
                if(tb) tb.innerHTML='<tr data-keep-visible="true"><td colspan="6" class="text-center text-muted">Nenhum serviço cadastrado</td></tr>';
            });
        }
    }catch(e){
        console.error('❌ Erro ao carregar serviços:', e);
    } finally {
        setTimeout(() => setLoading(key, false), 1000);
    }
}

async function deleteServico(id){
    const result=await Swal.fire({title:'Deletar?',icon:'warning',showCancelButton:true});
    if(result.isConfirmed){
        try{
            await fetch(`/api/servicos/${id}`,{method:'DELETE',credentials:'include'});
            Swal.fire('Deletado!','','success');
            loadServicosLista();
        }catch(e){
            Swal.fire('Erro','','error');
        }
    }
}

async function visualizarProfissional(id){
    try{
        const res=await fetch(`/api/profissionais/${id}`,{credentials:'include'});
        const data=await res.json();
        if(data.success&&data.profissional){
            const p=data.profissional;
            Swal.fire({
                title:`<strong>👨‍💼 ${p.nome}</strong>`,
                html:`<div style="text-align:left"><div style="background:linear-gradient(135deg,#7C3AED,#EC4899);color:#fff;padding:20px;border-radius:15px;margin-bottom:20px"><p style="margin:5px 0"><strong>CPF:</strong> ${p.cpf}</p>${p.especialidade?`<p style="margin:5px 0"><strong>Especialidade:</strong> ${p.especialidade}</p>`:''}${p.telefone?`<p style="margin:5px 0"><strong>Telefone:</strong> ${p.telefone}</p>`:''}</div><div style="background:#f3f4f6;padding:15px;border-radius:10px"><p><strong>💰 Comissão:</strong> <span style="color:#7C3AED;font-size:1.3rem">${p.comissao_perc}%</span></p><p><strong>📊 Status:</strong> <span class="badge ${p.ativo?'success':'danger'}">${p.ativo?'ATIVO':'INATIVO'}</span></p></div><p style="margin-top:15px;font-size:0.85rem;color:#6B7280">Cadastrado em: ${new Date(p.created_at).toLocaleString('pt-BR')}</p></div>`,
                width:'600px',
                confirmButtonText:'Fechar',
                confirmButtonColor:'#7C3AED',
                allowEscapeKey: true,
                allowOutsideClick: true,
                showCloseButton: true,
                focusConfirm: true
            });
        }
    }catch(e){
        Swal.fire('Erro','Não foi possível carregar os detalhes','error');
    }
}

async function editarProfissional(id){
    try{
        const res=await fetch(`/api/profissionais/${id}`,{credentials:'include'});
        const data=await res.json();
        if(data.success&&data.profissional){
            const p=data.profissional;
            Swal.fire({
                title:'Editar Profissional',
                html:`<input type="text" id="swal-nome" class="form-control mb-3" placeholder="Nome" value="${p.nome}"><input type="text" id="swal-cpf" class="form-control mb-3" placeholder="CPF" value="${p.cpf}"><input type="text" id="swal-espec" class="form-control mb-3" placeholder="Especialidade" value="${p.especialidade||''}"><input type="number" id="swal-comissao" class="form-control mb-3" placeholder="Comissão %" value="${p.comissao_perc}"><select id="swal-ativo" class="form-select"><option value="true" ${p.ativo?'selected':''}>Ativo</option><option value="false" ${!p.ativo?'selected':''}>Inativo</option></select>`,
                showCancelButton:true,
                confirmButtonText:'Salvar',
                cancelButtonText:'Cancelar',
                allowEscapeKey: true,
                allowOutsideClick: true,
                showCloseButton: true,
                preConfirm:()=>{
                const nome=document.getElementById('swal-nome').value;
                const cpf=document.getElementById('swal-cpf').value;
                if(!nome||!cpf){Swal.showValidationMessage('Nome e CPF obrigatórios');return false;}
                return {nome,cpf,especialidade:document.getElementById('swal-espec').value,comissao_perc:document.getElementById('swal-comissao').value,ativo:document.getElementById('swal-ativo').value==='true'};
            }}).then(async(result)=>{
                if(result.isConfirmed){
                    try{
                        await fetch(`/api/profissionais/${id}`,{method:'PUT',headers:{'Content-Type':'application/json'},credentials:'include',body:JSON.stringify(result.value)});
                        Swal.fire('Sucesso!','Profissional atualizado','success');
                        loadProfissionais();
                    }catch(e){
                        Swal.fire('Erro','Não foi possível atualizar','error');
                    }
                }
            });
        }
    }catch(e){
        Swal.fire('Erro','Não foi possível carregar para edição','error');
    }
}

function showModalServico(){
    Swal.fire({
        title:'Novo Serviço',
        html:`<input type="text" id="swal-nome" class="form-control mb-3" placeholder="Nome"><div class="row"><div class="col-6"><input type="number" id="swal-kids" class="form-control mb-2" placeholder="Kids" step="0.01"><input type="number" id="swal-masc" class="form-control mb-2" placeholder="Masculino" step="0.01"><input type="number" id="swal-curto" class="form-control" placeholder="Curto" step="0.01"></div><div class="col-6"><input type="number" id="swal-medio" class="form-control mb-2" placeholder="Médio" step="0.01"><input type="number" id="swal-longo" class="form-control mb-2" placeholder="Longo" step="0.01"><input type="number" id="swal-xl" class="form-control" placeholder="XL" step="0.01"></div></div>`,
        showCancelButton:true,
        width:'600px',
        allowEscapeKey: true,
        allowOutsideClick: true,
        showCloseButton: true,
        preConfirm:()=>{
        const nome=document.getElementById('swal-nome').value;
        if(!nome){Swal.showValidationMessage('Nome obrigatório');return false;}
        return {nome,preco_kids:document.getElementById('swal-kids').value||0,preco_masculino:document.getElementById('swal-masc').value||0,preco_curto:document.getElementById('swal-curto').value||0,preco_medio:document.getElementById('swal-medio').value||0,preco_longo:document.getElementById('swal-longo').value||0,preco_extra_longo:document.getElementById('swal-xl').value||0};
    }}).then(async(result)=>{
        if(result.isConfirmed){
            try{
                const res=await fetch('/api/servicos',{method:'POST',headers:{'Content-Type':'application/json'},credentials:'include',body:JSON.stringify(result.value)});
                const data=await res.json();
                if(data.success){
                    Swal.fire('Sucesso!',`${data.count} SKUs criados`,'success');
                    loadServicosLista();
                }
            }catch(e){
                Swal.fire('Erro','','error');
            }
        }
    });
}

// Função para ativar todos os serviços
async function ativarTodosServicos() {
    const result = await SafeSwal.fire({
        title: 'Ativar Todos os Serviços?',
        text: 'Esta ação irá ativar todos os serviços cadastrados no sistema.',
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#10B981',
        cancelButtonColor: '#6c757d',
        confirmButtonText: '<i class="bi bi-check-circle-fill"></i> Sim, Ativar Todos',
        cancelButtonText: 'Cancelar'
    });

    if (result.isConfirmed) {
        try {
            const res = await fetch('/api/servicos/toggle-todos', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({ ativo: true })
            });
            const data = await res.json();

            if (data.success) {
                toast(`✅ ${data.count} serviços ativados com sucesso!`, 'success');
                loadServicosLista();
            } else {
                toast(`❌ ${data.message || 'Não foi possível ativar os serviços'}`, 'error');
            }
        } catch (e) {
            console.error('Erro ao ativar serviços:', e);
            toast('❌ Falha ao ativar serviços', 'error');
        }
    }

    // Limpeza de backdrop residual
    setTimeout(() => {
        document.querySelectorAll('.swal2-container, .swal2-backdrop-show').forEach(el => {
            if (!Swal.isVisible()) el.remove();
        });
        document.body.classList.remove('swal2-shown', 'swal2-height-auto');
    }, 100);
}

// Função para desativar todos os serviços
async function desativarTodosServicos() {
    const result = await SafeSwal.fire({
        title: 'Desativar Todos os Serviços?',
        text: 'Esta ação irá desativar todos os serviços cadastrados no sistema.',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#EF4444',
        cancelButtonColor: '#6c757d',
        confirmButtonText: '<i class="bi bi-x-circle-fill"></i> Sim, Desativar Todos',
        cancelButtonText: 'Cancelar'
    });

    if (result.isConfirmed) {
        try {
            const res = await fetch('/api/servicos/toggle-todos', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({ ativo: false })
            });
            const data = await res.json();

            if (data.success) {
                toast(`✅ ${data.count} serviços desativados com sucesso!`, 'success');
                loadServicosLista();
            } else {
                toast(`❌ ${data.message || 'Não foi possível desativar os serviços'}`, 'error');
            }
        } catch (e) {
            console.error('Erro ao desativar serviços:', e);
            toast('❌ Falha ao desativar serviços', 'error');
        }
    }

    // Limpeza de backdrop residual
    setTimeout(() => {
        document.querySelectorAll('.swal2-container, .swal2-backdrop-show').forEach(el => {
            if (!Swal.isVisible()) el.remove();
        });
        document.body.classList.remove('swal2-shown', 'swal2-height-auto');
    }, 100);
}

async function loadProdutosLista(){
    const key = 'loadProdutosLista';
    if (isLoading(key)) {
        console.warn(`⚠️ Já carregando: ${key}`);
        return;
    }
    setLoading(key, true);

    try{
        const res=await fetch('/api/produtos',{credentials:'include'});
        const data=await res.json();

        // Atualizar TODOS os tbody de produtos
        const tbodies = [
            document.getElementById('produtosTodosBody'),
            document.getElementById('produtosAtivosBody'),
            document.getElementById('produtosInativosBody')
        ];

        if(data.success&&data.produtos&&data.produtos.length>0){
            produtosDisponiveis = data.produtos;
            produtosCache = data.produtos;

            // Todos os produtos
            if(tbodies[0]){
                const htmlTodos=data.produtos.map(p=>`<tr data-id="${p._id}"><td><strong>${p.nome}</strong></td><td>${p.marca||'-'}</td><td><strong>R$ ${p.preco.toFixed(2)}</strong></td><td><span class="badge ${p.estoque<=p.estoque_minimo?'danger':'success'}">${p.estoque||0}</span></td><td><span class="badge ${p.ativo?'success':'danger'}">${p.ativo?'Ativo':'Inativo'}</span></td><td><button class="btn btn-sm btn-danger" onclick="deleteProduto('${p._id}')"><i class="bi bi-trash"></i></button></td></tr>`).join('');
                tbodies[0].innerHTML=htmlTodos;
            }

            // Produtos ativos
            if(tbodies[1]){
                const ativos = data.produtos.filter(p => p.ativo);
                const htmlAtivos = ativos.length > 0 ? ativos.map(p=>`<tr data-id="${p._id}"><td><strong>${p.nome}</strong></td><td>${p.marca||'-'}</td><td><strong>R$ ${p.preco.toFixed(2)}</strong></td><td><span class="badge ${p.estoque<=p.estoque_minimo?'danger':'success'}">${p.estoque||0}</span></td><td><button class="btn btn-sm btn-danger" onclick="deleteProduto('${p._id}')"><i class="bi bi-trash"></i></button></td></tr>`).join('') : '<tr data-keep-visible="true"><td colspan="5" class="text-center text-muted">Nenhum produto ativo</td></tr>';
                tbodies[1].innerHTML=htmlAtivos;
            }

            // Produtos inativos
            if(tbodies[2]){
                const inativos = data.produtos.filter(p => !p.ativo);
                const htmlInativos = inativos.length > 0 ? inativos.map(p=>`<tr data-id="${p._id}"><td><strong>${p.nome}</strong></td><td>${p.marca||'-'}</td><td><strong>R$ ${p.preco.toFixed(2)}</strong></td><td><span class="badge danger">${p.estoque||0}</span></td><td><button class="btn btn-sm btn-success" onclick="ativarProduto('${p._id}')"><i class="bi bi-check-circle"></i> Ativar</button></td></tr>`).join('') : '<tr data-keep-visible="true"><td colspan="5" class="text-center text-muted">Nenhum produto inativo</td></tr>';
                tbodies[2].innerHTML=htmlInativos;
            }
        }else{
            tbodies.forEach(tb => {
                if(tb) tb.innerHTML='<tr data-keep-visible="true"><td colspan="6" class="text-center text-muted">Nenhum produto cadastrado</td></tr>';
            });
        }
    }catch(e){
        console.error('❌ Erro ao carregar produtos:', e);
    } finally {
        setTimeout(() => setLoading(key, false), 1000);
    }
}

async function deleteProduto(id){
    const result=await Swal.fire({title:'Deletar?',icon:'warning',showCancelButton:true});
    if(result.isConfirmed){
        try{
            await fetch(`/api/produtos/${id}`,{method:'DELETE',credentials:'include'});
            Swal.fire('Deletado!','','success');
            loadProdutosLista();
        }catch(e){
            Swal.fire('Erro','','error');
        }
    }

    // Limpeza de backdrop residual
    setTimeout(() => {
        document.querySelectorAll('.swal2-container, .swal2-backdrop-show').forEach(el => {
            if (!Swal.isVisible()) el.remove();
        });
        document.body.classList.remove('swal2-shown', 'swal2-height-auto');
    }, 100);
}

function showModalProduto(){
    Swal.fire({
        title:'Novo Produto',
        html:`<input type="text" id="swal-nome" class="form-control mb-3" placeholder="Nome"><input type="text" id="swal-marca" class="form-control mb-3" placeholder="Marca"><input type="number" id="swal-preco" class="form-control mb-3" placeholder="Preço" step="0.01"><input type="number" id="swal-estoque" class="form-control" placeholder="Estoque" value="0">`,
        showCancelButton:true,
        allowEscapeKey: true,
        allowOutsideClick: true,
        showCloseButton: true,
        preConfirm:()=>{
        const nome=document.getElementById('swal-nome').value;
        const preco=document.getElementById('swal-preco').value;
        if(!nome||!preco){Swal.showValidationMessage('Nome e Preço obrigatórios');return false;}
        return {nome,marca:document.getElementById('swal-marca').value,preco,estoque:document.getElementById('swal-estoque').value};
    }}).then(async(result)=>{
        if(result.isConfirmed){
            try{
                await fetch('/api/produtos',{method:'POST',headers:{'Content-Type':'application/json'},credentials:'include',body:JSON.stringify(result.value)});
                Swal.fire('Sucesso!','','success');
                loadProdutosLista();
            }catch(e){
                Swal.fire('Erro','','error');
            }
        }
    });
}

// Função para ativar todos os produtos
async function ativarTodosProdutos() {
    const result = await SafeSwal.fire({
        title: 'Ativar Todos os Produtos?',
        text: 'Esta ação irá ativar todos os produtos cadastrados no sistema.',
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#10B981',
        cancelButtonColor: '#6c757d',
        confirmButtonText: '<i class="bi bi-check-circle-fill"></i> Sim, Ativar Todos',
        cancelButtonText: 'Cancelar'
    });

    if (result.isConfirmed) {
        try {
            const res = await fetch('/api/produtos/toggle-todos', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({ ativo: true })
            });
            const data = await res.json();

            if (data.success) {
                toast(`✅ ${data.count} produtos ativados com sucesso!`, 'success');
                loadProdutosLista();
            } else {
                toast(`❌ ${data.message || 'Não foi possível ativar os produtos'}`, 'error');
            }
        } catch (e) {
            console.error('Erro ao ativar produtos:', e);
            toast('❌ Falha ao ativar produtos', 'error');
        }
    }

    // Limpeza de backdrop residual
    setTimeout(() => {
        document.querySelectorAll('.swal2-container, .swal2-backdrop-show').forEach(el => {
            if (!Swal.isVisible()) el.remove();
        });
        document.body.classList.remove('swal2-shown', 'swal2-height-auto');
    }, 100);
}

// Função para desativar todos os produtos
async function desativarTodosProdutos() {
    const result = await SafeSwal.fire({
        title: 'Desativar Todos os Produtos?',
        text: 'Esta ação irá desativar todos os produtos cadastrados no sistema.',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#EF4444',
        cancelButtonColor: '#6c757d',
        confirmButtonText: '<i class="bi bi-x-circle-fill"></i> Sim, Desativar Todos',
        cancelButtonText: 'Cancelar'
    });

    if (result.isConfirmed) {
        try {
            const res = await fetch('/api/produtos/toggle-todos', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({ ativo: false })
            });
            const data = await res.json();

            if (data.success) {
                toast(`✅ ${data.count} produtos desativados com sucesso!`, 'success');
                loadProdutosLista();
            } else {
                toast(`❌ ${data.message || 'Não foi possível desativar os produtos'}`, 'error');
            }
        } catch (e) {
            console.error('Erro ao desativar produtos:', e);
            toast('❌ Falha ao desativar produtos', 'error');
        }
    }

    // Limpeza de backdrop residual
    setTimeout(() => {
        document.querySelectorAll('.swal2-container, .swal2-backdrop-show').forEach(el => {
            if (!Swal.isVisible()) el.remove();
        });
        document.body.classList.remove('swal2-shown', 'swal2-height-auto');
    }, 100);
}

// Global variable to store all budgets for filtering
let todosOrcamentos = [];

async function loadConsultar(){
    const key = 'loadConsultar';
    if (isLoading(key)) {
        console.warn(`⚠️ Já carregando: ${key}`);
        return;
    }
    setLoading(key, true);

    try{
        const res=await fetch('/api/orcamentos',{credentials:'include'});
        const data=await res.json();
        if(data.success&&data.orcamentos&&data.orcamentos.length>0){
            todosOrcamentos = data.orcamentos; // Store all budgets
            filtrarOrcamentos(); // Apply filters
        }else{
            todosOrcamentos = [];
            const tbody=document.getElementById('consultaBody');
            tbody.innerHTML='<tr><td colspan="6" class="text-center text-muted">Nenhum orçamento encontrado</td></tr>';
            document.getElementById('consultaResultCount').textContent = '0 orçamentos encontrados';
        }
    }catch(e){
        console.error(e);
        todosOrcamentos = [];
        const tbody=document.getElementById('consultaBody');
        tbody.innerHTML='<tr><td colspan="6" class="text-center text-danger">Erro ao carregar orçamentos</td></tr>';
    } finally {
        setTimeout(() => setLoading(key, false), 1000);
    }
}

function filtrarOrcamentos(){
    const searchTerm = document.getElementById('consultaSearch').value.toLowerCase();
    const statusFilter = document.getElementById('consultaStatusFilter').value;
    const dataInicio = document.getElementById('consultaDataInicio').value;
    const dataFim = document.getElementById('consultaDataFim').value;

    let filtrados = todosOrcamentos;

    // Apply search filter
    if(searchTerm){
        filtrados = filtrados.filter(o => {
            const numero = String(o.numero).toLowerCase();
            const cliente = (o.cliente_nome || '').toLowerCase();
            return numero.includes(searchTerm) || cliente.includes(searchTerm);
        });
    }

    // Apply status filter
    if(statusFilter){
        filtrados = filtrados.filter(o => o.status === statusFilter);
    }

    // Apply date range filter
    if(dataInicio){
        const dataInicioDate = new Date(dataInicio);
        filtrados = filtrados.filter(o => {
            const orcamentoDate = new Date(o.created_at);
            return orcamentoDate >= dataInicioDate;
        });
    }

    if(dataFim){
        const dataFimDate = new Date(dataFim);
        dataFimDate.setHours(23, 59, 59, 999); // Include entire day
        filtrados = filtrados.filter(o => {
            const orcamentoDate = new Date(o.created_at);
            return orcamentoDate <= dataFimDate;
        });
    }

    // Render filtered results
    const tbody = document.getElementById('consultaBody');
    if(filtrados.length > 0){
        const html = filtrados.map(o => {
            const statusClass = o.status === 'Aprovado' ? 'success' : (o.status === 'Cancelado' ? 'danger' : 'warning');
            return `<tr><td><strong>#${o.numero}</strong></td><td>${new Date(o.created_at).toLocaleDateString('pt-BR')}</td><td>${o.cliente_nome}</td><td><strong>R$ ${o.total_final.toFixed(2)}</strong></td><td><span class="badge ${statusClass}">${o.status}</span></td><td><button class="btn btn-sm btn-info" onclick="visualizarOrcamento('${o._id}')" style="background:linear-gradient(135deg,#3B82F6,#2563EB);color:#fff;margin-right:5px"><i class="bi bi-eye"></i></button><button class="btn btn-sm btn-primary" onclick="editarOrcamento('${o._id}')" style="margin-right:5px"><i class="bi bi-pencil"></i></button><button class="btn btn-sm btn-danger" onclick="deleteOrcamento('${o._id}')"><i class="bi bi-trash"></i></button></td></tr>`;
        }).join('');
        tbody.innerHTML = html;
    }else{
        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Nenhum orçamento encontrado com os filtros aplicados</td></tr>';
    }

    // Update result count
    document.getElementById('consultaResultCount').textContent =
        `${filtrados.length} de ${todosOrcamentos.length} orçamentos encontrados`;
}

function limparFiltrosOrcamentos(){
    document.getElementById('consultaSearch').value = '';
    document.getElementById('consultaStatusFilter').value = '';
    document.getElementById('consultaDataInicio').value = '';
    document.getElementById('consultaDataFim').value = '';
    filtrarOrcamentos();
}

async function deleteOrcamento(id){
    const result=await Swal.fire({title:'Deletar?',icon:'warning',showCancelButton:true});
    if(result.isConfirmed){
        try{
            await fetch(`/api/orcamentos/${id}`,{method:'DELETE',credentials:'include'});
            Swal.fire('Deletado!','','success');
            loadConsultar();
        }catch(e){
            Swal.fire('Erro','','error');
        }
    }
}

async function loadContratos(){
    const key = 'loadContratos';
    if (isLoading(key)) {
        console.warn(`⚠️ Já carregando: ${key}`);
        return;
    }
    setLoading(key, true);

    try{
        const res=await fetch('/api/contratos',{credentials:'include'});
        const data=await res.json();
        const tbody=document.getElementById('contratosBody');
        if(data.success&&data.contratos&&data.contratos.length>0){
            const html=data.contratos.map(c=>{
                const dataFormatada = new Date(c.created_at).toLocaleDateString('pt-BR');
                return `<tr>
                    <td><strong style="color: var(--primary); font-size: 1.1rem;">#${c.numero}</strong></td>
                    <td>${dataFormatada}</td>
                    <td><strong>${c.cliente_nome}</strong></td>
                    <td><strong style="color: var(--success); font-size: 1.1rem;">R$ ${c.total_final.toFixed(2)}</strong></td>
                    <td><span class="badge success">APROVADO</span></td>
                    <td>
                        <button class="btn btn-sm" onclick="visualizarOrcamento('${c._id}')" style="background:linear-gradient(135deg,#3B82F6,#2563EB);color:#fff;margin-right:5px" title="Visualizar Detalhes">
                            <i class="bi bi-eye"></i>
                        </button>
                        <a href="/api/orcamento/${c._id}/pdf" target="_blank" class="btn btn-sm btn-danger" style="margin-right:5px" title="Gerar PDF">
                            <i class="bi bi-file-pdf"></i>
                        </a>
                        <button class="btn btn-sm" onclick="enviarContratoEmail('${c._id}')" style="background:linear-gradient(135deg,#10B981,#059669);color:#fff;margin-right:5px" title="Enviar por Email">
                            <i class="bi bi-envelope-fill"></i>
                        </button>
                        <button class="btn btn-sm" onclick="enviarContratoWhatsApp('${c._id}')" style="background:linear-gradient(135deg,#25D366,#128C7E);color:#fff" title="Enviar por WhatsApp">
                            <i class="bi bi-whatsapp"></i>
                        </button>
                    </td>
                </tr>`;
            }).join('');
            tbody.innerHTML=html;
        }else{
            tbody.innerHTML='<tr><td colspan="6" class="text-center text-muted"><i class="bi bi-inbox" style="font-size: 3rem; opacity: 0.3;"></i><br>Nenhum contrato aprovado ainda</td></tr>';
        }
    }catch(e){
        console.error('❌ Erro ao carregar contratos:',e);
        Swal.fire('Erro','Não foi possível carregar os contratos','error');
    } finally {
        setTimeout(() => setLoading(key, false), 1000);
    }
}

// ========== FUNÇÕES DE ENVIO DE CONTRATOS ==========

/**
 * Enviar contrato via WhatsApp
 */
async function enviarContratoWhatsApp(contratoId) {
    try {
        // Buscar dados do contrato
        const res = await fetch(`/api/orcamento/${contratoId}`, {credentials: 'include'});
        const data = await res.json();

        if(!data.success) {
            throw new Error(data.message || 'Erro ao buscar contrato');
        }

        const contrato = data.orcamento;

        // Buscar dados do cliente para telefone
        const clienteRes = await fetch(`/api/cliente/${contrato.cliente_id}`, {credentials: 'include'});
        const clienteData = await clienteRes.json();

        if(!clienteData.success || !clienteData.cliente.telefone) {
            Swal.fire({
                icon: 'warning',
                title: 'Cliente sem telefone',
                text: 'Este cliente não possui telefone cadastrado',
                confirmButtonText: 'OK'
            });
            return;
        }

        const telefone = clienteData.cliente.telefone.replace(/\D/g, ''); // Remove formatação

        // Montar mensagem
        const dataFormatada = new Date(contrato.created_at).toLocaleDateString('pt-BR');
        const mensagem = `
🌳 *BIOMA Uberaba - Contrato #${contrato.numero}*

Olá, ${contrato.cliente_nome}!

Seu contrato foi aprovado! ✅

📊 *Valor Total:* R$ ${contrato.total_final.toFixed(2)}
📅 *Data:* ${dataFormatada}
💳 *Pagamento:* ${contrato.forma_pagamento || 'Crédito à Vista'}

🔗 *Visualizar PDF:*
${window.location.origin}/api/orcamento/${contratoId}/pdf

Obrigado pela preferência! 🌿
_Equipe BIOMA Uberaba_
        `.trim();

        // Abrir WhatsApp
        const url = `https://wa.me/55${telefone}?text=${encodeURIComponent(mensagem)}`;
        window.open(url, '_blank');

        console.log('✅ WhatsApp aberto com sucesso');

    } catch(error) {
        console.error('❌ Erro ao enviar WhatsApp:', error);
        Swal.fire({
            icon: 'error',
            title: 'Erro ao abrir WhatsApp',
            text: error.message || 'Não foi possível enviar pelo WhatsApp',
            confirmButtonText: 'OK'
        });
    }
}

/**
 * Enviar contrato via Email
 */
async function enviarContratoEmail(contratoId) {
    try {
        // Show loading modal
        Swal.fire({
            title: 'Enviando E-mail...',
            html: '<div class="spinner"></div><p style="margin-top:20px">Aguarde enquanto enviamos o contrato...</p>',
            allowOutsideClick: false,
            showConfirmButton: false
        });

        const res = await fetch(`/api/orcamento/${contratoId}/enviar-email`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            credentials: 'include'
        });

        const data = await res.json();

        // IMPORTANT: Close loading modal before showing result
        Swal.close();

        if(data.success) {
            Swal.fire({
                icon: 'success',
                title: 'E-mail Enviado!',
                html: `
                    <p>Contrato enviado com sucesso para:</p>
                    <p style="font-weight:700;color:var(--primary);font-size:1.1rem">${data.destinatario || 'cliente'}</p>
                `,
                timer: 4000,
                timerProgressBar: true,
                showConfirmButton: true,
                confirmButtonText: 'OK'
            });
        } else {
            throw new Error(data.message || 'Erro ao enviar e-mail');
        }
    } catch(error) {
        console.error('❌ Erro ao enviar email:', error);

        // CRITICAL: Always close loading modal on error
        Swal.close();

        // Then show error
        Swal.fire({
            icon: 'error',
            title: 'Erro ao Enviar E-mail',
            text: error.message || 'Não foi possível enviar o e-mail. Verifique as configurações SMTP.',
            confirmButtonText: 'OK'
        });
    }
}

async function loadComissoes(){
    const key = 'loadComissoes';
    if (isLoading(key)) {
        console.warn(`⚠️ Já carregando: ${key}`);
        return;
    }
    setLoading(key, true);

    console.log('💰 Carregando histórico de comissões...');

    // Carregar também gráficos e top performers em paralelo
    loadComissoesChart();
    loadTopPerformers();

    try{
        const res = await fetch('/api/comissoes', {credentials: 'include'});
        const data = await res.json();
        const tbody = document.getElementById('comissoesBody');

        if(!tbody){
            console.error('❌ #comissoesBody não encontrado');
            setLoading(key, false);
            return;
        }

        // A API retorna histórico de comissões, não regras
        if(data.success && data.comissoes && data.comissoes.length > 0){
            const html = data.comissoes.map(c => `
                <tr>
                    <td><strong>${c.profissional_nome}</strong></td>
                    <td>${c.cliente_nome}</td>
                    <td>#${c.orcamento_numero}</td>
                    <td><strong style="color: var(--success);">R$ ${c.comissao_valor.toFixed(2)}</strong></td>
                    <td>${new Date(c.data_registro).toLocaleDateString('pt-BR')}</td>
                </tr>
            `).join('');
            tbody.innerHTML = html;
            console.log(`✅ ${data.comissoes.length} comissões carregadas`);
        }else{
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center" style="padding: 40px; color: var(--text-muted);">
                        <i class="bi bi-info-circle" style="font-size: 3rem; opacity: 0.3;"></i>
                        <p style="margin-top: 15px; font-weight: 600; font-size: 1.1rem;">Nenhuma comissão registrada ainda</p>
                        <p style="color: var(--text-secondary); font-size: 0.9rem;">As comissões aparecerão aqui quando orçamentos forem aprovados</p>
                    </td>
                </tr>
            `;
            console.log('ℹ️ Nenhuma comissão no histórico');
        }
    }catch(e){
        console.error('❌ Erro ao carregar comissões:', e);
        const tbody = document.getElementById('comissoesBody');
        if(tbody){
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center" style="padding: 40px; color: var(--danger);">
                        <i class="bi bi-exclamation-triangle" style="font-size: 2rem;"></i>
                        <p style="margin-top: 10px;">Erro ao carregar comissões</p>
                        <button class="btn btn-sm btn-outline" onclick="loadComissoes()" style="margin-top: 10px;">
                            <i class="bi bi-arrow-clockwise"></i> Tentar Novamente
                        </button>
                    </td>
                </tr>
            `;
        }
        setLoading(key, false);
    } finally {
        setTimeout(() => setLoading(key, false), 500);
    }
}

// Carregar gráfico de desempenho de comissões (por mês)
async function loadComissoesChart(){
    try {
        const res = await fetch('/api/comissoes', {credentials: 'include'});
        const data = await res.json();

        if (!data.success || !data.comissoes || data.comissoes.length === 0) {
            const canvas = document.getElementById('chartComissoes');
            if (canvas) {
                canvas.style.display = 'none';
                canvas.parentElement.innerHTML = '<p class="text-center text-muted" style="padding: 40px;">Nenhum dado de comissões disponível</p>';
            }
            return;
        }

        // Agrupar comissões por mês
        const meses = {};
        data.comissoes.forEach(c => {
            const data_registro = new Date(c.data_registro);
            const mesAno = `${data_registro.getMonth() + 1}/${data_registro.getFullYear()}`;
            if (!meses[mesAno]) {
                meses[mesAno] = 0;
            }
            meses[mesAno] += c.comissao_valor || 0;
        });

        // Ordenar por data
        const labels = Object.keys(meses).sort((a, b) => {
            const [mesA, anoA] = a.split('/').map(Number);
            const [mesB, anoB] = b.split('/').map(Number);
            return (anoA * 12 + mesA) - (anoB * 12 + mesB);
        });
        const valores = labels.map(label => meses[label]);

        // Criar gráfico com Chart.js
        const ctx = document.getElementById('chartComissoes');
        if (ctx && window.Chart) {
            // Destruir gráfico anterior se existir
            if (window.chartComissoesInstance) {
                window.chartComissoesInstance.destroy();
            }

            window.chartComissoesInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Comissões (R$)',
                        data: valores,
                        borderColor: 'rgb(124, 58, 237)',
                        backgroundColor: 'rgba(124, 58, 237, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'R$ ' + value.toFixed(0);
                                }
                            }
                        }
                    }
                }
            });
        }
    } catch (error) {
        console.error('Erro ao carregar gráfico de comissões:', error);
    }
}

// Carregar Top Performers
async function loadTopPerformers(){
    try {
        const res = await fetch('/api/comissoes', {credentials: 'include'});
        const data = await res.json();

        const container = document.getElementById('topPerformersBody');
        if (!container) return;

        if (!data.success || !data.comissoes || data.comissoes.length === 0) {
            container.innerHTML = '<p class="text-center text-muted" style="padding: 20px;">Nenhum dado disponível</p>';
            return;
        }

        // Agrupar por profissional
        const profissionais = {};
        data.comissoes.forEach(c => {
            const nome = c.profissional_nome;
            if (!profissionais[nome]) {
                profissionais[nome] = {
                    nome: nome,
                    total: 0,
                    quantidade: 0
                };
            }
            profissionais[nome].total += c.comissao_valor || 0;
            profissionais[nome].quantidade += 1;
        });

        // Ordenar por total e pegar top 5
        const top = Object.values(profissionais)
            .sort((a, b) => b.total - a.total)
            .slice(0, 5);

        if (top.length === 0) {
            container.innerHTML = '<p class="text-center text-muted" style="padding: 20px;">Nenhum profissional com comissões</p>';
            return;
        }

        // Renderizar top performers
        const html = top.map((prof, index) => `
            <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background: var(--bg-main); border-radius: 10px; margin-bottom: 10px;">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div style="background: linear-gradient(135deg, var(--primary), var(--secondary)); color: #fff; width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 0.9rem;">
                        ${index + 1}
                    </div>
                    <div>
                        <div style="font-weight: 700; color: var(--text-primary);">${prof.nome}</div>
                        <div style="font-size: 0.85rem; color: var(--text-secondary);">${prof.quantidade} comissões</div>
                    </div>
                </div>
                <div style="text-align: right;">
                    <div style="font-weight: 900; font-size: 1.1rem; color: var(--success);">R$ ${prof.total.toFixed(2)}</div>
                </div>
            </div>
        `).join('');

        container.innerHTML = html;
    } catch (error) {
        console.error('Erro ao carregar top performers:', error);
        const container = document.getElementById('topPerformersBody');
        if (container) {
            container.innerHTML = '<p class="text-center text-danger" style="padding: 20px;">Erro ao carregar dados</p>';
        }
    }
}

// Função para modal de nova comissão
function showModalComissao() {
    SafeSwal.fire({
        title: '<i class="bi bi-info-circle"></i> Comissões Automáticas',
        html: `
            <div style="text-align: left; padding: 20px;">
                <p style="margin-bottom: 15px;">
                    <i class="bi bi-check-circle-fill" style="color: var(--success);"></i>
                    <strong>As comissões são geradas automaticamente</strong> quando um orçamento é aprovado.
                </p>
                <p style="margin-bottom: 15px;">
                    <i class="bi bi-calculator" style="color: var(--primary);"></i>
                    O valor da comissão é calculado com base no <strong>percentual configurado</strong>
                    para cada profissional.
                </p>
                <p style="margin-bottom: 15px;">
                    <i class="bi bi-person-badge" style="color: var(--info);"></i>
                    Para ajustar o <strong>percentual de comissão</strong> de um profissional,
                    vá para a seção <strong>Profissionais</strong> e edite as informações do profissional.
                </p>
                <div style="background: rgba(var(--warning-rgb), 0.1); padding: 15px; border-radius: 8px; border-left: 4px solid var(--warning); margin-top: 20px;">
                    <i class="bi bi-lightbulb" style="color: var(--warning);"></i>
                    <strong>Dica:</strong> As comissões aparecem na aba <em>Comissões</em> do módulo Financeiro.
                </div>
            </div>
        `,
        icon: 'info',
        confirmButtonText: '<i class="bi bi-check-lg"></i> Entendi',
        confirmButtonColor: 'var(--primary)',
        width: '600px'
    });
}

async function loadFila(){
    const key = 'loadFila';
    if (isLoading(key)) {
        console.warn(`⚠️ Já carregando: ${key}`);
        return;
    }
    setLoading(key, true);

    try{
        const res=await fetch('/api/fila',{credentials:'include'});
        const data=await res.json();
        const container=document.getElementById('filaContainer');

        if(data.success&&data.fila&&data.fila.length>0){
            document.getElementById('totalFila').textContent=data.fila.length;
            
            const html=data.fila.map((f,idx)=>`
                <div style="padding:20px;border:2px solid var(--border-color);border-radius:15px;margin-bottom:15px;display:flex;justify-content:space-between;align-items:center;background:var(--bg-card);transition:all 0.3s;box-shadow:var(--shadow);" onmouseover="this.style.transform='translateX(5px)';this.style.borderColor='var(--primary)'" onmouseout="this.style.transform='translateX(0)';this.style.borderColor='var(--border-color)'">
                    <div style="flex:1">
                        <div style="display:flex;align-items:center;gap:15px;">
                            <div style="width:60px;height:60px;border-radius:50%;background:linear-gradient(135deg,var(--primary),var(--secondary));color:white;display:flex;align-items:center;justify-content:center;font-size:1.8rem;font-weight:900;box-shadow:0 5px 15px rgba(124,58,237,0.3);">
                                #${idx+1}
                            </div>
                            <div>
                                <strong style="font-size:1.2rem;color:var(--text-primary);display:block;">${f.cliente_nome}</strong>
                                <small style="color:var(--text-secondary);display:flex;align-items:center;gap:5px;margin-top:5px;">
                                    <i class="bi bi-telephone"></i> ${f.cliente_telefone||'Sem telefone'}
                                </small>
                                <small style="color:var(--text-muted);display:block;margin-top:3px;">
                                    <i class="bi bi-clock"></i> Adicionado: ${new Date(f.created_at || new Date()).toLocaleTimeString('pt-BR')}
                                </small>
                            </div>
                        </div>
                    </div>
                    <div>
                        <button class="btn btn-sm btn-success" onclick="chamarProximo('${f._id}')" style="margin-right:8px;" title="Chamar para atendimento">
                            <i class="bi bi-check-circle"></i> Chamar
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="removeFila('${f._id}')" title="Remover da fila">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML=html;
        }else{
            document.getElementById('totalFila').textContent='0';
            container.innerHTML=`
                <div style="text-align:center;padding:60px 20px;color:var(--text-muted);">
                    <i class="bi bi-people" style="font-size:5rem;opacity:0.3;"></i>
                    <h3 style="margin-top:20px;color:var(--text-secondary);">Fila Vazia</h3>
                    <p>Nenhuma pessoa aguardando atendimento</p>
                </div>
            `;
        }
    }catch(e){
        console.error('❌ Erro ao carregar fila:',e);
        Swal.fire('Erro','Não foi possível carregar a fila','error');
    } finally {
        setTimeout(() => setLoading(key, false), 1000);
    }
}

async function chamarProximo(id){
    const result = await Swal.fire({
        title: 'Chamar para Atendimento?',
        text: 'Este cliente será atendido e removido da fila',
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'Sim, chamar',
        cancelButtonText: 'Cancelar'
    });

    if(result.isConfirmed){
        try{
            await fetch(`/api/fila/${id}`,{method:'DELETE',credentials:'include'});
            Swal.fire({
                icon: 'success',
                title: '✅ Cliente Chamado!',
                text: 'Cliente pronto para atendimento',
                timer: 2000
            });
            loadFila();
        }catch(e){
            Swal.fire('Erro','Não foi possível processar','error');
        }
    }

    // Limpeza de backdrop residual
    setTimeout(() => {
        document.querySelectorAll('.swal2-container, .swal2-backdrop-show').forEach(el => {
            if (!Swal.isVisible()) el.remove();
        });
        document.body.classList.remove('swal2-shown', 'swal2-height-auto');
    }, 100);
}

async function removeFila(id){
    const result = await Swal.fire({
        title: 'Remover da Fila?',
        text: 'O cliente será removido da fila de atendimento',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Sim, remover',
        cancelButtonText: 'Cancelar',
        confirmButtonColor: '#EF4444'
    });

    if(result.isConfirmed){
        try{
            await fetch(`/api/fila/${id}`,{method:'DELETE',credentials:'include'});
            Swal.fire({
                icon: 'success',
                title: 'Removido!',
                text: 'Cliente removido da fila',
                timer: 1500
            });
            loadFila();
        }catch(e){
            console.error('❌ Erro ao remover da fila:',e);
            Swal.fire('Erro','Não foi possível remover da fila','error');
        }
    }

    // Limpeza de backdrop residual
    setTimeout(() => {
        document.querySelectorAll('.swal2-container, .swal2-backdrop-show').forEach(el => {
            if (!Swal.isVisible()) el.remove();
        });
        document.body.classList.remove('swal2-shown', 'swal2-height-auto');
    }, 100);
}

function showModalFila(){
    Swal.fire({
        title: '<strong>👥 Adicionar à Fila</strong>',
        html: `
            <div style="text-align: left; padding: 10px;">
                <div class="mb-3">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">
                        <i class="bi bi-person"></i> Nome do Cliente:
                    </label>
                    <input type="text" id="swal-nome" class="form-control" placeholder="Digite o nome completo">
                </div>
                <div class="mb-3">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">
                        <i class="bi bi-telephone"></i> Telefone (opcional):
                    </label>
                    <input type="text" id="swal-telefone" class="form-control" placeholder="(00) 00000-0000">
                </div>
                <div class="alert alert-info" style="margin-top: 15px; font-size: 0.9rem;">
                    <i class="bi bi-info-circle"></i> O cliente será adicionado ao final da fila de atendimento
                </div>
            </div>
        `,
        showCancelButton: true,
        confirmButtonText: '<i class="bi bi-plus-circle"></i> Adicionar',
        cancelButtonText: 'Cancelar',
        width: '500px',
        allowEscapeKey: true,
        allowOutsideClick: true,
        showCloseButton: true,
        preConfirm: () => {
            const cliente_nome = document.getElementById('swal-nome').value.trim();
            const cliente_telefone = document.getElementById('swal-telefone').value.trim();
            
            if(!cliente_nome){
                Swal.showValidationMessage('Nome do cliente é obrigatório');
                return false;
            }
            
            return {
                cliente_nome,
                cliente_telefone: cliente_telefone || 'Não informado'
            };
        }
    }).then(async(result) => {
        if(result.isConfirmed){
            try{
                const response = await fetch('/api/fila',{
                    method:'POST',
                    headers:{'Content-Type':'application/json'},
                    credentials:'include',
                    body:JSON.stringify(result.value)
                });
                
                const data = await response.json();
                
                if(data.success){
                    Swal.fire({
                        icon: 'success',
                        title: '✅ Adicionado!',
                        text: 'Cliente adicionado à fila com sucesso',
                        timer: 2000
                    });
                    loadFila();
                } else {
                    Swal.fire('Erro', data.message || 'Erro ao adicionar à fila', 'error');
                }
            }catch(e){
                console.error('Erro:', e);
                Swal.fire('Erro','Não foi possível adicionar à fila','error');
            }
        }
    });
}

async function loadAgendamentos(){
    const key = 'loadAgendamentos';

    // PROTEÇÃO ANTI-LOOP
    if (isLoading(key)) {
        console.warn(`⚠️ Já carregando: ${key}`);
        return;
    }

    setLoading(key, true);

    try{
        const res=await fetch('/api/agendamentos',{credentials:'include'});
        const data=await res.json();

        // Atualizar TODOS os tbody de agendamentos
        const tbodies = [
            document.getElementById('agendamentosHojeBody'),
            document.getElementById('agendamentosSemanaBody'),
            document.getElementById('agendamentosMesBody'),
            document.getElementById('agendamentosTodosBody')
        ];

        if(data.success&&data.agendamentos&&data.agendamentos.length>0){
            const hoje = new Date();
            hoje.setHours(0, 0, 0, 0);

            const amanha = new Date(hoje);
            amanha.setDate(amanha.getDate() + 1);

            const proximaSemana = new Date(hoje);
            proximaSemana.setDate(proximaSemana.getDate() + 7);

            const proximoMes = new Date(hoje);
            proximoMes.setMonth(proximoMes.getMonth() + 1);

            // Filtrar agendamentos
            const agendamentosHoje = data.agendamentos.filter(a => {
                const dataAgend = new Date(a.data);
                dataAgend.setHours(0, 0, 0, 0);
                return dataAgend.getTime() === hoje.getTime();
            });

            const agendamentosSemana = data.agendamentos.filter(a => {
                const dataAgend = new Date(a.data);
                return dataAgend >= hoje && dataAgend < proximaSemana;
            });

            const agendamentosMes = data.agendamentos.filter(a => {
                const dataAgend = new Date(a.data);
                return dataAgend >= hoje && dataAgend < proximoMes;
            });

            // Função auxiliar para renderizar HTML
            const renderAgendamento = (a) => {
                const dataFormatada = new Date(a.data).toLocaleDateString('pt-BR');
                const statusBadge = a.status === 'Confirmado' ? 'success' :
                                   a.status === 'Pendente' ? 'warning' :
                                   a.status === 'Cancelado' ? 'danger' : 'secondary';
                return `<tr>
                    <td><strong>${dataFormatada}</strong></td>
                    <td><strong style="color: var(--primary); font-size: 1.1rem;">${a.horario}</strong></td>
                    <td>${a.cliente_nome}</td>
                    <td>${a.servico_nome||'<span class="text-muted">Não especificado</span>'}</td>
                    <td>${a.profissional_nome||'<span class="text-muted">Não atribuído</span>'}</td>
                    <td><span class="badge ${statusBadge}">${a.status||'Pendente'}</span></td>
                    <td>
                        <button class="btn btn-sm btn-danger" onclick="cancelarAgendamento('${a._id}')" title="Cancelar">
                            <i class="bi bi-x-circle"></i>
                        </button>
                    </td>
                </tr>`;
            };

            // Hoje
            if(tbodies[0]){
                const html = agendamentosHoje.length > 0 ? agendamentosHoje.map(renderAgendamento).join('') : '<tr><td colspan="7" class="text-center text-muted">Nenhum agendamento para hoje</td></tr>';
                tbodies[0].innerHTML = html;
            }

            // Próxima semana
            if(tbodies[1]){
                const html = agendamentosSemana.length > 0 ? agendamentosSemana.map(renderAgendamento).join('') : '<tr><td colspan="7" class="text-center text-muted">Nenhum agendamento nos próximos 7 dias</td></tr>';
                tbodies[1].innerHTML = html;
            }

            // Próximo mês
            if(tbodies[2]){
                const html = agendamentosMes.length > 0 ? agendamentosMes.map(renderAgendamento).join('') : '<tr><td colspan="7" class="text-center text-muted">Nenhum agendamento nos próximos 30 dias</td></tr>';
                tbodies[2].innerHTML = html;
            }

            // Todos
            if(tbodies[3]){
                const html = data.agendamentos.map(renderAgendamento).join('');
                tbodies[3].innerHTML = html;
            }
        }else{
            tbodies.forEach(tb => {
                if(tb) tb.innerHTML='<tr><td colspan="7" class="text-center text-muted"><i class="bi bi-calendar-x" style="font-size: 3rem; opacity: 0.3;"></i><br>Nenhum agendamento cadastrado</td></tr>';
            });
        }
    }catch(e){
        console.error('❌ Erro ao carregar agendamentos:',e);
    } finally {
        setTimeout(() => setLoading(key, false), 1000);
    }
}

async function cancelarAgendamento(id){
    const result = await Swal.fire({
        title: 'Cancelar Agendamento?',
        text: 'Esta ação não pode ser desfeita',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Sim, cancelar',
        cancelButtonText: 'Não'
    });

    if(result.isConfirmed){
        try{
            await fetch(`/api/agendamentos/${id}`,{method:'DELETE',credentials:'include'});
            Swal.fire('Cancelado!','Agendamento cancelado com sucesso','success');
            loadAgendamentos();
        }catch(e){
            Swal.fire('Erro','Não foi possível cancelar o agendamento','error');
        }
    }

    // Limpeza de backdrop residual
    setTimeout(() => {
        document.querySelectorAll('.swal2-container, .swal2-backdrop-show').forEach(el => {
            if (!Swal.isVisible()) el.remove();
        });
        document.body.classList.remove('swal2-shown', 'swal2-height-auto');
    }, 100);
}

async function visualizarAgendamento(id){
    try{
        const res = await fetch(`/api/agendamentos/${id}`, {credentials:'include'});
        const data = await res.json();

        if(data.success && data.agendamento){
            const ag = data.agendamento;
            const dataHora = new Date(ag.data_hora).toLocaleString('pt-BR');

            Swal.fire({
                title: '<strong>📅 Detalhes do Agendamento</strong>',
                html: `
                    <div style="text-align: left; padding: 20px;">
                        <div style="background: linear-gradient(135deg, #7C3AED, #EC4899); color: #fff; padding: 20px; border-radius: 15px; margin-bottom: 20px;">
                            <h3 style="margin: 0;">👤 ${ag.cliente_nome || 'Não informado'}</h3>
                            <p style="margin: 10px 0 0; opacity: 0.9;">📞 ${ag.cliente_telefone || 'Não informado'}</p>
                        </div>

                        <div style="margin-bottom: 15px;">
                            <strong style="color: #7C3AED;">✂️ Serviço:</strong>
                            <p style="margin: 5px 0 0;">${ag.servico || 'Não especificado'}</p>
                        </div>

                        <div style="margin-bottom: 15px;">
                            <strong style="color: #7C3AED;">👨‍⚕️ Profissional:</strong>
                            <p style="margin: 5px 0 0;">${ag.profissional || 'Não atribuído'}</p>
                        </div>

                        <div style="margin-bottom: 15px;">
                            <strong style="color: #7C3AED;">🗓️ Data e Hora:</strong>
                            <p style="margin: 5px 0 0;">${dataHora}</p>
                        </div>

                        ${ag.observacoes ? `
                            <div style="margin-bottom: 15px;">
                                <strong style="color: #7C3AED;">📝 Observações:</strong>
                                <p style="margin: 5px 0 0; background: #F3F4F6; padding: 10px; border-radius: 8px;">${ag.observacoes}</p>
                            </div>
                        ` : ''}

                        <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #E5E7EB;">
                            <p style="font-size: 0.85rem; color: #6B7280; margin: 0;">
                                <strong>Status:</strong> <span class="badge ${ag.status === 'confirmado' ? 'success' : 'warning'}">${ag.status || 'Pendente'}</span>
                            </p>
                            <p style="font-size: 0.85rem; color: #6B7280; margin: 10px 0 0;">
                                Criado em: ${new Date(ag.created_at || ag.data_hora).toLocaleString('pt-BR')}
                            </p>
                        </div>
                    </div>
                `,
                width: '600px',
                confirmButtonText: 'Fechar',
                confirmButtonColor: '#7C3AED',
                showCancelButton: true,
                cancelButtonText: '<i class="bi bi-trash"></i> Cancelar Agendamento',
                cancelButtonColor: '#EF4444',
                allowEscapeKey: true,
                allowOutsideClick: true,
                showCloseButton: true,
                focusConfirm: true
            }).then((result) => {
                if (result.dismiss === Swal.DismissReason.cancel) {
                    cancelarAgendamento(id);
                }
            });
        } else {
            Swal.fire('Erro', 'Agendamento não encontrado', 'error');
        }
    }catch(e){
        console.error('Erro ao visualizar agendamento:', e);
        Swal.fire('Erro', 'Não foi possível carregar os detalhes do agendamento', 'error');
    }
}

async function showModalAgendamento(){
    // Buscar clientes e serviços para preencher os selects
    let clientesOptions = '<option value="">Selecione o cliente...</option>';
    let servicosOptions = '<option value="">Selecione o serviço...</option>';
    let profissionaisOptions = '<option value="">Selecione o profissional...</option>';
    
    try {
        const [clientesRes, servicosRes, profissionaisRes] = await Promise.all([
            fetch('/api/clientes',{credentials:'include'}),
            fetch('/api/servicos',{credentials:'include'}),
            fetch('/api/profissionais',{credentials:'include'})
        ]);
        
        const [clientesData, servicosData, profissionaisData] = await Promise.all([
            clientesRes.json(),
            servicosRes.json(),
            profissionaisRes.json()
        ]);
        
        if(clientesData.success && clientesData.clientes){
            clientesOptions += clientesData.clientes.map(c => 
                `<option value="${c.nome}">${c.nome} - ${c.cpf}</option>`
            ).join('');
        }
        
        if(servicosData.success && servicosData.servicos){
            servicosOptions += servicosData.servicos.map(s => 
                `<option value="${s.nome}">${s.nome} - R$ ${s.preco.toFixed(2)}</option>`
            ).join('');
        }
        
        if(profissionaisData.success && profissionaisData.profissionais){
            profissionaisOptions += profissionaisData.profissionais.map(p => 
                `<option value="${p.nome}">${p.nome} - ${p.especialidade||'Geral'}</option>`
            ).join('');
        }
    } catch(e) {
        console.error('Erro ao buscar dados:', e);
    }
    
    Swal.fire({
        title: '<strong>🗓️ Novo Agendamento</strong>',
        html: `
            <div style="text-align: left; padding: 10px;">
                <div class="mb-3">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Cliente:</label>
                    <select id="swal-cliente" class="form-select">${clientesOptions}</select>
                </div>
                <div class="mb-3">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Serviço:</label>
                    <select id="swal-servico" class="form-select">${servicosOptions}</select>
                </div>
                <div class="mb-3">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Profissional:</label>
                    <select id="swal-profissional" class="form-select">${profissionaisOptions}</select>
                </div>
                <div class="mb-3">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Data:</label>
                    <input type="date" id="swal-data" class="form-control" min="${new Date().toISOString().split('T')[0]}">
                </div>
                <div class="mb-3">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Horário:</label>
                    <select id="swal-horario" class="form-select">
                        <option value="">Selecione o horário...</option>
                        <option value="08:00">08:00</option>
                        <option value="08:30">08:30</option>
                        <option value="09:00">09:00</option>
                        <option value="09:30">09:30</option>
                        <option value="10:00">10:00</option>
                        <option value="10:30">10:30</option>
                        <option value="11:00">11:00</option>
                        <option value="11:30">11:30</option>
                        <option value="13:00">13:00</option>
                        <option value="13:30">13:30</option>
                        <option value="14:00">14:00</option>
                        <option value="14:30">14:30</option>
                        <option value="15:00">15:00</option>
                        <option value="15:30">15:30</option>
                        <option value="16:00">16:00</option>
                        <option value="16:30">16:30</option>
                        <option value="17:00">17:00</option>
                        <option value="17:30">17:30</option>
                        <option value="18:00">18:00</option>
                    </select>
                </div>
            </div>
        `,
        showCancelButton: true,
        confirmButtonText: '<i class="bi bi-check-circle"></i> Agendar',
        cancelButtonText: 'Cancelar',
        width: '600px',
        allowEscapeKey: true,
        allowOutsideClick: true,
        showCloseButton: true,
        preConfirm: () => {
            const cliente_nome = document.getElementById('swal-cliente').value;
            const servico_nome = document.getElementById('swal-servico').value;
            const profissional_nome = document.getElementById('swal-profissional').value;
            const data = document.getElementById('swal-data').value;
            const horario = document.getElementById('swal-horario').value;
            
            if(!cliente_nome || !data || !horario){
                Swal.showValidationMessage('Cliente, data e horário são obrigatórios');
                return false;
            }
            
            return {
                cliente_nome,
                servico_nome: servico_nome || 'Não especificado',
                profissional_nome: profissional_nome || 'Não atribuído',
                data: new Date(data+'T12:00:00').toISOString(),
                horario,
                status: 'Confirmado'
            };
        }
    }).then(async(result) => {
        if(result.isConfirmed){
            try{
                const response = await fetch('/api/agendamentos',{
                    method:'POST',
                    headers:{'Content-Type':'application/json'},
                    credentials:'include',
                    body:JSON.stringify(result.value)
                });
                
                const data = await response.json();
                
                if(data.success){
                    Swal.fire({
                        icon: 'success',
                        title: '✅ Agendado!',
                        text: 'Agendamento criado com sucesso',
                        timer: 2000
                    });
                    loadAgendamentos();
                } else {
                    Swal.fire('Erro', data.message || 'Erro ao criar agendamento', 'error');
                }
            }catch(e){
                console.error('Erro:', e);
                Swal.fire('Erro','Não foi possível criar o agendamento','error');
            }
        }
    });
}

async function handleUpload(input,tipo){
    const file=input.files[0];
    if(!file){
        return;
    }
    
    // Validar tipo de arquivo
    const validExtensions = ['.csv', '.xlsx', '.xls'];
    const fileName = file.name.toLowerCase();
    const isValidFile = validExtensions.some(ext => fileName.endsWith(ext));
    
    if(!isValidFile){
        Swal.fire({
            icon: 'error',
            title: 'Arquivo Inválido',
            text: 'Por favor, selecione um arquivo CSV ou Excel (.xlsx, .xls)'
        });
        input.value = '';
        return;
    }
    
    const formData=new FormData();
    formData.append('file',file);
    formData.append('tipo',tipo);
    
    Swal.fire({
        title: `Importando ${tipo}...`,
        html: `
            <div style="padding: 20px;">
                <div class="spinner" style="margin: 20px auto;"></div>
                <p style="margin-top: 20px;">Processando arquivo: <strong>${file.name}</strong></p>
                <p class="text-muted">Aguarde, isso pode levar alguns segundos...</p>
            </div>
        `,
        allowOutsideClick: false,
        allowEscapeKey: false,
        showConfirmButton: false
    });
    
    try{
        const res=await fetch('/api/importar',{
            method:'POST',
            credentials:'include',
            body:formData
        });
        
        const data=await res.json();
        
        if(data.success){
            const totalRegistros = data.count_success + (data.count_error || 0);
            const porcentagemSucesso = ((data.count_success / totalRegistros) * 100).toFixed(1);
            
            Swal.fire({
                icon: data.count_error > 0 ? 'warning' : 'success',
                title: data.count_error > 0 ? '⚠️ Importação Parcial' : '✅ Importação Concluída!',
                html: `
                    <div style="padding: 20px;">
                        <div style="background: var(--bg-main); border-radius: 12px; padding: 20px; margin: 15px 0;">
                            <h3 style="color: var(--success); margin: 0;">
                                <i class="bi bi-check-circle"></i> ${data.count_success} registros importados
                            </h3>
                            ${data.count_error > 0 ? `
                                <h4 style="color: var(--danger); margin-top: 10px;">
                                    <i class="bi bi-x-circle"></i> ${data.count_error} erros encontrados
                                </h4>
                            ` : ''}
                            <p style="margin-top: 15px; font-size: 0.9rem; color: var(--text-secondary);">
                                Taxa de sucesso: <strong style="color: var(--primary);">${porcentagemSucesso}%</strong>
                            </p>
                        </div>
                        ${data.errors && data.errors.length > 0 ? `
                            <div style="margin-top: 20px; text-align: left;">
                                <strong>Detalhes dos erros:</strong>
                                <ul style="max-height: 150px; overflow-y: auto; margin-top: 10px; padding-left: 20px;">
                                    ${data.errors.slice(0, 5).map(err => `<li style="margin: 5px 0;">${err}</li>`).join('')}
                                    ${data.errors.length > 5 ? `<li style="color: var(--text-muted);">... e mais ${data.errors.length - 5} erros</li>` : ''}
                                </ul>
                            </div>
                        ` : ''}
                    </div>
                `,
                confirmButtonText: 'Entendi'
            });
            
            // Recarregar a lista apropriada
            if(tipo==='produtos') loadProdutosLista();
            else if(tipo==='servicos') loadServicosLista();
            else if(tipo==='clientes') loadClientes();
            else if(tipo==='profissionais') loadProfissionais();
            
        }else{
            Swal.fire({
                icon: 'error',
                title: 'Erro na Importação',
                text: data.message || 'Ocorreu um erro ao processar o arquivo',
                footer: '<small>Verifique se o arquivo está no formato correto</small>'
            });
        }
    }catch(e){
        console.error('❌ Erro na importação:',e);
        Swal.fire({
            icon: 'error',
            title: 'Erro no Upload',
            text: 'Não foi possível enviar o arquivo. Tente novamente.',
            footer: '<small>Verifique sua conexão e o tamanho do arquivo</small>'
        });
    }
    
    // Limpar o input para permitir upload do mesmo arquivo novamente
    input.value='';
}

async function buscarClientePorCPF(){
    const cpf=document.getElementById('orcCPF').value.trim();
    if(cpf.length<3){document.getElementById('cpfResults').style.display='none';return;}
    try{
        const res=await fetch(`/api/clientes/buscar?termo=${cpf}`,{credentials:'include'});
        const data=await res.json();
        if(data.success&&data.clientes.length>0){
            const html=data.clientes.map(c=>`<div class="autocomplete-item" onclick="selecionarCliente('${c._id}','${c.cpf}','${c.nome}','${c.email||''}','${c.telefone||''}')"><strong>${c.nome}</strong><small>${c.cpf} | ${c.telefone||'Sem telefone'}</small></div>`).join('');
            document.getElementById('cpfResults').innerHTML=html;
            document.getElementById('cpfResults').style.display='block';
        }else{
            document.getElementById('cpfResults').style.display='none';
        }
    }catch(e){
        console.error('❌ Erro buscar cliente:',e);
    }
}

function selecionarCliente(id,cpf,nome,email,telefone){
    document.getElementById('orcCPF').value=cpf;
    document.getElementById('orcNomeCliente').value=nome;
    document.getElementById('orcEmail').value=email;
    document.getElementById('orcTelefone').value=telefone;
    document.getElementById('cpfResults').style.display='none';
}

function limparCliente(){
    document.getElementById('orcCPF').value='';
    document.getElementById('orcNomeCliente').value='';
    document.getElementById('orcEmail').value='';
    document.getElementById('orcTelefone').value='';
}

async function buscarServicos(){
    const termo=document.getElementById('buscaServico').value.trim();
    if(termo.length<2){document.getElementById('servicoResults').style.display='none';return;}
    try{
        const res=await fetch(`/api/servicos/buscar?termo=${termo}`,{credentials:'include'});
        const data=await res.json();
        if(data.success&&data.servicos.length>0){
            servicosDisponiveis=data.servicos;
            const servicosAgrupados={};
            data.servicos.forEach(s=>{if(!servicosAgrupados[s.nome])servicosAgrupados[s.nome]=[];servicosAgrupados[s.nome].push(s);});
            const html=Object.keys(servicosAgrupados).map(nome=>`<div class="autocomplete-item" onclick="selecionarServico('${nome}')"><strong>${nome}</strong><small>${servicosAgrupados[nome].length} tamanhos disponíveis</small></div>`).join('');
            document.getElementById('servicoResults').innerHTML=html;
            document.getElementById('servicoResults').style.display='block';
        }else{
            document.getElementById('servicoResults').style.display='none';
        }
    }catch(e){
        console.error(e);
    }
}

function selecionarServico(nome){
    document.getElementById('buscaServico').value=nome;
    document.getElementById('servicoResults').style.display='none';
    const servicosFiltrados=servicosDisponiveis.filter(s=>s.nome===nome);
    const selectTamanho=document.getElementById('servicoTamanho');
    selectTamanho.innerHTML='<option value="">Selecione...</option>';
    servicosFiltrados.forEach(s=>{
        const option=document.createElement('option');
        option.value=s._id;
        option.textContent=`${s.tamanho} - R$ ${s.preco.toFixed(2)}`;
        option.dataset.preco=s.preco;
        option.dataset.nome=s.nome;
        option.dataset.tamanho=s.tamanho;
        selectTamanho.appendChild(option);
    });
    selectTamanho.addEventListener('change',function(){
        const selected=this.options[this.selectedIndex];
        if(selected.dataset.preco){
            document.getElementById('servicoPreco').value=selected.dataset.preco;
            servicoSelecionado={id:this.value,nome:selected.dataset.nome,tamanho:selected.dataset.tamanho,preco:parseFloat(selected.dataset.preco)};
        }
    });
}

function addServico(){
    if(!servicoSelecionado){Swal.fire('Atenção','Selecione um serviço','warning');return;}
    const qtd=parseInt(document.getElementById('servicoQtd').value)||1;
    const preco=parseFloat(document.getElementById('servicoPreco').value)||0;
    const desconto=parseInt(document.getElementById('servicoDesconto').value)||0;
    if(preco<=0){Swal.fire('Atenção','Preço inválido','warning');return;}
    const subtotal=qtd*preco;
    const total=subtotal-(subtotal*desconto/100);
    orcamento.servicos.push({id:servicoSelecionado.id,nome:servicoSelecionado.nome,tamanho:servicoSelecionado.tamanho,qtd:qtd,preco_unit:preco,desconto:desconto,total:total});
    atualizarTabelaServicos();
    document.getElementById('buscaServico').value='';
    document.getElementById('servicoTamanho').innerHTML='<option value="">Selecione...</option>';
    document.getElementById('servicoQtd').value='1';
    document.getElementById('servicoPreco').value='';
    document.getElementById('servicoDesconto').value='0';
    servicoSelecionado=null;
    calcularTotais();
}

function atualizarTabelaServicos(){
    const tbody=document.getElementById('servicosBody');
    if(orcamento.servicos.length===0){tbody.innerHTML='<tr><td colspan="7" class="text-center text-muted">Nenhum serviço</td></tr>';return;}
    const html=orcamento.servicos.map((s,idx)=>`<tr><td><strong>${s.nome}</strong></td><td>${s.tamanho}</td><td>${s.qtd}</td><td>R$ ${s.preco_unit.toFixed(2)}</td><td>${s.desconto}%</td><td><strong>R$ ${s.total.toFixed(2)}</strong></td><td><button class="btn btn-sm btn-danger" onclick="removerServico(${idx})"><i class="bi bi-trash"></i></button></td></tr>`).join('');
    tbody.innerHTML=html;
}

function removerServico(idx){
    orcamento.servicos.splice(idx,1);
    atualizarTabelaServicos();
    calcularTotais();
}

async function buscarProdutos(){
    const termo=document.getElementById('buscaProduto').value.trim();
    if(termo.length<2){document.getElementById('produtoResults').style.display='none';return;}
    try{
        const res=await fetch(`/api/produtos/buscar?termo=${termo}`,{credentials:'include'});
        const data=await res.json();
        if(data.success&&data.produtos.length>0){
            produtosDisponiveis=data.produtos;
            const html=data.produtos.map(p=>{
                let nomeCompleto=p.nome;
                if(p.marca)nomeCompleto+=` - ${p.marca}`;
                return `<div class="autocomplete-item" onclick="selecionarProduto('${p._id}','${nomeCompleto.replace(/'/g,"\\'")}','${p.marca||''}','${p.sku}',${p.preco})"><strong>${nomeCompleto}</strong><small>R$ ${p.preco.toFixed(2)} | Estoque: ${p.estoque||0} unidades</small></div>`;
            }).join('');
            document.getElementById('produtoResults').innerHTML=html;
            document.getElementById('produtoResults').style.display='block';
        }else{
            document.getElementById('produtoResults').style.display='none';
        }
    }catch(e){
        console.error(e);
    }
}

function selecionarProduto(id,nome,marca,sku,preco){
    document.getElementById('buscaProduto').value=nome;
    document.getElementById('produtoResults').style.display='none';
    document.getElementById('produtoPreco').value=preco.toFixed(2);
    produtoSelecionado={id,nome,marca,sku,preco};
}

function addProduto(){
    if(!produtoSelecionado){Swal.fire('Atenção','Selecione um produto','warning');return;}
    const qtd=parseInt(document.getElementById('produtoQtd').value)||1;
    const preco=parseFloat(document.getElementById('produtoPreco').value)||0;
    const desconto=parseInt(document.getElementById('produtoDesconto').value)||0;
    if(preco<=0){Swal.fire('Atenção','Preço inválido','warning');return;}
    const subtotal=qtd*preco;
    const total=subtotal-(subtotal*desconto/100);
    orcamento.produtos.push({id:produtoSelecionado.id,nome:produtoSelecionado.nome,marca:produtoSelecionado.marca,sku:produtoSelecionado.sku,qtd:qtd,preco_unit:preco,desconto:desconto,total:total});
    atualizarTabelaProdutos();
    document.getElementById('buscaProduto').value='';
    document.getElementById('produtoQtd').value='1';
    document.getElementById('produtoPreco').value='';
    document.getElementById('produtoDesconto').value='0';
    produtoSelecionado=null;
    calcularTotais();
}

function atualizarTabelaProdutos(){
    const tbody=document.getElementById('produtosBody');
    if(orcamento.produtos.length===0){tbody.innerHTML='<tr><td colspan="7" class="text-center text-muted">Nenhum produto</td></tr>';return;}
    const html=orcamento.produtos.map((p,idx)=>`<tr><td><strong>${p.nome}</strong></td><td>${p.marca||'-'}</td><td>${p.qtd}</td><td>R$ ${p.preco_unit.toFixed(2)}</td><td>${p.desconto}%</td><td><strong>R$ ${p.total.toFixed(2)}</strong></td><td><button class="btn btn-sm btn-danger" onclick="removerProduto(${idx})"><i class="bi bi-trash"></i></button></td></tr>`).join('');
    tbody.innerHTML=html;
}

function removerProduto(idx){
    orcamento.produtos.splice(idx,1);
    atualizarTabelaProdutos();
    calcularTotais();
}

function calcularTotais(){
    const subtotalServicos=orcamento.servicos.reduce((acc,s)=>acc+s.total,0);
    const subtotalProdutos=orcamento.produtos.reduce((acc,p)=>acc+p.total,0);
    const subtotal=subtotalServicos+subtotalProdutos;
    const descontoGlobal=parseFloat(document.getElementById('descontoGlobal').value)||0;
    const descontoValor=subtotal*(descontoGlobal/100);
    const totalComDesconto=subtotal-descontoValor;
    const cashbackPerc=parseFloat(document.getElementById('cashbackPerc').value)||0;
    const cashbackValor=totalComDesconto*(cashbackPerc/100);
    document.getElementById('subtotalServicos').textContent=`R$ ${subtotalServicos.toFixed(2)}`;
    document.getElementById('subtotalProdutos').textContent=`R$ ${subtotalProdutos.toFixed(2)}`;
    document.getElementById('totalFinalOrc').textContent=`R$ ${totalComDesconto.toFixed(2)}`;
    document.getElementById('cashbackValor').textContent=`🎁 Cashback: R$ ${cashbackValor.toFixed(2)}`;
    
    // Atualizar comissões dos profissionais vinculados
    atualizarTabelaProfissionaisVinculados();
    
    // Calcular e exibir total de comissões
    const totalComissoes = profissionaisVinculados.reduce((acc, prof) => {
        return acc + ((totalComDesconto * prof.comissao_perc) / 100);
    }, 0);
    
    const totalComissoesElement = document.getElementById('totalComissoes');
    const footerElement = document.getElementById('profissionaisVinculadosFooter');
    
    if (profissionaisVinculados.length > 0 && totalComissoesElement && footerElement) {
        totalComissoesElement.textContent = `R$ ${totalComissoes.toFixed(2)}`;
        footerElement.style.display = '';
    } else if (footerElement) {
        footerElement.style.display = 'none';
    }
}

async function salvarOrc(status){
    const cpf=document.getElementById('orcCPF').value.trim();
    const nome=document.getElementById('orcNomeCliente').value.trim();
    if(!cpf||!nome){Swal.fire('Atenção','Preencha CPF e Nome','warning');return;}
    if(orcamento.servicos.length===0&&orcamento.produtos.length===0){Swal.fire('Atenção','Adicione pelo menos um item','warning');return;}
    
    // Calcular comissões dos profissionais vinculados
    const totalOrcamento = calcularTotalOrcamentoBase();
    const profissionaisComComissoes = profissionaisVinculados.map(prof => ({
        profissional_id: prof.id,
        nome: prof.nome,
        tipo: prof.tipo,
        comissao_perc: prof.comissao_perc,
        comissao_valor: (totalOrcamento * prof.comissao_perc) / 100
    }));
    
    const data={
        cliente_cpf:cpf,
        cliente_nome:nome,
        cliente_email:document.getElementById('orcEmail').value.trim(),
        cliente_telefone:document.getElementById('orcTelefone').value.trim(),
        servicos:orcamento.servicos,
        produtos:orcamento.produtos,
        desconto_global:parseFloat(document.getElementById('descontoGlobal').value)||0,
        cashback_perc:parseFloat(document.getElementById('cashbackPerc').value)||0,
        pagamento:{tipo:document.getElementById('pagamento').value},
        profissionais_vinculados: profissionaisComComissoes, // NOVO: array de profissionais
        status:status
    };
    
    try{
        let res,result;
        if(window.orcamentoEditandoId){
            res=await fetch(`/api/orcamentos/${window.orcamentoEditandoId}`,{method:'PUT',headers:{'Content-Type':'application/json'},credentials:'include',body:JSON.stringify(data)});
            result=await res.json();
            if(result.success){
                Swal.fire({icon:'success',title:'✅ Atualizado!',html:`<p>Orçamento <strong>#${result.numero||window.orcamentoEditandoId}</strong> atualizado</p>`,timer:2000}).then(()=>{delete window.orcamentoEditandoId;cancelarOrc();goTo('consultar');});
            }else{
                Swal.fire('Erro',result.message,'error');
            }
        }else{
            res=await fetch('/api/orcamentos',{method:'POST',headers:{'Content-Type':'application/json'},credentials:'include',body:JSON.stringify(data)});
            result=await res.json();
            if(result.success){
                Swal.fire({icon:'success',title:status==='Aprovado'?'✅ Contrato Gerado!':'✅ Salvo!',html:`<p>Orçamento <strong>#${result.numero}</strong></p>${status==='Aprovado'?'<p>📧 Email enviado!</p>':''}${profissionaisComComissoes.length > 0 ? `<p>👥 ${profissionaisComComissoes.length} profissional(is) vinculado(s)</p>` : ''}`,timer:2500}).then(()=>{cancelarOrc();goTo('consultar');});
            }else{
                Swal.fire('Erro',result.message,'error');
            }
        }
    }catch(e){
        Swal.fire('Erro','Erro ao salvar','error');
    }
}

async function visualizarOrcamento(id){
    // CORREÇÃO 1.4: Usar modal completo e detalhado do melhorias-v37.js
    if (typeof mostrarDetalhesOrcamentoCompleto === 'function') {
        mostrarDetalhesOrcamentoCompleto(id);
    } else {
        // Fallback: versão simplificada
        try{
            const res=await fetch(`/api/orcamentos/${id}`,{credentials:'include'});
            const data=await res.json();
            if(data.success&&data.orcamento){
                const orc=data.orcamento;
                const servicosHtml=orc.servicos.map(s=>`<tr><td>${s.nome}</td><td>${s.tamanho}</td><td>${s.qtd}</td><td>R$ ${s.preco_unit.toFixed(2)}</td><td>${s.desconto}%</td><td><strong>R$ ${s.total.toFixed(2)}</strong></td></tr>`).join('');
                const produtosHtml=orc.produtos.map(p=>`<tr><td>${p.nome}</td><td>${p.marca||'-'}</td><td>${p.qtd}</td><td>${p.preco_unit.toFixed(2)}</td><td>${p.desconto}%</td><td><strong>R$ ${p.total.toFixed(2)}</strong></td></tr>`).join('');
                Swal.fire({
                    title:`<strong>Orçamento #${orc.numero}</strong>`,
                    html:`<div style="text-align:left;max-height:500px;overflow-y:auto"><div style="background:linear-gradient(135deg,#7C3AED,#EC4899);color:#fff;padding:20px;border-radius:15px;margin-bottom:20px"><h3 style="margin:0">👤 ${orc.cliente_nome}</h3><p style="margin:5px 0 0"><strong>CPF:</strong> ${orc.cliente_cpf}</p>${orc.cliente_email?`<p style="margin:5px 0 0"><strong>Email:</strong> ${orc.cliente_email}</p>`:''}${orc.cliente_telefone?`<p style="margin:5px 0 0"><strong>Telefone:</strong> ${orc.cliente_telefone}</p>`:''}</div><h4 style="color:#7C3AED;border-bottom:2px solid #7C3AED;padding-bottom:10px">✂️ Serviços</h4><table style="width:100%;margin-bottom:20px;font-size:0.9rem"><thead><tr style="background:#f3f4f6"><th style="padding:8px;text-align:left">Serviço</th><th>Tamanho</th><th>Qtd</th><th>Preço</th><th>Desc</th><th>Total</th></tr></thead><tbody>${servicosHtml||'<tr><td colspan="6" style="text-align:center;color:#999">Nenhum</td></tr>'}</tbody></table><h4 style="color:#7C3AED;border-bottom:2px solid #7C3AED;padding-bottom:10px">📦 Produtos</h4><table style="width:100%;margin-bottom:20px;font-size:0.9rem"><thead><tr style="background:#f3f4f6"><th style="padding:8px;text-align:left">Produto</th><th>Marca</th><th>Qtd</th><th>Preço</th><th>Desc</th><th>Total</th></tr></thead><tbody>${produtosHtml||'<tr><td colspan="6" style="text-align:center;color:#999">Nenhum</td></tr>'}</tbody></table><div style="background:#f3f4f6;padding:15px;border-radius:10px"><p><strong>Desconto Global:</strong> ${orc.desconto_global||0}%</p><p><strong>Cashback:</strong> ${orc.cashback_perc||0}% (R$ ${orc.cashback_valor.toFixed(2)})</p><p><strong>Pagamento:</strong> ${orc.pagamento?.tipo||'N/A'}</p><h3 style="color:#10B981;margin:10px 0 0">TOTAL: R$ ${orc.total_final.toFixed(2)}</h3></div><p style="margin-top:15px;font-size:0.85rem;color:#6B7280">Criado em: ${new Date(orc.created_at).toLocaleString('pt-BR')}</p></div>`,
                    width:'700px',
                    confirmButtonText:'Fechar',
                    confirmButtonColor:'#7C3AED',
                    allowEscapeKey: true,
                    allowOutsideClick: true,
                    focusConfirm: true,
                    showCloseButton: true
                });
            }
        }catch(e){
            Swal.fire('Erro','Não foi possível carregar os detalhes','error');
        }
    }
}

async function editarOrcamento(id){
    try{
        const res=await fetch(`/api/orcamentos/${id}`,{credentials:'include'});
        const data=await res.json();
        if(data.success&&data.orcamento){
            const orc=data.orcamento;
            orcamento={servicos:orc.servicos||[],produtos:orc.produtos||[]};
            document.getElementById('orcCPF').value=orc.cliente_cpf;
            document.getElementById('orcNomeCliente').value=orc.cliente_nome;
            document.getElementById('orcEmail').value=orc.cliente_email||'';
            document.getElementById('orcTelefone').value=orc.cliente_telefone||'';
            document.getElementById('descontoGlobal').value=orc.desconto_global||0;
            document.getElementById('cashbackPerc').value=orc.cashback_perc||0;
            if(orc.pagamento?.tipo)document.getElementById('pagamento').value=orc.pagamento.tipo;
            atualizarTabelaServicos();
            atualizarTabelaProdutos();
            calcularTotais();
            goTo('orcamento');

            // CORREÇÃO 2.1: Ir direto para sub-aba "novo" (formulário de edição)
            setTimeout(() => {
                const novoBtn = document.querySelector('[data-subtab="orcamento-novo"]');
                if (novoBtn) {
                    novoBtn.click();
                } else {
                    // Fallback: mostrar diretamente
                    document.querySelectorAll('#section-orcamento .sub-tab-content').forEach(tab => tab.classList.remove('active'));
                    const novoTab = document.getElementById('orcamento-subtab-novo');
                    if (novoTab) novoTab.classList.add('active');
                }
            }, 100);

            const pageHeader=document.querySelector('#section-orcamento .page-header h1');
            if(pageHeader){pageHeader.innerHTML=`<i class="bi bi-pencil-square"></i> Editando Orçamento #${orc.numero}`;}
            Swal.fire({icon:'info',title:'✏️ Modo Edição',html:`<p>Orçamento <strong>#${orc.numero}</strong> carregado</p><p style="color:#7C3AED">Faça as alterações e clique em Salvar</p>`,timer:2500,showConfirmButton:false});
            window.orcamentoEditandoId=id;
        }
    }catch(e){
        Swal.fire('Erro','Não foi possível carregar para edição','error');
    }
}

async function imprimirContrato(id) {
    try {
        // Buscar dados do orçamento
        const res = await fetch(`/api/orcamentos/${id}`, {credentials: 'include'});
        const data = await res.json();

        if (!data.success || !data.orcamento) {
            Swal.fire('Erro', 'Orçamento não encontrado', 'error');
            return;
        }

        const orc = data.orcamento;

        // Gerar PDF via backend
        const pdfRes = await fetch(`/api/orcamentos/${id}/pdf`, {
            method: 'GET',
            credentials: 'include'
        });

        if (pdfRes.ok) {
            // Baixar o PDF
            const blob = await pdfRes.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `contrato_${orc.numero || id}.pdf`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);

            Swal.fire({
                icon: 'success',
                title: 'Contrato gerado!',
                text: 'O PDF do contrato foi baixado com sucesso',
                timer: 2000,
                showConfirmButton: false
            });
        } else {
            // Fallback: abrir em nova janela para impressão
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Contrato #${orc.numero || id}</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 40px; }
                        h1 { color: #7C3AED; border-bottom: 3px solid #7C3AED; padding-bottom: 10px; }
                        .info { margin: 20px 0; }
                        .info strong { color: #333; }
                        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
                        th { background-color: #7C3AED; color: white; }
                        .total { font-size: 1.2em; font-weight: bold; color: #7C3AED; }
                        @media print { button { display: none; } }
                    </style>
                </head>
                <body>
                    <h1>CONTRATO DE SERVIÇOS - #${orc.numero || id}</h1>

                    <div class="info">
                        <p><strong>Cliente:</strong> ${orc.cliente_nome || 'N/A'}</p>
                        <p><strong>CPF:</strong> ${orc.cliente_cpf || 'N/A'}</p>
                        <p><strong>Email:</strong> ${orc.cliente_email || 'N/A'}</p>
                        <p><strong>Telefone:</strong> ${orc.cliente_telefone || 'N/A'}</p>
                        <p><strong>Data:</strong> ${orc.data || new Date().toLocaleDateString('pt-BR')}</p>
                        <p><strong>Status:</strong> ${orc.status || 'Pendente'}</p>
                    </div>

                    ${orc.servicos && orc.servicos.length > 0 ? `
                    <h2>Serviços Contratados</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>Serviço</th>
                                <th>Quantidade</th>
                                <th>Valor Unit.</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${orc.servicos.map(s => `
                                <tr>
                                    <td>${s.nome || 'N/A'}</td>
                                    <td>${s.quantidade || 1}</td>
                                    <td>R$ ${(s.preco || 0).toFixed(2)}</td>
                                    <td>R$ ${((s.quantidade || 1) * (s.preco || 0)).toFixed(2)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    ` : ''}

                    ${orc.produtos && orc.produtos.length > 0 ? `
                    <h2>Produtos Inclusos</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>Produto</th>
                                <th>Quantidade</th>
                                <th>Valor Unit.</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${orc.produtos.map(p => `
                                <tr>
                                    <td>${p.nome || 'N/A'}</td>
                                    <td>${p.quantidade || 1}</td>
                                    <td>R$ ${(p.preco || 0).toFixed(2)}</td>
                                    <td>R$ ${((p.quantidade || 1) * (p.preco || 0)).toFixed(2)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    ` : ''}

                    <div style="text-align: right; margin-top: 30px;">
                        <p class="total">VALOR TOTAL: R$ ${(orc.total_final || 0).toFixed(2)}</p>
                        ${orc.desconto_global ? `<p>Desconto: R$ ${orc.desconto_global.toFixed(2)}</p>` : ''}
                        ${orc.cashback_valor ? `<p>Cashback: R$ ${orc.cashback_valor.toFixed(2)}</p>` : ''}
                    </div>

                    <div style="margin-top: 60px;">
                        <p><strong>Termos e Condições:</strong></p>
                        <p>${orc.observacoes || 'Contrato válido conforme termos gerais da empresa.'}</p>
                    </div>

                    <div style="margin-top: 80px; display: flex; justify-content: space-between;">
                        <div style="border-top: 1px solid #000; padding-top: 10px; width: 45%;">
                            <p style="text-align: center;">Assinatura do Cliente</p>
                        </div>
                        <div style="border-top: 1px solid #000; padding-top: 10px; width: 45%;">
                            <p style="text-align: center;">Assinatura BIOMA</p>
                        </div>
                    </div>

                    <button onclick="window.print()" style="margin-top: 20px; padding: 10px 20px; background: #7C3AED; color: white; border: none; border-radius: 8px; cursor: pointer;">Imprimir</button>
                </body>
                </html>
            `);
            printWindow.document.close();
        }
    } catch (error) {
        console.error('Erro ao imprimir contrato:', error);
        Swal.fire('Erro', 'Não foi possível gerar o contrato', 'error');
    }
}

function cancelarOrc(){
    orcamento={servicos:[],produtos:[]};
    profissionaisVinculados=[]; // Limpar profissionais vinculados
    limparCliente();
    document.getElementById('descontoGlobal').value='0';
    document.getElementById('cashbackPerc').value='0';
    document.getElementById('pagamento').value='Pix';
    document.getElementById('buscaProfissionalOrc').value=''; // Limpar campo de busca
    document.getElementById('profComissaoPerc').value='10'; // Reset comissão padrão
    atualizarTabelaServicos();
    atualizarTabelaProdutos();
    atualizarTabelaProfissionaisVinculados(); // Atualizar tabela de profissionais
    calcularTotais();
    const pageHeader=document.querySelector('#section-orcamento .page-header h1');
    if(pageHeader){pageHeader.innerHTML='<i class="bi bi-file-earmark-plus"></i> Novo Orçamento';}
    if(window.orcamentoEditandoId){delete window.orcamentoEditandoId;}
}

let chartServicos=null,chartFaturamento=null;
let assistentesCache=[];
let anamneseDef=null;
let prontuarioDef=null;
async function loadRelatorios(){
    const key = 'loadRelatorios';
    if (isLoading(key)) {
        console.warn(`⚠️ Já carregando: ${key}`);
        return;
    }
    setLoading(key, true);

    try{
        const res=await fetch('/api/orcamentos',{credentials:'include'});
        const data=await res.json();
        if(!data.success||!data.orcamentos)return;
        const orcamentos=data.orcamentos.filter(o=>o.status==='Aprovado');
        const faturamentoTotal=orcamentos.reduce((acc,o)=>acc+(o.total_final||0),0);
        document.getElementById('relFaturamentoTotal').textContent=`R$ ${faturamentoTotal.toFixed(0)}`;
        const mesAtual=new Date().getMonth();
        const anoAtual=new Date().getFullYear();
        const faturamentoMes=orcamentos.filter(o=>{const d=new Date(o.created_at);return d.getMonth()===mesAtual&&d.getFullYear()===anoAtual;}).reduce((acc,o)=>acc+o.total_final,0);
        document.getElementById('relFaturamentoMes').textContent=`R$ ${faturamentoMes.toFixed(0)}`;
        const cashbackTotal=orcamentos.reduce((acc,o)=>acc+(o.cashback_valor||0),0);
        document.getElementById('relCashbackTotal').textContent=`R$ ${cashbackTotal.toFixed(0)}`;
        const ticketMedio=orcamentos.length>0?faturamentoTotal/orcamentos.length:0;
        document.getElementById('relTicketMedio').textContent=`R$ ${ticketMedio.toFixed(0)}`;
        const servicosCount={};
        orcamentos.forEach(o=>{(o.servicos||[]).forEach(s=>{const key=s.nome;if(!servicosCount[key])servicosCount[key]={total:0,qtd:0};servicosCount[key].total+=s.total||0;servicosCount[key].qtd+=s.qtd||1;});});
        const topServicos=Object.entries(servicosCount).sort((a,b)=>b[1].total-a[1].total).slice(0,5);
        const ctxServicos=document.getElementById('chartServicos');
        if(chartServicos)chartServicos.destroy();
        if(topServicos.length>0){
            chartServicos=new Chart(ctxServicos,{type:'bar',data:{labels:topServicos.map(s=>s[0]),datasets:[{label:'Faturamento (R$)',data:topServicos.map(s=>s[1].total),backgroundColor:'rgba(124,58,237,0.8)',borderColor:'rgba(124,58,237,1)',borderWidth:2}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}}}});
        }
        const meses=[];
        const faturamentoMensal=[];
        for(let i=5;i>=0;i--){
            const d=new Date();
            d.setMonth(d.getMonth()-i);
            const mes=d.getMonth();
            const ano=d.getFullYear();
            meses.push(d.toLocaleDateString('pt-BR',{month:'short'}));
            const fat=orcamentos.filter(o=>{const od=new Date(o.created_at);return od.getMonth()===mes&&od.getFullYear()===ano;}).reduce((acc,o)=>acc+o.total_final,0);
            faturamentoMensal.push(fat);
        }
        const ctxFaturamento=document.getElementById('chartFaturamento');
        if(chartFaturamento)chartFaturamento.destroy();
        chartFaturamento=new Chart(ctxFaturamento,{type:'line',data:{labels:meses,datasets:[{label:'Faturamento (R$)',data:faturamentoMensal,backgroundColor:'rgba(16,185,129,0.2)',borderColor:'rgba(16,185,129,1)',borderWidth:3,fill:true,tension:0.4}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}}}});
        const resClientes=await fetch('/api/clientes',{credentials:'include'});
        const dataClientes=await resClientes.json();
        if(dataClientes.success&&dataClientes.clientes){
            const topClientes=dataClientes.clientes.sort((a,b)=>(b.total_gasto||0)-(a.total_gasto||0)).slice(0,10);
            const htmlClientes=topClientes.map((c,idx)=>`<tr><td><strong style="font-size:1.5rem;color:${idx===0?'#FFD700':idx===1?'#C0C0C0':idx===2?'#CD7F32':'var(--text-primary)'}">${idx+1}º</strong></td><td><strong>${c.nome}</strong></td><td><strong style="color:var(--success)">R$ ${(c.total_gasto||0).toFixed(2)}</strong></td><td>${c.total_visitas||0}</td><td>${c.ultima_visita?new Date(c.ultima_visita).toLocaleDateString('pt-BR'):'-'}</td></tr>`).join('');
            document.getElementById('topClientesBody').innerHTML=htmlClientes||'<tr><td colspan="5" class="text-center text-muted">Nenhum</td></tr>';
        }
        const produtosCount={};
        orcamentos.forEach(o=>{(o.produtos||[]).forEach(p=>{const key=p.nome;if(!produtosCount[key])produtosCount[key]={total:0,qtd:0};produtosCount[key].total+=p.total||0;produtosCount[key].qtd+=p.qtd||1;});});
        const topProdutos=Object.entries(produtosCount).sort((a,b)=>b[1].qtd-a[1].qtd).slice(0,10);
        if(topProdutos.length>0){
            const htmlProdutos=topProdutos.map(p=>`<tr><td><strong>${p[0]}</strong></td><td>${p[1].qtd}</td><td><strong>R$ ${p[1].total.toFixed(2)}</strong></td></tr>`).join('');
            document.getElementById('topProdutosBody').innerHTML=htmlProdutos;
        }else{
            document.getElementById('topProdutosBody').innerHTML='<tr><td colspan="3" class="text-center text-muted">Nenhum</td></tr>';
        }
    }catch(e){
        console.error('❌ Relatórios error:',e);
    } finally {
        setTimeout(() => setLoading(key, false), 1000);
    }
}

async function exportarRelatorio(){
    try{
        // Usar toast em vez de modal pesado
        toast('Preparando relatório Excel...', 'info');

        const response = await fetch('/api/relatorios/completo', {
            method: 'GET',
            credentials: 'include'
        });

        if(!response.ok){
            throw new Error('Erro ao gerar relatório');
        }

        // A API retorna JSON, não um arquivo Excel
        // Vamos usar SheetJS para gerar o Excel no frontend
        const data = await response.json();

        // Criar workbook
        const wb = XLSX.utils.book_new();

        // Criar planilha com dados gerais
        const wsData = [
            ['RELATÓRIO BIOMA - RESUMO GERAL'],
            [],
            ['Estatísticas Gerais'],
            ['Total Clientes', data.estatisticas?.total_clientes || 0],
            ['Total Produtos', data.estatisticas?.total_produtos || 0],
            ['Total Serviços', data.estatisticas?.total_servicos || 0],
            ['Total Profissionais', data.estatisticas?.total_profissionais || 0],
            [],
            ['Faturamento'],
            ['Faturamento Total', `R$ ${(data.faturamento?.total || 0).toFixed(2)}`],
            ['Faturamento Serviços', `R$ ${(data.faturamento?.servicos || 0).toFixed(2)}`],
            ['Faturamento Produtos', `R$ ${(data.faturamento?.produtos || 0).toFixed(2)}`],
            ['Ticket Médio', `R$ ${(data.vendas?.ticket_medio || 0).toFixed(2)}`],
            ['Taxa de Conversão', `${(data.vendas?.taxa_conversao || 0).toFixed(2)}%`]
        ];

        const ws = XLSX.utils.aoa_to_sheet(wsData);
        XLSX.utils.book_append_sheet(wb, ws, 'Resumo');

        // Adicionar planilha de top clientes se houver
        if(data.top_clientes && data.top_clientes.length > 0){
            const clientesData = [
                ['Top Clientes'],
                ['Nome', 'Total Gasto', 'Total Compras'],
                ...data.top_clientes.map(c => [
                    c.cliente_nome || 'N/A',
                    `R$ ${(c.total_gasto || 0).toFixed(2)}`,
                    c.total_compras || 0
                ])
            ];
            const wsClientes = XLSX.utils.aoa_to_sheet(clientesData);
            XLSX.utils.book_append_sheet(wb, wsClientes, 'Top Clientes');
        }

        // Nome do arquivo com data atual
        const dataAtual = new Date().toISOString().split('T')[0];
        const fileName = `relatorio_bioma_${dataAtual}.xlsx`;

        // Gerar arquivo Excel e baixar
        XLSX.writeFile(wb, fileName);

        toast('✅ Relatório exportado com sucesso!', 'success');

    }catch(e){
        console.error('❌ Erro ao exportar relatório:', e);
        toast('Erro ao exportar relatório', 'error');
    }
}

async function salvarConfig(){
    try{
        const payload = {
            nome_empresa: document.getElementById('cfgNome').value.trim(),
            cnpj: document.getElementById('cfgCNPJ').value.trim(),
            endereco: document.getElementById('cfgEndereco').value.trim(),
            telefone: document.getElementById('cfgTelefone').value.trim(),
            email: document.getElementById('cfgEmail').value.trim(),
            logo_url: logosPersonalizados.principal || '',
            logo_login_url: logosPersonalizados.login || ''
        };
        const res = await fetch('/api/config',{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            credentials:'include',
            body:JSON.stringify(payload)
        });
        const data = await res.json();
        if(data.success){
            configuracoesAtuais = Object.assign({}, configuracoesAtuais || {}, payload);
            Swal.fire({icon:'success',title:'Configurações salvas!',timer:2000});
        }else{
            throw new Error(data.message || 'Não foi possível salvar');
        }
    }catch(error){
        console.error('Erro ao salvar configurações', error);
        Swal.fire('Erro','Não foi possível salvar as configurações.','error');
    }
}

// Função para testar configuração de e-mail
async function testarEmailConfig() {
    const emailDestino = document.getElementById('emailTesteDestino')?.value?.trim();

    if (!emailDestino) {
        Swal.fire({
            icon: 'warning',
            title: 'E-mail Necessário',
            text: 'Por favor, digite um endereço de e-mail para enviar o teste.'
        });
        return;
    }

    // Validar formato de email
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(emailDestino)) {
        Swal.fire({
            icon: 'error',
            title: 'E-mail Inválido',
            text: 'Por favor, digite um endereço de e-mail válido.'
        });
        return;
    }

    try {
        // Mostrar loading
        Swal.fire({
            title: 'Enviando E-mail de Teste...',
            html: 'Por favor, aguarde enquanto o e-mail é enviado.',
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });

        const response = await fetch('/api/email/test', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ email: emailDestino })
        });

        const data = await response.json();

        if (data.success) {
            Swal.fire({
                icon: 'success',
                title: 'E-mail Enviado com Sucesso!',
                html: `
                    <p>✅ O e-mail de teste foi enviado para:</p>
                    <p><strong>${emailDestino}</strong></p>
                    <p class="text-muted">Verifique a caixa de entrada (e spam) do destinatário.</p>
                `,
                confirmButtonText: 'OK'
            });

            // Limpar campo
            document.getElementById('emailTesteDestino').value = '';

        } else {
            throw new Error(data.message || 'Erro ao enviar e-mail de teste');
        }

    } catch (error) {
        console.error('❌ Erro ao testar e-mail:', error);

        Swal.fire({
            icon: 'error',
            title: 'Erro ao Enviar E-mail',
            html: `
                <p>${error.message || 'Não foi possível enviar o e-mail de teste.'}</p>
                <hr>
                <p class="text-muted"><strong>Possíveis causas:</strong></p>
                <ul style="text-align: left; font-size: 0.9rem;">
                    <li>Configurações SMTP incorretas no arquivo .env</li>
                    <li>Credenciais de e-mail inválidas</li>
                    <li>Servidor SMTP bloqueando conexão</li>
                    <li>Porta SMTP incorreta ou bloqueada por firewall</li>
                </ul>
                <p class="text-muted">Verifique o console do servidor para mais detalhes.</p>
            `,
            confirmButtonText: 'Entendi'
        });
    }
}

function salvarConfigOp(){
    Swal.fire({icon:'success',title:'✅ Configurações operacionais salvas',timer:2000});
}

// ====== NOVAS FUNÇÕES - AUDITORIA E DASHBOARD ======

// Variáveis globais para auditoria
window.currentPageAuditoria = 1;
window.totalPagesAuditoria = 1;

// Função para carregar auditoria
async function loadAuditoria() {
    const key = 'loadAuditoria';
    if (isLoading(key)) {
        console.warn(`⚠️ Já carregando: ${key}`);
        return;
    }

    const tbody = document.getElementById('auditoriaTableBody');
    if (!tbody) return;

    setLoading(key, true);
    tbody.innerHTML = '<tr><td colspan="7" class="text-center"><div class="spinner"></div></td></tr>';

    try {
        const username = document.getElementById('auditoriaUsername')?.value || '';
        const acao = document.getElementById('auditoriaAcao')?.value || '';
        const entidade = document.getElementById('auditoriaEntidade')?.value || '';
        const dataInicio = document.getElementById('auditoriaDataInicio')?.value || '';
        const dataFim = document.getElementById('auditoriaDataFim')?.value || '';
        const page = window.currentPageAuditoria || 1;
        
        let url = `/api/auditoria?page=${page}&per_page=50`;
        if (username) url += `&username=${encodeURIComponent(username)}`;
        if (acao) url += `&acao=${acao}`;
        if (entidade) url += `&entidade=${entidade}`;
        if (dataInicio) url += `&data_inicio=${dataInicio}`;
        if (dataFim) url += `&data_fim=${dataFim}`;
        
        const res = await fetch(url, {credentials: 'include'});
        const data = await res.json();
        
        if (data.success && data.registros && data.registros.length > 0) {
            tbody.innerHTML = data.registros.map(r => `
                <tr>
                    <td>${formatarDataHora(r.timestamp)}</td>
                    <td><strong>${r.username}</strong></td>
                    <td><span class="badge ${getBadgeClassAcao(r.acao)}">${r.acao}</span></td>
                    <td>${r.entidade}</td>
                    <td><code style="font-size:0.8em">${r.entidade_id.substring(0, 8)}...</code></td>
                    <td><small>${r.ip || '-'}</small></td>
                    <td>
                        <button class="btn btn-sm btn-outline" onclick="verDetalhesAuditoria('${r._id}')" title="Ver detalhes">
                            <i class="bi bi-eye"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            
            // Atualizar paginação
            if (data.pagination) {
                window.totalPagesAuditoria = data.pagination.total_pages;
                window.currentPageAuditoria = data.pagination.page;
                
                const paginacaoDiv = document.getElementById('paginacaoAuditoria');
                const infoPagina = document.getElementById('infoPaginaAuditoria');
                
                if (paginacaoDiv && infoPagina) {
                    paginacaoDiv.style.display = 'flex';
                    infoPagina.textContent = `Página ${data.pagination.page} de ${data.pagination.total_pages} (${data.pagination.total} registros)`;
                }
            }
            
            // Atualizar estatísticas
            if (data.stats) {
                document.getElementById('auditoriaStats').style.display = 'flex';
                document.getElementById('auditoriaTotalAcoes').textContent = data.stats.total_acoes || 0;
                document.getElementById('auditoriaUsuariosAtivos').textContent = data.stats.usuarios_ativos?.length || 0;
                
                if (data.stats.acoes_por_tipo && data.stats.acoes_por_tipo.length > 0) {
                    document.getElementById('auditoriaPrincipalAcao').textContent = data.stats.acoes_por_tipo[0]._id || '-';
                } else {
                    document.getElementById('auditoriaPrincipalAcao').textContent = '-';
                }
            }
        } else {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">Nenhum registro de auditoria encontrado</td></tr>';
            document.getElementById('paginacaoAuditoria')?.style.setProperty('display', 'none', 'important');
            document.getElementById('auditoriaStats').style.display = 'none';
        }
    } catch (error) {
        console.error('Erro ao carregar auditoria:', error);
        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-danger">Erro ao carregar registros de auditoria</td></tr>';
    } finally {
        setTimeout(() => setLoading(key, false), 1000);
    }
}

async function loadClube(){
    const key = 'loadClube';
    if (isLoading(key)) {
        console.warn(`⚠️ Já carregando: ${key}`);
        return;
    }
    setLoading(key, true);

    try{
        // A seção de clube é estática (HTML puro), não precisa carregar dados do backend
        // Esta função existe apenas para manter consistência
        console.log('📢 Seção Comunidade carregada');
    } finally {
        setTimeout(() => setLoading(key, false), 100);
    }
}

// Função auxiliar para badge de ação
function getBadgeClassAcao(acao) {
    const classes = {
        'criar': 'success',
        'editar': 'warning',
        'deletar': 'danger',
        'aprovar': 'success',
        'rejeitar': 'danger'
    };
    return classes[acao] || 'neutral';
}

// Função para mudar página de auditoria
function mudarPaginaAuditoria(direcao) {
    const currentPage = window.currentPageAuditoria || 1;
    const totalPages = window.totalPagesAuditoria || 1;
    
    let newPage = currentPage + direcao;
    if (newPage < 1) newPage = 1;
    if (newPage > totalPages) newPage = totalPages;
    
    window.currentPageAuditoria = newPage;
    loadAuditoria();
}

// Função para ver detalhes de auditoria
async function verDetalhesAuditoria(id) {
    // Implementação simplificada - pode ser expandida
    if (window.Swal) {
        Swal.fire({
            icon: 'info',
            title: 'Detalhes da Auditoria',
            text: `Registro ID: ${id}`,
            html: '<p>Funcionalidade completa em desenvolvimento</p>'
        });
    }
}

// Função para atualizar dashboard com stats em tempo real
let dashboardRealtimeInterval = null;

async function startDashboardRealtime() {
    // Limpar intervalo anterior se existir
    if (dashboardRealtimeInterval) {
        clearInterval(dashboardRealtimeInterval);
    }
    
    // Primeira execução imediata
    await updateDashboardRealtime();

    // Atualizar a cada 60 segundos (otimizado para reduzir carga)
    dashboardRealtimeInterval = setInterval(updateDashboardRealtime, 60000);
}

async function updateDashboardRealtime() {
    try {
        const res = await fetch('/api/dashboard/stats/realtime', {credentials: 'include'});
        const data = await res.json();
        
        if (data.success && data.stats) {
            const stats = data.stats;
            
            // Atualizar cards do dashboard (se existirem)
            const updateElement = (id, value) => {
                const el = document.getElementById(id);
                if (el) el.textContent = value;
            };
            
            // Totais
            updateElement('totalClientes', stats.totais?.clientes || 0);
            updateElement('totalProfissionais', stats.totais?.profissionais || 0);
            updateElement('totalProdutos', stats.totais?.produtos || 0);
            
            // Faturamento
            if (stats.faturamento) {
                updateElement('faturamentoMes', formatarMoeda(stats.faturamento.mes));
                updateElement('faturamentoHoje', formatarMoeda(stats.faturamento.hoje));
                updateElement('ticketMedio', formatarMoeda(stats.faturamento.ticket_medio));
            }
            
            // Pendências - adicionar badge com contador se houver
            if (stats.pendencias && stats.pendencias.total > 0) {
                const menuEstoque = document.getElementById('menu-estoque');
                if (menuEstoque && !menuEstoque.querySelector('.badge')) {
                    const badge = document.createElement('span');
                    badge.className = 'badge badge-sm bg-danger ms-2';
                    badge.textContent = stats.pendencias.total;
                    badge.style.cssText = 'padding: 4px 8px; border-radius: 10px; font-size: 0.7em;';
                    menuEstoque.appendChild(badge);
                }
            }
            
            // Log para debug
            console.log('%c📊 Dashboard atualizado', 'color:#10B981;font-weight:bold', new Date().toLocaleTimeString());
        }
    } catch (error) {
        console.error('Erro ao atualizar dashboard em tempo real:', error);
    }
}

// Parar atualização automática quando sair do dashboard
function stopDashboardRealtime() {
    if (dashboardRealtimeInterval) {
        clearInterval(dashboardRealtimeInterval);
        dashboardRealtimeInterval = null;
    }
}

// ====== FUNÇÕES DE FOTO DE PROFISSIONAIS ======

/**
 * Exibir foto do profissional ou avatar padrão
 */
function exibirFotoProfissional(fotoUrl) {
    if (fotoUrl && fotoUrl !== '') {
        return `<img src="${fotoUrl}" alt="Foto" style="width:45px;height:45px;border-radius:50%;object-fit:cover;border:2px solid var(--primary);">`;
    } else {
        return `<div style="width:45px;height:45px;border-radius:50%;background:linear-gradient(135deg,#7C3AED,#EC4899);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:1.2rem;"><i class="bi bi-person"></i></div>`;
    }
}

/**
 * Validação de imagem para upload
 * @param {File} file - Arquivo de imagem
 * @param {Object} options - Opções de validação
 * @returns {Object} - {valid: boolean, error: string}
 */
function validarImagemUpload(file, options = {}) {
    const config = {
        maxSizeMB: options.maxSizeMB || 5,
        allowedTypes: options.allowedTypes || ['image/jpeg', 'image/jpg', 'image/png', 'image/webp', 'image/gif'],
        ...options
    };

    // Validar se arquivo existe
    if (!file) {
        return { valid: false, error: 'Nenhum arquivo selecionado' };
    }

    // Validar tipo de arquivo
    if (!config.allowedTypes.includes(file.type.toLowerCase())) {
        const tipos = config.allowedTypes.map(t => t.split('/')[1].toUpperCase()).join(', ');
        return {
            valid: false,
            error: `Formato não permitido. Use: ${tipos}`
        };
    }

    // Validar tamanho
    const sizeMB = file.size / (1024 * 1024);
    if (sizeMB > config.maxSizeMB) {
        return {
            valid: false,
            error: `Arquivo muito grande (${sizeMB.toFixed(2)}MB). Máximo: ${config.maxSizeMB}MB`
        };
    }

    return {
        valid: true,
        fileInfo: {
            name: file.name,
            size: sizeMB.toFixed(2) + 'MB',
            type: file.type.split('/')[1].toUpperCase()
        }
    };
}

/**
 * Formatar bytes para formato legível
 */
function formatarTamanhoArquivo(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round((bytes / Math.pow(k, i)) * 100) / 100 + ' ' + sizes[i];
}

// ========== BIBLIOTECA DE EXPORTAÇÃO ==========

/**
 * Biblioteca unificada para exportação de dados
 * Suporta: Excel (XLSX), CSV, PDF
 */
const ExportLibrary = {
    /**
     * Exportar dados para CSV
     * @param {Array} data - Array de objetos com os dados
     * @param {Array} columns - Array de objetos {key: 'campo', label: 'Label'}
     * @param {String} filename - Nome do arquivo
     */
    toCSV: function(data, columns, filename) {
        if (!data || data.length === 0) {
            Swal.fire('Atenção', 'Nenhum dado disponível para exportar', 'warning');
            return;
        }

        // BOM UTF-8 para Excel reconhecer acentos
        let csv = '\uFEFF';

        // Cabeçalhos
        csv += columns.map(col => col.label).join(';') + '\n';

        // Dados
        data.forEach(row => {
            const line = columns.map(col => {
                let value = row[col.key] ?? '';

                // Tratar tipos especiais
                if (typeof value === 'object' && value !== null) {
                    value = JSON.stringify(value);
                }

                // Escapar ponto e vírgula
                value = String(value).replace(/;/g, ',');

                return value;
            }).join(';');

            csv += line + '\n';
        });

        // Download
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `${filename}_${new Date().toISOString().split('T')[0]}.csv`;
        link.click();
        URL.revokeObjectURL(link.href);

        // Toast notification simples sem bloquear
        console.log(`✅ CSV exportado: ${data.length} registros`);

        const toast = document.createElement('div');
        toast.style.cssText = 'position:fixed;top:20px;right:20px;background:linear-gradient(135deg,#3B82F6,#2563EB);color:white;padding:16px 24px;border-radius:12px;box-shadow:0 8px 25px rgba(59,130,246,0.4);z-index:99999;font-weight:700;animation:slideInRight 0.4s ease;';
        toast.innerHTML = `<i class="bi bi-check-circle-fill"></i> CSV exportado! (${data.length} registros)`;
        document.body.appendChild(toast);

        setTimeout(() => {
            toast.style.animation = 'slideOutRight 0.4s ease';
            setTimeout(() => toast.remove(), 400);
        }, 2500);
    },

    /**
     * Exportar dados para Excel usando biblioteca SheetJS
     * @param {Array} data - Array de objetos com os dados
     * @param {Array} columns - Array de objetos {key: 'campo', label: 'Label'}
     * @param {String} filename - Nome do arquivo
     * @param {String} sheetName - Nome da planilha
     */
    toExcel: async function(data, columns, filename, sheetName = 'Dados') {
        if (!data || data.length === 0) {
            Swal.fire('Atenção', 'Nenhum dado disponível para exportar', 'warning');
            return;
        }

        try {
            // Preparar dados no formato de tabela
            const tableData = [];

            // Cabeçalhos
            tableData.push(columns.map(col => col.label));

            // Dados
            data.forEach(row => {
                const rowData = columns.map(col => {
                    let value = row[col.key] ?? '';

                    // Formatar datas
                    if (col.type === 'date' && value) {
                        value = new Date(value).toLocaleDateString('pt-BR');
                    }
                    // Formatar moeda
                    else if (col.type === 'currency' && value) {
                        value = 'R$ ' + Number(value).toLocaleString('pt-BR', {
                            minimumFractionDigits: 2,
                            maximumFractionDigits: 2
                        });
                    }
                    // Formatar boolean
                    else if (col.type === 'boolean') {
                        value = value ? 'Sim' : 'Não';
                    }

                    return value;
                });
                tableData.push(rowData);
            });

            // Criar workbook com SheetJS (biblioteca já carregada globalmente)
            if (typeof XLSX === 'undefined') {
                throw new Error('Biblioteca XLSX não carregada');
            }

            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(tableData);

            // Estilizar cabeçalho (largura das colunas)
            const wscols = columns.map(col => ({ wch: col.width || 15 }));
            ws['!cols'] = wscols;

            XLSX.utils.book_append_sheet(wb, ws, sheetName);

            // Gerar arquivo
            XLSX.writeFile(wb, `${filename}_${new Date().toISOString().split('T')[0]}.xlsx`);

            // Mensagem de sucesso toast (não bloqueia)
            console.log(`✅ Excel exportado: ${data.length} registros`);

            // Toast notification simples sem bloquear
            const toast = document.createElement('div');
            toast.style.cssText = 'position:fixed;top:20px;right:20px;background:linear-gradient(135deg,#10B981,#059669);color:white;padding:16px 24px;border-radius:12px;box-shadow:0 8px 25px rgba(16,185,129,0.4);z-index:99999;font-weight:700;animation:slideInRight 0.4s ease;';
            toast.innerHTML = `<i class="bi bi-check-circle-fill"></i> Excel exportado! (${data.length} registros)`;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'slideOutRight 0.4s ease';
                setTimeout(() => toast.remove(), 400);
            }, 2500);

        } catch (error) {
            console.error('Erro ao gerar Excel:', error);
            Swal.fire('Erro', 'Não foi possível gerar o arquivo Excel', 'error');
        }
    },

    /**
     * Exportar tabela HTML existente para CSV
     * @param {String} tableId - ID da tabela HTML
     * @param {String} filename - Nome do arquivo
     */
    tableToCSV: function(tableId, filename) {
        const table = document.getElementById(tableId);
        if (!table) {
            Swal.fire('Erro', 'Tabela não encontrada', 'error');
            return;
        }

        const rows = table.querySelectorAll('tr');
        if (rows.length <= 1) {
            Swal.fire('Atenção', 'Nenhum dado na tabela para exportar', 'warning');
            return;
        }

        let csv = '\uFEFF'; // BOM UTF-8

        rows.forEach((row, index) => {
            const cells = row.querySelectorAll(index === 0 ? 'th' : 'td');
            const line = Array.from(cells).map(cell => {
                return cell.textContent.trim().replace(/;/g, ',');
            }).join(';');
            csv += line + '\n';
        });

        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `${filename}_${new Date().toISOString().split('T')[0]}.csv`;
        link.click();
        URL.revokeObjectURL(link.href);

        // Toast notification simples sem bloquear
        console.log(`✅ CSV exportado da tabela`);

        const toast = document.createElement('div');
        toast.style.cssText = 'position:fixed;top:20px;right:20px;background:linear-gradient(135deg,#3B82F6,#2563EB);color:white;padding:16px 24px;border-radius:12px;box-shadow:0 8px 25px rgba(59,130,246,0.4);z-index:99999;font-weight:700;animation:slideInRight 0.4s ease;';
        toast.innerHTML = `<i class="bi bi-check-circle-fill"></i> CSV exportado!`;
        document.body.appendChild(toast);

        setTimeout(() => {
            toast.style.animation = 'slideOutRight 0.4s ease';
            setTimeout(() => toast.remove(), 400);
        }, 2500);
    }
};

// ========== FIM BIBLIOTECA DE EXPORTAÇÃO ==========

// ========== FUNÇÕES DE EXPORTAÇÃO ESPECÍFICAS ==========

/**
 * Exportar Orçamentos para Excel
 */
async function exportarOrcamentosExcel() {
    try {
        const res = await fetch('/api/orcamentos', { credentials: 'include' });
        const data = await res.json();

        if (!data.success || !data.orcamentos || data.orcamentos.length === 0) {
            Swal.fire('Atenção', 'Nenhum orçamento disponível para exportar', 'info');
            return;
        }

        const columns = [
            { key: 'numero', label: 'Número', width: 10 },
            { key: 'cliente_nome', label: 'Cliente', width: 25 },
            { key: 'created_at', label: 'Data', type: 'date', width: 12 },
            { key: 'profissional_nome', label: 'Profissional', width: 25 },
            { key: 'total_servicos', label: 'Total Serviços', type: 'currency', width: 15 },
            { key: 'total_produtos', label: 'Total Produtos', type: 'currency', width: 15 },
            { key: 'desconto', label: 'Desconto', type: 'currency', width: 12 },
            { key: 'total_final', label: 'Total Final', type: 'currency', width: 15 },
            { key: 'status', label: 'Status', width: 12 }
        ];

        await ExportLibrary.toExcel(data.orcamentos, columns, 'orcamentos_bioma', 'Orçamentos');
    } catch (error) {
        console.error('Erro ao exportar orçamentos:', error);
        Swal.fire('Erro', 'Não foi possível exportar os orçamentos', 'error');
    }
}

/**
 * Exportar Orçamentos para CSV
 */
async function exportarOrcamentosCSV() {
    try {
        const res = await fetch('/api/orcamentos', { credentials: 'include' });
        const data = await res.json();

        if (!data.success || !data.orcamentos || data.orcamentos.length === 0) {
            Swal.fire('Atenção', 'Nenhum orçamento disponível para exportar', 'info');
            return;
        }

        const columns = [
            { key: 'numero', label: 'Número' },
            { key: 'cliente_nome', label: 'Cliente' },
            { key: 'created_at', label: 'Data' },
            { key: 'profissional_nome', label: 'Profissional' },
            { key: 'total_final', label: 'Total Final' },
            { key: 'status', label: 'Status' }
        ];

        ExportLibrary.toCSV(data.orcamentos, columns, 'orcamentos_bioma');
    } catch (error) {
        console.error('Erro ao exportar orçamentos:', error);
        Swal.fire('Erro', 'Não foi possível exportar os orçamentos', 'error');
    }
}

/**
 * Exportar Serviços para Excel/CSV
 */
async function exportarServicos(formato = 'excel') {
    try {
        const res = await fetch('/api/servicos', { credentials: 'include' });
        const data = await res.json();

        if (!data.success || !data.servicos || data.servicos.length === 0) {
            Swal.fire('Atenção', 'Nenhum serviço disponível para exportar', 'info');
            return;
        }

        const columns = [
            { key: 'nome', label: 'Nome do Serviço', width: 30 },
            { key: 'categoria', label: 'Categoria', width: 15 },
            { key: 'tamanho', label: 'Tamanho', width: 12 },
            { key: 'preco', label: 'Preço', type: 'currency', width: 15 },
            { key: 'duracao', label: 'Duração (min)', width: 12 },
            { key: 'ativo', label: 'Ativo', type: 'boolean', width: 10 }
        ];

        if (formato === 'excel') {
            await ExportLibrary.toExcel(data.servicos, columns, 'servicos_bioma', 'Serviços');
        } else {
            ExportLibrary.toCSV(data.servicos, columns, 'servicos_bioma');
        }
    } catch (error) {
        console.error('Erro ao exportar serviços:', error);
        Swal.fire('Erro', 'Não foi possível exportar os serviços', 'error');
    }
}

/**
 * Exportar Produtos para Excel/CSV
 */
async function exportarProdutos(formato = 'excel') {
    try {
        const res = await fetch('/api/produtos', { credentials: 'include' });
        const data = await res.json();

        if (!data.success || !data.produtos || data.produtos.length === 0) {
            Swal.fire('Atenção', 'Nenhum produto disponível para exportar', 'info');
            return;
        }

        const columns = [
            { key: 'nome', label: 'Nome do Produto', width: 30 },
            { key: 'marca', label: 'Marca', width: 20 },
            { key: 'preco', label: 'Preço', type: 'currency', width: 15 },
            { key: 'estoque', label: 'Estoque', width: 10 },
            { key: 'estoque_minimo', label: 'Estoque Mínimo', width: 15 },
            { key: 'ativo', label: 'Ativo', type: 'boolean', width: 10 }
        ];

        if (formato === 'excel') {
            await ExportLibrary.toExcel(data.produtos, columns, 'produtos_bioma', 'Produtos');
        } else {
            ExportLibrary.toCSV(data.produtos, columns, 'produtos_bioma');
        }
    } catch (error) {
        console.error('Erro ao exportar produtos:', error);
        Swal.fire('Erro', 'Não foi possível exportar os produtos', 'error');
    }
}

/**
 * Exportar Clientes para Excel/CSV
 */
async function exportarClientes(formato = 'excel') {
    try {
        const res = await fetch('/api/clientes', { credentials: 'include' });
        const data = await res.json();

        if (!data.success || !data.clientes || data.clientes.length === 0) {
            Swal.fire('Atenção', 'Nenhum cliente disponível para exportar', 'info');
            return;
        }

        const columns = [
            { key: 'nome', label: 'Nome', width: 30 },
            { key: 'telefone', label: 'Telefone', width: 15 },
            { key: 'email', label: 'E-mail', width: 30 },
            { key: 'cpf', label: 'CPF', width: 15 },
            { key: 'data_nascimento', label: 'Data Nascimento', type: 'date', width: 15 },
            { key: 'endereco', label: 'Endereço', width: 35 }
        ];

        if (formato === 'excel') {
            await ExportLibrary.toExcel(data.clientes, columns, 'clientes_bioma', 'Clientes');
        } else {
            ExportLibrary.toCSV(data.clientes, columns, 'clientes_bioma');
        }
    } catch (error) {
        console.error('Erro ao exportar clientes:', error);
        Swal.fire('Erro', 'Não foi possível exportar os clientes', 'error');
    }
}

/**
 * Exportar Profissionais para Excel/CSV
 */
async function exportarProfissionais(formato = 'excel') {
    try {
        const res = await fetch('/api/profissionais', { credentials: 'include' });
        const data = await res.json();

        if (!data.success || !data.profissionais || data.profissionais.length === 0) {
            Swal.fire('Atenção', 'Nenhum profissional disponível para exportar', 'info');
            return;
        }

        const columns = [
            { key: 'nome', label: 'Nome', width: 30 },
            { key: 'especialidade', label: 'Especialidade', width: 25 },
            { key: 'telefone', label: 'Telefone', width: 15 },
            { key: 'email', label: 'E-mail', width: 30 },
            { key: 'comissao_padrao', label: 'Comissão Padrão (%)', width: 18 },
            { key: 'ativo', label: 'Ativo', type: 'boolean', width: 10 }
        ];

        if (formato === 'excel') {
            await ExportLibrary.toExcel(data.profissionais, columns, 'profissionais_bioma', 'Profissionais');
        } else {
            ExportLibrary.toCSV(data.profissionais, columns, 'profissionais_bioma');
        }
    } catch (error) {
        console.error('Erro ao exportar profissionais:', error);
        Swal.fire('Erro', 'Não foi possível exportar os profissionais', 'error');
    }
}

// ========== FIM FUNÇÕES DE EXPORTAÇÃO ESPECÍFICAS ==========

/**
 * Upload de foto para profissional
 */
async function uploadFotoProfissional(profissionalId) {
    const {value: file} = await Swal.fire({
        title: 'Upload de Foto Profissional',
        html: `
            <div style="text-align:center;padding:20px;">
                <label for="fotoInput" style="cursor:pointer;display:block;margin-bottom:15px;">
                    <div id="uploadArea" style="width:180px;height:180px;margin:0 auto;border-radius:50%;border:3px dashed var(--primary);display:flex;align-items:center;justify-content:center;background:var(--bg-main);transition:all 0.3s;position:relative;overflow:hidden;">
                        <i class="bi bi-camera" id="cameraIcon" style="font-size:3.5rem;color:var(--primary);"></i>
                        <img id="fotoPreview" style="display:none;width:100%;height:100%;object-fit:cover;">
                    </div>
                    <p style="margin-top:15px;color:var(--text-secondary);font-weight:600;">
                        <i class="bi bi-cloud-upload"></i> Clique para selecionar
                    </p>
                </label>
                <input type="file" id="fotoInput" accept="image/jpeg,image/jpg,image/png,image/webp,image/gif" style="display:none;">
                <div id="fileInfo" style="display:none;margin-top:15px;padding:15px;background:var(--bg-secondary);border-radius:10px;text-align:left;">
                    <p style="margin:5px 0;color:var(--text-primary);"><strong><i class="bi bi-file-earmark-image"></i> Arquivo:</strong> <span id="fileName"></span></p>
                    <p style="margin:5px 0;color:var(--text-primary);"><strong><i class="bi bi-hdd"></i> Tamanho:</strong> <span id="fileSize"></span></p>
                    <p style="margin:5px 0;color:var(--text-primary);"><strong><i class="bi bi-filetype-jpg"></i> Tipo:</strong> <span id="fileType"></span></p>
                </div>
                <p style="margin-top:15px;font-size:0.85rem;color:var(--text-muted);">
                    <i class="bi bi-info-circle"></i> Formatos: JPG, PNG, WebP, GIF | Máximo: 5MB
                </p>
            </div>
        `,
        width: '500px',
        showCancelButton: true,
        confirmButtonText: '<i class="bi bi-upload"></i> Enviar Foto',
        cancelButtonText: '<i class="bi bi-x-circle"></i> Cancelar',
        confirmButtonColor: '#7C3AED',
        cancelButtonColor: '#6c757d',
        didOpen: () => {
            const input = document.getElementById('fotoInput');
            const uploadArea = document.getElementById('uploadArea');

            // Click no label
            uploadArea.parentElement.addEventListener('click', () => input.click());

            // Preview e validação ao selecionar
            input.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;

                // Validar imagem
                const validation = validarImagemUpload(file, { maxSizeMB: 5 });

                if (!validation.valid) {
                    Swal.showValidationMessage(validation.error);
                    input.value = '';
                    return;
                }

                // Mostrar preview
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('cameraIcon').style.display = 'none';
                    const preview = document.getElementById('fotoPreview');
                    preview.src = e.target.result;
                    preview.style.display = 'block';

                    // Mostrar info do arquivo
                    document.getElementById('fileName').textContent = validation.fileInfo.name;
                    document.getElementById('fileSize').textContent = validation.fileInfo.size;
                    document.getElementById('fileType').textContent = validation.fileInfo.type;
                    document.getElementById('fileInfo').style.display = 'block';
                };
                reader.readAsDataURL(file);
            });
        },
        preConfirm: () => {
            const fileInput = document.getElementById('fotoInput');
            if (!fileInput.files || fileInput.files.length === 0) {
                Swal.showValidationMessage('Selecione uma imagem primeiro');
                return false;
            }

            // Validar novamente
            const validation = validarImagemUpload(fileInput.files[0], { maxSizeMB: 5 });
            if (!validation.valid) {
                Swal.showValidationMessage(validation.error);
                return false;
            }

            return fileInput.files[0];
        }
    });

    if (file) {
        const formData = new FormData();
        formData.append('foto', file);
        formData.append('profissional_id', profissionalId);

        try {
            // Modal com progress bar
            Swal.fire({
                title: 'Enviando Foto...',
                html: `
                    <div style="padding:20px;">
                        <div style="margin-bottom:15px;">
                            <div style="width:100%;height:30px;background:var(--bg-secondary);border-radius:15px;overflow:hidden;position:relative;">
                                <div id="progressBar" style="width:0%;height:100%;background:linear-gradient(90deg,#7C3AED,#EC4899);transition:width 0.3s;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:0.9rem;"></div>
                            </div>
                        </div>
                        <p id="progressText" style="color:var(--text-secondary);margin-top:10px;">Iniciando upload...</p>
                    </div>
                `,
                allowOutsideClick: false,
                showConfirmButton: false
            });

            // Upload com XMLHttpRequest para ter progress
            const xhr = new XMLHttpRequest();

            xhr.upload.addEventListener('progress', (e) => {
                if (e.lengthComputable) {
                    const percentComplete = Math.round((e.loaded / e.total) * 100);
                    const progressBar = document.getElementById('progressBar');
                    const progressText = document.getElementById('progressText');

                    if (progressBar) {
                        progressBar.style.width = percentComplete + '%';
                        progressBar.textContent = percentComplete + '%';
                    }
                    if (progressText) {
                        progressText.textContent = `Enviando... ${formatarTamanhoArquivo(e.loaded)} de ${formatarTamanhoArquivo(e.total)}`;
                    }
                }
            });

            xhr.addEventListener('load', () => {
                if (xhr.status === 200) {
                    const data = JSON.parse(xhr.responseText);
                    if (data.success) {
                        Swal.fire({
                            icon: 'success',
                            title: 'Foto Enviada!',
                            text: 'A foto do profissional foi atualizada com sucesso',
                            timer: 2000,
                            showConfirmButton: false
                        });
                        loadProfissionais(); // Recarregar lista
                    } else {
                        Swal.fire('Erro', data.message || 'Falha no upload', 'error');
                    }
                } else {
                    Swal.fire('Erro', 'Erro ao enviar foto (HTTP ' + xhr.status + ')', 'error');
                }
            });

            xhr.addEventListener('error', () => {
                Swal.fire('Erro', 'Falha na conexão durante o upload', 'error');
            });

            xhr.open('POST', '/api/upload/foto-profissional');
            xhr.setRequestHeader('Accept', 'application/json');
            xhr.withCredentials = true;
            xhr.send(formData);

        } catch (error) {
            console.error('Erro no upload:', error);
            Swal.fire('Erro', 'Não foi possível enviar a foto', 'error');
        }
    }
}

/**
 * Preview da foto antes do upload
 */
function previewFotoUpload(event) {
    const file = event.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('previewContainer').style.display = 'block';
            document.getElementById('fotoPreview').src = e.target.result;
        };
        reader.readAsDataURL(file);
    }
}

// ====== FUNÇÕES DE MÚLTIPLOS PROFISSIONAIS EM ORÇAMENTOS ======

// Arrays globais para orçamento
let profissionaisVinculados = [];
let profissionalSelecionado = null;

/**
 * Buscar profissionais e assistentes para vincular ao orçamento
 */
async function buscarProfissionaisOrcamento() {
    const termo = document.getElementById('buscaProfissionalOrc').value;
    if (termo.length < 2) {
        document.getElementById('profissionalOrcResults').style.display = 'none';
        return;
    }

    try {
        // Buscar profissionais
        const resProf = await fetch('/api/profissionais', {credentials: 'include'});
        const dataProf = await resProf.json();
        
        // Buscar assistentes
        const resAsst = await fetch('/api/assistentes', {credentials: 'include'});
        const dataAsst = await resAsst.json();

        const profissionais = dataProf.profissionais || [];
        const assistentes = dataAsst.assistentes || [];
        
        const todos = [
            ...profissionais.map(p => ({...p, tipo: 'profissional'})),
            ...assistentes.map(a => ({...a, tipo: 'assistente'}))
        ];

        const filtrados = todos.filter(p => 
            p.nome.toLowerCase().includes(termo.toLowerCase())
        );

        const resultsDiv = document.getElementById('profissionalOrcResults');
        if (filtrados.length === 0) {
            resultsDiv.innerHTML = '<div class="autocomplete-item">Nenhum resultado encontrado</div>';
        } else {
            resultsDiv.innerHTML = filtrados.map(p => `
                <div class="autocomplete-item" onclick='selecionarProfissionalOrcamento(${JSON.stringify(p).replace(/'/g, "&apos;")})'>
                    <div style="display:flex;align-items:center;gap:10px;">
                        ${exibirFotoProfissional(p.foto || p.foto_url)}
                        <div>
                            <strong>${p.nome}</strong><br>
                            <small style="color:var(--text-secondary);">
                                ${p.tipo === 'profissional' ? '👨‍⚕️ Profissional' : '👤 Assistente'} | 
                                Comissão: ${p.comissao_perc || 10}%
                            </small>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        resultsDiv.style.display = 'block';
    } catch (error) {
        console.error('Erro ao buscar profissionais:', error);
    }
}

/**
 * Selecionar profissional do autocomplete
 */
function selecionarProfissionalOrcamento(prof) {
    profissionalSelecionado = prof;
    document.getElementById('buscaProfissionalOrc').value = prof.nome;
    document.getElementById('profComissaoPerc').value = prof.comissao_perc || 10;
    document.getElementById('profissionalOrcResults').style.display = 'none';
}

/**
 * Adicionar profissional à lista de vinculados
 */
function addProfissionalOrcamento() {
    if (!profissionalSelecionado) {
        Swal.fire('Atenção', 'Selecione um profissional primeiro', 'warning');
        return;
    }

    const comissaoPerc = parseFloat(document.getElementById('profComissaoPerc').value);
    
    if (isNaN(comissaoPerc) || comissaoPerc < 0 || comissaoPerc > 100) {
        Swal.fire('Atenção', 'Comissão deve estar entre 0% e 100%', 'warning');
        return;
    }

    // Verificar se já está na lista
    if (profissionaisVinculados.find(p => p.id === profissionalSelecionado._id)) {
        Swal.fire('Atenção', 'Este profissional já está vinculado ao orçamento', 'warning');
        return;
    }

    profissionaisVinculados.push({
        id: profissionalSelecionado._id,
        nome: profissionalSelecionado.nome,
        tipo: profissionalSelecionado.tipo,
        foto: profissionalSelecionado.foto || profissionalSelecionado.foto_url || '',
        comissao_perc: comissaoPerc
    });

    atualizarTabelaProfissionaisVinculados();
    
    // Limpar campos
    document.getElementById('buscaProfissionalOrc').value = '';
    document.getElementById('profComissaoPerc').value = '10';
    profissionalSelecionado = null;

    Swal.fire({
        icon: 'success',
        title: 'Adicionado!',
        text: `${profissionaisVinculados[profissionaisVinculados.length - 1].nome} foi vinculado ao orçamento`,
        timer: 1500,
        showConfirmButton: false
    });
}

/**
 * Atualizar tabela de profissionais vinculados
 */
function atualizarTabelaProfissionaisVinculados() {
    const tbody = document.getElementById('profissionaisVinculadosBody');
    
    if (profissionaisVinculados.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Nenhum profissional vinculado</td></tr>';
        return;
    }

    const totalOrcamento = calcularTotalOrcamentoBase();

    tbody.innerHTML = profissionaisVinculados.map((prof, idx) => {
        const valorComissao = (totalOrcamento * prof.comissao_perc) / 100;
        const fotoHtml = exibirFotoProfissional(prof.foto);

        return `
            <tr>
                <td>${fotoHtml}</td>
                <td><strong>${prof.nome}</strong></td>
                <td><span class="badge ${prof.tipo === 'profissional' ? 'success' : 'neutral'}">
                    ${prof.tipo === 'profissional' ? '👨‍⚕️ Profissional' : '👤 Assistente'}
                </span></td>
                <td>${prof.comissao_perc}%</td>
                <td><strong style="color:var(--success);">R$ ${valorComissao.toFixed(2)}</strong></td>
                <td>
                    <button class="btn btn-sm btn-danger" onclick="removerProfissionalVinculado(${idx})" title="Remover">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>
            </tr>
        `;
    }).join('');
}

/**
 * Remover profissional vinculado
 */
function removerProfissionalVinculado(index) {
    const nome = profissionaisVinculados[index].nome;
    profissionaisVinculados.splice(index, 1);
    atualizarTabelaProfissionaisVinculados();
    
    Swal.fire({
        icon: 'info',
        title: 'Removido',
        text: `${nome} foi desvinculado do orçamento`,
        timer: 1500,
        showConfirmButton: false
    });
}

/**
 * Calcular total base do orçamento (para comissões)
 */
function calcularTotalOrcamentoBase() {
    const subtotalServicos = orcamento.servicos.reduce((sum, s) => sum + (s.total || 0), 0);
    const subtotalProdutos = orcamento.produtos.reduce((sum, p) => sum + (p.total || 0), 0);
    const descontoGlobal = parseFloat(document.getElementById('descontoGlobal')?.value || 0);
    const subtotal = subtotalServicos + subtotalProdutos;
    return subtotal - (subtotal * descontoGlobal / 100);
}

// ====== FIM NOVAS FUNÇÕES ======

function salvarConfigOp(){
    Swal.fire({icon:'info',title:'Configurações operacionais',text:'Valores registrados localmente. Ajuste manualmente horários e comissões conforme necessidade.'});
}

console.log('%c✅ BIOMA v4.0 COMPLETO - 100% FUNCIONAL','color:#10B981;font-size:18px;font-weight:900');
console.log('%c🔥 Todas as funções implementadas sem erros','color:#7C3AED;font-size:14px;font-weight:700');
console.log('%c📅 2025-10-05 22:38 UTC | Dev: @juanmarco1999','color:#6B7280;font-size:12px');

document.addEventListener('click',function(e){
    if(!e.target.closest('#orcCPF')&&!e.target.closest('#cpfResults')){
        document.getElementById('cpfResults').style.display='none';
    }
    if(!e.target.closest('#buscaServico')&&!e.target.closest('#servicoResults')){
        document.getElementById('servicoResults').style.display='none';
    }
    if(!e.target.closest('#buscaProduto')&&!e.target.closest('#produtoResults')){
        document.getElementById('produtoResults').style.display='none';
    }
    if(!e.target.closest('.global-search-container')){
        limparResultadosBuscaGlobal();
    }
});
</script>

<!-- BIOMA ENHANCEMENTS APPENDED -->
<script>
/* === BIOMA v4.0 – Enhancements (não altera a estrutura, só adiciona funcionalidades) ===
   Este bloco conecta o frontend base ao backend (appchatgpt.py):
   - Login/Cadastro/Logout
   - Tema, System Health
   - Dashboard (stats, alertas, últimos orçamentos)
   - Busca Global (sugestões/resultados)
   - Clientes (listar, editar, PDF)
   - Profissionais (listar, foto, comissões PDF)
   - Produtos & Serviços (buscar)
   - Estoque (entrada/saída, alertas, export/PDF/import templates)
   - Orçamentos (salvar, PDF/Contrato)
   - Agendamentos (disponibilidade + heatmap)
   - Comunidade (SSE /api/stream)
*/
// ===== Helpers =====
const $ = (s, r=document)=>r.querySelector(s);
const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));
const API = {
  async get(u){ const r = await fetch(u,{credentials:'include'}); if(!r.ok) throw new Error(await r.text()); try{ return await r.json(); }catch{ return await r.text(); } },
  async post(u,b){ const r = await fetch(u,{method:'POST',headers:{'Content-Type':'application/json'},credentials:'include',body:JSON.stringify(b)}); if(!r.ok) throw new Error(await r.text()); return r.json(); },
  async put(u,b){ const r = await fetch(u,{method:'PUT',headers:{'Content-Type':'application/json'},credentials:'include',body:JSON.stringify(b)}); if(!r.ok) throw new Error(await r.text()); return r.json(); },
  async del(u){ const r = await fetch(u,{method:'DELETE',credentials:'include'}); if(!r.ok) throw new Error(await r.text()); return r.json(); },
  async upload(u, fd){ const r = await fetch(u,{method:'POST',credentials:'include',body:fd}); if(!r.ok) throw new Error(await r.text()); return r.json(); }
};
function money(v){ if(v==null||isNaN(v)) v=0; return v.toLocaleString('pt-BR',{style:'currency',currency:'BRL'}); }
function fmtDate(d){ try{ return new Date(d).toLocaleString('pt-BR'); }catch{ return d||''; } }
function toast(msg, type='info'){
    if(window.Swal){
        // Usar Swal diretamente para toasts (não SafeSwal, pois toasts devem ser não-bloqueantes)
        const Toast = Swal.mixin({
            toast: true,
            position: 'bottom-end',
            timer: 3000,
            timerProgressBar: true,
            showConfirmButton: false,
            didOpen: (toast) => {
                // Garantir que o toast não interfira com cliques
                toast.addEventListener('mouseenter', Swal.stopTimer);
                toast.addEventListener('mouseleave', Swal.resumeTimer);
            },
            didClose: () => {
                // Limpar qualquer backdrop residual de toasts
                document.querySelectorAll('.swal2-container.swal2-backdrop-show').forEach(el => {
                    if(el.classList.contains('swal2-toast-shown')){
                        el.remove();
                    }
                });
            }
        });

        Toast.fire({
            icon: type,
            title: msg
        });
    } else {
        alert(msg);
    }
}
function openFile(url){ window.open(url,'_blank','noopener'); }

// ===== Controle de Loading e Debounce (ANTI-LOOP INFINITO) =====
const loadingStates = {}; // Track loading state for each function
const debounceTimers = {}; // Track debounce timers

function isLoading(key) {
    return loadingStates[key] === true;
}

function setLoading(key, state) {
    loadingStates[key] = state;
}

// Debounce helper - prevents excessive API calls
function debounce(key, func, delay = 300) {
    clearTimeout(debounceTimers[key]);
    debounceTimers[key] = setTimeout(func, delay);
}

// Wrap async functions to prevent concurrent calls
async function safeCall(key, asyncFunc) {
    if (isLoading(key)) {
        console.log(`⏳ ${key} já está carregando, ignorando chamada duplicada`);
        return null;
    }
    
    setLoading(key, true);
    try {
        return await asyncFunc();
    } catch (error) {
        console.error(`❌ Erro em ${key}:`, error);
        return null;
    } finally {
        setLoading(key, false);
    }
}

// ===== Auth =====
/**
 * SISTEMA DE LOGIN REFATORADO - v4.1
 * - Mais robusto e sem travamentos
 * - Melhor tratamento de erros
 * - Toast notifications em vez de modais pesados
 */
async function handleLogin(e){
    e?.preventDefault?.();

    const btnLogin = document.getElementById('btnLogin');
    const btnContent = btnLogin?.querySelector('.btn-content');
    const btnLoading = btnLogin?.querySelector('.btn-loading');

    try{
        // Validação de campos
        const username = $('#loginUsername')?.value?.trim();
        const password = $('#loginPassword')?.value;
        const rememberMe = $('#rememberMe')?.checked || false;

        if(!username || !password){
            toast('Por favor, preencha todos os campos', 'warning');
            return false;
        }

        // Mostrar loading no botão
        if(btnLogin){
            btnLogin.disabled = true;
            if(btnContent) btnContent.style.display = 'none';
            if(btnLoading) btnLoading.style.display = 'flex';
        }

        // Fazer login
        const r = await API.post('/api/login', {username, password});

        if(r.success){
            // Salvar sessão
            sessionStorage.setItem('bioma_user', JSON.stringify(r.user));

            // Lembrar por 7 dias se marcado
            if(rememberMe){
                const expiryDate = new Date();
                expiryDate.setDate(expiryDate.getDate() + 7);
                localStorage.setItem('bioma_remember', JSON.stringify({
                    username: username,
                    password: btoa(password),
                    expiry: expiryDate.toISOString()
                }));
            } else {
                localStorage.removeItem('bioma_remember');
            }

            // Mensagem de sucesso SIMPLES
            console.log('✅ Login bem-sucedido:', r.user.name || r.user.username);
            toast(`Bem-vindo, ${r.user.name || r.user.username}!`, 'success');

            // Redirecionar após 500ms
            setTimeout(() => {
                initApp(r.user);
            }, 500);

        } else {
            // Erro de credenciais
            toast(r.message || 'Usuário ou senha incorretos', 'error');

            // Reset botão
            if(btnLogin){
                btnLogin.disabled = false;
                if(btnContent) btnContent.style.display = 'flex';
                if(btnLoading) btnLoading.style.display = 'none';
            }
        }
    }catch(err){
        console.error('❌ Login error:', err);
        toast('Erro ao conectar ao servidor', 'error');

        // CRITICAL: Reset botão sempre
        if(btnLogin){
            btnLogin.disabled = false;
            if(btnContent) btnContent.style.display = 'flex';
            if(btnLoading) btnLoading.style.display = 'none';
        }
    }

    return false;
}
async function handleRegister(e){ e?.preventDefault?.(); try{ const data = {name:$('#registerName').value, username:$('#registerUsername').value, email:$('#registerEmail').value, telefone:$('#registerTelefone').value, password:$('#registerPassword').value}; const r = await API.post('/api/register', data); if(r.success){ toast('Conta criada! Faça login.','success'); $('#loginTab').click(); } else { toast(r.message||'Erro ao registrar','error'); } }catch(err){ toast('Erro ao registrar','error'); } return false; }
/**
 * LOGOUT REFATORADO - v4.1
 * - Mais simples e direto
 * - Sem modais pesados que podem travar
 */
async function doLogout(){
    try{
        // Confirmar com modal simples
        const result = await Swal.fire({
            title: 'Confirmar Logout',
            text: 'Deseja realmente sair do sistema?',
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'Sim, Sair',
            cancelButtonText: 'Cancelar',
            confirmButtonColor: '#EF4444',
            cancelButtonColor: '#6B7280',
            reverseButtons: true
        });

        if(result.isConfirmed){
            // Fazer logout
            await API.post('/api/logout',{});

            // Limpar dados locais
            sessionStorage.removeItem('bioma_user');
            localStorage.removeItem('bioma_remember');

            console.log('✅ Logout bem-sucedido');
            toast('Até logo!', 'success');

            // Reload após 500ms
            setTimeout(() => {
                location.reload();
            }, 500);
        }
    }catch(err){
        console.error('❌ Logout error:', err);

        // Forçar logout mesmo em caso de erro
        sessionStorage.removeItem('bioma_user');
        localStorage.removeItem('bioma_remember');
        location.reload();
    }

    // Limpeza de backdrop residual
    setTimeout(() => {
        document.querySelectorAll('.swal2-container, .swal2-backdrop-show').forEach(el => {
            if (!Swal.isVisible()) el.remove();
        });
        document.body.classList.remove('swal2-shown', 'swal2-height-auto');
    }, 100);
}
function switchTab(which){ const login=$('#loginForm'), reg=$('#registerForm'); if(which==='login'){ login.style.display='block'; reg.style.display='none'; $('#loginTab').classList.add('active'); $('#registerTab').classList.remove('active'); } else { login.style.display='none'; reg.style.display='block'; $('#registerTab').classList.add('active'); $('#loginTab').classList.remove('active'); } }

// ===== Theme =====
async function toggleTheme(){
  const root = document.documentElement;
  const current = root.getAttribute('data-theme') || 'light';
  const next = current==='light' ? 'dark' : 'light';
  root.setAttribute('data-theme', next);
  const ic = $('#themeIcon'); const tx = $('#themeText');
  if(ic && tx){ ic.className = next==='dark'?'bi bi-sun-fill':'bi bi-moon-stars-fill'; tx.textContent = next==='dark'?'Modo Claro':'Modo Escuro'; }
  try{ await API.post('/api/update-theme', { theme: next }); }catch{ /* ignore */ }
}

// ===== Navigation ===== [REMOVIDO - usando a função principal na linha 2829]

// ===== Sub-Tabs Navigation =====
function showSubTab(section, subTab){
  // Remove active de todos os botões da seção
  const buttons = document.querySelectorAll(`#section-${section} .sub-tab-btn, #section-${section} .sub-tab`);
  buttons.forEach(btn => btn.classList.remove('active'));
  
  // Remove active de todos os conteúdos da seção
  const contents = document.querySelectorAll(`#section-${section} .sub-tab-content`);
  contents.forEach(content => content.classList.remove('active'));
  
  // Ativa o botão clicado
  const activeButton = document.querySelector(`#section-${section} [onclick*="'${subTab}'"]`);
  if(activeButton) activeButton.classList.add('active');
  
  // Ativa o conteúdo correspondente
  const activeContent = document.getElementById(`${section}-${subTab}`);
  if(activeContent) activeContent.classList.add('active');
  
  console.log(`✅ Sub-tab ativada: ${section} > ${subTab}`);
}

// Função de fallback para estoque (compatibilidade)
function mudarTabEstoque(tab){
  showSubTab('estoque', tab);
}

// ===== Global Search =====
async function buscarGlobal(q){
  const box = $('#globalSearchResults'); if(!box) return;
  if(!q || q.trim().length<2){ box.classList.remove('active'); box.innerHTML=''; return; }
  try{
    let res; try{ res = await API.get('/api/search/suggest?q='+encodeURIComponent(q)); }catch{ res=null; }
    box.innerHTML='';
    if(res && (res.success || res.suggestions)){
      const list = res.suggestions || res.resultados || [];
      const groups = {};
      list.forEach(s=>{ (groups[s.tipo]=groups[s.tipo]||[]).push(s); });
      for(const tipo of Object.keys(groups)){
        const sec = document.createElement('div'); sec.className='global-search-section';
        sec.innerHTML = `<h6>${tipo.toUpperCase()}</h6>` + groups[tipo].map(s=>`<div class="global-search-item" data-tipo="${s.tipo}" data-id="${s.id}" onclick="abrirResultado('${s.tipo}','${s.id}')"><strong>${s.label||s.nome||s.titulo||''}</strong><span>${s.tipo}</span></div>`).join('');
        box.appendChild(sec);
      }
      box.classList.add('active');
    } else {
      box.innerHTML = `<div class="global-search-item"><strong>Pressione Enter para buscar</strong><span>${q}</span></div>`;
      box.classList.add('active');
    }
  }catch(err){ box.classList.remove('active'); }
}
function executarBuscaGlobal(){ const q=$('#globalSearchInput')?.value||''; if(q) buscarGlobal(q); }
async function abrirResultado(tipo,id){
  $('#globalSearchResults').classList.remove('active');
  if(tipo==='cliente'){ goTo('clientes'); }
  if(tipo==='produto'){ goTo('produtos'); }
  if(tipo==='servico'){ goTo('servicos'); }
  if(tipo==='profissional'){ goTo('profissionais'); }
  if(tipo==='orcamento'){ goTo('contratos'); }
}

// ===== [REMOVIDO] Funções duplicadas - usando as versões originais completas com anti-loop =====

// ===== Agendamentos =====
async function heatmapDias(dias=60){
  try{
    const r = await API.get('/api/agendamentos/heatmap?dias='+dias);
    if(!r.success) return;
    const canvas = document.querySelector('#chartHeatmap');
    if(canvas && window.Chart){
      const labels = r.heatmap.map(d=>d.data);
      const a = r.heatmap.map(d=>d.agendamentos);
      const o = r.heatmap.map(d=>d.orcamentos);
      const v = r.heatmap.map(d=>d.vendas);
      const ctx = canvas.getContext('2d');
      new Chart(ctx,{type:'line',data:{labels,datasets:[{label:'Agendamentos',data:a},{label:'Orçamentos',data:o},{label:'Vendas',data:v}]}});
    }
  }catch{}
}

// ========== FUNÇÕES AUXILIARES - AUTOCOMPLETE E MAPA DE CALOR ==========
function bindAutocompletes() {
  console.log('📝 Inicializando autocompletes...');
  // Stub: Autocompletes serão implementados conforme necessário
  // Esta função evita erro de "is not defined" no initApp
}

async function carregarMapaCalor(){
    console.log('🗓️ Carregando mapa de calor...');
    const container = document.getElementById('mapaCalorContainer');

    if(!container){
        console.error('Container do mapa de calor não encontrado');
        return;
    }

    try{
        // Loading
        container.innerHTML = '<div class="spinner" style="margin: 40px auto;"></div>';

        const res = await fetch('/api/relatorios/mapa-calor', {credentials: 'include'});
        const data = await res.json();

        if(data.success && data.data && data.data.length > 0){
            let html = '';

            data.data.forEach(dia => {
                const atendimentos = dia.total_atendimentos || 0;
                const receita = dia.receita_total || 0;

                // Definir intensidade baseada no número de atendimentos
                let intensidade = 1;
                if(atendimentos > 20) intensidade = 5;
                else if(atendimentos > 15) intensidade = 4;
                else if(atendimentos > 10) intensidade = 3;
                else if(atendimentos > 5) intensidade = 2;

                html += `
                    <div class="mapa-dia intensidade-${intensidade}">
                        <div class="mapa-dia-header">${dia.dia_semana || 'N/A'}</div>
                        <div class="mapa-dia-data">${dia.data_formatada || dia.data || 'N/A'}</div>
                        <div class="mapa-dia-valor">${atendimentos}</div>
                        <div style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 8px;">
                            R$ ${receita.toFixed(2)}
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
            console.log(`✅ Mapa de calor carregado: ${data.data.length} dias`);
        } else {
            container.innerHTML = `
                <div style="text-align: center; padding: 40px; color: var(--text-muted);">
                    <i class="bi bi-calendar-x" style="font-size: 3rem; opacity: 0.3;"></i>
                    <p style="margin-top: 15px; font-weight: 600;">Nenhum dado disponível para o mapa de calor</p>
                    <p style="font-size: 0.9rem; margin-top: 5px;">Registre atendimentos para visualizar estatísticas</p>
                </div>
            `;
        }
    }catch(err){
        console.error('Erro ao carregar mapa de calor:', err);
        container.innerHTML = `
            <div style="text-align: center; padding: 40px; color: var(--danger);">
                <i class="bi bi-exclamation-triangle" style="font-size: 3rem;"></i>
                <p style="margin-top: 15px; font-weight: 600;">Erro ao carregar mapa de calor</p>
                <p style="font-size: 0.9rem; margin-top: 5px;">${err.message || 'Tente novamente mais tarde'}</p>
                <button class="btn btn-primary btn-sm" onclick="carregarMapaCalor()" style="margin-top: 15px;">
                    <i class="bi bi-arrow-clockwise"></i> Tentar Novamente
                </button>
            </div>
        `;
    }
}

async function carregarDadosFinanceiro() {
  console.log('💰 Atualizando dados financeiros...');
  try {
    // Carregar dashboard completo
    const dashRes = await fetch('/api/financeiro/dashboard', {credentials: 'include'});
    const dashData = await dashRes.json();

    if (dashData.success && dashData.financeiro) {
      const fin = dashData.financeiro;

      // Atualizar cards principais
      document.getElementById('financeiroReceitas').textContent = `R$ ${fin.receita_total.toFixed(2)}`;
      document.getElementById('financeiroDespesas').textContent = `R$ ${fin.despesas_total.toFixed(2)}`;
      document.getElementById('financeiroLucro').textContent = `R$ ${fin.lucro_liquido.toFixed(2)}`;

      // Atualizar margem de lucro
      const margemEl = document.getElementById('margemLucro');
      if (margemEl) {
        margemEl.textContent = `${fin.margem_lucro_perc.toFixed(1)}%`;
        margemEl.style.color = fin.margem_lucro_perc > 0 ? 'var(--success)' : 'var(--danger)';
      }
    }

    // Carregar gráficos em paralelo
    carregarFaturamentoMensal();
    carregarServicosMaisVendidos();
    carregarProdutosMaisVendidos();

    // Carrega comissões
    carregarHistoricoComissoes();

    // Toast não bloqueante
    toast('✅ Dados financeiros atualizados', 'success');
  } catch (error) {
    console.error('Erro ao carregar dados financeiros:', error);
    toast('❌ Erro ao atualizar dados financeiros', 'error');
  }
}

// Carregar faturamento mensal dos últimos 12 meses
async function carregarFaturamentoMensal() {
  try {
    console.log('📊 Carregando faturamento mensal...');

    // Verificar se Chart.js está disponível
    if (!window.Chart) {
      console.error('❌ Chart.js não está carregado!');
      return;
    }

    // Verificar se canvas existe
    const ctx = document.getElementById('graficoFaturamentoMensal') || document.getElementById('chartFaturamento');
    if (!ctx) {
      console.warn('⚠️ Canvas de faturamento mensal não encontrado (IDs: graficoFaturamentoMensal, chartFaturamento)');
      return;
    }

    // Buscar dados
    const res = await fetch('/api/orcamentos', {credentials: 'include'});

    if (!res.ok) {
      console.error(`❌ Erro HTTP ao buscar orçamentos: ${res.status}`);
      return;
    }

    const data = await res.json();
    console.log('📦 Dados recebidos:', { success: data.success, total_orcamentos: data.orcamentos?.length });

    if (!data.success || !data.orcamentos) {
      console.warn('⚠️ Resposta da API não contém orçamentos');
      renderizarGraficoFaturamentoVazio(ctx, 'Nenhum orçamento disponível');
      return;
    }

    // Filtrar aprovados dos últimos 12 meses
    const hoje = new Date();
    const doze_meses_atras = new Date(hoje.getFullYear(), hoje.getMonth() - 11, 1);

    const aprovados = data.orcamentos.filter(o => {
      if (!o || o.status !== 'Aprovado') return false;
      try {
        const dataOrc = new Date(o.created_at || o.data_criacao || o.data);
        return dataOrc >= doze_meses_atras && dataOrc <= hoje;
      } catch (err) {
        console.warn('⚠️ Erro ao parsear data do orçamento:', o);
        return false;
      }
    });

    console.log(`✅ Orçamentos aprovados nos últimos 12 meses: ${aprovados.length}`);

    // Agrupar por mês (últimos 12 meses)
    const faturamentoPorMes = {};
    const mesesNomes = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
    const labelsFormatados = [];

    for (let i = 11; i >= 0; i--) {
      const mes = new Date(hoje.getFullYear(), hoje.getMonth() - i, 1);
      const mesAno = `${mes.getMonth() + 1}/${mes.getFullYear()}`;
      const mesAnoFormatado = `${mesesNomes[mes.getMonth()]}/${mes.getFullYear().toString().slice(-2)}`;
      faturamentoPorMes[mesAno] = 0;
      labelsFormatados.push(mesAnoFormatado);
    }

    // Acumular valores
    aprovados.forEach(orc => {
      try {
        const data = new Date(orc.created_at || orc.data_criacao || orc.data);
        const mesAno = `${data.getMonth() + 1}/${data.getFullYear()}`;
        if (faturamentoPorMes[mesAno] !== undefined) {
          const valor = parseFloat(orc.total || orc.total_final || orc.valor_total || 0);
          faturamentoPorMes[mesAno] += valor;
        }
      } catch (err) {
        console.warn('⚠️ Erro ao processar orçamento:', orc, err);
      }
    });

    const valores = Object.values(faturamentoPorMes);
    const totalFaturamento = valores.reduce((sum, val) => sum + val, 0);
    console.log(`💰 Faturamento total (12 meses): R$ ${totalFaturamento.toFixed(2)}`);

    // Destruir gráfico anterior se existir
    if (window.chartFaturamentoInstance) {
      window.chartFaturamentoInstance.destroy();
    }

    // Criar gráfico
    window.chartFaturamentoInstance = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labelsFormatados,
        datasets: [{
          label: 'Faturamento (R$)',
          data: valores,
          backgroundColor: 'rgba(16, 185, 129, 0.7)',
          borderColor: 'rgba(16, 185, 129, 1)',
          borderWidth: 2,
          borderRadius: 6,
          hoverBackgroundColor: 'rgba(16, 185, 129, 0.9)'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
          legend: {
            display: true,
            labels: {
              font: { size: 12, weight: 'bold' }
            }
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                return `Faturamento: R$ ${context.parsed.y.toFixed(2).replace('.', ',')}`;
              }
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              callback: function(value) {
                return 'R$ ' + value.toLocaleString('pt-BR', {minimumFractionDigits: 0, maximumFractionDigits: 0});
              }
            }
          }
        }
      }
    });

    console.log('✅ Gráfico de faturamento mensal renderizado com sucesso');

  } catch (error) {
    console.error('❌ Erro ao carregar faturamento mensal:', error);
    const ctx = document.getElementById('graficoFaturamentoMensal') || document.getElementById('chartFaturamento');
    if (ctx) {
      renderizarGraficoFaturamentoVazio(ctx, `Erro ao carregar dados: ${error.message}`);
    }
  }
}

// Função auxiliar para renderizar gráfico vazio com mensagem
function renderizarGraficoFaturamentoVazio(ctx, mensagem) {
  if (window.chartFaturamentoInstance) {
    window.chartFaturamentoInstance.destroy();
  }

  window.chartFaturamentoInstance = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: ['Sem dados'],
      datasets: [{
        label: 'Faturamento (R$)',
        data: [0],
        backgroundColor: 'rgba(156, 163, 175, 0.5)',
        borderColor: 'rgba(156, 163, 175, 1)',
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        legend: { display: false },
        title: {
          display: true,
          text: mensagem,
          color: 'rgba(156, 163, 175, 1)',
          font: { size: 14 }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          max: 100,
          ticks: {
            callback: function(value) {
              return 'R$ ' + value;
            }
          }
        }
      }
    }
  });
}

// Carregar serviços mais vendidos
async function carregarServicosMaisVendidos() {
  try {
    const res = await fetch('/api/orcamentos', {credentials: 'include'});
    const data = await res.json();

    if (!data.success || !data.orcamentos) return;

    const aprovados = data.orcamentos.filter(o => o.status === 'Aprovado');

    // Agrupar serviços
    const servicos = {};
    aprovados.forEach(orc => {
      (orc.servicos || []).forEach(serv => {
        const nome = serv.nome || serv.servico || 'Serviço';
        if (!servicos[nome]) {
          servicos[nome] = { quantidade: 0, valor: 0 };
        }
        servicos[nome].quantidade += 1;
        servicos[nome].valor += serv.valor || serv.preco || 0;
      });
    });

    // Top 5 por quantidade
    const top = Object.entries(servicos)
      .sort((a, b) => b[1].quantidade - a[1].quantidade)
      .slice(0, 5);

    if (top.length === 0) {
      const canvas = document.getElementById('graficoServicosMaisVendidos');
      if (canvas) {
        canvas.style.display = 'none';
        canvas.parentElement.innerHTML = '<p class="text-center text-muted" style="padding: 40px;">Nenhum serviço vendido</p>';
      }
      return;
    }

    const labels = top.map(t => t[0]);
    const valores = top.map(t => t[1].quantidade);

    // Criar gráfico
    const ctx = document.getElementById('graficoServicosMaisVendidos');
    if (ctx && window.Chart) {
      if (window.chartServicosInstance) {
        window.chartServicosInstance.destroy();
      }

      window.chartServicosInstance = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: labels,
          datasets: [{
            data: valores,
            backgroundColor: [
              'rgba(124, 58, 237, 0.8)',
              'rgba(236, 72, 153, 0.8)',
              'rgba(245, 158, 11, 0.8)',
              'rgba(16, 185, 129, 0.8)',
              'rgba(59, 130, 246, 0.8)'
            ]
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom'
            }
          }
        }
      });
    }
  } catch (error) {
    console.error('Erro ao carregar serviços mais vendidos:', error);
  }
}

// Carregar produtos mais vendidos
async function carregarProdutosMaisVendidos() {
  try {
    const res = await fetch('/api/estoque/movimentacoes?tipo=saida&per_page=1000', {credentials: 'include'});
    const data = await res.json();

    if (!data.success || !data.movimentacoes || data.movimentacoes.length === 0) {
      const canvas = document.getElementById('graficoProdutosMaisVendidos');
      if (canvas) {
        canvas.style.display = 'none';
        canvas.parentElement.innerHTML = '<p class="text-center text-muted" style="padding: 40px;">Nenhum produto vendido</p>';
      }
      return;
    }

    // Agrupar produtos
    const produtos = {};
    data.movimentacoes.forEach(mov => {
      const nome = mov.produto_nome || 'Produto';
      if (!produtos[nome]) {
        produtos[nome] = 0;
      }
      produtos[nome] += mov.quantidade || 0;
    });

    // Top 5 por quantidade
    const top = Object.entries(produtos)
      .sort((a, b) => b[1] - a[1])
      .slice(0, 5);

    const labels = top.map(t => t[0]);
    const valores = top.map(t => t[1]);

    // Criar gráfico
    const ctx = document.getElementById('graficoProdutosMaisVendidos');
    if (ctx && window.Chart) {
      if (window.chartProdutosInstance) {
        window.chartProdutosInstance.destroy();
      }

      window.chartProdutosInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Quantidade Vendida',
            data: valores,
            backgroundColor: 'rgba(236, 72, 153, 0.7)',
            borderColor: 'rgba(236, 72, 153, 1)',
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          indexAxis: 'y',
          plugins: {
            legend: { display: false }
          },
          scales: {
            x: {
              beginAtZero: true,
              ticks: {
                precision: 0
              }
            }
          }
        }
      });
    }
  } catch (error) {
    console.error('Erro ao carregar produtos mais vendidos:', error);
  }
}

async function disponibilidade(profId, dataISO){
  try{
    const r = await API.get(`/api/agendamentos/disponibilidade?profissional_id=${profId}&data=${dataISO}`);
    const box = document.querySelector('#agendaSlots'); if(!box) return;
    box.innerHTML = (r.slots||[]).map(s=>`<span class="community-pill" style="background:${s.status==='livre'?'#DCFCE7':'#fee2e2'};color:${s.status==='livre'?'#166534':'#991B1B'}">${s.hora} • ${s.status}</span>`).join('');
  }catch{}
}

// ===== Comunidade (SSE) ===== [Variáveis já declaradas nas linhas 2689-2692]

function startSSE(){
  // Evitar múltiplas instâncias do SSE
  if (sseInstance) {
    return;
  }

  try{
    const ev = new EventSource('/api/stream');
    sseInstance = ev;

    ev.onopen = () => {
      console.log('✅ SSE conectado');
      sseReconnectAttempts = 0; // Reset contador de reconexão
    };

    ev.onerror = (error) => {
      // Verificar se é um erro real ou apenas uma desconexão normal
      if (ev.readyState === EventSource.CLOSED) {
        // Conexão foi fechada
        ev.close();
        sseInstance = null;

        // Reconectar apenas se não exceder o limite
        if (sseReconnectAttempts < MAX_SSE_RECONNECT) {
          sseReconnectAttempts++;
          const delay = Math.min(2000 * sseReconnectAttempts, 10000); // Backoff linear
          setTimeout(startSSE, delay);
        }
      } else if (ev.readyState === EventSource.CONNECTING) {
        // Tentando reconectar automaticamente
        // Não fazer nada, o EventSource está tratando
      }
    };
    
    ev.onmessage = (e)=>{
      let data = {}; try{ data = JSON.parse(e.data); }catch{}
      if(data.channel==='hello') return;
      const feed = document.querySelector('#feedCards') || document.querySelector('#feed');
      if(feed){ const card = document.createElement('div'); card.className='community-card'; card.innerHTML = `<h5>${data.channel||'evento'}</h5><pre style="white-space:pre-wrap">${JSON.stringify(data.payload,null,2)}</pre><small class="text-muted">${new Date().toLocaleString()}</small>`; feed.prepend(card); while(feed.children.length>50){ feed.removeChild(feed.lastChild);} }
      // SOMENTE carregar estoque se a seção estiver visível
      if(data.channel==='estoque'){
        const estoqueSection = document.getElementById('section-estoque');
        if(estoqueSection && estoqueSection.style.display !== 'none'){
          loadEstoque();
        }
      }
      if(data.channel==='profissionais'){ loadProfissionais(); }
    };
  }catch(e){
    console.error('❌ Falha ao iniciar SSE:', e);
    sseInstance = null;
  }
}

// ===== Sistema / Config =====
async function loadSystem(){
  const key = 'loadSystem';
  if (isLoading(key)) {
      console.warn(`⚠️ Já carregando: ${key}`);
      return;
  }
  setLoading(key, true);

  try{
    const r = await API.get('/api/system/status');
    const el = document.querySelector('#sistemaStatus'); if(!el) return;
    el.innerHTML = `
      <div class="row g-4">
        <div class="col-md-4"><div class="stat-card"><div class="icon"><i class="bi bi-database-check"></i></div><h3>${r.status.mongodb.operational?'OK':'OFF'}</h3><p>MongoDB</p></div></div>
        <div class="col-md-4"><div class="stat-card"><div class="icon"><i class="bi bi-envelope-check"></i></div><h3>${r.status.mailersend.operational?'OK':'OFF'}</h3><p>MailerSend</p></div></div>
        <div class="col-md-4"><div class="stat-card"><div class="icon"><i class="bi bi-hdd-network"></i></div><h3>${r.status.server.version}</h3><p>Versão</p></div></div>
      </div>`;
  }catch{}
  finally {
      setTimeout(() => setLoading(key, false), 1000);
  }
}
async function uploadLogo(inputSel='#logoArquivo'){
  const f = document.querySelector(inputSel)?.files?.[0]; if(!f) return toast('Selecione um arquivo','warning');
  const fd = new FormData(); fd.append('file', f);
  try{
    const up = await API.upload('/api/upload/imagem', fd);
    const filename = up.filename || up.name || up.id || up.path || up.url?.split('/').pop();
    const logo_url = up.url || '/api/imagem/'+filename;
    await API.post('/api/config', { logo_url });
    if(document.querySelector('#authLogoCustom')){ document.querySelector('#authLogoCustom').src = logo_url; document.querySelector('#authLogoCustom').style.display='block'; }
    toast('Logo atualizado','success');
  }catch{ toast('Falha no upload','error'); }
}
window.uploadLogo = uploadLogo;

// ===== Init =====
async function initApp(user=null){
  // Evitar múltiplas inicializações
  if (appInitialized) {
    console.log('⏳ App já foi inicializado');
    return;
  }
  appInitialized = true;
  
  console.log('🚀 Inicializando aplicativo...');
  document.querySelector('#authScreen').style.display='none';
  document.querySelector('#app').style.display='block';
  
  try{
    const cu = await API.get('/api/current-user');
    const theme = (cu.success && cu.user && cu.user.theme) ? cu.user.theme : 'light';
    // IMPORTANTE: Só aplicar tema do usuário quando NÃO estiver na tela de login
    // A tela de login SEMPRE deve ficar em light mode
    const isAuthScreen = document.getElementById('authScreen')?.style.display !== 'none';
    if (!isAuthScreen) {
      document.documentElement.setAttribute('data-theme', theme);
      console.log(`🎨 Tema do usuário aplicado: ${theme}`);
    } else {
      console.log('🌞 Auth screen ativa - mantendo light mode obrigatório');
    }
  }catch(e){
    console.error('Erro ao carregar tema:', e);
  }
  
  // CARREGAR LOGO IMEDIATAMENTE (antes de tudo)
  await loadConfiguracoes(true); // force=true para garantir carregamento

  // Executar loads de forma não-bloqueante para evitar travamento
  // Cada função tem seu próprio safeCall internamente
  Promise.allSettled([
    loadDashboard(),
    loadClientes(),
    loadProfissionais(),
    // loadEstoque(), // REMOVIDO: Estoque só deve carregar quando a seção for acessada
    loadSystem()
  ]).then(() => {
    console.log('✅ Carregamento inicial completo');
  });
  
  // Iniciar features que não dependem de dados
  bindAutocompletes();
  heatmapDias(60);
  startSSE();
}

// ========== SISTEMA DE COMISSÕES - FASE 3 ==========
let graficoComissoesInstance = null;

async function carregarProfissionaisFiltro() {
    try {
        const [resProfissionais, resAssistentes] = await Promise.all([
            fetch('/api/profissionais', {credentials: 'include'}),
            fetch('/api/assistentes', {credentials: 'include'})
        ]);

        const profissionais = (await resProfissionais.json()).profissionais || [];
        const assistentes = (await resAssistentes.json()).assistentes || [];

        const select = document.getElementById('filtroComissoesProfissional');
        if (!select) return;
        
        select.innerHTML = '<option value="">Selecione um profissional</option>';

        profissionais.forEach(p => {
            const option = document.createElement('option');
            option.value = p._id;
            option.textContent = `${p.nome} (Profissional)`;
            select.appendChild(option);
        });

        assistentes.forEach(a => {
            const option = document.createElement('option');
            option.value = a._id;
            option.textContent = `${a.nome} (Assistente)`;
            select.appendChild(option);
        });
    } catch (error) {
        console.error('Erro ao carregar profissionais:', error);
    }
}

async function carregarComissoesProfissional() {
    const profissionalId = document.getElementById('filtroComissoesProfissional')?.value;

    if (!profissionalId) {
        Swal.fire('Atenção', 'Selecione um profissional', 'warning');
        return;
    }

    const dataInicio = document.getElementById('filtroComissoesDataInicio')?.value || '';
    const dataFim = document.getElementById('filtroComissoesDataFim')?.value || '';
    const status = document.getElementById('filtroComissoesStatus')?.value || '';

    const params = new URLSearchParams();
    if (dataInicio) params.append('data_inicio', dataInicio + 'T00:00:00');
    if (dataFim) params.append('data_fim', dataFim + 'T23:59:59');
    if (status) params.append('status', status);

    // Mostrar loading na tabela
    const tbody = document.getElementById('tabelaHistoricoComissoes');
    if (tbody) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Carregando...</span></div></td></tr>';
    }

    try {
        const res = await fetch(`/api/profissionais/${profissionalId}/comissoes?${params}`, {
            credentials: 'include'
        });

        if (!res.ok) {
            const errorText = await res.text();
            console.error('❌ Erro HTTP ao carregar comissões:', res.status, errorText);
            throw new Error(`Erro ${res.status}: ${errorText || 'Falha ao carregar comissões'}`);
        }

        const responseData = await res.json();
        console.log('📊 Dados recebidos do backend:', responseData);

        // Verificar estrutura de dados e aplicar fallbacks
        const data = responseData.data || responseData;
        const estatisticas = data.estatisticas || {};
        const historico = data.historico || data.comissoes || [];

        // Valores com fallback
        const totalComissoes = estatisticas.total_comissoes ?? 0;
        const totalOrcamentos = estatisticas.total_orcamentos ?? 0;
        const mediaComissao = estatisticas.media_comissao ?? 0;
        const comissoesPorMes = estatisticas.comissoes_por_mes || [];

        // Atualizar estatísticas
        const statTotalComissoesElem = document.getElementById('statTotalComissoes');
        const statTotalOrcamentosElem = document.getElementById('statTotalOrcamentos');
        const statMediaComissaoElem = document.getElementById('statMediaComissao');

        if (statTotalComissoesElem) {
            statTotalComissoesElem.textContent = `R$ ${totalComissoes.toFixed(2).replace('.', ',')}`;
        }
        if (statTotalOrcamentosElem) {
            statTotalOrcamentosElem.textContent = totalOrcamentos;
        }
        if (statMediaComissaoElem) {
            statMediaComissaoElem.textContent = `R$ ${mediaComissao.toFixed(2).replace('.', ',')}`;
        }

        // Mostrar/ocultar seções
        const cardsElem = document.getElementById('comissoesEstatisticasCards');
        const msgInicialElem = document.getElementById('comissoesMensagemInicial');

        if (cardsElem) cardsElem.style.display = 'block';
        if (msgInicialElem) msgInicialElem.style.display = 'none';

        // Renderizar gráfico e tabela
        renderizarGraficoComissoes(comissoesPorMes);
        renderizarTabelaHistoricoComissoes(historico, totalComissoes);

        console.log('✅ Comissões carregadas com sucesso:', {
            total_comissoes: totalComissoes,
            total_orcamentos: totalOrcamentos,
            historico_length: historico.length
        });

    } catch (error) {
        console.error('❌ Erro ao carregar comissões:', error);

        // Mostrar mensagem de erro amigável na tabela
        if (tbody) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center text-danger">
                        <i class="bi bi-exclamation-triangle"></i>
                        <strong>Erro ao carregar comissões</strong><br>
                        <small>${error.message || 'Verifique sua conexão ou contate o suporte'}</small>
                    </td>
                </tr>
            `;
        }

        Swal.fire({
            icon: 'error',
            title: 'Erro ao Carregar Comissões',
            html: `<p>${error.message || 'Não foi possível carregar as comissões'}</p>
                   <small class="text-muted">Verifique o console para mais detalhes</small>`,
            confirmButtonText: 'OK'
        });
    }
}

function renderizarGraficoComissoes(comissoesPorMes) {
    const ctx = document.getElementById('graficoComissoesMensal');
    if (!ctx) {
        console.warn('⚠️ Canvas graficoComissoesMensal não encontrado');
        return;
    }

    // Destruir gráfico anterior se existir
    if (graficoComissoesInstance) {
        graficoComissoesInstance.destroy();
    }

    // Validar dados de entrada
    if (!comissoesPorMes || typeof comissoesPorMes !== 'object' || Object.keys(comissoesPorMes).length === 0) {
        console.warn('⚠️ Dados de comissões por mês vazios ou inválidos');
        // Renderizar gráfico vazio com mensagem
        graficoComissoesInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: ['Sem dados'],
                datasets: [{
                    label: 'Valor Total (R$)',
                    data: [0],
                    borderColor: 'rgb(124, 58, 237)',
                    backgroundColor: 'rgba(124, 58, 237, 0.1)',
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Nenhum dado disponível para o período selecionado'
                    }
                }
            }
        });
        return;
    }

    try {
        const meses = Object.keys(comissoesPorMes).sort();
        const valores = meses.map(mes => {
            const dadosMes = comissoesPorMes[mes];
            return dadosMes?.valor ?? dadosMes?.total ?? 0;
        });
        const quantidades = meses.map(mes => {
            const dadosMes = comissoesPorMes[mes];
            return dadosMes?.quantidade ?? dadosMes?.count ?? 0;
        });

        const labels = meses.map(mes => {
            try {
                const [ano, mesNum] = mes.split('-');
                const mesesNomes = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
                const mesIndex = parseInt(mesNum) - 1;
                return mesesNomes[mesIndex] ? `${mesesNomes[mesIndex]}/${ano}` : mes;
            } catch (err) {
                console.warn('⚠️ Erro ao formatar label do mês:', mes, err);
                return mes;
            }
        });

    graficoComissoesInstance = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Valor Total (R$)',
                    data: valores,
                    borderColor: 'rgb(124, 58, 237)',
                    backgroundColor: 'rgba(124, 58, 237, 0.1)',
                    tension: 0.4,
                    fill: true,
                    yAxisID: 'y'
                },
                {
                    label: 'Quantidade',
                    data: quantidades,
                    borderColor: 'rgb(236, 72, 153)',
                    backgroundColor: 'rgba(236, 72, 153, 0.1)',
                    tension: 0.4,
                    fill: true,
                    yAxisID: 'y1'
                }
            ]
        },
        options: {
            responsive: true,
            interaction: {
                mode: 'index',
                intersect: false
            },
            scales: {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: {
                        display: true,
                        text: 'Valor (R$)'
                    }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    title: {
                        display: true,
                        text: 'Quantidade'
                    },
                    grid: {
                        drawOnChartArea: false
                    }
                }
            }
        }
    });

    console.log('✅ Gráfico de comissões renderizado com sucesso');

    } catch (error) {
        console.error('❌ Erro ao renderizar gráfico de comissões:', error);
        // Renderizar gráfico vazio em caso de erro
        graficoComissoesInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: ['Erro'],
                datasets: [{
                    label: 'Dados não disponíveis',
                    data: [0],
                    borderColor: 'rgb(239, 68, 68)',
                    backgroundColor: 'rgba(239, 68, 68, 0.1)',
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Erro ao carregar dados do gráfico',
                        color: 'rgb(239, 68, 68)'
                    }
                }
            }
        });
    }
}

function renderizarTabelaHistoricoComissoes(historico, totalComissoes) {
    const tbody = document.getElementById('tabelaHistoricoComissoes');
    if (!tbody) return;

    if (!historico || historico.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted"><i class="bi bi-inbox"></i> Nenhuma comissão encontrada para os filtros selecionados</td></tr>';
        const tfoot = document.getElementById('tfootComissoes');
        if (tfoot) tfoot.style.display = 'none';
        return;
    }

    tbody.innerHTML = historico.map((comissao, index) => {
        try {
            // Fallbacks para todos os campos
            const dataRegistro = comissao.data_registro || comissao.data || comissao.created_at;
            const data = dataRegistro ? new Date(dataRegistro).toLocaleDateString('pt-BR') : 'Data não disponível';

            const valorBase = (comissao.valor_base ?? comissao.valorBase ?? 0);
            const valorBaseFormatado = typeof valorBase === 'number' ? valorBase.toFixed(2).replace('.', ',') : '0,00';

            const comissaoValor = (comissao.comissao_valor ?? comissao.comissaoValor ?? comissao.valor ?? 0);
            const comissaoValorFormatado = typeof comissaoValor === 'number' ? comissaoValor.toFixed(2).replace('.', ',') : '0,00';

            const comissaoPerc = (comissao.comissao_perc ?? comissao.percentual ?? comissao.porcentagem ?? 0);
            const comissaoPercFormatado = typeof comissaoPerc === 'number' ? comissaoPerc : parseFloat(comissaoPerc) || 0;

            const orcamentoId = comissao.orcamento_id || comissao.orcamentoId || `ORÇ-${index + 1}`;
            const orcamentoIdDisplay = typeof orcamentoId === 'string' && orcamentoId.length > 6
                ? orcamentoId.slice(-6)
                : orcamentoId;

            const statusOrcamento = comissao.status_orcamento || comissao.statusOrcamento || comissao.status || 'Desconhecido';
            const badgeStatus =
                statusOrcamento === 'Aprovado' || statusOrcamento === 'aprovado' ? 'success' :
                statusOrcamento === 'Pendente' || statusOrcamento === 'pendente' ? 'warning' :
                statusOrcamento === 'Cancelado' || statusOrcamento === 'cancelado' ? 'danger' : 'secondary';

            const tipo = comissao.tipo || comissao.tipo_comissao || 'profissional';
            const badgeTipo = tipo === 'profissional' ? 'primary' : tipo === 'indicacao' ? 'info' : 'secondary';

            return `
                <tr>
                    <td>${data}</td>
                    <td>#${orcamentoIdDisplay}</td>
                    <td><span class="badge ${badgeTipo}">${tipo}</span></td>
                    <td>R$ ${valorBaseFormatado}</td>
                    <td>${comissaoPercFormatado}%</td>
                    <td><strong>R$ ${comissaoValorFormatado}</strong></td>
                    <td><span class="badge ${badgeStatus}">${statusOrcamento}</span></td>
                </tr>
            `;
        } catch (err) {
            console.error('❌ Erro ao renderizar comissão:', err, comissao);
            return `
                <tr>
                    <td colspan="7" class="text-center text-warning">
                        <i class="bi bi-exclamation-triangle"></i> Erro ao exibir comissão #${index + 1}
                    </td>
                </tr>
            `;
        }
    }).join('');

    // Atualizar rodapé com total
    const footerElem = document.getElementById('totalComissoesFooter');
    const tfootElem = document.getElementById('tfootComissoes');

    const totalFormatado = typeof totalComissoes === 'number'
        ? totalComissoes.toFixed(2).replace('.', ',')
        : '0,00';

    if (footerElem) footerElem.textContent = `R$ ${totalFormatado}`;
    if (tfootElem) tfootElem.style.display = '';
}

function limparFiltrosComissoes() {
    const els = {
        profissional: document.getElementById('filtroComissoesProfissional'),
        dataInicio: document.getElementById('filtroComissoesDataInicio'),
        dataFim: document.getElementById('filtroComissoesDataFim'),
        status: document.getElementById('filtroComissoesStatus')
    };
    
    if (els.profissional) els.profissional.value = '';
    if (els.dataInicio) els.dataInicio.value = '';
    if (els.dataFim) els.dataFim.value = '';
    if (els.status) els.status.value = '';
    
    const cards = document.getElementById('comissoesEstatisticasCards');
    const msg = document.getElementById('comissoesMensagemInicial');
    if (cards) cards.style.display = 'none';
    if (msg) msg.style.display = 'block';
    
    const tbody = document.getElementById('tabelaHistoricoComissoes');
    if (tbody) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">Selecione um profissional nos filtros acima</td></tr>';
    }
}

async function exportarComissoesExcel() {
    const profissionalId = document.getElementById('filtroComissoesProfissional')?.value;

    if (!profissionalId) {
        Swal.fire('Atenção', 'Selecione um profissional primeiro', 'warning');
        return;
    }

    try {
        // Buscar dados do profissional
        const res = await fetch(`/api/profissionais/${profissionalId}/comissoes`, {credentials: 'include'});
        const data = await res.json();

        if (!data.success || !data.historico || data.historico.length === 0) {
            Swal.fire('Atenção', 'Nenhuma comissão disponível para exportar', 'info');
            return;
        }

        const profissionalNome = document.getElementById('filtroComissoesProfissional')
            ?.selectedOptions[0]?.textContent || 'Profissional';

        const columns = [
            { key: 'data_registro', label: 'Data', type: 'date', width: 12 },
            { key: 'orcamento_numero', label: 'Orçamento', width: 12 },
            { key: 'tipo', label: 'Tipo', width: 15 },
            { key: 'valor_base', label: 'Valor Base', type: 'currency', width: 15 },
            { key: 'comissao_percentual', label: 'Comissão %', width: 12 },
            { key: 'comissao_valor', label: 'Valor Comissão', type: 'currency', width: 15 },
            { key: 'status', label: 'Status', width: 12 }
        ];

        await ExportLibrary.toExcel(data.historico, columns, `comissoes_${profissionalNome.replace(/\s/g, '_')}`, 'Comissões');
    } catch (error) {
        console.error('Erro ao exportar comissões:', error);
        Swal.fire('Erro', 'Não foi possível exportar as comissões', 'error');
    }
}

async function carregarRankingProfissionais() {
    try {
        const [resProfissionais, resAssistentes] = await Promise.all([
            fetch('/api/profissionais', {credentials: 'include'}),
            fetch('/api/assistentes', {credentials: 'include'})
        ]);

        const profissionais = (await resProfissionais.json()).profissionais || [];
        const assistentes = (await resAssistentes.json()).assistentes || [];

        const todos = [
            ...profissionais.map(p => ({...p, tipo: 'profissional'})),
            ...assistentes.map(a => ({...a, tipo: 'assistente'}))
        ];

        const promises = todos.map(pessoa => 
            fetch(`/api/profissionais/${pessoa._id}/comissoes`, {credentials: 'include'})
                .then(r => r.json())
                .then(data => ({
                    ...pessoa,
                    total_comissoes: data.data.estatisticas.total_comissoes,
                    total_orcamentos: data.data.estatisticas.total_orcamentos,
                    media_comissao: data.data.estatisticas.media_comissao
                }))
                .catch(() => ({
                    ...pessoa,
                    total_comissoes: 0,
                    total_orcamentos: 0,
                    media_comissao: 0
                }))
        );

        const ranking = await Promise.all(promises);
        ranking.sort((a, b) => b.total_comissoes - a.total_comissoes);

        const tbody = document.getElementById('rankingProfissionaisBody');
        if (!tbody) return;
        
        tbody.innerHTML = ranking.map((pessoa, index) => {
            const foto = pessoa.foto ? 
                `<img src="${pessoa.foto}" alt="${pessoa.nome}" style="width:40px;height:40px;border-radius:50%;object-fit:cover;">` :
                `<div style="width:40px;height:40px;border-radius:50%;background:linear-gradient(135deg,#7C3AED,#EC4899);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700">${pessoa.nome[0]}</div>`;

            const badgeTipo = pessoa.tipo === 'profissional' ? 'primary' : 'info';
            const medalha = index === 0 ? '🥇' : index === 1 ? '🥈' : index === 2 ? '🥉' : '';

            return `
                <tr>
                    <td><strong>${index + 1}º ${medalha}</strong></td>
                    <td>${foto}</td>
                    <td><strong>${pessoa.nome}</strong></td>
                    <td><span class="badge ${badgeTipo}">${pessoa.tipo}</span></td>
                    <td><strong style="color:var(--success)">R$ ${pessoa.total_comissoes.toFixed(2).replace('.', ',')}</strong></td>
                    <td>${pessoa.total_orcamentos}</td>
                    <td>R$ ${pessoa.media_comissao.toFixed(2).replace('.', ',')}</td>
                </tr>
            `;
        }).join('');

    } catch (error) {
        console.error('Erro ao carregar ranking:', error);
        const tbody = document.getElementById('rankingProfissionaisBody');
        if (tbody) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center text-danger">Erro ao carregar ranking</td></tr>';
        }
    }
}

// Modificar showSubTab existente para carregar dados
const originalShowSubTab = typeof showSubTab !== 'undefined' ? showSubTab : null;
function showSubTab(section, tab) {
    // Chamar função original se existir
    if (originalShowSubTab && originalShowSubTab !== showSubTab) {
        originalShowSubTab(section, tab);
    } else {
        // Implementação padrão
        const sectionElement = document.getElementById(`section-${section}`);
        if (!sectionElement) return;
        
        // Desativar todos os botões e conteúdos
        sectionElement.querySelectorAll('.sub-tab-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        sectionElement.querySelectorAll('.sub-tab-content').forEach(content => {
            content.classList.remove('active');
        });

        // Ativar botão clicado
        const clickedBtn = Array.from(sectionElement.querySelectorAll('.sub-tab-btn'))
            .find(btn => btn.onclick.toString().includes(`'${tab}'`));
        if (clickedBtn) clickedBtn.classList.add('active');

        // Ativar conteúdo correspondente
        const tabContent = document.getElementById(`${section}-${tab}`);
        if (tabContent) tabContent.classList.add('active');
    }
    
    // Carregar dados específicos da tab
    if (section === 'profissionais') {
        if (tab === 'comissoes') {
            carregarProfissionaisFiltro();
        } else if (tab === 'estatisticas') {
            carregarRankingProfissionais();
        }
    }
}
// ========== FIM SISTEMA DE COMISSÕES ==========

// ========== SISTEMA DE ANAMNESE E PRONTUÁRIO ====================
let currentClienteCPF = null;

async function buscarAnamnesesCliente() {
    const cpf = document.getElementById('anamneseCPF')?.value?.trim();
    
    if (!cpf) {
        Swal.fire('Atenção', 'Digite o CPF do cliente', 'warning');
        return;
    }
    
    try {
        const res = await fetch(`/api/clientes/${cpf}/anamnese`, {credentials: 'include'});
        
        if (!res.ok) {
            if (res.status === 404) {
                Swal.fire('Erro', 'Cliente não encontrado', 'error');
                return;
            }
            throw new Error('Erro ao buscar anamneses');
        }
        
        const { cliente, anamneses } = await res.json();
        
        currentClienteCPF = cpf;
        document.getElementById('anamnesesClienteNome').textContent = cliente.nome;
        document.getElementById('anamnesesResultado').style.display = 'block';
        document.getElementById('anamneseMensagemInicial').style.display = 'none';
        
        renderizarHistoricoAnamneses(anamneses);
        
    } catch (error) {
        console.error('Erro:', error);
        Swal.fire('Erro', 'Não foi possível carregar as anamneses', 'error');
    }
}

function renderizarHistoricoAnamneses(anamneses) {
    const tbody = document.getElementById('anamnesesHistoricoBody');
    if (!tbody) return;
    
    if (!anamneses || anamneses.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">Nenhuma anamnese encontrada</td></tr>';
        return;
    }
    
    tbody.innerHTML = anamneses.map(anamnese => {
        const data = new Date(anamnese.data_cadastro).toLocaleDateString('pt-BR');
        return `
            <tr>
                <td><span class="badge primary">v${anamnese.versao}</span></td>
                <td>${data}</td>
                <td>${anamnese.cadastrado_por || 'N/A'}</td>
                <td>
                    <button class="btn btn-sm btn-outline" onclick="visualizarAnamnese('${anamnese._id}')">
                        <i class="bi bi-eye"></i> Visualizar
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="deletarAnamnese('${anamnese._id}')">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>
            </tr>
        `;
    }).join('');
}

async function novaAnamneseModal() {
    const { value: formValues } = await Swal.fire({
        title: 'Nova Anamnese',
        html: `
            <div style="text-align:left;">
                <label>Observações Gerais:</label>
                <textarea id="anamneseObs" class="swal2-textarea" placeholder="Digite as observações da anamnese..."></textarea>
                
                <div class="alert alert-info mt-3" style="font-size:0.9rem;">
                    <i class="bi bi-info-circle"></i> Campos adicionais podem ser preenchidos posteriormente no formulário completo
                </div>
            </div>
        `,
        focusConfirm: false,
        showCancelButton: true,
        confirmButtonText: 'Salvar',
        cancelButtonText: 'Cancelar',
        preConfirm: () => {
            return {
                observacoes: document.getElementById('anamneseObs').value
            };
        }
    });
    
    if (formValues) {
        try {
            const res = await fetch(`/api/clientes/${currentClienteCPF}/anamnese`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                credentials: 'include',
                body: JSON.stringify({
                    respostas: {},
                    observacoes: formValues.observacoes
                })
            });
            
            if (!res.ok) throw new Error('Erro ao salvar anamnese');
            
            Swal.fire('Sucesso', 'Anamnese salva com sucesso!', 'success');
            buscarAnamnesesCliente(); // Recarregar lista
            
        } catch (error) {
            console.error('Erro:', error);
            Swal.fire('Erro', 'Não foi possível salvar a anamnese', 'error');
        }
    }
}

async function visualizarAnamnese(id) {
    try {
        const res = await fetch(`/api/clientes/${currentClienteCPF}/anamnese/${id}`, {
            credentials: 'include'
        });
        
        if (!res.ok) throw new Error('Erro ao buscar anamnese');
        
        const { anamnese } = await res.json();
        const data = new Date(anamnese.data_cadastro).toLocaleDateString('pt-BR');
        
        Swal.fire({
            title: `Anamnese v${anamnese.versao}`,
            html: `
                <div style="text-align:left;">
                    <p><strong>Data:</strong> ${data}</p>
                    <p><strong>Cadastrado por:</strong> ${anamnese.cadastrado_por || 'N/A'}</p>
                    <hr>
                    <p><strong>Observações:</strong></p>
                    <p>${anamnese.observacoes || 'Nenhuma observação registrada'}</p>
                </div>
            `,
            width: 600,
            confirmButtonText: 'Fechar',
            allowEscapeKey: true,
            allowOutsideClick: true,
            showCloseButton: true,
            focusConfirm: true
        });
        
    } catch (error) {
        console.error('Erro:', error);
        Swal.fire('Erro', 'Não foi possível visualizar a anamnese', 'error');
    }
}

async function deletarAnamnese(id) {
    const result = await Swal.fire({
        title: 'Confirmar exclusão?',
        text: 'Esta ação não pode ser desfeita!',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Sim, deletar!',
        cancelButtonText: 'Cancelar'
    });

    if (result.isConfirmed) {
        try {
            const res = await fetch(`/api/clientes/${currentClienteCPF}/anamnese/${id}`, {
                method: 'DELETE',
                credentials: 'include'
            });

            if (!res.ok) throw new Error('Erro ao deletar anamnese');

            Swal.fire('Deletado!', 'Anamnese removida com sucesso', 'success');
            buscarAnamnesesCliente(); // Recarregar lista

        } catch (error) {
            console.error('Erro:', error);
            Swal.fire('Erro', 'Não foi possível deletar a anamnese', 'error');
        }
    }

    // Limpeza de backdrop residual
    setTimeout(() => {
        document.querySelectorAll('.swal2-container, .swal2-backdrop-show').forEach(el => {
            if (!Swal.isVisible()) el.remove();
        });
        document.body.classList.remove('swal2-shown', 'swal2-height-auto');
    }, 100);
}

// ========== PRONTUÁRIO ==========
async function buscarProntuariosCliente() {
    const cpf = document.getElementById('prontuarioCPF')?.value?.trim();
    
    if (!cpf) {
        Swal.fire('Atenção', 'Digite o CPF do cliente', 'warning');
        return;
    }
    
    try {
        const res = await fetch(`/api/clientes/${cpf}/prontuario`, {credentials: 'include'});
        
        if (!res.ok) {
            if (res.status === 404) {
                Swal.fire('Erro', 'Cliente não encontrado', 'error');
                return;
            }
            throw new Error('Erro ao buscar prontuários');
        }
        
        const { cliente, prontuarios } = await res.json();
        
        currentClienteCPF = cpf;
        document.getElementById('prontuariosClienteNome').textContent = cliente.nome;
        document.getElementById('prontuariosResultado').style.display = 'block';
        document.getElementById('prontuarioMensagemInicial').style.display = 'none';
        
        renderizarHistoricoProntuarios(prontuarios);
        
    } catch (error) {
        console.error('Erro:', error);
        Swal.fire('Erro', 'Não foi possível carregar os prontuários', 'error');
    }
}

function renderizarHistoricoProntuarios(prontuarios) {
    const tbody = document.getElementById('prontuariosHistoricoBody');
    if (!tbody) return;
    
    if (!prontuarios || prontuarios.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Nenhum prontuário encontrado</td></tr>';
        return;
    }
    
    tbody.innerHTML = prontuarios.map(pront => {
        const data = new Date(pront.data_atendimento).toLocaleDateString('pt-BR');
        const proxima = pront.proxima_sessao ? new Date(pront.proxima_sessao).toLocaleDateString('pt-BR') : 'N/A';
        
        return `
            <tr>
                <td>${data}</td>
                <td>${pront.profissional || 'N/A'}</td>
                <td>${pront.procedimento || 'N/A'}</td>
                <td>${proxima}</td>
                <td>
                    <button class="btn btn-sm btn-outline" onclick="visualizarProntuario('${pront._id}')">
                        <i class="bi bi-eye"></i> Visualizar
                    </button>
                    <button class="btn btn-sm btn-primary" onclick="editarProntuario('${pront._id}')">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="deletarProntuario('${pront._id}')">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>
            </tr>
        `;
    }).join('');
}

async function novoProntuarioModal() {
    const { value: formValues } = await Swal.fire({
        title: 'Novo Prontuário',
        html: `
            <div style="text-align:left;">
                <label>Data do Atendimento:</label>
                <input type="date" id="prontDataAtend" class="swal2-input" value="${new Date().toISOString().split('T')[0]}">
                
                <label>Profissional:</label>
                <input type="text" id="prontProfissional" class="swal2-input" placeholder="Nome do profissional">
                
                <label>Procedimento:</label>
                <input type="text" id="prontProcedimento" class="swal2-input" placeholder="Tipo de procedimento">
                
                <label>Observações:</label>
                <textarea id="prontObs" class="swal2-textarea" placeholder="Observações do atendimento"></textarea>
                
                <label>Próxima Sessão (opcional):</label>
                <input type="date" id="prontProxima" class="swal2-input">
            </div>
        `,
        width: 600,
        focusConfirm: false,
        showCancelButton: true,
        confirmButtonText: 'Salvar',
        cancelButtonText: 'Cancelar',
        preConfirm: () => {
            return {
                data_atendimento: document.getElementById('prontDataAtend').value + 'T00:00:00',
                profissional: document.getElementById('prontProfissional').value,
                procedimento: document.getElementById('prontProcedimento').value,
                observacoes: document.getElementById('prontObs').value,
                proxima_sessao: document.getElementById('prontProxima').value || ''
            };
        }
    });
    
    if (formValues) {
        try {
            const res = await fetch(`/api/clientes/${currentClienteCPF}/prontuario`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                credentials: 'include',
                body: JSON.stringify(formValues)
            });
            
            if (!res.ok) throw new Error('Erro ao salvar prontuário');
            
            Swal.fire('Sucesso', 'Prontuário salvo com sucesso!', 'success');
            buscarProntuariosCliente(); // Recarregar lista
            
        } catch (error) {
            console.error('Erro:', error);
            Swal.fire('Erro', 'Não foi possível salvar o prontuário', 'error');
        }
    }
}

async function visualizarProntuario(id) {
    try {
        const res = await fetch(`/api/clientes/${currentClienteCPF}/prontuario/${id}`, {
            credentials: 'include'
        });
        
        if (!res.ok) throw new Error('Erro ao buscar prontuário');
        
        const { prontuario } = await res.json();
        const data = new Date(prontuario.data_atendimento).toLocaleDateString('pt-BR');
        const proxima = prontuario.proxima_sessao ? new Date(prontuario.proxima_sessao).toLocaleDateString('pt-BR') : 'N/A';
        
        Swal.fire({
            title: 'Prontuário de Atendimento',
            html: `
                <div style="text-align:left;">
                    <p><strong>Data do Atendimento:</strong> ${data}</p>
                    <p><strong>Profissional:</strong> ${prontuario.profissional || 'N/A'}</p>
                    <p><strong>Procedimento:</strong> ${prontuario.procedimento || 'N/A'}</p>
                    <p><strong>Próxima Sessão:</strong> ${proxima}</p>
                    <hr>
                    <p><strong>Observações:</strong></p>
                    <p>${prontuario.observacoes || 'Nenhuma observação registrada'}</p>
                    <hr>
                    <p><strong>Cadastrado por:</strong> ${prontuario.cadastrado_por || 'N/A'}</p>
                </div>
            `,
            width: 600,
            confirmButtonText: 'Fechar',
            allowEscapeKey: true,
            allowOutsideClick: true,
            showCloseButton: true,
            focusConfirm: true
        });
        
    } catch (error) {
        console.error('Erro:', error);
        Swal.fire('Erro', 'Não foi possível visualizar o prontuário', 'error');
    }
}

async function editarProntuario(id) {
    try {
        // Buscar prontuário atual
        const res = await fetch(`/api/clientes/${currentClienteCPF}/prontuario/${id}`, {
            credentials: 'include'
        });
        
        if (!res.ok) throw new Error('Erro ao buscar prontuário');
        
        const { prontuario } = await res.json();
        
        const { value: formValues } = await Swal.fire({
            title: 'Editar Prontuário',
            html: `
                <div style="text-align:left;">
                    <label>Data do Atendimento:</label>
                    <input type="date" id="prontDataAtend" class="swal2-input" value="${prontuario.data_atendimento.split('T')[0]}">
                    
                    <label>Profissional:</label>
                    <input type="text" id="prontProfissional" class="swal2-input" value="${prontuario.profissional || ''}" placeholder="Nome do profissional">
                    
                    <label>Procedimento:</label>
                    <input type="text" id="prontProcedimento" class="swal2-input" value="${prontuario.procedimento || ''}" placeholder="Tipo de procedimento">
                    
                    <label>Observações:</label>
                    <textarea id="prontObs" class="swal2-textarea" placeholder="Observações do atendimento">${prontuario.observacoes || ''}</textarea>
                    
                    <label>Próxima Sessão (opcional):</label>
                    <input type="date" id="prontProxima" class="swal2-input" value="${prontuario.proxima_sessao ? prontuario.proxima_sessao.split('T')[0] : ''}">
                </div>
            `,
            width: 600,
            focusConfirm: false,
            showCancelButton: true,
            confirmButtonText: 'Salvar',
            cancelButtonText: 'Cancelar',
            preConfirm: () => {
                return {
                    data_atendimento: document.getElementById('prontDataAtend').value + 'T00:00:00',
                    profissional: document.getElementById('prontProfissional').value,
                    procedimento: document.getElementById('prontProcedimento').value,
                    observacoes: document.getElementById('prontObs').value,
                    proxima_sessao: document.getElementById('prontProxima').value || ''
                };
            }
        });
        
        if (formValues) {
            const updateRes = await fetch(`/api/clientes/${currentClienteCPF}/prontuario/${id}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                credentials: 'include',
                body: JSON.stringify(formValues)
            });
            
            if (!updateRes.ok) throw new Error('Erro ao atualizar prontuário');
            
            Swal.fire('Sucesso', 'Prontuário atualizado com sucesso!', 'success');
            buscarProntuariosCliente(); // Recarregar lista
        }
        
    } catch (error) {
        console.error('Erro:', error);
        Swal.fire('Erro', 'Não foi possível editar o prontuário', 'error');
    }
}

async function deletarProntuario(id) {
    const result = await Swal.fire({
        title: 'Confirmar exclusão?',
        text: 'Esta ação não pode ser desfeita!',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Sim, deletar!',
        cancelButtonText: 'Cancelar'
    });

    if (result.isConfirmed) {
        try {
            const res = await fetch(`/api/clientes/${currentClienteCPF}/prontuario/${id}`, {
                method: 'DELETE',
                credentials: 'include'
            });

            if (!res.ok) throw new Error('Erro ao deletar prontuário');

            Swal.fire('Deletado!', 'Prontuário removido com sucesso', 'success');
            buscarProntuariosCliente(); // Recarregar lista

        } catch (error) {
            console.error('Erro:', error);
            Swal.fire('Erro', 'Não foi possível deletar o prontuário', 'error');
        }
    }

    // Limpeza de backdrop residual
    setTimeout(() => {
        document.querySelectorAll('.swal2-container, .swal2-backdrop-show').forEach(el => {
            if (!Swal.isVisible()) el.remove();
        });
        document.body.classList.remove('swal2-shown', 'swal2-height-auto');
    }, 100);
}
// ========== FIM ANAMNESE E PRONTUÁRIO ==========

// ========== SISTEMA DE SUB-TABS GLOBAL ====================
// switchSubTab já foi definida no início do script (linha ~2709)

async function carregarDadosSubTab(section, subtab) {
    console.log(`🚀 Loading data for sub-tab: ${section} -> ${subtab}`);

    try {
        // Add specific calls based on section and subtab
        if (section === 'orcamento') {
            if (subtab === 'pendentes') await carregarOrcamentosPendentes();
            else if (subtab === 'aprovados') await carregarOrcamentosAprovados();
            else if (subtab === 'rejeitados') await carregarOrcamentosRejeitados();
            else if (subtab === 'historico') await carregarHistoricoOrcamentos();
        } else if (section === 'agendamentos') {
            if (subtab === 'hoje') await carregarAgendamentosHoje();
            else if (subtab === 'semana') await carregarAgendamentosSemana();
            else if (subtab === 'mes') await carregarAgendamentosMes();
            else if (subtab === 'todos') await carregarTodosAgendamentos();
        } else if (section === 'produtos') {
            if (subtab === 'todos') await carregarProdutosTodos();
            else if (subtab === 'ativos') await carregarProdutosAtivos();
            else if (subtab === 'inativos') await carregarProdutosInativos();
        } else if (section === 'servicos') {
            if (subtab === 'todos') await carregarServicosTodos();
            else if (subtab === 'ativos') await carregarServicosAtivos();
        } else if (section === 'estoque') {
            if (subtab === 'visaogeral') await carregarEstoqueVisaoGeral();
            else if (subtab === 'produtos') await carregarProdutosEstoque();
            else if (subtab === 'movimentacoes') await carregarMovimentacoesEstoque();
            else if (subtab === 'relatorios') await carregarRelatoriosEstoque();
        } else if (section === 'profissionais') {
            if (subtab === 'lista') await loadProfissionais();
            else if (subtab === 'comissoes') await carregarComissoesProfissionais();
            else if (subtab === 'estatisticas') await carregarEstatisticasProfissionais();
            else if (subtab === 'assistentes') await loadAssistentes();
        } else if (section === 'financeiro') {
            if (subtab === 'resumo') await carregarFinanceiroResumo();
            else if (subtab === 'receitas') await carregarReceitas();
            else if (subtab === 'despesas') await carregarDespesas();
            else if (subtab === 'comissoes') await carregarHistoricoComissoes();
        }

        console.log(`✅ Finished loading: ${section} -> ${subtab}`);
    } catch(e) {
        console.error(`❌ Error loading sub-tab ${section} -> ${subtab}:`, e);
    }
}
// ========== FIM SUB-TABS GLOBAL ==========

// ========== SISTEMA DE SUB-TABS - ORÇAMENTOS ====================
async function carregarOrcamentosPendentes() {
    const tbody = document.getElementById('orcamentosPendentesBody');
    if (!tbody) return;
    
    try {
        const res = await fetch('/api/orcamentos?status=Pendente', {credentials: 'include'});
        if (!res.ok) throw new Error('Erro ao carregar orçamentos');

        const data = await res.json();
        const orcamentos = data.orcamentos || [];

        if (!orcamentos || orcamentos.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Nenhum orçamento pendente</td></tr>';
            return;
        }

        tbody.innerHTML = orcamentos.map(orc => {
            const dataStr = orc.data || orc.created_at || new Date().toISOString();
            const data = new Date(dataStr).toLocaleDateString('pt-BR');
            const profs = orc.profissionais_vinculados?.map(p => p.nome).join(', ') || 'N/A';
            const nome = orc.cliente_nome || orc.nome || 'Sem nome';
            const cpf = orc.cliente_cpf || orc.cpf || 'Sem CPF';
            return `
                <tr>
                    <td>${data}</td>
                    <td>${nome}</td>
                    <td>${cpf}</td>
                    <td>R$ ${parseFloat(orc.total_final || 0).toFixed(2)}</td>
                    <td>${profs}</td>
                    <td>
                        <button class="btn btn-sm btn-outline" onclick="visualizarOrcamento('${orc._id}')">
                            <i class="bi bi-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-success" onclick="aprovarOrcamento('${orc._id}')">
                            <i class="bi bi-check"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="rejeitarOrcamento('${orc._id}')">
                            <i class="bi bi-x"></i>
                        </button>
                    </td>
                </tr>
            `;
        }).join('');
        
    } catch (error) {
        console.error('Erro:', error);
        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Erro ao carregar orçamentos</td></tr>';
    }
}

async function carregarOrcamentosAprovados() {
    const tbody = document.getElementById('orcamentosAprovadosBody');
    if (!tbody) return;
    
    try {
        const res = await fetch('/api/orcamentos?status=Aprovado', {credentials: 'include'});
        if (!res.ok) throw new Error('Erro ao carregar orçamentos');

        const data = await res.json();
        const orcamentos = data.orcamentos || [];

        if (!orcamentos || orcamentos.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Nenhum orçamento aprovado</td></tr>';
            return;
        }

        tbody.innerHTML = orcamentos.map(orc => {
            const dataStr = orc.data || orc.created_at || new Date().toISOString();
            const data = new Date(dataStr).toLocaleDateString('pt-BR');
            const nome = orc.cliente_nome || orc.nome || 'Sem nome';
            const cpf = orc.cliente_cpf || orc.cpf || 'Sem CPF';
            return `
                <tr>
                    <td>${data}</td>
                    <td>${nome}</td>
                    <td>${cpf}</td>
                    <td>R$ ${parseFloat(orc.total_final || 0).toFixed(2)}</td>
                    <td>${(typeof orc.pagamento === 'object' ? orc.pagamento.tipo : orc.pagamento) || orc.forma_pagamento || 'N/A'}</td>
                    <td>
                        <button class="btn btn-sm btn-outline" onclick="visualizarOrcamento('${orc._id}')">
                            <i class="bi bi-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-primary" onclick="imprimirContrato('${orc._id}')">
                            <i class="bi bi-printer"></i>
                        </button>
                    </td>
                </tr>
            `;
        }).join('');
        
    } catch (error) {
        console.error('Erro:', error);
        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Erro ao carregar orçamentos</td></tr>';
    }
}

async function carregarOrcamentosRejeitados() {
    const tbody = document.getElementById('orcamentosRejeitadosBody');
    if (!tbody) return;
    
    try {
        const res = await fetch('/api/orcamentos?status=Rejeitado', {credentials: 'include'});
        if (!res.ok) throw new Error('Erro ao carregar orçamentos');

        const data = await res.json();
        const orcamentos = data.orcamentos || [];

        if (!orcamentos || orcamentos.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Nenhum orçamento rejeitado</td></tr>';
            return;
        }

        tbody.innerHTML = orcamentos.map(orc => {
            const dataStr = orc.data || orc.created_at || new Date().toISOString();
            const data = new Date(dataStr).toLocaleDateString('pt-BR');
            const nome = orc.cliente_nome || orc.nome || 'Sem nome';
            const cpf = orc.cliente_cpf || orc.cpf || 'Sem CPF';
            return `
                <tr>
                    <td>${data}</td>
                    <td>${nome}</td>
                    <td>${cpf}</td>
                    <td>R$ ${parseFloat(orc.total_final || 0).toFixed(2)}</td>
                    <td>${orc.motivo_rejeicao || 'N/A'}</td>
                    <td>
                        <button class="btn btn-sm btn-outline" onclick="visualizarOrcamento('${orc._id}')">
                            <i class="bi bi-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deletarOrcamento('${orc._id}')">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
        }).join('');
        
    } catch (error) {
        console.error('Erro:', error);
        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Erro ao carregar orçamentos</td></tr>';
    }
}

async function carregarHistoricoOrcamentos() {
    const tbody = document.getElementById('orcamentosHistoricoBody');
    if (!tbody) return;
    
    const periodo = document.getElementById('filtroHistoricoPeriodo')?.value || '30';
    const status = document.getElementById('filtroHistoricoStatus')?.value || '';
    const cliente = document.getElementById('filtroHistoricoCliente')?.value || '';
    
    try {
        let url = `/api/orcamentos?periodo=${periodo}`;
        if (status) url += `&status=${status}`;
        if (cliente) url += `&cliente=${encodeURIComponent(cliente)}`;
        
        const res = await fetch(url, {credentials: 'include'});
        if (!res.ok) throw new Error('Erro ao carregar histórico');

        const data = await res.json();
        const orcamentos = data.orcamentos || [];

        if (!orcamentos || orcamentos.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Nenhum orçamento encontrado</td></tr>';
            return;
        }

        tbody.innerHTML = orcamentos.map(orc => {
            const dataStr = orc.data || orc.created_at || new Date().toISOString();
            const data = new Date(dataStr).toLocaleDateString('pt-BR');
            const nome = orc.cliente_nome || orc.nome || 'Sem nome';
            const cpf = orc.cliente_cpf || orc.cpf || 'Sem CPF';
            const statusClass = orc.status === 'Aprovado' ? 'success' : orc.status === 'Rejeitado' ? 'danger' : 'warning';
            return `
                <tr>
                    <td>${data}</td>
                    <td>${nome}</td>
                    <td>${cpf}</td>
                    <td>R$ ${parseFloat(orc.total_final || 0).toFixed(2)}</td>
                    <td><span class="badge ${statusClass}">${orc.status}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline" onclick="visualizarOrcamento('${orc._id}')">
                            <i class="bi bi-eye"></i>
                        </button>
                    </td>
                </tr>
            `;
        }).join('');
        
    } catch (error) {
        console.error('Erro:', error);
        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Erro ao carregar histórico</td></tr>';
    }
}

async function aprovarOrcamento(id) {
    const result = await Swal.fire({
        title: 'Aprovar Orçamento?',
        text: 'O orçamento será marcado como aprovado',
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'Sim, aprovar',
        cancelButtonText: 'Cancelar'
    });
    
    if (result.isConfirmed) {
        try {
            const res = await fetch(`/api/orcamentos/${id}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                credentials: 'include',
                body: JSON.stringify({ status: 'Aprovado' })
            });
            
            if (!res.ok) throw new Error('Erro ao aprovar orçamento');
            
            Swal.fire('Aprovado!', 'Orçamento aprovado com sucesso', 'success');
            carregarOrcamentosPendentes();
            
        } catch (error) {
            console.error('Erro:', error);
            Swal.fire('Erro', 'Não foi possível aprovar o orçamento', 'error');
        }
    }
}

async function rejeitarOrcamento(id) {
    const { value: motivo } = await Swal.fire({
        title: 'Rejeitar Orçamento',
        input: 'textarea',
        inputLabel: 'Motivo da rejeição',
        inputPlaceholder: 'Digite o motivo...',
        showCancelButton: true,
        confirmButtonText: 'Rejeitar',
        cancelButtonText: 'Cancelar'
    });
    
    if (motivo) {
        try {
            const res = await fetch(`/api/orcamentos/${id}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                credentials: 'include',
                body: JSON.stringify({ status: 'Rejeitado', motivo_rejeicao: motivo })
            });
            
            if (!res.ok) throw new Error('Erro ao rejeitar orçamento');
            
            Swal.fire('Rejeitado!', 'Orçamento rejeitado', 'success');
            carregarOrcamentosPendentes();
            
        } catch (error) {
            console.error('Erro:', error);
            Swal.fire('Erro', 'Não foi possível rejeitar o orçamento', 'error');
        }
    }
}
// ========== FIM SUB-TABS ORÇAMENTOS ==========

// ========== SISTEMA DE SUB-TABS - AGENDAMENTOS (CORRIGIDO) ====================
async function carregarAgendamentosHoje() {
    const FUNC_KEY = 'agendamentosHoje';
    const tbody = document.getElementById('agendamentosHojeBody');
    if (!tbody) return;
    
    // Prevenir múltiplas chamadas
    if (window.loadingStates && window.loadingStates[FUNC_KEY]) {
        console.log('⏳ Já está carregando agendamentos hoje...');
        return;
    }
    
    try {
        // Marcar como carregando
        if (!window.loadingStates) window.loadingStates = {};
        window.loadingStates[FUNC_KEY] = true;
        
        console.log('📅 Carregando agendamentos de hoje...');
        
        const res = await fetch('/api/agendamentos/hoje', {credentials: 'include'});
        if (!res.ok) throw new Error('Erro ao carregar agendamentos');
        
        const data = await res.json();
        
        if (!data.success) {
            throw new Error(data.message || 'Erro ao carregar agendamentos');
        }
        
        const agendamentos = data.agendamentos || [];
        
        // Atualizar estatísticas (vindas do backend)
        document.getElementById('agendamentosHojeTotal').textContent = data.total || 0;
        document.getElementById('agendamentosHojePendentes').textContent = data.pendentes || 0;
        document.getElementById('agendamentosHojeConfirmados').textContent = data.confirmados || 0;
        document.getElementById('agendamentosHojeCancelados').textContent = data.cancelados || 0;
        
        if (!agendamentos || agendamentos.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Nenhum agendamento para hoje</td></tr>';
            return;
        }
        
        tbody.innerHTML = agendamentos.map(ag => {
            const statusClass = ag.status === 'Confirmado' ? 'success' : ag.status === 'Cancelado' ? 'danger' : 'warning';
            const horario = ag.horario || ag.hora || 'N/A';
            const clienteNome = ag.cliente_nome || ag.cliente?.nome || 'Cliente não informado';
            const servico = ag.servico || ag.servico_nome || ag.servico?.nome || 'Serviço não informado';
            const profissional = ag.profissional || ag.profissional_nome || ag.profissional?.nome || 'Profissional não informado';
            const status = ag.status || 'Pendente';

            return `
                <tr>
                    <td>${horario}</td>
                    <td>${clienteNome}</td>
                    <td>${servico}</td>
                    <td>${profissional}</td>
                    <td><span class="badge ${statusClass}">${status}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline" onclick="visualizarAgendamento('${ag._id}')">
                            <i class="bi bi-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-primary" onclick="editarAgendamento('${ag._id}')">
                            <i class="bi bi-pencil"></i>
                        </button>
                    </td>
                </tr>
            `;
        }).join('');

        console.log(`✅ ${agendamentos.length} agendamentos de hoje carregados`);

    } catch (error) {
        console.error('❌ Erro ao carregar agendamentos de hoje:', error);
        Swal.fire('Erro', 'Não foi possível carregar os agendamentos de hoje', 'error');
        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Erro ao carregar dados</td></tr>';
    } finally {
        // SEMPRE limpar estado
        if (window.loadingStates) {
            window.loadingStates[FUNC_KEY] = false;
        }
    }
}

async function carregarAgendamentosSemana() {
    const FUNC_KEY = 'agendamentosSemana';
    const tbody = document.getElementById('agendamentosSemanaBody');
    if (!tbody) return;

    if (window.loadingStates?.[FUNC_KEY]) return;

    try {
        if (!window.loadingStates) window.loadingStates = {};
        window.loadingStates[FUNC_KEY] = true;

        const res = await fetch('/api/agendamentos/semana', {credentials: 'include'});
        if (!res.ok) throw new Error('Erro ao carregar agendamentos');

        const data = await res.json();
        const agendamentos = data.agendamentos || data;

        if (!agendamentos || agendamentos.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">Nenhum agendamento esta semana</td></tr>';
            return;
        }

        tbody.innerHTML = agendamentos.map(ag => {
            const dataFormatada = ag.data ? new Date(ag.data).toLocaleDateString('pt-BR') : 'Data não informada';
            const statusClass = ag.status === 'Confirmado' ? 'success' : ag.status === 'Cancelado' ? 'danger' : 'warning';
            const horario = ag.horario || ag.hora || 'N/A';
            const clienteNome = ag.cliente_nome || ag.cliente?.nome || 'Cliente não informado';
            const servico = ag.servico || ag.servico_nome || ag.servico?.nome || 'Serviço não informado';
            const profissional = ag.profissional || ag.profissional_nome || ag.profissional?.nome || 'Profissional não informado';
            const status = ag.status || 'Pendente';

            return `
                <tr>
                    <td>${dataFormatada}</td>
                    <td>${horario}</td>
                    <td>${clienteNome}</td>
                    <td>${servico}</td>
                    <td>${profissional}</td>
                    <td><span class="badge ${statusClass}">${status}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline" onclick="visualizarAgendamento('${ag._id}')">
                            <i class="bi bi-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-primary" onclick="editarAgendamento('${ag._id}')">
                            <i class="bi bi-pencil"></i>
                        </button>
                    </td>
                </tr>
            `;
        }).join('');

        console.log(`✅ ${agendamentos.length} agendamentos da semana carregados`);

    } catch (error) {
        console.error('❌ Erro ao carregar agendamentos da semana:', error);
        Swal.fire('Erro', 'Falha ao carregar agendamentos da semana', 'error');
        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-danger">Erro ao carregar agendamentos</td></tr>';
    } finally {
        if (window.loadingStates) window.loadingStates[FUNC_KEY] = false;
    }
}

async function carregarAgendamentosMes() {
    const FUNC_KEY = 'agendamentosMes';
    const tbody = document.getElementById('agendamentosMesBody');
    if (!tbody) return;

    if (window.loadingStates?.[FUNC_KEY]) return;

    try {
        if (!window.loadingStates) window.loadingStates = {};
        window.loadingStates[FUNC_KEY] = true;

        const res = await fetch('/api/agendamentos/mes', {credentials: 'include'});
        if (!res.ok) throw new Error('Erro ao carregar agendamentos');

        const data = await res.json();
        const agendamentos = data.agendamentos || data;

        if (!agendamentos || agendamentos.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">Nenhum agendamento este mês</td></tr>';
            return;
        }

        tbody.innerHTML = agendamentos.map(ag => {
            const dataFormatada = ag.data ? new Date(ag.data).toLocaleDateString('pt-BR') : 'Data não informada';
            const statusClass = ag.status === 'Confirmado' ? 'success' : ag.status === 'Cancelado' ? 'danger' : 'warning';
            const horario = ag.horario || ag.hora || 'N/A';
            const clienteNome = ag.cliente_nome || ag.cliente?.nome || 'Cliente não informado';
            const servico = ag.servico || ag.servico_nome || ag.servico?.nome || 'Serviço não informado';
            const profissional = ag.profissional || ag.profissional_nome || ag.profissional?.nome || 'Profissional não informado';
            const status = ag.status || 'Pendente';

            return `
                <tr>
                    <td>${dataFormatada}</td>
                    <td>${horario}</td>
                    <td>${clienteNome}</td>
                    <td>${servico}</td>
                    <td>${profissional}</td>
                    <td><span class="badge ${statusClass}">${status}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline" onclick="visualizarAgendamento('${ag._id}')">
                            <i class="bi bi-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-primary" onclick="editarAgendamento('${ag._id}')">
                            <i class="bi bi-pencil"></i>
                        </button>
                    </td>
                </tr>
            `;
        }).join('');

        console.log(`✅ ${agendamentos.length} agendamentos do mês carregados`);

    } catch (error) {
        console.error('❌ Erro ao carregar agendamentos do mês:', error);
        Swal.fire('Erro', 'Falha ao carregar agendamentos do mês', 'error');
        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-danger">Erro ao carregar agendamentos</td></tr>';
    } finally {
        if (window.loadingStates) window.loadingStates[FUNC_KEY] = false;
    }
}

async function carregarTodosAgendamentos() {
    const FUNC_KEY = 'todosAgendamentos';
    const tbody = document.getElementById('agendamentosTodosBody');
    if (!tbody) return;
    
    if (window.loadingStates?.[FUNC_KEY]) return;
    
    const dataInicio = document.getElementById('filtroAgendamentoDataInicio')?.value || '';
    const dataFim = document.getElementById('filtroAgendamentoDataFim')?.value || '';
    const status = document.getElementById('filtroAgendamentoStatus')?.value || '';
    
    try {
        let url = '/api/agendamentos?';
        if (dataInicio) url += `data_inicio=${dataInicio}&`;
        if (dataFim) url += `data_fim=${dataFim}&`;
        if (status) url += `status=${status}&`;
        
        const res = await fetch(url, {credentials: 'include'});
        if (!res.ok) throw new Error('Erro ao carregar agendamentos');

        const data = await res.json();
        const agendamentos = data.agendamentos || [];

        if (!agendamentos || agendamentos.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">Nenhum agendamento encontrado</td></tr>';
            return;
        }

        tbody.innerHTML = agendamentos.map(ag => {
            const data = new Date(ag.data).toLocaleDateString('pt-BR');
            const statusClass = ag.status === 'Confirmado' ? 'success' : ag.status === 'Cancelado' ? 'danger' : 'warning';
            return `
                <tr>
                    <td>${data}</td>
                    <td>${ag.horario}</td>
                    <td>${ag.cliente_nome}</td>
                    <td>${ag.servico}</td>
                    <td>${ag.profissional}</td>
                    <td><span class="badge ${statusClass}">${ag.status}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline" onclick="visualizarAgendamento('${ag._id}')">
                            <i class="bi bi-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-primary" onclick="editarAgendamento('${ag._id}')">
                            <i class="bi bi-pencil"></i>
                        </button>
                    </td>
                </tr>
            `;
        }).join('');
        
    } catch (error) {
        console.error('❌ Erro:', error);
        Swal.fire('Erro', 'Falha ao carregar todos os agendamentos', 'error');
        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-danger">Erro ao carregar agendamentos</td></tr>';
    } finally {
        if (window.loadingStates) window.loadingStates[FUNC_KEY] = false;
    }
}
// ========== FIM SUB-TABS AGENDAMENTOS ==========

// ========== SISTEMA DE SUB-TABS - PRODUTOS ====================
async function carregarProdutosTodos() {
    const FUNC_KEY = 'produtosTodos';
    const tbody = document.getElementById('produtosTodosBody');
    if (!tbody) return;
    if (window.loadingStates?.[FUNC_KEY]) return;
    
    try {
        if (!window.loadingStates) window.loadingStates = {};
        window.loadingStates[FUNC_KEY] = true;
        
        const res = await fetch('/api/produtos', {credentials: 'include'});
        if (!res.ok) throw new Error('Erro ao carregar produtos');
        
        const data = await res.json();
        const produtos = data.produtos || data;
        
        renderizarTabelaProdutos(produtos, tbody, true);
        
    } catch (error) {
        console.error('❌ Erro:', error);
        Swal.fire('Erro', 'Falha ao carregar produtos', 'error');
        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Erro ao carregar produtos</td></tr>';
    } finally {
        if (window.loadingStates) window.loadingStates[FUNC_KEY] = false;
    }
}

async function carregarProdutosAtivos() {
    const FUNC_KEY = 'produtosAtivos';
    const tbody = document.getElementById('produtosAtivosBody');
    if (!tbody) return;
    if (window.loadingStates?.[FUNC_KEY]) return;
    
    try {
        if (!window.loadingStates) window.loadingStates = {};
        window.loadingStates[FUNC_KEY] = true;
        
        const res = await fetch('/api/produtos?status=Ativo', {credentials: 'include'});
        if (!res.ok) throw new Error('Erro ao carregar produtos');
        
        const data = await res.json();
        const produtos = data.produtos || data;
        
        renderizarTabelaProdutos(produtos, tbody, false);
        
    } catch (error) {
        console.error('❌ Erro:', error);
        Swal.fire('Erro', 'Falha ao carregar produtos ativos', 'error');
        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Erro ao carregar produtos</td></tr>';
    } finally {
        if (window.loadingStates) window.loadingStates[FUNC_KEY] = false;
    }
}

async function carregarProdutosInativos() {
    const FUNC_KEY = 'produtosInativos';
    const tbody = document.getElementById('produtosInativosBody');
    if (!tbody) return;
    if (window.loadingStates?.[FUNC_KEY]) return;
    
    try {
        if (!window.loadingStates) window.loadingStates = {};
        window.loadingStates[FUNC_KEY] = true;
        
        const res = await fetch('/api/produtos?status=Inativo', {credentials: 'include'});
        if (!res.ok) throw new Error('Erro ao carregar produtos');
        
        const data = await res.json();
        const produtos = data.produtos || data;
        
        if (!produtos || produtos.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Nenhum produto inativo</td></tr>';
            return;
        }
        
        renderizarTabelaProdutos(produtos, tbody, false);
        
    } catch (error) {
        console.error('❌ Erro:', error);
        Swal.fire('Erro', 'Falha ao carregar produtos inativos', 'error');
        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Erro ao carregar produtos</td></tr>';
    } finally {
        if (window.loadingStates) window.loadingStates[FUNC_KEY] = false;
    }
}

function renderizarTabelaProdutos(produtos, tbody, incluirStatus) {
    if (!produtos || produtos.length === 0) {
        const colspan = incluirStatus ? 6 : 5;
        tbody.innerHTML = `<tr><td colspan="${colspan}" class="text-center text-muted">Nenhum produto encontrado</td></tr>`;
        return;
    }
    
    tbody.innerHTML = produtos.map(p => {
        const estoqueClass = p.estoque_atual <= p.estoque_minimo ? 'danger' : 'success';
        const statusBadge = incluirStatus ? `<td><span class="badge ${p.status === 'Ativo' ? 'success' : 'secondary'}">${p.status}</span></td>` : '';
        
        return `
            <tr>
                <td>${p.nome}</td>
                <td>${p.marca || 'N/A'}</td>
                <td>R$ ${parseFloat(p.preco || 0).toFixed(2)}</td>
                <td><span class="badge ${estoqueClass}">${p.estoque_atual || 0}</span></td>
                ${statusBadge}
                <td>
                    <button class="btn btn-sm btn-outline" onclick="editarProduto('${p._id}')">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-sm btn-${p.status === 'Ativo' ? 'warning' : 'success'}" onclick="toggleStatusProduto('${p._id}', '${p.status}')">
                        <i class="bi bi-${p.status === 'Ativo' ? 'x' : 'check'}-circle"></i>
                    </button>
                </td>
            </tr>
        `;
    }).join('');
}

function filtrarProdutosTodos() {
    // Implementar filtro local
}

function filtrarProdutosAtivos() {
    // Implementar filtro local
}

async function toggleStatusProduto(id, statusAtual) {
    const novoStatus = statusAtual === 'Ativo' ? 'Inativo' : 'Ativo';
    const acao = novoStatus === 'Ativo' ? 'ativar' : 'inativar';
    
    const result = await Swal.fire({
        title: `${acao.charAt(0).toUpperCase() + acao.slice(1)} produto?`,
        text: `Você está prestes a ${acao} este produto`,
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: `Sim, ${acao}`,
        cancelButtonText: 'Cancelar'
    });
    
    if (result.isConfirmed) {
        try {
            const res = await fetch(`/api/produtos/${id}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                credentials: 'include',
                body: JSON.stringify({ status: novoStatus })
            });
            
            if (!res.ok) throw new Error('Erro ao atualizar produto');
            
            Swal.fire('Sucesso!', `Produto ${novoStatus.toLowerCase()} com sucesso`, 'success');
            
            // Recarregar a sub-tab atual
            const activeSubTab = document.querySelector('#section-produtos .sub-tab-btn.active');
            if (activeSubTab) {
                const subtab = activeSubTab.textContent.trim().toLowerCase();
                if (subtab.includes('todos')) carregarProdutosTodos();
                else if (subtab.includes('ativos')) carregarProdutosAtivos();
                else if (subtab.includes('inativos')) carregarProdutosInativos();
            }
            
        } catch (error) {
            console.error('Erro:', error);
            Swal.fire('Erro', 'Não foi possível atualizar o produto', 'error');
        }
    }

    // Limpeza de backdrop residual
    setTimeout(() => {
        document.querySelectorAll('.swal2-container, .swal2-backdrop-show').forEach(el => {
            if (!Swal.isVisible()) el.remove();
        });
        document.body.classList.remove('swal2-shown', 'swal2-height-auto');
    }, 100);
}
// ========== FIM SUB-TABS PRODUTOS ==========

// ========== SISTEMA DE SUB-TABS - SERVIÇOS ====================
async function carregarServicosTodos() {
    const FUNC_KEY = 'servicosTodos';
    const tbody = document.getElementById('servicosTodosBody');
    if (!tbody) return;
    if (window.loadingStates?.[FUNC_KEY]) return;
    
    try {
        if (!window.loadingStates) window.loadingStates = {};
        window.loadingStates[FUNC_KEY] = true;
        
        const res = await fetch('/api/servicos', {credentials: 'include'});
        if (!res.ok) throw new Error('Erro ao carregar serviços');
        
        const data = await res.json();
        const servicos = data.servicos || data;
        
        renderizarTabelaServicos(servicos, tbody, true);
        
    } catch (error) {
        console.error('❌ Erro:', error);
        Swal.fire('Erro', 'Falha ao carregar serviços', 'error');
        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Erro ao carregar serviços</td></tr>';
    } finally {
        if (window.loadingStates) window.loadingStates[FUNC_KEY] = false;
    }
}

async function carregarServicosAtivos() {
    const FUNC_KEY = 'servicosAtivos';
    const tbody = document.getElementById('servicosAtivosBody');
    if (!tbody) return;
    if (window.loadingStates?.[FUNC_KEY]) return;
    
    try {
        if (!window.loadingStates) window.loadingStates = {};
        window.loadingStates[FUNC_KEY] = true;
        
        const res = await fetch('/api/servicos?status=Ativo', {credentials: 'include'});
        if (!res.ok) throw new Error('Erro ao carregar serviços');
        
        const data = await res.json();
        const servicos = data.servicos || data;
        
        renderizarTabelaServicos(servicos, tbody, false);
        
    } catch (error) {
        console.error('❌ Erro:', error);
        Swal.fire('Erro', 'Falha ao carregar serviços ativos', 'error');
        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Erro ao carregar serviços</td></tr>';
    } finally {
        if (window.loadingStates) window.loadingStates[FUNC_KEY] = false;
    }
}

async function carregarServicosInativos() {
    const FUNC_KEY = 'servicosInativos';
    const tbody = document.getElementById('servicosInativosBody');
    if (!tbody) return;
    if (window.loadingStates?.[FUNC_KEY]) return;
    
    try {
        if (!window.loadingStates) window.loadingStates = {};
        window.loadingStates[FUNC_KEY] = true;
        
        const res = await fetch('/api/servicos?status=Inativo', {credentials: 'include'});
        if (!res.ok) throw new Error('Erro ao carregar serviços');
        
        const data = await res.json();
        const servicos = data.servicos || data;
        
        if (!servicos || servicos.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Nenhum serviço inativo</td></tr>';
            return;
        }
        
        renderizarTabelaServicos(servicos, tbody, false);
        
    } catch (error) {
        console.error('❌ Erro:', error);
        Swal.fire('Erro', 'Falha ao carregar serviços inativos', 'error');
        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Erro ao carregar serviços</td></tr>';
    } finally {
        if (window.loadingStates) window.loadingStates[FUNC_KEY] = false;
    }
}

function renderizarTabelaServicos(servicos, tbody, incluirStatus) {
    if (!servicos || servicos.length === 0) {
        const colspan = incluirStatus ? 6 : 5;
        tbody.innerHTML = `<tr><td colspan="${colspan}" class="text-center text-muted">Nenhum serviço encontrado</td></tr>`;
        return;
    }
    
    tbody.innerHTML = servicos.map(s => {
        const statusBadge = incluirStatus ? `<td><span class="badge ${s.status === 'Ativo' ? 'success' : 'secondary'}">${s.status}</span></td>` : '';
        
        return `
            <tr>
                <td>${s.nome}</td>
                <td>${s.categoria || 'N/A'}</td>
                <td>${s.tamanho || 'N/A'}</td>
                <td>R$ ${parseFloat(s.preco || 0).toFixed(2)}</td>
                ${statusBadge}
                <td>
                    <button class="btn btn-sm btn-outline" onclick="editarServico('${s._id}')">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-sm btn-${s.status === 'Ativo' ? 'warning' : 'success'}" onclick="toggleStatusServico('${s._id}', '${s.status}')">
                        <i class="bi bi-${s.status === 'Ativo' ? 'x' : 'check'}-circle"></i>
                    </button>
                </td>
            </tr>
        `;
    }).join('');
}

function filtrarServicosTodos() {
    // Implementar filtro local
}

function filtrarServicosAtivos() {
    // Implementar filtro local
}

async function toggleStatusServico(id, statusAtual) {
    const novoStatus = statusAtual === 'Ativo' ? 'Inativo' : 'Ativo';
    const acao = novoStatus === 'Ativo' ? 'ativar' : 'inativar';
    
    const result = await Swal.fire({
        title: `${acao.charAt(0).toUpperCase() + acao.slice(1)} serviço?`,
        text: `Você está prestes a ${acao} este serviço`,
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: `Sim, ${acao}`,
        cancelButtonText: 'Cancelar'
    });
    
    if (result.isConfirmed) {
        try {
            const res = await fetch(`/api/servicos/${id}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                credentials: 'include',
                body: JSON.stringify({ status: novoStatus })
            });
            
            if (!res.ok) throw new Error('Erro ao atualizar serviço');
            
            Swal.fire('Sucesso!', `Serviço ${novoStatus.toLowerCase()} com sucesso`, 'success');
            
            // Recarregar a sub-tab atual
            const activeSubTab = document.querySelector('#section-servicos .sub-tab-btn.active');
            if (activeSubTab) {
                const subtab = activeSubTab.textContent.trim().toLowerCase();
                if (subtab.includes('todos')) carregarServicosTodos();
                else if (subtab.includes('ativos')) carregarServicosAtivos();
                else if (subtab.includes('inativos')) carregarServicosInativos();
            }
            
        } catch (error) {
            console.error('Erro:', error);
            Swal.fire('Erro', 'Não foi possível atualizar o serviço', 'error');
        }
    }

    // Limpeza de backdrop residual
    setTimeout(() => {
        document.querySelectorAll('.swal2-container, .swal2-backdrop-show').forEach(el => {
            if (!Swal.isVisible()) el.remove();
        });
        document.body.classList.remove('swal2-shown', 'swal2-height-auto');
    }, 100);
}
// ========== FIM SUB-TABS SERVIÇOS ==========

// ========== SISTEMA DE SUB-TABS - ESTOQUE ====================
async function carregarEstoqueVisaoGeral() {
    const FUNC_KEY = 'estoqueVisaoGeral';
    if (window.loadingStates?.[FUNC_KEY]) {
        console.warn('⚠️ carregarEstoqueVisaoGeral já está em execução');
        return;
    }

    try {
        if (!window.loadingStates) window.loadingStates = {};
        window.loadingStates[FUNC_KEY] = true;

        console.log('📦 Carregando visão geral do estoque...');

        // Verificar Chart.js
        if (!window.Chart) {
            console.error('❌ Chart.js não está carregado!');
            return;
        }

        // Buscar produtos para estatísticas
        const prodRes = await fetch('/api/produtos', {credentials: 'include'});

        if (!prodRes.ok) {
            console.error(`❌ Erro HTTP ao buscar produtos: ${prodRes.status}`);
            throw new Error(`Erro ${prodRes.status}: Falha ao carregar produtos`);
        }

        const prodData = await prodRes.json();
        console.log('📦 Produtos recebidos:', { success: prodData.success, total: prodData.produtos?.length });

        // Buscar movimentações do mês
        const hoje = new Date();
        const inicioMes = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
        const movRes = await fetch(`/api/estoque/movimentacoes?data_inicio=${inicioMes.toISOString()}&per_page=10000`, {credentials: 'include'});

        if (!movRes.ok) {
            console.warn(`⚠️ Erro HTTP ao buscar movimentações: ${movRes.status}`);
        }

        const movData = await movRes.json();
        console.log('📦 Movimentações recebidas:', { success: movData.success, total: movData.movimentacoes?.length });

        // Atualizar cards de estatísticas
        if (prodData.success && prodData.produtos) {
            const produtos = prodData.produtos;

            const totalProdutosEl = document.getElementById('totalProdutosEstoque');
            const valorTotalEl = document.getElementById('valorTotalEstoque');
            const abaixoMinimoEl = document.getElementById('itensAbaixoMinimo');

            if (totalProdutosEl) {
                totalProdutosEl.textContent = produtos.length;
            }

            // Valor total em estoque
            const valorTotal = produtos.reduce((sum, p) => {
                const preco = parseFloat(p.preco || 0);
                const quantidade = parseFloat(p.quantidade || p.estoque || 0);
                return sum + (preco * quantidade);
            }, 0);

            if (valorTotalEl) {
                valorTotalEl.textContent = `R$ ${valorTotal.toFixed(2).replace('.', ',')}`;
            }

            // Produtos abaixo do mínimo
            const abaixoMinimo = produtos.filter(p => {
                const estoque = parseFloat(p.quantidade || p.estoque || 0);
                const minimo = parseFloat(p.estoque_minimo || 0);
                return estoque < minimo && minimo > 0;
            }).length;

            if (abaixoMinimoEl) {
                abaixoMinimoEl.textContent = abaixoMinimo;
            }

            console.log('✅ Cards atualizados:', {
                total_produtos: produtos.length,
                valor_total: valorTotal,
                abaixo_minimo: abaixoMinimo
            });
        }

        // Movimentações do mês
        const movimentacoesEl = document.getElementById('movimentacoesEstoque');
        if (movData.success && movData.movimentacoes) {
            if (movimentacoesEl) {
                movimentacoesEl.textContent = movData.movimentacoes.length;
            }

            // Popula tabela de Últimas Movimentações
            const ultimasMovBody = document.getElementById('estoqueUltimasMovimentacoesVisaoGeral');
            if (ultimasMovBody && movData.movimentacoes.length > 0) {
                // Ordenar por data (mais recentes primeiro) e pegar só as 10 primeiras
                const movimentacoesRecentes = [...movData.movimentacoes]
                    .sort((a, b) => {
                        const dateA = new Date(a.data || a.data_movimentacao || a.created_at);
                        const dateB = new Date(b.data || b.data_movimentacao || b.created_at);
                        return dateB - dateA; // Descendente
                    })
                    .slice(0, 10);

                ultimasMovBody.innerHTML = movimentacoesRecentes.map(mov => {
                    try {
                        // Extrair informações com fallbacks
                        const data = mov.data || mov.data_movimentacao || mov.created_at || 'N/A';
                        const produtoNome = mov.produto_nome || mov.produto?.nome || mov.descricao || 'Produto desconhecido';
                        const tipo = mov.tipo || 'N/A';
                        const quantidade = mov.quantidade ?? mov.qtd ?? 0;
                        const responsavel = mov.responsavel || mov.usuario || mov.profissional || 'Sistema';

                        // Formatar data
                        let dataFormatada = 'N/A';
                        try {
                            if (data !== 'N/A') {
                                const dt = new Date(data);
                                if (!isNaN(dt.getTime())) {
                                    dataFormatada = dt.toLocaleDateString('pt-BR', {
                                        day: '2-digit',
                                        month: '2-digit',
                                        year: 'numeric',
                                        hour: '2-digit',
                                        minute: '2-digit'
                                    });
                                }
                            }
                        } catch (e) {
                            console.warn('Erro ao formatar data:', e);
                        }

                        // Badge de tipo com cor
                        const tipoLower = String(tipo).toLowerCase();
                        let tipoBadgeClass = 'secondary';
                        if (tipoLower.includes('entrada')) {
                            tipoBadgeClass = 'success';
                        } else if (tipoLower.includes('saida') || tipoLower.includes('saída')) {
                            tipoBadgeClass = 'danger';
                        }

                        return `
                            <tr>
                                <td>${dataFormatada}</td>
                                <td>${produtoNome}</td>
                                <td><span class="badge ${tipoBadgeClass}">${tipo}</span></td>
                                <td>${quantidade}</td>
                                <td>${responsavel}</td>
                            </tr>
                        `;
                    } catch (err) {
                        console.error('Erro ao renderizar movimentação:', err, mov);
                        return '<tr><td colspan="5" class="text-center text-danger">Erro ao carregar movimentação</td></tr>';
                    }
                }).join('');

                console.log(`✅ Tabela de Últimas Movimentações populada com ${movimentacoesRecentes.length} registros`);
            } else if (ultimasMovBody) {
                ultimasMovBody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Nenhuma movimentação recente</td></tr>';
            }

            console.log('📊 Preparando gráficos do estoque...');

            // IMPORTANTE: setTimeout para garantir que canvas está visível
            setTimeout(() => {
                try {
                    // Criar gráfico de Resumo de Movimentações
                    const entradas = movData.movimentacoes.filter(m => m.tipo === 'entrada' || m.tipo === 'Entrada').length;
                    const saidas = movData.movimentacoes.filter(m => m.tipo === 'saida' || m.tipo === 'saída' || m.tipo === 'Saida' || m.tipo === 'Saída').length;

                    console.log(`📊 Movimentações: ${entradas} entradas, ${saidas} saídas`);

                    const ctxMovimentacoes = document.getElementById('chartEstoqueVisaoGeral');
                    if (!ctxMovimentacoes) {
                        console.warn('⚠️ Canvas chartEstoqueVisaoGeral não encontrado');
                    } else {
                        if (window.chartEstoqueVisaoGeralInstance) {
                            window.chartEstoqueVisaoGeralInstance.destroy();
                        }

                        window.chartEstoqueVisaoGeralInstance = new Chart(ctxMovimentacoes, {
                            type: 'bar',
                            data: {
                                labels: ['Entradas', 'Saídas'],
                                datasets: [{
                                    label: 'Movimentações do Mês',
                                    data: [entradas, saidas],
                                    backgroundColor: [
                                        'rgba(16, 185, 129, 0.7)',
                                        'rgba(239, 68, 68, 0.7)'
                                    ],
                                    borderColor: [
                                        'rgba(16, 185, 129, 1)',
                                        'rgba(239, 68, 68, 1)'
                                    ],
                                    borderWidth: 2,
                                    borderRadius: 6
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: true,
                                plugins: {
                                    legend: {
                                        display: true,
                                        position: 'top'
                                    },
                                    tooltip: {
                                        callbacks: {
                                            label: function(context) {
                                                return `${context.label}: ${context.parsed.y} movimentações`;
                                            }
                                        }
                                    }
                                },
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        ticks: {
                                            precision: 0,
                                            callback: function(value) {
                                                return value + ' mov.';
                                            }
                                        }
                                    }
                                }
                            }
                        });

                        console.log('✅ Gráfico de movimentações renderizado');
                    }
                } catch (chartErr) {
                    console.error('❌ Erro ao criar gráfico de movimentações:', chartErr);
                }
            }, 50);
        } else {
            console.warn('⚠️ Sem dados de movimentações para o gráfico');
        }

        // Criar gráfico de Distribuição (Produtos por Status)
        if (prodData.success && prodData.produtos) {
            // setTimeout para garantir renderização correta
            setTimeout(() => {
                try {
                    const produtos = prodData.produtos;

                    const disponiveis = produtos.filter(p => {
                        const estoque = parseFloat(p.quantidade || p.estoque || 0);
                        const minimo = parseFloat(p.estoque_minimo || 0);
                        return estoque >= (minimo * 1.5);
                    }).length;

                    const baixo = produtos.filter(p => {
                        const estoque = parseFloat(p.quantidade || p.estoque || 0);
                        const minimo = parseFloat(p.estoque_minimo || 0);
                        return estoque >= minimo && estoque < (minimo * 1.5) && minimo > 0;
                    }).length;

                    const critico = produtos.filter(p => {
                        const estoque = parseFloat(p.quantidade || p.estoque || 0);
                        const minimo = parseFloat(p.estoque_minimo || 0);
                        return estoque < minimo && minimo > 0;
                    }).length;

                    console.log(`📊 Distribuição: ${disponiveis} disponíveis, ${baixo} baixo, ${critico} crítico`);

                    const ctxDistribuicao = document.getElementById('chartDistribuicaoEstoque');
                    if (!ctxDistribuicao) {
                        console.warn('⚠️ Canvas chartDistribuicaoEstoque não encontrado');
                    } else {
                        if (window.chartDistribuicaoEstoqueInstance) {
                            window.chartDistribuicaoEstoqueInstance.destroy();
                        }

                        window.chartDistribuicaoEstoqueInstance = new Chart(ctxDistribuicao, {
                            type: 'doughnut',
                            data: {
                                labels: ['Disponível', 'Estoque Baixo', 'Crítico'],
                                datasets: [{
                                    label: 'Produtos',
                                    data: [disponiveis, baixo, critico],
                                    backgroundColor: [
                                        'rgba(16, 185, 129, 0.8)',
                                        'rgba(245, 158, 11, 0.8)',
                                        'rgba(239, 68, 68, 0.8)'
                                    ],
                                    borderColor: [
                                        'rgba(16, 185, 129, 1)',
                                        'rgba(245, 158, 11, 1)',
                                        'rgba(239, 68, 68, 1)'
                                    ],
                                    borderWidth: 2
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: true,
                                plugins: {
                                    legend: {
                                        position: 'bottom',
                                        labels: {
                                            font: { size: 12, weight: 'bold' }
                                        }
                                    },
                                    tooltip: {
                                        callbacks: {
                                            label: function(context) {
                                                const label = context.label || '';
                                                const value = context.parsed || 0;
                                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                                const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                                return `${label}: ${value} produtos (${percentage}%)`;
                                            }
                                        }
                                    }
                                }
                            }
                        });

                        console.log('✅ Gráfico de distribuição renderizado');
                    }
                } catch (chartErr) {
                    console.error('❌ Erro ao criar gráfico de distribuição:', chartErr);
                }
            }, 50);
        } else {
            console.warn('⚠️ Sem dados de produtos para o gráfico de distribuição');
        }

        console.log('✅ Visão geral do estoque carregada completamente');

    } catch (error) {
        console.error('❌ Erro ao carregar visão geral do estoque:', error);
        toast('❌ Erro ao carregar visão geral do estoque', 'error');

        // Mostrar valores zerados em caso de erro
        const zeroElements = {
            totalProdutosEstoque: document.getElementById('totalProdutosEstoque'),
            valorTotalEstoque: document.getElementById('valorTotalEstoque'),
            itensAbaixoMinimo: document.getElementById('itensAbaixoMinimo'),
            movimentacoesEstoque: document.getElementById('movimentacoesEstoque')
        };

        if (zeroElements.totalProdutosEstoque) zeroElements.totalProdutosEstoque.textContent = '0';
        if (zeroElements.valorTotalEstoque) zeroElements.valorTotalEstoque.textContent = 'R$ 0,00';
        if (zeroElements.itensAbaixoMinimo) zeroElements.itensAbaixoMinimo.textContent = '0';
        if (zeroElements.movimentacoesEstoque) zeroElements.movimentacoesEstoque.textContent = '0';

    } finally {
        if (window.loadingStates) window.loadingStates[FUNC_KEY] = false;
    }
}

async function carregarMovimentacoesEstoque() {
    const FUNC_KEY = 'movimentacoesEstoque';
    const tbody = document.getElementById('estoqueMovimentacoesBody');
    if (!tbody) return;
    if (window.loadingStates?.[FUNC_KEY]) return;
    
    try {
        if (!window.loadingStates) window.loadingStates = {};
        window.loadingStates[FUNC_KEY] = true;
        
        const tipo = document.getElementById('filtroTipoMov')?.value || '';
        const dataInicio = document.getElementById('filtroDataInicioMov')?.value || '';
        const dataFim = document.getElementById('filtroDataFimMov')?.value || '';
        
        let url = '/api/estoque/movimentacoes?';
        if (tipo) url += `tipo=${tipo}&`;
        if (dataInicio) url += `data_inicio=${dataInicio}&`;
        if (dataFim) url += `data_fim=${dataFim}&`;
        
        const res = await fetch(url, {credentials: 'include'});
        if (!res.ok) throw new Error('Erro ao carregar movimentações');

        const data = await res.json();
        const movimentacoes = data.movimentacoes || [];

        if (!movimentacoes || movimentacoes.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Nenhuma movimentação encontrada</td></tr>';
            return;
        }
        
        tbody.innerHTML = movimentacoes.map(m => {
            const data = new Date(m.data).toLocaleDateString('pt-BR');
            const tipoClass = m.tipo === 'entrada' ? 'success' : 'danger';
            const tipoIcon = m.tipo === 'entrada' ? 'arrow-down-circle' : 'arrow-up-circle';
            
            return `
                <tr>
                    <td>${data}</td>
                    <td><span class="badge ${tipoClass}"><i class="bi bi-${tipoIcon}"></i> ${m.tipo.toUpperCase()}</span></td>
                    <td>${m.produto_nome}</td>
                    <td>${m.quantidade}</td>
                    <td>${m.motivo || 'N/A'}</td>
                    <td>${m.responsavel || 'N/A'}</td>
                </tr>
            `;
        }).join('');
        
    } catch (error) {
        console.error('❌ Erro:', error);
        Swal.fire('Erro', 'Falha ao carregar movimentações de estoque', 'error');
        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Erro ao carregar movimentações</td></tr>';
    } finally {
        if (window.loadingStates) window.loadingStates[FUNC_KEY] = false;
    }
}

async function carregarRelatoriosEstoque() {
    const FUNC_KEY = 'relatoriosEstoque';
    if (window.loadingStates?.[FUNC_KEY]) return;
    
    try {
        if (!window.loadingStates) window.loadingStates = {};
        window.loadingStates[FUNC_KEY] = true;
        
        // Inicializar gráficos se necessário
        console.log('📊 Relatórios de estoque carregados');
        
    } catch (error) {
        console.error('❌ Erro:', error);
        Swal.fire('Erro', 'Falha ao carregar relatórios', 'error');
    } finally {
        if (window.loadingStates) window.loadingStates[FUNC_KEY] = false;
    }
}

function filtrarEstoqueGeral() {
    // Implementar filtro local
}

async function gerarRelatorioEstoque() {
    const dataInicio = document.getElementById('relatorioDataInicio')?.value;
    const dataFim = document.getElementById('relatorioDataFim')?.value;
    const tipo = document.getElementById('relatorioTipo')?.value || 'movimentacoes';
    
    if (!dataInicio || !dataFim) {
        Swal.fire('Atenção', 'Selecione o período do relatório', 'warning');
        return;
    }
    
    try {
        const url = `/api/estoque/relatorio?tipo=${tipo}&data_inicio=${dataInicio}&data_fim=${dataFim}`;
        const res = await fetch(url, {credentials: 'include'});
        if (!res.ok) throw new Error('Erro ao gerar relatório');
        
        const data = await res.json();
        
        // Exibir resultados
        const resultadosDiv = document.getElementById('relatorioEstoqueResultados');
        resultadosDiv.style.display = 'block';
        resultadosDiv.innerHTML = `
            <div class="alert alert-success">
                <h5><i class="bi bi-check-circle"></i> Relatório Gerado!</h5>
                <p>Período: ${new Date(dataInicio).toLocaleDateString('pt-BR')} a ${new Date(dataFim).toLocaleDateString('pt-BR')}</p>
                <p>Total de registros: ${data.total || 0}</p>
            </div>
        `;
        
        Swal.fire('Sucesso', 'Relatório gerado com sucesso!', 'success');
        
    } catch (error) {
        console.error('Erro:', error);
        Swal.fire('Erro', 'Não foi possível gerar o relatório', 'error');
    }
}

async function exportarRelatorioPDF() {
    Swal.fire('Info', 'Funcionalidade de exportação PDF será implementada em breve', 'info');
}
// ========== FIM SUB-TABS ESTOQUE ==========

// ========== STUB FUNCTIONS FOR MISSING SUB-TAB LOADERS ==========
// TODO: Implementar estas funções completamente quando os endpoints estiverem prontos

async function carregarProdutosEstoque() {
    console.log('📦 Carregando produtos do estoque...');
    const tbody = document.getElementById('estoqueProdutosBody');

    if(!tbody){
        console.error('tbody estoqueProdutosBody não encontrado');
        return;
    }

    try{
        tbody.innerHTML = '<tr><td colspan="8" class="text-center"><div class="spinner"></div></td></tr>';

        const res = await fetch('/api/produtos', {credentials: 'include'});
        const data = await res.json();

        if(data.success && data.produtos && data.produtos.length > 0){
            // Armazenar produtos para filtro de busca
            window.produtosEstoqueData = data.produtos;

            tbody.innerHTML = data.produtos.map(prod => {
                const quantidade = prod.quantidade || 0;
                const minimo = prod.estoque_minimo || 0;
                const preco = parseFloat(prod.preco || 0);
                const valorTotal = quantidade * preco;

                let statusBadge = '';
                let statusClass = '';

                if(quantidade === 0){
                    statusBadge = '<span class="badge danger">Esgotado</span>';
                    statusClass = 'text-danger';
                } else if(quantidade <= minimo){
                    statusBadge = '<span class="badge warning">Estoque Baixo</span>';
                    statusClass = 'text-warning';
                } else {
                    statusBadge = '<span class="badge success">Disponível</span>';
                    statusClass = '';
                }

                return `
                    <tr class="${statusClass}">
                        <td><strong>${prod.nome || 'N/A'}</strong></td>
                        <td>${prod.marca || 'N/A'}</td>
                        <td>${prod.sku || 'N/A'}</td>
                        <td><strong>${quantidade}</strong></td>
                        <td>${minimo}</td>
                        <td>R$ ${preco.toFixed(2)}</td>
                        <td><strong>R$ ${valorTotal.toFixed(2)}</strong></td>
                        <td>${statusBadge}</td>
                    </tr>
                `;
            }).join('');

            console.log(`✅ ${data.produtos.length} produtos carregados no estoque`);
        } else {
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" class="text-center" style="padding: 40px; color: var(--text-muted);">
                        <i class="bi bi-inbox" style="font-size: 3rem; opacity: 0.3;"></i>
                        <p style="margin-top: 15px;">Nenhum produto cadastrado no sistema</p>
                    </td>
                </tr>
            `;
        }
    }catch(err){
        console.error('Erro ao carregar produtos do estoque:', err);
        tbody.innerHTML = `
            <tr>
                <td colspan="8" class="text-center text-danger" style="padding: 40px;">
                    <i class="bi bi-exclamation-triangle" style="font-size: 3rem;"></i>
                    <p style="margin-top: 15px;">Erro ao carregar produtos</p>
                </td>
            </tr>
        `;
    }
}

function filtrarProdutosEstoque(){
    const busca = document.getElementById('buscaProdutosEstoque').value.toLowerCase();
    const tbody = document.getElementById('estoqueProdutosBody');

    if(!window.produtosEstoqueData || window.produtosEstoqueData.length === 0){
        console.warn('Nenhum produto disponível para filtrar');
        return;
    }

    const produtosFiltrados = window.produtosEstoqueData.filter(prod => {
        const nome = (prod.nome || '').toLowerCase();
        const marca = (prod.marca || '').toLowerCase();
        const sku = (prod.sku || '').toLowerCase();
        return nome.includes(busca) || marca.includes(busca) || sku.includes(busca);
    });

    if(produtosFiltrados.length > 0){
        tbody.innerHTML = produtosFiltrados.map(prod => {
            const quantidade = prod.quantidade || 0;
            const minimo = prod.estoque_minimo || 0;
            const preco = parseFloat(prod.preco || 0);
            const valorTotal = quantidade * preco;

            let statusBadge = '';
            let statusClass = '';

            if(quantidade === 0){
                statusBadge = '<span class="badge danger">Esgotado</span>';
                statusClass = 'text-danger';
            } else if(quantidade <= minimo){
                statusBadge = '<span class="badge warning">Estoque Baixo</span>';
                statusClass = 'text-warning';
            } else {
                statusBadge = '<span class="badge success">Disponível</span>';
                statusClass = '';
            }

            return `
                <tr class="${statusClass}">
                    <td><strong>${prod.nome || 'N/A'}</strong></td>
                    <td>${prod.marca || 'N/A'}</td>
                    <td>${prod.sku || 'N/A'}</td>
                    <td><strong>${quantidade}</strong></td>
                    <td>${minimo}</td>
                    <td>R$ ${preco.toFixed(2)}</td>
                    <td><strong>R$ ${valorTotal.toFixed(2)}</strong></td>
                    <td>${statusBadge}</td>
                </tr>
            `;
        }).join('');
    } else {
        tbody.innerHTML = `
            <tr>
                <td colspan="8" class="text-center" style="padding: 40px; color: var(--text-muted);">
                    <i class="bi bi-search" style="font-size: 3rem; opacity: 0.3;"></i>
                    <p style="margin-top: 15px;">Nenhum produto encontrado com "${document.getElementById('buscaProdutosEstoque').value}"</p>
                </td>
            </tr>
        `;
    }
}

async function carregarComissoesProfissionais(){
    console.log('💰 Inicializando seção de comissões dos profissionais...');

    try{
        // Carregar lista de profissionais no dropdown
        const resProfissionais = await fetch('/api/profissionais', {credentials: 'include'});
        const dataProfissionais = await resProfissionais.json();

        const selectProfissional = document.getElementById('filtroComissoesProfissional');

        if(selectProfissional && dataProfissionais.success){
            selectProfissional.innerHTML = '<option value="">Selecione um profissional</option>';

            (dataProfissionais.profissionais || []).forEach(prof => {
                const option = document.createElement('option');
                option.value = prof._id;
                option.textContent = `${prof.nome} (${prof.especialidade || 'N/A'})`;
                selectProfissional.appendChild(option);
            });

            console.log(`✅ ${dataProfissionais.profissionais.length} profissionais carregados no filtro`);
        }

        // Carregar também assistentes
        const resAssistentes = await fetch('/api/assistentes', {credentials: 'include'});
        const dataAssistentes = await resAssistentes.json();

        if(dataAssistentes.success && dataAssistentes.assistentes && dataAssistentes.assistentes.length > 0){
            dataAssistentes.assistentes.forEach(assis => {
                const option = document.createElement('option');
                option.value = assis._id;
                option.textContent = `${assis.nome} (Assistente)`;
                selectProfissional.appendChild(option);
            });

            console.log(`✅ ${dataAssistentes.assistentes.length} assistentes carregados no filtro`);
        }

        // Mostrar mensagem inicial
        document.getElementById('comissoesMensagemInicial').style.display = 'block';
        document.getElementById('comissoesEstatisticasCards').style.display = 'none';

    }catch(err){
        console.error('Erro ao carregar profissionais para comissões:', err);
        Swal.fire({
            icon: 'error',
            title: 'Erro ao Carregar',
            text: 'Não foi possível carregar a lista de profissionais',
            confirmButtonColor: '#7C3AED'
        });
    }
}

async function carregarEstatisticasProfissionais() {
    console.log('📊 Carregando estatísticas dos profissionais...');
    // TODO: Implementar carregamento de estatísticas (atendimentos, receita, etc)
}

async function carregarFinanceiroResumo(){
    console.log('💵 Carregando resumo financeiro...');

    try{
        // Carregar dados de dashboard (mais completo que resumo)
        const res = await fetch('/api/financeiro/dashboard', {credentials: 'include'});

        if (!res.ok) {
            console.error(`❌ Erro HTTP ao buscar dashboard financeiro: ${res.status}`);
            throw new Error(`Erro ${res.status}: Falha ao carregar dashboard`);
        }

        const data = await res.json();
        console.log('📦 Dados do dashboard financeiro:', { success: data.success, hasData: !!data.financeiro });

        if(data.success && data.financeiro){
            const fin = data.financeiro;

            // Atualizar cards principais com fallbacks
            const financeiroReceitasEl = document.getElementById('financeiroReceitas');
            const financeiroDespesasEl = document.getElementById('financeiroDespesas');
            const financeiroComissoesEl = document.getElementById('financeiroComissoes');
            const financeiroLucroEl = document.getElementById('financeiroLucro');

            if (financeiroReceitasEl) {
                const receita = parseFloat(fin.receita_total || fin.receitas || 0);
                financeiroReceitasEl.textContent = `R$ ${receita.toFixed(2).replace('.', ',')}`;
            }

            if (financeiroDespesasEl) {
                const despesas = parseFloat(fin.despesas_total || fin.despesas || 0);
                financeiroDespesasEl.textContent = `R$ ${despesas.toFixed(2).replace('.', ',')}`;
            }

            if (financeiroComissoesEl) {
                const comissoes = parseFloat(fin.comissoes_pendentes || fin.comissoes || 0);
                financeiroComissoesEl.textContent = `R$ ${comissoes.toFixed(2).replace('.', ',')}`;
            }

            if (financeiroLucroEl) {
                const lucro = parseFloat(fin.lucro_liquido || fin.lucro || 0);
                financeiroLucroEl.textContent = `R$ ${lucro.toFixed(2).replace('.', ',')}`;
                // Colorir baseado no valor
                financeiroLucroEl.style.color = lucro >= 0 ? 'var(--success)' : 'var(--danger)';
            }

            // Atualizar margem de lucro
            const margemEl = document.getElementById('margemLucro');
            if (margemEl) {
                const margem = parseFloat(fin.margem_lucro_perc || fin.margem || 0);
                margemEl.textContent = `${margem.toFixed(1)}%`;
                margemEl.style.color = margem > 0 ? 'var(--success)' : margem < 0 ? 'var(--danger)' : 'var(--text-muted)';
            }

            console.log('✅ Cards financeiros atualizados:', {
                receita: fin.receita_total,
                despesas: fin.despesas_total,
                comissoes: fin.comissoes_pendentes,
                lucro: fin.lucro_liquido
            });

            // IMPORTANTE: Aguardar um frame para garantir que o DOM esteja visível antes de renderizar gráficos
            // Isso resolve o problema de gráficos desaparecendo ao trocar de sub-tab
            setTimeout(() => {
                console.log('📊 Recarregando gráficos financeiros...');

                // Recarregar gráficos (importante para manter dados visíveis ao trocar sub-tabs)
                carregarFaturamentoMensal();
                carregarServicosMaisVendidos();
                carregarProdutosMaisVendidos();

                // Forçar atualização de charts existentes (caso já tenham sido criados)
                if (window.chartFaturamentoInstance) {
                    try {
                        window.chartFaturamentoInstance.update();
                        console.log('✅ Gráfico de faturamento atualizado');
                    } catch (err) {
                        console.warn('⚠️ Erro ao atualizar gráfico de faturamento:', err);
                    }
                }

                console.log('✅ Gráficos financeiros recarregados');
            }, 50); // Pequeno delay para garantir que o CSS tenha aplicado display:block

            console.log('✅ Resumo financeiro atualizado completamente');
        } else {
            console.warn('⚠️ Resposta do dashboard não contém dados financeiros');
        }
    }catch(err){
        console.error('❌ Erro ao carregar resumo financeiro:', err);

        // Mostrar valores zerados em caso de erro (evita campos vazios)
        const zeroValue = 'R$ 0,00';
        const elements = {
            financeiroReceitas: document.getElementById('financeiroReceitas'),
            financeiroDespesas: document.getElementById('financeiroDespesas'),
            financeiroComissoes: document.getElementById('financeiroComissoes'),
            financeiroLucro: document.getElementById('financeiroLucro'),
            margemLucro: document.getElementById('margemLucro')
        };

        if (elements.financeiroReceitas) elements.financeiroReceitas.textContent = zeroValue;
        if (elements.financeiroDespesas) elements.financeiroDespesas.textContent = zeroValue;
        if (elements.financeiroComissoes) elements.financeiroComissoes.textContent = zeroValue;
        if (elements.financeiroLucro) {
            elements.financeiroLucro.textContent = zeroValue;
            elements.financeiroLucro.style.color = 'var(--text-muted)';
        }
        if (elements.margemLucro) {
            elements.margemLucro.textContent = '0.0%';
            elements.margemLucro.style.color = 'var(--text-muted)';
        }
    }
}

async function carregarReceitas(){
    console.log('💰 Carregando receitas...');
    const tbody = document.getElementById('receitasTableBody');

    if(!tbody){
        console.error('tbody receitasTableBody não encontrado');
        return;
    }

    try{
        tbody.innerHTML = '<tr><td colspan="5" class="text-center"><div class="spinner"></div></td></tr>';

        const res = await fetch('/api/financeiro/receitas', {credentials: 'include'});
        const data = await res.json();

        if(data.success && data.receitas && data.receitas.length > 0){
            tbody.innerHTML = data.receitas.map(receita => `
                <tr>
                    <td><strong>${new Date(receita.data || receita.created_at).toLocaleDateString('pt-BR')}</strong></td>
                    <td><span class="badge success">#${receita.orcamento_id || receita._id}</span></td>
                    <td>${receita.cliente_nome || receita.nome_cliente || 'N/A'}</td>
                    <td><strong style="color: var(--success);">R$ ${parseFloat(receita.valor || receita.total || 0).toFixed(2)}</strong></td>
                    <td>${receita.categoria || receita.tipo || 'Serviço'}</td>
                </tr>
            `).join('');

            console.log(`✅ ${data.receitas.length} receitas carregadas`);
        } else {
            tbody.innerHTML = `
                <tr>
                    <td colspan="5" class="text-center" style="padding: 40px; color: var(--text-muted);">
                        <i class="bi bi-inbox" style="font-size: 3rem; opacity: 0.3;"></i>
                        <p style="margin-top: 15px; font-weight: 600;">Nenhuma receita registrada</p>
                    </td>
                </tr>
            `;
        }
    }catch(err){
        console.error('Erro ao carregar receitas:', err);
        tbody.innerHTML = `
            <tr>
                <td colspan="5" class="text-center" style="padding: 40px; color: var(--danger);">
                    <i class="bi bi-exclamation-triangle" style="font-size: 2rem;"></i>
                    <p style="margin-top: 10px;">Erro ao carregar receitas</p>
                    <button class="btn btn-sm btn-primary" onclick="carregarReceitas()" style="margin-top: 10px;">
                        <i class="bi bi-arrow-clockwise"></i> Tentar Novamente
                    </button>
                </td>
            </tr>
        `;
    }
}

// ========== GERENCIAMENTO DE DESPESAS ==========

async function novaDespesa(){
    const result = await SafeSwal.fire({
        title: '<i class="bi bi-plus-circle"></i> Nova Despesa',
        html: `
            <div style="text-align: left;">
                <label style="display: block; margin-bottom: 5px; font-weight: 600;">Descrição *</label>
                <input type="text" id="swal-descricao" class="form-control mb-3" placeholder="Ex: Conta de luz" required>

                <label style="display: block; margin-bottom: 5px; font-weight: 600;">Categoria</label>
                <select id="swal-categoria" class="form-select mb-3">
                    <option value="Geral">Geral</option>
                    <option value="Salários">Salários</option>
                    <option value="Aluguel">Aluguel</option>
                    <option value="Contas">Contas (água, luz, internet)</option>
                    <option value="Produtos">Produtos</option>
                    <option value="Manutenção">Manutenção</option>
                    <option value="Marketing">Marketing</option>
                    <option value="Impostos">Impostos</option>
                    <option value="Outros">Outros</option>
                </select>

                <label style="display: block; margin-bottom: 5px; font-weight: 600;">Valor (R$) *</label>
                <input type="number" id="swal-valor" class="form-control mb-3" placeholder="0.00" step="0.01" min="0" required>

                <label style="display: block; margin-bottom: 5px; font-weight: 600;">Data</label>
                <input type="date" id="swal-data" class="form-control mb-3" value="${new Date().toISOString().split('T')[0]}">

                <label style="display: block; margin-bottom: 5px; font-weight: 600;">Forma de Pagamento</label>
                <select id="swal-forma-pagamento" class="form-select mb-3">
                    <option value="Dinheiro">Dinheiro</option>
                    <option value="PIX">PIX</option>
                    <option value="Débito">Débito</option>
                    <option value="Crédito">Crédito</option>
                    <option value="Transferência">Transferência</option>
                </select>

                <label style="display: block; margin-bottom: 5px; font-weight: 600;">Observações</label>
                <textarea id="swal-observacoes" class="form-control" rows="2" placeholder="Informações adicionais (opcional)"></textarea>
            </div>
        `,
        showCancelButton: true,
        confirmButtonText: '<i class="bi bi-check-circle"></i> Registrar',
        cancelButtonText: '<i class="bi bi-x-circle"></i> Cancelar',
        width: '600px',
        preConfirm: async () => {
            const descricao = document.getElementById('swal-descricao').value.trim();
            const categoria = document.getElementById('swal-categoria').value;
            const valor = document.getElementById('swal-valor').value;
            const data = document.getElementById('swal-data').value;
            const forma_pagamento = document.getElementById('swal-forma-pagamento').value;
            const observacoes = document.getElementById('swal-observacoes').value.trim();

            if (!descricao) {
                Swal.showValidationMessage('Por favor, informe uma descrição');
                return false;
            }
            if (!valor || parseFloat(valor) <= 0) {
                Swal.showValidationMessage('Por favor, informe um valor válido');
                return false;
            }

            try {
                const response = await fetch('/api/financeiro/despesas', {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        descricao,
                        categoria,
                        valor: parseFloat(valor),
                        data,
                        forma_pagamento,
                        observacoes
                    })
                });

                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.message || 'Erro ao registrar despesa');
                }

                return result;
            } catch (error) {
                Swal.showValidationMessage(`Erro: ${error.message}`);
                return false;
            }
        }
    });

    if (result.isConfirmed) {
        toast('✅ Despesa registrada com sucesso!', 'success');
        await carregarDespesas();
        await carregarDadosFinanceiro(); // Atualizar resumo financeiro
    }

    // Limpeza de segurança: remover qualquer backdrop residual
    setTimeout(() => {
        document.querySelectorAll('.swal2-container, .swal2-backdrop-show').forEach(el => {
            if (!Swal.isVisible()) {
                el.remove();
            }
        });
        document.body.classList.remove('swal2-shown', 'swal2-height-auto');
    }, 100);
}

async function excluirDespesa(id){
    const result = await SafeSwal.fire({
        title: 'Confirmar Exclusão',
        text: 'Tem certeza que deseja excluir esta despesa? Esta ação não pode ser desfeita.',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: '<i class="bi bi-trash"></i> Sim, excluir',
        cancelButtonText: '<i class="bi bi-x"></i> Cancelar',
        confirmButtonColor: '#dc3545'
    });

    if (result.isConfirmed) {
        try {
            const response = await fetch(`/api/financeiro/despesas/${id}`, {
                method: 'DELETE',
                credentials: 'include'
            });

            const data = await response.json();

            if (data.success) {
                toast('✅ Despesa excluída com sucesso', 'success');
                await carregarDespesas();
                await carregarDadosFinanceiro(); // Atualizar resumo financeiro
            } else {
                throw new Error(data.message || 'Erro ao excluir despesa');
            }
        } catch (error) {
            console.error('Erro ao excluir despesa:', error);
            toast('❌ Erro ao excluir despesa', 'error');
        }
    }

    // Limpeza de backdrop residual
    setTimeout(() => {
        document.querySelectorAll('.swal2-container, .swal2-backdrop-show').forEach(el => {
            if (!Swal.isVisible()) el.remove();
        });
        document.body.classList.remove('swal2-shown', 'swal2-height-auto');
    }, 100);
}

async function carregarDespesas(){
    console.log('💸 Carregando despesas...');
    const tbody = document.getElementById('despesasTableBody');

    if(!tbody){
        console.error('tbody despesasTableBody não encontrado');
        return;
    }

    try{
        tbody.innerHTML = '<tr><td colspan="5" class="text-center"><div class="spinner"></div></td></tr>';

        const res = await fetch('/api/financeiro/despesas', {credentials: 'include'});
        const data = await res.json();

        if(data.success && data.despesas && data.despesas.length > 0){
            tbody.innerHTML = data.despesas.map(desp => `
                <tr>
                    <td><strong>${new Date(desp.data || desp.created_at).toLocaleDateString('pt-BR')}</strong></td>
                    <td>${desp.descricao || 'N/A'}</td>
                    <td><span class="badge warning">${desp.categoria || 'Geral'}</span></td>
                    <td><strong style="color: var(--danger);">R$ ${parseFloat(desp.valor || 0).toFixed(2)}</strong></td>
                    <td>
                        <button class="btn btn-sm btn-danger" onclick="excluirDespesa('${desp._id}')" title="Excluir">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');

            console.log(`✅ ${data.despesas.length} despesas carregadas`);
        } else {
            tbody.innerHTML = `
                <tr>
                    <td colspan="5" class="text-center" style="padding: 40px; color: var(--text-muted);">
                        <i class="bi bi-inbox" style="font-size: 3rem; opacity: 0.3;"></i>
                        <p style="margin-top: 15px; font-weight: 600;">Nenhuma despesa registrada</p>
                    </td>
                </tr>
            `;
        }
    }catch(err){
        console.error('Erro ao carregar despesas:', err);
        tbody.innerHTML = `
            <tr>
                <td colspan="5" class="text-center" style="padding: 40px; color: var(--danger);">
                    <i class="bi bi-exclamation-triangle" style="font-size: 2rem;"></i>
                    <p style="margin-top: 10px;">Erro ao carregar despesas</p>
                    <button class="btn btn-sm btn-primary" onclick="carregarDespesas()" style="margin-top: 10px;">
                        <i class="bi bi-arrow-clockwise"></i> Tentar Novamente
                    </button>
                </td>
            </tr>
        `;
    }
}

// ========== FIM STUB FUNCTIONS ==========

(async function boot(){
  try{
    const cu = await API.get('/api/current-user');
    if(cu.success){ 
      initApp(cu.user); 
    } else { 
      document.querySelector('#authScreen').style.display='flex'; 
      document.querySelector('#app').style.display='none'; 
    }
  }catch(e){
    console.error('Erro no boot:', e);
    document.querySelector('#authScreen').style.display='flex';
    document.querySelector('#app').style.display='none';
  }
})();
</script>
<!-- MODALS E SEÇÕES ADICIONAIS -->

<!-- Modal: Upload de Foto de Serviço -->
<div id="modalFotoServico" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.7); z-index:10000; align-items:center; justify-content:center;">
    <div style="background:var(--bg-card); border-radius:20px; padding:40px; max-width:700px; width:90%; max-height:90vh; overflow-y:auto;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;">
            <h2><i class="bi bi-camera"></i> Gerenciar Fotos do Serviço</h2>
            <button class="btn btn-sm btn-danger" onclick="fecharModalFotoServico()" style="border-radius:50%; width:40px; height:40px;">×</button>
        </div>

        <div class="mb-4">
            <label style="display:block; font-weight:700; margin-bottom:10px;">Adicionar Nova Foto</label>
            <input type="file" id="fotoServicoInput-modal" accept="image/*" class="form-control" style="margin-bottom:15px;">
            <button class="btn btn-primary" onclick="uploadFotoServicoModal()">
                <i class="bi bi-upload"></i> Fazer Upload
            </button>
        </div>

        <div class="mb-4">
            <h4>Fotos Atuais</h4>
            <div id="fotosServico-modal" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(200px, 1fr)); gap:20px; margin-top:20px;">
                <!-- Fotos serão carregadas aqui via JS -->
            </div>
        </div>
    </div>
</div>

<style>
/* Estilos para fotos de serviços */
.foto-servico-item {
    position: relative;
    border: 2px solid var(--border-color);
    border-radius: 15px;
    overflow: hidden;
    transition: all 0.3s;
}

.foto-servico-item.principal {
    border-color: var(--primary);
    border-width: 4px;
}

.foto-servico-item img {
    width: 100%;
    height: 150px;
    object-fit: cover;
}

.foto-servico-item:hover {
    transform: translateY(-5px);
    box-shadow: var(--shadow-hover);
}

.foto-servico-item .badge {
    position: absolute;
    top: 10px;
    right: 10px;
}

.foto-servico-item .foto-acoes {
    padding: 10px;
    background: var(--bg-card);
    display: flex;
    gap: 10px;
    flex-direction: column;
}
</style>

<script>
// Funções auxiliares para modais
let servicoIdAtual = null;

function abrirModalFotoServico(servicoId) {
    servicoIdAtual = servicoId;
    document.getElementById('modalFotoServico').style.display = 'flex';
    carregarFotosServico(servicoId);
}

function fecharModalFotoServico() {
    document.getElementById('modalFotoServico').style.display = 'none';
    servicoIdAtual = null;
}

function uploadFotoServicoModal() {
    if (!servicoIdAtual) return;

    const fileInput = document.getElementById('fotoServicoInput-modal');
    if (!fileInput || !fileInput.files[0]) {
        mostrarErro('Selecione uma imagem');
        return;
    }

    const formData = new FormData();
    formData.append('foto', fileInput.files[0]);

    fetch(`/api/servicos/${servicoIdAtual}/foto`, {
        method: 'POST',
        body: formData
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            mostrarSucesso('Foto adicionada com sucesso!');
            carregarFotosServico(servicoIdAtual);
            fileInput.value = '';
        } else {
            throw new Error(data.message || 'Erro ao fazer upload');
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        mostrarErro('Erro ao fazer upload da foto: ' + error.message);
    });
}

function carregarFotosServico(servicoId) {
    fetch(`/api/servicos/${servicoId}/fotos`)
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            renderFotosServicoModal(data.fotos, data.foto_principal_index);
        }
    })
    .catch(error => {
        console.error('Erro:', error);
    });
}

function renderFotosServicoModal(fotos, principalIndex) {
    const container = document.getElementById('fotosServico-modal');
    if (!container) return;

    if (!fotos || fotos.length === 0) {
        container.innerHTML = '<p class="text-muted">Nenhuma foto adicionada</p>';
        return;
    }

    container.innerHTML = fotos.map((foto, index) => `
        <div class="foto-servico-item ${index === principalIndex ? 'principal' : ''}">
            <img src="${foto.url}" alt="Foto ${index + 1}">
            ${index === principalIndex ? '<span class="badge badge-primary">Principal</span>' : ''}
            <div class="foto-acoes">
                <button class="btn btn-sm btn-danger" onclick="deletarFotoServico('${servicoIdAtual}', ${index})">
                    <i class="bi bi-trash"></i> Excluir
                </button>
            </div>
            <small class="text-muted" style="display:block; padding:10px; text-align:center;">Enviada em ${new Date(foto.data_upload).toLocaleDateString()}</small>
        </div>
    `).join('');
}


// Carregar gráficos quando a seção financeira for ativada
const originalCarregarDadosSecao = window.carregarDadosSecao;
window.carregarDadosSecao = function(section) {
    if (typeof originalCarregarDadosSecao === 'function') {
        originalCarregarDadosSecao(section);
    }
    if (section === 'financeiro') {
        setTimeout(() => {
            if (typeof carregarTodosGraficos === 'function') {
                carregarTodosGraficos();
            }
        }, 500);
    }
};

// ========== SISTEMA DE AUTO-ATUALIZAÇÃO (DIRETRIZ 0.1) ==========

/**
 * Sistema de atualização automática de dados
 * Atualiza o dashboard e seção atual a cada 30 segundos
 */

let autoUpdateInterval = null;
let autoUpdateEnabled = true;

// Última seção ativa
let lastActiveSection = 'dashboard';

function enableAutoUpdate() {
    if (autoUpdateInterval) {
        clearInterval(autoUpdateInterval);
    }

    console.log('🔄 Auto-atualização ATIVADA (intervalo: 60s - otimizado)');

    // Atualizar imediatamente ao ativar
    performAutoUpdate();

    // Configurar intervalo de 60 segundos (otimizado para reduzir carga)
    autoUpdateInterval = setInterval(() => {
        if (autoUpdateEnabled) {
            performAutoUpdate();
        }
    }, 60000); // 60 segundos (otimizado)
}

function disableAutoUpdate() {
    if (autoUpdateInterval) {
        clearInterval(autoUpdateInterval);
        autoUpdateInterval = null;
        console.log('⏸️ Auto-atualização DESATIVADA');
    }
    autoUpdateEnabled = false;
}

async function performAutoUpdate() {
    try {
        // Mostrar indicador de atualização
        const indicator = document.getElementById('auto-refresh-indicator');
        if (indicator) indicator.classList.add('show');

        // Detectar seção ativa
        const activeSection = document.querySelector('.content-section.active');
        if (!activeSection) {
            if (indicator) indicator.classList.remove('show');
            return;
        }

        const sectionId = activeSection.id.replace('section-', '');
        lastActiveSection = sectionId;

        console.log(`🔄 Auto-atualizando: ${sectionId}`);

        // Atualizar apenas a seção ativa para economizar recursos
        switch(sectionId) {
            case 'dashboard':
                await loadDashboard();
                console.log('✅ Dashboard atualizado');
                break;

            case 'clientes':
                await loadClientes();
                console.log('✅ Clientes atualizados');
                break;

            case 'profissionais':
                await loadProfissionais();
                console.log('✅ Profissionais atualizados');
                break;

            case 'fila':
                await loadFila();
                console.log('✅ Fila atualizada');
                break;

            case 'agendamentos':
                await loadAgendamentos();
                console.log('✅ Agendamentos atualizados');
                break;

            case 'financeiro':
                // Atualizar apenas os cards de resumo (não recarregar tudo)
                await carregarFinanceiroResumo();
                console.log('✅ Financeiro atualizado');
                break;

            case 'estoque':
                // Atualizar apenas visão geral
                await loadEstoque();
                console.log('✅ Estoque atualizado');
                break;

            case 'sistema':
                await verificarStatus();
                console.log('✅ Sistema atualizado');
                break;

            default:
                // Para outras seções, apenas log
                console.log(`ℹ️ Seção "${sectionId}" não requer auto-atualização`);
        }

        // Atualizar timestamp na interface (se existir)
        updateLastRefreshTimestamp();

    } catch (err) {
        console.error('❌ Erro na auto-atualização:', err);
    } finally {
        // Ocultar indicador após 2 segundos
        setTimeout(() => {
            const indicator = document.getElementById('auto-refresh-indicator');
            if (indicator) indicator.classList.remove('show');
        }, 2000);
    }
}

function updateLastRefreshTimestamp() {
    // Criar ou atualizar badge de última atualização
    let badge = document.getElementById('lastRefreshBadge');

    if (!badge) {
        // Criar badge se não existir
        const pageHeader = document.querySelector('.page-header h1');
        if (pageHeader) {
            badge = document.createElement('span');
            badge.id = 'lastRefreshBadge';
            badge.style.cssText = `
                font-size: 0.75rem;
                font-weight: 600;
                color: #10B981;
                background: linear-gradient(135deg, #D1FAE5, #A7F3D0);
                padding: 4px 12px;
                border-radius: 12px;
                margin-left: 15px;
                display: inline-flex;
                align-items: center;
                gap: 5px;
            `;
            pageHeader.appendChild(badge);
        }
    }

    if (badge) {
        const now = new Date();
        const timeStr = now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
        badge.innerHTML = `<i class="bi bi-arrow-clockwise"></i> Atualizado às ${timeStr}`;
    }
}

// Iniciar auto-atualização quando o app carregar
document.addEventListener('DOMContentLoaded', () => {
    // Aguardar 5 segundos após o load inicial antes de ativar auto-update
    setTimeout(() => {
        enableAutoUpdate();
    }, 5000);
});

// Pausar auto-atualização quando a aba do navegador não estiver visível
document.addEventListener('visibilitychange', () => {
    if (document.hidden) {
        console.log('👁️ Página oculta, pausando auto-atualização');
        autoUpdateEnabled = false;
    } else {
        console.log('👁️ Página visível, retomando auto-atualização');
        autoUpdateEnabled = true;
        // Atualizar imediatamente ao voltar
        performAutoUpdate();
    }
});

console.log('✅ Sistema de auto-atualização inicializado (Diretriz 0.1)');

// ========== FIM AUTO-ATUALIZAÇÃO ==========

</script>

<!-- BIOMA v4.0 - Document Generator (PDF & Excel profissionais) -->
<script src="/static/js/document-generator.js"></script>

<!-- BIOMA v4.0 - Offline Manager (IndexedDB + Sync) -->
<script src="/static/js/offline-manager.js"></script>

</body>
</html>